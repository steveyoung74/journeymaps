<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, viewport-fit=cover">
  <title>Profile Settings | FATHOM</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Open+Sans:wght@400;500;600;700&display=swap" rel="stylesheet">
  <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <style>
    /* Interstate Font Family - Brand/Display Font */
    @font-face {
      font-family: 'Interstate';
      src: url('https://steveyoung74.github.io/journeymaps/fonts/Interstate-light.ttf') format('truetype');
      font-weight: 300;
      font-style: normal;
      font-display: swap;
    }
    @font-face {
      font-family: 'Interstate';
      src: url('https://steveyoung74.github.io/journeymaps/fonts/Interstate-regular.ttf') format('truetype');
      font-weight: 400;
      font-style: normal;
      font-display: swap;
    }
    @font-face {
      font-family: 'Interstate';
      src: url('https://steveyoung74.github.io/journeymaps/fonts/Interstate-bold.ttf') format('truetype');
      font-weight: 700;
      font-style: normal;
      font-display: swap;
    }
    
    :root {
      --font-display: 'Interstate', -apple-system, BlinkMacSystemFont, sans-serif;
      --font-body: 'Open Sans', -apple-system, BlinkMacSystemFont, sans-serif;
      
      --navy-950: #0C1620;
      --navy-900: #111E2E;
      --navy-800: #15243A;
      --navy-700: #192B45;
      --navy-600: #243D5C;
      --navy-500: #2F5070;
      --steel-700: #3A6070;
      --steel-600: #4A7485;
      --steel-500: #5B8A9A;
      --steel-400: #74A0AE;
      --steel-300: #96BCC7;
      --steel-100: #E1EEF2;
      --amber-600: #A67D1D;
      --amber-500: #C4942A;
      --amber-100: #FAF0D6;
      --success: #2D8A6E;
      --success-light: #D4EDE5;
      --error: #B84A5A;
      --slate-900: #1A2332;
      --slate-700: #3D4A5C;
      --slate-600: #556275;
      --slate-500: #6E7B8C;
      --slate-400: #8A95A5;
      --slate-300: #A9B2BE;
      --slate-200: #C8CED6;
      --slate-100: #E4E7EB;
      --slate-50: #F4F5F7;
    }
    
    * { box-sizing: border-box; margin: 0; padding: 0; }
    html { overflow-x: hidden; width: 100%; }
    body {
      font-family: var(--font-body);
      background: var(--slate-50);
      color: var(--slate-900);
      line-height: 1.6;
      min-height: 100vh;
      overflow-x: hidden;
      width: 100%;
      max-width: 100vw;
    }
    
    h1, h2, h3, h4, h5, h6 { font-family: var(--font-display); }
    
    /* Page Background */
    .page-bg {
      min-height: 100vh;
      position: relative;
      display: flex;
      flex-direction: column;
    }
    .page-bg::before {
      content: '';
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background-image: url("data:image/svg+xml,%3Csvg viewBox='0 0 1200 800' xmlns='http://www.w3.org/2000/svg'%3E%3Cpath d='M0 400 Q300 350 600 400 T1200 400' stroke='%2396BCC7' stroke-width='1' fill='none' opacity='0.3'/%3E%3Cpath d='M0 420 Q300 380 600 420 T1200 420' stroke='%2396BCC7' stroke-width='1' fill='none' opacity='0.25'/%3E%3Cpath d='M0 440 Q300 410 600 440 T1200 440' stroke='%2396BCC7' stroke-width='1' fill='none' opacity='0.2'/%3E%3Cpath d='M0 460 Q300 440 600 460 T1200 460' stroke='%2396BCC7' stroke-width='1' fill='none' opacity='0.15'/%3E%3Cpath d='M0 480 Q300 470 600 480 T1200 480' stroke='%2396BCC7' stroke-width='1' fill='none' opacity='0.1'/%3E%3C/svg%3E");
      background-size: cover;
      background-position: center;
      pointer-events: none;
      z-index: 0;
    }
    
    .page-container {
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      position: relative;
      z-index: 1;
    }
    
    /* Navigation */
    .nav {
      background: var(--navy-800);
      position: sticky;
      top: 0;
      z-index: 100;
    }
    .nav-inner {
      max-width: 1200px;
      margin: 0 auto;
      padding: 0 24px;
      height: 60px;
      display: flex;
      align-items: center;
      justify-content: space-between;
    }
    .nav-left {
      display: flex;
      align-items: center;
      gap: 32px;
    }
    .nav-logo { height: 24px; }
    .nav-links {
      display: none;
      align-items: center;
      gap: 4px;
    }
    .nav-link {
      color: rgba(255,255,255,0.7);
      text-decoration: none;
      padding: 8px 16px;
      border-radius: 6px;
      font-size: 14px;
      font-weight: 500;
      transition: all 0.15s;
    }
    .nav-link:hover { color: #FFF; background: rgba(255,255,255,0.1); }
    .nav-link.active { color: #FFF; background: rgba(255,255,255,0.15); }
    
    .nav-right {
      display: none;
      align-items: center;
      gap: 16px;
    }
    
    /* Profile Dropdown */
    .profile-trigger {
      display: flex;
      align-items: center;
      gap: 6px;
      padding: 3px;
      background: transparent;
      border: none;
      border-radius: 50%;
      cursor: pointer;
      transition: all 0.15s;
      position: relative;
    }
    .profile-trigger:hover {
      background: rgba(255,255,255,0.1);
    }
    .profile-avatar {
      width: 36px;
      height: 36px;
      border-radius: 50%;
      background: var(--steel-500);
      display: flex;
      align-items: center;
      justify-content: center;
      color: #FFF;
      font-size: 14px;
      font-weight: 600;
      text-transform: uppercase;
      overflow: hidden;
      border: 2px solid rgba(255,255,255,0.2);
    }
    .profile-trigger:hover .profile-avatar {
      border-color: rgba(255,255,255,0.4);
    }
    .profile-avatar img {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }
    .profile-chevron {
      position: absolute;
      bottom: 2px;
      right: 0;
      width: 14px;
      height: 14px;
      background: var(--navy-700);
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      color: rgba(255,255,255,0.8);
      font-size: 8px;
      border: 2px solid var(--navy-800);
    }
    .profile-trigger.open .profile-chevron {
      transform: rotate(180deg);
    }
    .profile-dropdown {
      position: absolute;
      top: calc(100% + 8px);
      right: 0;
      background: #FFF;
      border-radius: 12px;
      box-shadow: 0 8px 32px rgba(0,0,0,0.2);
      min-width: 220px;
      padding: 8px 0;
      opacity: 0;
      visibility: hidden;
      transform: translateY(-8px);
      transition: all 0.2s;
      z-index: 1000;
    }
    .profile-dropdown.open {
      opacity: 1;
      visibility: visible;
      transform: translateY(0);
    }
    .profile-dropdown-header {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 12px 16px;
      border-bottom: 1px solid var(--slate-100);
      margin-bottom: 4px;
    }
    .profile-dropdown-avatar {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      background: var(--steel-500);
      display: flex;
      align-items: center;
      justify-content: center;
      color: #FFF;
      font-size: 16px;
      font-weight: 600;
      flex-shrink: 0;
    }
    .profile-dropdown-info {
      flex: 1;
      min-width: 0;
    }
    .profile-dropdown-name {
      font-weight: 600;
      color: var(--slate-900);
      font-size: 14px;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }
    .profile-dropdown-email {
      color: var(--slate-500);
      font-size: 12px;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }
    .profile-dropdown-item {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 10px 16px;
      color: var(--slate-700);
      text-decoration: none;
      font-size: 14px;
      cursor: pointer;
      transition: background 0.1s;
      border: none;
      background: none;
      width: 100%;
      text-align: left;
      font-family: inherit;
    }
    .profile-dropdown-item:hover {
      background: var(--slate-50);
    }
    .profile-dropdown-item .icon {
      width: 18px;
      text-align: center;
    }
    .profile-dropdown-divider {
      height: 1px;
      background: var(--slate-100);
      margin: 4px 0;
    }
    .profile-dropdown-item.danger {
      color: var(--error);
    }
    .profile-dropdown-item.danger:hover {
      background: rgba(184, 74, 90, 0.08);
    }
    
    .nav-user {
      color: rgba(255,255,255,0.8);
      font-size: 14px;
    }
    .nav-signout {
      color: rgba(255,255,255,0.6);
      background: rgba(255,255,255,0.1);
      border: 1px solid rgba(255,255,255,0.2);
      padding: 6px 14px;
      border-radius: 6px;
      font-size: 13px;
      cursor: pointer;
      font-family: inherit;
      transition: all 0.15s;
    }
    .nav-signout:hover { background: rgba(255,255,255,0.2); color: #FFF; }
    
    /* Mobile hamburger */
    .nav-mobile-toggle {
      display: block;
      padding: 8px;
      background: transparent;
      border: none;
      cursor: pointer;
      color: rgba(255,255,255,0.8);
      font-size: 24px;
      line-height: 1;
    }
    
    /* Dropdown */
    .nav-dropdown {
      position: relative;
    }
    .nav-dropdown-menu {
      position: absolute;
      top: 100%;
      left: 0;
      background: #FFF;
      border-radius: 8px;
      box-shadow: 0 4px 20px rgba(0,0,0,0.15);
      min-width: 160px;
      padding: 6px 0;
      opacity: 0;
      visibility: hidden;
      transform: translateY(8px);
      transition: all 0.2s;
      z-index: 1000;
    }
    .nav-dropdown:hover .nav-dropdown-menu {
      opacity: 1;
      visibility: visible;
      transform: translateY(4px);
    }
    .nav-dropdown-item {
      display: block;
      padding: 10px 16px;
      color: var(--slate-700);
      text-decoration: none;
      font-size: 14px;
      transition: background 0.1s;
    }
    .nav-dropdown-item:hover { background: var(--slate-50); }
    
    /* Mobile Menu */
    .nav-mobile-backdrop {
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, 0.5);
      z-index: 999;
      opacity: 0;
      visibility: hidden;
      transition: opacity 0.3s ease, visibility 0.3s ease;
    }
    .nav-mobile-backdrop.open { opacity: 1; visibility: visible; }
    .nav-mobile-menu {
      position: fixed;
      top: 0;
      right: 0;
      bottom: 0;
      width: 280px;
      max-width: 85vw;
      background: var(--navy-800);
      z-index: 1000;
      display: flex;
      flex-direction: column;
      transform: translateX(100%);
      transition: transform 0.3s ease;
      box-shadow: -4px 0 24px rgba(0, 0, 0, 0.3);
    }
    .nav-mobile-menu.open { transform: translateX(0); }
    .nav-mobile-header {
      display: flex;
      justify-content: flex-end;
      padding: 16px 20px;
      border-bottom: 1px solid rgba(255,255,255,0.1);
    }
    .nav-mobile-close {
      background: rgba(255,255,255,0.1);
      border: none;
      color: #FFF;
      font-size: 20px;
      cursor: pointer;
      padding: 8px 12px;
      line-height: 1;
      border-radius: 20px;
    }
    .nav-mobile-links {
      display: flex;
      flex-direction: column;
      gap: 8px;
      padding: 20px;
      flex: 1;
      overflow-y: auto;
    }
    .nav-mobile-link {
      color: rgba(255,255,255,0.9);
      text-decoration: none;
      padding: 14px 20px;
      border-radius: 24px;
      font-size: 15px;
      font-weight: 500;
      background: rgba(255,255,255,0.05);
      text-align: center;
    }
    .nav-mobile-link:hover { background: rgba(255,255,255,0.15); }
    .nav-mobile-link.active { background: rgba(255,255,255,0.2); }
    .nav-mobile-section-label {
      color: rgba(255,255,255,0.4);
      font-size: 11px;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      padding: 16px 20px 8px;
    }
    .nav-mobile-user {
      padding: 20px;
      border-top: 1px solid rgba(255,255,255,0.1);
      background: rgba(0,0,0,0.2);
    }
    .nav-mobile-user-name {
      color: rgba(255,255,255,0.6);
      font-size: 13px;
      margin-bottom: 12px;
      text-align: center;
    }
    .nav-mobile-signout {
      width: 100%;
      padding: 12px;
      background: transparent;
      border: 1px solid rgba(255,255,255,0.3);
      color: rgba(255,255,255,0.9);
      border-radius: 24px;
      font-size: 14px;
      cursor: pointer;
      font-family: inherit;
    }
    
    /* Main Content */
    .main {
      flex: 1;
      max-width: 800px;
      margin: 0 auto;
      padding: 32px 24px;
      width: 100%;
    }
    
    .page-header {
      margin-bottom: 32px;
    }
    .page-title {
      font-size: 28px;
      font-weight: 700;
      color: var(--navy-800);
      margin-bottom: 8px;
    }
    .page-subtitle {
      color: var(--slate-500);
      font-size: 16px;
    }
    
    /* Card */
    .card {
      background: #FFF;
      border-radius: 16px;
      padding: 24px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.06);
      margin-bottom: 24px;
    }
    .card-title {
      font-size: 18px;
      font-weight: 600;
      color: var(--navy-800);
      margin-bottom: 20px;
    }
    
    /* Form */
    .form-group {
      margin-bottom: 20px;
    }
    .form-label {
      display: block;
      font-weight: 600;
      color: var(--slate-700);
      margin-bottom: 8px;
      font-size: 14px;
    }
    .form-input {
      width: 100%;
      padding: 12px 16px;
      border: 1px solid var(--slate-200);
      border-radius: 8px;
      font-size: 15px;
      font-family: inherit;
      transition: border-color 0.15s, box-shadow 0.15s;
    }
    .form-input:focus {
      outline: none;
      border-color: var(--steel-500);
      box-shadow: 0 0 0 3px rgba(91, 138, 154, 0.15);
    }
    .form-input:disabled {
      background: var(--slate-50);
      color: var(--slate-500);
    }
    .form-hint {
      color: var(--slate-500);
      font-size: 13px;
      margin-top: 6px;
    }
    
    /* Avatar Section */
    .avatar-section {
      display: flex;
      align-items: center;
      gap: 24px;
      margin-bottom: 24px;
      padding-bottom: 24px;
      border-bottom: 1px solid var(--slate-100);
    }
    .avatar-preview {
      width: 96px;
      height: 96px;
      border-radius: 50%;
      background: var(--steel-500);
      display: flex;
      align-items: center;
      justify-content: center;
      color: #FFF;
      font-size: 32px;
      font-weight: 600;
      flex-shrink: 0;
      position: relative;
      overflow: hidden;
      cursor: pointer;
      transition: all 0.2s;
    }
    .avatar-preview:hover {
      opacity: 0.9;
    }
    .avatar-preview img {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }
    .avatar-preview .avatar-overlay {
      position: absolute;
      inset: 0;
      background: rgba(0,0,0,0.5);
      display: flex;
      align-items: center;
      justify-content: center;
      opacity: 0;
      transition: opacity 0.2s;
    }
    .avatar-preview:hover .avatar-overlay {
      opacity: 1;
    }
    .avatar-overlay-text {
      color: #FFF;
      font-size: 12px;
      font-weight: 600;
      text-align: center;
    }
    .avatar-actions {
      display: flex;
      flex-direction: column;
      gap: 12px;
      flex: 1;
    }
    .avatar-actions h3 {
      font-size: 16px;
      font-weight: 600;
      color: var(--slate-900);
      margin: 0;
    }
    .avatar-actions p {
      font-size: 13px;
      color: var(--slate-500);
      margin: 0;
    }
    .avatar-buttons {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
    }
    .btn-sm {
      padding: 6px 12px;
      font-size: 13px;
    }
    .btn-outline {
      background: transparent;
      border: 1px solid var(--slate-200);
      color: var(--slate-600);
    }
    .btn-outline:hover {
      background: var(--slate-50);
      border-color: var(--slate-300);
    }
    .btn-danger-outline {
      background: transparent;
      border: 1px solid var(--accent-red);
      color: var(--accent-red);
    }
    .btn-danger-outline:hover {
      background: rgba(184, 74, 90, 0.08);
    }
    .avatar-upload-input {
      display: none;
    }
    .upload-progress {
      width: 100%;
      height: 4px;
      background: var(--slate-100);
      border-radius: 2px;
      overflow: hidden;
      margin-top: 8px;
    }
    .upload-progress-bar {
      height: 100%;
      background: var(--steel-500);
      transition: width 0.3s;
    }
    
    /* Buttons */
    .btn {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      padding: 10px 20px;
      border-radius: 8px;
      font-size: 14px;
      font-weight: 600;
      font-family: inherit;
      cursor: pointer;
      transition: all 0.15s;
      border: none;
    }
    .btn-primary {
      background: var(--navy-700);
      color: #FFF;
    }
    .btn-primary:hover { background: var(--navy-600); }
    .btn-primary:disabled {
      background: var(--slate-300);
      cursor: not-allowed;
    }
    .btn-secondary {
      background: var(--slate-100);
      color: var(--slate-700);
    }
    .btn-secondary:hover { background: var(--slate-200); }
    .btn-danger {
      background: rgba(184, 74, 90, 0.1);
      color: var(--error);
    }
    .btn-danger:hover { background: rgba(184, 74, 90, 0.2); }
    
    /* Info Section */
    .info-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 16px 0;
      border-bottom: 1px solid var(--slate-100);
    }
    .info-row:last-child { border-bottom: none; }
    .info-label {
      font-weight: 600;
      color: var(--slate-700);
      font-size: 14px;
    }
    .info-value {
      color: var(--slate-600);
      font-size: 14px;
    }
    
    /* Alerts */
    .alert {
      padding: 12px 16px;
      border-radius: 8px;
      font-size: 14px;
      margin-bottom: 16px;
    }
    .alert-success {
      background: var(--success-light);
      color: var(--success);
    }
    .alert-error {
      background: rgba(184, 74, 90, 0.1);
      color: var(--error);
    }
    
    /* Loading */
    @keyframes sinkIntoDepths {
      0% { transform: translateY(-100px); opacity: 0; }
      8% { opacity: 0.85; }
      85% { opacity: 0.12; }
      100% { transform: translateY(120px); opacity: 0; }
    }
    .loading-screen {
      position: fixed;
      inset: 0;
      display: flex;
      align-items: center;
      justify-content: center;
      background: linear-gradient(
        180deg, 
        #2B4358 0%,
        #28404F 10%,
        #253D49 20%,
        #233A44 30%,
        #20373F 40%,
        #1E343A 50%,
        #1C3136 60%,
        #1A2E32 70%,
        #182B2E 80%,
        #16282A 90%,
        #142526 100%
      );
      z-index: 9999;
    }
    .loading-screen::before {
      content: '';
      position: absolute;
      inset: 0;
      opacity: 0.15;
      pointer-events: none;
      background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='300' height='300'%3E%3Cfilter id='n' x='0' y='0'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.75' numOctaves='4' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='300' height='300' filter='url(%23n)' opacity='1'/%3E%3C/svg%3E");
    }
    .loading-logo {
      height: 40px;
      animation: sinkIntoDepths 5s ease-in-out infinite;
      position: relative;
      z-index: 1;
    }
    
    /* Responsive */
    @media (min-width: 768px) {
      .nav-links { display: flex; }
      .nav-right { display: flex; }
      .nav-mobile-toggle { display: none; }
    }
    
    /* Footer */
    .footer {
      background: var(--navy-900);
      padding: 24px;
      margin-top: auto;
    }
    .footer-inner {
      max-width: 1200px;
      margin: 0 auto;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .footer-logo { height: 20px; opacity: 0.5; }
    .footer-copy { color: rgba(255,255,255,0.5); font-size: 13px; }
  </style>
</head>
<body>
  <div id="root"></div>
  
  <script type="text/babel">
    const { useState, useEffect, useContext, createContext } = React;
    
    // Supabase client - must match dashboard.html config exactly
    const SUPABASE_URL = 'https://ktctvaeulualihczwnrl.supabase.co';
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imt0Y3R2YWV1bHVhbGloY3p3bnJsIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njc0MzczNjksImV4cCI6MjA4MzAxMzM2OX0.qnvrAUvUhp3hgu37YnahR0Ql-CKR0zcDt3sKWaMq95I';
    const supabase = window.supabase?.createClient(SUPABASE_URL, SUPABASE_ANON_KEY, {
      auth: {
        persistSession: true,
        autoRefreshToken: true,
        detectSessionInUrl: true,
        storage: window.localStorage,
        flowType: 'implicit'
      }
    });
    
    if (!supabase) {
      console.error('Profile: Supabase failed to initialize');
    }
    
    function ProfilePage() {
      const [user, setUser] = useState(null);
      const [profile, setProfile] = useState(null);
      const [loading, setLoading] = useState(true);
      const [showMobileMenu, setShowMobileMenu] = useState(false);
      const [showProfileMenu, setShowProfileMenu] = useState(false);
      
      // Form state
      const [displayName, setDisplayName] = useState('');
      const [avatarUrl, setAvatarUrl] = useState(null);
      const [uploading, setUploading] = useState(false);
      const [uploadProgress, setUploadProgress] = useState(0);
      const [saving, setSaving] = useState(false);
      const [success, setSuccess] = useState('');
      const [error, setError] = useState('');
      const fileInputRef = React.useRef(null);
      
      // Helper to get user initials
      const getInitials = (name) => {
        if (!name) return '?';
        return name.split(' ').map(n => n[0]).join('').toUpperCase().slice(0, 2);
      };
      
      // Close profile menu when clicking outside
      useEffect(() => {
        const handleClickOutside = (e) => {
          if (showProfileMenu && !e.target.closest('.profile-container')) {
            setShowProfileMenu(false);
          }
        };
        document.addEventListener('click', handleClickOutside);
        return () => document.removeEventListener('click', handleClickOutside);
      }, [showProfileMenu]);      
      // Load user and data
      useEffect(() => {
        if (!supabase) return;
        
        console.log('Profile: Starting auth check...');
        
        // Just use getSession - it reads from localStorage synchronously
        supabase.auth.getSession().then(({ data: { session }, error }) => {
          console.log('Profile: getSession result:', { 
            hasSession: !!session, 
            hasUser: !!session?.user,
            error: error?.message 
          });
          
          if (session?.user) {
            setUser(session.user);
            loadProfile(session.user.id);
          } else {
            console.log('Profile: No session found, redirecting to dashboard');
            window.location.href = 'dashboard.html';
          }
        }).catch(err => {
          console.error('Profile: getSession error:', err);
          window.location.href = 'dashboard.html';
        });
        
        // Listen for sign out only
        const { data: { subscription } } = supabase.auth.onAuthStateChange((event, session) => {
          console.log('Profile: Auth event:', event);
          if (event === 'SIGNED_OUT') {
            window.location.href = 'dashboard.html';
          }
        });
        
        return () => subscription?.unsubscribe();
      }, []);
      
      const loadProfile = async (userId) => {
        try {
          const { data, error } = await supabase
            .from('users')
            .select('*, organisations(*)')
            .eq('id', userId)
            .single();
          
          if (data) {
            setProfile(data);
            setDisplayName(data.display_name || '');
            setAvatarUrl(data.avatar_url || null);
          }
        } catch (err) {
          console.error('Failed to load profile:', err);
        }
        setLoading(false);
      };
      
      // Handle avatar upload
      const handleAvatarUpload = async (e) => {
        const file = e.target.files?.[0];
        if (!file) return;
        
        // Validate file type
        const allowedTypes = ['image/jpeg', 'image/png', 'image/gif', 'image/webp'];
        if (!allowedTypes.includes(file.type)) {
          setError('Please upload a valid image file (JPEG, PNG, GIF, or WebP)');
          return;
        }
        
        // Validate file size (max 2MB)
        if (file.size > 2 * 1024 * 1024) {
          setError('Image must be smaller than 2MB');
          return;
        }
        
        setUploading(true);
        setUploadProgress(0);
        setError('');
        setSuccess('');
        
        try {
          // Create unique filename
          const fileExt = file.name.split('.').pop();
          const fileName = `${user.id}-${Date.now()}.${fileExt}`;
          
          // Simulate progress (Supabase doesn't provide progress events)
          const progressInterval = setInterval(() => {
            setUploadProgress(prev => Math.min(prev + 10, 90));
          }, 100);
          
          // Upload to Supabase Storage
          const { data: uploadData, error: uploadError } = await supabase.storage
            .from('avatars')
            .upload(fileName, file, {
              cacheControl: '3600',
              upsert: false
            });
          
          clearInterval(progressInterval);
          
          if (uploadError) throw uploadError;
          
          // Get public URL
          const { data: urlData } = supabase.storage
            .from('avatars')
            .getPublicUrl(fileName);
          
          const publicUrl = urlData.publicUrl;
          
          // Delete old avatar if exists
          if (avatarUrl) {
            // Extract just the filename from the URL
            const urlParts = avatarUrl.split('/');
            const oldFileName = urlParts[urlParts.length - 1];
            if (oldFileName && oldFileName !== fileName) {
              await supabase.storage.from('avatars').remove([oldFileName]);
            }
          }
          
          // Update user profile with new avatar URL
          const { error: updateError } = await supabase
            .from('users')
            .update({ 
              avatar_url: publicUrl,
              updated_at: new Date().toISOString()
            })
            .eq('id', user.id);
          
          if (updateError) throw updateError;
          
          setUploadProgress(100);
          setAvatarUrl(publicUrl);
          setProfile(prev => ({ ...prev, avatar_url: publicUrl }));
          setSuccess('Avatar updated successfully');
          
          // Reset progress after a moment
          setTimeout(() => setUploadProgress(0), 1000);
        } catch (err) {
          console.error('Avatar upload failed:', err);
          if (err.message?.includes('Bucket not found')) {
            setError('Avatar storage not configured. Please create an "avatars" bucket in Supabase Storage.');
          } else if (err.message?.includes('Policy')) {
            setError('Storage permissions not configured. Please add storage policies in Supabase.');
          } else {
            setError(err.message || 'Failed to upload avatar');
          }
        }
        
        setUploading(false);
        // Reset file input
        if (fileInputRef.current) {
          fileInputRef.current.value = '';
        }
      };
      
      // Handle avatar removal
      const handleAvatarRemove = async () => {
        if (!avatarUrl) return;
        
        setUploading(true);
        setError('');
        setSuccess('');
        
        try {
          // Extract path from URL and delete from storage
          const pathMatch = avatarUrl.match(/avatars\/(.+)$/);
          if (pathMatch) {
            await supabase.storage.from('avatars').remove([`avatars/${pathMatch[1]}`]);
          }
          
          // Update user profile to remove avatar URL
          const { error: updateError } = await supabase
            .from('users')
            .update({ 
              avatar_url: null,
              updated_at: new Date().toISOString()
            })
            .eq('id', user.id);
          
          if (updateError) throw updateError;
          
          setAvatarUrl(null);
          setProfile(prev => ({ ...prev, avatar_url: null }));
          setSuccess('Avatar removed');
        } catch (err) {
          console.error('Avatar removal failed:', err);
          setError(err.message || 'Failed to remove avatar');
        }
        
        setUploading(false);
      };
      
      const handleSave = async (e) => {
        e.preventDefault();
        setSaving(true);
        setError('');
        setSuccess('');
        
        try {
          const { error: updateError } = await supabase
            .from('users')
            .update({ 
              display_name: displayName.trim(),
              updated_at: new Date().toISOString()
            })
            .eq('id', user.id);
          
          if (updateError) throw updateError;
          
          setProfile(prev => ({ ...prev, display_name: displayName.trim() }));
          setSuccess('Profile updated successfully');
        } catch (err) {
          setError(err.message || 'Failed to save profile');
        }
        setSaving(false);
      };
      
      const handleSignOut = async () => {
        await supabase.auth.signOut();
        window.location.href = 'index.html';
      };
      
      const canManageTeam = profile?.role === 'owner' || profile?.role === 'admin';
      
      if (loading) {
        return (
          <div className="loading-screen">
            <img 
              src="https://steveyoung74.github.io/journeymaps/logo_light.png" 
              alt="FATHOM" 
              className="loading-logo"
            />
          </div>
        );
      }
      
      return (
        <div className="page-container">
          {/* Navigation */}
          <nav className="nav">
            <div className="nav-inner">
              <div className="nav-left">
                <a href="index.html">
                  <img src="https://steveyoung74.github.io/journeymaps/logo_light.png" alt="FATHOM" className="nav-logo" />
                </a>
                <div className="nav-links">
                  <a href="dashboard.html" className="nav-link">Dashboard</a>
                  <div className="nav-dropdown">
                    <span className="nav-link" style={{ cursor: 'pointer' }}>Surveys ‚ñæ</span>
                    <div className="nav-dropdown-menu">
                      <a href="survey-admin.html" className="nav-dropdown-item">Send Surveys</a>
                      <a href="responses.html" className="nav-dropdown-item">View Responses</a>
                    </div>
                  </div>
                  {canManageTeam && (
                    <a href="team.html" className="nav-link">Team</a>
                  )}
                  <a href="whats-new.html" className="nav-link">What's New</a>
                  <a href="about.html" className="nav-link">About</a>
                </div>
              </div>
              
              <div className="nav-right">
                <div className="profile-container" style={{ position: 'relative' }}>
                  <button 
                    className={`profile-trigger ${showProfileMenu ? 'open' : ''}`}
                    onClick={(e) => { e.stopPropagation(); setShowProfileMenu(!showProfileMenu); }}
                  >
                    <div className="profile-avatar">
                      {avatarUrl ? (
                        <img src={avatarUrl} alt="" />
                      ) : (
                        getInitials(profile?.display_name || user?.email)
                      )}
                    </div>
                    <span className="profile-chevron">‚ñº</span>
                  </button>
                  
                  <div className={`profile-dropdown ${showProfileMenu ? 'open' : ''}`}>
                    <div className="profile-dropdown-header">
                      <div className="profile-dropdown-avatar">
                        {avatarUrl ? (
                          <img src={avatarUrl} alt="" style={{ width: '100%', height: '100%', objectFit: 'cover' }} />
                        ) : (
                          getInitials(profile?.display_name || user?.email)
                        )}
                      </div>
                      <div className="profile-dropdown-info">
                        <div className="profile-dropdown-name">{profile?.display_name || 'User'}</div>
                        <div className="profile-dropdown-email">{user?.email}</div>
                      </div>
                    </div>
                    
                    <a href="profile.html" className="profile-dropdown-item" onClick={() => setShowProfileMenu(false)}>
                      <span className="icon">üë§</span>
                      Profile Settings
                    </a>
                    
                    {canManageTeam && (
                      <a href="team.html" className="profile-dropdown-item" onClick={() => setShowProfileMenu(false)}>
                        <span className="icon">üë•</span>
                        Team Management
                      </a>
                    )}
                    
                    <div className="profile-dropdown-divider" />
                    
                    <a href="whats-new.html" className="profile-dropdown-item" onClick={() => setShowProfileMenu(false)}>
                      <span className="icon">‚ú®</span>
                      What's New
                    </a>
                    <a href="about.html" className="profile-dropdown-item" onClick={() => setShowProfileMenu(false)}>
                      <span className="icon">‚ÑπÔ∏è</span>
                      About Fathom
                    </a>
                    
                    <div className="profile-dropdown-divider" />
                    
                    <button 
                      className="profile-dropdown-item danger"
                      onClick={() => { setShowProfileMenu(false); handleSignOut(); }}
                    >
                      <span className="icon">üö™</span>
                      Sign Out
                    </button>
                  </div>
                </div>
              </div>
              
              <button className="nav-mobile-toggle" onClick={() => setShowMobileMenu(true)}>
                ‚ò∞
              </button>
            </div>
          </nav>
          
          {/* Mobile Menu */}
          <div className={`nav-mobile-backdrop ${showMobileMenu ? 'open' : ''}`} onClick={() => setShowMobileMenu(false)} />
          <div className={`nav-mobile-menu ${showMobileMenu ? 'open' : ''}`}>
            <div className="nav-mobile-header">
              <button className="nav-mobile-close" onClick={() => setShowMobileMenu(false)}>‚úï</button>
            </div>
            <div className="nav-mobile-links">
              <a href="dashboard.html" className="nav-mobile-link">Dashboard</a>
              <div className="nav-mobile-section-label">Surveys</div>
              <a href="survey-admin.html" className="nav-mobile-link">Send Surveys</a>
              <a href="responses.html" className="nav-mobile-link">View Responses</a>
              {canManageTeam && (
                <>
                  <div className="nav-mobile-section-label">Organisation</div>
                  <a href="team.html" className="nav-mobile-link">Team</a>
                </>
              )}
              <div className="nav-mobile-section-label">Info</div>
              <a href="whats-new.html" className="nav-mobile-link">What's New</a>
              <a href="about.html" className="nav-mobile-link">About</a>
            </div>
            <div className="nav-mobile-user">
              <div className="nav-mobile-user-name">Signed in as {profile?.display_name || user?.email}</div>
              <button onClick={() => { setShowMobileMenu(false); handleSignOut(); }} className="nav-mobile-signout">Sign Out</button>
            </div>
          </div>
          
          {/* Main Content */}
          <main className="main">
            <div className="page-header">
              <h1 className="page-title">Profile Settings</h1>
              <p className="page-subtitle">Manage your account information</p>
            </div>
            
            {/* Profile Card */}
            <div className="card">
              <h2 className="card-title">Profile</h2>
              
              {success && <div className="alert alert-success">{success}</div>}
              {error && <div className="alert alert-error">{error}</div>}
              
              {/* Avatar Section */}
              <div className="avatar-section">
                <div 
                  className="avatar-preview" 
                  onClick={() => !uploading && fileInputRef.current?.click()}
                  style={{ cursor: uploading ? 'wait' : 'pointer' }}
                >
                  {avatarUrl ? (
                    <img src={avatarUrl} alt="Avatar" />
                  ) : (
                    getInitials(displayName || profile?.email)
                  )}
                  {!uploading && (
                    <div className="avatar-overlay">
                      <span className="avatar-overlay-text">
                        {avatarUrl ? 'Change' : 'Upload'}
                      </span>
                    </div>
                  )}
                </div>
                <div className="avatar-actions">
                  <h3>Profile Picture</h3>
                  <p>JPEG, PNG, GIF or WebP. Max 2MB.</p>
                  <div className="avatar-buttons">
                    <button 
                      type="button"
                      className="btn btn-sm btn-outline"
                      onClick={() => fileInputRef.current?.click()}
                      disabled={uploading}
                    >
                      {uploading ? 'Uploading...' : (avatarUrl ? 'Change Photo' : 'Upload Photo')}
                    </button>
                    {avatarUrl && (
                      <button 
                        type="button"
                        className="btn btn-sm btn-danger-outline"
                        onClick={handleAvatarRemove}
                        disabled={uploading}
                      >
                        Remove
                      </button>
                    )}
                  </div>
                  {uploading && uploadProgress > 0 && (
                    <div className="upload-progress">
                      <div 
                        className="upload-progress-bar" 
                        style={{ width: `${uploadProgress}%` }}
                      />
                    </div>
                  )}
                </div>
                <input 
                  ref={fileInputRef}
                  type="file"
                  accept="image/jpeg,image/png,image/gif,image/webp"
                  className="avatar-upload-input"
                  onChange={handleAvatarUpload}
                />
              </div>
              
              <form onSubmit={handleSave}>
                <div className="form-group">
                  <label className="form-label">Display Name</label>
                  <input 
                    type="text" 
                    className="form-input"
                    value={displayName}
                    onChange={(e) => setDisplayName(e.target.value)}
                    placeholder="Enter your name"
                  />
                  <p className="form-hint">This is how your name appears across Fathom</p>
                </div>
                
                <div className="form-group">
                  <label className="form-label">Email</label>
                  <input 
                    type="email" 
                    className="form-input"
                    value={user?.email || ''}
                    disabled
                  />
                  <p className="form-hint">Your email cannot be changed</p>
                </div>
                
                <button type="submit" className="btn btn-primary" disabled={saving}>
                  {saving ? 'Saving...' : 'Save Changes'}
                </button>
              </form>
            </div>
            
            {/* Organisation Info */}
            <div className="card">
              <h2 className="card-title">Organisation</h2>
              
              <div className="info-row">
                <span className="info-label">Workspace</span>
                <span className="info-value">{profile?.organisations?.name || 'Not set'}</span>
              </div>
              
              <div className="info-row">
                <span className="info-label">Your Role</span>
                <span className="info-value" style={{ textTransform: 'capitalize' }}>{profile?.role || 'Member'}</span>
              </div>
              
              <div className="info-row">
                <span className="info-label">Member Since</span>
                <span className="info-value">
                  {profile?.created_at ? new Date(profile.created_at).toLocaleDateString('en-GB', { 
                    day: 'numeric', 
                    month: 'long', 
                    year: 'numeric' 
                  }) : 'Unknown'}
                </span>
              </div>
            </div>
            
            {/* Account Actions */}
            <div className="card">
              <h2 className="card-title">Account</h2>
              
              <div style={{ display: 'flex', flexDirection: 'column', gap: '12px' }}>
                <button className="btn btn-secondary" onClick={handleSignOut}>
                  üö™ Sign Out
                </button>
                <p className="form-hint" style={{ marginTop: '-4px' }}>
                  Sign out of your account on this device
                </p>
              </div>
            </div>
          </main>
          
          {/* Footer */}
          <footer className="footer">
            <div className="footer-inner">
              <img src="https://steveyoung74.github.io/journeymaps/logo_light.png" alt="FATHOM" className="footer-logo" />
              <span className="footer-copy">¬© 2026 Fathom</span>
            </div>
          </footer>
        </div>
      );
    }
    
    ReactDOM.createRoot(document.getElementById('root')).render(<ProfilePage />);
  </script>
</body>
</html>
