<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, viewport-fit=cover">
  <title>Survey Responses | FATHOM</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Open+Sans:wght@400;500;600;700&display=swap" rel="stylesheet">
  <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <style>
    /* ============================================
       FATHOM RESPONSE VIEWER - STYLES
       ============================================ */
    
    /* Interstate Font Family - Brand/Display Font */
    @font-face {
      font-family: 'Interstate';
      src: url('https://steveyoung74.github.io/journeymaps/fonts/Interstate-regular.ttf') format('truetype');
      font-weight: 400;
      font-style: normal;
      font-display: swap;
    }
    @font-face {
      font-family: 'Interstate';
      src: url('https://steveyoung74.github.io/journeymaps/fonts/Interstate-bold.ttf') format('truetype');
      font-weight: 700;
      font-style: normal;
      font-display: swap;
    }
    
    :root {
      /* Font Families */
      --font-display: 'Interstate', -apple-system, BlinkMacSystemFont, sans-serif;
      --font-body: 'Open Sans', -apple-system, BlinkMacSystemFont, sans-serif;
      
      --navy-950: #0C1620;
      --navy-900: #111E2E;
      --navy-800: #15243A;
      --navy-700: #192B45;
      --navy-600: #243D5C;
      --navy-500: #2F5070;
      --steel-700: #3A6070;
      --steel-600: #4A7485;
      --steel-500: #5B8A9A;
      --steel-400: #74A0AE;
      --steel-300: #96BCC7;
      --steel-100: #E1EEF2;
      --amber-600: #A67D1D;
      --amber-500: #C4942A;
      --amber-400: #D4A84A;
      --amber-100: #FAF0D6;
      --success: #2D8A6E;
      --success-light: #D4EDE5;
      --error: #B84A5A;
      --error-light: #F5E0E3;
      --warning: #D97706;
      --warning-light: #FEF3C7;
      --slate-900: #1A2332;
      --slate-700: #3D4A5C;
      --slate-600: #556275;
      --slate-500: #6E7B8C;
      --slate-400: #8A95A5;
      --slate-300: #A9B2BE;
      --slate-200: #C8CED6;
      --slate-100: #E4E7EB;
      --slate-50: #F4F5F7;
    }
    
    * { box-sizing: border-box; margin: 0; padding: 0; }
    html {
      overflow-x: hidden;
      width: 100%;
      
    }
    body {
      font-family: var(--font-body);
      background: var(--slate-50);
      color: var(--slate-900);
      line-height: 1.6;
      min-height: 100vh;
      overflow-x: hidden;
      width: 100%;
      max-width: 100vw;
    }
    
    /* Typography - Display font for headings */
    h1, h2, h3, h4, h5, h6 {
      font-family: var(--font-display);
    }
    
    /* Page background with topographic pattern */
    .page-bg {
      min-height: 100vh;
      background: var(--slate-50);
      position: relative;
      min-height: 100vh;
      display: flex;
      flex-direction: column;
    }
    .page-bg::before {
      content: '';
      position: absolute;
      inset: 0;
      background: url('https://steveyoung74.github.io/journeymaps/topography-light.svg') center/600px 600px repeat;
      opacity: 1;
      pointer-events: none;
      z-index: 0;
    }
    .page-bg > main {
      position: relative;
      flex: 1;
    }
    .page-bg > .footer {
      position: relative;
    }
    
    /* ============================================
       NAVIGATION
       ============================================ */
    
    .nav {
      background: linear-gradient(135deg, var(--navy-700) 0%, var(--navy-900) 100%);
      position: sticky;
      top: 0;
      z-index: 9999;
    }
    .nav::before {
      content: '';
      position: absolute;
      inset: 0;
      background: url('https://steveyoung74.github.io/journeymaps/topography-dark.svg') center/600px 600px repeat;
      opacity: 1;
      pointer-events: none;
      z-index: 0;
    }
    .nav-inner {
      max-width: 1200px;
      margin: 0 auto;
      padding: 0 24px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      height: 64px;
      position: relative;
      z-index: 1;
    }
    .nav-left {
      display: flex;
      align-items: center;
      gap: 32px;
    }
    .nav-logo {
      height: 32px;
    }
    .nav-links {
      display: flex;
      align-items: center;
      gap: 4px;
    }
    .nav-link {
      color: rgba(255,255,255,0.7);
      text-decoration: none;
      padding: 8px 16px;
      border-radius: 6px;
      font-size: 14px;
      font-weight: 500;
      transition: all 0.15s;
      cursor: pointer;
      background: none;
      border: none;
      font-family: inherit;
    }
    .nav-link:hover {
      color: #FFF;
      background: rgba(255,255,255,0.1);
    }
    .nav-link.active {
      color: #FFF;
      background: rgba(255,255,255,0.15);
    }
    .nav-dropdown {
      position: relative;
    }
    .nav-dropdown-menu {
      position: absolute;
      top: 100%;
      left: 0;
      background: #FFF;
      border-radius: 8px;
      box-shadow: 0 4px 24px rgba(0,0,0,0.15);
      min-width: 180px;
      padding: 8px 0;
      opacity: 0;
      visibility: hidden;
      transform: translateY(8px);
      transition: all 0.2s;
      z-index: 1001;
    }
    .nav-dropdown:hover .nav-dropdown-menu {
      opacity: 1;
      visibility: visible;
      transform: translateY(0);
    }
    .nav-dropdown-item {
      display: block;
      padding: 10px 16px;
      color: var(--slate-700);
      text-decoration: none;
      font-size: 14px;
      transition: background 0.15s;
    }
    .nav-dropdown-item:hover {
      background: var(--slate-50);
      color: var(--navy-700);
    }
    .nav-right {
      display: flex;
      align-items: center;
      gap: 16px;
    }
    
    /* Profile Dropdown */
    .profile-trigger {
      display: flex;
      align-items: center;
      gap: 6px;
      padding: 3px;
      background: transparent;
      border: none;
      border-radius: 50%;
      cursor: pointer;
      transition: all 0.15s;
      position: relative;
    }
    .profile-trigger:hover {
      background: rgba(255,255,255,0.1);
    }
    .profile-avatar {
      width: 36px;
      height: 36px;
      border-radius: 50%;
      background: var(--steel-500);
      display: flex;
      align-items: center;
      justify-content: center;
      color: #FFF;
      font-size: 14px;
      font-weight: 600;
      text-transform: uppercase;
      overflow: hidden;
      border: 2px solid rgba(255,255,255,0.2);
    }
    .profile-trigger:hover .profile-avatar {
      border-color: rgba(255,255,255,0.4);
    }
    .profile-avatar img {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }
    .profile-chevron {
      position: absolute;
      bottom: 2px;
      right: 0;
      width: 14px;
      height: 14px;
      background: var(--navy-700);
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      color: rgba(255,255,255,0.8);
      font-size: 8px;
      border: 2px solid var(--navy-800);
    }
    .profile-trigger.open .profile-chevron {
      transform: rotate(180deg);
    }
    .profile-dropdown {
      position: absolute;
      top: calc(100% + 8px);
      right: 0;
      background: #FFF;
      border-radius: 12px;
      box-shadow: 0 8px 32px rgba(0,0,0,0.2);
      min-width: 220px;
      padding: 8px 0;
      opacity: 0;
      visibility: hidden;
      transform: translateY(-8px);
      transition: all 0.2s;
      z-index: 1000;
    }
    .profile-dropdown.open {
      opacity: 1;
      visibility: visible;
      transform: translateY(0);
    }
    .profile-dropdown-header {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 12px 16px;
      border-bottom: 1px solid var(--slate-100);
      margin-bottom: 4px;
    }
    .profile-dropdown-avatar {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      background: var(--steel-500);
      display: flex;
      align-items: center;
      justify-content: center;
      color: #FFF;
      font-size: 16px;
      font-weight: 600;
      flex-shrink: 0;
    }
    .profile-dropdown-info {
      flex: 1;
      min-width: 0;
    }
    .profile-dropdown-name {
      font-weight: 600;
      color: var(--slate-900);
      font-size: 14px;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }
    .profile-dropdown-email {
      color: var(--slate-500);
      font-size: 12px;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }
    .profile-dropdown-item {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 10px 16px;
      color: var(--slate-700);
      text-decoration: none;
      font-size: 14px;
      cursor: pointer;
      transition: background 0.1s;
      border: none;
      background: none;
      width: 100%;
      text-align: left;
      font-family: inherit;
    }
    .profile-dropdown-item:hover {
      background: var(--slate-50);
    }
    .profile-dropdown-item .icon {
      width: 18px;
      text-align: center;
    }
    .profile-dropdown-divider {
      height: 1px;
      background: var(--slate-100);
      margin: 4px 0;
    }
    .profile-dropdown-item.danger {
      color: var(--error);
    }
    .profile-dropdown-item.danger:hover {
      background: rgba(184, 74, 90, 0.08);
    }
    
    .nav-user {
      color: rgba(255,255,255,0.8);
      font-size: 14px;
    }
    .nav-signout {
      color: rgba(255,255,255,0.6);
      background: rgba(255,255,255,0.1);
      border: 1px solid rgba(255,255,255,0.2);
      padding: 6px 14px;
      border-radius: 6px;
      font-size: 13px;
      cursor: pointer;
      font-family: inherit;
      transition: all 0.15s;
    }
    .nav-signout:hover {
      background: rgba(255,255,255,0.2);
      color: #FFF;
    }
    @media (max-width: 768px) {
      .nav-links { display: none; }
      .nav-inner { padding: 0 16px; }
    }
    
    .page-title {
      font-size: 28px;
      font-weight: 400;
      color: var(--navy-700);
      margin-bottom: 8px;
    }
    .page-subtitle {
      font-size: 15px;
      color: var(--slate-500);
    }
    .page-header-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 32px;
      flex-wrap: wrap;
      gap: 16px;
    }
    
    /* ============================================
       MAP LIST (for map selector)
       ============================================ */
    
    .map-list {
      display: flex;
      flex-direction: column;
      gap: 12px;
    }
    
    .map-card {
      background: #FFF;
      border-radius: 12px;
      padding: 20px 24px;
      display: flex;
      align-items: center;
      gap: 20px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.06);
      cursor: pointer;
      transition: all 0.2s;
      border: 2px solid transparent;
    }
    
    .map-card:hover {
      border-color: var(--steel-400);
      box-shadow: 0 4px 16px rgba(0,0,0,0.1);
    }
    
    .map-card-content {
      flex: 1;
    }
    
    .map-card-content h3 {
      font-size: 18px;
      font-weight: 600;
      color: var(--navy-700);
      margin-bottom: 4px;
    }
    
    .map-card-meta {
      font-size: 14px;
      color: var(--slate-500);
    }
    
    .map-card-responses {
      text-align: right;
      min-width: 100px;
    }
    
    .response-count {
      display: block;
      font-size: 28px;
      font-weight: 700;
      color: var(--steel-600);
      line-height: 1;
    }
    
    .response-label {
      font-size: 12px;
      color: var(--slate-500);
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }
    
    .no-responses {
      font-size: 13px;
      color: var(--slate-400);
      font-style: italic;
    }
    
    .map-card-arrow {
      font-size: 20px;
      color: var(--slate-300);
      transition: transform 0.2s;
    }
    
    .map-card:hover .map-card-arrow {
      transform: translateX(4px);
      color: var(--steel-500);
    }
    
    /* ============================================
       MAIN LAYOUT
       ============================================ */
    
    .main {
      max-width: 1200px;
      margin: 0 auto;
      padding: 32px;
    }
    
    /* ============================================
       STATS CARDS
       ============================================ */
    
    .stats-grid {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 20px;
      margin-bottom: 32px;
    }
    
    .stat-card {
      background: #FFF;
      border-radius: 12px;
      padding: 24px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.06);
    }
    
    .stat-label {
      font-size: 13px;
      color: var(--slate-500);
      margin-bottom: 8px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }
    
    .stat-value {
      font-size: 32px;
      font-weight: 700;
      color: var(--navy-700);
    }
    
    .stat-sub {
      font-size: 13px;
      color: var(--slate-400);
      margin-top: 4px;
    }
    
    .stat-card.highlight {
      background: var(--navy-700);
      color: #FFF;
    }
    
    .stat-card.highlight .stat-label {
      color: rgba(255,255,255,0.7);
    }
    
    .stat-card.highlight .stat-value {
      color: #FFF;
    }
    
    .stat-card.highlight .stat-sub {
      color: rgba(255,255,255,0.6);
    }
    
    /* ============================================
       FILTERS
       ============================================ */
    
    .filters-bar {
      display: flex;
      gap: 16px;
      margin-bottom: 24px;
      flex-wrap: wrap;
      align-items: center;
    }
    
    .filter-group {
      display: flex;
      align-items: center;
      gap: 8px;
    }
    
    .filter-label {
      font-size: 13px;
      color: var(--slate-500);
      font-weight: 500;
    }
    
    .filter-select {
      padding: 8px 12px;
      border: 1px solid var(--slate-200);
      border-radius: 6px;
      font-size: 14px;
      font-family: inherit;
      background: #FFF;
      color: var(--slate-700);
      min-width: 160px;
    }
    
    .filter-select:focus {
      outline: none;
      border-color: var(--steel-500);
    }
    
    .view-toggle {
      display: flex;
      gap: 4px;
      margin-left: auto;
      border: 1px solid var(--slate-200);
      border-radius: 6px;
      padding: 2px;
      background: #FFF;
    }
    
    .view-btn {
      padding: 6px 12px;
      border: none;
      background: transparent;
      color: var(--slate-500);
      cursor: pointer;
      border-radius: 4px;
      font-size: 13px;
      font-family: inherit;
      transition: all 0.15s;
    }
    
    .view-btn.active {
      background: var(--navy-700);
      color: #FFF;
    }
    
    /* ============================================
       RESPONSE CARDS
       ============================================ */
    
    .responses-list {
      display: flex;
      flex-direction: column;
      gap: 16px;
    }
    
    .response-card {
      background: #FFF;
      border-radius: 12px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.06);
      overflow: hidden;
    }
    
    .response-header {
      padding: 20px 24px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      cursor: pointer;
      transition: background 0.15s;
    }
    
    .response-header:hover {
      background: var(--slate-50);
    }
    
    .response-meta {
      display: flex;
      align-items: center;
      gap: 16px;
    }
    
    .response-avatar {
      width: 44px;
      height: 44px;
      border-radius: 50%;
      background: var(--steel-100);
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 600;
      color: var(--steel-600);
      font-size: 16px;
    }
    
    .response-info h3 {
      font-size: 16px;
      font-weight: 600;
      color: var(--navy-700);
      margin-bottom: 2px;
    }
    
    .response-info p {
      font-size: 13px;
      color: var(--slate-500);
    }
    
    .response-badges {
      display: flex;
      gap: 8px;
      align-items: center;
    }
    
    .badge {
      padding: 4px 10px;
      border-radius: 20px;
      font-size: 12px;
      font-weight: 500;
    }
    
    .badge-role {
      background: var(--steel-100);
      color: var(--steel-600);
    }
    
    .badge-steps {
      background: var(--slate-100);
      color: var(--slate-600);
    }
    
    .badge-friction-high {
      background: var(--error-light);
      color: var(--error);
    }
    
    .badge-friction-medium {
      background: var(--warning-light);
      color: var(--warning);
    }
    
    .badge-friction-low {
      background: var(--success-light);
      color: var(--success);
    }
    
    .expand-icon {
      font-size: 18px;
      color: var(--slate-400);
      transition: transform 0.2s;
    }
    
    .expand-icon.expanded {
      transform: rotate(180deg);
    }
    
    .response-body {
      border-top: 1px solid var(--slate-100);
      padding: 24px;
      display: none;
    }
    
    .response-body.expanded {
      display: block;
    }
    
    /* ============================================
       STEP RESPONSES
       ============================================ */
    
    .step-responses {
      display: flex;
      flex-direction: column;
      gap: 16px;
    }
    
    .step-response {
      background: var(--slate-50);
      border-radius: 8px;
      padding: 16px 20px;
    }
    
    .step-response-header {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      margin-bottom: 12px;
    }
    
    .step-name {
      font-weight: 600;
      color: var(--navy-700);
      margin-bottom: 2px;
    }
    
    .step-stage {
      font-size: 12px;
      color: var(--slate-500);
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }
    
    .step-metrics {
      display: flex;
      gap: 16px;
      align-items: center;
    }
    
    .metric {
      text-align: right;
    }
    
    .metric-value {
      font-size: 18px;
      font-weight: 600;
      color: var(--navy-700);
    }
    
    .metric-label {
      font-size: 11px;
      color: var(--slate-500);
      text-transform: uppercase;
    }
    
    .metric-variance {
      font-size: 12px;
      padding: 2px 6px;
      border-radius: 4px;
      font-weight: 500;
    }
    
    .variance-higher {
      background: var(--error-light);
      color: var(--error);
    }
    
    .variance-lower {
      background: var(--success-light);
      color: var(--success);
    }
    
    .variance-same {
      background: var(--slate-100);
      color: var(--slate-500);
    }
    
    .friction-display {
      display: flex;
      align-items: center;
      gap: 6px;
    }
    
    .friction-emoji {
      font-size: 20px;
    }
    
    .step-content {
      display: grid;
      gap: 12px;
    }
    
    .content-field {
      display: grid;
      grid-template-columns: 140px 1fr;
      gap: 8px;
      font-size: 14px;
    }
    
    .content-field dt {
      color: var(--slate-500);
      font-weight: 500;
    }
    
    .content-field dd {
      color: var(--slate-700);
    }
    
    /* ============================================
       COMPARISON VIEW
       ============================================ */
    
    .comparison-grid {
      display: grid;
      gap: 16px;
    }
    
    .comparison-row {
      background: #FFF;
      border-radius: 12px;
      padding: 20px 24px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.06);
    }
    
    .comparison-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 16px;
    }
    
    .comparison-step-name {
      font-weight: 600;
      color: var(--navy-700);
    }
    
    .comparison-step-stage {
      font-size: 12px;
      color: var(--slate-500);
    }
    
    .comparison-data {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(min(200px, 100%), 1fr));
      gap: 20px;
    }
    
    .comparison-column {
      padding: 16px;
      border-radius: 8px;
    }
    
    .comparison-column.estimate {
      background: var(--slate-50);
    }
    
    .comparison-column.responses {
      background: var(--steel-100);
    }
    
    .comparison-column h4 {
      font-size: 12px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      color: var(--slate-500);
      margin-bottom: 12px;
    }
    
    .comparison-column.responses h4 {
      color: var(--steel-600);
    }
    
    .comparison-value {
      font-size: 24px;
      font-weight: 700;
      color: var(--navy-700);
      margin-bottom: 4px;
    }
    
    .comparison-column.responses .comparison-value {
      color: var(--steel-700);
    }
    
    .comparison-detail {
      font-size: 13px;
      color: var(--slate-500);
    }
    
    .response-quotes {
      margin-top: 16px;
      padding-top: 16px;
      border-top: 1px solid var(--slate-200);
    }
    
    .response-quotes h5 {
      font-size: 12px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      color: var(--slate-500);
      margin-bottom: 12px;
    }
    
    .quote {
      background: var(--amber-100);
      border-left: 3px solid var(--amber-500);
      padding: 12px 16px;
      margin-bottom: 8px;
      border-radius: 0 6px 6px 0;
      font-size: 14px;
      color: var(--slate-700);
    }
    
    .quote-author {
      font-size: 12px;
      color: var(--slate-500);
      margin-top: 6px;
    }
    
    /* ============================================
       EMPTY STATES
       ============================================ */
    
    .empty-state {
      text-align: center;
      padding: 80px 40px;
      background: #FFF;
      border-radius: 16px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.06);
    }
    
    .empty-icon {
      font-size: 48px;
      margin-bottom: 16px;
    }
    
    .empty-state h2 {
      font-size: 20px;
      color: var(--navy-700);
      margin-bottom: 8px;
    }
    
    .empty-state p {
      color: var(--slate-500);
      margin-bottom: 24px;
    }
    
    .btn {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      padding: 12px 24px;
      border-radius: 8px;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.15s;
      border: none;
      font-family: inherit;
      text-decoration: none;
    }
    
    .btn-primary {
      background: var(--navy-700);
      color: #FFF;
    }
    
    .btn-primary:hover {
      background: var(--navy-600);
    }
    
    .btn-secondary {
      background: var(--slate-100);
      color: var(--slate-700);
    }
    
    .btn-secondary:hover {
      background: var(--slate-200);
    }
    
    /* ============================================
       LOADING
       ============================================ */
    
    .loading {
      text-align: center;
      padding: 80px 40px;
    }
    
    .loading-spinner {
      width: 40px;
      height: 40px;
      border: 3px solid var(--slate-200);
      border-top-color: var(--steel-500);
      border-radius: 50%;
      animation: spin 0.8s linear infinite;
      margin: 0 auto 16px;
    }
    
    @keyframes spin {
      to { transform: rotate(360deg); }
    }
    
    /* ============================================
       RESPONSIVE
       ============================================ */
    
    @media (max-width: 1024px) {
      .stats-grid {
        grid-template-columns: repeat(2, 1fr);
      }
    }
    
    @media (max-width: 768px) {
      .main {
        padding: 20px;
      }
      
      .stats-grid {
        grid-template-columns: 1fr;
      }
      
      .filters-bar {
        flex-direction: column;
        align-items: stretch;
      }
      
      .view-toggle {
        margin-left: 0;
      }
      
      .response-header {
        flex-direction: column;
        align-items: flex-start;
        gap: 12px;
      }
      
      .response-badges {
        flex-wrap: wrap;
      }
      
      .content-field {
        grid-template-columns: 1fr;
      }
      
      .comparison-data {
        grid-template-columns: 1fr;
      }
      
      .nav-links {
        display: none !important;
      }
      .nav-right {
        display: none !important;
      }
      .nav-mobile-toggle {
        display: flex !important;
        align-items: center;
        justify-content: center;
      }
    }
    
    /* Mobile Menu */
    .nav-mobile-toggle {
      display: none;
      background: none;
      border: none;
      color: #FFF;
      font-size: 24px;
      cursor: pointer;
      padding: 8px 12px;
      line-height: 1;
      position: relative;
      z-index: 10;
    }
    /* Mobile Menu - Threads-style Side Sliding */
    .nav-mobile-backdrop {
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, 0.5);
      z-index: 9999;
      opacity: 0;
      visibility: hidden;
      transition: opacity 0.3s ease, visibility 0.3s ease;
    }
    .nav-mobile-backdrop.open {
      opacity: 1;
      visibility: visible;
    }
    .nav-mobile-menu {
      position: fixed;
      top: 0;
      right: 0;
      bottom: 0;
      width: 280px;
      max-width: 85vw;
      background: var(--navy-800);
      z-index: 10000;
      display: flex;
      flex-direction: column;
      transform: translateX(100%);
      transition: transform 0.3s ease;
      box-shadow: -4px 0 24px rgba(0, 0, 0, 0.3);
    }
    .nav-mobile-menu.open {
      transform: translateX(0);
    }
    .nav-mobile-header {
      display: flex;
      justify-content: flex-end;
      padding: 16px 20px;
      border-bottom: 1px solid rgba(255,255,255,0.1);
    }
    .nav-mobile-close {
      background: rgba(255,255,255,0.1);
      border: none;
      color: #FFF;
      font-size: 20px;
      cursor: pointer;
      padding: 8px 12px;
      line-height: 1;
      border-radius: 20px;
      transition: background 0.15s;
    }
    .nav-mobile-close:hover {
      background: rgba(255,255,255,0.2);
    }
    .nav-mobile-links {
      display: flex;
      flex-direction: column;
      gap: 8px;
      padding: 20px;
      flex: 1;
      overflow-y: auto;
    }
    .nav-mobile-link {
      color: rgba(255,255,255,0.9);
      text-decoration: none;
      padding: 14px 20px;
      border-radius: 24px;
      font-size: 15px;
      font-weight: 500;
      background: rgba(255,255,255,0.05);
      transition: all 0.15s;
      text-align: center;
    }
    .nav-mobile-link:hover {
      background: rgba(255,255,255,0.15);
      color: #FFF;
    }
    .nav-mobile-link.active {
      background: rgba(255,255,255,0.2);
      color: #FFF;
    }
    .nav-mobile-section-label {
      color: rgba(255,255,255,0.4);
      font-size: 11px;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      padding: 16px 20px 8px;
    }
    .nav-mobile-user {
      padding: 20px;
      border-top: 1px solid rgba(255,255,255,0.1);
      background: rgba(0,0,0,0.2);
    }
    .nav-mobile-user-name {
      color: rgba(255,255,255,0.6);
      font-size: 13px;
      margin-bottom: 12px;
      text-align: center;
    }
    .nav-mobile-signout {
      width: 100%;
      padding: 12px;
      background: transparent;
      border: 1px solid rgba(255,255,255,0.3);
      color: rgba(255,255,255,0.9);
      border-radius: 24px;
      font-size: 14px;
      font-weight: 500;
      cursor: pointer;
      font-family: inherit;
      transition: all 0.15s;
    }
    .nav-mobile-signout:hover {
      background: rgba(255,255,255,0.1);
      border-color: rgba(255,255,255,0.4);
    }
    
    /* Footer */
    .footer {
      background: var(--navy-950);
      color: rgba(255,255,255,0.4);
      padding: 32px 24px;
    }
    .footer-inner {
      max-width: 1140px;
      margin: 0 auto;
      display: flex;
      justify-content: space-between;
      align-items: center;
      flex-wrap: wrap;
      gap: 16px;
    }
    .footer-brand {
      display: flex;
      align-items: center;
      gap: 12px;
    }
    .footer-logo {
      height: 20px;
      opacity: 0.5;
    }
    .footer-version {
      font-size: 11px;
      opacity: 0.6;
    }
    .footer-copy {
      font-size: 13px;
    }
  </style>
</head>
<body>
  <div id="root"></div>
  
  <script type="text/babel">
    const { useState, useEffect, useMemo } = React;
    
    // Supabase Configuration
    const SUPABASE_URL = 'https://ktctvaeulualihczwnrl.supabase.co';
    const SUPABASE_ANON_KEY = 'sb_publishable_NlZjP1W6SO7j7jrbv8gARA_HgZlRxLY';
    
    const supabase = window.supabase?.createClient(SUPABASE_URL, SUPABASE_ANON_KEY, {
      auth: {
        persistSession: true,
        autoRefreshToken: true,
        storage: window.localStorage
      }
    });
    
    // ============================================
    // CONFIGURATION
    // ============================================
    
    const FRICTION_OPTIONS = [
      { id: 'none', emoji: 'ðŸ˜Š', label: 'None', score: 0 },
      { id: 'low', emoji: 'ðŸ™‚', label: 'Low', score: 1 },
      { id: 'medium', emoji: 'ðŸ˜', label: 'Medium', score: 2 },
      { id: 'high', emoji: 'ðŸ˜£', label: 'High', score: 3 },
      { id: 'severe', emoji: 'ðŸ˜«', label: 'Severe', score: 4 }
    ];
    
    // ============================================
    // RESPONSE VIEWER APP
    // ============================================
    
    function ResponseViewer() {
      const [loading, setLoading] = useState(true);
      const [error, setError] = useState(null);
      const [maps, setMaps] = useState([]);
      const [mapResponseCounts, setMapResponseCounts] = useState({});
      const [selectedMapId, setSelectedMapId] = useState(null);
      const [mapConfig, setMapConfig] = useState(null);
      const [responses, setResponses] = useState([]);
      const [invitations, setInvitations] = useState([]);
      const [filterRole, setFilterRole] = useState('all');
      const [filterStage, setFilterStage] = useState('all');
      const [viewMode, setViewMode] = useState('responses'); // 'responses', 'comparison', or 'tracking'
      const [expandedCards, setExpandedCards] = useState(new Set());
      const [user, setUser] = useState(null);
      const [profile, setProfile] = useState(null);
      const [showMobileMenu, setShowMobileMenu] = useState(false);
      const [showProfileMenu, setShowProfileMenu] = useState(false);
      
      // Helper to get user initials
      const getInitials = (name) => {
        if (!name) return '?';
        return name.split(' ').map(n => n[0]).join('').toUpperCase().slice(0, 2);
      };
      
      // Close profile menu when clicking outside
      useEffect(() => {
        const handleClickOutside = (e) => {
          if (showProfileMenu && !e.target.closest('.profile-container')) {
            setShowProfileMenu(false);
          }
        };
        document.addEventListener('click', handleClickOutside);
        return () => document.removeEventListener('click', handleClickOutside);
      }, [showProfileMenu]);
      
      // Get map ID from URL (support both 'id' for Supabase and 'map' for legacy)
      const urlParams = new URLSearchParams(window.location.search);
      const mapIdFromUrl = urlParams.get('id') || urlParams.get('map');
      
      // Load user from Supabase
      useEffect(() => {
        if (!supabase) return;
        
        supabase.auth.getSession().then(({ data: { session } }) => {
          if (session?.user) {
            setUser(session.user);
            supabase
              .from('users')
              .select('display_name, organisation_id, role, avatar_url')
              .eq('id', session.user.id)
              .single()
              .then(({ data }) => {
                if (data) {
                  setProfile(data);
                }
              });
          }
        });
        
        const { data: { subscription } } = supabase.auth.onAuthStateChange((event, session) => {
          setUser(session?.user ?? null);
          if (!session?.user) setProfile(null);
        });
        
        return () => subscription?.unsubscribe();
      }, []);
      
      const handleSignOut = async () => {
        if (supabase) {
          await supabase.auth.signOut();
        }
        window.location.href = 'index.html';
      };
      
      // Display name helper
      const displayName = profile?.display_name || user?.email?.split('@')[0] || 'User';
      const canManageTeam = profile?.role === 'owner' || profile?.role === 'admin';
      
      // Initial load - either load maps list or specific map
      useEffect(() => {
        if (!profile?.organisation_id) return;
        
        if (mapIdFromUrl) {
          setSelectedMapId(mapIdFromUrl);
        } else {
          loadMapsWithCounts();
        }
      }, [mapIdFromUrl, profile?.organisation_id]);
      
      // Load responses when a map is selected
      useEffect(() => {
        if (selectedMapId) {
          loadData(selectedMapId);
        }
      }, [selectedMapId]);
      
      // Load maps from Supabase with response counts from localStorage
      const loadMapsWithCounts = async () => {
        if (!supabase || !profile?.organisation_id) return;
        
        try {
          const { data, error } = await supabase
            .from('journey_maps')
            .select('id, title, journey_type, created_at')
            .eq('organisation_id', profile.organisation_id)
            .is('archived_at', null)
            .order('updated_at', { ascending: false });
          
          if (error) throw error;
          
          const mapsList = data || [];
          setMaps(mapsList);
          
          // Check response counts from localStorage
          const counts = {};
          mapsList.forEach(map => {
            counts[map.id] = getResponseCount(map.id);
          });
          setMapResponseCounts(counts);
          
          setLoading(false);
        } catch (err) {
          setError(err.message);
          setLoading(false);
        }
      };
      
      // Get response count for a map (localStorage only for now)
      const getResponseCount = (mapId) => {
        const localResponses = JSON.parse(localStorage.getItem('fathom-survey-responses') || '[]')
          .filter(r => r.mapId === mapId);
        return localResponses.length;
      };
      
      // Handle map selection
      const handleMapSelect = (mapId) => {
        setSelectedMapId(mapId);
        // Update URL without reload
        window.history.pushState({}, '', `responses.html?id=${mapId}`);
      };
      
      const loadData = async (mapId) => {
        if (!supabase) return;
        
        setLoading(true);
        setError(null);
        try {
          // Load map configuration from Supabase
          const { data, error } = await supabase
            .from('journey_maps')
            .select('config, title')
            .eq('id', mapId)
            .single();
          
          if (error) throw error;
          if (!data?.config) throw new Error('Could not load journey map');
          
          setMapConfig(data.config);
          
          // Load responses from Supabase
          const { data: supabaseResponses, error: respError } = await supabase
            .from('survey_responses')
            .select('*')
            .eq('journey_map_id', mapId)
            .order('submitted_at', { ascending: false });
          
          if (respError) {
            console.error('Error loading responses:', respError);
          }
          
          // Normalize Supabase responses to match expected format
          const normalizedResponses = (supabaseResponses || []).map(r => ({
            surveyId: r.survey_id,
            mapId: r.journey_map_id,
            roleId: r.role_id,
            roleName: r.role_name,
            respondent: {
              email: r.respondent_email,
              name: r.respondent_name
            },
            respondentEmail: r.respondent_email,
            respondentName: r.respondent_name,
            submittedAt: r.submitted_at,
            responses: r.responses || []
          }));
          
          // Also check localStorage for legacy responses
          const localResponses = JSON.parse(localStorage.getItem('fathom-survey-responses') || '[]')
            .filter(r => r.mapId === mapId);
          
          // Merge, avoiding duplicates by surveyId
          const existingIds = new Set(normalizedResponses.map(r => r.surveyId));
          const mergedResponses = [
            ...normalizedResponses,
            ...localResponses.filter(r => !existingIds.has(r.surveyId))
          ];
          
          // Sort by submission date (newest first)
          mergedResponses.sort((a, b) => new Date(b.submittedAt) - new Date(a.submittedAt));
          
          setResponses(mergedResponses);
          
          // Load invitations from Supabase
          const { data: supabaseInvitations, error: invError } = await supabase
            .from('survey_invitations')
            .select('*')
            .eq('journey_map_id', mapId)
            .order('sent_at', { ascending: false });
          
          if (invError) {
            console.error('Error loading invitations:', invError);
          }
          
          // Normalize Supabase invitations to match expected format
          const normalizedInvitations = (supabaseInvitations || []).map(inv => ({
            id: inv.id,
            mapId: inv.journey_map_id,
            mapTitle: data.config?.meta?.title || 'Journey Map',
            roleId: inv.role_id,
            roleName: inv.role_name,
            email: inv.email,
            name: inv.name,
            url: inv.survey_url,
            stepCount: inv.step_count,
            sentAt: inv.sent_at,
            lastSentAt: inv.last_sent_at,
            sendCount: inv.send_count,
            startedAt: inv.started_at,
            completedAt: inv.completed_at
          }));
          
          // Also check localStorage for legacy invitations
          const localInvitations = JSON.parse(localStorage.getItem('fathom-survey-invitations') || '[]')
            .filter(inv => inv.mapId === mapId);
          
          // Merge, avoiding duplicates by mapId + roleId + email
          const existingInvKeys = new Set(normalizedInvitations.map(i => `${i.mapId}-${i.roleId}-${i.email}`));
          const mergedInvitations = [
            ...normalizedInvitations,
            ...localInvitations.filter(i => !existingInvKeys.has(`${i.mapId}-${i.roleId}-${i.email}`))
          ];
          
          setInvitations(mergedInvitations);
          
          setLoading(false);
        } catch (err) {
          console.error('Load error:', err);
          setError(err.message);
          setLoading(false);
        }
      };
      
      // Get invitation status - check if person has responded
      const getInvitationStatus = (invitation) => {
        // Find matching responses
        const matchingResponses = responses.filter(r => 
          r.mapId === invitation.mapId && 
          r.roleId === invitation.roleId &&
          (r.respondent?.email === invitation.email || r.respondentEmail === invitation.email)
        );
        
        if (matchingResponses.length === 0) {
          return { status: 'pending', label: 'Awaiting Response', color: '#F59E0B' };
        }
        
        // Check completion - count unique steps responded to
        const stepsResponded = new Set();
        matchingResponses.forEach(r => {
          r.responses?.forEach(resp => {
            if (resp.stepId) stepsResponded.add(resp.stepId);
          });
        });
        
        const totalSteps = invitation.stepCount || 1;
        const completedSteps = stepsResponded.size;
        const percentage = Math.round((completedSteps / totalSteps) * 100);
        
        if (percentage >= 100) {
          return { status: 'complete', label: 'Complete', color: '#10B981', percentage: 100 };
        } else if (percentage > 0) {
          return { status: 'partial', label: `${percentage}% Complete`, color: '#3B82F6', percentage };
        }
        
        return { status: 'started', label: 'Started', color: '#3B82F6', percentage: 0 };
      };
      
      // Send reminder email
      const sendReminder = async (invitation) => {
        // Update invitation record in Supabase
        if (supabase && invitation.id) {
          try {
            const { error } = await supabase
              .from('survey_invitations')
              .update({
                last_sent_at: new Date().toISOString(),
                send_count: (invitation.sendCount || 1) + 1
              })
              .eq('id', invitation.id);
            
            if (error) {
              console.error('Error updating invitation:', error);
            } else {
              // Update local state
              setInvitations(prev => prev.map(inv => 
                inv.id === invitation.id 
                  ? { ...inv, lastSentAt: new Date().toISOString(), sendCount: (inv.sendCount || 1) + 1 }
                  : inv
              ));
            }
          } catch (err) {
            console.error('Failed to update invitation:', err);
          }
        }
        
        const subject = encodeURIComponent(`Reminder: Process Survey - ${invitation.mapTitle}`);
        const body = encodeURIComponent(`Hi ${invitation.name},

Just a friendly reminder about the process survey we sent earlier.

We'd really appreciate your input on the "${invitation.mapTitle}" process. It should only take about ${Math.ceil(invitation.stepCount * 2)} minutes.

Complete the survey here:
${invitation.url}

Thank you!`);
        
        window.open(`mailto:${invitation.email}?subject=${subject}&body=${body}`, '_blank');
      };
      
      // Set default view mode based on data
      useEffect(() => {
        if (invitations.length > 0 && responses.length === 0) {
          setViewMode('tracking');
        } else if (responses.length > 0) {
          // Keep current view or default to responses
          if (viewMode !== 'tracking' && viewMode !== 'comparison') {
            setViewMode('responses');
          }
        }
      }, [invitations.length, responses.length]);
      
      // Get unique roles and stages from responses
      const roles = useMemo(() => {
        const roleMap = new Map();
        responses.forEach(r => {
          if (!roleMap.has(r.roleId)) {
            roleMap.set(r.roleId, r.roleName);
          }
        });
        return Array.from(roleMap.entries()).map(([id, name]) => ({ id, name }));
      }, [responses]);
      
      const stages = useMemo(() => {
        if (!mapConfig?.stages) return [];
        return mapConfig.stages.map(s => ({ id: s.id, name: s.name }));
      }, [mapConfig]);
      
      // Filter responses
      const filteredResponses = useMemo(() => {
        return responses.filter(r => {
          if (filterRole !== 'all' && r.roleId !== filterRole) return false;
          return true;
        });
      }, [responses, filterRole]);
      
      // Calculate stats
      const stats = useMemo(() => {
        const totalResponses = responses.length;
        const responsesByRole = {};
        let totalFrictionScore = 0;
        let frictionCount = 0;
        let totalTimeVariance = 0;
        let timeVarianceCount = 0;
        
        responses.forEach(r => {
          responsesByRole[r.roleId] = (responsesByRole[r.roleId] || 0) + 1;
          
          r.responses?.forEach(sr => {
            const friction = FRICTION_OPTIONS.find(f => f.id === sr.friction);
            if (friction) {
              totalFrictionScore += friction.score;
              frictionCount++;
            }
            
            // Calculate time variance if we have map data
            if (sr.timeEstimate && mapConfig) {
              const step = mapConfig.stages
                ?.flatMap(s => s.steps || [])
                ?.find(s => s.id === sr.stepId);
              
              if (step?.time) {
                totalTimeVariance += (parseInt(sr.timeEstimate) - step.time);
                timeVarianceCount++;
              }
            }
          });
        });
        
        const avgFriction = frictionCount > 0 ? totalFrictionScore / frictionCount : 0;
        const avgTimeVariance = timeVarianceCount > 0 ? totalTimeVariance / timeVarianceCount : 0;
        
        return {
          totalResponses,
          responsesByRole,
          avgFriction,
          avgTimeVariance,
          frictionLabel: avgFriction < 1 ? 'Low' : avgFriction < 2 ? 'Medium' : 'High'
        };
      }, [responses, mapConfig]);
      
      // Invitation stats
      const invitationStats = useMemo(() => {
        const total = invitations.length;
        let responded = 0;
        let complete = 0;
        
        invitations.forEach(inv => {
          const status = getInvitationStatus(inv);
          if (status.status !== 'pending') {
            responded++;
          }
          if (status.status === 'complete') {
            complete++;
          }
        });
        
        const responseRate = total > 0 ? Math.round((responded / total) * 100) : 0;
        const completionRate = responded > 0 ? Math.round((complete / responded) * 100) : 0;
        
        return {
          total,
          responded,
          complete,
          pending: total - responded,
          responseRate,
          completionRate
        };
      }, [invitations, responses]);
      
      // Build comparison data (step by step)
      const comparisonData = useMemo(() => {
        if (!mapConfig?.stages) return [];
        
        const data = [];
        
        mapConfig.stages.forEach(stage => {
          if (filterStage !== 'all' && stage.id !== filterStage) return;
          
          stage.steps?.forEach(step => {
            // Get all responses for this step
            const stepResponses = [];
            filteredResponses.forEach(r => {
              const sr = r.responses?.find(sr => sr.stepId === step.id);
              if (sr) {
                stepResponses.push({
                  ...sr,
                  respondentName: r.respondent?.name || r.respondentName,
                  roleName: r.roleName
                });
              }
            });
            
            if (stepResponses.length === 0 && filterRole !== 'all') return;
            
            // Calculate aggregates
            const times = stepResponses
              .map(sr => parseInt(sr.timeEstimate))
              .filter(t => !isNaN(t));
            
            const frictionScores = stepResponses
              .map(sr => FRICTION_OPTIONS.find(f => f.id === sr.friction)?.score)
              .filter(s => s !== undefined);
            
            const avgTime = times.length > 0 
              ? times.reduce((a, b) => a + b, 0) / times.length 
              : null;
            
            const avgFriction = frictionScores.length > 0
              ? frictionScores.reduce((a, b) => a + b, 0) / frictionScores.length
              : null;
            
            const painPoints = stepResponses
              .filter(sr => sr.painPoints)
              .map(sr => ({ text: sr.painPoints, author: sr.respondentName, role: sr.roleName }));
            
            const improvements = stepResponses
              .filter(sr => sr.improvements)
              .map(sr => ({ text: sr.improvements, author: sr.respondentName, role: sr.roleName }));
            
            data.push({
              stepId: step.id,
              stepName: step.name,
              stageId: stage.id,
              stageName: stage.name,
              estimate: {
                time: step.time,
                friction: step.friction
              },
              responses: {
                count: stepResponses.length,
                avgTime,
                minTime: times.length > 0 ? Math.min(...times) : null,
                maxTime: times.length > 0 ? Math.max(...times) : null,
                avgFriction,
                painPoints,
                improvements
              }
            });
          });
        });
        
        return data;
      }, [mapConfig, filteredResponses, filterStage]);
      
      // Toggle card expansion
      const toggleCard = (id) => {
        setExpandedCards(prev => {
          const next = new Set(prev);
          if (next.has(id)) {
            next.delete(id);
          } else {
            next.add(id);
          }
          return next;
        });
      };
      
      // Format date
      const formatDate = (dateStr) => {
        const date = new Date(dateStr);
        return date.toLocaleDateString('en-GB', { 
          day: 'numeric', 
          month: 'short', 
          year: 'numeric',
          hour: '2-digit',
          minute: '2-digit'
        });
      };
      
      // Get friction badge class
      const getFrictionBadgeClass = (frictionId) => {
        const score = FRICTION_OPTIONS.find(f => f.id === frictionId)?.score || 0;
        if (score >= 3) return 'badge-friction-high';
        if (score >= 2) return 'badge-friction-medium';
        return 'badge-friction-low';
      };
      
      // Calculate overall friction for a response
      const getResponseFriction = (response) => {
        const scores = response.responses
          ?.map(sr => FRICTION_OPTIONS.find(f => f.id === sr.friction)?.score)
          ?.filter(s => s !== undefined) || [];
        
        if (scores.length === 0) return null;
        
        const avg = scores.reduce((a, b) => a + b, 0) / scores.length;
        
        if (avg >= 3) return { label: 'High Friction', class: 'badge-friction-high' };
        if (avg >= 2) return { label: 'Medium Friction', class: 'badge-friction-medium' };
        return { label: 'Low Friction', class: 'badge-friction-low' };
      };
      
      // ============================================
      // RENDER
      // ============================================
      
      // Navigation component
      const Nav = ({ title }) => (
        <>
        <nav className="nav">
          <div className="nav-inner">
            <div className="nav-left">
              <a href="index.html">
                <img src="https://steveyoung74.github.io/journeymaps/logo_light.png" alt="FATHOM" className="nav-logo" />
              </a>
              {user && (
                <div className="nav-links">
                  <a href="dashboard.html" className="nav-link">Dashboard</a>
                  <div className="nav-dropdown">
                    <span className="nav-link active">Surveys â–¾</span>
                    <div className="nav-dropdown-menu">
                      <a href="survey-admin.html" className="nav-dropdown-item">Send Surveys</a>
                      <a href="responses.html" className="nav-dropdown-item">View Responses</a>
                    </div>
                  </div>
                  {canManageTeam && (
                    <a href="team.html" className="nav-link">Team</a>
                  )}
                  <a href="whats-new.html" className="nav-link">What's New</a>
                  <a href="about.html" className="nav-link">About</a>
                </div>
              )}
            </div>
            <div className="nav-right">
              {user ? (
                <div className="profile-container" style={{ position: 'relative' }}>
                  <button 
                    className={`profile-trigger ${showProfileMenu ? 'open' : ''}`}
                    onClick={(e) => { e.stopPropagation(); setShowProfileMenu(!showProfileMenu); }}
                  >
                    <div className="profile-avatar">
                      {profile?.avatar_url ? (
                        <img src={profile.avatar_url} alt="" />
                      ) : (
                        getInitials(displayName)
                      )}
                    </div>
                    <span className="profile-chevron">â–¼</span>
                  </button>
                  
                  <div className={`profile-dropdown ${showProfileMenu ? 'open' : ''}`}>
                    <div className="profile-dropdown-header">
                      <div className="profile-dropdown-avatar">
                        {profile?.avatar_url ? (
                          <img src={profile.avatar_url} alt="" style={{ width: '100%', height: '100%', objectFit: 'cover' }} />
                        ) : (
                          getInitials(displayName)
                        )}
                      </div>
                      <div className="profile-dropdown-info">
                        <div className="profile-dropdown-name">{profile?.display_name || 'User'}</div>
                        <div className="profile-dropdown-email">{user?.email}</div>
                      </div>
                    </div>
                    
                    <a href="profile.html" className="profile-dropdown-item" onClick={() => setShowProfileMenu(false)}>
                      <span className="icon">ðŸ‘¤</span>
                      Profile Settings
                    </a>
                    
                    {canManageTeam && (
                      <a href="team.html" className="profile-dropdown-item" onClick={() => setShowProfileMenu(false)}>
                        <span className="icon">ðŸ‘¥</span>
                        Team Management
                      </a>
                    )}
                    
                    <div className="profile-dropdown-divider" />
                    
                    <a href="whats-new.html" className="profile-dropdown-item" onClick={() => setShowProfileMenu(false)}>
                      <span className="icon">âœ¨</span>
                      What's New
                    </a>
                    <a href="about.html" className="profile-dropdown-item" onClick={() => setShowProfileMenu(false)}>
                      <span className="icon">â„¹ï¸</span>
                      About Fathom
                    </a>
                    
                    <div className="profile-dropdown-divider" />
                    
                    <button 
                      className="profile-dropdown-item danger"
                      onClick={() => { setShowProfileMenu(false); handleSignOut(); }}
                    >
                      <span className="icon">ðŸšª</span>
                      Sign Out
                    </button>
                  </div>
                </div>
              ) : (
                <a href="dashboard.html" className="nav-link" style={{ color: '#FFF' }}>Sign In</a>
              )}
            </div>
            {/* Mobile hamburger */}
            <button className="nav-mobile-toggle" onClick={() => setShowMobileMenu(true)}>
              â˜°
            </button>
          </div>
        </nav>
        
        {/* Mobile Menu - Threads-style */}
        <div className={`nav-mobile-backdrop ${showMobileMenu ? 'open' : ''}`} onClick={() => setShowMobileMenu(false)} />
        <div className={`nav-mobile-menu ${showMobileMenu ? 'open' : ''}`}>
          <div className="nav-mobile-header">
            <button className="nav-mobile-close" onClick={() => setShowMobileMenu(false)}>âœ•</button>
          </div>
          <div className="nav-mobile-links">
            {user && (
              <>
                <a href="dashboard.html" className="nav-mobile-link">Dashboard</a>
                <div className="nav-mobile-section-label">Surveys</div>
                <a href="survey-admin.html" className="nav-mobile-link">Send Surveys</a>
                <a href="responses.html" className="nav-mobile-link active">View Responses</a>
                {canManageTeam && (
                  <>
                    <div className="nav-mobile-section-label">Organisation</div>
                    <a href="team.html" className="nav-mobile-link">Team</a>
                  </>
                )}
                <div className="nav-mobile-section-label">Info</div>
              </>
            )}
            <a href="whats-new.html" className="nav-mobile-link">What's New</a>
            <a href="about.html" className="nav-mobile-link">About</a>
          </div>
          <div className="nav-mobile-user">
            {user ? (
              <>
                <div className="nav-mobile-user-name">Signed in as {displayName}</div>
                <button onClick={() => { setShowMobileMenu(false); handleSignOut(); }} className="nav-mobile-signout">Sign Out</button>
              </>
            ) : (
              <a href="dashboard.html" className="nav-mobile-signout" style={{ display: 'block', textAlign: 'center', textDecoration: 'none' }}>Sign In</a>
            )}
          </div>
        </div>
        </>
      );
      
      if (loading) {
        return (
          <div className="page-bg">
            <Nav />
            <main className="main">
              <div className="loading">
                <div className="loading-spinner"></div>
                <p>Loading...</p>
              </div>
            </main>
          </div>
        );
      }
      
      // Show map selector if no map selected
      if (!selectedMapId) {
        return (
          <div className="page-bg">
            <Nav />
            <main className="main">
              <div className="page-header-row">
                <div>
                  <h1 className="page-title">Survey Responses</h1>
                  <p className="page-subtitle">Select a journey map to view survey feedback</p>
                </div>
              </div>
              
              {maps.length === 0 ? (
                <div className="empty-state">
                  <div className="empty-icon">ðŸ“Š</div>
                  <h2>No Journey Maps</h2>
                  <p>Create a journey map first to start collecting survey responses.</p>
                  <a href="dashboard.html" className="btn btn-primary">Go to Dashboard</a>
                </div>
              ) : (
                <div className="map-list">
                  {maps.map(map => {
                    const count = mapResponseCounts[map.id] || 0;
                    return (
                      <div 
                        key={map.id} 
                        className="map-card"
                        onClick={() => handleMapSelect(map.id)}
                      >
                        <div className="map-card-content">
                          <h3>{map.title}</h3>
                          <p className="map-card-meta">
                            {map.stageCount || 'â€”'} stages â€¢ {map.stepCount || 'â€”'} steps
                          </p>
                        </div>
                        <div className="map-card-responses">
                          {count > 0 ? (
                            <>
                              <span className="response-count">{count}</span>
                              <span className="response-label">response{count !== 1 ? 's' : ''}</span>
                            </>
                          ) : (
                            <span className="no-responses">No responses yet</span>
                          )}
                        </div>
                        <div className="map-card-arrow">â†’</div>
                      </div>
                    );
                  })}
                </div>
              )}
            </main>
          </div>
        );
      }
      
      if (error) {
        return (
          <div className="page-bg">
            <Nav />
            <main className="main">
              <div className="empty-state">
                <div className="empty-icon">âš ï¸</div>
                <h2>Unable to Load Responses</h2>
                <p>{error}</p>
                <a href="dashboard.html" className="btn btn-primary">Go to Dashboard</a>
              </div>
            </main>
          </div>
        );
      }
      
      return (
        <div className="page-bg">
          <Nav />
          
          <main className="main">
            {/* Page Header */}
            <div className="page-header-row">
              <div>
                <h1 className="page-title">{mapConfig?.meta?.title || 'Survey Responses'}</h1>
                <p className="page-subtitle">View and analyse survey feedback from your team</p>
              </div>
              <div style={{ display: 'flex', gap: '12px' }}>
                <button 
                  onClick={() => { setSelectedMapId(null); setMapConfig(null); setResponses([]); window.history.pushState({}, '', 'responses.html'); loadMapsWithCounts(); }}
                  className="btn btn-secondary"
                >
                  â† All Maps
                </button>
                <a href={`survey-admin.html?map=${selectedMapId}`} className="btn btn-primary">
                  ðŸ“¤ Send More Surveys
                </a>
              </div>
            </div>
            
            {/* Stats */}
            <div className="stats-grid">
              <div className="stat-card highlight">
                <div className="stat-label">Total Responses</div>
                <div className="stat-value">{stats.totalResponses}</div>
                <div className="stat-sub">{roles.length} role{roles.length !== 1 ? 's' : ''} represented</div>
              </div>
              
              <div className="stat-card">
                <div className="stat-label">Avg Time Variance</div>
                <div className="stat-value" style={{ color: stats.avgTimeVariance > 0 ? 'var(--error)' : 'var(--success)' }}>
                  {stats.avgTimeVariance > 0 ? '+' : ''}{Math.round(stats.avgTimeVariance)} min
                </div>
                <div className="stat-sub">{stats.avgTimeVariance > 0 ? 'Longer than estimated' : 'Shorter than estimated'}</div>
              </div>
              
              <div className="stat-card">
                <div className="stat-label">Avg Friction Level</div>
                <div className="stat-value">{stats.frictionLabel}</div>
                <div className="stat-sub">Score: {stats.avgFriction.toFixed(1)} / 4</div>
              </div>
              
              <div className="stat-card">
                <div className="stat-label">Response Rate</div>
                {invitations.length > 0 ? (
                  <>
                    <div className="stat-value">{invitationStats.responseRate}%</div>
                    <div className="stat-sub">{invitationStats.responded} of {invitationStats.total} responded</div>
                  </>
                ) : (
                  <>
                    <div className="stat-value">â€”</div>
                    <div className="stat-sub">Send surveys to track</div>
                  </>
                )}
              </div>
            </div>
            
            {responses.length === 0 && invitations.length === 0 ? (
              <div className="empty-state">
                <div className="empty-icon">ðŸ“­</div>
                <h2>No Responses Yet</h2>
                <p>Survey responses will appear here once people complete them.</p>
                <a href={`survey-admin.html?id=${selectedMapId}`} className="btn btn-primary">
                  ðŸ“¤ Send Survey Invitations
                </a>
              </div>
            ) : (
              <>
                {/* Filters */}
                <div className="filters-bar">
                  <div className="filter-group">
                    <span className="filter-label">Role:</span>
                    <select 
                      className="filter-select"
                      value={filterRole}
                      onChange={(e) => setFilterRole(e.target.value)}
                    >
                      <option value="all">All Roles</option>
                      {roles.map(role => (
                        <option key={role.id} value={role.id}>
                          {role.name} ({stats.responsesByRole[role.id] || 0})
                        </option>
                      ))}
                    </select>
                  </div>
                  
                  {viewMode === 'comparison' && (
                    <div className="filter-group">
                      <span className="filter-label">Stage:</span>
                      <select 
                        className="filter-select"
                        value={filterStage}
                        onChange={(e) => setFilterStage(e.target.value)}
                      >
                        <option value="all">All Stages</option>
                        {stages.map(stage => (
                          <option key={stage.id} value={stage.id}>{stage.name}</option>
                        ))}
                      </select>
                    </div>
                  )}
                  
                  <div className="view-toggle">
                    <button 
                      className={`view-btn ${viewMode === 'tracking' ? 'active' : ''}`}
                      onClick={() => setViewMode('tracking')}
                    >
                      ðŸ“‹ Tracking ({invitations.length})
                    </button>
                    <button 
                      className={`view-btn ${viewMode === 'responses' ? 'active' : ''}`}
                      onClick={() => setViewMode('responses')}
                    >
                      By Person
                    </button>
                    <button 
                      className={`view-btn ${viewMode === 'comparison' ? 'active' : ''}`}
                      onClick={() => setViewMode('comparison')}
                    >
                      By Step
                    </button>
                  </div>
                </div>
                
                {/* Tracking View */}
                {viewMode === 'tracking' && (
                  <div className="tracking-view">
                    {invitations.length === 0 ? (
                      <div className="empty-state">
                        <div className="empty-icon">ðŸ“§</div>
                        <h2>No Invitations Sent</h2>
                        <p>Send survey invitations to track who has responded.</p>
                        <a href={`survey-admin.html?id=${selectedMapId}`} className="btn btn-primary">
                          ðŸ“¤ Send Survey Invitations
                        </a>
                      </div>
                    ) : (
                      <>
                        <div style={{ 
                          display: 'grid', 
                          gridTemplateColumns: 'repeat(3, 1fr)', 
                          gap: '12px', 
                          marginBottom: '24px',
                          padding: '16px',
                          background: '#F8FAFC',
                          borderRadius: '12px'
                        }}>
                          <div style={{ textAlign: 'center' }}>
                            <div style={{ fontSize: '24px', fontWeight: 700, color: '#F59E0B' }}>{invitationStats.pending}</div>
                            <div style={{ fontSize: '12px', color: '#64748B' }}>Awaiting Response</div>
                          </div>
                          <div style={{ textAlign: 'center' }}>
                            <div style={{ fontSize: '24px', fontWeight: 700, color: '#3B82F6' }}>{invitationStats.responded - invitationStats.complete}</div>
                            <div style={{ fontSize: '12px', color: '#64748B' }}>In Progress</div>
                          </div>
                          <div style={{ textAlign: 'center' }}>
                            <div style={{ fontSize: '24px', fontWeight: 700, color: '#10B981' }}>{invitationStats.complete}</div>
                            <div style={{ fontSize: '12px', color: '#64748B' }}>Complete</div>
                          </div>
                        </div>
                        
                        <div className="responses-list">
                          {invitations.map((invitation, index) => {
                            const status = getInvitationStatus(invitation);
                            const sentDate = new Date(invitation.sentAt);
                            const daysSinceSent = Math.floor((new Date() - sentDate) / (1000 * 60 * 60 * 24));
                            
                            return (
                              <div key={invitation.id || index} className="response-card" style={{ borderLeft: `4px solid ${status.color}` }}>
                                <div className="response-header" style={{ cursor: 'default' }}>
                                  <div className="response-meta">
                                    <div className="response-avatar" style={{ background: status.color }}>
                                      {invitation.name?.charAt(0)?.toUpperCase() || invitation.email?.charAt(0)?.toUpperCase() || '?'}
                                    </div>
                                    <div className="response-info">
                                      <h3>{invitation.name || invitation.email}</h3>
                                      <p>{invitation.email}</p>
                                    </div>
                                  </div>
                                  
                                  <div className="response-badges">
                                    <span className="badge badge-role">{invitation.roleName}</span>
                                    <span className="badge" style={{ 
                                      background: status.color + '20',
                                      color: status.color
                                    }}>
                                      {status.label}
                                    </span>
                                    <span className="badge" style={{ background: '#F1F5F9' }}>
                                      Sent {daysSinceSent === 0 ? 'today' : daysSinceSent === 1 ? 'yesterday' : `${daysSinceSent} days ago`}
                                    </span>
                                  </div>
                                </div>
                                
                                <div style={{ 
                                  padding: '12px 16px', 
                                  borderTop: '1px solid #E2E8F0',
                                  display: 'flex',
                                  justifyContent: 'space-between',
                                  alignItems: 'center'
                                }}>
                                  <div style={{ fontSize: '13px', color: '#64748B' }}>
                                    {invitation.stepCount} step{invitation.stepCount !== 1 ? 's' : ''} to complete
                                    {invitation.sendCount > 1 && (
                                      <span style={{ marginLeft: '8px', color: '#94A3B8' }}>
                                        â€¢ Reminded {invitation.sendCount - 1} time{invitation.sendCount > 2 ? 's' : ''}
                                      </span>
                                    )}
                                  </div>
                                  
                                  {status.status === 'pending' && (
                                    <button 
                                      className="btn btn-secondary"
                                      onClick={() => sendReminder(invitation)}
                                      style={{ 
                                        display: 'flex', 
                                        alignItems: 'center', 
                                        gap: '6px',
                                        padding: '6px 12px',
                                        fontSize: '13px'
                                      }}
                                    >
                                      ðŸ”” Send Reminder
                                    </button>
                                  )}
                                  
                                  {status.status === 'complete' && (
                                    <span style={{ color: '#10B981', fontSize: '13px', fontWeight: 500 }}>
                                      âœ“ Complete
                                    </span>
                                  )}
                                </div>
                              </div>
                            );
                          })}
                        </div>
                      </>
                    )}
                  </div>
                )}
                
                {/* Responses View */}
                {viewMode === 'responses' && (
                  <div className="responses-list">
                    {filteredResponses.map(response => {
                      const isExpanded = expandedCards.has(response.surveyId);
                      const friction = getResponseFriction(response);
                      
                      return (
                        <div key={response.surveyId} className="response-card">
                          <div 
                            className="response-header"
                            onClick={() => toggleCard(response.surveyId)}
                          >
                            <div className="response-meta">
                              <div className="response-avatar">
                                {getInitials(response.respondent?.name || response.respondentName)}
                              </div>
                              <div className="response-info">
                                <h3>{response.respondent?.name || response.respondentName}</h3>
                                <p>{formatDate(response.submittedAt)}</p>
                              </div>
                            </div>
                            
                            <div className="response-badges">
                              <span className="badge badge-role">{response.roleName}</span>
                              <span className="badge badge-steps">{response.responses?.length || 0} steps</span>
                              {friction && (
                                <span className={`badge ${friction.class}`}>{friction.label}</span>
                              )}
                              <span className={`expand-icon ${isExpanded ? 'expanded' : ''}`}>â–¼</span>
                            </div>
                          </div>
                          
                          <div className={`response-body ${isExpanded ? 'expanded' : ''}`}>
                            <div className="step-responses">
                              {response.responses?.map(sr => {
                                const frictionOpt = FRICTION_OPTIONS.find(f => f.id === sr.friction);
                                
                                // Get original step data for comparison
                                const originalStep = mapConfig?.stages
                                  ?.flatMap(s => s.steps || [])
                                  ?.find(s => s.id === sr.stepId);
                                
                                const timeVariance = sr.timeEstimate && originalStep?.time
                                  ? parseInt(sr.timeEstimate) - originalStep.time
                                  : null;
                                
                                return (
                                  <div key={sr.stepId} className="step-response">
                                    <div className="step-response-header">
                                      <div>
                                        <div className="step-name">{sr.stepName}</div>
                                        <div className="step-stage">{sr.stageName}</div>
                                      </div>
                                      <div className="step-metrics">
                                        {sr.timeEstimate && (
                                          <div className="metric">
                                            <div className="metric-value">{sr.timeEstimate} min</div>
                                            <div className="metric-label">Time</div>
                                            {timeVariance !== null && (
                                              <div className={`metric-variance ${timeVariance > 0 ? 'variance-higher' : timeVariance < 0 ? 'variance-lower' : 'variance-same'}`}>
                                                {timeVariance > 0 ? '+' : ''}{timeVariance} vs estimate
                                              </div>
                                            )}
                                          </div>
                                        )}
                                        {frictionOpt && (
                                          <div className="friction-display">
                                            <span className="friction-emoji">{frictionOpt.emoji}</span>
                                            <span>{frictionOpt.label}</span>
                                          </div>
                                        )}
                                      </div>
                                    </div>
                                    
                                    <div className="step-content">
                                      {sr.description && (
                                        <dl className="content-field">
                                          <dt>What they do</dt>
                                          <dd>{sr.description}</dd>
                                        </dl>
                                      )}
                                      {sr.painPoints && (
                                        <dl className="content-field">
                                          <dt>Pain Points</dt>
                                          <dd>{sr.painPoints}</dd>
                                        </dl>
                                      )}
                                      {sr.regulatory && (
                                        <dl className="content-field">
                                          <dt>Regulatory</dt>
                                          <dd>{sr.regulatory}</dd>
                                        </dl>
                                      )}
                                      {sr.thirdPartyCosts && (
                                        <dl className="content-field">
                                          <dt>Third Party Costs</dt>
                                          <dd>Â£{sr.thirdPartyCosts}</dd>
                                        </dl>
                                      )}
                                      {sr.improvements && (
                                        <dl className="content-field">
                                          <dt>Improvement Ideas</dt>
                                          <dd>{sr.improvements}</dd>
                                        </dl>
                                      )}
                                    </div>
                                  </div>
                                );
                              })}
                            </div>
                          </div>
                        </div>
                      );
                    })}
                  </div>
                )}
                
                {/* Comparison View */}
                {viewMode === 'comparison' && (
                  <div className="comparison-grid">
                    {comparisonData.map(item => (
                      <div key={item.stepId} className="comparison-row">
                        <div className="comparison-header">
                          <div>
                            <div className="comparison-step-name">{item.stepName}</div>
                            <div className="comparison-step-stage">{item.stageName}</div>
                          </div>
                          <span className="badge badge-steps">{item.responses.count} response{item.responses.count !== 1 ? 's' : ''}</span>
                        </div>
                        
                        <div className="comparison-data">
                          <div className="comparison-column estimate">
                            <h4>Your Estimate</h4>
                            <div className="comparison-value">
                              {item.estimate.time ? `${item.estimate.time} min` : 'â€”'}
                            </div>
                            {item.estimate.friction && (
                              <div className="comparison-detail">
                                Friction: {item.estimate.friction}
                              </div>
                            )}
                          </div>
                          
                          <div className="comparison-column responses">
                            <h4>Survey Responses</h4>
                            {item.responses.avgTime !== null ? (
                              <>
                                <div className="comparison-value">{Math.round(item.responses.avgTime)} min</div>
                                <div className="comparison-detail">
                                  Range: {item.responses.minTime}â€“{item.responses.maxTime} min
                                </div>
                                {item.estimate.time && (
                                  <div className="comparison-detail" style={{ 
                                    color: item.responses.avgTime > item.estimate.time ? 'var(--error)' : 'var(--success)',
                                    fontWeight: 600
                                  }}>
                                    {item.responses.avgTime > item.estimate.time ? '+' : ''}
                                    {Math.round(item.responses.avgTime - item.estimate.time)} min variance
                                  </div>
                                )}
                              </>
                            ) : (
                              <div className="comparison-value" style={{ color: 'var(--slate-400)' }}>â€”</div>
                            )}
                            {item.responses.avgFriction !== null && (
                              <div className="comparison-detail" style={{ marginTop: '8px' }}>
                                Avg Friction: {FRICTION_OPTIONS.find(f => f.score === Math.round(item.responses.avgFriction))?.emoji || 'ðŸ˜'} 
                                {' '}({item.responses.avgFriction.toFixed(1)}/4)
                              </div>
                            )}
                          </div>
                        </div>
                        
                        {(item.responses.painPoints.length > 0 || item.responses.improvements.length > 0) && (
                          <div className="response-quotes">
                            {item.responses.painPoints.length > 0 && (
                              <>
                                <h5>Pain Points Reported</h5>
                                {item.responses.painPoints.map((pp, i) => (
                                  <div key={i} className="quote">
                                    {pp.text}
                                    <div className="quote-author">â€” {pp.author} ({pp.role})</div>
                                  </div>
                                ))}
                              </>
                            )}
                            
                            {item.responses.improvements.length > 0 && (
                              <>
                                <h5 style={{ marginTop: '16px' }}>Improvement Ideas</h5>
                                {item.responses.improvements.map((imp, i) => (
                                  <div key={i} className="quote" style={{ background: 'var(--success-light)', borderColor: 'var(--success)' }}>
                                    {imp.text}
                                    <div className="quote-author">â€” {imp.author} ({imp.role})</div>
                                  </div>
                                ))}
                              </>
                            )}
                          </div>
                        )}
                      </div>
                    ))}
                  </div>
                )}
              </>
            )}
          </main>
          
          <footer className="footer">
            <div className="footer-inner">
              <div className="footer-brand">
                <img src="https://steveyoung74.github.io/journeymaps/logo_light.png" alt="Fathom" className="footer-logo" />
                <span className="footer-version">v8.8.0</span>
              </div>
              <div className="footer-copy">Â© 2025 Fathom Â· Journey intelligence for modern operations</div>
            </div>
          </footer>
        </div>
      );
    }
    
    // ============================================
    // RENDER
    // ============================================
    ReactDOM.createRoot(document.getElementById('root')).render(<ResponseViewer />);
  </script>
</body>
</html>
