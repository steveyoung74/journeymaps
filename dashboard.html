<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, viewport-fit=cover">
  <title>FATHOM - Dashboard</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Open+Sans:wght@400;500;600;700&display=swap" rel="stylesheet">
  <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <style>
    /* Interstate Font Family - Brand/Display Font */
    @font-face {
      font-family: 'Interstate';
      src: url('https://steveyoung74.github.io/journeymaps/fonts/Interstate-light.ttf') format('truetype');
      font-weight: 300;
      font-style: normal;
      font-display: swap;
    }
    @font-face {
      font-family: 'Interstate';
      src: url('https://steveyoung74.github.io/journeymaps/fonts/Interstate-regular.ttf') format('truetype');
      font-weight: 400;
      font-style: normal;
      font-display: swap;
    }
    @font-face {
      font-family: 'Interstate';
      src: url('https://steveyoung74.github.io/journeymaps/fonts/Interstate-bold.ttf') format('truetype');
      font-weight: 700;
      font-style: normal;
      font-display: swap;
    }
    
    /* CSS Custom Properties */
    :root {
      /* Font Families */
      --font-display: 'Interstate', -apple-system, BlinkMacSystemFont, sans-serif;
      --font-body: 'Open Sans', -apple-system, BlinkMacSystemFont, sans-serif;
      
      --navy-950: #0C1620;
      --navy-900: #111E2E;
      --navy-800: #15243A;
      --navy-700: #192B45;
      --navy-600: #243D5C;
      --navy-500: #2F5070;
      --navy-400: #456A8A;
      --navy-300: #6889A8;
      --navy-200: #9BB1C7;
      --navy-100: #C8D5E2;
      --navy-50: #E9EEF4;
      --steel-700: #3A6070;
      --steel-600: #4A7485;
      --steel-500: #5B8A9A;
      --steel-400: #74A0AE;
      --steel-300: #96BCC7;
      --steel-100: #E1EEF2;
      --amber-700: #8B6914;
      --amber-600: #A67D1D;
      --amber-500: #C4942A;
      --amber-400: #D4A84A;
      --amber-200: #E8D5A3;
      --amber-100: #FAF0D6;
      --success: #2D8A6E;
      --success-light: #D4EDE5;
      --error: #B84A5A;
      --error-light: #F5E0E3;
      --slate-900: #1A2332;
      --slate-700: #3D4A5C;
      --slate-600: #556275;
      --slate-500: #6E7B8C;
      --slate-400: #8A95A5;
      --slate-300: #A9B2BE;
      --slate-200: #C8CED6;
      --slate-100: #E4E7EB;
      --slate-50: #F4F5F7;
    }
    
    /* Loading Animation - Sinking into depths */
    @keyframes sinkIntoDepths {
      0% {
        transform: translateY(-100px);
        opacity: 0;
      }
      8% {
        opacity: 0.85;
      }
      85% {
        opacity: 0.12;
      }
      100% {
        transform: translateY(120px);
        opacity: 0;
      }
    }
    
    .loading-screen {
      min-height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
      /* Smooth gradient using brand navy blues */
      background: linear-gradient(
        180deg, 
        #243D5C 0%,
        #213857 10%,
        #1E3351 20%,
        #1C2F4B 30%,
        #192B45 40%,
        #17273F 50%,
        #152339 60%,
        #131F33 70%,
        #111C2E 80%,
        #0F1928 90%,
        #0C1620 100%
      );
      position: relative;
      overflow: hidden;
    }
    
    .loading-logo {
      height: 40px;
      animation: sinkIntoDepths 5s ease-in-out infinite;
      position: relative;
      z-index: 1;
    }
    
    /* Noise texture to break up any remaining banding */
    .loading-screen::before {
      content: '';
      position: absolute;
      inset: 0;
      opacity: 0.12;
      pointer-events: none;
      background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='300' height='300'%3E%3Cfilter id='n' x='0' y='0'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.75' numOctaves='4' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='300' height='300' filter='url(%23n)' opacity='1'/%3E%3C/svg%3E");
    }
    
    /* Base Reset - Mobile First */
    * { box-sizing: border-box; margin: 0; padding: 0; }
    html, body {
      width: 100%;
      max-width: 100%;
      overflow-x: hidden;
      
    }
    body { 
      font-family: var(--font-body); 
      background: var(--slate-50);
      color: var(--slate-900);
      line-height: 1.6;
      min-height: 100vh;
    }
    
    /* Typography - Display font for headings */
    h1, h2, h3, h4, h5, h6 {
      font-family: var(--font-display);
    }
    
    /* Buttons */
    .btn { 
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      padding: 12px 20px; 
      border-radius: 8px; 
      font-size: 14px; 
      font-weight: 500; 
      cursor: pointer; 
      transition: all 0.2s;
      border: none;
      font-family: inherit;
      text-decoration: none;
    }
    .btn:disabled { opacity: 0.5; cursor: not-allowed; }
    .btn-primary { background: var(--success); color: #FFF; }
    .btn-primary:hover:not(:disabled) { background: #257A5E; }
    .btn-secondary { background: #FFF; color: var(--navy-700); border: 2px solid var(--navy-700); }
    .btn-secondary:hover:not(:disabled) { background: var(--navy-50); }
    .btn-ghost { background: transparent; color: var(--slate-600); }
    .btn-ghost:hover:not(:disabled) { background: var(--slate-100); }
    
    /* Form Elements */
    .input {
      width: 100%;
      padding: 12px 14px;
      border: 1px solid var(--slate-200);
      border-radius: 8px;
      font-size: 15px;
      font-family: inherit;
      transition: border-color 0.15s, box-shadow 0.15s;
    }
    .input:focus { 
      outline: none;
      border-color: var(--steel-500); 
      box-shadow: 0 0 0 3px rgba(91, 138, 154, 0.15);
    }
    .label {
      display: block;
      font-size: 14px;
      font-weight: 500;
      color: var(--slate-700);
      margin-bottom: 6px;
    }
    
    /* Cards */
    .card {
      background: #FFF;
      border-radius: 12px;
      box-shadow: 0 2px 12px rgba(25, 43, 69, 0.06);
      border: 1px solid var(--slate-100);
    }
    
    /* Badge */
    .badge {
      display: inline-flex;
      align-items: center;
      padding: 4px 10px;
      border-radius: 16px;
      font-size: 11px;
      font-weight: 500;
    }
    .badge-owner { background: var(--steel-100); color: var(--navy-600); }
    .badge-edit { background: var(--success-light); color: var(--success); }
    .badge-view { background: var(--slate-100); color: var(--slate-600); }
    
    /* Utility */
    .text-muted { color: var(--slate-500); }
    .text-small { font-size: 13px; }
    
    /* Page Layout */
    .page-container {
      min-height: 100vh;
      display: flex;
      flex-direction: column;
    }
    .page-container::before {
      content: '';
      position: fixed;
      inset: 0;
      background: url('https://steveyoung74.github.io/journeymaps/topography-light.svg') center/600px 600px repeat;
      opacity: 1;
      pointer-events: none;
      z-index: -1;
    }
    
    /* Navigation */
    .nav {
      background: linear-gradient(135deg, var(--navy-700) 0%, var(--navy-900) 100%);
      position: sticky;
      top: 0;
      z-index: 100;
    }
    .nav::before {
      content: '';
      position: absolute;
      inset: 0;
      background: url('https://steveyoung74.github.io/journeymaps/topography-dark.svg') center/600px 600px repeat;
      opacity: 1;
      pointer-events: none;
      z-index: 0;
    }
    .nav-inner {
      max-width: 1200px;
      margin: 0 auto;
      padding: 0 24px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      height: 64px;
      position: relative;
      z-index: 1;
    }
    .nav-logo { height: 32px; }
    .nav-left {
      display: flex;
      align-items: center;
      gap: 32px;
    }
    .nav-links {
      display: none;
      align-items: center;
      gap: 4px;
    }
    .nav-link {
      color: rgba(255,255,255,0.7);
      text-decoration: none;
      padding: 8px 16px;
      border-radius: 6px;
      font-size: 14px;
      font-weight: 500;
      transition: all 0.15s;
    }
    .nav-link:hover { color: #FFF; background: rgba(255,255,255,0.1); }
    .nav-link.active { color: #FFF; background: rgba(255,255,255,0.15); }
    .nav-right {
      display: none;
      align-items: center;
      gap: 16px;
    }
    
    /* Profile Dropdown */
    .profile-trigger {
      display: flex;
      align-items: center;
      gap: 6px;
      padding: 3px;
      background: transparent;
      border: none;
      border-radius: 50%;
      cursor: pointer;
      transition: all 0.15s;
      position: relative;
    }
    .profile-trigger:hover {
      background: rgba(255,255,255,0.1);
    }
    .profile-avatar {
      width: 36px;
      height: 36px;
      border-radius: 50%;
      background: var(--steel-500);
      display: flex;
      align-items: center;
      justify-content: center;
      color: #FFF;
      font-size: 14px;
      font-weight: 600;
      text-transform: uppercase;
      overflow: hidden;
      border: 2px solid rgba(255,255,255,0.2);
    }
    .profile-trigger:hover .profile-avatar {
      border-color: rgba(255,255,255,0.4);
    }
    .profile-avatar img {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }
    .profile-chevron {
      position: absolute;
      bottom: 2px;
      right: 0;
      width: 14px;
      height: 14px;
      background: var(--navy-700);
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      color: rgba(255,255,255,0.8);
      font-size: 8px;
      border: 2px solid var(--navy-800);
    }
    .profile-trigger.open .profile-chevron {
      transform: rotate(180deg);
    }
    .profile-dropdown {
      position: absolute;
      top: calc(100% + 8px);
      right: 0;
      background: #FFF;
      border-radius: 12px;
      box-shadow: 0 8px 32px rgba(0,0,0,0.2);
      min-width: 220px;
      padding: 8px 0;
      opacity: 0;
      visibility: hidden;
      transform: translateY(-8px);
      transition: all 0.2s;
      z-index: 1000;
    }
    .profile-dropdown.open {
      opacity: 1;
      visibility: visible;
      transform: translateY(0);
    }
    .profile-dropdown-header {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 12px 16px;
      border-bottom: 1px solid var(--slate-100);
      margin-bottom: 4px;
    }
    .profile-dropdown-avatar {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      background: var(--steel-500);
      display: flex;
      align-items: center;
      justify-content: center;
      color: #FFF;
      font-size: 16px;
      font-weight: 600;
      flex-shrink: 0;
    }
    .profile-dropdown-info {
      flex: 1;
      min-width: 0;
    }
    .profile-dropdown-name {
      font-weight: 600;
      color: var(--slate-900);
      font-size: 14px;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }
    .profile-dropdown-email {
      color: var(--slate-500);
      font-size: 12px;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }
    .profile-dropdown-item {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 10px 16px;
      color: var(--slate-700);
      text-decoration: none;
      font-size: 14px;
      cursor: pointer;
      transition: background 0.1s;
      border: none;
      background: none;
      width: 100%;
      text-align: left;
      font-family: inherit;
    }
    .profile-dropdown-item:hover {
      background: var(--slate-50);
    }
    .profile-dropdown-item svg,
    .profile-dropdown-item span.icon {
      width: 18px;
      height: 18px;
      color: var(--slate-400);
      display: flex;
      align-items: center;
      justify-content: center;
    }
    .profile-dropdown-divider {
      height: 1px;
      background: var(--slate-100);
      margin: 4px 0;
    }
    .profile-dropdown-item.danger {
      color: var(--error);
    }
    .profile-dropdown-item.danger:hover {
      background: rgba(184, 74, 90, 0.08);
    }
    
    .nav-user {
      color: rgba(255,255,255,0.8);
      font-size: 14px;
    }
    .nav-signout {
      color: rgba(255,255,255,0.6);
      background: rgba(255,255,255,0.1);
      border: 1px solid rgba(255,255,255,0.2);
      padding: 6px 14px;
      border-radius: 6px;
      font-size: 13px;
      cursor: pointer;
      font-family: inherit;
      transition: all 0.15s;
    }
    .nav-signout:hover { background: rgba(255,255,255,0.2); color: #FFF; }
    
    /* Mobile hamburger */
    .nav-mobile-toggle {
      display: flex;
      align-items: center;
      justify-content: center;
      background: none;
      border: none;
      color: #FFF;
      font-size: 24px;
      cursor: pointer;
      padding: 8px;
      line-height: 1;
    }
    
    /* Mobile Menu - Threads-style Side Sliding */
    .nav-mobile-backdrop {
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, 0.5);
      z-index: 999;
      opacity: 0;
      visibility: hidden;
      transition: opacity 0.3s ease, visibility 0.3s ease;
    }
    .nav-mobile-backdrop.open {
      opacity: 1;
      visibility: visible;
    }
    .nav-mobile-menu {
      position: fixed;
      top: 0;
      right: 0;
      bottom: 0;
      width: 280px;
      max-width: 85vw;
      background: var(--navy-800);
      z-index: 1000;
      display: flex;
      flex-direction: column;
      transform: translateX(100%);
      transition: transform 0.3s ease;
      box-shadow: -4px 0 24px rgba(0, 0, 0, 0.3);
    }
    .nav-mobile-menu.open {
      transform: translateX(0);
    }
    .nav-mobile-header {
      display: flex;
      justify-content: flex-end;
      padding: 16px 20px;
      border-bottom: 1px solid rgba(255,255,255,0.1);
    }
    .nav-mobile-close {
      background: rgba(255,255,255,0.1);
      border: none;
      color: #FFF;
      font-size: 20px;
      cursor: pointer;
      padding: 8px 12px;
      line-height: 1;
      border-radius: 20px;
      transition: background 0.15s;
    }
    .nav-mobile-close:hover {
      background: rgba(255,255,255,0.2);
    }
    .nav-mobile-links {
      display: flex;
      flex-direction: column;
      gap: 8px;
      padding: 20px;
      flex: 1;
      overflow-y: auto;
    }
    .nav-mobile-link {
      color: rgba(255,255,255,0.9);
      text-decoration: none;
      padding: 14px 20px;
      border-radius: 24px;
      font-size: 15px;
      font-weight: 500;
      background: rgba(255,255,255,0.05);
      transition: all 0.15s;
      text-align: center;
    }
    .nav-mobile-link:hover {
      background: rgba(255,255,255,0.15);
      color: #FFF;
    }
    .nav-mobile-link.active {
      background: rgba(255,255,255,0.2);
      color: #FFF;
    }
    .nav-mobile-section-label {
      color: rgba(255,255,255,0.4);
      font-size: 11px;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      padding: 16px 20px 8px;
    }
    .nav-mobile-user {
      padding: 20px;
      border-top: 1px solid rgba(255,255,255,0.1);
      background: rgba(0,0,0,0.2);
    }
    .nav-mobile-user-name {
      color: rgba(255,255,255,0.6);
      font-size: 13px;
      margin-bottom: 12px;
      text-align: center;
    }
    .nav-mobile-signout {
      width: 100%;
      padding: 12px;
      background: transparent;
      border: 1px solid rgba(255,255,255,0.3);
      color: rgba(255,255,255,0.9);
      border-radius: 24px;
      font-size: 14px;
      font-weight: 500;
      cursor: pointer;
      font-family: inherit;
      transition: all 0.15s;
    }
    .nav-mobile-signout:hover {
      background: rgba(255,255,255,0.1);
      border-color: rgba(255,255,255,0.4);
    }
    
    /* Main Content */
    main {
      flex: 1;
      padding: 32px 24px;
    }
    .main-inner {
      max-width: 1200px;
      margin: 0 auto;
    }
    
    /* Dashboard Header */
    .dash-header {
      margin-bottom: 24px;
    }
    .dash-title {
      font-size: 24px;
      font-weight: 400;
      color: var(--navy-700);
      margin-bottom: 4px;
    }
    .dash-subtitle {
      color: var(--slate-500);
      font-size: 14px;
    }
    .dash-header-row {
      display: flex;
      flex-direction: column;
      gap: 16px;
      margin-bottom: 20px;
    }
    
    /* Tabs */
    .tabs {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      margin-bottom: 20px;
      padding-bottom: 16px;
      border-bottom: 1px solid var(--slate-200);
    }
    .tab-btn {
      padding: 8px 16px;
      background: transparent;
      color: var(--slate-600);
      border: none;
      border-radius: 6px;
      cursor: pointer;
      font-family: inherit;
      font-size: 14px;
      font-weight: 500;
      transition: all 0.15s;
    }
    .tab-btn:hover { background: var(--slate-100); }
    .tab-btn.active {
      background: var(--navy-700);
      color: #FFF;
    }
    
    /* Journey Cards Grid */
    .cards-grid {
      display: grid;
      grid-template-columns: 1fr;
      gap: 16px;
    }
    .journey-card {
      padding: 0;
      cursor: pointer;
      transition: all 0.2s;
      position: relative;
      overflow: visible;
    }
    .journey-card:hover {
      box-shadow: 0 4px 20px rgba(25, 43, 69, 0.1);
    }
    .journey-card-header {
      background: linear-gradient(135deg, var(--steel-500) 0%, var(--steel-600) 100%);
      padding: 16px 20px;
      position: relative;
      border-radius: 12px 12px 0 0;
      overflow: visible;
    }
    .journey-card-header.favourite {
      background: linear-gradient(135deg, var(--amber-500) 0%, var(--amber-600) 100%);
    }
    .journey-card-header.example {
      background: linear-gradient(135deg, #8B5CF6 0%, #7C3AED 100%);
    }
    
    /* Custom card colours */
    .journey-card-header.color-steel { background: linear-gradient(135deg, #5B8A9A 0%, #4A7485 100%); }
    .journey-card-header.color-navy { background: linear-gradient(135deg, #243D5C 0%, #192B45 100%); }
    .journey-card-header.color-teal { background: linear-gradient(135deg, #2D8A6E 0%, #236B56 100%); }
    .journey-card-header.color-amber { background: linear-gradient(135deg, #C4942A 0%, #A67C1A 100%); }
    .journey-card-header.color-slate { background: linear-gradient(135deg, #6E7B8C 0%, #556275 100%); }
    .journey-card-header.color-rose { background: linear-gradient(135deg, #B84A5A 0%, #9A3D4A 100%); }
    .journey-card-header.color-indigo { background: linear-gradient(135deg, #5A5B8A 0%, #484970 100%); }
    .journey-card-header.color-copper { background: linear-gradient(135deg, #9A6B5B 0%, #7D5649 100%); }
    
    /* Colour picker swatches */
    .color-picker {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
      margin-top: 8px;
    }
    .color-swatch {
      width: 36px;
      height: 36px;
      border-radius: 8px;
      cursor: pointer;
      border: 3px solid transparent;
      transition: all 0.15s ease;
      position: relative;
    }
    .color-swatch:hover {
      transform: scale(1.1);
    }
    .color-swatch.selected {
      border-color: var(--navy-700);
      box-shadow: 0 0 0 2px white, 0 0 0 4px var(--navy-700);
    }
    .color-swatch.selected::after {
      content: '‚úì';
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      color: white;
      font-size: 16px;
      font-weight: bold;
      text-shadow: 0 1px 2px rgba(0,0,0,0.3);
    }
    .color-swatch-steel { background: linear-gradient(135deg, #5B8A9A 0%, #4A7485 100%); }
    .color-swatch-navy { background: linear-gradient(135deg, #243D5C 0%, #192B45 100%); }
    .color-swatch-teal { background: linear-gradient(135deg, #2D8A6E 0%, #236B56 100%); }
    .color-swatch-amber { background: linear-gradient(135deg, #C4942A 0%, #A67C1A 100%); }
    .color-swatch-slate { background: linear-gradient(135deg, #6E7B8C 0%, #556275 100%); }
    .color-swatch-rose { background: linear-gradient(135deg, #B84A5A 0%, #9A3D4A 100%); }
    .color-swatch-indigo { background: linear-gradient(135deg, #5A5B8A 0%, #484970 100%); }
    .color-swatch-copper { background: linear-gradient(135deg, #9A6B5B 0%, #7D5649 100%); }
    .journey-card-title {
      font-size: 16px;
      font-weight: 600;
      color: #FFF;
      line-height: 1.3;
      padding-right: 50px;
      margin: 0;
    }
    .journey-card-icons {
      display: flex;
      gap: 4px;
      font-size: 14px;
      position: absolute;
      top: 16px;
      right: 16px;
    }
    
    /* Example badge */
    .example-badge {
      display: inline-flex;
      align-items: center;
      gap: 4px;
      padding: 3px 8px;
      background: rgba(255, 255, 255, 0.2);
      border-radius: 4px;
      font-size: 11px;
      font-weight: 500;
      color: #FFF;
      margin-bottom: 8px;
    }
    
    /* Card header buttons container - top right */
    .journey-card-header-buttons {
      position: absolute;
      top: 12px;
      right: 12px;
      display: flex;
      gap: 4px;
      z-index: 5;
    }
    
    /* Miro-style options button */
    .journey-card-options {
      width: 32px;
      height: 32px;
      border-radius: 6px;
      background: rgba(255, 255, 255, 0.15);
      border: none;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 18px;
      font-weight: bold;
      color: #FFF;
      opacity: 0;
      transition: opacity 0.15s, background 0.15s;
    }
    .journey-card-options:hover {
      background: rgba(255, 255, 255, 0.25);
    }
    .journey-card:hover .journey-card-options {
      opacity: 1;
    }
    
    /* Miro-style star button */
    .journey-card-star {
      width: 32px;
      height: 32px;
      border-radius: 6px;
      background: rgba(255, 255, 255, 0.15);
      border: none;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 16px;
      opacity: 0;
      transition: opacity 0.15s, background 0.15s, transform 0.15s;
    }
    .journey-card-star:hover {
      background: rgba(255, 255, 255, 0.25);
      transform: scale(1.1);
    }
    .journey-card-star.starred {
      opacity: 1;
    }
    .journey-card:hover .journey-card-star {
      opacity: 1;
    }
    
    /* Options dropdown menu */
    .card-options-container {
      position: relative;
    }
    .card-options-dropdown {
      position: absolute;
      top: 40px;
      right: 0;
      background: #FFF;
      border-radius: 12px;
      box-shadow: 0 4px 24px rgba(0, 0, 0, 0.15), 0 0 0 1px rgba(0, 0, 0, 0.05);
      min-width: 200px;
      z-index: 1000;
      padding: 8px 0;
      animation: dropdownFadeIn 0.15s ease;
    }
    @keyframes dropdownFadeIn {
      from { opacity: 0; transform: translateY(-8px); }
      to { opacity: 1; transform: translateY(0); }
    }
    .card-options-item {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 10px 16px;
      font-size: 14px;
      color: var(--slate-700);
      cursor: pointer;
      transition: background 0.1s;
      border: none;
      background: none;
      width: 100%;
      text-align: left;
      font-family: inherit;
    }
    .card-options-item:hover {
      background: var(--slate-50);
    }
    .card-options-item.danger {
      color: var(--error);
    }
    .card-options-item.danger:hover {
      background: var(--error-light);
    }
    .card-options-item.disabled {
      color: var(--slate-300);
      cursor: not-allowed;
    }
    .card-options-item.disabled:hover {
      background: transparent;
    }
    .card-options-item-icon {
      width: 18px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 15px;
    }
    .card-options-divider {
      height: 1px;
      background: var(--slate-100);
      margin: 6px 0;
    }
    
    /* On touch devices, always show buttons */
    @media (hover: none) {
      .journey-card-star.starred {
        opacity: 1;
      }
      .journey-card-options {
        opacity: 1;
      }
    }
    .journey-card-body {
      padding: 16px 20px;
    }
    .journey-card-desc {
      color: var(--slate-500);
      font-size: 13px;
      margin-bottom: 12px;
      line-height: 1.4;
    }
    .journey-card-metrics {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
      padding: 10px 12px;
      background: var(--slate-50);
      border-radius: 8px;
      margin-bottom: 12px;
    }
    .metric {
      display: flex;
      align-items: center;
      gap: 4px;
      font-size: 12px;
    }
    .metric-value { font-weight: 600; color: var(--navy-700); }
    .metric-dot { color: var(--slate-300); }
    .journey-card-footer {
      display: flex;
      flex-wrap: wrap;
      justify-content: space-between;
      align-items: center;
      gap: 8px;
    }
    .journey-card-date {
      color: var(--slate-400);
      font-size: 12px;
    }
    .journey-card-actions {
      display: flex;
      gap: 4px;
    }
    .journey-card-actions .btn {
      padding: 6px 10px;
      font-size: 12px;
    }
    
    /* Modal */
    .modal-overlay {
      position: fixed;
      inset: 0;
      background: rgba(12, 22, 32, 0.7);
      backdrop-filter: blur(4px);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 1000;
      padding: 16px;
    }
    .modal {
      background: #FFF;
      border-radius: 16px;
      width: 100%;
      max-width: 420px;
      max-height: 90vh;
      overflow-y: auto;
    }
    .modal-content { padding: 24px; }
    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
    }
    .modal-close {
      background: none;
      border: none;
      font-size: 28px;
      color: var(--slate-400);
      cursor: pointer;
      padding: 4px;
      line-height: 1;
    }
    .modal-title {
      font-size: 22px;
      font-weight: 400;
      color: var(--navy-700);
      margin-bottom: 6px;
    }
    
    /* Footer */
    .footer {
      background: var(--navy-950);
      color: rgba(255,255,255,0.4);
      padding: 32px 24px;
    }
    .footer-inner {
      max-width: 1200px;
      margin: 0 auto;
      display: flex;
      justify-content: space-between;
      align-items: center;
      flex-wrap: wrap;
      gap: 16px;
    }
    .footer-brand {
      display: flex;
      align-items: center;
      gap: 12px;
    }
    .footer-logo {
      height: 20px;
      opacity: 0.5;
    }
    .footer-version {
      font-size: 11px;
      opacity: 0.6;
    }
    .footer-copy {
      font-size: 13px;
    }
    
    /* Dropdown */
    .dropdown {
      position: relative;
    }
    .dropdown-menu {
      position: absolute;
      top: 100%;
      left: 0;
      background: #FFF;
      border-radius: 8px;
      box-shadow: 0 4px 20px rgba(0,0,0,0.15);
      min-width: 160px;
      padding: 6px 0;
      opacity: 0;
      visibility: hidden;
      transform: translateY(8px);
      transition: all 0.2s;
      z-index: 50;
    }
    .dropdown:hover .dropdown-menu {
      opacity: 1;
      visibility: visible;
      transform: translateY(4px);
    }
    .dropdown-item {
      display: block;
      padding: 10px 16px;
      color: var(--slate-700);
      text-decoration: none;
      font-size: 14px;
      transition: background 0.1s;
    }
    .dropdown-item:hover { background: var(--slate-50); }
    
    /* ============================================
       TABLET AND UP (768px+)
       ============================================ */
    @media (min-width: 768px) {
      .nav-links { display: flex; }
      .nav-right { display: flex; }
      .nav-mobile-toggle { display: none; }
      
      main { padding: 32px 24px; }
      
      .dash-header-row {
        flex-direction: row;
        justify-content: space-between;
        align-items: center;
      }
      .dash-title { font-size: 28px; }
      
      .cards-grid {
        grid-template-columns: repeat(2, 1fr);
        gap: 20px;
      }
      
      .journey-card-header { padding: 18px 24px; }
      .journey-card-body { padding: 20px 24px; }
      .journey-card-title { font-size: 17px; }
    }
    
    /* ============================================
       DESKTOP (1024px+)
       ============================================ */
    @media (min-width: 1024px) {
      main { padding: 40px; }
      
      .dash-title { font-size: 32px; }
      
      .cards-grid {
        grid-template-columns: repeat(3, 1fr);
        gap: 24px;
      }
    }
  </style>
</head>
<body>
  <div id="root"></div>
  
  <script type="text/babel">
    const { useState, useEffect, useCallback, useRef, createContext, useContext } = React;
    
    // ============================================
    // SUPABASE CONFIGURATION
    // ============================================
    const SUPABASE_URL = 'https://ktctvaeulualihczwnrl.supabase.co';
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imt0Y3R2YWV1bHVhbGloY3p3bnJsIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njc0MzczNjksImV4cCI6MjA4MzAxMzM2OX0.qnvrAUvUhp3hgu37YnahR0Ql-CKR0zcDt3sKWaMq95I';
    
    // Check if Supabase loaded
    if (!window.supabase) {
      console.error('Supabase library not loaded!');
    }
    
    // Create client with explicit options
    const supabase = window.supabase?.createClient(SUPABASE_URL, SUPABASE_ANON_KEY, {
      auth: {
        persistSession: true,
        autoRefreshToken: true,
        detectSessionInUrl: true,
        storage: window.localStorage,
        flowType: 'implicit'
      }
    });
    
    if (supabase) {
      console.log('Supabase client initialized');
      // Force initialize auth to prevent lock issues
      supabase.auth.initialize().catch(e => console.log('Auth init:', e));
    }
    
    // ============================================
    // AUTH CONTEXT
    // ============================================
    const AuthContext = createContext(null);
    
    function AuthProvider({ children }) {
      const [user, setUser] = useState(null);
      const [profile, setProfile] = useState(null);
      const [loading, setLoading] = useState(true);
      const fetchingRef = useRef(false); // Prevent double-fetch
      
      // Define fetchProfile FIRST
      const fetchProfile = useCallback(async (userId) => {
        if (fetchingRef.current) {
          console.log('Profile fetch already in progress, skipping');
          return;
        }
        fetchingRef.current = true;
        console.log('Fetching profile for:', userId);
        
        // Add timeout for entire profile fetch operation
        const timeoutPromise = new Promise((_, reject) => 
          setTimeout(() => reject(new Error('Profile fetch timeout')), 15000)
        );
        
        try {
          await Promise.race([
            (async () => {
              // Try to get existing profile
              const { data, error } = await supabase
                .from('users')
                .select('*, organisations(*)')
                .eq('id', userId)
                .single();
              
              console.log('Profile fetch result:', { data: !!data, error: error?.message });
              
              if (data && data.organisation_id) {
                console.log('Profile loaded successfully');
                setProfile(data);
                setLoading(false);
                fetchingRef.current = false;
                return;
              }
              
              // Profile doesn't exist - check for pending invitation first
              console.log('Profile not found, checking for invitation...');
              
              // Get user email from auth
              const { data: authUser } = await supabase.auth.getUser();
              const email = authUser?.user?.email;
              const displayName = authUser?.user?.user_metadata?.display_name || email?.split('@')[0];
              
              if (!email) {
                console.error('No email found for user');
                setLoading(false);
                fetchingRef.current = false;
                return;
              }
              
              // Check for pending invitation (optional - table may not exist)
              let invitation = null;
              try {
                const { data: inviteData, error: inviteError } = await supabase
                  .from('workspace_invites')
                  .select('*, organisations(*)')
                  .eq('email', email.toLowerCase())
                  .is('accepted_at', null)
                  .single();
                
                if (!inviteError && inviteData) {
                  invitation = inviteData;
                }
                console.log('Invitation check:', { invitation: !!invitation, error: inviteError?.message });
              } catch (e) {
                console.log('Invitation check skipped (table may not exist):', e.message);
              }
              
              if (invitation && invitation.organisation_id) {
                // Accept invitation - join existing organisation
                console.log('Found invitation, joining organisation:', invitation.organisations?.name);
                
                // Create user profile with invited role
                const { data: newProfile, error: profileError } = await supabase
                  .from('users')
                  .insert({
                    id: userId,
                    email: email,
                    display_name: displayName,
                    organisation_id: invitation.organisation_id,
                    role: invitation.role || 'member'
                  })
                  .select('*, organisations(*)')
                  .single();
                
                if (profileError) {
                  console.error('Failed to create profile:', profileError);
                  setLoading(false);
                  fetchingRef.current = false;
                  return;
                }
                
                // Mark invitation as accepted
                await supabase
                  .from('org_invitations')
                  .update({ 
                    status: 'accepted',
                    accepted_at: new Date().toISOString()
                  })
                  .eq('id', invitation.id);
                
                console.log('Profile created via invitation:', newProfile);
                setProfile(newProfile);
                setLoading(false);
                fetchingRef.current = false;
                return;
              }
              
              // No invitation found - create new organisation
              console.log('No invitation found, creating new organisation...');
              
              const orgSlug = email.split('@')[0].toLowerCase().replace(/[^a-z0-9]/g, '-') + '-' + Date.now().toString(36);
              const { data: newOrg, error: orgError } = await supabase
                .from('organisations')
                .insert({
                  name: displayName + "'s Workspace",
                  slug: orgSlug,
                  settings: {}
                })
                .select()
                .single();
              
              if (orgError) {
                console.error('Failed to create org:', orgError);
                setLoading(false);
                fetchingRef.current = false;
                return;
              }
              
              // Create user profile as owner
              const { data: newProfile, error: profileError } = await supabase
                .from('users')
                .insert({
                  id: userId,
                  email: email,
                  display_name: displayName,
                  organisation_id: newOrg.id,
                  role: 'owner'
                })
                .select('*, organisations(*)')
                .single();
              
              if (profileError) {
                console.error('Failed to create profile:', profileError);
                setLoading(false);
                fetchingRef.current = false;
                return;
              }
              
              console.log('Profile created with new org:', newProfile);
              setProfile(newProfile);
              setLoading(false);
              fetchingRef.current = false;
              
              // Create starter example maps for new workspace (non-blocking)
              // Do this AFTER setting profile so user isn't stuck waiting
              console.log('Creating starter content for new workspace...');
              createStarterMaps(newOrg.id, userId).then(() => {
                console.log('Starter content created successfully');
              }).catch(err => {
                console.error('Failed to create starter content (non-fatal):', err);
              });
            })(),
            timeoutPromise
          ]);
        } catch (err) {
          console.error('fetchProfile error:', err);
          setLoading(false);
          fetchingRef.current = false;
        }
      }, []);
      
      useEffect(() => {
        // Check if Supabase is available
        if (!supabase) {
          console.error('Supabase not initialized');
          setLoading(false);
          return;
        }
        
        console.log('Starting auth check...');
        let resolved = false;
        
        // Fallback timeout - MUST fire
        const timeout = setTimeout(() => {
          if (!resolved) {
            console.log('Auth timeout - showing login screen');
            setLoading(false);
          }
        }, 10000);
        
        // Set up auth state change listener FIRST
        const { data: { subscription } } = supabase.auth.onAuthStateChange(async (event, session) => {
          resolved = true;
          console.log('Auth state change:', event, 'hasUser:', !!session?.user);
          
          if (session?.user) {
            setUser(session.user);
            console.log('User authenticated, will fetch profile for:', session.user.id);
            await fetchProfile(session.user.id);
          } else {
            console.log('No user, clearing state');
            setUser(null);
            setProfile(null);
            setLoading(false);
          }
        });
        
        // Then get current session
        supabase.auth.getSession().then(({ data: { session } }) => {
          resolved = true;
          clearTimeout(timeout);
          console.log('getSession returned, hasUser:', !!session?.user);
          
          // If no user, show login
          if (!session?.user) {
            console.log('No session, showing login');
            setUser(null);
            setLoading(false);
          }
          // If user exists, onAuthStateChange will handle profile fetch
        }).catch(err => {
          resolved = true;
          clearTimeout(timeout);
          console.error('getSession error:', err);
          setLoading(false);
        });
        
        return () => {
          clearTimeout(timeout);
          subscription?.unsubscribe();
        };
      }, [fetchProfile]);
      
      const signUp = async (email, password, displayName) => {
        const { data, error } = await supabase.auth.signUp({
          email,
          password,
          options: { data: { display_name: displayName } }
        });
        return { data, error };
      };
      
      const signIn = async (email, password) => {
        const { data, error } = await supabase.auth.signInWithPassword({ email, password });
        return { data, error };
      };
      
      const signOut = async () => {
        await supabase.auth.signOut();
        setUser(null);
        setProfile(null);
      };
      
      return (
        <AuthContext.Provider value={{ user, profile, loading, signUp, signIn, signOut, fetchProfile }}>
          {children}
        </AuthContext.Provider>
      );
    }
    
    const useAuth = () => useContext(AuthContext);
    
    // ============================================
    // SUPABASE DATA FUNCTIONS
    // ============================================
    async function fetchMapsFromSupabase(organisationId) {
      const { data, error } = await supabase
        .from('journey_maps')
        .select('*')
        .eq('organisation_id', organisationId)
        .is('archived_at', null)
        .order('updated_at', { ascending: false });
      
      if (error) throw error;
      return data || [];
    }
    
    async function saveMapToSupabase(map) {
      const { data, error } = await supabase
        .from('journey_maps')
        .upsert(map)
        .select()
        .single();
      
      if (error) throw error;
      return data;
    }
    
    async function createMapInSupabase(mapData) {
      const { data, error } = await supabase
        .from('journey_maps')
        .insert(mapData)
        .select()
        .single();
      
      if (error) throw error;
      return data;
    }
    
    async function deleteMapFromSupabase(mapId) {
      // Soft delete
      const { error } = await supabase
        .from('journey_maps')
        .update({ archived_at: new Date().toISOString() })
        .eq('id', mapId);
      
      if (error) throw error;
    }
    
    // Create starter example maps for new workspaces
    async function createStarterMaps(organisationId, userId) {
      const starterMaps = [
        // Coffee Shop Journey (Simple)
        {
          organisation_id: organisationId,
          title: '‚òï Coffee Shop Customer Journey',
          description: 'Example: A typical customer journey from entering to leaving a coffee shop',
          journey_type: 'Customer Experience',
          template_source: 'starter-example',
          created_by: userId,
          config: {
            meta: { title: '‚òï Coffee Shop Customer Journey', description: 'Example: A typical customer journey', journeyType: 'Customer Experience', isExample: true },
            isExample: true,
            stages: [
              { id: 'stage-1', name: 'Arrival', steps: [
                { id: 's1-1', name: 'Enter shop', persona: 'customer', timeMinutes: 1, friction: 1 },
                { id: 's1-2', name: 'Queue assessment', persona: 'customer', timeMinutes: 1, friction: 2 },
                { id: 's1-3', name: 'Wait in queue', persona: 'customer', timeMinutes: 5, friction: 3, painPoints: 'Long wait times during peak hours' }
              ]},
              { id: 'stage-2', name: 'Order', steps: [
                { id: 's2-1', name: 'Review menu', persona: 'customer', timeMinutes: 2, friction: 2 },
                { id: 's2-2', name: 'Place order', persona: 'barista', timeMinutes: 2, friction: 1 },
                { id: 's2-3', name: 'Payment', persona: 'customer', timeMinutes: 1, friction: 1 }
              ]},
              { id: 'stage-3', name: 'Fulfilment', steps: [
                { id: 's3-1', name: 'Prepare drink', persona: 'barista', timeMinutes: 4, friction: 1 },
                { id: 's3-2', name: 'Wait for drink', persona: 'customer', timeMinutes: 4, friction: 2 },
                { id: 's3-3', name: 'Collect order', persona: 'customer', timeMinutes: 1, friction: 1 }
              ]},
              { id: 'stage-4', name: 'Experience', steps: [
                { id: 's4-1', name: 'Find seating', persona: 'customer', timeMinutes: 2, friction: 2, painPoints: 'Limited seating during busy periods' },
                { id: 's4-2', name: 'Enjoy', persona: 'customer', timeMinutes: 20, friction: 1 },
                { id: 's4-3', name: 'Depart', persona: 'customer', timeMinutes: 1, friction: 1 }
              ]}
            ],
            personas: [
              { id: 'customer', label: 'Customer', color: '#3B82F6', isExternal: true, hourlyRate: 0 },
              { id: 'barista', label: 'Barista', color: '#10B981', isExternal: false, hourlyRate: 12 }
            ],
            funnel: { enabled: true, initialVolume: 100, stageDropOffs: { 'stage-1': 5, 'stage-2': 2, 'stage-3': 1, 'stage-4': 0 } }
          }
        },
        // Employee Onboarding Journey (Medium)
        {
          organisation_id: organisationId,
          title: 'üè¢ Employee Onboarding Journey',
          description: 'Example: From offer acceptance to full productivity for a new hire',
          journey_type: 'Employee Onboarding',
          template_source: 'starter-example',
          created_by: userId,
          config: {
            meta: { title: 'üè¢ Employee Onboarding Journey', description: 'Example: From offer acceptance to full productivity', journeyType: 'Employee Onboarding', isExample: true },
            isExample: true,
            stages: [
              { id: 'stage-1', name: 'Pre-boarding', steps: [
                { id: 's1-1', name: 'Send offer letter', persona: 'hr', timeMinutes: 30, friction: 1 },
                { id: 's1-2', name: 'Receive signed contract', persona: 'hr', timeMinutes: 15, friction: 2, painPoints: 'Delays waiting for signatures' },
                { id: 's1-3', name: 'Background check', persona: 'hr', timeMinutes: 20, friction: 2, thirdPartyCost: 50 },
                { id: 's1-4', name: 'IT equipment order', persona: 'it', timeMinutes: 30, friction: 2, thirdPartyCost: 1200 },
                { id: 's1-5', name: 'System accounts', persona: 'it', timeMinutes: 45, friction: 3, painPoints: 'Multiple systems need setup', automationOpportunity: 'high' }
              ]},
              { id: 'stage-2', name: 'Day One', steps: [
                { id: 's2-1', name: 'Welcome & tour', persona: 'hr', timeMinutes: 60, friction: 1 },
                { id: 's2-2', name: 'Equipment setup', persona: 'it', timeMinutes: 45, friction: 2 },
                { id: 's2-3', name: 'HR paperwork', persona: 'new-hire', timeMinutes: 60, friction: 3, painPoints: 'Repetitive form filling', automationOpportunity: 'medium' },
                { id: 's2-4', name: 'Team intros', persona: 'manager', timeMinutes: 30, friction: 1 },
                { id: 's2-5', name: 'Compliance training', persona: 'new-hire', timeMinutes: 120, friction: 3, regulatoryRequired: true }
              ]},
              { id: 'stage-3', name: 'Week One', steps: [
                { id: 's3-1', name: 'Role training', persona: 'manager', timeMinutes: 240, friction: 2 },
                { id: 's3-2', name: 'System training', persona: 'new-hire', timeMinutes: 180, friction: 3 },
                { id: 's3-3', name: 'First 1:1', persona: 'manager', timeMinutes: 30, friction: 1 },
                { id: 's3-4', name: 'Buddy check-in', persona: 'buddy', timeMinutes: 30, friction: 1 }
              ]},
              { id: 'stage-4', name: 'First Month', steps: [
                { id: 's4-1', name: 'Weekly 1:1s (x4)', persona: 'manager', timeMinutes: 120, friction: 1 },
                { id: 's4-2', name: 'Complete training', persona: 'new-hire', timeMinutes: 180, friction: 2, regulatoryRequired: true },
                { id: 's4-3', name: 'First project', persona: 'new-hire', timeMinutes: 480, friction: 2 },
                { id: 's4-4', name: '30-day review', persona: 'manager', timeMinutes: 60, friction: 1 }
              ]},
              { id: 'stage-5', name: '90-Day Checkpoint', steps: [
                { id: 's5-1', name: 'Probation review', persona: 'hr', timeMinutes: 60, friction: 2 },
                { id: 's5-2', name: 'Competency check', persona: 'manager', timeMinutes: 60, friction: 2 },
                { id: 's5-3', name: 'Feedback', persona: 'hr', timeMinutes: 30, friction: 1 },
                { id: 's5-4', name: 'Confirmation', persona: 'hr', timeMinutes: 30, friction: 1 }
              ]}
            ],
            personas: [
              { id: 'new-hire', label: 'New Hire', color: '#3B82F6', isExternal: false, hourlyRate: 25 },
              { id: 'hr', label: 'HR', color: '#8B5CF6', isExternal: false, hourlyRate: 30 },
              { id: 'it', label: 'IT Support', color: '#F59E0B', isExternal: false, hourlyRate: 28 },
              { id: 'manager', label: 'Line Manager', color: '#10B981', isExternal: false, hourlyRate: 45 },
              { id: 'buddy', label: 'Buddy', color: '#EC4899', isExternal: false, hourlyRate: 25 }
            ],
            funnel: { enabled: true, initialVolume: 100, stageDropOffs: { 'stage-1': 8, 'stage-2': 3, 'stage-3': 2, 'stage-4': 2, 'stage-5': 5 } }
          }
        },
        // Wealth Management Journey (Complex)
        {
          organisation_id: organisationId,
          title: 'üè¶ Wealth Management Client Onboarding',
          description: 'Example: High-net-worth client onboarding with full KYC and compliance',
          journey_type: 'Client Onboarding',
          template_source: 'starter-example',
          created_by: userId,
          config: {
            meta: { title: 'üè¶ Wealth Management Client Onboarding', description: 'Example: High-net-worth client onboarding with full KYC and compliance', journeyType: 'Client Onboarding', isExample: true },
            isExample: true,
            stages: [
              { id: 'stage-1', name: 'Initial Engagement', steps: [
                { id: 's1-1', name: 'Enquiry received', persona: 'admin', timeMinutes: 15, friction: 1 },
                { id: 's1-2', name: 'Qualification call', persona: 'advisor', timeMinutes: 30, friction: 2 },
                { id: 's1-3', name: 'Send info pack', persona: 'admin', timeMinutes: 20, friction: 1 },
                { id: 's1-4', name: 'Schedule meeting', persona: 'admin', timeMinutes: 15, friction: 2, painPoints: 'Back-and-forth scheduling' }
              ]},
              { id: 'stage-2', name: 'Discovery & Fact Find', steps: [
                { id: 's2-1', name: 'Discovery meeting', persona: 'advisor', timeMinutes: 90, friction: 2 },
                { id: 's2-2', name: 'Fact find form', persona: 'client', timeMinutes: 60, friction: 4, painPoints: 'Lengthy forms, repeated info requests' },
                { id: 's2-3', name: 'Document request', persona: 'admin', timeMinutes: 30, friction: 3 },
                { id: 's2-4', name: 'Client provides docs', persona: 'client', timeMinutes: 120, friction: 4, painPoints: 'Difficulty locating documents' }
              ]},
              { id: 'stage-3', name: 'KYC & Compliance', steps: [
                { id: 's3-1', name: 'ID verification', persona: 'compliance', timeMinutes: 30, friction: 2, thirdPartyCost: 25, regulatoryRequired: true },
                { id: 's3-2', name: 'AML screening', persona: 'compliance', timeMinutes: 45, friction: 2, thirdPartyCost: 50, regulatoryRequired: true },
                { id: 's3-3', name: 'Source of wealth', persona: 'compliance', timeMinutes: 120, friction: 4, painPoints: 'Complex cases need extensive docs', regulatoryRequired: true },
                { id: 's3-4', name: 'Risk assessment', persona: 'compliance', timeMinutes: 60, friction: 3, regulatoryRequired: true },
                { id: 's3-5', name: 'Compliance sign-off', persona: 'compliance', timeMinutes: 30, friction: 2, regulatoryRequired: true }
              ]},
              { id: 'stage-4', name: 'Proposal & Agreement', steps: [
                { id: 's4-1', name: 'Financial plan prep', persona: 'paraplanner', timeMinutes: 240, friction: 2 },
                { id: 's4-2', name: 'Internal review', persona: 'advisor', timeMinutes: 60, friction: 2 },
                { id: 's4-3', name: 'Proposal presentation', persona: 'advisor', timeMinutes: 90, friction: 2 },
                { id: 's4-4', name: 'Client consideration', persona: 'client', timeMinutes: 60, friction: 2 },
                { id: 's4-5', name: 'Agreement signing', persona: 'client', timeMinutes: 30, friction: 2, automationOpportunity: 'medium' }
              ]},
              { id: 'stage-5', name: 'Account Setup', steps: [
                { id: 's5-1', name: 'Platform account', persona: 'admin', timeMinutes: 45, friction: 3, thirdPartyCost: 150, painPoints: 'Multiple platform applications' },
                { id: 's5-2', name: 'Custody account', persona: 'admin', timeMinutes: 60, friction: 3, thirdPartyCost: 100 },
                { id: 's5-3', name: 'Transfer initiation', persona: 'admin', timeMinutes: 90, friction: 4, painPoints: 'Legacy providers slow', automationOpportunity: 'high' },
                { id: 's5-4', name: 'Transfer tracking', persona: 'admin', timeMinutes: 120, friction: 3 },
                { id: 's5-5', name: 'Initial investment', persona: 'advisor', timeMinutes: 60, friction: 2 }
              ]},
              { id: 'stage-6', name: 'Handover & Review', steps: [
                { id: 's6-1', name: 'Welcome pack', persona: 'admin', timeMinutes: 30, friction: 1 },
                { id: 's6-2', name: 'Portal access', persona: 'admin', timeMinutes: 20, friction: 2, automationOpportunity: 'high' },
                { id: 's6-3', name: 'First review meeting', persona: 'advisor', timeMinutes: 60, friction: 1 },
                { id: 's6-4', name: 'Service schedule', persona: 'admin', timeMinutes: 15, friction: 1 }
              ]}
            ],
            personas: [
              { id: 'client', label: 'Client', color: '#3B82F6', isExternal: true, hourlyRate: 0 },
              { id: 'advisor', label: 'Financial Advisor', color: '#10B981', isExternal: false, hourlyRate: 85 },
              { id: 'paraplanner', label: 'Paraplanner', color: '#8B5CF6', isExternal: false, hourlyRate: 45 },
              { id: 'admin', label: 'Client Services', color: '#F59E0B', isExternal: false, hourlyRate: 28 },
              { id: 'compliance', label: 'Compliance', color: '#EF4444', isExternal: false, hourlyRate: 55 }
            ],
            funnel: { enabled: true, initialVolume: 100, stageDropOffs: { 'stage-1': 25, 'stage-2': 15, 'stage-3': 10, 'stage-4': 8, 'stage-5': 3, 'stage-6': 1 } }
          }
        }
      ];
      
      // Insert all starter maps
      for (const map of starterMaps) {
        try {
          await supabase.from('journey_maps').insert(map);
          console.log('Created starter map:', map.title);
        } catch (err) {
          console.error('Failed to create starter map:', map.title, err);
        }
      }
    }
    
    // GitHub configuration (legacy/fallback)
    const GITHUB_CONFIG = {
      owner: 'steveyoung74',
      repo: 'journeymaps',
      branch: 'main',
      mapsPath: 'maps',
      indexFile: 'maps/index.json'
    };
    
    const getRawUrl = (path) => 
      `https://raw.githubusercontent.com/${GITHUB_CONFIG.owner}/${GITHUB_CONFIG.repo}/${GITHUB_CONFIG.branch}/${path}`;
    
    const getApiUrl = (path) => 
      `https://api.github.com/repos/${GITHUB_CONFIG.owner}/${GITHUB_CONFIG.repo}/contents/${path}`;
    
    async function fetchFromGitHub(path) {
      const cacheBust = `${Date.now()}-${Math.random().toString(36).substr(2, 9)}`;
      const url = getRawUrl(path) + '?t=' + cacheBust;
      const response = await fetch(url);
      if (!response.ok) {
        if (response.status === 404) return null;
        throw new Error(`GitHub fetch failed: ${response.status}`);
      }
      return response.json();
    }
    
    async function saveToGitHub(path, content, token, message = 'Update from Fathom') {
      const apiUrl = getApiUrl(path);
      let sha = null;
      
      try {
        const existingResponse = await fetch(apiUrl, {
          headers: { 'Authorization': `token ${token}` }
        });
        if (existingResponse.ok) {
          const existing = await existingResponse.json();
          sha = existing.sha;
        }
      } catch (e) {}
      
      const body = {
        message,
        content: btoa(unescape(encodeURIComponent(JSON.stringify(content, null, 2)))),
        branch: GITHUB_CONFIG.branch
      };
      if (sha) body.sha = sha;
      
      const response = await fetch(apiUrl, {
        method: 'PUT',
        headers: {
          'Authorization': `token ${token}`,
          'Content-Type': 'application/json'
        },
        body: JSON.stringify(body)
      });
      
      if (!response.ok) {
        const error = await response.json();
        throw new Error(error.message || 'Failed to save');
      }
      
      return response.json();
    }
    
    async function deleteFromGitHub(path, token, message = 'Delete from Fathom') {
      const apiUrl = getApiUrl(path);
      const existingResponse = await fetch(apiUrl, {
        headers: { 'Authorization': `token ${token}` }
      });
      if (!existingResponse.ok) throw new Error('File not found');
      const existing = await existingResponse.json();
      
      const response = await fetch(apiUrl, {
        method: 'DELETE',
        headers: {
          'Authorization': `token ${token}`,
          'Content-Type': 'application/json'
        },
        body: JSON.stringify({
          message,
          sha: existing.sha,
          branch: GITHUB_CONFIG.branch
        })
      });
      
      if (!response.ok) throw new Error('Failed to delete');
      return true;
    }
    
    // Utility functions
    const formatTime = (minutes) => {
      if (!minutes) return '0m';
      const h = Math.floor(minutes / 60);
      const m = Math.round(minutes % 60);
      if (h === 0) return `${m}m`;
      if (m === 0) return `${h}h`;
      return `${h}h ${m}m`;
    };
    
    const formatCurrency = (amount) => {
      if (amount === null || amount === undefined) return '‚Äî';
      return '¬£' + amount.toLocaleString('en-GB', { minimumFractionDigits: 0, maximumFractionDigits: 0 });
    };
    
    const formatDate = (dateStr) => {
      if (!dateStr) return '';
      const date = new Date(dateStr);
      return date.toLocaleDateString('en-GB', { day: '2-digit', month: '2-digit', year: 'numeric' });
    };
    
    // ============================================
    // LOGIN MODAL
    // ============================================
    function AuthScreen() {
      const { signUp, signIn } = useAuth();
      const [mode, setMode] = useState('signin'); // signin, signup
      const [name, setName] = useState('');
      const [email, setEmail] = useState('');
      const [password, setPassword] = useState('');
      const [error, setError] = useState('');
      const [success, setSuccess] = useState('');
      const [isLoading, setIsLoading] = useState(false);
      
      // Check for login redirect from editor
      const urlParams = new URLSearchParams(window.location.search);
      const loginRequired = urlParams.get('login') === 'required';
      const returnUrl = urlParams.get('return');

      const handleSubmit = async (e) => {
        e.preventDefault();
        setError('');
        setSuccess('');
        
        if (!email.trim() || !password.trim()) {
          setError('Please enter email and password');
          return;
        }
        if (mode === 'signup' && !name.trim()) {
          setError('Please enter your name');
          return;
        }
        if (password.length < 6) {
          setError('Password must be at least 6 characters');
          return;
        }
        
        setIsLoading(true);
        try {
          if (mode === 'signup') {
            const { error } = await signUp(email.trim(), password, name.trim());
            if (error) throw error;
            setSuccess('Account created! You can now sign in.');
            setMode('signin');
            setPassword('');
          } else {
            const { error } = await signIn(email.trim(), password);
            if (error) throw error;
            // If there's a return URL, redirect back after login
            if (returnUrl) {
              setTimeout(() => {
                window.location.href = decodeURIComponent(returnUrl);
              }, 500);
            }
          }
        } catch (err) {
          setError(err.message || 'An error occurred');
        }
        setIsLoading(false);
      };

      return (
        <div className="modal-overlay" style={{ background: 'linear-gradient(135deg, var(--navy-950) 0%, var(--navy-800) 100%)' }}>
          <div className="modal">
            <div className="modal-content">
              <div className="modal-header">
                <img src="https://steveyoung74.github.io/journeymaps/logo_dark.png" alt="FATHOM" style={{ height: '28px' }} />
              </div>
              
              <h2 className="modal-title">Welcome to Fathom</h2>
              <p className="text-muted" style={{ marginBottom: '16px', fontSize: '14px' }}>
                {loginRequired 
                  ? 'Please sign in to view this shared journey map'
                  : (mode === 'signup' ? 'Create your account to get started' : 'Sign in to access your journey maps')
                }
              </p>
              
              {/* Login required notice */}
              {loginRequired && (
                <div style={{ 
                  background: 'rgba(196, 148, 42, 0.1)', 
                  border: '1px solid rgba(196, 148, 42, 0.3)',
                  borderRadius: '8px',
                  padding: '12px',
                  marginBottom: '16px',
                  fontSize: '13px',
                  color: 'var(--amber-600)'
                }}>
                  üîí This journey map requires authentication to view
                </div>
              )}
              
              {/* Auth tabs */}
              <div style={{ display: 'flex', gap: '8px', marginBottom: '20px' }}>
                <button
                  onClick={() => { setMode('signin'); setError(''); setSuccess(''); }}
                  style={{
                    flex: 1, padding: '10px', border: 'none', borderRadius: '8px',
                    fontSize: '14px', fontWeight: 500, cursor: 'pointer',
                    background: mode === 'signin' ? 'var(--navy-700)' : 'var(--slate-100)',
                    color: mode === 'signin' ? '#FFF' : 'var(--slate-600)',
                    fontFamily: 'inherit', transition: 'all 0.15s'
                  }}
                >
                  Sign In
                </button>
                <button
                  onClick={() => { setMode('signup'); setError(''); setSuccess(''); }}
                  style={{
                    flex: 1, padding: '10px', border: 'none', borderRadius: '8px',
                    fontSize: '14px', fontWeight: 500, cursor: 'pointer',
                    background: mode === 'signup' ? 'var(--navy-700)' : 'var(--slate-100)',
                    color: mode === 'signup' ? '#FFF' : 'var(--slate-600)',
                    fontFamily: 'inherit', transition: 'all 0.15s'
                  }}
                >
                  Sign Up
                </button>
              </div>

              {error && (
                <div style={{ padding: '12px 14px', background: 'var(--error-light)', borderRadius: '8px', marginBottom: '16px', color: 'var(--error)', fontSize: '13px' }}>
                  {error}
                </div>
              )}
              
              {success && (
                <div style={{ padding: '12px 14px', background: 'var(--success-light)', borderRadius: '8px', marginBottom: '16px', color: 'var(--success)', fontSize: '13px' }}>
                  {success}
                </div>
              )}

              <form onSubmit={handleSubmit}>
                {mode === 'signup' && (
                  <div style={{ marginBottom: '16px' }}>
                    <label className="label">Your Name</label>
                    <input
                      type="text"
                      className="input"
                      value={name}
                      onChange={(e) => setName(e.target.value)}
                      placeholder="Steve Young"
                    />
                  </div>
                )}

                <div style={{ marginBottom: '16px' }}>
                  <label className="label">Email Address</label>
                  <input
                    type="email"
                    className="input"
                    value={email}
                    onChange={(e) => setEmail(e.target.value)}
                    placeholder="steve@company.com"
                    autoFocus
                  />
                </div>

                <div style={{ marginBottom: '24px' }}>
                  <label className="label">Password</label>
                  <input
                    type="password"
                    className="input"
                    value={password}
                    onChange={(e) => setPassword(e.target.value)}
                    placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢"
                  />
                  {mode === 'signup' && (
                    <p className="text-muted text-small" style={{ marginTop: '6px' }}>
                      Minimum 6 characters
                    </p>
                  )}
                </div>

                <button type="submit" className="btn btn-primary" style={{ width: '100%', padding: '14px' }} disabled={isLoading}>
                  {isLoading ? 'Please wait...' : mode === 'signup' ? 'Create Account' : 'Sign In'}
                </button>
              </form>
              
              {mode === 'signin' && (
                <p className="text-muted text-small" style={{ marginTop: '16px', textAlign: 'center' }}>
                  Don't have an account? <button onClick={() => setMode('signup')} style={{ background: 'none', border: 'none', color: 'var(--steel-500)', cursor: 'pointer', fontFamily: 'inherit', fontSize: 'inherit', textDecoration: 'underline' }}>Sign up</button>
                </p>
              )}
              
              <div style={{ marginTop: '24px', paddingTop: '24px', borderTop: '1px solid var(--slate-200)', textAlign: 'center' }}>
                <a href="index.html" style={{ color: 'var(--slate-500)', fontSize: '13px', textDecoration: 'none' }}>
                  ‚Üê Back to Home
                </a>
              </div>
            </div>
          </div>
        </div>
      );
    }
    
    // Legacy LoginModal (kept for reference)
    function LoginModal_Legacy({ onLogin }) {
      const [name, setName] = useState('');
      const [email, setEmail] = useState('');
      const [token, setToken] = useState('');
      const [error, setError] = useState('');
      const [isLoading, setIsLoading] = useState(false);

      const handleSubmit = async (e) => {
        e.preventDefault();
        if (!name.trim() || !email.trim()) {
          setError('Please enter your name and email');
          return;
        }
        if (!email.includes('@')) {
          setError('Please enter a valid email');
          return;
        }
        setIsLoading(true);
        await onLogin({ name: name.trim(), email: email.trim().toLowerCase() }, token.trim());
        setIsLoading(false);
      };

      return (
        <div className="modal-overlay">
          <div className="modal">
            <div className="modal-content">
              <div className="modal-header">
                <img src="https://steveyoung74.github.io/journeymaps/logo_dark.png" alt="FATHOM" style={{ height: '28px' }} />
              </div>
              
              <h2 className="modal-title">Welcome to Fathom</h2>
              <p className="text-muted" style={{ marginBottom: '24px', fontSize: '14px' }}>Enter your details to access your journey maps</p>

              {error && (
                <div style={{ padding: '12px 14px', background: 'var(--error-light)', borderRadius: '8px', marginBottom: '16px', color: 'var(--error)', fontSize: '13px' }}>
                  {error}
                </div>
              )}

              <form onSubmit={handleSubmit}>
                <div style={{ marginBottom: '16px' }}>
                  <label className="label">Your Name</label>
                  <input
                    type="text"
                    className="input"
                    value={name}
                    onChange={(e) => setName(e.target.value)}
                    placeholder="Steve Young"
                    autoFocus
                  />
                </div>

                <div style={{ marginBottom: '16px' }}>
                  <label className="label">Email Address</label>
                  <input
                    type="email"
                    className="input"
                    value={email}
                    onChange={(e) => setEmail(e.target.value)}
                    placeholder="steve@company.com"
                  />
                </div>

                <div style={{ marginBottom: '24px' }}>
                  <label className="label">GitHub Token <span style={{ fontWeight: 400, color: 'var(--slate-400)' }}>(optional)</span></label>
                  <input
                    type="password"
                    className="input"
                    value={token}
                    onChange={(e) => setToken(e.target.value)}
                    placeholder="ghp_xxxxxxxxxxxx"
                  />
                  <p className="text-muted text-small" style={{ marginTop: '6px' }}>
                    Required to create and edit maps.
                  </p>
                </div>

                <button type="submit" className="btn btn-primary" style={{ width: '100%', padding: '14px' }} disabled={isLoading}>
                  {isLoading ? 'Signing in...' : 'Sign In'}
                </button>
              </form>
            </div>
          </div>
        </div>
      );
    }
    
    // ============================================
    // DASHBOARD
    // ============================================
    function Dashboard() {
      const { user, profile, signOut } = useAuth();
      const [maps, setMaps] = useState([]);
      const [sharedMaps, setSharedMaps] = useState([]);
      const [loading, setLoading] = useState(true);
      const [error, setError] = useState('');
      const [showCreateModal, setShowCreateModal] = useState(false);
      const [showShareModal, setShowShareModal] = useState(null);
      const [activeTab, setActiveTab] = useState('my-maps');
      const [showMobileMenu, setShowMobileMenu] = useState(false);
      const [showProfileMenu, setShowProfileMenu] = useState(false);
      const [openOptionsMenu, setOpenOptionsMenu] = useState(null); // mapId of open menu
      const [showRenameModal, setShowRenameModal] = useState(null); // mapId for rename
      const [viewMode, setViewMode] = useState('cards'); // 'cards' or 'list'
      const [isMobile, setIsMobile] = useState(window.innerWidth < 768);
      
      // Handle resize for mobile detection
      useEffect(() => {
        const handleResize = () => setIsMobile(window.innerWidth < 768);
        window.addEventListener('resize', handleResize);
        return () => window.removeEventListener('resize', handleResize);
      }, []);
      
      // Helper to get user initials
      const getInitials = (name) => {
        if (!name) return '?';
        return name.split(' ').map(n => n[0]).join('').toUpperCase().slice(0, 2);
      };
      
      // Close profile menu and options menu when clicking outside
      useEffect(() => {
        const handleClickOutside = (e) => {
          if (showProfileMenu && !e.target.closest('.profile-container')) {
            setShowProfileMenu(false);
          }
          if (openOptionsMenu && !e.target.closest('.card-options-container')) {
            setOpenOptionsMenu(null);
          }
        };
        document.addEventListener('click', handleClickOutside);
        return () => document.removeEventListener('click', handleClickOutside);
      }, [showProfileMenu, openOptionsMenu]);

      useEffect(() => {
        window.scrollTo(0, 0);
        if (profile?.organisation_id) {
          fetchMaps();
          fetchSharedMaps();
        }
      }, [profile?.organisation_id]);

      const fetchMaps = async () => {
        if (!profile?.organisation_id) {
          setLoading(false);
          return;
        }
        setLoading(true);
        setError('');
        try {
          const data = await fetchMapsFromSupabase(profile.organisation_id);
          // Transform Supabase data to match existing map structure
          const transformedMaps = data.map(m => ({
            id: m.id,
            title: m.title,
            description: m.description,
            journeyType: m.journey_type,
            template: m.template_source,
            createdAt: m.created_at,
            updatedAt: m.updated_at,
            lastOpenedAt: m.last_opened_at,
            createdBy: m.created_by,
            isExample: m.is_example || false,
            // Config is stored directly in the map
            config: m.config,
            // Legacy compatibility
            favourite: m.config?.favourite || false,
            locked: m.config?.locked || false,
            sharedWith: m.config?.sharedWith || []
          }));
          setMaps(transformedMaps);
        } catch (err) {
          console.error('Fetch error:', err);
          setError('Failed to load maps');
        }
        setLoading(false);
      };
      
      const fetchSharedMaps = async () => {
        if (!user?.id) return;
        
        try {
          // Get maps shared directly with user
          const { data: sharedWithUser, error: err1 } = await supabase
            .from('journey_map_shares')
            .select(`
              id,
              permission,
              shared_at,
              shared_by,
              journey_maps (
                id,
                title,
                description,
                journey_type,
                config,
                created_at,
                updated_at,
                created_by,
                users:created_by (
                  display_name,
                  email
                )
              )
            `)
            .eq('shared_with_user_id', user.id);
          
          // Also get maps shared via email (for users who signed up after being shared with)
          const { data: sharedWithEmail, error: err2 } = await supabase
            .from('journey_map_shares')
            .select(`
              id,
              permission,
              shared_at,
              shared_by,
              journey_maps (
                id,
                title,
                description,
                journey_type,
                config,
                created_at,
                updated_at,
                created_by,
                users:created_by (
                  display_name,
                  email
                )
              )
            `)
            .eq('shared_with_email', user.email);
          
          const allShared = [...(sharedWithUser || []), ...(sharedWithEmail || [])];
          
          // Transform and dedupe
          const seenIds = new Set();
          const transformedShared = allShared
            .filter(s => s.journey_maps && !seenIds.has(s.journey_maps.id))
            .map(s => {
              seenIds.add(s.journey_maps.id);
              const m = s.journey_maps;
              return {
                id: m.id,
                title: m.title,
                description: m.description,
                journeyType: m.journey_type,
                createdAt: m.created_at,
                updatedAt: m.updated_at,
                config: m.config,
                permission: s.permission,
                sharedAt: s.shared_at,
                sharedBy: m.users?.display_name || m.users?.email || 'Someone',
                isShared: true
              };
            });
          
          setSharedMaps(transformedShared);
        } catch (err) {
          console.error('Error fetching shared maps:', err);
        }
      };

      // Calculate hourly rate from annual salary (matches editor.html)
      const WORKING_HOURS_PER_YEAR = 1820; // 52 weeks * 35 hours (UK standard)
      
      const calculateFullyLoadedRate = (persona) => {
        if (!persona || persona.isExternal) return 0;
        const salary = persona.annualSalary || persona.salary || 0;
        if (salary === 0) return 0;
        const baseHourly = salary / WORKING_HOURS_PER_YEAR;
        const burdenMultiplier = persona.burdenMultiplier || 1.0;
        const workspaceHourly = persona.workspaceHourlyCost || 0;
        return (baseHourly * burdenMultiplier) + workspaceHourly;
      };

      // Calculate step cost - handles both legacy (owner) and new (roleInvolvement) formats
      const calculateStepCost = (step, personas) => {
        if (!personas) return 0;
        let totalCost = 0;
        
        // New format: roleInvolvement object
        if (step.roleInvolvement && Object.keys(step.roleInvolvement).length > 0) {
          Object.entries(step.roleInvolvement).forEach(([personaId, inv]) => {
            const persona = personas.find(p => p.id === personaId);
            if (persona && !persona.isExternal) {
              const fullyLoadedRate = calculateFullyLoadedRate(persona);
              const hours = (inv.timeMinutes || 0) / 60;
              const headcount = inv.headcount || 1;
              totalCost += fullyLoadedRate * hours * headcount;
            }
          });
        }
        // Legacy format: owner + timeMinutes
        else if (step.owner && step.timeMinutes) {
          const persona = personas.find(p => p.id === step.owner);
          if (persona && !persona.isExternal) {
            const fullyLoadedRate = calculateFullyLoadedRate(persona);
            totalCost += fullyLoadedRate * (step.timeMinutes / 60);
          }
        }
        
        // Additional costs (third-party services, materials, etc.)
        if (step.additionalCosts && Array.isArray(step.additionalCosts)) {
          step.additionalCosts.forEach(cost => {
            totalCost += cost.amount || 0;
          });
        }
        
        return totalCost;
      };

      const getMapMetrics = (map) => {
        const config = map.config;
        if (!config?.stages) return null;
        
        const allSteps = config.stages.flatMap(s => s.steps || []);
        const totalTime = allSteps.reduce((acc, s) => acc + (s.timeMinutes || s.duration || 0), 0);
        const totalPainPoints = allSteps.reduce((acc, s) => acc + (s.painPoints?.length || 0), 0);
        const highImprovements = allSteps.filter(s => s.automationOpportunity === 'high').length;
        
        const frictionMap = { none: 1, low: 2, medium: 3, high: 4, extreme: 5 };
        const frictionValues = allSteps.map(s => s.frictionLevel || s.frictionScore || frictionMap[s.friction]).filter(Boolean);
        const avgFriction = frictionValues.length ? (frictionValues.reduce((a, b) => a + b, 0) / frictionValues.length).toFixed(1) : null;
        
        let totalCost = null;
        if (config.personas?.length) {
          totalCost = 0;
          allSteps.forEach(step => {
            // Use calculateStepCost for consistent cost calculation
            totalCost += calculateStepCost(step, config.personas);
          });
        }
        
        return { totalTime, totalSteps: allSteps.length, stageCount: config.stages?.length || 0, totalPainPoints, highImprovements, avgFriction, totalCost };
      };

      // Helper for map configs (now embedded in map)
      const mapConfigs = maps.reduce((acc, m) => { acc[m.id] = m.config; return acc; }, {});

      // Generate comprehensive report
      const generateReport = (mapId) => {
        const config = mapConfigs[mapId];
        const map = maps.find(m => m.id === mapId);
        if (!config) {
          alert('Report data not loaded yet. Please try again.');
          return;
        }

        const printWindow = window.open('', '_blank');
        if (!printWindow) {
          alert('Please allow popups to generate the report');
          return;
        }

        const allSteps = config.stages.flatMap((stage, si) => 
          stage.steps.map((step, sti) => ({ ...step, stageName: stage.name, stageIndex: si, stepIndex: sti }))
        );

        // Calculate totals
        const totalTime = allSteps.reduce((acc, s) => acc + (s.timeMinutes || 0), 0);
        const totalPainPoints = allSteps.reduce((acc, s) => acc + (s.painPoints?.length || 0), 0);
        const highAutomationCount = allSteps.filter(s => s.automationOpportunity === 'high').length;
        const frictionMap = { none: 1, low: 2, medium: 3, high: 4, extreme: 5 };
        const frictionValues = allSteps.map(s => s.frictionLevel || s.frictionScore || frictionMap[s.friction]).filter(Boolean);
        const avgFriction = frictionValues.length ? (frictionValues.reduce((a, b) => a + b, 0) / frictionValues.length).toFixed(1) : 'N/A';

        // Calculate costs
        let totalCost = 0;
        const hasCostData = config.personas?.some(p => p.salary || p.annualSalary);
        if (hasCostData) {
          allSteps.forEach(step => {
            totalCost += calculateStepCost(step, config.personas);
          });
        }

        // Calculate potential savings
        const potentialSavings = allSteps.reduce((acc, s) => {
          const cost = calculateStepCost(s, config.personas);
          if (s.automationOpportunity === 'high') return acc + cost * 0.7;
          if (s.automationOpportunity === 'medium') return acc + cost * 0.4;
          if (s.automationOpportunity === 'low') return acc + cost * 0.1;
          return acc;
        }, 0);

        // Stage metrics
        const stageMetrics = config.stages.map(stage => {
          const stageSteps = stage.steps || [];
          const stageTime = stageSteps.reduce((acc, s) => acc + (s.timeMinutes || 0), 0);
          const stageCost = stageSteps.reduce((acc, s) => acc + calculateStepCost(s, config.personas), 0);
          const stagePainPoints = stageSteps.reduce((acc, s) => acc + (s.painPoints?.length || 0), 0);
          const stageFrictionValues = stageSteps.map(s => s.frictionLevel || s.frictionScore || frictionMap[s.friction]).filter(Boolean);
          const avgStageFriction = stageFrictionValues.length ? (stageFrictionValues.reduce((a, b) => a + b, 0) / stageFrictionValues.length).toFixed(1) : 'N/A';
          return { name: stage.name, stepCount: stageSteps.length, time: stageTime, cost: stageCost, painPoints: stagePainPoints, avgFriction: avgStageFriction, dropOffCount: stage.dropOffCount || 0 };
        });

        // Role costs - handles both roleInvolvement and legacy owner format
        const roleCosts = (config.personas || []).filter(p => !p.isExternal && (p.salary || p.annualSalary)).map(persona => {
          let roleTime = 0;
          let roleCost = 0;
          const fullyLoadedRate = calculateFullyLoadedRate(persona);
          
          allSteps.forEach(step => {
            // New format: roleInvolvement
            const inv = step.roleInvolvement?.[persona.id];
            if (inv) {
              roleTime += inv.timeMinutes || 0;
              roleCost += (inv.timeMinutes / 60) * fullyLoadedRate * (inv.headcount || 1);
            }
            // Legacy format: owner
            else if (step.owner === persona.id && step.timeMinutes) {
              roleTime += step.timeMinutes;
              roleCost += (step.timeMinutes / 60) * fullyLoadedRate;
            }
          });
          return { label: persona.label || persona.name, color: persona.color, totalMinutes: roleTime, totalCost: roleCost };
        }).filter(r => r.totalCost > 0).sort((a, b) => b.totalCost - a.totalCost);

        // Top expensive steps
        const topExpensiveSteps = allSteps.map(s => ({ ...s, cost: calculateStepCost(s, config.personas) })).sort((a, b) => b.cost - a.cost).slice(0, 5);
        
        // Top improvement opportunities
        const topImprovements = allSteps.filter(s => s.automationOpportunity === 'high' || s.automationOpportunity === 'medium').map(s => {
          const cost = calculateStepCost(s, config.personas);
          const savings = s.automationOpportunity === 'high' ? cost * 0.7 : cost * 0.4;
          return { ...s, cost, savings };
        }).sort((a, b) => b.savings - a.savings).slice(0, 8);

        const date = new Date().toLocaleDateString('en-GB', { day: 'numeric', month: 'long', year: 'numeric' });
        const title = config.meta?.title || map?.title || 'Journey Map';

        // Build HTML using arrays to avoid nested template literals
        const parts = [];
        
        parts.push('<!DOCTYPE html><html><head><meta charset="UTF-8"><title>' + title + ' - Complete Report</title>');
        parts.push('<style>');
        parts.push('@page { margin: 15mm; size: A4; }');
        parts.push('* { box-sizing: border-box; margin: 0; padding: 0; }');
        parts.push('body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif; color: #1F2937; line-height: 1.5; padding: 32px 40px; max-width: 1000px; margin: 0 auto; font-size: 12px; }');
        parts.push('.header { background: #192B45; color: #FFF; padding: 24px 28px; border-radius: 8px; margin-bottom: 24px; display: flex; justify-content: space-between; align-items: center; }');
        parts.push('.header h1 { font-size: 24px; font-weight: 600; margin-bottom: 4px; }');
        parts.push('.header .subtitle { font-size: 14px; opacity: 0.8; }');
        parts.push('.header .meta { text-align: right; font-size: 11px; opacity: 0.7; }');
        parts.push('.section { margin-bottom: 28px; page-break-inside: avoid; }');
        parts.push('.section-title { font-size: 16px; font-weight: 600; color: #192B45; margin-bottom: 12px; padding-bottom: 6px; border-bottom: 2px solid #2D8A6E; }');
        parts.push('.summary-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 12px; margin-bottom: 20px; }');
        parts.push('.summary-grid.cols-3 { grid-template-columns: repeat(3, 1fr); }');
        parts.push('.summary-card { background: #F8FAFC; border: 1px solid #E2E8F0; border-radius: 8px; padding: 14px; text-align: center; }');
        parts.push('.summary-card.highlight-green { background: #D1FAE5; border-color: #A7F3D0; }');
        parts.push('.summary-card.highlight-red { background: #FEE2E2; border-color: #FECACA; }');
        parts.push('.summary-card.highlight-amber { background: #FEF3C7; border-color: #FDE68A; }');
        parts.push('.summary-value { font-size: 20px; font-weight: 700; color: #192B45; }');
        parts.push('.summary-label { font-size: 9px; color: #64748B; text-transform: uppercase; letter-spacing: 0.5px; margin-top: 4px; }');
        parts.push('table { width: 100%; border-collapse: collapse; font-size: 11px; margin-bottom: 16px; }');
        parts.push('th, td { padding: 8px 10px; text-align: left; border-bottom: 1px solid #E2E8F0; }');
        parts.push('th { background: #F8FAFC; font-weight: 600; color: #475569; font-size: 9px; text-transform: uppercase; }');
        parts.push('.num { text-align: right; }');
        parts.push('.text-green { color: #059669; }');
        parts.push('.text-red { color: #DC2626; }');
        parts.push('.two-column { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }');
        parts.push('.stage-header { background: #2D8A6E; color: #FFF; padding: 10px 14px; border-radius: 6px 6px 0 0; display: flex; justify-content: space-between; font-size: 12px; }');
        parts.push('.badge { display: inline-block; padding: 2px 8px; border-radius: 10px; font-size: 10px; font-weight: 500; }');
        parts.push('.badge-high { background: #D1FAE5; color: #059669; }');
        parts.push('.badge-medium { background: #FEF3C7; color: #D97706; }');
        parts.push('.badge-low { background: #E2E8F0; color: #64748B; }');
        parts.push('.rpt-footer { margin-top: 32px; padding-top: 16px; border-top: 1px solid #C8CED6; font-size: 10px; color: #8A95A5; text-align: center; }');
        parts.push('@media print { .page-break { page-break-before: always; } }');
        parts.push('</style></head><body>');

        // Header
        parts.push('<div class="header"><div><h1>' + title + '</h1><div class="subtitle">Complete Journey Analysis Report</div></div>');
        parts.push('<div class="meta">Generated: ' + date + '<br/>Version: ' + (config.meta?.version || '1.0') + '</div></div>');

        // Executive Summary
        parts.push('<div class="section"><div class="section-title">üìä Executive Summary</div>');
        parts.push('<div class="summary-grid">');
        parts.push('<div class="summary-card"><div class="summary-value">' + config.stages.length + '</div><div class="summary-label">Stages</div></div>');
        parts.push('<div class="summary-card"><div class="summary-value">' + allSteps.length + '</div><div class="summary-label">Steps</div></div>');
        parts.push('<div class="summary-card"><div class="summary-value">' + formatTime(totalTime) + '</div><div class="summary-label">Total Time</div></div>');
        parts.push('<div class="summary-card highlight-amber"><div class="summary-value">' + (hasCostData ? formatCurrency(totalCost) : 'N/A') + '</div><div class="summary-label">Total Cost</div></div>');
        parts.push('</div>');
        parts.push('<div class="summary-grid">');
        parts.push('<div class="summary-card highlight-red"><div class="summary-value">' + totalPainPoints + '</div><div class="summary-label">Pain Points</div></div>');
        parts.push('<div class="summary-card"><div class="summary-value">' + avgFriction + '/5</div><div class="summary-label">Avg Friction</div></div>');
        parts.push('<div class="summary-card"><div class="summary-value">' + highAutomationCount + '</div><div class="summary-label">High Improvement Opps</div></div>');
        parts.push('<div class="summary-card highlight-green"><div class="summary-value">' + (hasCostData ? formatCurrency(potentialSavings) : 'N/A') + '</div><div class="summary-label">Potential Savings</div></div>');
        parts.push('</div></div>');

        // Timeline Analysis
        parts.push('<div class="section"><div class="section-title">‚è±Ô∏è Timeline Analysis</div>');
        parts.push('<table><thead><tr><th>Stage</th><th class="num">Steps</th><th class="num">Time</th><th class="num">% of Total</th><th class="num">Avg Friction</th><th class="num">Pain Points</th></tr></thead><tbody>');
        stageMetrics.forEach(function(s) {
          var pct = totalTime > 0 ? ((s.time / totalTime) * 100).toFixed(1) : 0;
          parts.push('<tr><td>' + s.name + '</td><td class="num">' + s.stepCount + '</td><td class="num">' + formatTime(s.time) + '</td><td class="num">' + pct + '%</td><td class="num">' + s.avgFriction + '/5</td><td class="num">' + s.painPoints + '</td></tr>');
        });
        parts.push('<tr style="font-weight:600;background:#F8FAFC"><td>Total</td><td class="num">' + allSteps.length + '</td><td class="num">' + formatTime(totalTime) + '</td><td class="num">100%</td><td class="num">' + avgFriction + '/5</td><td class="num">' + totalPainPoints + '</td></tr>');
        parts.push('</tbody></table></div>');

        // Cost Analysis
        if (hasCostData) {
          parts.push('<div class="section"><div class="section-title">üí∞ Cost Analysis</div>');
          parts.push('<div class="two-column"><div><h4 style="font-size:12px;margin-bottom:8px;color:#475569">Cost by Stage</h4>');
          parts.push('<table><thead><tr><th>Stage</th><th class="num">Time</th><th class="num">Cost</th><th class="num">%</th></tr></thead><tbody>');
          stageMetrics.forEach(function(s) {
            var pct = totalCost > 0 ? ((s.cost / totalCost) * 100).toFixed(1) : 0;
            parts.push('<tr><td>' + s.name + '</td><td class="num">' + formatTime(s.time) + '</td><td class="num">' + formatCurrency(s.cost) + '</td><td class="num">' + pct + '%</td></tr>');
          });
          parts.push('</tbody></table></div>');
          
          parts.push('<div><h4 style="font-size:12px;margin-bottom:8px;color:#475569">Cost by Role</h4>');
          parts.push('<table><thead><tr><th>Role</th><th class="num">Time</th><th class="num">Cost</th><th class="num">%</th></tr></thead><tbody>');
          roleCosts.forEach(function(r) {
            var pct = totalCost > 0 ? ((r.totalCost / totalCost) * 100).toFixed(1) : 0;
            parts.push('<tr><td>' + r.label + '</td><td class="num">' + formatTime(r.totalMinutes) + '</td><td class="num">' + formatCurrency(r.totalCost) + '</td><td class="num">' + pct + '%</td></tr>');
          });
          parts.push('</tbody></table></div></div>');

          // Top Expensive Steps
          if (topExpensiveSteps.length > 0) {
            parts.push('<h4 style="font-size:12px;margin:16px 0 8px;color:#475569">üî• Top 5 Most Expensive Steps</h4>');
            parts.push('<table><thead><tr><th>#</th><th>Step</th><th>Stage</th><th class="num">Cost</th></tr></thead><tbody>');
            topExpensiveSteps.forEach(function(s, i) {
              parts.push('<tr><td>' + (i + 1) + '</td><td>' + s.name + '</td><td>' + s.stageName + '</td><td class="num">' + formatCurrency(s.cost) + '</td></tr>');
            });
            parts.push('</tbody></table>');
          }
          parts.push('</div>');
        }

        // Improvement Opportunities
        if (topImprovements.length > 0 && hasCostData) {
          parts.push('<div class="section"><div class="section-title">üéØ Top Improvement Opportunities</div>');
          parts.push('<table><thead><tr><th>Step</th><th>Stage</th><th class="num">Current Cost</th><th class="num">Opportunity</th><th class="num">Potential Savings</th></tr></thead><tbody>');
          topImprovements.forEach(function(s) {
            parts.push('<tr><td>' + s.name + '</td><td>' + s.stageName + '</td><td class="num">' + formatCurrency(s.cost) + '</td><td class="num"><span class="badge badge-' + s.automationOpportunity + '">' + s.automationOpportunity + '</span></td><td class="num text-green">' + formatCurrency(s.savings) + '</td></tr>');
          });
          parts.push('</tbody></table></div>');
        }

        // Detailed Stage Breakdown
        parts.push('<div class="section page-break"><div class="section-title">üìã Detailed Stage Breakdown</div>');
        config.stages.forEach(function(stage, si) {
          var stageSteps = stage.steps || [];
          var stageTime = stageSteps.reduce(function(acc, s) { return acc + (s.timeMinutes || 0); }, 0);
          var stageCost = stageSteps.reduce(function(acc, s) { return acc + calculateStepCost(s, config.personas); }, 0);
          
          parts.push('<div style="margin-bottom:16px;">');
          parts.push('<div class="stage-header"><span>' + stage.name + '</span><span>' + stageSteps.length + ' steps ¬∑ ' + formatTime(stageTime) + (hasCostData ? ' ¬∑ ' + formatCurrency(stageCost) : '') + '</span></div>');
          parts.push('<table><thead><tr><th style="width:40px">#</th><th>Step</th><th style="width:70px" class="num">Time</th>' + (hasCostData ? '<th style="width:80px" class="num">Cost</th>' : '') + '<th>Pain Points</th><th style="width:80px" class="num">Improvement</th></tr></thead><tbody>');
          
          stageSteps.forEach(function(step, sti) {
            var stepCost = calculateStepCost(step, config.personas);
            var owner = config.personas?.find(function(p) { return p.id === step.owner; });
            var painPointsHtml = (step.painPoints || []).length > 0 ? (step.painPoints || []).map(function(p) { return '‚ö† ' + p; }).join('<br/>') : '‚Äî';
            
            parts.push('<tr>');
            parts.push('<td>' + (si + 1) + '.' + (sti + 1) + '</td>');
            parts.push('<td><strong>' + step.name + '</strong><div style="font-size:10px;color:#64748B">' + (owner?.label || '') + (step.clientTouchpoint ? ' ¬∑ üë§ Client' : '') + '</div></td>');
            parts.push('<td class="num">' + formatTime(step.timeMinutes || 0) + '</td>');
            if (hasCostData) {
              parts.push('<td class="num">' + formatCurrency(stepCost) + '</td>');
            }
            parts.push('<td style="font-size:10px;color:#DC2626">' + painPointsHtml + '</td>');
            parts.push('<td class="num"><span class="badge badge-' + (step.automationOpportunity || 'none') + '">' + (step.automationOpportunity || 'none') + '</span></td>');
            parts.push('</tr>');
          });
          
          parts.push('</tbody></table></div>');
        });
        parts.push('</div>');

        // Footer
        parts.push('<div class="rpt-footer"><p>Generated by FATHOM ¬∑ ' + date + '</p><p style="margin-top:4px">üí° Use Print ‚Üí Save as PDF to save this report</p></div>');
        parts.push('<script>window.onload = function() { window.print(); }<\/script>');
        parts.push('</body></html>');

        printWindow.document.write(parts.join(''));
        printWindow.document.close();
      };

      // Sort by updated_at (most recent first), with examples always at bottom
      const myMaps = [...maps].sort((a, b) => {
        // Check if either is an example map
        const aIsExample = a.config?.isExample || a.config?.meta?.isExample || a.template_source === 'starter-example';
        const bIsExample = b.config?.isExample || b.config?.meta?.isExample || b.template_source === 'starter-example';
        
        // Examples always go to bottom
        if (aIsExample && !bIsExample) return 1;
        if (!aIsExample && bIsExample) return -1;
        
        // Both examples or both regular - sort by updated_at (when saved)
        const aTime = new Date(a.updatedAt || a.updated_at || a.created_at);
        const bTime = new Date(b.updatedAt || b.updated_at || b.created_at);
        return bTime - aTime;
      });
      // sharedMaps is now loaded from state via fetchSharedMaps()
      
      const openMap = async (mapId) => {
        const map = maps.find(m => m.id === mapId);
        const title = map?.config?.meta?.title || map?.title || 'Journey Map';
        
        // Navigate to editor (no need to update last_opened_at since we sort by updated_at)
        window.location.href = `editor.html?id=${mapId}&title=${encodeURIComponent(title)}`;
      };

      // Toggle favourite/star
      const toggleFavourite = async (mapId, e) => {
        if (e) {
          e.stopPropagation();
          e.preventDefault();
        }
        const map = maps.find(m => m.id === mapId);
        if (!map) return;
        try {
          const updatedConfig = { ...map.config, favourite: !map.favourite };
          await supabase
            .from('journey_maps')
            .update({ config: updatedConfig })
            .eq('id', mapId);
          setMaps(maps.map(m => m.id === mapId ? { ...m, favourite: !m.favourite, config: updatedConfig } : m));
        } catch (err) {
          console.error('Failed to toggle favourite:', err);
        }
      };

      // Options menu handlers
      const handleOptionsClick = (mapId, e) => {
        e.stopPropagation();
        e.preventDefault();
        setOpenOptionsMenu(openOptionsMenu === mapId ? null : mapId);
      };

      const handleCopyLink = (mapId, e) => {
        e.stopPropagation();
        const map = maps.find(m => m.id === mapId);
        const title = map?.config?.meta?.title || map?.title || 'Journey Map';
        const link = `${window.location.origin}/editor.html?id=${mapId}&title=${encodeURIComponent(title)}`;
        navigator.clipboard.writeText(link).then(() => {
          alert('Link copied to clipboard!');
        });
        setOpenOptionsMenu(null);
      };

      const handleOpenNewTab = (mapId, e) => {
        e.stopPropagation();
        const map = maps.find(m => m.id === mapId);
        const title = map?.config?.meta?.title || map?.title || 'Journey Map';
        window.open(`editor.html?id=${mapId}&title=${encodeURIComponent(title)}`, '_blank');
        setOpenOptionsMenu(null);
      };

      const handleRename = (mapId, e) => {
        e.stopPropagation();
        setShowRenameModal(mapId);
        setOpenOptionsMenu(null);
      };

      const handleDownloadBackup = (mapId, e) => {
        e.stopPropagation();
        const map = maps.find(m => m.id === mapId);
        if (!map) return;
        
        const config = map.config || mapConfigs[mapId];
        const exportData = {
          ...config,
          exportedAt: new Date().toISOString(),
          exportedFrom: 'FATHOM Dashboard'
        };
        
        const blob = new Blob([JSON.stringify(exportData, null, 2)], { type: 'application/json' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `${(config?.meta?.title || map.title || 'journey-map').replace(/[^a-z0-9]/gi, '-').toLowerCase()}-backup.json`;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
        setOpenOptionsMenu(null);
      };

      const handleDeleteMap = async (mapId, e) => {
        e.stopPropagation();
        const map = maps.find(m => m.id === mapId);
        if (!map) return;
        
        if (map.favourite) {
          alert('Cannot delete a starred map. Please unstar it first.');
          setOpenOptionsMenu(null);
          return;
        }
        
        const title = map?.config?.meta?.title || map?.title || 'this map';
        if (!confirm(`Delete "${title}"? This cannot be undone.`)) {
          setOpenOptionsMenu(null);
          return;
        }
        
        try {
          await deleteMapFromSupabase(mapId);
          setMaps(maps.filter(m => m.id !== mapId));
          setOpenOptionsMenu(null);
        } catch (err) {
          console.error('Failed to delete map:', err);
          alert('Failed to delete map. Please try again.');
        }
      };

      const handleShareFromMenu = (mapId, e) => {
        e.stopPropagation();
        setShowShareModal(mapId);
        setOpenOptionsMenu(null);
      };

      const displayMaps = activeTab === 'my-maps' ? myMaps : sharedMaps;

      // Show loading if profile not ready
      if (!profile) {
        return (
          <div style={{ minHeight: '100vh', display: 'flex', alignItems: 'center', justifyContent: 'center', background: 'var(--slate-50)', flexDirection: 'column', gap: '16px' }}>
            <img src="https://steveyoung74.github.io/journeymaps/logo_dark.png" alt="FATHOM" style={{ height: '32px', opacity: 0.5 }} />
            <p style={{ color: 'var(--slate-500)', fontSize: '14px' }}>Setting up your workspace...</p>
          </div>
        );
      }

      return (
        <div className="page-container">
          {/* Navigation */}
          <nav className="nav">
            <div className="nav-inner">
              <div className="nav-left">
                <a href="index.html">
                  <img src="https://steveyoung74.github.io/journeymaps/logo_light.png" alt="FATHOM" className="nav-logo" />
                </a>
                <div className="nav-links">
                  <a href="dashboard.html" className="nav-link active">Dashboard</a>
                  <div className="dropdown">
                    <span className="nav-link" style={{ cursor: 'pointer' }}>Surveys ‚ñæ</span>
                    <div className="dropdown-menu">
                      <a href="survey-admin.html" className="dropdown-item">Send Surveys</a>
                      <a href="responses.html" className="dropdown-item">View Responses</a>
                    </div>
                  </div>
                  {(profile?.role === 'owner' || profile?.role === 'admin') && (
                    <a href="team.html" className="nav-link">Team</a>
                  )}
                  <a href="whats-new.html" className="nav-link">What's New</a>
                  <a href="about.html" className="nav-link">About</a>
                </div>
              </div>
              <div className="nav-right">
                <div className="profile-container" style={{ position: 'relative' }}>
                  <button 
                    className={`profile-trigger ${showProfileMenu ? 'open' : ''}`}
                    onClick={(e) => { e.stopPropagation(); setShowProfileMenu(!showProfileMenu); }}
                  >
                    <div className="profile-avatar">
                      {profile?.avatar_url ? (
                        <img src={profile.avatar_url} alt="" />
                      ) : (
                        getInitials(profile?.display_name || profile?.email)
                      )}
                    </div>
                    <span className="profile-chevron">‚ñº</span>
                  </button>
                  
                  <div className={`profile-dropdown ${showProfileMenu ? 'open' : ''}`}>
                    <div className="profile-dropdown-header">
                      <div className="profile-dropdown-avatar">
                        {profile?.avatar_url ? (
                          <img src={profile.avatar_url} alt="" style={{ width: '100%', height: '100%', objectFit: 'cover' }} />
                        ) : (
                          getInitials(profile?.display_name || profile?.email)
                        )}
                      </div>
                      <div className="profile-dropdown-info">
                        <div className="profile-dropdown-name">{profile?.display_name || 'User'}</div>
                        <div className="profile-dropdown-email">{profile?.email}</div>
                      </div>
                    </div>
                    
                    <a href="profile.html" className="profile-dropdown-item" onClick={() => setShowProfileMenu(false)}>
                      <span className="icon">üë§</span>
                      Profile Settings
                    </a>
                    
                    {(profile?.role === 'owner' || profile?.role === 'admin') && (
                      <a href="team.html" className="profile-dropdown-item" onClick={() => setShowProfileMenu(false)}>
                        <span className="icon">üë•</span>
                        Team Management
                      </a>
                    )}
                    
                    <div className="profile-dropdown-divider" />
                    
                    <a href="whats-new.html" className="profile-dropdown-item" onClick={() => setShowProfileMenu(false)}>
                      <span className="icon">‚ú®</span>
                      What's New
                    </a>
                    <a href="about.html" className="profile-dropdown-item" onClick={() => setShowProfileMenu(false)}>
                      <span className="icon">‚ÑπÔ∏è</span>
                      About Fathom
                    </a>
                    
                    <div className="profile-dropdown-divider" />
                    
                    <button 
                      className="profile-dropdown-item danger"
                      onClick={() => { setShowProfileMenu(false); signOut(); }}
                    >
                      <span className="icon">üö™</span>
                      Sign Out
                    </button>
                  </div>
                </div>
              </div>
              <button className="nav-mobile-toggle" onClick={() => setShowMobileMenu(true)}>‚ò∞</button>
            </div>
          </nav>
          
          {/* Mobile Menu - Threads-style */}
          <div className={`nav-mobile-backdrop ${showMobileMenu ? 'open' : ''}`} onClick={() => setShowMobileMenu(false)} />
          <div className={`nav-mobile-menu ${showMobileMenu ? 'open' : ''}`}>
            <div className="nav-mobile-header">
              <button className="nav-mobile-close" onClick={() => setShowMobileMenu(false)}>‚úï</button>
            </div>
            <div className="nav-mobile-links">
              <a href="dashboard.html" className="nav-mobile-link active">Dashboard</a>
              <div className="nav-mobile-section-label">Surveys</div>
              <a href="survey-admin.html" className="nav-mobile-link">Send Surveys</a>
              <a href="responses.html" className="nav-mobile-link">View Responses</a>
              {(profile?.role === 'owner' || profile?.role === 'admin') && (
                <>
                  <div className="nav-mobile-section-label">Organisation</div>
                  <a href="team.html" className="nav-mobile-link">Team</a>
                </>
              )}
              <div className="nav-mobile-section-label">Info</div>
              <a href="whats-new.html" className="nav-mobile-link">What's New</a>
              <a href="about.html" className="nav-mobile-link">About</a>
            </div>
            <div className="nav-mobile-user">
              <div className="nav-mobile-user-name">Signed in as {profile?.display_name || profile?.email}</div>
              <button onClick={() => { setShowMobileMenu(false); signOut(); }} className="nav-mobile-signout">Sign Out</button>
            </div>
          </div>

          {/* Main Content */}
          <main>
            <div className="main-inner">
              <div className="dash-header">
                <div className="dash-header-row">
                  <div>
                    <h1 className="dash-title">Your Journey Intelligence Maps</h1>
                    <p className="dash-subtitle">Create, manage, and share operational journey maps</p>
                  </div>
                  <button onClick={() => setShowCreateModal(true)} className="btn btn-primary">
                    + New Map
                  </button>
                </div>
              </div>

              {/* Tabs */}
              <div className="tabs" style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center' }}>
                <div style={{ display: 'flex', gap: '8px' }}>
                  <button className={`tab-btn ${activeTab === 'my-maps' ? 'active' : ''}`} onClick={() => { setActiveTab('my-maps'); exitManageMode(); }}>
                    My Maps ({myMaps.length})
                  </button>
                  <button className={`tab-btn ${activeTab === 'shared' ? 'active' : ''}`} onClick={() => { setActiveTab('shared'); exitManageMode(); }}>
                    Shared with Me ({sharedMaps.length})
                  </button>
                </div>
                <div style={{ display: 'flex', gap: '8px', alignItems: 'center' }}>
                  {/* View Toggle - hidden on mobile */}
                  {!isMobile && (
                    <div style={{ 
                      display: 'flex', 
                      background: 'var(--slate-100)', 
                      borderRadius: '6px', 
                      padding: '2px',
                      marginRight: '8px'
                    }}>
                      <button 
                        onClick={() => setViewMode('cards')}
                        style={{ 
                          padding: '6px 10px', 
                          borderRadius: '4px', 
                          border: 'none', 
                          background: viewMode === 'cards' ? '#FFF' : 'transparent',
                          boxShadow: viewMode === 'cards' ? '0 1px 3px rgba(0,0,0,0.1)' : 'none',
                          cursor: 'pointer',
                          fontSize: '13px',
                          color: viewMode === 'cards' ? 'var(--slate-700)' : 'var(--slate-500)'
                        }}
                        title="Card view"
                      >
                        ‚ñ¶
                      </button>
                      <button 
                        onClick={() => setViewMode('list')}
                        style={{ 
                          padding: '6px 10px', 
                          borderRadius: '4px', 
                          border: 'none', 
                          background: viewMode === 'list' ? '#FFF' : 'transparent',
                          boxShadow: viewMode === 'list' ? '0 1px 3px rgba(0,0,0,0.1)' : 'none',
                          cursor: 'pointer',
                          fontSize: '13px',
                          color: viewMode === 'list' ? 'var(--slate-700)' : 'var(--slate-500)'
                        }}
                        title="List view"
                      >
                        ‚ò∞
                      </button>
                    </div>
                  )}
                </div>
              </div>

              {/* Content */}
              {loading ? (
                <div style={{ textAlign: 'center', padding: '60px 20px', color: 'var(--slate-500)' }}>Loading maps...</div>
              ) : error ? (
                <div style={{ textAlign: 'center', padding: '60px 20px', color: 'var(--error)' }}>{error}</div>
              ) : displayMaps.length === 0 ? (
                <div style={{ textAlign: 'center', padding: '60px 20px', color: 'var(--slate-500)' }}>
                  {activeTab === 'my-maps' ? 'No maps yet. Create your first journey map!' : 'No maps shared with you yet.'}
                </div>
              ) : viewMode === 'list' && !isMobile ? (
                /* List View */
                <div style={{ background: '#FFF', borderRadius: '12px', overflow: 'hidden', border: '1px solid var(--slate-200)' }}>
                  {/* Table Header */}
                  <div style={{ 
                    display: 'grid', 
                    gridTemplateColumns: '1fr 100px 100px 80px 80px 100px 120px',
                    padding: '12px 16px', 
                    background: 'var(--slate-50)', 
                    borderBottom: '1px solid var(--slate-200)',
                    fontSize: '12px',
                    fontWeight: '600',
                    color: 'var(--slate-500)',
                    textTransform: 'uppercase',
                    letterSpacing: '0.5px'
                  }}>
                    <div>Name</div>
                    <div style={{ textAlign: 'right' }}>Time</div>
                    <div style={{ textAlign: 'right' }}>Cost</div>
                    <div style={{ textAlign: 'right' }}>Steps</div>
                    <div style={{ textAlign: 'right' }}>Friction</div>
                    <div style={{ textAlign: 'right' }}>Updated</div>
                    <div style={{ textAlign: 'center' }}>Actions</div>
                  </div>
                  {/* Table Rows */}
                  {displayMaps.map(map => {
                    const metrics = getMapMetrics(map);
                    const isOwner = map.createdBy === profile?.id || map.created_by === profile?.id || true;
                    return (
                      <div 
                        key={map.id}
                        onClick={() => openMap(map.id)}
                        style={{ 
                          display: 'grid', 
                          gridTemplateColumns: '1fr 100px 100px 80px 80px 100px 120px',
                          padding: '14px 16px', 
                          borderBottom: '1px solid var(--slate-100)',
                          alignItems: 'center',
                          cursor: 'pointer',
                          background: '#FFF',
                          transition: 'background 0.15s'
                        }}
                        onMouseEnter={e => { e.currentTarget.style.background = 'var(--slate-50)'; }}
                        onMouseLeave={e => { e.currentTarget.style.background = '#FFF'; }}
                      >
                        <div style={{ display: 'flex', alignItems: 'center', gap: '10px' }}>
                          <span style={{ fontWeight: '500', color: 'var(--slate-800)' }}>
                            {map.favourite && <span style={{ marginRight: '4px' }}>‚≠ê</span>}
                            {map.config?.meta?.title || map.title || 'Untitled'}
                          </span>
                          {map.config?.meta?.description && (
                            <span style={{ fontSize: '12px', color: 'var(--slate-400)' }}>
                              {map.config.meta.description.substring(0, 40)}{map.config.meta.description.length > 40 ? '...' : ''}
                            </span>
                          )}
                        </div>
                        <div style={{ textAlign: 'right', fontSize: '13px', color: 'var(--slate-600)' }}>
                          {metrics?.totalTime ? formatTime(metrics.totalTime) : '-'}
                        </div>
                        <div style={{ textAlign: 'right', fontSize: '13px', color: 'var(--slate-600)' }}>
                          {metrics?.totalCost ? `¬£${Math.round(metrics.totalCost).toLocaleString()}` : '-'}
                        </div>
                        <div style={{ textAlign: 'right', fontSize: '13px', color: 'var(--slate-600)' }}>
                          {metrics?.totalSteps || '-'}
                        </div>
                        <div style={{ textAlign: 'right', fontSize: '13px', color: 'var(--slate-600)' }}>
                          {metrics?.avgFriction ? `${metrics.avgFriction}/5` : '-'}
                        </div>
                        <div style={{ textAlign: 'right', fontSize: '12px', color: 'var(--slate-400)' }}>
                          {map.updated_at ? new Date(map.updated_at).toLocaleDateString('en-GB', { day: '2-digit', month: '2-digit', year: '2-digit' }) : '-'}
                        </div>
                        <div style={{ textAlign: 'center' }} onClick={e => e.stopPropagation()}>
                          <div style={{ display: 'flex', gap: '4px', justifyContent: 'center' }}>
                            <button onClick={(e) => toggleFavourite(map.id, e)} className="btn btn-ghost" style={{ padding: '4px 8px', fontSize: '12px' }} title={map.favourite ? 'Unstar' : 'Star'}>{map.favourite ? '‚≠ê' : '‚òÜ'}</button>
                            <button onClick={() => generateReport(map.id)} className="btn btn-ghost" style={{ padding: '4px 8px', fontSize: '12px' }} title="Report">üìÑ</button>
                            <button onClick={(e) => handleShareFromMenu(map.id, e)} className="btn btn-ghost" style={{ padding: '4px 8px', fontSize: '12px' }} title="Share">üîó</button>
                            <button onClick={(e) => handleDeleteMap(map.id, e)} className="btn btn-ghost" style={{ padding: '4px 8px', fontSize: '12px', color: map.favourite ? 'var(--slate-300)' : 'var(--error)' }} title={map.favourite ? 'Unstar to delete' : 'Delete'} disabled={map.favourite}>üóëÔ∏è</button>
                          </div>
                        </div>
                      </div>
                    );
                  })}
                </div>
              ) : (
                /* Card View */
                <div className="cards-grid">
                  {displayMaps.map(map => {
                    const metrics = getMapMetrics(map);
                    const isOwner = map.createdBy === profile?.id || map.created_by === profile?.id || true;
                    const responseCount = map.responseCount || 0;
                    const isExample = map.config?.isExample || map.config?.meta?.isExample || map.template_source === 'starter-example';
                    const cardColor = map.config?.cardColor || map.config?.meta?.cardColor || 'steel';
                    
                    // Determine header class: favourite trumps custom color, example trumps both if no custom set
                    const getHeaderClass = () => {
                      if (map.favourite) return 'favourite';
                      if (map.config?.cardColor || map.config?.meta?.cardColor) return `color-${cardColor}`;
                      if (isExample) return 'example';
                      return '';
                    };
                    
                    return (
                      <div 
                        key={map.id} 
                        className="card journey-card" 
                        onClick={() => openMap(map.id)}
                        style={{ 
                          cursor: 'pointer',
                          border: '1px solid var(--slate-200)'
                        }}
                      >
                        {/* Colored header with gradient */}
                        <div className={`journey-card-header ${getHeaderClass()}`}>
                          {/* Example badge */}
                          {isExample && (
                            <div className="example-badge">üìò Example</div>
                          )}
                          
                          {/* Header buttons - options and star side by side */}
                          <div className="journey-card-header-buttons" onClick={e => e.stopPropagation()}>
                            <div className="card-options-container">
                              <button 
                                className="journey-card-options"
                                onClick={(e) => handleOptionsClick(map.id, e)}
                                title="Options"
                              >
                                ¬∑¬∑¬∑
                              </button>
                              
                              {/* Dropdown menu */}
                              {openOptionsMenu === map.id && (
                                <div className="card-options-dropdown">
                                  <button className="card-options-item" onClick={(e) => handleShareFromMenu(map.id, e)}>
                                    <span className="card-options-item-icon">‚Üó</span>
                                    Share
                                  </button>
                                  <button className="card-options-item" onClick={(e) => handleCopyLink(map.id, e)}>
                                    <span className="card-options-item-icon">üîó</span>
                                    Copy map link
                                  </button>
                                  <button className="card-options-item" onClick={(e) => handleOpenNewTab(map.id, e)}>
                                    <span className="card-options-item-icon">‚ÜóÔ∏è</span>
                                    Open in new tab
                                  </button>
                                  <div className="card-options-divider"></div>
                                  <button className="card-options-item" onClick={(e) => toggleFavourite(map.id, e)}>
                                    <span className="card-options-item-icon">{map.favourite ? '‚òÖ' : '‚òÜ'}</span>
                                    {map.favourite ? 'Unstar this map' : 'Star this map'}
                                  </button>
                                  <button className="card-options-item" onClick={(e) => handleRename(map.id, e)}>
                                    <span className="card-options-item-icon">‚úèÔ∏è</span>
                                    Edit Details
                                  </button>
                                  <div className="card-options-divider"></div>
                                  <button className="card-options-item" onClick={(e) => handleDownloadBackup(map.id, e)}>
                                    <span className="card-options-item-icon">‚¨áÔ∏è</span>
                                    Download map backup
                                  </button>
                                  <div className="card-options-divider"></div>
                                  <button 
                                    className={`card-options-item ${map.favourite ? 'disabled' : 'danger'}`}
                                    onClick={(e) => !map.favourite && handleDeleteMap(map.id, e)}
                                    title={map.favourite ? 'Unstar to delete' : ''}
                                  >
                                    <span className="card-options-item-icon">üóëÔ∏è</span>
                                    {map.favourite ? 'Unstar to delete' : 'Delete'}
                                  </button>
                                </div>
                              )}
                            </div>
                            
                            <button 
                              className={`journey-card-star ${map.favourite ? 'starred' : ''}`}
                              onClick={(e) => toggleFavourite(map.id, e)}
                              title={map.favourite ? 'Remove from favourites' : 'Add to favourites'}
                            >
                              {map.favourite ? '‚≠ê' : (
                                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="rgba(255,255,255,0.8)" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
                                  <polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"></polygon>
                                </svg>
                              )}
                            </button>
                          </div>
                          
                          <h3 className="journey-card-title">
                            {mapConfigs[map.id]?.meta?.title || map.title}
                          </h3>
                        </div>
                        
                        {/* Card body */}
                        <div className="journey-card-body">
                          <p className="journey-card-desc">{mapConfigs[map.id]?.meta?.description || map.description || 'No description'}</p>
                          
                          {metrics && (
                            <div className="journey-card-metrics">
                              <div className="metric" title="Total time">
                                <span>‚è±Ô∏è</span>
                                <span className="metric-value">{formatTime(metrics.totalTime)}</span>
                              </div>
                              <span className="metric-dot">¬∑</span>
                              <div className="metric" title="Stages / Steps">
                                <span>üìã</span>
                                <span>{metrics.stageCount} / {metrics.totalSteps}</span>
                              </div>
                              {metrics.avgFriction && (
                                <>
                                  <span className="metric-dot">¬∑</span>
                                  <div className="metric" title="Avg friction">
                                    <span>{metrics.avgFriction >= 4 ? 'üò∞' : metrics.avgFriction >= 3 ? 'üòê' : 'üôÇ'}</span>
                                    <span>{metrics.avgFriction}/5</span>
                                  </div>
                                </>
                              )}
                              {metrics.totalPainPoints > 0 && (
                                <>
                                  <span className="metric-dot">¬∑</span>
                                  <div className="metric" title="Pain points">
                                    <span>‚ö†Ô∏è</span>
                                    <span style={{ color: 'var(--error)' }}>{metrics.totalPainPoints}</span>
                                  </div>
                                </>
                              )}
                              {metrics.highImprovements > 0 && (
                                <>
                                  <span className="metric-dot">¬∑</span>
                                  <div className="metric" title="High improvement opps">
                                    <span>üéØ</span>
                                    <span style={{ color: 'var(--success)' }}>{metrics.highImprovements}</span>
                                  </div>
                                </>
                              )}
                              {metrics.totalCost !== null && (
                                <>
                                  <span className="metric-dot">¬∑</span>
                                  <div className="metric" title="Cost per journey">
                                    <span>üí∑</span>
                                    <span className="metric-value">{formatCurrency(metrics.totalCost)}</span>
                                  </div>
                                </>
                              )}
                            </div>
                          )}
                          
                          <div className="journey-card-footer">
                            <span className="journey-card-date">
                              Updated {formatDate(map.updatedAt)}
                              {map.sharedWith?.length > 0 && <span> ¬∑ üë• {map.sharedWith.length}</span>}
                            </span>
                            
                            {/* Action buttons */}
                            <div className="journey-card-actions" onClick={e => e.stopPropagation()}>
                              <button onClick={() => generateReport(map.id)} className="btn btn-ghost" title="Generate Report">
                                üìÑ Report
                              </button>
                              <button 
                                onClick={() => window.location.href = `responses.html?map=${map.id}`} 
                                className="btn btn-ghost"
                                title="View Responses"
                                style={{ position: 'relative' }}
                              >
                                üìä Responses
                                {responseCount > 0 && (
                                  <span style={{
                                    position: 'absolute',
                                    top: '-4px',
                                    right: '-4px',
                                    background: 'var(--error)',
                                    color: '#FFF',
                                    fontSize: '10px',
                                    fontWeight: '600',
                                    padding: '2px 5px',
                                    borderRadius: '10px',
                                    minWidth: '16px',
                                    textAlign: 'center'
                                  }}>
                                    {responseCount}
                                  </span>
                                )}
                              </button>
                            </div>
                          </div>
                        </div>{/* end journey-card-body */}
                      </div>
                    );
                  })}
                </div>
              )}
            </div>
          </main>

          {/* Footer */}
          <footer className="footer">
            <div className="footer-inner">
              <div className="footer-brand">
                <img src="https://steveyoung74.github.io/journeymaps/logo_light.png" alt="Fathom" className="footer-logo" />
                <span className="footer-version">v9.8.0</span>
              </div>
              <div className="footer-copy">¬© 2025 Fathom ¬∑ Journey intelligence for modern operations</div>
            </div>
          </footer>

          {/* Create Modal */}
          {showCreateModal && (
            <CreateMapModal 
              maps={maps}
              onClose={() => setShowCreateModal(false)}
              onCreated={() => { setShowCreateModal(false); fetchMaps(); }}
            />
          )}

          {/* Share Modal */}
          {showShareModal && (
            <ShareModal
              mapId={showShareModal}
              maps={maps}
              onClose={() => setShowShareModal(null)}
              onUpdated={fetchMaps}
            />
          )}
          
          {/* Rename Modal */}
          {showRenameModal && (
            <RenameModal
              mapId={showRenameModal}
              maps={maps}
              mapConfigs={mapConfigs}
              onClose={() => setShowRenameModal(null)}
              onSaved={fetchMaps}
            />
          )}
        </div>
      );
    }

    // ============================================
    // RENAME MODAL
    // ============================================
    // Card colour options
    const CARD_COLORS = [
      { id: 'steel', label: 'Steel Blue', class: 'color-swatch-steel' },
      { id: 'navy', label: 'Navy', class: 'color-swatch-navy' },
      { id: 'teal', label: 'Teal', class: 'color-swatch-teal' },
      { id: 'amber', label: 'Amber', class: 'color-swatch-amber' },
      { id: 'slate', label: 'Slate', class: 'color-swatch-slate' },
      { id: 'rose', label: 'Rose', class: 'color-swatch-rose' },
      { id: 'indigo', label: 'Indigo', class: 'color-swatch-indigo' },
      { id: 'copper', label: 'Copper', class: 'color-swatch-copper' },
    ];

    function RenameModal({ mapId, maps, mapConfigs, onClose, onSaved }) {
      const map = maps.find(m => m.id === mapId);
      const config = map?.config || mapConfigs[mapId] || {};
      const [title, setTitle] = useState(config?.meta?.title || map?.title || '');
      const [description, setDescription] = useState(config?.meta?.description || map?.description || '');
      const [cardColor, setCardColor] = useState(config?.cardColor || config?.meta?.cardColor || 'steel');
      const [saving, setSaving] = useState(false);
      const [error, setError] = useState('');
      
      const handleSave = async () => {
        if (!title.trim()) {
          setError('Title is required');
          return;
        }
        
        setSaving(true);
        setError('');
        
        try {
          const updatedConfig = {
            ...config,
            cardColor: cardColor,
            meta: {
              ...config.meta,
              title: title.trim(),
              description: description.trim(),
              cardColor: cardColor
            }
          };
          
          await supabase
            .from('journey_maps')
            .update({ 
              title: title.trim(),
              description: description.trim(),
              config: updatedConfig 
            })
            .eq('id', mapId);
          
          onSaved();
          onClose();
        } catch (err) {
          console.error('Failed to save map details:', err);
          setError('Failed to save. Please try again.');
        } finally {
          setSaving(false);
        }
      };
      
      return (
        <div className="modal-overlay" onClick={onClose}>
          <div className="modal" onClick={e => e.stopPropagation()} style={{ maxWidth: '480px' }}>
            <div className="modal-content">
              <div className="modal-header">
                <h2 className="modal-title">Edit Details</h2>
                <button className="modal-close" onClick={onClose}>√ó</button>
              </div>
              
              {error && (
                <div style={{ 
                  padding: '10px 14px', 
                  background: 'var(--error-light)', 
                  color: 'var(--error)', 
                  borderRadius: '6px', 
                  marginBottom: '16px',
                  fontSize: '13px'
                }}>
                  {error}
                </div>
              )}
              
              <div style={{ marginBottom: '16px' }}>
                <label className="label">Title</label>
                <input
                  type="text"
                  className="input"
                  value={title}
                  onChange={(e) => setTitle(e.target.value)}
                  placeholder="Journey map title"
                  autoFocus
                />
              </div>
              
              <div style={{ marginBottom: '20px' }}>
                <label className="label">Description</label>
                <textarea
                  className="input"
                  value={description}
                  onChange={(e) => setDescription(e.target.value)}
                  placeholder="Brief description of this journey map"
                  rows={2}
                  style={{ resize: 'vertical' }}
                />
              </div>
              
              <div style={{ marginBottom: '24px' }}>
                <label className="label">Card Colour</label>
                <div className="color-picker">
                  {CARD_COLORS.map(color => (
                    <div
                      key={color.id}
                      className={`color-swatch ${color.class} ${cardColor === color.id ? 'selected' : ''}`}
                      onClick={() => setCardColor(color.id)}
                      title={color.label}
                    />
                  ))}
                </div>
                
                {/* Preview */}
                <div style={{ marginTop: '16px' }}>
                  <label className="label" style={{ fontSize: '11px', color: 'var(--slate-500)' }}>Preview</label>
                  <div style={{ 
                    borderRadius: '8px', 
                    overflow: 'hidden', 
                    boxShadow: '0 2px 8px rgba(0,0,0,0.1)',
                    maxWidth: '200px'
                  }}>
                    <div className={`journey-card-header color-${cardColor}`} style={{ padding: '12px 16px', borderRadius: '8px 8px 0 0' }}>
                      <div style={{ color: 'white', fontSize: '13px', fontWeight: '600' }}>{title || 'Journey Title'}</div>
                    </div>
                    <div style={{ padding: '8px 16px', background: 'white', fontSize: '11px', color: 'var(--slate-500)' }}>
                      Card preview
                    </div>
                  </div>
                </div>
              </div>
              
              <div style={{ display: 'flex', gap: '12px', justifyContent: 'flex-end' }}>
                <button onClick={onClose} className="btn btn-secondary">Cancel</button>
                <button onClick={handleSave} className="btn btn-primary" disabled={saving || !title.trim()}>
                  {saving ? 'Saving...' : 'Save Changes'}
                </button>
              </div>
            </div>
          </div>
        </div>
      );
    }

    // Token Form
    function TokenForm({ onSave, onCancel }) {
      const [token, setToken] = useState('');
      return (
        <div>
          <div style={{ marginBottom: '16px' }}>
            <label className="label">GitHub Personal Access Token</label>
            <input type="password" className="input" value={token} onChange={e => setToken(e.target.value)} placeholder="ghp_xxxxxxxxxxxx" />
            <p className="text-muted text-small" style={{ marginTop: '6px' }}>Create a token at github.com/settings/tokens with repo access.</p>
          </div>
          <div style={{ display: 'flex', gap: '8px' }}>
            <button onClick={() => onSave(token)} className="btn btn-primary" disabled={!token.trim()}>Save Token</button>
            <button onClick={onCancel} className="btn btn-secondary">Cancel</button>
          </div>
        </div>
      );
    }

    // ============================================
    // JOURNEY TEMPLATES
    // ============================================
    const JOURNEY_TEMPLATES = [
      {
        id: 'blank',
        name: 'Blank Canvas',
        description: 'Start from scratch with an empty journey map',
        icon: 'üìÑ',
        industry: 'Any',
        stageCount: 1,
        config: {
          title: 'New Journey Map',
          currency: '¬£',
          stages: [
            { id: 'stage-1', name: 'Stage 1', steps: [{ id: 'step-1-1', name: 'First Step', time: 30, personaId: null, friction: 'none', notes: '' }] }
          ],
          personas: [
            { id: 'customer', name: 'Customer', salary: 0, isExternal: true },
            { id: 'staff', name: 'Staff Member', salary: 35000, isExternal: false }
          ],
          funnelConfig: { enabled: false, startVolume: 100, stages: {} }
        }
      },
      {
        id: 'financial_client_onboarding',
        name: 'Client Onboarding',
        description: 'Wealth management with KYC & compliance',
        icon: 'üè¶',
        industry: 'Financial Services',
        stageCount: 6,
        config: {
          title: 'Client Onboarding Journey',
          currency: '¬£',
          stages: [
            { id: 'stage-discovery', name: 'Discovery & Qualification', steps: [
              { id: 'step-1-1', name: 'Initial Enquiry Received', time: 15, personaId: 'administrator', friction: 'none', notes: 'Via web form, phone, or referral' },
              { id: 'step-1-2', name: 'Qualification Call', time: 45, personaId: 'advisor', friction: 'low', notes: 'Assess fit and requirements' },
              { id: 'step-1-3', name: 'Send Welcome Pack', time: 20, personaId: 'administrator', friction: 'none', notes: '' },
              { id: 'step-1-4', name: 'Schedule Discovery Meeting', time: 15, personaId: 'administrator', friction: 'none', notes: '' }
            ]},
            { id: 'stage-kyc', name: 'KYC & Compliance', steps: [
              { id: 'step-2-1', name: 'Collect ID Documents', time: 30, personaId: 'client', friction: 'medium', notes: 'Passport, proof of address' },
              { id: 'step-2-2', name: 'Verify Identity (AML Check)', time: 45, personaId: 'compliance', friction: 'low', notes: '' },
              { id: 'step-2-3', name: 'Source of Wealth Declaration', time: 60, personaId: 'client', friction: 'high', notes: 'Often requires chasing' },
              { id: 'step-2-4', name: 'Compliance Review & Sign-off', time: 30, personaId: 'compliance', friction: 'medium', notes: '' },
              { id: 'step-2-5', name: 'Risk Profiling Questionnaire', time: 25, personaId: 'client', friction: 'low', notes: '' }
            ]},
            { id: 'stage-factfind', name: 'Fact Find & Analysis', steps: [
              { id: 'step-3-1', name: 'Discovery Meeting', time: 90, personaId: 'advisor', friction: 'none', notes: '' },
              { id: 'step-3-2', name: 'Gather Financial Information', time: 120, personaId: 'client', friction: 'high', notes: '' },
              { id: 'step-3-3', name: 'Input Data to Planning System', time: 60, personaId: 'paraplanner', friction: 'medium', notes: '' },
              { id: 'step-3-4', name: 'Cash Flow Modelling', time: 120, personaId: 'paraplanner', friction: 'low', notes: '' },
              { id: 'step-3-5', name: 'Research & Provider Selection', time: 180, personaId: 'paraplanner', friction: 'medium', notes: '' }
            ]},
            { id: 'stage-advice', name: 'Advice & Recommendation', steps: [
              { id: 'step-4-1', name: 'Draft Suitability Report', time: 240, personaId: 'paraplanner', friction: 'medium', notes: '' },
              { id: 'step-4-2', name: 'Advisor Review', time: 60, personaId: 'advisor', friction: 'low', notes: '' },
              { id: 'step-4-3', name: 'Compliance Review', time: 45, personaId: 'compliance', friction: 'medium', notes: '' },
              { id: 'step-4-4', name: 'Recommendation Meeting', time: 90, personaId: 'advisor', friction: 'none', notes: '' }
            ]},
            { id: 'stage-implementation', name: 'Implementation', steps: [
              { id: 'step-5-1', name: 'Prepare Application Forms', time: 45, personaId: 'administrator', friction: 'medium', notes: '' },
              { id: 'step-5-2', name: 'Client Signatures', time: 30, personaId: 'client', friction: 'medium', notes: '' },
              { id: 'step-5-3', name: 'Submit Applications', time: 30, personaId: 'administrator', friction: 'low', notes: '' },
              { id: 'step-5-4', name: 'Chase Providers', time: 60, personaId: 'administrator', friction: 'high', notes: '' }
            ]},
            { id: 'stage-handover', name: 'Handover & Review', steps: [
              { id: 'step-6-1', name: 'Welcome to Service Call', time: 30, personaId: 'advisor', friction: 'none', notes: '' },
              { id: 'step-6-2', name: 'Portal Setup', time: 20, personaId: 'administrator', friction: 'low', notes: '' },
              { id: 'step-6-3', name: 'Schedule Annual Review', time: 10, personaId: 'administrator', friction: 'none', notes: '' }
            ]}
          ],
          personas: [
            { id: 'client', name: 'Client', salary: 0, isExternal: true },
            { id: 'advisor', name: 'Financial Advisor', salary: 75000, isExternal: false },
            { id: 'paraplanner', name: 'Paraplanner', salary: 45000, isExternal: false },
            { id: 'administrator', name: 'Administrator', salary: 28000, isExternal: false },
            { id: 'compliance', name: 'Compliance Officer', salary: 55000, isExternal: false }
          ],
          funnelConfig: { enabled: true, startVolume: 100, stages: { 'stage-discovery': { dropOff: 25 }, 'stage-kyc': { dropOff: 10 }, 'stage-factfind': { dropOff: 5 }, 'stage-advice': { dropOff: 10 }, 'stage-implementation': { dropOff: 5 }, 'stage-handover': { dropOff: 0 } }}
        }
      },
      { id: 'mortgage_application', name: 'Mortgage Application', description: 'Enquiry to completion, 30-60 day cycle', icon: 'üè†', industry: 'Financial Services', stageCount: 5, config: { title: 'Mortgage Application Journey', currency: '¬£', stages: [{ id: 'stage-1', name: 'Initial Enquiry', steps: [{ id: 's1-1', name: 'Customer Enquiry', time: 15, personaId: 'customer', friction: 'none', notes: '' }, { id: 's1-2', name: 'Initial Assessment', time: 30, personaId: 'advisor', friction: 'low', notes: '' }]}, { id: 'stage-2', name: 'Application', steps: [{ id: 's2-1', name: 'Full Application', time: 60, personaId: 'customer', friction: 'medium', notes: '' }, { id: 's2-2', name: 'Document Collection', time: 90, personaId: 'admin', friction: 'high', notes: '' }]}, { id: 'stage-3', name: 'Underwriting', steps: [{ id: 's3-1', name: 'Credit Check', time: 30, personaId: 'underwriter', friction: 'low', notes: '' }, { id: 's3-2', name: 'Valuation', time: 120, personaId: 'valuer', friction: 'medium', notes: '' }]}, { id: 'stage-4', name: 'Offer', steps: [{ id: 's4-1', name: 'Mortgage Offer', time: 45, personaId: 'underwriter', friction: 'low', notes: '' }, { id: 's4-2', name: 'Customer Acceptance', time: 30, personaId: 'customer', friction: 'low', notes: '' }]}, { id: 'stage-5', name: 'Completion', steps: [{ id: 's5-1', name: 'Legal Completion', time: 60, personaId: 'solicitor', friction: 'medium', notes: '' }, { id: 's5-2', name: 'Funds Transfer', time: 30, personaId: 'admin', friction: 'low', notes: '' }]}], personas: [{ id: 'customer', name: 'Customer', salary: 0, isExternal: true }, { id: 'advisor', name: 'Mortgage Advisor', salary: 45000, isExternal: false }, { id: 'admin', name: 'Administrator', salary: 28000, isExternal: false }, { id: 'underwriter', name: 'Underwriter', salary: 42000, isExternal: false }, { id: 'valuer', name: 'Valuer', salary: 0, isExternal: true }, { id: 'solicitor', name: 'Solicitor', salary: 0, isExternal: true }], funnelConfig: { enabled: true, startVolume: 100, stages: {} }}},
      { id: 'insurance_claim', name: 'Insurance Claim', description: 'FNOL to settlement with fraud checks', icon: 'üõ°Ô∏è', industry: 'Financial Services', stageCount: 5, config: { title: 'Insurance Claim Journey', currency: '¬£', stages: [{ id: 'stage-1', name: 'FNOL', steps: [{ id: 's1-1', name: 'First Notice of Loss', time: 20, personaId: 'customer', friction: 'medium', notes: '' }, { id: 's1-2', name: 'Claim Registration', time: 15, personaId: 'handler', friction: 'low', notes: '' }]}, { id: 'stage-2', name: 'Assessment', steps: [{ id: 's2-1', name: 'Document Review', time: 45, personaId: 'handler', friction: 'low', notes: '' }, { id: 's2-2', name: 'Fraud Screening', time: 30, personaId: 'fraud', friction: 'low', notes: '' }]}, { id: 'stage-3', name: 'Investigation', steps: [{ id: 's3-1', name: 'Loss Adjuster Visit', time: 120, personaId: 'adjuster', friction: 'medium', notes: '' }, { id: 's3-2', name: 'Report Compilation', time: 90, personaId: 'adjuster', friction: 'low', notes: '' }]}, { id: 'stage-4', name: 'Decision', steps: [{ id: 's4-1', name: 'Claim Decision', time: 30, personaId: 'handler', friction: 'low', notes: '' }, { id: 's4-2', name: 'Customer Notification', time: 15, personaId: 'handler', friction: 'low', notes: '' }]}, { id: 'stage-5', name: 'Settlement', steps: [{ id: 's5-1', name: 'Payment Processing', time: 30, personaId: 'finance', friction: 'low', notes: '' }, { id: 's5-2', name: 'Claim Closure', time: 15, personaId: 'handler', friction: 'none', notes: '' }]}], personas: [{ id: 'customer', name: 'Policyholder', salary: 0, isExternal: true }, { id: 'handler', name: 'Claims Handler', salary: 32000, isExternal: false }, { id: 'fraud', name: 'Fraud Analyst', salary: 38000, isExternal: false }, { id: 'adjuster', name: 'Loss Adjuster', salary: 0, isExternal: true }, { id: 'finance', name: 'Finance', salary: 35000, isExternal: false }], funnelConfig: { enabled: true, startVolume: 100, stages: {} }}},
      { id: 'bank_account', name: 'Bank Account Opening', description: 'Personal or business with AML screening', icon: 'üí≥', industry: 'Financial Services', stageCount: 4, config: { title: 'Bank Account Opening Journey', currency: '¬£', stages: [{ id: 'stage-1', name: 'Application', steps: [{ id: 's1-1', name: 'Online Application', time: 20, personaId: 'customer', friction: 'low', notes: '' }, { id: 's1-2', name: 'ID Verification', time: 15, personaId: 'customer', friction: 'medium', notes: '' }]}, { id: 'stage-2', name: 'KYC', steps: [{ id: 's2-1', name: 'AML Screening', time: 30, personaId: 'compliance', friction: 'low', notes: '' }, { id: 's2-2', name: 'Risk Assessment', time: 20, personaId: 'compliance', friction: 'low', notes: '' }]}, { id: 'stage-3', name: 'Account Setup', steps: [{ id: 's3-1', name: 'Account Creation', time: 15, personaId: 'ops', friction: 'none', notes: '' }, { id: 's3-2', name: 'Card Issuance', time: 10, personaId: 'ops', friction: 'none', notes: '' }]}, { id: 'stage-4', name: 'Activation', steps: [{ id: 's4-1', name: 'Welcome Pack', time: 10, personaId: 'ops', friction: 'none', notes: '' }, { id: 's4-2', name: 'First Login', time: 15, personaId: 'customer', friction: 'low', notes: '' }]}], personas: [{ id: 'customer', name: 'Customer', salary: 0, isExternal: true }, { id: 'compliance', name: 'Compliance', salary: 40000, isExternal: false }, { id: 'ops', name: 'Operations', salary: 28000, isExternal: false }], funnelConfig: { enabled: true, startVolume: 100, stages: {} }}},
      { id: 'personal_loan', name: 'Personal Loan', description: 'Application to disbursement', icon: 'üí∑', industry: 'Financial Services', stageCount: 4, config: { title: 'Personal Loan Journey', currency: '¬£', stages: [{ id: 'stage-1', name: 'Application', steps: [{ id: 's1-1', name: 'Loan Application', time: 20, personaId: 'customer', friction: 'low', notes: '' }, { id: 's1-2', name: 'Income Verification', time: 30, personaId: 'customer', friction: 'medium', notes: '' }]}, { id: 'stage-2', name: 'Assessment', steps: [{ id: 's2-1', name: 'Credit Check', time: 15, personaId: 'underwriter', friction: 'low', notes: '' }, { id: 's2-2', name: 'Affordability Check', time: 30, personaId: 'underwriter', friction: 'low', notes: '' }]}, { id: 'stage-3', name: 'Decision', steps: [{ id: 's3-1', name: 'Loan Decision', time: 20, personaId: 'underwriter', friction: 'low', notes: '' }, { id: 's3-2', name: 'Offer Letter', time: 15, personaId: 'ops', friction: 'none', notes: '' }]}, { id: 'stage-4', name: 'Disbursement', steps: [{ id: 's4-1', name: 'Agreement Signing', time: 15, personaId: 'customer', friction: 'low', notes: '' }, { id: 's4-2', name: 'Funds Transfer', time: 30, personaId: 'ops', friction: 'none', notes: '' }]}], personas: [{ id: 'customer', name: 'Customer', salary: 0, isExternal: true }, { id: 'underwriter', name: 'Underwriter', salary: 38000, isExternal: false }, { id: 'ops', name: 'Operations', salary: 28000, isExternal: false }], funnelConfig: { enabled: true, startVolume: 100, stages: {} }}},
      { id: 'patient_registration', name: 'Patient Registration & Admission', description: 'Front door, insurance verification, consent', icon: 'üè•', industry: 'Healthcare', stageCount: 4, config: { title: 'Patient Registration Journey', currency: '¬£', stages: [{ id: 'stage-1', name: 'Registration', steps: [{ id: 's1-1', name: 'Patient Arrival', time: 10, personaId: 'patient', friction: 'low', notes: '' }, { id: 's1-2', name: 'Demographics Collection', time: 15, personaId: 'receptionist', friction: 'low', notes: '' }]}, { id: 'stage-2', name: 'Verification', steps: [{ id: 's2-1', name: 'Insurance Verification', time: 20, personaId: 'admin', friction: 'medium', notes: '' }, { id: 's2-2', name: 'ID Check', time: 10, personaId: 'receptionist', friction: 'low', notes: '' }]}, { id: 'stage-3', name: 'Consent', steps: [{ id: 's3-1', name: 'Consent Forms', time: 15, personaId: 'patient', friction: 'medium', notes: '' }, { id: 's3-2', name: 'GDPR Acknowledgement', time: 5, personaId: 'patient', friction: 'low', notes: '' }]}, { id: 'stage-4', name: 'Admission', steps: [{ id: 's4-1', name: 'Triage', time: 20, personaId: 'nurse', friction: 'low', notes: '' }, { id: 's4-2', name: 'Ward Allocation', time: 15, personaId: 'admin', friction: 'low', notes: '' }]}], personas: [{ id: 'patient', name: 'Patient', salary: 0, isExternal: true }, { id: 'receptionist', name: 'Receptionist', salary: 24000, isExternal: false }, { id: 'admin', name: 'Admin', salary: 28000, isExternal: false }, { id: 'nurse', name: 'Nurse', salary: 35000, isExternal: false }], funnelConfig: { enabled: true, startVolume: 100, stages: {} }}},
      { id: 'patient_referral', name: 'Patient Referral', description: 'NHS/private pathway tracking', icon: 'üìã', industry: 'Healthcare', stageCount: 4, config: { title: 'Patient Referral Journey', currency: '¬£', stages: [{ id: 'stage-1', name: 'Referral', steps: [{ id: 's1-1', name: 'GP Consultation', time: 30, personaId: 'gp', friction: 'low', notes: '' }, { id: 's1-2', name: 'Referral Submission', time: 15, personaId: 'gp', friction: 'low', notes: '' }]}, { id: 'stage-2', name: 'Triage', steps: [{ id: 's2-1', name: 'Referral Review', time: 20, personaId: 'consultant', friction: 'low', notes: '' }, { id: 's2-2', name: 'Priority Assignment', time: 10, personaId: 'admin', friction: 'low', notes: '' }]}, { id: 'stage-3', name: 'Scheduling', steps: [{ id: 's3-1', name: 'Appointment Booking', time: 15, personaId: 'admin', friction: 'medium', notes: '' }, { id: 's3-2', name: 'Patient Notification', time: 10, personaId: 'admin', friction: 'low', notes: '' }]}, { id: 'stage-4', name: 'Consultation', steps: [{ id: 's4-1', name: 'Specialist Appointment', time: 45, personaId: 'consultant', friction: 'low', notes: '' }, { id: 's4-2', name: 'Treatment Plan', time: 30, personaId: 'consultant', friction: 'low', notes: '' }]}], personas: [{ id: 'patient', name: 'Patient', salary: 0, isExternal: true }, { id: 'gp', name: 'GP', salary: 0, isExternal: true }, { id: 'consultant', name: 'Consultant', salary: 100000, isExternal: false }, { id: 'admin', name: 'Admin', salary: 26000, isExternal: false }], funnelConfig: { enabled: true, startVolume: 100, stages: {} }}},
      { id: 'employee_onboarding', name: 'Employee Onboarding', description: 'Offer acceptance to full productivity', icon: 'üëã', industry: 'HR / People Operations', stageCount: 6, config: { title: 'Employee Onboarding Journey', currency: '¬£', stages: [{ id: 'stage-1', name: 'Pre-boarding', steps: [{ id: 's1-1', name: 'Send Offer Letter', time: 30, personaId: 'hr', friction: 'none', notes: '' }, { id: 's1-2', name: 'Contract Signed', time: 15, personaId: 'new-hire', friction: 'low', notes: '' }, { id: 's1-3', name: 'Right to Work Check', time: 30, personaId: 'hr', friction: 'medium', notes: '' }]}, { id: 'stage-2', name: 'IT Setup', steps: [{ id: 's2-1', name: 'Create Accounts', time: 45, personaId: 'it', friction: 'low', notes: '' }, { id: 's2-2', name: 'Provision Equipment', time: 60, personaId: 'it', friction: 'medium', notes: '' }]}, { id: 'stage-3', name: 'First Day', steps: [{ id: 's3-1', name: 'Welcome & Tour', time: 45, personaId: 'hr', friction: 'none', notes: '' }, { id: 's3-2', name: 'IT Handover', time: 30, personaId: 'it', friction: 'low', notes: '' }, { id: 's3-3', name: 'Team Introductions', time: 30, personaId: 'manager', friction: 'none', notes: '' }]}, { id: 'stage-4', name: 'First Week', steps: [{ id: 's4-1', name: 'Company Induction', time: 120, personaId: 'hr', friction: 'low', notes: '' }, { id: 's4-2', name: 'Role Training', time: 180, personaId: 'manager', friction: 'low', notes: '' }]}, { id: 'stage-5', name: 'First Month', steps: [{ id: 's5-1', name: 'Compliance Training', time: 240, personaId: 'new-hire', friction: 'medium', notes: '' }, { id: 's5-2', name: '30-Day Review', time: 45, personaId: 'manager', friction: 'low', notes: '' }]}, { id: 'stage-6', name: 'Probation', steps: [{ id: 's6-1', name: '90-Day Review', time: 60, personaId: 'manager', friction: 'low', notes: '' }, { id: 's6-2', name: 'Probation Sign-off', time: 30, personaId: 'hr', friction: 'low', notes: '' }]}], personas: [{ id: 'new-hire', name: 'New Hire', salary: 40000, isExternal: false }, { id: 'manager', name: 'Manager', salary: 65000, isExternal: false }, { id: 'hr', name: 'HR', salary: 32000, isExternal: false }, { id: 'it', name: 'IT', salary: 35000, isExternal: false }], funnelConfig: { enabled: true, startVolume: 50, stages: {} }}},
      { id: 'recruitment', name: 'Recruitment & Hiring', description: 'Requisition to offer acceptance', icon: 'üéØ', industry: 'HR / People Operations', stageCount: 5, config: { title: 'Recruitment Journey', currency: '¬£', stages: [{ id: 'stage-1', name: 'Requisition', steps: [{ id: 's1-1', name: 'Hiring Need', time: 30, personaId: 'manager', friction: 'none', notes: '' }, { id: 's1-2', name: 'Job Description', time: 60, personaId: 'recruiter', friction: 'low', notes: '' }]}, { id: 'stage-2', name: 'Sourcing', steps: [{ id: 's2-1', name: 'Post to Job Boards', time: 30, personaId: 'recruiter', friction: 'none', notes: '' }, { id: 's2-2', name: 'Direct Sourcing', time: 180, personaId: 'recruiter', friction: 'medium', notes: '' }]}, { id: 'stage-3', name: 'Screening', steps: [{ id: 's3-1', name: 'CV Review', time: 120, personaId: 'recruiter', friction: 'medium', notes: '' }, { id: 's3-2', name: 'Phone Screens', time: 180, personaId: 'recruiter', friction: 'low', notes: '' }]}, { id: 'stage-4', name: 'Interviews', steps: [{ id: 's4-1', name: 'First Round', time: 60, personaId: 'manager', friction: 'low', notes: '' }, { id: 's4-2', name: 'Final Round', time: 90, personaId: 'manager', friction: 'low', notes: '' }]}, { id: 'stage-5', name: 'Offer', steps: [{ id: 's5-1', name: 'References', time: 60, personaId: 'recruiter', friction: 'medium', notes: '' }, { id: 's5-2', name: 'Offer & Negotiation', time: 45, personaId: 'recruiter', friction: 'medium', notes: '' }]}], personas: [{ id: 'candidate', name: 'Candidate', salary: 0, isExternal: true }, { id: 'manager', name: 'Hiring Manager', salary: 65000, isExternal: false }, { id: 'recruiter', name: 'Recruiter', salary: 38000, isExternal: false }], funnelConfig: { enabled: true, startVolume: 150, stages: {} }}},
      { id: 'employee_offboarding', name: 'Employee Offboarding', description: 'Knowledge transfer, access revocation, exit', icon: 'üëã', industry: 'HR / People Operations', stageCount: 4, config: { title: 'Employee Offboarding Journey', currency: '¬£', stages: [{ id: 'stage-1', name: 'Resignation', steps: [{ id: 's1-1', name: 'Resignation Received', time: 15, personaId: 'manager', friction: 'none', notes: '' }, { id: 's1-2', name: 'HR Notification', time: 10, personaId: 'hr', friction: 'none', notes: '' }]}, { id: 'stage-2', name: 'Knowledge Transfer', steps: [{ id: 's2-1', name: 'Documentation', time: 120, personaId: 'leaver', friction: 'medium', notes: '' }, { id: 's2-2', name: 'Handover Meetings', time: 90, personaId: 'leaver', friction: 'low', notes: '' }]}, { id: 'stage-3', name: 'Access Revocation', steps: [{ id: 's3-1', name: 'System Access Removal', time: 30, personaId: 'it', friction: 'low', notes: '' }, { id: 's3-2', name: 'Equipment Return', time: 30, personaId: 'leaver', friction: 'low', notes: '' }]}, { id: 'stage-4', name: 'Exit', steps: [{ id: 's4-1', name: 'Exit Interview', time: 45, personaId: 'hr', friction: 'low', notes: '' }, { id: 's4-2', name: 'Final Payroll', time: 30, personaId: 'hr', friction: 'low', notes: '' }]}], personas: [{ id: 'leaver', name: 'Departing Employee', salary: 45000, isExternal: false }, { id: 'manager', name: 'Manager', salary: 60000, isExternal: false }, { id: 'hr', name: 'HR', salary: 32000, isExternal: false }, { id: 'it', name: 'IT', salary: 35000, isExternal: false }], funnelConfig: { enabled: false, startVolume: 100, stages: {} }}},
      { id: 'property_purchase', name: 'Property Purchase', description: 'Conveyancing from offer to completion', icon: 'üè°', industry: 'Property & Real Estate', stageCount: 5, config: { title: 'Property Purchase Journey', currency: '¬£', stages: [{ id: 'stage-1', name: 'Offer', steps: [{ id: 's1-1', name: 'Offer Accepted', time: 15, personaId: 'buyer', friction: 'none', notes: '' }, { id: 's1-2', name: 'Instruct Solicitor', time: 30, personaId: 'buyer', friction: 'low', notes: '' }]}, { id: 'stage-2', name: 'Searches', steps: [{ id: 's2-1', name: 'Local Authority Search', time: 60, personaId: 'solicitor', friction: 'low', notes: '' }, { id: 's2-2', name: 'Environmental Search', time: 45, personaId: 'solicitor', friction: 'low', notes: '' }]}, { id: 'stage-3', name: 'Survey', steps: [{ id: 's3-1', name: 'Survey Booked', time: 30, personaId: 'buyer', friction: 'low', notes: '' }, { id: 's3-2', name: 'Survey Report', time: 120, personaId: 'surveyor', friction: 'medium', notes: '' }]}, { id: 'stage-4', name: 'Exchange', steps: [{ id: 's4-1', name: 'Contract Review', time: 60, personaId: 'solicitor', friction: 'medium', notes: '' }, { id: 's4-2', name: 'Exchange of Contracts', time: 30, personaId: 'solicitor', friction: 'low', notes: '' }]}, { id: 'stage-5', name: 'Completion', steps: [{ id: 's5-1', name: 'Final Checks', time: 30, personaId: 'solicitor', friction: 'low', notes: '' }, { id: 's5-2', name: 'Key Handover', time: 30, personaId: 'agent', friction: 'none', notes: '' }]}], personas: [{ id: 'buyer', name: 'Buyer', salary: 0, isExternal: true }, { id: 'solicitor', name: 'Solicitor', salary: 0, isExternal: true }, { id: 'surveyor', name: 'Surveyor', salary: 0, isExternal: true }, { id: 'agent', name: 'Estate Agent', salary: 0, isExternal: true }], funnelConfig: { enabled: true, startVolume: 100, stages: {} }}},
      { id: 'tenant_move_in', name: 'Tenant Move-In', description: 'References, contracts, key handover', icon: 'üîë', industry: 'Property & Real Estate', stageCount: 4, config: { title: 'Tenant Move-In Journey', currency: '¬£', stages: [{ id: 'stage-1', name: 'Application', steps: [{ id: 's1-1', name: 'Viewing', time: 30, personaId: 'tenant', friction: 'low', notes: '' }, { id: 's1-2', name: 'Application Form', time: 20, personaId: 'tenant', friction: 'low', notes: '' }]}, { id: 'stage-2', name: 'Referencing', steps: [{ id: 's2-1', name: 'Credit Check', time: 30, personaId: 'agent', friction: 'low', notes: '' }, { id: 's2-2', name: 'Employer Reference', time: 60, personaId: 'agent', friction: 'medium', notes: '' }]}, { id: 'stage-3', name: 'Contract', steps: [{ id: 's3-1', name: 'AST Preparation', time: 30, personaId: 'agent', friction: 'low', notes: '' }, { id: 's3-2', name: 'Contract Signing', time: 30, personaId: 'tenant', friction: 'low', notes: '' }]}, { id: 'stage-4', name: 'Move-In', steps: [{ id: 's4-1', name: 'Inventory Check', time: 60, personaId: 'agent', friction: 'low', notes: '' }, { id: 's4-2', name: 'Key Handover', time: 30, personaId: 'agent', friction: 'none', notes: '' }]}], personas: [{ id: 'tenant', name: 'Tenant', salary: 0, isExternal: true }, { id: 'agent', name: 'Letting Agent', salary: 28000, isExternal: false }, { id: 'landlord', name: 'Landlord', salary: 0, isExternal: true }], funnelConfig: { enabled: true, startVolume: 100, stages: {} }}},
      { id: 'legal_client_intake', name: 'Client Intake (Law Firm)', description: 'Conflict checks, engagement letters, AML/KYC', icon: '‚öñÔ∏è', industry: 'Legal & Professional Services', stageCount: 4, config: { title: 'Legal Client Intake Journey', currency: '¬£', stages: [{ id: 'stage-1', name: 'Enquiry', steps: [{ id: 's1-1', name: 'Initial Contact', time: 15, personaId: 'client', friction: 'none', notes: '' }, { id: 's1-2', name: 'Matter Assessment', time: 30, personaId: 'partner', friction: 'low', notes: '' }]}, { id: 'stage-2', name: 'Conflict Check', steps: [{ id: 's2-1', name: 'Conflict Search', time: 20, personaId: 'admin', friction: 'low', notes: '' }, { id: 's2-2', name: 'Partner Sign-off', time: 15, personaId: 'partner', friction: 'low', notes: '' }]}, { id: 'stage-3', name: 'KYC/AML', steps: [{ id: 's3-1', name: 'ID Collection', time: 30, personaId: 'client', friction: 'medium', notes: '' }, { id: 's3-2', name: 'AML Check', time: 30, personaId: 'compliance', friction: 'low', notes: '' }]}, { id: 'stage-4', name: 'Engagement', steps: [{ id: 's4-1', name: 'Engagement Letter', time: 30, personaId: 'admin', friction: 'low', notes: '' }, { id: 's4-2', name: 'Retainer Receipt', time: 15, personaId: 'admin', friction: 'low', notes: '' }]}], personas: [{ id: 'client', name: 'Client', salary: 0, isExternal: true }, { id: 'partner', name: 'Partner', salary: 150000, isExternal: false }, { id: 'admin', name: 'Admin', salary: 28000, isExternal: false }, { id: 'compliance', name: 'Compliance', salary: 45000, isExternal: false }], funnelConfig: { enabled: true, startVolume: 100, stages: {} }}},
      { id: 'contract_lifecycle', name: 'Contract Lifecycle', description: 'Request, negotiation, approval, execution', icon: 'üìù', industry: 'Legal & Professional Services', stageCount: 5, config: { title: 'Contract Lifecycle Journey', currency: '¬£', stages: [{ id: 'stage-1', name: 'Request', steps: [{ id: 's1-1', name: 'Contract Request', time: 15, personaId: 'requestor', friction: 'low', notes: '' }, { id: 's1-2', name: 'Requirements Gathering', time: 30, personaId: 'legal', friction: 'low', notes: '' }]}, { id: 'stage-2', name: 'Drafting', steps: [{ id: 's2-1', name: 'Draft Contract', time: 120, personaId: 'legal', friction: 'medium', notes: '' }, { id: 's2-2', name: 'Internal Review', time: 60, personaId: 'legal', friction: 'low', notes: '' }]}, { id: 'stage-3', name: 'Negotiation', steps: [{ id: 's3-1', name: 'Send to Counterparty', time: 15, personaId: 'legal', friction: 'none', notes: '' }, { id: 's3-2', name: 'Redline Review', time: 90, personaId: 'legal', friction: 'medium', notes: '' }]}, { id: 'stage-4', name: 'Approval', steps: [{ id: 's4-1', name: 'Finance Review', time: 30, personaId: 'finance', friction: 'low', notes: '' }, { id: 's4-2', name: 'Final Approval', time: 30, personaId: 'approver', friction: 'low', notes: '' }]}, { id: 'stage-5', name: 'Execution', steps: [{ id: 's5-1', name: 'Signature', time: 30, personaId: 'approver', friction: 'low', notes: '' }, { id: 's5-2', name: 'Archival', time: 15, personaId: 'legal', friction: 'none', notes: '' }]}], personas: [{ id: 'requestor', name: 'Requestor', salary: 50000, isExternal: false }, { id: 'legal', name: 'Legal Counsel', salary: 85000, isExternal: false }, { id: 'finance', name: 'Finance', salary: 55000, isExternal: false }, { id: 'approver', name: 'Approver', salary: 75000, isExternal: false }], funnelConfig: { enabled: false, startVolume: 100, stages: {} }}},
      { id: 'saas_onboarding', name: 'Customer Onboarding (SaaS)', description: 'Implementation to go-live', icon: 'üöÄ', industry: 'B2B / SaaS', stageCount: 5, config: { title: 'Customer Onboarding Journey', currency: '¬£', stages: [{ id: 'stage-1', name: 'Handoff', steps: [{ id: 's1-1', name: 'Sales Handoff', time: 30, personaId: 'sales', friction: 'low', notes: '' }, { id: 's1-2', name: 'Kickoff Call', time: 60, personaId: 'csm', friction: 'none', notes: '' }]}, { id: 'stage-2', name: 'Setup', steps: [{ id: 's2-1', name: 'Account Configuration', time: 120, personaId: 'csm', friction: 'medium', notes: '' }, { id: 's2-2', name: 'Integration Setup', time: 180, personaId: 'tech', friction: 'high', notes: '' }]}, { id: 'stage-3', name: 'Training', steps: [{ id: 's3-1', name: 'Admin Training', time: 90, personaId: 'csm', friction: 'low', notes: '' }, { id: 's3-2', name: 'User Training', time: 120, personaId: 'csm', friction: 'low', notes: '' }]}, { id: 'stage-4', name: 'Go-Live', steps: [{ id: 's4-1', name: 'UAT', time: 60, personaId: 'customer', friction: 'medium', notes: '' }, { id: 's4-2', name: 'Production Launch', time: 30, personaId: 'tech', friction: 'low', notes: '' }]}, { id: 'stage-5', name: 'Success', steps: [{ id: 's5-1', name: '30-Day Check-in', time: 30, personaId: 'csm', friction: 'none', notes: '' }, { id: 's5-2', name: 'Success Review', time: 45, personaId: 'csm', friction: 'none', notes: '' }]}], personas: [{ id: 'customer', name: 'Customer', salary: 0, isExternal: true }, { id: 'sales', name: 'Sales Rep', salary: 55000, isExternal: false }, { id: 'csm', name: 'CSM', salary: 45000, isExternal: false }, { id: 'tech', name: 'Implementation', salary: 50000, isExternal: false }], funnelConfig: { enabled: true, startVolume: 100, stages: {} }}},
      { id: 'vendor_onboarding', name: 'Vendor/Supplier Onboarding', description: 'Due diligence, contracting, setup', icon: 'ü§ù', industry: 'B2B / SaaS', stageCount: 4, config: { title: 'Vendor Onboarding Journey', currency: '¬£', stages: [{ id: 'stage-1', name: 'Request', steps: [{ id: 's1-1', name: 'Vendor Request', time: 20, personaId: 'requestor', friction: 'low', notes: '' }, { id: 's1-2', name: 'Initial Assessment', time: 30, personaId: 'procurement', friction: 'low', notes: '' }]}, { id: 'stage-2', name: 'Due Diligence', steps: [{ id: 's2-1', name: 'Risk Assessment', time: 60, personaId: 'risk', friction: 'medium', notes: '' }, { id: 's2-2', name: 'Security Review', time: 90, personaId: 'security', friction: 'medium', notes: '' }]}, { id: 'stage-3', name: 'Contracting', steps: [{ id: 's3-1', name: 'Contract Negotiation', time: 120, personaId: 'legal', friction: 'medium', notes: '' }, { id: 's3-2', name: 'Contract Execution', time: 30, personaId: 'legal', friction: 'low', notes: '' }]}, { id: 'stage-4', name: 'Setup', steps: [{ id: 's4-1', name: 'System Setup', time: 60, personaId: 'procurement', friction: 'low', notes: '' }, { id: 's4-2', name: 'Payment Setup', time: 30, personaId: 'finance', friction: 'low', notes: '' }]}], personas: [{ id: 'vendor', name: 'Vendor', salary: 0, isExternal: true }, { id: 'requestor', name: 'Requestor', salary: 50000, isExternal: false }, { id: 'procurement', name: 'Procurement', salary: 45000, isExternal: false }, { id: 'legal', name: 'Legal', salary: 70000, isExternal: false }, { id: 'risk', name: 'Risk', salary: 55000, isExternal: false }, { id: 'security', name: 'Security', salary: 60000, isExternal: false }, { id: 'finance', name: 'Finance', salary: 50000, isExternal: false }], funnelConfig: { enabled: true, startVolume: 100, stages: {} }}},
      { id: 'enterprise_sales', name: 'Enterprise Sales Cycle', description: 'Lead to closed deal with procurement', icon: 'üìä', industry: 'B2B / SaaS', stageCount: 6, config: { title: 'Enterprise Sales Journey', currency: '¬£', stages: [{ id: 'stage-1', name: 'Lead', steps: [{ id: 's1-1', name: 'Lead Qualification', time: 30, personaId: 'sdr', friction: 'low', notes: '' }, { id: 's1-2', name: 'Discovery Call', time: 45, personaId: 'ae', friction: 'low', notes: '' }]}, { id: 'stage-2', name: 'Demo', steps: [{ id: 's2-1', name: 'Product Demo', time: 60, personaId: 'ae', friction: 'low', notes: '' }, { id: 's2-2', name: 'Technical Demo', time: 90, personaId: 'se', friction: 'low', notes: '' }]}, { id: 'stage-3', name: 'Evaluation', steps: [{ id: 's3-1', name: 'POC Setup', time: 120, personaId: 'se', friction: 'medium', notes: '' }, { id: 's3-2', name: 'POC Review', time: 60, personaId: 'ae', friction: 'low', notes: '' }]}, { id: 'stage-4', name: 'Proposal', steps: [{ id: 's4-1', name: 'Proposal Creation', time: 90, personaId: 'ae', friction: 'medium', notes: '' }, { id: 's4-2', name: 'Pricing Negotiation', time: 60, personaId: 'ae', friction: 'medium', notes: '' }]}, { id: 'stage-5', name: 'Procurement', steps: [{ id: 's5-1', name: 'Security Review', time: 180, personaId: 'se', friction: 'high', notes: '' }, { id: 's5-2', name: 'Legal Review', time: 120, personaId: 'ae', friction: 'high', notes: '' }]}, { id: 'stage-6', name: 'Close', steps: [{ id: 's6-1', name: 'Contract Signature', time: 30, personaId: 'ae', friction: 'low', notes: '' }, { id: 's6-2', name: 'Handoff to CS', time: 30, personaId: 'ae', friction: 'none', notes: '' }]}], personas: [{ id: 'prospect', name: 'Prospect', salary: 0, isExternal: true }, { id: 'sdr', name: 'SDR', salary: 35000, isExternal: false }, { id: 'ae', name: 'Account Executive', salary: 65000, isExternal: false }, { id: 'se', name: 'Solutions Engineer', salary: 70000, isExternal: false }], funnelConfig: { enabled: true, startVolume: 100, stages: {} }}},
      { id: 'grant_application', name: 'Grant Application & Award', description: 'Eligibility, assessment, disbursement', icon: 'üí∞', industry: 'Public Sector / Government', stageCount: 5, config: { title: 'Grant Application Journey', currency: '¬£', stages: [{ id: 'stage-1', name: 'Application', steps: [{ id: 's1-1', name: 'Eligibility Check', time: 30, personaId: 'applicant', friction: 'low', notes: '' }, { id: 's1-2', name: 'Application Submission', time: 90, personaId: 'applicant', friction: 'high', notes: '' }]}, { id: 'stage-2', name: 'Review', steps: [{ id: 's2-1', name: 'Initial Review', time: 60, personaId: 'officer', friction: 'low', notes: '' }, { id: 's2-2', name: 'Due Diligence', time: 120, personaId: 'officer', friction: 'medium', notes: '' }]}, { id: 'stage-3', name: 'Assessment', steps: [{ id: 's3-1', name: 'Panel Review', time: 90, personaId: 'panel', friction: 'low', notes: '' }, { id: 's3-2', name: 'Decision', time: 30, personaId: 'panel', friction: 'low', notes: '' }]}, { id: 'stage-4', name: 'Award', steps: [{ id: 's4-1', name: 'Grant Agreement', time: 45, personaId: 'officer', friction: 'low', notes: '' }, { id: 's4-2', name: 'Agreement Signing', time: 30, personaId: 'applicant', friction: 'low', notes: '' }]}, { id: 'stage-5', name: 'Disbursement', steps: [{ id: 's5-1', name: 'Bank Details Verification', time: 20, personaId: 'finance', friction: 'low', notes: '' }, { id: 's5-2', name: 'Payment', time: 30, personaId: 'finance', friction: 'low', notes: '' }]}], personas: [{ id: 'applicant', name: 'Applicant', salary: 0, isExternal: true }, { id: 'officer', name: 'Grants Officer', salary: 38000, isExternal: false }, { id: 'panel', name: 'Assessment Panel', salary: 55000, isExternal: false }, { id: 'finance', name: 'Finance', salary: 35000, isExternal: false }], funnelConfig: { enabled: true, startVolume: 100, stages: {} }}},
      { id: 'permit_license', name: 'Permit/License Application', description: 'Submission to issuance with appeals', icon: 'üèõÔ∏è', industry: 'Public Sector / Government', stageCount: 4, config: { title: 'Permit Application Journey', currency: '¬£', stages: [{ id: 'stage-1', name: 'Application', steps: [{ id: 's1-1', name: 'Form Submission', time: 45, personaId: 'applicant', friction: 'medium', notes: '' }, { id: 's1-2', name: 'Document Upload', time: 30, personaId: 'applicant', friction: 'medium', notes: '' }]}, { id: 'stage-2', name: 'Review', steps: [{ id: 's2-1', name: 'Completeness Check', time: 30, personaId: 'officer', friction: 'low', notes: '' }, { id: 's2-2', name: 'Technical Review', time: 90, personaId: 'specialist', friction: 'medium', notes: '' }]}, { id: 'stage-3', name: 'Decision', steps: [{ id: 's3-1', name: 'Assessment', time: 60, personaId: 'officer', friction: 'low', notes: '' }, { id: 's3-2', name: 'Decision Notice', time: 30, personaId: 'officer', friction: 'low', notes: '' }]}, { id: 'stage-4', name: 'Issuance', steps: [{ id: 's4-1', name: 'Fee Payment', time: 15, personaId: 'applicant', friction: 'low', notes: '' }, { id: 's4-2', name: 'Permit Issuance', time: 20, personaId: 'officer', friction: 'none', notes: '' }]}], personas: [{ id: 'applicant', name: 'Applicant', salary: 0, isExternal: true }, { id: 'officer', name: 'Licensing Officer', salary: 32000, isExternal: false }, { id: 'specialist', name: 'Technical Specialist', salary: 42000, isExternal: false }], funnelConfig: { enabled: true, startVolume: 100, stages: {} }}},
      { id: 'complaint_handling', name: 'Complaint Handling', description: 'Receipt to resolution and learning', icon: 'üì£', industry: 'Operations / Service', stageCount: 4, config: { title: 'Complaint Handling Journey', currency: '¬£', stages: [{ id: 'stage-1', name: 'Receipt', steps: [{ id: 's1-1', name: 'Complaint Received', time: 15, personaId: 'customer', friction: 'medium', notes: '' }, { id: 's1-2', name: 'Acknowledgement', time: 10, personaId: 'agent', friction: 'none', notes: '' }]}, { id: 'stage-2', name: 'Investigation', steps: [{ id: 's2-1', name: 'Gather Information', time: 45, personaId: 'agent', friction: 'low', notes: '' }, { id: 's2-2', name: 'Root Cause Analysis', time: 60, personaId: 'manager', friction: 'medium', notes: '' }]}, { id: 'stage-3', name: 'Resolution', steps: [{ id: 's3-1', name: 'Resolution Proposal', time: 30, personaId: 'manager', friction: 'low', notes: '' }, { id: 's3-2', name: 'Customer Communication', time: 20, personaId: 'agent', friction: 'low', notes: '' }]}, { id: 'stage-4', name: 'Closure', steps: [{ id: 's4-1', name: 'Confirmation', time: 15, personaId: 'customer', friction: 'low', notes: '' }, { id: 's4-2', name: 'Learning & Improvement', time: 30, personaId: 'manager', friction: 'none', notes: '' }]}], personas: [{ id: 'customer', name: 'Customer', salary: 0, isExternal: true }, { id: 'agent', name: 'Service Agent', salary: 26000, isExternal: false }, { id: 'manager', name: 'Manager', salary: 42000, isExternal: false }], funnelConfig: { enabled: false, startVolume: 100, stages: {} }}},
      { id: 'product_return', name: 'Product Return & Refund', description: 'E-commerce returns processing', icon: 'üì¶', industry: 'Operations / Service', stageCount: 4, config: { title: 'Product Return Journey', currency: '¬£', stages: [{ id: 'stage-1', name: 'Request', steps: [{ id: 's1-1', name: 'Return Request', time: 10, personaId: 'customer', friction: 'low', notes: '' }, { id: 's1-2', name: 'RMA Issued', time: 10, personaId: 'agent', friction: 'none', notes: '' }]}, { id: 'stage-2', name: 'Return', steps: [{ id: 's2-1', name: 'Ship Return', time: 30, personaId: 'customer', friction: 'medium', notes: '' }, { id: 's2-2', name: 'Receive Return', time: 20, personaId: 'warehouse', friction: 'low', notes: '' }]}, { id: 'stage-3', name: 'Inspection', steps: [{ id: 's3-1', name: 'Quality Check', time: 15, personaId: 'warehouse', friction: 'low', notes: '' }, { id: 's3-2', name: 'Decision', time: 10, personaId: 'warehouse', friction: 'low', notes: '' }]}, { id: 'stage-4', name: 'Refund', steps: [{ id: 's4-1', name: 'Process Refund', time: 15, personaId: 'finance', friction: 'low', notes: '' }, { id: 's4-2', name: 'Confirmation', time: 5, personaId: 'agent', friction: 'none', notes: '' }]}], personas: [{ id: 'customer', name: 'Customer', salary: 0, isExternal: true }, { id: 'agent', name: 'Service Agent', salary: 24000, isExternal: false }, { id: 'warehouse', name: 'Warehouse', salary: 26000, isExternal: false }, { id: 'finance', name: 'Finance', salary: 32000, isExternal: false }], funnelConfig: { enabled: true, startVolume: 100, stages: {} }}},
      { id: 'it_incident', name: 'IT Incident Management', description: 'Detection to resolution and PIR', icon: 'üîß', industry: 'Operations / Service', stageCount: 5, config: { title: 'IT Incident Journey', currency: '¬£', stages: [{ id: 'stage-1', name: 'Detection', steps: [{ id: 's1-1', name: 'Incident Detected', time: 5, personaId: 'monitoring', friction: 'none', notes: '' }, { id: 's1-2', name: 'Ticket Created', time: 5, personaId: 'l1', friction: 'none', notes: '' }]}, { id: 'stage-2', name: 'Triage', steps: [{ id: 's2-1', name: 'Initial Assessment', time: 15, personaId: 'l1', friction: 'low', notes: '' }, { id: 's2-2', name: 'Priority Assignment', time: 10, personaId: 'l1', friction: 'low', notes: '' }]}, { id: 'stage-3', name: 'Resolution', steps: [{ id: 's3-1', name: 'Investigation', time: 45, personaId: 'l2', friction: 'medium', notes: '' }, { id: 's3-2', name: 'Fix Applied', time: 30, personaId: 'l2', friction: 'low', notes: '' }]}, { id: 'stage-4', name: 'Verification', steps: [{ id: 's4-1', name: 'Testing', time: 20, personaId: 'l2', friction: 'low', notes: '' }, { id: 's4-2', name: 'User Confirmation', time: 15, personaId: 'user', friction: 'low', notes: '' }]}, { id: 'stage-5', name: 'Closure', steps: [{ id: 's5-1', name: 'Documentation', time: 15, personaId: 'l2', friction: 'low', notes: '' }, { id: 's5-2', name: 'PIR (if major)', time: 60, personaId: 'manager', friction: 'medium', notes: '' }]}], personas: [{ id: 'user', name: 'User', salary: 0, isExternal: true }, { id: 'monitoring', name: 'Monitoring', salary: 0, isExternal: false }, { id: 'l1', name: 'L1 Support', salary: 28000, isExternal: false }, { id: 'l2', name: 'L2 Support', salary: 38000, isExternal: false }, { id: 'manager', name: 'IT Manager', salary: 55000, isExternal: false }], funnelConfig: { enabled: false, startVolume: 100, stages: {} }}}
    ];

    // Create Map Modal with Templates
    // ============================================
    // AI WIZARD CONFIGURATION
    // ============================================
    const WIZARD_INDUSTRIES = {
      'financial-services': {
        label: 'Financial Services',
        roles: [
          { name: 'Client', salary: 0, isExternal: true },
          { name: 'Financial Adviser', salary: 75000, isExternal: false },
          { name: 'Paraplanner', salary: 45000, isExternal: false },
          { name: 'Administrator', salary: 28000, isExternal: false },
          { name: 'Compliance Officer', salary: 55000, isExternal: false }
        ]
      },
      'accounting': {
        label: 'Accounting & Professional Services',
        roles: [
          { name: 'Client', salary: 0, isExternal: true },
          { name: 'Partner', salary: 150000, isExternal: false },
          { name: 'Senior Accountant', salary: 55000, isExternal: false },
          { name: 'Administrator', salary: 26000, isExternal: false }
        ]
      },
      'legal': {
        label: 'Legal Services',
        roles: [
          { name: 'Client', salary: 0, isExternal: true },
          { name: 'Partner', salary: 180000, isExternal: false },
          { name: 'Associate', salary: 65000, isExternal: false },
          { name: 'Paralegal', salary: 32000, isExternal: false }
        ]
      },
      'healthcare': {
        label: 'Healthcare',
        roles: [
          { name: 'Patient', salary: 0, isExternal: true },
          { name: 'Consultant', salary: 120000, isExternal: false },
          { name: 'Nurse', salary: 38000, isExternal: false },
          { name: 'Administrator', salary: 26000, isExternal: false }
        ]
      },
      'hr': {
        label: 'HR / People Operations',
        roles: [
          { name: 'Employee', salary: 0, isExternal: true },
          { name: 'Candidate', salary: 0, isExternal: true },
          { name: 'HR Manager', salary: 55000, isExternal: false },
          { name: 'HR Administrator', salary: 28000, isExternal: false }
        ]
      },
      'property': {
        label: 'Property & Real Estate',
        roles: [
          { name: 'Buyer', salary: 0, isExternal: true },
          { name: 'Agent', salary: 35000, isExternal: false },
          { name: 'Solicitor', salary: 55000, isExternal: false }
        ]
      },
      'saas': {
        label: 'B2B / SaaS',
        roles: [
          { name: 'Customer', salary: 0, isExternal: true },
          { name: 'Account Executive', salary: 65000, isExternal: false },
          { name: 'Customer Success', salary: 45000, isExternal: false }
        ]
      },
      'other': {
        label: 'Other',
        roles: [
          { name: 'Customer', salary: 0, isExternal: true },
          { name: 'Manager', salary: 50000, isExternal: false },
          { name: 'Staff', salary: 32000, isExternal: false }
        ]
      }
    };
    
    const WIZARD_JOURNEY_TYPES = [
      'Client Onboarding', 'Employee Onboarding', 'Service Delivery', 'Sales Process',
      'Support / Case Management', 'Application Processing', 'Complaint Handling', 'Procurement', 'Other'
    ];
    
    const WIZARD_COMPLEXITY = [
      { value: 'simple', label: 'Simple', stages: '3-4 stages' },
      { value: 'medium', label: 'Medium', stages: '5-6 stages' },
      { value: 'complex', label: 'Complex', stages: '7+ stages' }
    ];

    function CreateMapModal({ maps, onClose, onCreated }) {
      const { profile } = useAuth();
      // Modal mode: 'select', 'wizard', 'customize', 'generating', 'import'
      const [mode, setMode] = useState('select');
      const [wizardStep, setWizardStep] = useState(1);
      
      // Template mode state
      const [selectedTemplate, setSelectedTemplate] = useState(null);
      const [title, setTitle] = useState('');
      const [templateDescription, setTemplateDescription] = useState('');
      
      // Wizard state
      const [description, setDescription] = useState('');
      const [industry, setIndustry] = useState('');
      const [journeyType, setJourneyType] = useState('');
      const [complexity, setComplexity] = useState('medium');
      const [roles, setRoles] = useState([]);
      const [knownStages, setKnownStages] = useState('');
      const [apiKey, setApiKey] = useState('');
      const [newRoleName, setNewRoleName] = useState('');
      const [newRoleExternal, setNewRoleExternal] = useState(false);
      
      // Import state
      const [importJson, setImportJson] = useState('');
      const [importTitle, setImportTitle] = useState('');
      const [importPreview, setImportPreview] = useState(null);
      const fileInputRef = useRef(null);
      
      // Shared state
      const [isCreating, setIsCreating] = useState(false);
      const [error, setError] = useState('');
      
      // Load saved API key
      useEffect(() => {
        const savedKey = localStorage.getItem('fathom_anthropic_key');
        if (savedKey) setApiKey(savedKey);
      }, []);
      
      // When industry changes, suggest roles
      useEffect(() => {
        if (industry && WIZARD_INDUSTRIES[industry]) {
          const suggested = WIZARD_INDUSTRIES[industry].roles.slice(0, 3);
          setRoles(suggested.map(r => ({
            id: r.name.toLowerCase().replace(/\s+/g, '-'),
            name: r.name,
            salary: r.salary,
            isExternal: r.isExternal
          })));
        }
      }, [industry]);
      
      const handleSelectTemplate = (template) => {
        setSelectedTemplate(template);
        setTitle(template.config.title);
        setTemplateDescription(template.description);
        setMode('customize');
      };
      
      const handleStartWizard = () => {
        setMode('wizard');
        setWizardStep(1);
      };
      
      const handleBack = () => {
        if (mode === 'customize') {
          setMode('select');
          setSelectedTemplate(null);
        } else if (mode === 'wizard') {
          if (wizardStep > 1) {
            setWizardStep(wizardStep - 1);
          } else {
            setMode('select');
          }
        } else if (mode === 'import') {
          setMode('select');
          setImportJson('');
          setImportTitle('');
          setImportPreview(null);
        }
      };
      
      // Import handlers
      const handleStartImport = () => {
        setMode('import');
        setError('');
      };
      
      const handleFileUpload = (e) => {
        const file = e.target.files?.[0];
        if (!file) return;
        
        const reader = new FileReader();
        reader.onload = (event) => {
          setImportJson(event.target.result);
          parseImportJson(event.target.result);
        };
        reader.onerror = () => setError('Failed to read file');
        reader.readAsText(file);
      };
      
      const parseImportJson = (jsonString) => {
        try {
          const parsed = JSON.parse(jsonString);
          
          // Detect format and extract preview info
          let preview = { stages: 0, steps: 0, personas: 0, title: '' };
          
          if (parsed.meta?.title) {
            // New format
            preview.title = parsed.meta.title;
            preview.stages = parsed.stages?.length || 0;
            preview.steps = parsed.stages?.reduce((acc, s) => acc + (s.steps?.length || 0), 0) || 0;
            preview.personas = parsed.personas?.length || 0;
            preview.format = 'current';
          } else if (parsed.title) {
            // Legacy format
            preview.title = parsed.title;
            preview.stages = parsed.stages?.length || 0;
            preview.steps = parsed.stages?.reduce((acc, s) => acc + (s.steps?.length || 0), 0) || 0;
            preview.personas = parsed.personas?.length || 0;
            preview.format = 'legacy';
          } else {
            throw new Error('Unrecognized JSON format');
          }
          
          setImportPreview(preview);
          setImportTitle(preview.title);
          setError('');
        } catch (err) {
          setError('Invalid JSON: ' + err.message);
          setImportPreview(null);
        }
      };
      
      const handleImportCreate = async () => {
        if (!importJson.trim() || !importTitle.trim()) return;
        if (!profile?.organisation_id) {
          setError('Profile not loaded. Please refresh and try again.');
          return;
        }
        
        setIsCreating(true);
        setError('');
        
        try {
          const parsed = JSON.parse(importJson);
          let mapConfig;
          
          if (parsed.meta?.title) {
            // Already in current format - use directly
            mapConfig = {
              ...parsed,
              meta: { ...parsed.meta, title: importTitle.trim() }
            };
          } else {
            // Convert legacy format to current format
            mapConfig = {
              meta: { 
                title: importTitle.trim(), 
                version: '1.0', 
                template: 'imported' 
              },
              funnel: parsed.funnelConfig ? {
                enabled: parsed.funnelConfig.enabled || false,
                initialVolume: parsed.funnelConfig.startVolume || 100,
                periodLabel: parsed.funnelConfig.periodLabel || 'per month'
              } : { 
                enabled: false, 
                initialVolume: 100, 
                periodLabel: 'per month' 
              },
              personas: (parsed.personas || []).map(p => ({
                id: p.id,
                label: p.label || p.name,
                annualSalary: p.annualSalary || p.salary || 0,
                isExternal: p.isExternal || false,
                burdenMultiplier: p.burdenMultiplier || 1.3,
                workspaceHourlyCost: p.workspaceHourlyCost || 6,
                color: p.color || (p.isExternal ? '#2D8A6E' : '#5B8A9A')
              })),
              stages: (parsed.stages || []).map(stage => ({
                id: stage.id,
                name: stage.name,
                dropOffCount: stage.dropOffCount || parsed.funnelConfig?.stages?.[stage.id]?.dropOff || 0,
                steps: (stage.steps || []).map(step => ({
                  id: step.id,
                  name: step.name,
                  description: step.description || '',
                  owner: step.owner || step.personaId,
                  timeMinutes: step.timeMinutes || step.time || 30,
                  frictionLevel: typeof step.frictionLevel === 'number' ? step.frictionLevel : 
                    (step.friction === 'high' ? 4 : step.friction === 'medium' ? 3 : step.friction === 'low' ? 2 : 1),
                  painPoints: step.painPoints || [],
                  automationOpportunity: step.automationOpportunity || 'none',
                  notes: step.notes || '',
                  clientTouchpoint: step.clientTouchpoint || false,
                  isHardCheckpoint: step.isHardCheckpoint || false,
                  clientSentiment: step.clientSentiment || 'neutral',
                  thirdPartyCosts: step.thirdPartyCosts || [],
                  roleInvolvement: step.roleInvolvement || [],
                  actions: step.actions || {}
                }))
              }))
            };
          }
          
          await createMapInSupabase({
            organisation_id: profile.organisation_id,
            title: importTitle.trim(),
            description: 'Imported from JSON',
            journey_type: mapConfig.meta?.journeyType || 'Imported',
            config: mapConfig,
            created_by: profile.id,
            template_source: 'imported'
          });
          
          onCreated();
        } catch (err) {
          console.error('Import error:', err);
          setError(err.message || 'Failed to import journey');
        }
        
        setIsCreating(false);
      };
      
      const addRole = (name, salary, isExternal) => {
        if (!name.trim()) return;
        if (roles.find(r => r.name.toLowerCase() === name.toLowerCase())) return;
        setRoles([...roles, {
          id: name.toLowerCase().replace(/\s+/g, '-'),
          name: name.trim(),
          salary: isExternal ? 0 : salary,
          isExternal
        }]);
      };
      
      const removeRole = (index) => {
        setRoles(roles.filter((_, i) => i !== index));
      };
      
      const addSuggestedRole = (suggestion) => {
        addRole(suggestion.name, suggestion.salary, suggestion.isExternal);
      };
      
      const handleAddCustomRole = () => {
        if (!newRoleName.trim()) return;
        addRole(newRoleName, newRoleExternal ? 0 : 35000, newRoleExternal);
        setNewRoleName('');
      };
      
      // Fallback generator (no AI required)
      const generateFallbackJourney = () => {
        let stageNames = [];
        if (knownStages.trim()) {
          stageNames = knownStages.split(/[,\n]+/).map(s => s.trim()).filter(Boolean);
        } else {
          const defaults = {
            'Client Onboarding': ['Initial Contact', 'Discovery', 'Documentation', 'Setup', 'Handover'],
            'Employee Onboarding': ['Offer', 'Pre-boarding', 'Day One', 'Training', 'Integration'],
            'Service Delivery': ['Request', 'Planning', 'Execution', 'Review', 'Delivery'],
            'Sales Process': ['Lead', 'Qualification', 'Proposal', 'Negotiation', 'Close'],
            'Support / Case Management': ['Intake', 'Triage', 'Investigation', 'Resolution', 'Follow-up'],
            'Application Processing': ['Submission', 'Validation', 'Assessment', 'Decision', 'Notification']
          };
          stageNames = defaults[journeyType] || ['Initiation', 'Planning', 'Execution', 'Review', 'Completion'];
        }
        
        const targetStages = complexity === 'simple' ? 3 : complexity === 'complex' ? 7 : 5;
        while (stageNames.length < targetStages) stageNames.push(`Stage ${stageNames.length + 1}`);
        stageNames = stageNames.slice(0, targetStages + 1);
        
        const externalRoles = roles.filter(r => r.isExternal);
        const internalRoles = roles.filter(r => !r.isExternal);
        const primaryExternal = externalRoles[0] || { id: 'customer', name: 'Customer', salary: 0, isExternal: true };
        const primaryInternal = internalRoles[0] || { id: 'staff', name: 'Staff', salary: 35000, isExternal: false };
        
        const stages = stageNames.map((stageName, si) => {
          const stepsPerStage = complexity === 'simple' ? 2 : complexity === 'complex' ? 4 : 3;
          const steps = [];
          for (let i = 0; i < stepsPerStage; i++) {
            let owner = i === 0 && externalRoles.length > 0 ? primaryExternal : 
                        internalRoles.length > 0 ? internalRoles[i % internalRoles.length] : primaryInternal;
            steps.push({
              id: `step-${si + 1}-${i + 1}`,
              name: `Step ${i + 1}`,
              description: '',
              owner: owner.id,
              timeMinutes: [15, 30, 45, 60, 90][Math.floor(Math.random() * 5)],
              frictionLevel: i === 0 ? 1 : [1, 2, 2, 3][Math.floor(Math.random() * 4)],
              notes: ''
            });
          }
          return { id: `stage-${si + 1}`, name: stageName, steps };
        });
        
        const personas = (roles.length > 0 ? roles : [primaryExternal, primaryInternal]).map(r => ({
          id: r.id,
          label: r.name,
          annualSalary: r.salary,
          isExternal: r.isExternal,
          burdenMultiplier: r.isExternal ? 1 : 1.3,
          workspaceHourlyCost: r.isExternal ? 0 : 6,
          color: r.isExternal ? '#2D8A6E' : '#5B8A9A'
        }));
        
        const journeyTitle = description.length > 60 ? description.slice(0, 60).trim() + '...' : description || `${journeyType || 'Process'} Journey`;
        return { title: journeyTitle, stages, personas };
      };
      
      // Generate with AI or fallback
      const handleGenerate = async () => {
        if (!profile?.organisation_id) {
          setError('Profile not loaded. Please refresh and try again.');
          return;
        }
        if (roles.length < 2) {
          setError('Please add at least 2 roles.');
          return;
        }
        
        setMode('generating');
        setError('');
        
        let journeyConfig;
        
        // Try AI generation if API key provided
        if (apiKey) {
          localStorage.setItem('fathom_anthropic_key', apiKey);
          try {
            const prompt = `You are an expert in operational process design. Generate a detailed journey map for:

CONTEXT:
- Description: ${description}
- Industry: ${WIZARD_INDUSTRIES[industry]?.label || 'General'}
- Journey Type: ${journeyType || 'Process'}
- Complexity: ${complexity} (${WIZARD_COMPLEXITY.find(c => c.value === complexity)?.stages})
- Roles: ${roles.map(r => r.name + (r.isExternal ? ' (external)' : '')).join(', ')}
${knownStages ? `- Key stages: ${knownStages}` : ''}

Generate a JSON object with this EXACT structure (no markdown, just JSON):
{
  "title": "Journey title",
  "stages": [{ "id": "stage-1", "name": "Stage Name", "steps": [{ "id": "step-1-1", "name": "Step name", "description": "What happens", "owner": "role-id", "timeMinutes": 30, "frictionLevel": 1, "notes": "" }] }],
  "personas": [{ "id": "role-id", "label": "Role Name", "annualSalary": 45000, "isExternal": false, "burdenMultiplier": 1.3, "workspaceHourlyCost": 6 }]
}

RULES:
1. Use roles: ${JSON.stringify(roles.map(r => ({ id: r.id, name: r.name, salary: r.salary, isExternal: r.isExternal })))}
2. frictionLevel: 1=none, 2=low, 3=medium, 4=high
3. Create ${complexity === 'simple' ? '3-4' : complexity === 'medium' ? '5-6' : '7-8'} stages with 2-5 steps each
4. External roles: salary 0, isExternal true. Internal: burdenMultiplier 1.3, workspaceHourlyCost 6
5. Return ONLY valid JSON`;

            const response = await fetch('https://api.anthropic.com/v1/messages', {
              method: 'POST',
              headers: {
                'Content-Type': 'application/json',
                'x-api-key': apiKey,
                'anthropic-version': '2023-06-01',
                'anthropic-dangerous-direct-browser-access': 'true'
              },
              body: JSON.stringify({
                model: 'claude-sonnet-4-20250514',
                max_tokens: 4000,
                messages: [{ role: 'user', content: prompt }]
              })
            });
            
            if (response.ok) {
              const data = await response.json();
              let jsonText = data.content[0].text.trim();
              if (jsonText.startsWith('`')) {
                jsonText = jsonText.replace(/^```json?\n?/, '').replace(/\n?```$/, '');
              }
              journeyConfig = JSON.parse(jsonText);
            } else {
              journeyConfig = generateFallbackJourney();
            }
          } catch (e) {
            console.warn('AI error, using fallback:', e);
            journeyConfig = generateFallbackJourney();
          }
        } else {
          journeyConfig = generateFallbackJourney();
        }
        
        // Save to Supabase
        try {
          const mapConfig = {
            meta: { title: journeyConfig.title, version: '1.0', template: 'ai-generated' },
            funnel: { enabled: false, initialVolume: 100, periodLabel: 'per month' },
            personas: journeyConfig.personas.map(p => ({
              id: p.id, label: p.label, annualSalary: p.annualSalary || p.salary || 0,
              isExternal: p.isExternal || false, burdenMultiplier: p.burdenMultiplier || 1.3,
              workspaceHourlyCost: p.workspaceHourlyCost || 6, color: p.isExternal ? '#2D8A6E' : '#5B8A9A'
            })),
            stages: journeyConfig.stages.map(stage => ({
              id: stage.id, name: stage.name, dropOffCount: 0,
              steps: stage.steps.map(step => ({
                id: step.id, name: step.name, description: step.description || '', owner: step.owner,
                timeMinutes: step.timeMinutes || 30, frictionLevel: step.frictionLevel || 1,
                painPoints: [], automationOpportunity: 'none', notes: step.notes || ''
              }))
            }))
          };
          
          await createMapInSupabase({
            organisation_id: profile.organisation_id,
            title: journeyConfig.title || description.slice(0, 50),
            description: description,
            journey_type: journeyType || industry,
            config: mapConfig,
            created_by: profile.id,
            template_source: 'ai-generated'
          });
          
          onCreated();
        } catch (err) {
          setError(err.message || 'Failed to create map');
          setMode('wizard');
          setWizardStep(3);
        }
      };
      
      const handleCreateTemplate = async () => {
        if (!title.trim() || !selectedTemplate) return;
        if (!profile?.organisation_id) {
          setError('Profile not loaded. Please refresh and try again.');
          return;
        }
        setIsCreating(true);
        setError('');
        
        try {
          const templateConfig = JSON.parse(JSON.stringify(selectedTemplate.config));
          
          const mapConfig = {
            meta: { title: title.trim(), version: '1.0', template: selectedTemplate.id },
            funnel: { enabled: templateConfig.funnelConfig?.enabled || false, initialVolume: templateConfig.funnelConfig?.startVolume || 100, periodLabel: 'per month' },
            personas: templateConfig.personas.map(p => ({ id: p.id, label: p.name, salary: p.salary, isExternal: p.isExternal, color: p.isExternal ? '#2D8A6E' : '#5B8A9A' })),
            stages: templateConfig.stages.map(stage => ({
              id: stage.id, name: stage.name, dropOffCount: templateConfig.funnelConfig?.stages?.[stage.id]?.dropOff || 0,
              steps: stage.steps.map(step => ({
                id: step.id, name: step.name, owner: step.personaId, timeMinutes: step.time,
                frictionLevel: step.friction === 'high' ? 4 : step.friction === 'medium' ? 3 : step.friction === 'low' ? 2 : 1,
                painPoints: [], automationOpportunity: 'none', notes: step.notes || ''
              }))
            }))
          };
          
          // Save to Supabase
          await createMapInSupabase({
            organisation_id: profile.organisation_id,
            title: title.trim(),
            description: templateDescription.trim(),
            journey_type: selectedTemplate.industry,
            config: mapConfig,
            created_by: profile.id,
            template_source: selectedTemplate.id
          });
          
          onCreated();
        } catch (err) {
          setError(err.message || 'Failed to create map');
        }
        setIsCreating(false);
      };
      
      // Group templates by industry
      const templatesByIndustry = JOURNEY_TEMPLATES.reduce((acc, t) => {
        if (!acc[t.industry]) acc[t.industry] = [];
        acc[t.industry].push(t);
        return acc;
      }, {});
      
      // Get suggested roles not yet added
      const suggestedRoles = industry && WIZARD_INDUSTRIES[industry] 
        ? WIZARD_INDUSTRIES[industry].roles.filter(sr => !roles.find(r => r.name === sr.name)).slice(0, 4)
        : [];

      // Modal title based on mode
      const getTitle = () => {
        if (mode === 'select') return 'Choose a Template';
        if (mode === 'customize') return 'Customise Your Map';
        if (mode === 'generating') return 'Creating Your Journey';
        if (mode === 'import') return 'Import from JSON';
        if (mode === 'wizard') {
          if (wizardStep === 1) return 'Describe Your Process';
          if (wizardStep === 2) return 'Context & Roles';
          if (wizardStep === 3) return 'Final Details';
        }
        return 'Create Map';
      };

      return (
        <div className="modal-overlay" onClick={onClose}>
          <div className="modal" onClick={e => e.stopPropagation()} style={{ maxWidth: mode === 'generating' ? '400px' : '520px', width: '95%' }}>
            <div className="modal-content" style={{ padding: '32px' }}>
              {/* Header */}
              <div style={{ display: 'flex', alignItems: 'center', gap: '12px', marginBottom: '24px' }}>
                {(mode === 'customize' || mode === 'wizard' || mode === 'import') && (
                  <button onClick={handleBack} style={{ background: 'none', border: 'none', cursor: 'pointer', fontSize: '18px', color: 'var(--slate-400)', padding: '4px' }}>‚Üê</button>
                )}
                <h2 className="modal-title" style={{ margin: 0, fontFamily: 'var(--font-display)' }}>{getTitle()}</h2>
                {mode === 'wizard' && (
                  <div style={{ marginLeft: 'auto', display: 'flex', gap: '6px', marginRight: '40px' }}>
                    {[1,2,3].map(s => (
                      <div key={s} style={{ width: s === wizardStep ? '24px' : '8px', height: '8px', borderRadius: '4px', background: s < wizardStep ? 'var(--success)' : s === wizardStep ? 'var(--navy-700)' : 'var(--slate-200)', transition: 'all 0.2s' }} />
                    ))}
                  </div>
                )}
                <button className="modal-close" onClick={onClose} style={{ marginLeft: mode === 'wizard' ? '0' : 'auto' }}>√ó</button>
              </div>
              
              {error && <div style={{ padding: '10px 12px', background: 'var(--error-light)', borderRadius: '8px', marginBottom: '16px', color: 'var(--error)', fontSize: '13px' }}>{error}</div>}
              
              {/* GENERATING STATE */}
              {mode === 'generating' && (
                <div style={{ textAlign: 'center', padding: '40px 20px' }}>
                  <div style={{ width: '60px', height: '60px', margin: '0 auto 20px', borderRadius: '50%', background: 'var(--navy-700)', display: 'flex', alignItems: 'center', justifyContent: 'center' }}>
                    <div style={{ width: '24px', height: '24px', border: '3px solid rgba(255,255,255,0.3)', borderTopColor: '#FFF', borderRadius: '50%', animation: 'spin 1s linear infinite' }} />
                  </div>
                  <p style={{ color: 'var(--slate-600)', fontSize: '14px' }}>Building your journey map...</p>
                  <style>{`@keyframes spin { to { transform: rotate(360deg); } }`}</style>
                </div>
              )}
              
              {/* SELECT MODE */}
              {mode === 'select' && (
                <>
                  <p style={{ color: 'var(--slate-500)', marginBottom: '20px', fontSize: '14px' }}>
                    Let AI build your journey, choose a template, or start from scratch.
                  </p>
                  
                  {/* AI Generate Button */}
                  <button
                    onClick={handleStartWizard}
                    style={{
                      display: 'flex', alignItems: 'center', gap: '16px', width: '100%', padding: '18px 20px',
                      background: 'linear-gradient(135deg, var(--navy-700), var(--navy-800))', border: 'none',
                      borderRadius: '12px', cursor: 'pointer', textAlign: 'left', marginBottom: '12px',
                      transition: 'all 0.2s', fontFamily: 'inherit'
                    }}
                    onMouseOver={(e) => { e.currentTarget.style.transform = 'translateY(-1px)'; e.currentTarget.style.boxShadow = '0 4px 12px rgba(25,43,69,0.3)'; }}
                    onMouseOut={(e) => { e.currentTarget.style.transform = 'translateY(0)'; e.currentTarget.style.boxShadow = 'none'; }}
                  >
                    <div style={{ fontSize: '24px' }}>‚ú®</div>
                    <div style={{ flex: 1 }}>
                      <div style={{ fontWeight: 600, color: '#FFF', fontSize: '15px' }}>AI-Powered Generation</div>
                      <div style={{ fontSize: '12px', color: 'rgba(255,255,255,0.7)' }}>Describe your process and let AI build your journey</div>
                    </div>
                    <div style={{ color: 'rgba(255,255,255,0.7)', fontSize: '16px' }}>‚Üí</div>
                  </button>
                  
                  {/* Blank Canvas */}
                  <button
                    onClick={() => handleSelectTemplate(JOURNEY_TEMPLATES.find(t => t.id === 'blank'))}
                    style={{
                      display: 'flex', alignItems: 'center', gap: '16px', width: '100%', padding: '14px 18px',
                      background: 'var(--slate-50)', border: '2px dashed var(--slate-300)', borderRadius: '10px',
                      cursor: 'pointer', textAlign: 'left', marginBottom: '20px', transition: 'all 0.15s', fontFamily: 'inherit'
                    }}
                    onMouseOver={(e) => { e.currentTarget.style.borderColor = 'var(--steel-400)'; e.currentTarget.style.background = 'var(--steel-100)'; }}
                    onMouseOut={(e) => { e.currentTarget.style.borderColor = 'var(--slate-300)'; e.currentTarget.style.background = 'var(--slate-50)'; }}
                  >
                    <div style={{ fontSize: '24px' }}>üìÑ</div>
                    <div style={{ flex: 1 }}>
                      <div style={{ fontWeight: 600, color: 'var(--navy-700)', fontSize: '14px' }}>Blank Canvas</div>
                      <div style={{ fontSize: '12px', color: 'var(--slate-500)' }}>Start from scratch</div>
                    </div>
                    <div style={{ color: 'var(--slate-400)', fontSize: '16px' }}>‚Üí</div>
                  </button>
                  
                  {/* Import from JSON */}
                  <button
                    onClick={handleStartImport}
                    style={{
                      display: 'flex', alignItems: 'center', gap: '16px', width: '100%', padding: '14px 18px',
                      background: 'var(--slate-50)', border: '1px solid var(--slate-200)', borderRadius: '10px',
                      cursor: 'pointer', textAlign: 'left', marginBottom: '20px', transition: 'all 0.15s', fontFamily: 'inherit'
                    }}
                    onMouseOver={(e) => { e.currentTarget.style.borderColor = 'var(--steel-400)'; e.currentTarget.style.background = 'var(--steel-100)'; }}
                    onMouseOut={(e) => { e.currentTarget.style.borderColor = 'var(--slate-200)'; e.currentTarget.style.background = 'var(--slate-50)'; }}
                  >
                    <div style={{ fontSize: '24px' }}>üì•</div>
                    <div style={{ flex: 1 }}>
                      <div style={{ fontWeight: 600, color: 'var(--navy-700)', fontSize: '14px' }}>Import from JSON</div>
                      <div style={{ fontSize: '12px', color: 'var(--slate-500)' }}>Migrate from legacy system or restore backup</div>
                    </div>
                    <div style={{ color: 'var(--slate-400)', fontSize: '16px' }}>‚Üí</div>
                  </button>
                  
                  {/* Template List */}
                  <div style={{ maxHeight: '340px', overflowY: 'auto', marginRight: '-8px', paddingRight: '8px' }}>
                    {Object.entries(templatesByIndustry).filter(([ind]) => ind !== 'Any').map(([ind, templates]) => (
                      <div key={ind} style={{ marginBottom: '16px' }}>
                        <h3 style={{ fontSize: '10px', fontWeight: 600, color: 'var(--slate-400)', textTransform: 'uppercase', letterSpacing: '1px', marginBottom: '6px', paddingLeft: '4px' }}>{ind}</h3>
                        <div style={{ display: 'flex', flexDirection: 'column', gap: '2px' }}>
                          {templates.map(template => (
                            <button key={template.id} onClick={() => handleSelectTemplate(template)}
                              style={{ display: 'flex', alignItems: 'center', gap: '10px', width: '100%', padding: '10px 12px', background: '#FFF', border: '1px solid transparent', borderRadius: '6px', cursor: 'pointer', textAlign: 'left', transition: 'all 0.1s', fontFamily: 'inherit' }}
                              onMouseOver={(e) => { e.currentTarget.style.background = 'var(--slate-50)'; e.currentTarget.style.borderColor = 'var(--slate-200)'; }}
                              onMouseOut={(e) => { e.currentTarget.style.background = '#FFF'; e.currentTarget.style.borderColor = 'transparent'; }}
                            >
                              <div style={{ fontSize: '18px', width: '24px', textAlign: 'center' }}>{template.icon}</div>
                              <div style={{ flex: 1 }}><div style={{ fontWeight: 500, color: 'var(--navy-700)', fontSize: '13px' }}>{template.name}</div></div>
                              <div style={{ fontSize: '11px', color: 'var(--slate-400)' }}>{template.stageCount} stages</div>
                              <div style={{ color: 'var(--slate-300)', fontSize: '12px' }}>‚Ä∫</div>
                            </button>
                          ))}
                        </div>
                      </div>
                    ))}
                  </div>
                </>
              )}
              
              {/* IMPORT MODE */}
              {mode === 'import' && (
                <>
                  <p style={{ color: 'var(--slate-500)', marginBottom: '20px', fontSize: '14px' }}>
                    Paste your journey JSON or upload a file to import an existing map.
                  </p>
                  
                  {/* File Upload */}
                  <input 
                    type="file" 
                    ref={fileInputRef}
                    accept=".json,application/json"
                    onChange={handleFileUpload}
                    style={{ display: 'none' }}
                  />
                  <button
                    onClick={() => fileInputRef.current?.click()}
                    style={{
                      display: 'flex', alignItems: 'center', justifyContent: 'center', gap: '8px',
                      width: '100%', padding: '12px 16px', marginBottom: '16px',
                      background: 'var(--slate-50)', border: '2px dashed var(--slate-300)', borderRadius: '8px',
                      cursor: 'pointer', fontFamily: 'inherit', fontSize: '14px', color: 'var(--slate-600)',
                      transition: 'all 0.15s'
                    }}
                    onMouseOver={(e) => { e.currentTarget.style.borderColor = 'var(--steel-400)'; e.currentTarget.style.background = 'var(--steel-100)'; }}
                    onMouseOut={(e) => { e.currentTarget.style.borderColor = 'var(--slate-300)'; e.currentTarget.style.background = 'var(--slate-50)'; }}
                  >
                    üìÅ Upload JSON File
                  </button>
                  
                  <div style={{ textAlign: 'center', color: 'var(--slate-400)', fontSize: '12px', marginBottom: '16px' }}>or paste JSON below</div>
                  
                  {/* JSON Textarea */}
                  <textarea
                    value={importJson}
                    onChange={(e) => {
                      setImportJson(e.target.value);
                      if (e.target.value.trim()) {
                        parseImportJson(e.target.value);
                      } else {
                        setImportPreview(null);
                      }
                    }}
                    placeholder='{"meta": {"title": "..."}, "stages": [...], "personas": [...]}'
                    style={{
                      width: '100%', minHeight: '120px', padding: '12px', marginBottom: '16px',
                      border: '1px solid var(--slate-200)', borderRadius: '8px', fontFamily: 'monospace',
                      fontSize: '12px', resize: 'vertical', background: '#FFF'
                    }}
                  />
                  
                  {/* Preview */}
                  {importPreview && (
                    <div style={{ 
                      padding: '16px', background: 'var(--success-light)', borderRadius: '8px', 
                      marginBottom: '16px', border: '1px solid var(--success)'
                    }}>
                      <div style={{ fontWeight: 600, color: 'var(--success-dark)', marginBottom: '8px', display: 'flex', alignItems: 'center', gap: '8px' }}>
                        ‚úì Valid JSON detected
                        <span style={{ fontSize: '11px', background: 'var(--success)', color: '#FFF', padding: '2px 8px', borderRadius: '10px' }}>
                          {importPreview.format === 'legacy' ? 'Legacy Format' : 'Current Format'}
                        </span>
                      </div>
                      <div style={{ fontSize: '13px', color: 'var(--slate-600)' }}>
                        <strong>{importPreview.stages}</strong> stages, <strong>{importPreview.steps}</strong> steps, <strong>{importPreview.personas}</strong> personas
                      </div>
                    </div>
                  )}
                  
                  {/* Title input */}
                  {importPreview && (
                    <div style={{ marginBottom: '16px' }}>
                      <label style={{ display: 'block', marginBottom: '6px', fontWeight: 500, fontSize: '13px', color: 'var(--slate-700)' }}>
                        Journey Title
                      </label>
                      <input
                        type="text"
                        value={importTitle}
                        onChange={(e) => setImportTitle(e.target.value)}
                        placeholder="Enter journey title"
                        style={{
                          width: '100%', padding: '10px 12px', border: '1px solid var(--slate-200)',
                          borderRadius: '8px', fontSize: '14px'
                        }}
                      />
                    </div>
                  )}
                  
                  {/* Import Button */}
                  <button
                    onClick={handleImportCreate}
                    disabled={!importPreview || !importTitle.trim() || isCreating}
                    style={{
                      width: '100%', padding: '14px', background: importPreview && importTitle.trim() ? 'var(--navy-700)' : 'var(--slate-200)',
                      color: importPreview && importTitle.trim() ? '#FFF' : 'var(--slate-400)',
                      border: 'none', borderRadius: '8px', fontSize: '15px', fontWeight: 600,
                      cursor: importPreview && importTitle.trim() && !isCreating ? 'pointer' : 'not-allowed',
                      fontFamily: 'inherit', transition: 'all 0.15s'
                    }}
                  >
                    {isCreating ? 'Importing...' : 'Import Journey'}
                  </button>
                  
                  {/* Help text */}
                  <div style={{ marginTop: '16px', padding: '12px', background: 'var(--slate-50)', borderRadius: '8px', fontSize: '12px', color: 'var(--slate-500)' }}>
                    <strong>How to export from legacy system:</strong><br/>
                    Open your journey in the editor, then in browser DevTools Console run:<br/>
                    <code style={{ background: 'var(--slate-100)', padding: '2px 6px', borderRadius: '4px', fontFamily: 'monospace' }}>
                      copy(JSON.stringify(journeyConfig))
                    </code>
                  </div>
                </>
              )}
              
              {/* WIZARD STEP 1: Description */}
              {mode === 'wizard' && wizardStep === 1 && (
                <>
                  <p style={{ color: 'var(--slate-500)', marginBottom: '20px', fontSize: '14px' }}>
                    Describe the process or journey you want to map. Be specific about what it involves.
                  </p>
                  <textarea
                    value={description}
                    onChange={(e) => setDescription(e.target.value)}
                    placeholder="e.g., Client onboarding for a wealth management firm, from initial enquiry through KYC checks, fact-finding, advice preparation, and implementation..."
                    rows={5}
                    style={{ width: '100%', padding: '14px', fontSize: '14px', border: '1px solid var(--slate-200)', borderRadius: '10px', resize: 'vertical', fontFamily: 'var(--font-body)', lineHeight: '1.5' }}
                    autoFocus
                  />
                  <p style={{ fontSize: '12px', color: 'var(--slate-400)', marginTop: '8px' }}>The more detail you provide, the better the generated journey will be.</p>
                  
                  <div style={{ display: 'flex', gap: '10px', marginTop: '24px' }}>
                    <button onClick={handleBack} className="btn btn-secondary" style={{ flex: 1 }}>Cancel</button>
                    <button onClick={() => setWizardStep(2)} className="btn btn-primary" style={{ flex: 1 }} disabled={description.trim().length < 10}>Continue</button>
                  </div>
                </>
              )}
              
              {/* WIZARD STEP 2: Context & Roles */}
              {mode === 'wizard' && wizardStep === 2 && (
                <>
                  <div style={{ display: 'grid', gridTemplateColumns: '1fr 1fr', gap: '12px', marginBottom: '16px' }}>
                    <div>
                      <label className="label">Industry</label>
                      <select value={industry} onChange={(e) => setIndustry(e.target.value)} className="input" style={{ width: '100%' }}>
                        <option value="">Select...</option>
                        {Object.entries(WIZARD_INDUSTRIES).map(([key, val]) => (
                          <option key={key} value={key}>{val.label}</option>
                        ))}
                      </select>
                    </div>
                    <div>
                      <label className="label">Journey Type</label>
                      <select value={journeyType} onChange={(e) => setJourneyType(e.target.value)} className="input" style={{ width: '100%' }}>
                        <option value="">Select...</option>
                        {WIZARD_JOURNEY_TYPES.map(jt => <option key={jt} value={jt}>{jt}</option>)}
                      </select>
                    </div>
                  </div>
                  
                  <div style={{ marginBottom: '20px' }}>
                    <label className="label">Complexity</label>
                    <div style={{ display: 'flex', gap: '8px' }}>
                      {WIZARD_COMPLEXITY.map(c => (
                        <button key={c.value} onClick={() => setComplexity(c.value)}
                          style={{
                            flex: 1, padding: '10px', borderRadius: '8px', border: complexity === c.value ? '2px solid var(--navy-600)' : '1px solid var(--slate-200)',
                            background: complexity === c.value ? 'var(--navy-50)' : '#FFF', cursor: 'pointer', fontFamily: 'inherit', transition: 'all 0.15s'
                          }}>
                          <div style={{ fontWeight: 600, fontSize: '13px', color: 'var(--navy-700)' }}>{c.label}</div>
                          <div style={{ fontSize: '11px', color: 'var(--slate-400)' }}>{c.stages}</div>
                        </button>
                      ))}
                    </div>
                  </div>
                  
                  <div style={{ marginBottom: '16px' }}>
                    <label className="label">Roles Involved <span style={{ fontWeight: 400, color: 'var(--slate-400)' }}>({roles.length} added)</span></label>
                    <div style={{ display: 'flex', flexWrap: 'wrap', gap: '6px', minHeight: '36px', padding: '8px', background: 'var(--slate-50)', borderRadius: '8px', marginBottom: '8px' }}>
                      {roles.map((role, i) => (
                        <span key={i} style={{ display: 'inline-flex', alignItems: 'center', gap: '6px', padding: '4px 10px', borderRadius: '16px', fontSize: '12px', background: role.isExternal ? 'var(--success-light)' : 'var(--steel-100)', color: role.isExternal ? 'var(--success)' : 'var(--steel-700)' }}>
                          {role.name}
                          {!role.isExternal && <span style={{ opacity: 0.6 }}>¬£{Math.round(role.salary/1000)}k</span>}
                          <button onClick={() => removeRole(i)} style={{ background: 'none', border: 'none', cursor: 'pointer', fontSize: '14px', opacity: 0.5, padding: 0 }}>√ó</button>
                        </span>
                      ))}
                      {roles.length === 0 && <span style={{ color: 'var(--slate-400)', fontSize: '12px' }}>Select an industry to get suggested roles</span>}
                    </div>
                    
                    {suggestedRoles.length > 0 && (
                      <div style={{ display: 'flex', flexWrap: 'wrap', gap: '6px', marginBottom: '12px' }}>
                        {suggestedRoles.map((sr, i) => (
                          <button key={i} onClick={() => addSuggestedRole(sr)}
                            style={{ padding: '4px 10px', borderRadius: '16px', border: '1px dashed var(--slate-300)', background: '#FFF', fontSize: '12px', color: 'var(--slate-500)', cursor: 'pointer', fontFamily: 'inherit' }}>
                            + {sr.name}
                          </button>
                        ))}
                      </div>
                    )}
                    
                    <div style={{ display: 'flex', gap: '8px' }}>
                      <input type="text" value={newRoleName} onChange={(e) => setNewRoleName(e.target.value)} placeholder="Add custom role..." className="input" style={{ flex: 1 }} onKeyDown={(e) => e.key === 'Enter' && handleAddCustomRole()} />
                      <label style={{ display: 'flex', alignItems: 'center', gap: '6px', fontSize: '12px', color: 'var(--slate-500)', whiteSpace: 'nowrap' }}>
                        <input type="checkbox" checked={newRoleExternal} onChange={(e) => setNewRoleExternal(e.target.checked)} /> External
                      </label>
                      <button onClick={handleAddCustomRole} className="btn btn-secondary" style={{ padding: '8px 12px' }}>Add</button>
                    </div>
                  </div>
                  
                  <div style={{ display: 'flex', gap: '10px', marginTop: '24px' }}>
                    <button onClick={handleBack} className="btn btn-secondary" style={{ flex: 1 }}>Back</button>
                    <button onClick={() => setWizardStep(3)} className="btn btn-primary" style={{ flex: 1 }} disabled={roles.length < 2}>Continue</button>
                  </div>
                </>
              )}
              
              {/* WIZARD STEP 3: Final Details */}
              {mode === 'wizard' && wizardStep === 3 && (
                <>
                  <div style={{ marginBottom: '20px' }}>
                    <label className="label">Key stages you know about <span style={{ fontWeight: 400, color: 'var(--slate-400)' }}>(optional)</span></label>
                    <textarea
                      value={knownStages}
                      onChange={(e) => setKnownStages(e.target.value)}
                      placeholder="e.g., Discovery, KYC, Fact-find, Advice, Implementation"
                      rows={2}
                      className="input"
                      style={{ resize: 'vertical' }}
                    />
                    <p style={{ fontSize: '11px', color: 'var(--slate-400)', marginTop: '4px' }}>Leave blank to auto-generate based on journey type.</p>
                  </div>
                  
                  <div style={{ padding: '16px', background: 'linear-gradient(135deg, var(--navy-50), var(--steel-100))', borderRadius: '12px', border: '1px solid var(--navy-100)', marginBottom: '20px' }}>
                    <div style={{ display: 'flex', alignItems: 'flex-start', gap: '12px' }}>
                      <span style={{ fontSize: '20px' }}>‚ú®</span>
                      <div style={{ flex: 1 }}>
                        <div style={{ fontWeight: 600, color: 'var(--navy-700)', marginBottom: '4px', fontSize: '14px' }}>AI-Enhanced Generation</div>
                        <div style={{ fontSize: '12px', color: 'var(--slate-600)', marginBottom: '10px' }}>Add your Anthropic API key for intelligent step descriptions and time estimates.</div>
                        <input
                          type="password"
                          placeholder="sk-ant-api03-..."
                          value={apiKey}
                          onChange={(e) => setApiKey(e.target.value)}
                          style={{ width: '100%', padding: '10px 12px', fontSize: '13px', fontFamily: 'monospace', borderRadius: '6px', border: '1px solid var(--slate-200)' }}
                        />
                        <div style={{ fontSize: '11px', color: 'var(--slate-400)', marginTop: '6px' }}>
                          Optional. Without a key, we'll generate a smart template structure. <a href="https://console.anthropic.com/settings/keys" target="_blank" style={{ color: 'var(--steel-600)' }}>Get an API key ‚Üí</a>
                        </div>
                      </div>
                    </div>
                  </div>
                  
                  <div style={{ display: 'flex', gap: '10px' }}>
                    <button onClick={handleBack} className="btn btn-secondary" style={{ flex: 1 }}>Back</button>
                    <button onClick={handleGenerate} className="btn btn-primary" style={{ flex: 1, background: 'linear-gradient(135deg, var(--amber-500), var(--amber-600))' }}>
                      ‚ú® Generate Journey
                    </button>
                  </div>
                </>
              )}
              
              {/* CUSTOMIZE MODE (for templates) */}
              {mode === 'customize' && selectedTemplate && (
                <>
                  <div style={{ display: 'flex', alignItems: 'center', gap: '14px', padding: '14px', background: 'var(--slate-50)', borderRadius: '10px', marginBottom: '20px' }}>
                    <div style={{ fontSize: '32px' }}>{selectedTemplate.icon}</div>
                    <div>
                      <div style={{ fontWeight: 600, color: 'var(--navy-700)', marginBottom: '2px', fontSize: '14px' }}>{selectedTemplate.name}</div>
                      <div style={{ fontSize: '12px', color: 'var(--slate-500)' }}>
                        {selectedTemplate.id === 'blank' ? 'Empty template' : `${selectedTemplate.stageCount} stages ‚Ä¢ ${selectedTemplate.config.personas.length} roles`}
                      </div>
                    </div>
                  </div>
                  
                  <div style={{ marginBottom: '16px' }}>
                    <label className="label">Map Title</label>
                    <input type="text" className="input" value={title} onChange={(e) => setTitle(e.target.value)} placeholder="e.g., Client Onboarding Journey" autoFocus />
                  </div>
                  
                  <div style={{ marginBottom: '24px' }}>
                    <label className="label">Description <span style={{ fontWeight: 400, color: 'var(--slate-400)' }}>(optional)</span></label>
                    <textarea className="input" value={templateDescription} onChange={(e) => setTemplateDescription(e.target.value)} placeholder="Brief description of this journey map" rows={3} style={{ resize: 'vertical' }} />
                  </div>
                  
                  <div style={{ display: 'flex', gap: '10px' }}>
                    <button onClick={onClose} className="btn btn-secondary" style={{ flex: 1 }}>Cancel</button>
                    <button onClick={handleCreateTemplate} className="btn btn-primary" style={{ flex: 1 }} disabled={!title.trim() || isCreating}>
                      {isCreating ? 'Creating...' : 'Create Map'}
                    </button>
                  </div>
                </>
              )}
            </div>
          </div>
        </div>
      );
    }

    // Share Modal - Full Supabase implementation
    function ShareModal({ mapId, maps, onClose, onUpdated }) {
      const { user, profile } = useAuth();
      const map = maps.find(m => m.id === mapId);
      const displayTitle = map?.config?.meta?.title || map?.title || 'Journey Map';
      
      const [shares, setShares] = useState([]);
      const [loading, setLoading] = useState(true);
      const [email, setEmail] = useState('');
      const [permission, setPermission] = useState('view');
      const [sharing, setSharing] = useState(false);
      const [error, setError] = useState(null);
      const [success, setSuccess] = useState(null);
      const [copySuccess, setCopySuccess] = useState(false);
      const [sendNotification, setSendNotification] = useState(true);
      
      useEffect(() => {
        loadShares();
      }, [mapId]);
      
      const loadShares = async () => {
        if (!mapId) return;
        try {
          const { data, error } = await supabase
            .from('journey_map_shares')
            .select(`
              id,
              permission,
              shared_at,
              shared_with_user_id,
              shared_with_email,
              users:shared_with_user_id (
                email,
                display_name
              )
            `)
            .eq('journey_map_id', mapId);
          
          if (error) throw error;
          setShares(data || []);
        } catch (err) {
          console.error('Error loading shares:', err);
        }
        setLoading(false);
      };
      
      // Send email notification via mailto
      const sendShareEmail = (recipientEmail, mapTitle, permissionLevel) => {
        const shareLink = `${window.location.origin}/journeymaps/editor.html?id=${mapId}`;
        const senderName = profile?.display_name || user?.email?.split('@')[0] || 'Someone';
        const permissionText = permissionLevel === 'edit' ? 'edit' : 'view';
        
        const subject = encodeURIComponent(`${senderName} shared "${mapTitle}" with you`);
        const body = encodeURIComponent(`Hi,

${senderName} has shared a journey map with you on FATHOM.

Map: ${mapTitle}
Permission: Can ${permissionText}

View it here:
${shareLink}

FATHOM - Journey intelligence for modern operations`);
        
        window.open(`mailto:${recipientEmail}?subject=${subject}&body=${body}`, '_blank');
      };
      
      const addShare = async (e) => {
        e.preventDefault();
        if (!email.trim()) return;
        
        setSharing(true);
        setError(null);
        setSuccess(null);
        
        try {
          const existingShare = shares.find(s => 
            s.shared_with_email === email.toLowerCase() ||
            s.users?.email === email.toLowerCase()
          );
          
          if (existingShare) {
            throw new Error('This map is already shared with this person');
          }
          
          const { data: existingUser } = await supabase
            .from('users')
            .select('id, email')
            .eq('email', email.toLowerCase())
            .single();
          
          const shareData = {
            journey_map_id: mapId,
            permission,
            shared_by: user?.id,
            shared_at: new Date().toISOString()
          };
          
          if (existingUser) {
            shareData.shared_with_user_id = existingUser.id;
          } else {
            shareData.shared_with_email = email.toLowerCase();
          }
          
          const { error } = await supabase
            .from('journey_map_shares')
            .insert(shareData);
          
          if (error) throw error;
          
          // Send email notification if enabled
          if (sendNotification) {
            sendShareEmail(email, displayTitle, permission);
          }
          
          setSuccess(`Shared with ${email}${sendNotification ? ' - email notification sent' : ''}`);
          setEmail('');
          await loadShares();
        } catch (err) {
          console.error('Share error:', err);
          setError(err.message || 'Failed to share');
        }
        
        setSharing(false);
      };
      
      const removeShare = async (shareId) => {
        try {
          const { error } = await supabase
            .from('journey_map_shares')
            .delete()
            .eq('id', shareId);
          
          if (error) throw error;
          setShares(prev => prev.filter(s => s.id !== shareId));
          setSuccess('Share removed');
          setTimeout(() => setSuccess(null), 2000);
        } catch (err) {
          console.error('Remove error:', err);
          setError('Failed to remove share');
        }
      };
      
      const updatePermission = async (shareId, newPermission) => {
        try {
          const { error } = await supabase
            .from('journey_map_shares')
            .update({ permission: newPermission })
            .eq('id', shareId);
          
          if (error) throw error;
          setShares(prev => prev.map(s => 
            s.id === shareId ? { ...s, permission: newPermission } : s
          ));
        } catch (err) {
          setError('Failed to update permission');
        }
      };
      
      const copyLink = () => {
        const link = `${window.location.origin}/journeymaps/editor.html?id=${mapId}`;
        navigator.clipboard.writeText(link);
        setCopySuccess(true);
        setTimeout(() => setCopySuccess(false), 2000);
      };
      
      const getInitials = (name) => {
        if (!name) return '?';
        return name.split(' ').map(n => n[0]).join('').toUpperCase().slice(0, 2);
      };

      return (
        <div className="modal-overlay" onClick={onClose}>
          <div className="modal" style={{ maxWidth: '500px' }} onClick={e => e.stopPropagation()}>
            <div className="modal-content">
              <div className="modal-header">
                <h2 className="modal-title">üîó Share "{displayTitle}"</h2>
                <button className="modal-close" onClick={onClose}>√ó</button>
              </div>
              
              {/* Copy Link */}
              <div style={{ 
                display: 'flex', 
                gap: '8px', 
                marginBottom: '20px',
                padding: '12px',
                background: 'var(--slate-50)',
                borderRadius: '8px'
              }}>
                <input
                  type="text"
                  readOnly
                  value={`${window.location.origin}/journeymaps/editor.html?id=${mapId}`}
                  style={{ 
                    flex: 1, 
                    padding: '8px 12px', 
                    border: '1px solid var(--slate-200)', 
                    borderRadius: '6px', 
                    fontSize: '12px',
                    fontFamily: 'monospace',
                    background: '#FFF'
                  }}
                />
                <button
                  onClick={copyLink}
                  className="btn btn-primary btn-sm"
                  style={{ whiteSpace: 'nowrap' }}
                >
                  {copySuccess ? '‚úì Copied!' : 'üìã Copy'}
                </button>
              </div>
              
              {/* Add Share Form */}
              <form onSubmit={addShare} style={{ marginBottom: '20px' }}>
                <label className="label">Share with someone</label>
                <div style={{ display: 'flex', gap: '8px', marginBottom: '10px' }}>
                  <input
                    type="email"
                    placeholder="Email address"
                    value={email}
                    onChange={(e) => setEmail(e.target.value)}
                    className="input"
                    style={{ flex: 1 }}
                  />
                  <select
                    value={permission}
                    onChange={(e) => setPermission(e.target.value)}
                    className="input"
                    style={{ width: '120px' }}
                  >
                    <option value="view">Can view</option>
                    <option value="edit">Can edit</option>
                  </select>
                  <button
                    type="submit"
                    disabled={sharing || !email.trim()}
                    className="btn btn-primary"
                  >
                    {sharing ? '...' : 'Share'}
                  </button>
                </div>
                <label style={{ display: 'flex', alignItems: 'center', gap: '8px', fontSize: '13px', color: 'var(--slate-600)', cursor: 'pointer' }}>
                  <input
                    type="checkbox"
                    checked={sendNotification}
                    onChange={(e) => setSendNotification(e.target.checked)}
                    style={{ width: '16px', height: '16px', cursor: 'pointer' }}
                  />
                  üìß Send email notification
                </label>
              </form>
              
              {error && (
                <div style={{ 
                  padding: '10px 14px', 
                  background: 'var(--error-light)', 
                  color: 'var(--error)', 
                  borderRadius: '6px', 
                  marginBottom: '16px',
                  fontSize: '13px'
                }}>
                  {error}
                </div>
              )}
              
              {success && (
                <div style={{ 
                  padding: '10px 14px', 
                  background: 'var(--success-light)', 
                  color: 'var(--success)', 
                  borderRadius: '6px', 
                  marginBottom: '16px',
                  fontSize: '13px'
                }}>
                  {success}
                </div>
              )}
              
              {/* Existing Shares */}
              {shares.length > 0 && (
                <div>
                  <label className="label">Shared with ({shares.length})</label>
                  <div style={{ display: 'flex', flexDirection: 'column', gap: '8px' }}>
                    {shares.map(share => {
                      const displayEmail = share.users?.email || share.shared_with_email;
                      const displayName = share.users?.display_name || displayEmail?.split('@')[0];
                      
                      return (
                        <div 
                          key={share.id}
                          style={{ 
                            display: 'flex', 
                            alignItems: 'center', 
                            justifyContent: 'space-between',
                            padding: '10px 12px',
                            background: 'var(--slate-50)',
                            borderRadius: '8px'
                          }}
                        >
                          <div style={{ display: 'flex', alignItems: 'center', gap: '10px' }}>
                            <div style={{ 
                              width: '32px', 
                              height: '32px', 
                              borderRadius: '50%', 
                              background: 'var(--navy-100)',
                              color: 'var(--navy-700)',
                              display: 'flex',
                              alignItems: 'center',
                              justifyContent: 'center',
                              fontSize: '12px',
                              fontWeight: 600
                            }}>
                              {getInitials(displayName)}
                            </div>
                            <div>
                              <div style={{ fontWeight: 500, fontSize: '14px' }}>{displayName}</div>
                              <div style={{ fontSize: '12px', color: 'var(--slate-500)' }}>{displayEmail}</div>
                            </div>
                          </div>
                          <div style={{ display: 'flex', alignItems: 'center', gap: '8px' }}>
                            <select
                              value={share.permission}
                              onChange={(e) => updatePermission(share.id, e.target.value)}
                              style={{ 
                                padding: '4px 8px', 
                                border: '1px solid var(--slate-200)', 
                                borderRadius: '4px', 
                                fontSize: '12px',
                                background: '#FFF'
                              }}
                            >
                              <option value="view">Can view</option>
                              <option value="edit">Can edit</option>
                            </select>
                            <button
                              onClick={() => sendShareEmail(displayEmail, displayTitle, share.permission)}
                              style={{ 
                                background: 'none', 
                                border: 'none', 
                                color: 'var(--steel-600)', 
                                cursor: 'pointer',
                                fontSize: '14px',
                                padding: '4px'
                              }}
                              title="Send notification email"
                            >
                              üìß
                            </button>
                            <button
                              onClick={() => removeShare(share.id)}
                              style={{ 
                                background: 'none', 
                                border: 'none', 
                                color: 'var(--error)', 
                                cursor: 'pointer',
                                fontSize: '16px',
                                padding: '4px'
                              }}
                              title="Remove share"
                            >
                              √ó
                            </button>
                          </div>
                        </div>
                      );
                    })}
                  </div>
                </div>
              )}
              
              {shares.length === 0 && !loading && (
                <div style={{ 
                  textAlign: 'center', 
                  padding: '24px',
                  color: 'var(--slate-500)',
                  fontSize: '14px'
                }}>
                  This map hasn't been shared with anyone yet
                </div>
              )}
            </div>
          </div>
        </div>
      );
    }

    // ============================================
    // APP
    // ============================================
    function AppContent() {
      const { user, profile, loading } = useAuth();
      
      if (loading) {
        return (
          <div className="loading-screen">
            <img 
              src="https://steveyoung74.github.io/journeymaps/logo_light.png" 
              alt="FATHOM" 
              className="loading-logo"
            />
          </div>
        );
      }
      
      if (!user) {
        return <AuthScreen />;
      }
      
      return <Dashboard />;
    }
    
    function App() {
      return (
        <AuthProvider>
          <AppContent />
        </AuthProvider>
      );
    }
    
    ReactDOM.createRoot(document.getElementById('root')).render(<App />);
  </script>
</body>
</html>
