<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, viewport-fit=cover">
  <title>FATHOM - Dashboard</title>
  <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <style>
    /* Interstate Font Family */
    @font-face {
      font-family: 'Interstate';
      src: url('https://steveyoung74.github.io/journeymaps/fonts/Interstate-light.ttf') format('truetype');
      font-weight: 300;
      font-style: normal;
      font-display: swap;
    }
    @font-face {
      font-family: 'Interstate';
      src: url('https://steveyoung74.github.io/journeymaps/fonts/Interstate-regular.ttf') format('truetype');
      font-weight: 400;
      font-style: normal;
      font-display: swap;
    }
    @font-face {
      font-family: 'Interstate';
      src: url('https://steveyoung74.github.io/journeymaps/fonts/Interstate-bold.ttf') format('truetype');
      font-weight: 700;
      font-style: normal;
      font-display: swap;
    }
    
    /* CSS Custom Properties */
    :root {
      --navy-950: #0C1620;
      --navy-900: #111E2E;
      --navy-800: #15243A;
      --navy-700: #192B45;
      --navy-600: #243D5C;
      --navy-500: #2F5070;
      --navy-400: #456A8A;
      --navy-300: #6889A8;
      --navy-200: #9BB1C7;
      --navy-100: #C8D5E2;
      --navy-50: #E9EEF4;
      --steel-700: #3A6070;
      --steel-600: #4A7485;
      --steel-500: #5B8A9A;
      --steel-400: #74A0AE;
      --steel-300: #96BCC7;
      --steel-100: #E1EEF2;
      --amber-700: #8B6914;
      --amber-600: #A67D1D;
      --amber-500: #C4942A;
      --amber-400: #D4A84A;
      --amber-200: #E8D5A3;
      --amber-100: #FAF0D6;
      --success: #2D8A6E;
      --success-light: #D4EDE5;
      --error: #B84A5A;
      --error-light: #F5E0E3;
      --slate-900: #1A2332;
      --slate-700: #3D4A5C;
      --slate-600: #556275;
      --slate-500: #6E7B8C;
      --slate-400: #8A95A5;
      --slate-300: #A9B2BE;
      --slate-200: #C8CED6;
      --slate-100: #E4E7EB;
      --slate-50: #F4F5F7;
    }
    
    /* Base Reset - Mobile First */
    * { box-sizing: border-box; margin: 0; padding: 0; }
    html, body {
      width: 100%;
      max-width: 100%;
      overflow-x: hidden;
      
    }
    body { 
      font-family: 'Interstate', -apple-system, BlinkMacSystemFont, sans-serif; 
      background: var(--slate-50);
      color: var(--slate-900);
      line-height: 1.6;
      min-height: 100vh;
    }
    
    /* Buttons */
    .btn { 
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      padding: 12px 20px; 
      border-radius: 8px; 
      font-size: 14px; 
      font-weight: 500; 
      cursor: pointer; 
      transition: all 0.2s;
      border: none;
      font-family: inherit;
      text-decoration: none;
    }
    .btn:disabled { opacity: 0.5; cursor: not-allowed; }
    .btn-primary { background: var(--navy-700); color: #FFF; }
    .btn-primary:hover:not(:disabled) { background: var(--navy-800); }
    .btn-secondary { background: #FFF; color: var(--navy-700); border: 2px solid var(--navy-700); }
    .btn-secondary:hover:not(:disabled) { background: var(--navy-50); }
    .btn-ghost { background: transparent; color: var(--slate-600); }
    .btn-ghost:hover:not(:disabled) { background: var(--slate-100); }
    
    /* Form Elements */
    .input {
      width: 100%;
      padding: 12px 14px;
      border: 1px solid var(--slate-200);
      border-radius: 8px;
      font-size: 15px;
      font-family: inherit;
      transition: border-color 0.15s, box-shadow 0.15s;
    }
    .input:focus { 
      outline: none;
      border-color: var(--steel-500); 
      box-shadow: 0 0 0 3px rgba(91, 138, 154, 0.15);
    }
    .label {
      display: block;
      font-size: 14px;
      font-weight: 500;
      color: var(--slate-700);
      margin-bottom: 6px;
    }
    
    /* Cards */
    .card {
      background: #FFF;
      border-radius: 12px;
      box-shadow: 0 2px 12px rgba(25, 43, 69, 0.06);
      border: 1px solid var(--slate-100);
    }
    
    /* Badge */
    .badge {
      display: inline-flex;
      align-items: center;
      padding: 4px 10px;
      border-radius: 16px;
      font-size: 11px;
      font-weight: 500;
    }
    .badge-owner { background: var(--steel-100); color: var(--navy-600); }
    .badge-edit { background: var(--success-light); color: var(--success); }
    .badge-view { background: var(--slate-100); color: var(--slate-600); }
    
    /* Utility */
    .text-muted { color: var(--slate-500); }
    .text-small { font-size: 13px; }
    
    /* Page Layout */
    .page-container {
      min-height: 100vh;
      display: flex;
      flex-direction: column;
    }
    .page-container::before {
      content: '';
      position: fixed;
      inset: 0;
      background: url('https://steveyoung74.github.io/journeymaps/topography-light.svg') center/600px 600px repeat;
      opacity: 1;
      pointer-events: none;
      z-index: -1;
    }
    
    /* Navigation */
    .nav {
      background: linear-gradient(135deg, var(--navy-700) 0%, var(--navy-900) 100%);
      position: sticky;
      top: 0;
      z-index: 100;
    }
    .nav::before {
      content: '';
      position: absolute;
      inset: 0;
      background: url('https://steveyoung74.github.io/journeymaps/topography-dark.svg') center/600px 600px repeat;
      opacity: 1;
      pointer-events: none;
      z-index: 0;
    }
    .nav-inner {
      max-width: 1200px;
      margin: 0 auto;
      padding: 0 24px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      height: 64px;
      position: relative;
      z-index: 1;
    }
    .nav-logo { height: 26px; }
    .nav-left {
      display: flex;
      align-items: center;
      gap: 32px;
    }
    .nav-links {
      display: none;
      align-items: center;
      gap: 4px;
    }
    .nav-link {
      color: rgba(255,255,255,0.7);
      text-decoration: none;
      padding: 8px 16px;
      border-radius: 6px;
      font-size: 14px;
      font-weight: 500;
      transition: all 0.15s;
    }
    .nav-link:hover { color: #FFF; background: rgba(255,255,255,0.1); }
    .nav-link.active { color: #FFF; background: rgba(255,255,255,0.15); }
    .nav-right {
      display: none;
      align-items: center;
      gap: 16px;
    }
    .nav-user {
      color: rgba(255,255,255,0.8);
      font-size: 14px;
    }
    .nav-signout {
      color: rgba(255,255,255,0.6);
      background: rgba(255,255,255,0.1);
      border: 1px solid rgba(255,255,255,0.2);
      padding: 6px 14px;
      border-radius: 6px;
      font-size: 13px;
      cursor: pointer;
      font-family: inherit;
      transition: all 0.15s;
    }
    .nav-signout:hover { background: rgba(255,255,255,0.2); color: #FFF; }
    
    /* Mobile hamburger */
    .nav-mobile-toggle {
      display: flex;
      align-items: center;
      justify-content: center;
      background: none;
      border: none;
      color: #FFF;
      font-size: 24px;
      cursor: pointer;
      padding: 8px;
      line-height: 1;
    }
    
    /* Mobile Menu Overlay */
    .nav-mobile-menu {
      display: none;
      position: fixed;
      inset: 0;
      background: rgba(12, 22, 32, 0.98);
      z-index: 1000;
      flex-direction: column;
      padding: 20px;
    }
    .nav-mobile-menu.open { display: flex; }
    .nav-mobile-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 32px;
    }
    .nav-mobile-close {
      background: none;
      border: none;
      color: #FFF;
      font-size: 32px;
      cursor: pointer;
      padding: 4px 8px;
      line-height: 1;
    }
    .nav-mobile-links {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }
    .nav-mobile-link {
      color: rgba(255,255,255,0.8);
      text-decoration: none;
      padding: 14px 16px;
      border-radius: 8px;
      font-size: 16px;
      font-weight: 500;
    }
    .nav-mobile-link:hover, .nav-mobile-link.active {
      background: rgba(255,255,255,0.1);
      color: #FFF;
    }
    .nav-mobile-divider {
      height: 1px;
      background: rgba(255,255,255,0.1);
      margin: 12px 0;
    }
    .nav-mobile-user {
      margin-top: auto;
      padding-top: 20px;
      border-top: 1px solid rgba(255,255,255,0.1);
    }
    .nav-mobile-user-name {
      color: rgba(255,255,255,0.6);
      font-size: 13px;
      margin-bottom: 12px;
    }
    .nav-mobile-signout {
      width: 100%;
      padding: 12px;
      background: rgba(255,255,255,0.1);
      border: 1px solid rgba(255,255,255,0.2);
      color: #FFF;
      border-radius: 8px;
      font-size: 14px;
      cursor: pointer;
      font-family: inherit;
    }
    
    /* Main Content */
    main {
      flex: 1;
      padding: 32px 24px;
    }
    .main-inner {
      max-width: 1200px;
      margin: 0 auto;
    }
    
    /* Dashboard Header */
    .dash-header {
      margin-bottom: 24px;
    }
    .dash-title {
      font-size: 24px;
      font-weight: 400;
      color: var(--navy-700);
      margin-bottom: 4px;
    }
    .dash-subtitle {
      color: var(--slate-500);
      font-size: 14px;
    }
    .dash-header-row {
      display: flex;
      flex-direction: column;
      gap: 16px;
      margin-bottom: 20px;
    }
    
    /* Tabs */
    .tabs {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      margin-bottom: 20px;
      padding-bottom: 16px;
      border-bottom: 1px solid var(--slate-200);
    }
    .tab-btn {
      padding: 8px 16px;
      background: transparent;
      color: var(--slate-600);
      border: none;
      border-radius: 6px;
      cursor: pointer;
      font-family: inherit;
      font-size: 14px;
      font-weight: 500;
      transition: all 0.15s;
    }
    .tab-btn:hover { background: var(--slate-100); }
    .tab-btn.active {
      background: var(--navy-700);
      color: #FFF;
    }
    
    /* Journey Cards Grid */
    .cards-grid {
      display: grid;
      grid-template-columns: 1fr;
      gap: 16px;
    }
    .journey-card {
      padding: 20px;
      cursor: pointer;
      transition: all 0.2s;
      position: relative;
    }
    .journey-card:hover {
      box-shadow: 0 4px 20px rgba(25, 43, 69, 0.1);
    }
    .journey-card-header {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      margin-bottom: 8px;
    }
    .journey-card-title {
      font-size: 16px;
      font-weight: 600;
      color: var(--navy-700);
      line-height: 1.3;
      padding-right: 40px;
    }
    .journey-card-icons {
      display: flex;
      gap: 4px;
      font-size: 14px;
      position: absolute;
      top: 16px;
      right: 16px;
    }
    .journey-card-desc {
      color: var(--slate-500);
      font-size: 13px;
      margin-bottom: 12px;
      line-height: 1.4;
    }
    .journey-card-metrics {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
      padding: 10px 12px;
      background: var(--slate-50);
      border-radius: 8px;
      margin-bottom: 12px;
    }
    .metric {
      display: flex;
      align-items: center;
      gap: 4px;
      font-size: 12px;
    }
    .metric-value { font-weight: 600; color: var(--navy-700); }
    .metric-dot { color: var(--slate-300); }
    .journey-card-footer {
      display: flex;
      flex-wrap: wrap;
      justify-content: space-between;
      align-items: center;
      gap: 8px;
    }
    .journey-card-date {
      color: var(--slate-400);
      font-size: 12px;
    }
    .journey-card-actions {
      display: flex;
      gap: 4px;
    }
    .journey-card-actions .btn {
      padding: 6px 10px;
      font-size: 12px;
    }
    
    /* Modal */
    .modal-overlay {
      position: fixed;
      inset: 0;
      background: rgba(12, 22, 32, 0.7);
      backdrop-filter: blur(4px);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 1000;
      padding: 16px;
    }
    .modal {
      background: #FFF;
      border-radius: 16px;
      width: 100%;
      max-width: 420px;
      max-height: 90vh;
      overflow-y: auto;
    }
    .modal-content { padding: 24px; }
    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
    }
    .modal-close {
      background: none;
      border: none;
      font-size: 28px;
      color: var(--slate-400);
      cursor: pointer;
      padding: 4px;
      line-height: 1;
    }
    .modal-title {
      font-size: 22px;
      font-weight: 400;
      color: var(--navy-700);
      margin-bottom: 6px;
    }
    
    /* Footer */
    .footer {
      background: var(--navy-950);
      color: rgba(255,255,255,0.4);
      padding: 32px 24px;
    }
    .footer-inner {
      max-width: 1200px;
      margin: 0 auto;
      display: flex;
      justify-content: space-between;
      align-items: center;
      flex-wrap: wrap;
      gap: 16px;
    }
    .footer-brand {
      display: flex;
      align-items: center;
      gap: 12px;
    }
    .footer-logo {
      height: 20px;
      opacity: 0.5;
    }
    .footer-version {
      font-size: 11px;
      opacity: 0.6;
    }
    .footer-copy {
      font-size: 13px;
    }
    
    /* Dropdown */
    .dropdown {
      position: relative;
    }
    .dropdown-menu {
      position: absolute;
      top: 100%;
      left: 0;
      background: #FFF;
      border-radius: 8px;
      box-shadow: 0 4px 20px rgba(0,0,0,0.15);
      min-width: 160px;
      padding: 6px 0;
      opacity: 0;
      visibility: hidden;
      transform: translateY(8px);
      transition: all 0.2s;
      z-index: 50;
    }
    .dropdown:hover .dropdown-menu {
      opacity: 1;
      visibility: visible;
      transform: translateY(4px);
    }
    .dropdown-item {
      display: block;
      padding: 10px 16px;
      color: var(--slate-700);
      text-decoration: none;
      font-size: 14px;
      transition: background 0.1s;
    }
    .dropdown-item:hover { background: var(--slate-50); }
    
    /* ============================================
       TABLET AND UP (768px+)
       ============================================ */
    @media (min-width: 768px) {
      .nav-links { display: flex; }
      .nav-right { display: flex; }
      .nav-mobile-toggle { display: none; }
      
      main { padding: 32px 24px; }
      
      .dash-header-row {
        flex-direction: row;
        justify-content: space-between;
        align-items: center;
      }
      .dash-title { font-size: 28px; }
      
      .cards-grid {
        grid-template-columns: repeat(2, 1fr);
        gap: 20px;
      }
      
      .journey-card { padding: 24px; }
      .journey-card-title { font-size: 17px; }
    }
    
    /* ============================================
       DESKTOP (1024px+)
       ============================================ */
    @media (min-width: 1024px) {
      main { padding: 40px; }
      
      .dash-title { font-size: 32px; }
      
      .cards-grid {
        grid-template-columns: repeat(3, 1fr);
        gap: 24px;
      }
    }
  </style>
</head>
<body>
  <div id="root"></div>
  
  <script type="text/babel">
    const { useState, useEffect } = React;
    
    // GitHub configuration
    const GITHUB_CONFIG = {
      owner: 'steveyoung74',
      repo: 'journeymaps',
      branch: 'main',
      mapsPath: 'maps',
      indexFile: 'maps/index.json'
    };
    
    const getRawUrl = (path) => 
      `https://raw.githubusercontent.com/${GITHUB_CONFIG.owner}/${GITHUB_CONFIG.repo}/${GITHUB_CONFIG.branch}/${path}`;
    
    const getApiUrl = (path) => 
      `https://api.github.com/repos/${GITHUB_CONFIG.owner}/${GITHUB_CONFIG.repo}/contents/${path}`;
    
    async function fetchFromGitHub(path) {
      const cacheBust = `${Date.now()}-${Math.random().toString(36).substr(2, 9)}`;
      const url = getRawUrl(path) + '?t=' + cacheBust;
      const response = await fetch(url);
      if (!response.ok) {
        if (response.status === 404) return null;
        throw new Error(`GitHub fetch failed: ${response.status}`);
      }
      return response.json();
    }
    
    async function saveToGitHub(path, content, token, message = 'Update from Fathom') {
      const apiUrl = getApiUrl(path);
      let sha = null;
      
      try {
        const existingResponse = await fetch(apiUrl, {
          headers: { 'Authorization': `token ${token}` }
        });
        if (existingResponse.ok) {
          const existing = await existingResponse.json();
          sha = existing.sha;
        }
      } catch (e) {}
      
      const body = {
        message,
        content: btoa(unescape(encodeURIComponent(JSON.stringify(content, null, 2)))),
        branch: GITHUB_CONFIG.branch
      };
      if (sha) body.sha = sha;
      
      const response = await fetch(apiUrl, {
        method: 'PUT',
        headers: {
          'Authorization': `token ${token}`,
          'Content-Type': 'application/json'
        },
        body: JSON.stringify(body)
      });
      
      if (!response.ok) {
        const error = await response.json();
        throw new Error(error.message || 'Failed to save');
      }
      
      return response.json();
    }
    
    async function deleteFromGitHub(path, token, message = 'Delete from Fathom') {
      const apiUrl = getApiUrl(path);
      const existingResponse = await fetch(apiUrl, {
        headers: { 'Authorization': `token ${token}` }
      });
      if (!existingResponse.ok) throw new Error('File not found');
      const existing = await existingResponse.json();
      
      const response = await fetch(apiUrl, {
        method: 'DELETE',
        headers: {
          'Authorization': `token ${token}`,
          'Content-Type': 'application/json'
        },
        body: JSON.stringify({
          message,
          sha: existing.sha,
          branch: GITHUB_CONFIG.branch
        })
      });
      
      if (!response.ok) throw new Error('Failed to delete');
      return true;
    }
    
    // Utility functions
    const formatTime = (minutes) => {
      if (!minutes) return '0m';
      const h = Math.floor(minutes / 60);
      const m = Math.round(minutes % 60);
      if (h === 0) return `${m}m`;
      if (m === 0) return `${h}h`;
      return `${h}h ${m}m`;
    };
    
    const formatCurrency = (amount) => {
      if (amount === null || amount === undefined) return '‚Äî';
      return '¬£' + amount.toLocaleString('en-GB', { minimumFractionDigits: 0, maximumFractionDigits: 0 });
    };
    
    const formatDate = (dateStr) => {
      if (!dateStr) return '';
      const date = new Date(dateStr);
      return date.toLocaleDateString('en-GB', { day: '2-digit', month: '2-digit', year: 'numeric' });
    };
    
    // ============================================
    // LOGIN MODAL
    // ============================================
    function LoginModal({ onLogin }) {
      const [name, setName] = useState('');
      const [email, setEmail] = useState('');
      const [token, setToken] = useState('');
      const [error, setError] = useState('');
      const [isLoading, setIsLoading] = useState(false);

      const handleSubmit = async (e) => {
        e.preventDefault();
        if (!name.trim() || !email.trim()) {
          setError('Please enter your name and email');
          return;
        }
        if (!email.includes('@')) {
          setError('Please enter a valid email');
          return;
        }
        setIsLoading(true);
        await onLogin({ name: name.trim(), email: email.trim().toLowerCase() }, token.trim());
        setIsLoading(false);
      };

      return (
        <div className="modal-overlay">
          <div className="modal">
            <div className="modal-content">
              <div className="modal-header">
                <img src="https://steveyoung74.github.io/journeymaps/logo_dark.png" alt="FATHOM" style={{ height: '28px' }} />
              </div>
              
              <h2 className="modal-title">Welcome to Fathom</h2>
              <p className="text-muted" style={{ marginBottom: '24px', fontSize: '14px' }}>Enter your details to access your journey maps</p>

              {error && (
                <div style={{ padding: '12px 14px', background: 'var(--error-light)', borderRadius: '8px', marginBottom: '16px', color: 'var(--error)', fontSize: '13px' }}>
                  {error}
                </div>
              )}

              <form onSubmit={handleSubmit}>
                <div style={{ marginBottom: '16px' }}>
                  <label className="label">Your Name</label>
                  <input
                    type="text"
                    className="input"
                    value={name}
                    onChange={(e) => setName(e.target.value)}
                    placeholder="Steve Young"
                    autoFocus
                  />
                </div>

                <div style={{ marginBottom: '16px' }}>
                  <label className="label">Email Address</label>
                  <input
                    type="email"
                    className="input"
                    value={email}
                    onChange={(e) => setEmail(e.target.value)}
                    placeholder="steve@company.com"
                  />
                </div>

                <div style={{ marginBottom: '24px' }}>
                  <label className="label">GitHub Token <span style={{ fontWeight: 400, color: 'var(--slate-400)' }}>(optional)</span></label>
                  <input
                    type="password"
                    className="input"
                    value={token}
                    onChange={(e) => setToken(e.target.value)}
                    placeholder="ghp_xxxxxxxxxxxx"
                  />
                  <p className="text-muted text-small" style={{ marginTop: '6px' }}>
                    Required to create and edit maps.
                  </p>
                </div>

                <button type="submit" className="btn btn-primary" style={{ width: '100%', padding: '14px' }} disabled={isLoading}>
                  {isLoading ? 'Signing in...' : 'Sign In'}
                </button>
              </form>
            </div>
          </div>
        </div>
      );
    }
    
    // ============================================
    // DASHBOARD
    // ============================================
    function Dashboard({ user, token, onLogout, onUpdateToken }) {
      const [maps, setMaps] = useState([]);
      const [mapConfigs, setMapConfigs] = useState({});
      const [loading, setLoading] = useState(true);
      const [error, setError] = useState('');
      const [showCreateModal, setShowCreateModal] = useState(false);
      const [showShareModal, setShowShareModal] = useState(null);
      const [showTokenModal, setShowTokenModal] = useState(false);
      const [activeTab, setActiveTab] = useState('my-maps');
      const [showMobileMenu, setShowMobileMenu] = useState(false);

      useEffect(() => {
        window.scrollTo(0, 0);
        fetchMaps();
      }, []);

      useEffect(() => {
        if (maps.length > 0) fetchMapConfigs();
      }, [maps]);

      const fetchMaps = async () => {
        setLoading(true);
        try {
          const index = await fetchFromGitHub(GITHUB_CONFIG.indexFile);
          setMaps(index?.maps || []);
        } catch (err) {
          setError('Failed to load maps');
        }
        setLoading(false);
      };

      const fetchMapConfigs = async () => {
        const configs = {};
        for (const map of maps) {
          try {
            const config = await fetchFromGitHub(`${GITHUB_CONFIG.mapsPath}/${map.id}.json`);
            if (config) configs[map.id] = config;
          } catch (err) {}
        }
        setMapConfigs(configs);
      };

      const getMapMetrics = (mapId) => {
        const config = mapConfigs[mapId];
        if (!config?.stages) return null;
        
        const allSteps = config.stages.flatMap(s => s.steps || []);
        const totalTime = allSteps.reduce((acc, s) => acc + (s.timeMinutes || s.duration || 0), 0);
        const totalPainPoints = allSteps.reduce((acc, s) => acc + (s.painPoints?.length || 0), 0);
        const highImprovements = allSteps.filter(s => s.automationOpportunity === 'high').length;
        
        const frictionMap = { none: 1, low: 2, medium: 3, high: 4, extreme: 5 };
        const frictionValues = allSteps.map(s => s.frictionScore || frictionMap[s.friction]).filter(Boolean);
        const avgFriction = frictionValues.length ? (frictionValues.reduce((a, b) => a + b, 0) / frictionValues.length).toFixed(1) : null;
        
        let totalCost = null;
        if (config.personas?.length) {
          totalCost = 0;
          allSteps.forEach(step => {
            const persona = config.personas.find(p => p.id === (step.owner || step.personaId));
            if (persona?.salary) {
              const hourlyRate = (persona.salary * (persona.burdenMultiplier || 1.4)) / (52 * 37.5);
              totalCost += ((step.timeMinutes || step.duration || 0) / 60) * hourlyRate;
            }
          });
        }
        
        return { totalTime, totalSteps: allSteps.length, stageCount: config.stages.length, totalPainPoints, highImprovements, avgFriction, totalCost };
      };

      // Calculate hourly rate from annual salary
      const calculateHourlyRate = (salary, burdenMultiplier = 1.4) => {
        return (salary * burdenMultiplier) / (52 * 37.5);
      };

      // Calculate step cost
      const calculateStepCost = (step, personas) => {
        if (!personas || !step.roleInvolvement) return 0;
        return Object.entries(step.roleInvolvement).reduce((total, [personaId, inv]) => {
          const persona = personas.find(p => p.id === personaId);
          if (!persona || !persona.salary) return total;
          const hourlyRate = calculateHourlyRate(persona.salary || persona.annualSalary, persona.burdenMultiplier);
          return total + (inv.timeMinutes / 60) * hourlyRate * (inv.headcount || 1);
        }, 0);
      };

      // Generate comprehensive report
      const generateReport = (mapId) => {
        const config = mapConfigs[mapId];
        const map = maps.find(m => m.id === mapId);
        if (!config) {
          alert('Report data not loaded yet. Please try again.');
          return;
        }

        const printWindow = window.open('', '_blank');
        if (!printWindow) {
          alert('Please allow popups to generate the report');
          return;
        }

        const allSteps = config.stages.flatMap((stage, si) => 
          stage.steps.map((step, sti) => ({ ...step, stageName: stage.name, stageIndex: si, stepIndex: sti }))
        );

        // Calculate totals
        const totalTime = allSteps.reduce((acc, s) => acc + (s.timeMinutes || 0), 0);
        const totalPainPoints = allSteps.reduce((acc, s) => acc + (s.painPoints?.length || 0), 0);
        const highAutomationCount = allSteps.filter(s => s.automationOpportunity === 'high').length;
        const frictionMap = { none: 1, low: 2, medium: 3, high: 4, extreme: 5 };
        const frictionValues = allSteps.map(s => s.frictionScore || frictionMap[s.friction]).filter(Boolean);
        const avgFriction = frictionValues.length ? (frictionValues.reduce((a, b) => a + b, 0) / frictionValues.length).toFixed(1) : 'N/A';

        // Calculate costs
        let totalCost = 0;
        const hasCostData = config.personas?.some(p => p.salary || p.annualSalary);
        if (hasCostData) {
          allSteps.forEach(step => {
            totalCost += calculateStepCost(step, config.personas);
          });
        }

        // Calculate potential savings
        const potentialSavings = allSteps.reduce((acc, s) => {
          const cost = calculateStepCost(s, config.personas);
          if (s.automationOpportunity === 'high') return acc + cost * 0.7;
          if (s.automationOpportunity === 'medium') return acc + cost * 0.4;
          if (s.automationOpportunity === 'low') return acc + cost * 0.1;
          return acc;
        }, 0);

        // Stage metrics
        const stageMetrics = config.stages.map(stage => {
          const stageSteps = stage.steps || [];
          const stageTime = stageSteps.reduce((acc, s) => acc + (s.timeMinutes || 0), 0);
          const stageCost = stageSteps.reduce((acc, s) => acc + calculateStepCost(s, config.personas), 0);
          const stagePainPoints = stageSteps.reduce((acc, s) => acc + (s.painPoints?.length || 0), 0);
          const stageFrictionValues = stageSteps.map(s => s.frictionScore || frictionMap[s.friction]).filter(Boolean);
          const avgStageFriction = stageFrictionValues.length ? (stageFrictionValues.reduce((a, b) => a + b, 0) / stageFrictionValues.length).toFixed(1) : 'N/A';
          return { name: stage.name, stepCount: stageSteps.length, time: stageTime, cost: stageCost, painPoints: stagePainPoints, avgFriction: avgStageFriction, dropOffCount: stage.dropOffCount || 0 };
        });

        // Role costs
        const roleCosts = (config.personas || []).filter(p => !p.isExternal && (p.salary || p.annualSalary)).map(persona => {
          let roleTime = 0;
          let roleCost = 0;
          allSteps.forEach(step => {
            const inv = step.roleInvolvement?.[persona.id];
            if (inv) {
              roleTime += inv.timeMinutes || 0;
              const hourlyRate = calculateHourlyRate(persona.salary || persona.annualSalary, persona.burdenMultiplier);
              roleCost += (inv.timeMinutes / 60) * hourlyRate * (inv.headcount || 1);
            }
          });
          return { label: persona.label || persona.name, color: persona.color, totalMinutes: roleTime, totalCost: roleCost };
        }).filter(r => r.totalCost > 0).sort((a, b) => b.totalCost - a.totalCost);

        // Top expensive steps
        const topExpensiveSteps = allSteps.map(s => ({ ...s, cost: calculateStepCost(s, config.personas) })).sort((a, b) => b.cost - a.cost).slice(0, 5);
        
        // Top improvement opportunities
        const topImprovements = allSteps.filter(s => s.automationOpportunity === 'high' || s.automationOpportunity === 'medium').map(s => {
          const cost = calculateStepCost(s, config.personas);
          const savings = s.automationOpportunity === 'high' ? cost * 0.7 : cost * 0.4;
          return { ...s, cost, savings };
        }).sort((a, b) => b.savings - a.savings).slice(0, 8);

        const date = new Date().toLocaleDateString('en-GB', { day: 'numeric', month: 'long', year: 'numeric' });
        const title = config.meta?.title || map?.title || 'Journey Map';

        // Build HTML using arrays to avoid nested template literals
        const parts = [];
        
        parts.push('<!DOCTYPE html><html><head><meta charset="UTF-8"><title>' + title + ' - Complete Report</title>');
        parts.push('<style>');
        parts.push('@page { margin: 15mm; size: A4; }');
        parts.push('* { box-sizing: border-box; margin: 0; padding: 0; }');
        parts.push('body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif; color: #1F2937; line-height: 1.5; padding: 32px 40px; max-width: 1000px; margin: 0 auto; font-size: 12px; }');
        parts.push('.header { background: #192B45; color: #FFF; padding: 24px 28px; border-radius: 8px; margin-bottom: 24px; display: flex; justify-content: space-between; align-items: center; }');
        parts.push('.header h1 { font-size: 24px; font-weight: 600; margin-bottom: 4px; }');
        parts.push('.header .subtitle { font-size: 14px; opacity: 0.8; }');
        parts.push('.header .meta { text-align: right; font-size: 11px; opacity: 0.7; }');
        parts.push('.section { margin-bottom: 28px; page-break-inside: avoid; }');
        parts.push('.section-title { font-size: 16px; font-weight: 600; color: #192B45; margin-bottom: 12px; padding-bottom: 6px; border-bottom: 2px solid #2D8A6E; }');
        parts.push('.summary-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 12px; margin-bottom: 20px; }');
        parts.push('.summary-grid.cols-3 { grid-template-columns: repeat(3, 1fr); }');
        parts.push('.summary-card { background: #F8FAFC; border: 1px solid #E2E8F0; border-radius: 8px; padding: 14px; text-align: center; }');
        parts.push('.summary-card.highlight-green { background: #D1FAE5; border-color: #A7F3D0; }');
        parts.push('.summary-card.highlight-red { background: #FEE2E2; border-color: #FECACA; }');
        parts.push('.summary-card.highlight-amber { background: #FEF3C7; border-color: #FDE68A; }');
        parts.push('.summary-value { font-size: 20px; font-weight: 700; color: #192B45; }');
        parts.push('.summary-label { font-size: 9px; color: #64748B; text-transform: uppercase; letter-spacing: 0.5px; margin-top: 4px; }');
        parts.push('table { width: 100%; border-collapse: collapse; font-size: 11px; margin-bottom: 16px; }');
        parts.push('th, td { padding: 8px 10px; text-align: left; border-bottom: 1px solid #E2E8F0; }');
        parts.push('th { background: #F8FAFC; font-weight: 600; color: #475569; font-size: 9px; text-transform: uppercase; }');
        parts.push('.num { text-align: right; }');
        parts.push('.text-green { color: #059669; }');
        parts.push('.text-red { color: #DC2626; }');
        parts.push('.two-column { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }');
        parts.push('.stage-header { background: #2D8A6E; color: #FFF; padding: 10px 14px; border-radius: 6px 6px 0 0; display: flex; justify-content: space-between; font-size: 12px; }');
        parts.push('.badge { display: inline-block; padding: 2px 8px; border-radius: 10px; font-size: 10px; font-weight: 500; }');
        parts.push('.badge-high { background: #D1FAE5; color: #059669; }');
        parts.push('.badge-medium { background: #FEF3C7; color: #D97706; }');
        parts.push('.badge-low { background: #E2E8F0; color: #64748B; }');
        parts.push('.rpt-footer { margin-top: 32px; padding-top: 16px; border-top: 1px solid #C8CED6; font-size: 10px; color: #8A95A5; text-align: center; }');
        parts.push('@media print { .page-break { page-break-before: always; } }');
        parts.push('</style></head><body>');

        // Header
        parts.push('<div class="header"><div><h1>' + title + '</h1><div class="subtitle">Complete Journey Analysis Report</div></div>');
        parts.push('<div class="meta">Generated: ' + date + '<br/>Version: ' + (config.meta?.version || '1.0') + '</div></div>');

        // Executive Summary
        parts.push('<div class="section"><div class="section-title">üìä Executive Summary</div>');
        parts.push('<div class="summary-grid">');
        parts.push('<div class="summary-card"><div class="summary-value">' + config.stages.length + '</div><div class="summary-label">Stages</div></div>');
        parts.push('<div class="summary-card"><div class="summary-value">' + allSteps.length + '</div><div class="summary-label">Steps</div></div>');
        parts.push('<div class="summary-card"><div class="summary-value">' + formatTime(totalTime) + '</div><div class="summary-label">Total Time</div></div>');
        parts.push('<div class="summary-card highlight-amber"><div class="summary-value">' + (hasCostData ? formatCurrency(totalCost) : 'N/A') + '</div><div class="summary-label">Total Cost</div></div>');
        parts.push('</div>');
        parts.push('<div class="summary-grid">');
        parts.push('<div class="summary-card highlight-red"><div class="summary-value">' + totalPainPoints + '</div><div class="summary-label">Pain Points</div></div>');
        parts.push('<div class="summary-card"><div class="summary-value">' + avgFriction + '/5</div><div class="summary-label">Avg Friction</div></div>');
        parts.push('<div class="summary-card"><div class="summary-value">' + highAutomationCount + '</div><div class="summary-label">High Improvement Opps</div></div>');
        parts.push('<div class="summary-card highlight-green"><div class="summary-value">' + (hasCostData ? formatCurrency(potentialSavings) : 'N/A') + '</div><div class="summary-label">Potential Savings</div></div>');
        parts.push('</div></div>');

        // Timeline Analysis
        parts.push('<div class="section"><div class="section-title">‚è±Ô∏è Timeline Analysis</div>');
        parts.push('<table><thead><tr><th>Stage</th><th class="num">Steps</th><th class="num">Time</th><th class="num">% of Total</th><th class="num">Avg Friction</th><th class="num">Pain Points</th></tr></thead><tbody>');
        stageMetrics.forEach(function(s) {
          var pct = totalTime > 0 ? ((s.time / totalTime) * 100).toFixed(1) : 0;
          parts.push('<tr><td>' + s.name + '</td><td class="num">' + s.stepCount + '</td><td class="num">' + formatTime(s.time) + '</td><td class="num">' + pct + '%</td><td class="num">' + s.avgFriction + '/5</td><td class="num">' + s.painPoints + '</td></tr>');
        });
        parts.push('<tr style="font-weight:600;background:#F8FAFC"><td>Total</td><td class="num">' + allSteps.length + '</td><td class="num">' + formatTime(totalTime) + '</td><td class="num">100%</td><td class="num">' + avgFriction + '/5</td><td class="num">' + totalPainPoints + '</td></tr>');
        parts.push('</tbody></table></div>');

        // Cost Analysis
        if (hasCostData) {
          parts.push('<div class="section"><div class="section-title">üí∞ Cost Analysis</div>');
          parts.push('<div class="two-column"><div><h4 style="font-size:12px;margin-bottom:8px;color:#475569">Cost by Stage</h4>');
          parts.push('<table><thead><tr><th>Stage</th><th class="num">Time</th><th class="num">Cost</th><th class="num">%</th></tr></thead><tbody>');
          stageMetrics.forEach(function(s) {
            var pct = totalCost > 0 ? ((s.cost / totalCost) * 100).toFixed(1) : 0;
            parts.push('<tr><td>' + s.name + '</td><td class="num">' + formatTime(s.time) + '</td><td class="num">' + formatCurrency(s.cost) + '</td><td class="num">' + pct + '%</td></tr>');
          });
          parts.push('</tbody></table></div>');
          
          parts.push('<div><h4 style="font-size:12px;margin-bottom:8px;color:#475569">Cost by Role</h4>');
          parts.push('<table><thead><tr><th>Role</th><th class="num">Time</th><th class="num">Cost</th><th class="num">%</th></tr></thead><tbody>');
          roleCosts.forEach(function(r) {
            var pct = totalCost > 0 ? ((r.totalCost / totalCost) * 100).toFixed(1) : 0;
            parts.push('<tr><td>' + r.label + '</td><td class="num">' + formatTime(r.totalMinutes) + '</td><td class="num">' + formatCurrency(r.totalCost) + '</td><td class="num">' + pct + '%</td></tr>');
          });
          parts.push('</tbody></table></div></div>');

          // Top Expensive Steps
          if (topExpensiveSteps.length > 0) {
            parts.push('<h4 style="font-size:12px;margin:16px 0 8px;color:#475569">üî• Top 5 Most Expensive Steps</h4>');
            parts.push('<table><thead><tr><th>#</th><th>Step</th><th>Stage</th><th class="num">Cost</th></tr></thead><tbody>');
            topExpensiveSteps.forEach(function(s, i) {
              parts.push('<tr><td>' + (i + 1) + '</td><td>' + s.name + '</td><td>' + s.stageName + '</td><td class="num">' + formatCurrency(s.cost) + '</td></tr>');
            });
            parts.push('</tbody></table>');
          }
          parts.push('</div>');
        }

        // Improvement Opportunities
        if (topImprovements.length > 0 && hasCostData) {
          parts.push('<div class="section"><div class="section-title">üéØ Top Improvement Opportunities</div>');
          parts.push('<table><thead><tr><th>Step</th><th>Stage</th><th class="num">Current Cost</th><th class="num">Opportunity</th><th class="num">Potential Savings</th></tr></thead><tbody>');
          topImprovements.forEach(function(s) {
            parts.push('<tr><td>' + s.name + '</td><td>' + s.stageName + '</td><td class="num">' + formatCurrency(s.cost) + '</td><td class="num"><span class="badge badge-' + s.automationOpportunity + '">' + s.automationOpportunity + '</span></td><td class="num text-green">' + formatCurrency(s.savings) + '</td></tr>');
          });
          parts.push('</tbody></table></div>');
        }

        // Detailed Stage Breakdown
        parts.push('<div class="section page-break"><div class="section-title">üìã Detailed Stage Breakdown</div>');
        config.stages.forEach(function(stage, si) {
          var stageSteps = stage.steps || [];
          var stageTime = stageSteps.reduce(function(acc, s) { return acc + (s.timeMinutes || 0); }, 0);
          var stageCost = stageSteps.reduce(function(acc, s) { return acc + calculateStepCost(s, config.personas); }, 0);
          
          parts.push('<div style="margin-bottom:16px;">');
          parts.push('<div class="stage-header"><span>' + stage.name + '</span><span>' + stageSteps.length + ' steps ¬∑ ' + formatTime(stageTime) + (hasCostData ? ' ¬∑ ' + formatCurrency(stageCost) : '') + '</span></div>');
          parts.push('<table><thead><tr><th style="width:40px">#</th><th>Step</th><th style="width:70px" class="num">Time</th>' + (hasCostData ? '<th style="width:80px" class="num">Cost</th>' : '') + '<th>Pain Points</th><th style="width:80px" class="num">Improvement</th></tr></thead><tbody>');
          
          stageSteps.forEach(function(step, sti) {
            var stepCost = calculateStepCost(step, config.personas);
            var owner = config.personas?.find(function(p) { return p.id === step.owner; });
            var painPointsHtml = (step.painPoints || []).length > 0 ? (step.painPoints || []).map(function(p) { return '‚ö† ' + p; }).join('<br/>') : '‚Äî';
            
            parts.push('<tr>');
            parts.push('<td>' + (si + 1) + '.' + (sti + 1) + '</td>');
            parts.push('<td><strong>' + step.name + '</strong><div style="font-size:10px;color:#64748B">' + (owner?.label || '') + (step.clientTouchpoint ? ' ¬∑ üë§ Client' : '') + '</div></td>');
            parts.push('<td class="num">' + formatTime(step.timeMinutes || 0) + '</td>');
            if (hasCostData) {
              parts.push('<td class="num">' + formatCurrency(stepCost) + '</td>');
            }
            parts.push('<td style="font-size:10px;color:#DC2626">' + painPointsHtml + '</td>');
            parts.push('<td class="num"><span class="badge badge-' + (step.automationOpportunity || 'none') + '">' + (step.automationOpportunity || 'none') + '</span></td>');
            parts.push('</tr>');
          });
          
          parts.push('</tbody></table></div>');
        });
        parts.push('</div>');

        // Footer
        parts.push('<div class="rpt-footer"><p>Generated by FATHOM ¬∑ ' + date + '</p><p style="margin-top:4px">üí° Use Print ‚Üí Save as PDF to save this report</p></div>');
        parts.push('<script>window.onload = function() { window.print(); }<\/script>');
        parts.push('</body></html>');

        printWindow.document.write(parts.join(''));
        printWindow.document.close();
      };

      const myMaps = maps.filter(m => m.owner === user.email).sort((a, b) => {
        if (a.favourite !== b.favourite) return a.favourite ? -1 : 1;
        return new Date(b.updatedAt) - new Date(a.updatedAt);
      });
      const sharedMaps = maps.filter(m => m.owner !== user.email && m.sharedWith?.some(s => s.email === user.email));
      
      const openMap = (mapId) => {
        const map = maps.find(m => m.id === mapId);
        window.location.href = `editor.html?map=${mapId}&title=${encodeURIComponent(map?.title || 'Journey Map')}`;
      };

      const displayMaps = activeTab === 'my-maps' ? myMaps : sharedMaps;

      return (
        <div className="page-container">
          {/* Navigation */}
          <nav className="nav">
            <div className="nav-inner">
              <div className="nav-left">
                <a href="index.html">
                  <img src="https://steveyoung74.github.io/journeymaps/logo_light.png" alt="FATHOM" className="nav-logo" />
                </a>
                <div className="nav-links">
                  <a href="dashboard.html" className="nav-link active">Dashboard</a>
                  <div className="dropdown">
                    <span className="nav-link" style={{ cursor: 'pointer' }}>Surveys ‚ñæ</span>
                    <div className="dropdown-menu">
                      <a href="survey-admin.html" className="dropdown-item">Send Surveys</a>
                      <a href="responses.html" className="dropdown-item">View Responses</a>
                    </div>
                  </div>
                  <a href="whats-new.html" className="nav-link">What's New</a>
                  <a href="about.html" className="nav-link">About</a>
                </div>
              </div>
              <div className="nav-right">
                <span className="nav-user">{user.name}</span>
                <button onClick={onLogout} className="nav-signout">Sign Out</button>
              </div>
              <button className="nav-mobile-toggle" onClick={() => setShowMobileMenu(true)}>‚ò∞</button>
            </div>
          </nav>
          
          {/* Mobile Menu */}
          <div className={`nav-mobile-menu ${showMobileMenu ? 'open' : ''}`}>
            <div className="nav-mobile-header">
              <img src="https://steveyoung74.github.io/journeymaps/logo_light.png" alt="FATHOM" style={{ height: '24px' }} />
              <button className="nav-mobile-close" onClick={() => setShowMobileMenu(false)}>√ó</button>
            </div>
            <div className="nav-mobile-links">
              <a href="dashboard.html" className="nav-mobile-link active">Dashboard</a>
              <div className="nav-mobile-divider" />
              <a href="survey-admin.html" className="nav-mobile-link">Send Surveys</a>
              <a href="responses.html" className="nav-mobile-link">View Responses</a>
              <div className="nav-mobile-divider" />
              <a href="whats-new.html" className="nav-mobile-link">What's New</a>
              <a href="about.html" className="nav-mobile-link">About</a>
            </div>
            <div className="nav-mobile-user">
              <div className="nav-mobile-user-name">Signed in as {user.name}</div>
              <button onClick={() => { setShowMobileMenu(false); onLogout(); }} className="nav-mobile-signout">Sign Out</button>
            </div>
          </div>

          {/* Main Content */}
          <main>
            <div className="main-inner">
              <div className="dash-header">
                <div className="dash-header-row">
                  <div>
                    <h1 className="dash-title">Your Journey Maps</h1>
                    <p className="dash-subtitle">Create, manage, and share operational journey maps</p>
                  </div>
                  <button onClick={() => token ? setShowCreateModal(true) : setShowTokenModal(true)} className="btn btn-primary">
                    + New Map
                  </button>
                </div>
              </div>

              {/* Tabs */}
              <div className="tabs">
                <button className={`tab-btn ${activeTab === 'my-maps' ? 'active' : ''}`} onClick={() => setActiveTab('my-maps')}>
                  My Maps ({myMaps.length})
                </button>
                <button className={`tab-btn ${activeTab === 'shared' ? 'active' : ''}`} onClick={() => setActiveTab('shared')}>
                  Shared with Me ({sharedMaps.length})
                </button>
              </div>

              {/* Content */}
              {loading ? (
                <div style={{ textAlign: 'center', padding: '60px 20px', color: 'var(--slate-500)' }}>Loading maps...</div>
              ) : error ? (
                <div style={{ textAlign: 'center', padding: '60px 20px', color: 'var(--error)' }}>{error}</div>
              ) : displayMaps.length === 0 ? (
                <div style={{ textAlign: 'center', padding: '60px 20px', color: 'var(--slate-500)' }}>
                  {activeTab === 'my-maps' ? 'No maps yet. Create your first journey map!' : 'No maps shared with you yet.'}
                </div>
              ) : (
                <div className="cards-grid">
                  {displayMaps.map(map => {
                    const metrics = getMapMetrics(map.id);
                    return (
                      <div key={map.id} className="card journey-card" onClick={() => openMap(map.id)}>
                        <div className="journey-card-icons">
                          {map.favourite && <span title="Favourite">‚≠ê</span>}
                          {map.locked && <span title="Locked">üîí</span>}
                        </div>
                        
                        <h3 className="journey-card-title">{map.title}</h3>
                        <p className="journey-card-desc">{map.description || 'No description'}</p>
                        
                        {metrics && (
                          <div className="journey-card-metrics">
                            <div className="metric" title="Total time">
                              <span>‚è±Ô∏è</span>
                              <span className="metric-value">{formatTime(metrics.totalTime)}</span>
                            </div>
                            <span className="metric-dot">¬∑</span>
                            <div className="metric" title="Stages / Steps">
                              <span>üìã</span>
                              <span>{metrics.stageCount} / {metrics.totalSteps}</span>
                            </div>
                            {metrics.avgFriction && (
                              <>
                                <span className="metric-dot">¬∑</span>
                                <div className="metric" title="Avg friction">
                                  <span>{metrics.avgFriction >= 4 ? 'üò∞' : metrics.avgFriction >= 3 ? 'üòê' : 'üôÇ'}</span>
                                  <span>{metrics.avgFriction}/5</span>
                                </div>
                              </>
                            )}
                            {metrics.totalPainPoints > 0 && (
                              <>
                                <span className="metric-dot">¬∑</span>
                                <div className="metric" title="Pain points">
                                  <span>‚ö†Ô∏è</span>
                                  <span style={{ color: 'var(--error)' }}>{metrics.totalPainPoints}</span>
                                </div>
                              </>
                            )}
                            {metrics.highImprovements > 0 && (
                              <>
                                <span className="metric-dot">¬∑</span>
                                <div className="metric" title="High improvement opps">
                                  <span>üéØ</span>
                                  <span style={{ color: 'var(--success)' }}>{metrics.highImprovements}</span>
                                </div>
                              </>
                            )}
                            {metrics.totalCost !== null && (
                              <>
                                <span className="metric-dot">¬∑</span>
                                <div className="metric" title="Cost per journey">
                                  <span>üí∑</span>
                                  <span className="metric-value">{formatCurrency(metrics.totalCost)}</span>
                                </div>
                              </>
                            )}
                          </div>
                        )}
                        
                        <div className="journey-card-footer">
                          <span className="journey-card-date">
                            Updated {formatDate(map.updatedAt)}
                            {map.sharedWith?.length > 0 && <span> ¬∑ üë• {map.sharedWith.length}</span>}
                          </span>
                          {map.owner === user.email && (
                            <div className="journey-card-actions" onClick={e => e.stopPropagation()}>
                              <button onClick={() => generateReport(map.id)} className="btn btn-ghost">üìÑ Report</button>
                              <button onClick={() => window.location.href = `responses.html?map=${map.id}`} className="btn btn-ghost">üìä Responses</button>
                              <button onClick={() => setShowShareModal(map.id)} className="btn btn-ghost">Share</button>
                            </div>
                          )}
                        </div>
                      </div>
                    );
                  })}
                </div>
              )}
            </div>
          </main>

          {/* Footer */}
          <footer className="footer">
            <div className="footer-inner">
              <div className="footer-brand">
                <img src="https://steveyoung74.github.io/journeymaps/logo_light.png" alt="Fathom" className="footer-logo" />
                <span className="footer-version">v8.8.0</span>
              </div>
              <div className="footer-copy">¬© 2025 Fathom ¬∑ Journey intelligence for modern operations</div>
            </div>
          </footer>

          {/* Token Modal */}
          {showTokenModal && (
            <div className="modal-overlay" onClick={() => setShowTokenModal(false)}>
              <div className="modal" onClick={e => e.stopPropagation()}>
                <div className="modal-content">
                  <div className="modal-header">
                    <h2 className="modal-title">GitHub Token Required</h2>
                    <button className="modal-close" onClick={() => setShowTokenModal(false)}>√ó</button>
                  </div>
                  <p className="text-muted" style={{ marginBottom: '16px' }}>To create and edit maps, you need a GitHub token.</p>
                  <TokenForm 
                    onSave={(newToken) => { onUpdateToken(newToken); setShowTokenModal(false); setShowCreateModal(true); }}
                    onCancel={() => setShowTokenModal(false)}
                  />
                </div>
              </div>
            </div>
          )}

          {/* Create Modal */}
          {showCreateModal && (
            <CreateMapModal 
              user={user}
              token={token}
              maps={maps}
              onClose={() => setShowCreateModal(false)}
              onCreated={() => { setShowCreateModal(false); fetchMaps(); }}
            />
          )}

          {/* Share Modal */}
          {showShareModal && (
            <ShareModal
              mapId={showShareModal}
              maps={maps}
              token={token}
              onClose={() => setShowShareModal(null)}
              onUpdated={fetchMaps}
            />
          )}
        </div>
      );
    }

    // Token Form
    function TokenForm({ onSave, onCancel }) {
      const [token, setToken] = useState('');
      return (
        <div>
          <div style={{ marginBottom: '16px' }}>
            <label className="label">GitHub Personal Access Token</label>
            <input type="password" className="input" value={token} onChange={e => setToken(e.target.value)} placeholder="ghp_xxxxxxxxxxxx" />
            <p className="text-muted text-small" style={{ marginTop: '6px' }}>Create a token at github.com/settings/tokens with repo access.</p>
          </div>
          <div style={{ display: 'flex', gap: '8px' }}>
            <button onClick={() => onSave(token)} className="btn btn-primary" disabled={!token.trim()}>Save Token</button>
            <button onClick={onCancel} className="btn btn-secondary">Cancel</button>
          </div>
        </div>
      );
    }

    // Create Map Modal (simplified)
    function CreateMapModal({ user, token, maps, onClose, onCreated }) {
      const [title, setTitle] = useState('');
      const [description, setDescription] = useState('');
      const [isCreating, setIsCreating] = useState(false);
      const [error, setError] = useState('');

      const handleCreate = async () => {
        if (!title.trim()) { setError('Please enter a title'); return; }
        setIsCreating(true);
        setError('');
        
        try {
          const mapId = 'map-' + Date.now();
          const now = new Date().toISOString();
          
          const mapMetadata = {
            id: mapId,
            title: title.trim(),
            description: description.trim(),
            owner: user.email,
            createdAt: now,
            updatedAt: now,
            sharedWith: []
          };
          
          const mapConfig = {
            meta: { title: title.trim(), version: '1.0' },
            funnel: { enabled: true, initialVolume: 1000, periodLabel: 'per quarter' },
            stages: [{ id: 'stage-1', name: 'Stage 1', dropOffCount: 0, steps: [] }],
            personas: []
          };
          
          // Save to GitHub
          await saveToGitHub(GITHUB_CONFIG.indexFile, { maps: [...maps, mapMetadata] }, token, `Create: ${title}`);
          await saveToGitHub(`${GITHUB_CONFIG.mapsPath}/${mapId}.json`, mapConfig, token, `Create config: ${title}`);
          
          onCreated();
        } catch (err) {
          setError(err.message || 'Failed to create map');
        }
        setIsCreating(false);
      };

      return (
        <div className="modal-overlay" onClick={onClose}>
          <div className="modal" onClick={e => e.stopPropagation()}>
            <div className="modal-content">
              <div className="modal-header">
                <h2 className="modal-title">Create New Map</h2>
                <button className="modal-close" onClick={onClose}>√ó</button>
              </div>
              
              {error && <div style={{ padding: '10px 12px', background: 'var(--error-light)', borderRadius: '8px', marginBottom: '16px', color: 'var(--error)', fontSize: '13px' }}>{error}</div>}
              
              <div style={{ marginBottom: '16px' }}>
                <label className="label">Map Title</label>
                <input type="text" className="input" value={title} onChange={e => setTitle(e.target.value)} placeholder="Client Onboarding Journey" autoFocus />
              </div>
              
              <div style={{ marginBottom: '20px' }}>
                <label className="label">Description</label>
                <textarea className="input" value={description} onChange={e => setDescription(e.target.value)} placeholder="Brief description..." rows={3} style={{ resize: 'vertical' }} />
              </div>
              
              <div style={{ display: 'flex', gap: '8px' }}>
                <button onClick={handleCreate} className="btn btn-primary" disabled={isCreating}>
                  {isCreating ? 'Creating...' : 'Create Map'}
                </button>
                <button onClick={onClose} className="btn btn-secondary">Cancel</button>
              </div>
            </div>
          </div>
        </div>
      );
    }

    // Share Modal (simplified)
    function ShareModal({ mapId, maps, token, onClose, onUpdated }) {
      const map = maps.find(m => m.id === mapId);
      const [email, setEmail] = useState('');
      const [permission, setPermission] = useState('view');
      const [isSharing, setIsSharing] = useState(false);

      const handleShare = async () => {
        if (!email.trim() || !email.includes('@')) return;
        setIsSharing(true);
        
        try {
          const updatedMap = {
            ...map,
            sharedWith: [...(map.sharedWith || []), { email: email.trim().toLowerCase(), permission, sharedAt: new Date().toISOString() }]
          };
          const updatedMaps = maps.map(m => m.id === mapId ? updatedMap : m);
          await saveToGitHub(GITHUB_CONFIG.indexFile, { maps: updatedMaps }, token, `Share ${map.title}`);
          onUpdated();
          setEmail('');
        } catch (err) {}
        setIsSharing(false);
      };

      const handleRemove = async (emailToRemove) => {
        try {
          const updatedMap = { ...map, sharedWith: map.sharedWith.filter(s => s.email !== emailToRemove) };
          const updatedMaps = maps.map(m => m.id === mapId ? updatedMap : m);
          await saveToGitHub(GITHUB_CONFIG.indexFile, { maps: updatedMaps }, token, `Unshare ${map.title}`);
          onUpdated();
        } catch (err) {}
      };

      return (
        <div className="modal-overlay" onClick={onClose}>
          <div className="modal" onClick={e => e.stopPropagation()}>
            <div className="modal-content">
              <div className="modal-header">
                <h2 className="modal-title">Share "{map?.title}"</h2>
                <button className="modal-close" onClick={onClose}>√ó</button>
              </div>
              
              <div style={{ display: 'flex', gap: '8px', marginBottom: '16px' }}>
                <input type="email" className="input" value={email} onChange={e => setEmail(e.target.value)} placeholder="colleague@company.com" style={{ flex: 1 }} />
                <select className="input" value={permission} onChange={e => setPermission(e.target.value)} style={{ width: '100px' }}>
                  <option value="view">View</option>
                  <option value="edit">Edit</option>
                </select>
                <button onClick={handleShare} className="btn btn-primary" disabled={isSharing}>Share</button>
              </div>
              
              {map?.sharedWith?.length > 0 && (
                <div>
                  <p className="label" style={{ marginBottom: '8px' }}>Shared with:</p>
                  {map.sharedWith.map(s => (
                    <div key={s.email} style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', padding: '8px 0', borderBottom: '1px solid var(--slate-100)' }}>
                      <span style={{ fontSize: '14px' }}>{s.email} <span className="badge" style={{ marginLeft: '8px' }}>{s.permission}</span></span>
                      <button onClick={() => handleRemove(s.email)} className="btn btn-ghost" style={{ padding: '4px 8px', fontSize: '12px', color: 'var(--error)' }}>Remove</button>
                    </div>
                  ))}
                </div>
              )}
              
              <button onClick={onClose} className="btn btn-secondary" style={{ width: '100%', marginTop: '16px' }}>Done</button>
            </div>
          </div>
        </div>
      );
    }

    // ============================================
    // APP
    // ============================================
    function App() {
      const [user, setUser] = useState(null);
      const [token, setToken] = useState('');
      const [isLoaded, setIsLoaded] = useState(false);
      
      useEffect(() => {
        const savedUser = localStorage.getItem('fathom_user');
        const savedToken = localStorage.getItem('fathom_token');
        if (savedUser) {
          setUser(JSON.parse(savedUser));
          if (savedToken) setToken(savedToken);
        }
        setIsLoaded(true);
      }, []);
      
      const handleLogin = (userData, userToken) => {
        setUser(userData);
        setToken(userToken || '');
        localStorage.setItem('fathom_user', JSON.stringify(userData));
        if (userToken) localStorage.setItem('fathom_token', userToken);
      };
      
      const handleLogout = () => {
        setUser(null);
        setToken('');
        localStorage.removeItem('fathom_user');
        localStorage.removeItem('fathom_token');
      };
      
      const handleUpdateToken = (newToken) => {
        setToken(newToken);
        localStorage.setItem('fathom_token', newToken);
      };
      
      if (!isLoaded) {
        return (
          <div style={{ minHeight: '100vh', display: 'flex', alignItems: 'center', justifyContent: 'center', background: 'var(--navy-700)' }}>
            <img src="https://steveyoung74.github.io/journeymaps/logo_light.png" alt="FATHOM" style={{ height: '32px', opacity: 0.5 }} />
          </div>
        );
      }
      
      if (!user) {
        return <LoginModal onLogin={handleLogin} />;
      }
      
      return <Dashboard user={user} token={token} onLogout={handleLogout} onUpdateToken={handleUpdateToken} />;
    }
    
    ReactDOM.createRoot(document.getElementById('root')).render(<App />);
  </script>
</body>
</html>
