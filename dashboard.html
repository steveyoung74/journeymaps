<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, viewport-fit=cover">
  <title>FATHOM - Dashboard</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Open+Sans:wght@400;500;600;700&display=swap" rel="stylesheet">
  <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <style>
    /* Interstate Font Family - Brand/Display Font */
    @font-face {
      font-family: 'Interstate';
      src: url('https://steveyoung74.github.io/journeymaps/fonts/Interstate-light.ttf') format('truetype');
      font-weight: 300;
      font-style: normal;
      font-display: swap;
    }
    @font-face {
      font-family: 'Interstate';
      src: url('https://steveyoung74.github.io/journeymaps/fonts/Interstate-regular.ttf') format('truetype');
      font-weight: 400;
      font-style: normal;
      font-display: swap;
    }
    @font-face {
      font-family: 'Interstate';
      src: url('https://steveyoung74.github.io/journeymaps/fonts/Interstate-bold.ttf') format('truetype');
      font-weight: 700;
      font-style: normal;
      font-display: swap;
    }
    
    /* CSS Custom Properties */
    :root {
      /* Font Families */
      --font-display: 'Interstate', -apple-system, BlinkMacSystemFont, sans-serif;
      --font-body: 'Open Sans', -apple-system, BlinkMacSystemFont, sans-serif;
      
      --navy-950: #0C1620;
      --navy-900: #111E2E;
      --navy-800: #15243A;
      --navy-700: #192B45;
      --navy-600: #243D5C;
      --navy-500: #2F5070;
      --navy-400: #456A8A;
      --navy-300: #6889A8;
      --navy-200: #9BB1C7;
      --navy-100: #C8D5E2;
      --navy-50: #E9EEF4;
      --steel-700: #3A6070;
      --steel-600: #4A7485;
      --steel-500: #5B8A9A;
      --steel-400: #74A0AE;
      --steel-300: #96BCC7;
      --steel-100: #E1EEF2;
      --amber-700: #8B6914;
      --amber-600: #A67D1D;
      --amber-500: #C4942A;
      --amber-400: #D4A84A;
      --amber-200: #E8D5A3;
      --amber-100: #FAF0D6;
      --success: #2D8A6E;
      --success-light: #D4EDE5;
      --error: #B84A5A;
      --error-light: #F5E0E3;
      --slate-900: #1A2332;
      --slate-700: #3D4A5C;
      --slate-600: #556275;
      --slate-500: #6E7B8C;
      --slate-400: #8A95A5;
      --slate-300: #A9B2BE;
      --slate-200: #C8CED6;
      --slate-100: #E4E7EB;
      --slate-50: #F4F5F7;
    }
    
    /* Base Reset - Mobile First */
    * { box-sizing: border-box; margin: 0; padding: 0; }
    html, body {
      width: 100%;
      max-width: 100%;
      overflow-x: hidden;
      
    }
    body { 
      font-family: var(--font-body); 
      background: var(--slate-50);
      color: var(--slate-900);
      line-height: 1.6;
      min-height: 100vh;
    }
    
    /* Typography - Display font for headings */
    h1, h2, h3, h4, h5, h6 {
      font-family: var(--font-display);
    }
    
    /* Buttons */
    .btn { 
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      padding: 12px 20px; 
      border-radius: 8px; 
      font-size: 14px; 
      font-weight: 500; 
      cursor: pointer; 
      transition: all 0.2s;
      border: none;
      font-family: inherit;
      text-decoration: none;
    }
    .btn:disabled { opacity: 0.5; cursor: not-allowed; }
    .btn-primary { background: var(--navy-700); color: #FFF; }
    .btn-primary:hover:not(:disabled) { background: var(--navy-800); }
    .btn-secondary { background: #FFF; color: var(--navy-700); border: 2px solid var(--navy-700); }
    .btn-secondary:hover:not(:disabled) { background: var(--navy-50); }
    .btn-ghost { background: transparent; color: var(--slate-600); }
    .btn-ghost:hover:not(:disabled) { background: var(--slate-100); }
    
    /* Form Elements */
    .input {
      width: 100%;
      padding: 12px 14px;
      border: 1px solid var(--slate-200);
      border-radius: 8px;
      font-size: 15px;
      font-family: inherit;
      transition: border-color 0.15s, box-shadow 0.15s;
    }
    .input:focus { 
      outline: none;
      border-color: var(--steel-500); 
      box-shadow: 0 0 0 3px rgba(91, 138, 154, 0.15);
    }
    .label {
      display: block;
      font-size: 14px;
      font-weight: 500;
      color: var(--slate-700);
      margin-bottom: 6px;
    }
    
    /* Cards */
    .card {
      background: #FFF;
      border-radius: 12px;
      box-shadow: 0 2px 12px rgba(25, 43, 69, 0.06);
      border: 1px solid var(--slate-100);
    }
    
    /* Badge */
    .badge {
      display: inline-flex;
      align-items: center;
      padding: 4px 10px;
      border-radius: 16px;
      font-size: 11px;
      font-weight: 500;
    }
    .badge-owner { background: var(--steel-100); color: var(--navy-600); }
    .badge-edit { background: var(--success-light); color: var(--success); }
    .badge-view { background: var(--slate-100); color: var(--slate-600); }
    
    /* Utility */
    .text-muted { color: var(--slate-500); }
    .text-small { font-size: 13px; }
    
    /* Page Layout */
    .page-container {
      min-height: 100vh;
      display: flex;
      flex-direction: column;
    }
    .page-container::before {
      content: '';
      position: fixed;
      inset: 0;
      background: url('https://steveyoung74.github.io/journeymaps/topography-light.svg') center/600px 600px repeat;
      opacity: 1;
      pointer-events: none;
      z-index: -1;
    }
    
    /* Navigation */
    .nav {
      background: linear-gradient(135deg, var(--navy-700) 0%, var(--navy-900) 100%);
      position: sticky;
      top: 0;
      z-index: 100;
    }
    .nav::before {
      content: '';
      position: absolute;
      inset: 0;
      background: url('https://steveyoung74.github.io/journeymaps/topography-dark.svg') center/600px 600px repeat;
      opacity: 1;
      pointer-events: none;
      z-index: 0;
    }
    .nav-inner {
      max-width: 1200px;
      margin: 0 auto;
      padding: 0 24px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      height: 64px;
      position: relative;
      z-index: 1;
    }
    .nav-logo { height: 32px; }
    .nav-left {
      display: flex;
      align-items: center;
      gap: 32px;
    }
    .nav-links {
      display: none;
      align-items: center;
      gap: 4px;
    }
    .nav-link {
      color: rgba(255,255,255,0.7);
      text-decoration: none;
      padding: 8px 16px;
      border-radius: 6px;
      font-size: 14px;
      font-weight: 500;
      transition: all 0.15s;
    }
    .nav-link:hover { color: #FFF; background: rgba(255,255,255,0.1); }
    .nav-link.active { color: #FFF; background: rgba(255,255,255,0.15); }
    .nav-right {
      display: none;
      align-items: center;
      gap: 16px;
    }
    .nav-user {
      color: rgba(255,255,255,0.8);
      font-size: 14px;
    }
    .nav-signout {
      color: rgba(255,255,255,0.6);
      background: rgba(255,255,255,0.1);
      border: 1px solid rgba(255,255,255,0.2);
      padding: 6px 14px;
      border-radius: 6px;
      font-size: 13px;
      cursor: pointer;
      font-family: inherit;
      transition: all 0.15s;
    }
    .nav-signout:hover { background: rgba(255,255,255,0.2); color: #FFF; }
    
    /* Mobile hamburger */
    .nav-mobile-toggle {
      display: flex;
      align-items: center;
      justify-content: center;
      background: none;
      border: none;
      color: #FFF;
      font-size: 24px;
      cursor: pointer;
      padding: 8px;
      line-height: 1;
    }
    
    /* Mobile Menu - Threads-style Side Sliding */
    .nav-mobile-backdrop {
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, 0.5);
      z-index: 999;
      opacity: 0;
      visibility: hidden;
      transition: opacity 0.3s ease, visibility 0.3s ease;
    }
    .nav-mobile-backdrop.open {
      opacity: 1;
      visibility: visible;
    }
    .nav-mobile-menu {
      position: fixed;
      top: 0;
      right: 0;
      bottom: 0;
      width: 280px;
      max-width: 85vw;
      background: var(--navy-800);
      z-index: 1000;
      display: flex;
      flex-direction: column;
      transform: translateX(100%);
      transition: transform 0.3s ease;
      box-shadow: -4px 0 24px rgba(0, 0, 0, 0.3);
    }
    .nav-mobile-menu.open {
      transform: translateX(0);
    }
    .nav-mobile-header {
      display: flex;
      justify-content: flex-end;
      padding: 16px 20px;
      border-bottom: 1px solid rgba(255,255,255,0.1);
    }
    .nav-mobile-close {
      background: rgba(255,255,255,0.1);
      border: none;
      color: #FFF;
      font-size: 20px;
      cursor: pointer;
      padding: 8px 12px;
      line-height: 1;
      border-radius: 20px;
      transition: background 0.15s;
    }
    .nav-mobile-close:hover {
      background: rgba(255,255,255,0.2);
    }
    .nav-mobile-links {
      display: flex;
      flex-direction: column;
      gap: 8px;
      padding: 20px;
      flex: 1;
      overflow-y: auto;
    }
    .nav-mobile-link {
      color: rgba(255,255,255,0.9);
      text-decoration: none;
      padding: 14px 20px;
      border-radius: 24px;
      font-size: 15px;
      font-weight: 500;
      background: rgba(255,255,255,0.05);
      transition: all 0.15s;
      text-align: center;
    }
    .nav-mobile-link:hover {
      background: rgba(255,255,255,0.15);
      color: #FFF;
    }
    .nav-mobile-link.active {
      background: rgba(255,255,255,0.2);
      color: #FFF;
    }
    .nav-mobile-section-label {
      color: rgba(255,255,255,0.4);
      font-size: 11px;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      padding: 16px 20px 8px;
    }
    .nav-mobile-user {
      padding: 20px;
      border-top: 1px solid rgba(255,255,255,0.1);
      background: rgba(0,0,0,0.2);
    }
    .nav-mobile-user-name {
      color: rgba(255,255,255,0.6);
      font-size: 13px;
      margin-bottom: 12px;
      text-align: center;
    }
    .nav-mobile-signout {
      width: 100%;
      padding: 12px;
      background: transparent;
      border: 1px solid rgba(255,255,255,0.3);
      color: rgba(255,255,255,0.9);
      border-radius: 24px;
      font-size: 14px;
      font-weight: 500;
      cursor: pointer;
      font-family: inherit;
      transition: all 0.15s;
    }
    .nav-mobile-signout:hover {
      background: rgba(255,255,255,0.1);
      border-color: rgba(255,255,255,0.4);
    }
    
    /* Main Content */
    main {
      flex: 1;
      padding: 32px 24px;
    }
    .main-inner {
      max-width: 1200px;
      margin: 0 auto;
    }
    
    /* Dashboard Header */
    .dash-header {
      margin-bottom: 24px;
    }
    .dash-title {
      font-size: 24px;
      font-weight: 400;
      color: var(--navy-700);
      margin-bottom: 4px;
    }
    .dash-subtitle {
      color: var(--slate-500);
      font-size: 14px;
    }
    .dash-header-row {
      display: flex;
      flex-direction: column;
      gap: 16px;
      margin-bottom: 20px;
    }
    
    /* Tabs */
    .tabs {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      margin-bottom: 20px;
      padding-bottom: 16px;
      border-bottom: 1px solid var(--slate-200);
    }
    .tab-btn {
      padding: 8px 16px;
      background: transparent;
      color: var(--slate-600);
      border: none;
      border-radius: 6px;
      cursor: pointer;
      font-family: inherit;
      font-size: 14px;
      font-weight: 500;
      transition: all 0.15s;
    }
    .tab-btn:hover { background: var(--slate-100); }
    .tab-btn.active {
      background: var(--navy-700);
      color: #FFF;
    }
    
    /* Journey Cards Grid */
    .cards-grid {
      display: grid;
      grid-template-columns: 1fr;
      gap: 16px;
    }
    .journey-card {
      padding: 20px;
      cursor: pointer;
      transition: all 0.2s;
      position: relative;
    }
    .journey-card:hover {
      box-shadow: 0 4px 20px rgba(25, 43, 69, 0.1);
    }
    .journey-card-header {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      margin-bottom: 8px;
    }
    .journey-card-title {
      font-size: 16px;
      font-weight: 600;
      color: var(--navy-700);
      line-height: 1.3;
      padding-right: 40px;
    }
    .journey-card-icons {
      display: flex;
      gap: 4px;
      font-size: 14px;
      position: absolute;
      top: 16px;
      right: 16px;
    }
    .journey-card-desc {
      color: var(--slate-500);
      font-size: 13px;
      margin-bottom: 12px;
      line-height: 1.4;
    }
    .journey-card-metrics {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
      padding: 10px 12px;
      background: var(--slate-50);
      border-radius: 8px;
      margin-bottom: 12px;
    }
    .metric {
      display: flex;
      align-items: center;
      gap: 4px;
      font-size: 12px;
    }
    .metric-value { font-weight: 600; color: var(--navy-700); }
    .metric-dot { color: var(--slate-300); }
    .journey-card-footer {
      display: flex;
      flex-wrap: wrap;
      justify-content: space-between;
      align-items: center;
      gap: 8px;
    }
    .journey-card-date {
      color: var(--slate-400);
      font-size: 12px;
    }
    .journey-card-actions {
      display: flex;
      gap: 4px;
    }
    .journey-card-actions .btn {
      padding: 6px 10px;
      font-size: 12px;
    }
    
    /* Modal */
    .modal-overlay {
      position: fixed;
      inset: 0;
      background: rgba(12, 22, 32, 0.7);
      backdrop-filter: blur(4px);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 1000;
      padding: 16px;
    }
    .modal {
      background: #FFF;
      border-radius: 16px;
      width: 100%;
      max-width: 420px;
      max-height: 90vh;
      overflow-y: auto;
    }
    .modal-content { padding: 24px; }
    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
    }
    .modal-close {
      background: none;
      border: none;
      font-size: 28px;
      color: var(--slate-400);
      cursor: pointer;
      padding: 4px;
      line-height: 1;
    }
    .modal-title {
      font-size: 22px;
      font-weight: 400;
      color: var(--navy-700);
      margin-bottom: 6px;
    }
    
    /* Footer */
    .footer {
      background: var(--navy-950);
      color: rgba(255,255,255,0.4);
      padding: 32px 24px;
    }
    .footer-inner {
      max-width: 1200px;
      margin: 0 auto;
      display: flex;
      justify-content: space-between;
      align-items: center;
      flex-wrap: wrap;
      gap: 16px;
    }
    .footer-brand {
      display: flex;
      align-items: center;
      gap: 12px;
    }
    .footer-logo {
      height: 20px;
      opacity: 0.5;
    }
    .footer-version {
      font-size: 11px;
      opacity: 0.6;
    }
    .footer-copy {
      font-size: 13px;
    }
    
    /* Dropdown */
    .dropdown {
      position: relative;
    }
    .dropdown-menu {
      position: absolute;
      top: 100%;
      left: 0;
      background: #FFF;
      border-radius: 8px;
      box-shadow: 0 4px 20px rgba(0,0,0,0.15);
      min-width: 160px;
      padding: 6px 0;
      opacity: 0;
      visibility: hidden;
      transform: translateY(8px);
      transition: all 0.2s;
      z-index: 50;
    }
    .dropdown:hover .dropdown-menu {
      opacity: 1;
      visibility: visible;
      transform: translateY(4px);
    }
    .dropdown-item {
      display: block;
      padding: 10px 16px;
      color: var(--slate-700);
      text-decoration: none;
      font-size: 14px;
      transition: background 0.1s;
    }
    .dropdown-item:hover { background: var(--slate-50); }
    
    /* ============================================
       TABLET AND UP (768px+)
       ============================================ */
    @media (min-width: 768px) {
      .nav-links { display: flex; }
      .nav-right { display: flex; }
      .nav-mobile-toggle { display: none; }
      
      main { padding: 32px 24px; }
      
      .dash-header-row {
        flex-direction: row;
        justify-content: space-between;
        align-items: center;
      }
      .dash-title { font-size: 28px; }
      
      .cards-grid {
        grid-template-columns: repeat(2, 1fr);
        gap: 20px;
      }
      
      .journey-card { padding: 24px; }
      .journey-card-title { font-size: 17px; }
    }
    
    /* ============================================
       DESKTOP (1024px+)
       ============================================ */
    @media (min-width: 1024px) {
      main { padding: 40px; }
      
      .dash-title { font-size: 32px; }
      
      .cards-grid {
        grid-template-columns: repeat(3, 1fr);
        gap: 24px;
      }
    }
  </style>
</head>
<body>
  <div id="root"></div>
  
  <script type="text/babel">
    const { useState, useEffect } = React;
    
    // GitHub configuration
    const GITHUB_CONFIG = {
      owner: 'steveyoung74',
      repo: 'journeymaps',
      branch: 'main',
      mapsPath: 'maps',
      indexFile: 'maps/index.json'
    };
    
    const getRawUrl = (path) => 
      `https://raw.githubusercontent.com/${GITHUB_CONFIG.owner}/${GITHUB_CONFIG.repo}/${GITHUB_CONFIG.branch}/${path}`;
    
    const getApiUrl = (path) => 
      `https://api.github.com/repos/${GITHUB_CONFIG.owner}/${GITHUB_CONFIG.repo}/contents/${path}`;
    
    async function fetchFromGitHub(path) {
      const cacheBust = `${Date.now()}-${Math.random().toString(36).substr(2, 9)}`;
      const url = getRawUrl(path) + '?t=' + cacheBust;
      const response = await fetch(url);
      if (!response.ok) {
        if (response.status === 404) return null;
        throw new Error(`GitHub fetch failed: ${response.status}`);
      }
      return response.json();
    }
    
    async function saveToGitHub(path, content, token, message = 'Update from Fathom') {
      const apiUrl = getApiUrl(path);
      let sha = null;
      
      try {
        const existingResponse = await fetch(apiUrl, {
          headers: { 'Authorization': `token ${token}` }
        });
        if (existingResponse.ok) {
          const existing = await existingResponse.json();
          sha = existing.sha;
        }
      } catch (e) {}
      
      const body = {
        message,
        content: btoa(unescape(encodeURIComponent(JSON.stringify(content, null, 2)))),
        branch: GITHUB_CONFIG.branch
      };
      if (sha) body.sha = sha;
      
      const response = await fetch(apiUrl, {
        method: 'PUT',
        headers: {
          'Authorization': `token ${token}`,
          'Content-Type': 'application/json'
        },
        body: JSON.stringify(body)
      });
      
      if (!response.ok) {
        const error = await response.json();
        throw new Error(error.message || 'Failed to save');
      }
      
      return response.json();
    }
    
    async function deleteFromGitHub(path, token, message = 'Delete from Fathom') {
      const apiUrl = getApiUrl(path);
      const existingResponse = await fetch(apiUrl, {
        headers: { 'Authorization': `token ${token}` }
      });
      if (!existingResponse.ok) throw new Error('File not found');
      const existing = await existingResponse.json();
      
      const response = await fetch(apiUrl, {
        method: 'DELETE',
        headers: {
          'Authorization': `token ${token}`,
          'Content-Type': 'application/json'
        },
        body: JSON.stringify({
          message,
          sha: existing.sha,
          branch: GITHUB_CONFIG.branch
        })
      });
      
      if (!response.ok) throw new Error('Failed to delete');
      return true;
    }
    
    // Utility functions
    const formatTime = (minutes) => {
      if (!minutes) return '0m';
      const h = Math.floor(minutes / 60);
      const m = Math.round(minutes % 60);
      if (h === 0) return `${m}m`;
      if (m === 0) return `${h}h`;
      return `${h}h ${m}m`;
    };
    
    const formatCurrency = (amount) => {
      if (amount === null || amount === undefined) return '‚Äî';
      return '¬£' + amount.toLocaleString('en-GB', { minimumFractionDigits: 0, maximumFractionDigits: 0 });
    };
    
    const formatDate = (dateStr) => {
      if (!dateStr) return '';
      const date = new Date(dateStr);
      return date.toLocaleDateString('en-GB', { day: '2-digit', month: '2-digit', year: 'numeric' });
    };
    
    // ============================================
    // LOGIN MODAL
    // ============================================
    function LoginModal({ onLogin }) {
      const [name, setName] = useState('');
      const [email, setEmail] = useState('');
      const [token, setToken] = useState('');
      const [error, setError] = useState('');
      const [isLoading, setIsLoading] = useState(false);

      const handleSubmit = async (e) => {
        e.preventDefault();
        if (!name.trim() || !email.trim()) {
          setError('Please enter your name and email');
          return;
        }
        if (!email.includes('@')) {
          setError('Please enter a valid email');
          return;
        }
        setIsLoading(true);
        await onLogin({ name: name.trim(), email: email.trim().toLowerCase() }, token.trim());
        setIsLoading(false);
      };

      return (
        <div className="modal-overlay">
          <div className="modal">
            <div className="modal-content">
              <div className="modal-header">
                <img src="https://steveyoung74.github.io/journeymaps/logo_dark.png" alt="FATHOM" style={{ height: '28px' }} />
              </div>
              
              <h2 className="modal-title">Welcome to Fathom</h2>
              <p className="text-muted" style={{ marginBottom: '24px', fontSize: '14px' }}>Enter your details to access your journey maps</p>

              {error && (
                <div style={{ padding: '12px 14px', background: 'var(--error-light)', borderRadius: '8px', marginBottom: '16px', color: 'var(--error)', fontSize: '13px' }}>
                  {error}
                </div>
              )}

              <form onSubmit={handleSubmit}>
                <div style={{ marginBottom: '16px' }}>
                  <label className="label">Your Name</label>
                  <input
                    type="text"
                    className="input"
                    value={name}
                    onChange={(e) => setName(e.target.value)}
                    placeholder="Steve Young"
                    autoFocus
                  />
                </div>

                <div style={{ marginBottom: '16px' }}>
                  <label className="label">Email Address</label>
                  <input
                    type="email"
                    className="input"
                    value={email}
                    onChange={(e) => setEmail(e.target.value)}
                    placeholder="steve@company.com"
                  />
                </div>

                <div style={{ marginBottom: '24px' }}>
                  <label className="label">GitHub Token <span style={{ fontWeight: 400, color: 'var(--slate-400)' }}>(optional)</span></label>
                  <input
                    type="password"
                    className="input"
                    value={token}
                    onChange={(e) => setToken(e.target.value)}
                    placeholder="ghp_xxxxxxxxxxxx"
                  />
                  <p className="text-muted text-small" style={{ marginTop: '6px' }}>
                    Required to create and edit maps.
                  </p>
                </div>

                <button type="submit" className="btn btn-primary" style={{ width: '100%', padding: '14px' }} disabled={isLoading}>
                  {isLoading ? 'Signing in...' : 'Sign In'}
                </button>
              </form>
            </div>
          </div>
        </div>
      );
    }
    
    // ============================================
    // DASHBOARD
    // ============================================
    function Dashboard({ user, token, onLogout, onUpdateToken }) {
      const [maps, setMaps] = useState([]);
      const [mapConfigs, setMapConfigs] = useState({});
      const [loading, setLoading] = useState(true);
      const [error, setError] = useState('');
      const [showCreateModal, setShowCreateModal] = useState(false);
      const [showShareModal, setShowShareModal] = useState(null);
      const [showTokenModal, setShowTokenModal] = useState(false);
      const [activeTab, setActiveTab] = useState('my-maps');
      const [showMobileMenu, setShowMobileMenu] = useState(false);
      const [manageMode, setManageMode] = useState(false);
      const [selectedMaps, setSelectedMaps] = useState(new Set());

      useEffect(() => {
        window.scrollTo(0, 0);
        fetchMaps();
      }, []);

      useEffect(() => {
        if (maps.length > 0) fetchMapConfigs();
      }, [maps]);

      const fetchMaps = async () => {
        setLoading(true);
        try {
          const index = await fetchFromGitHub(GITHUB_CONFIG.indexFile);
          setMaps(index?.maps || []);
        } catch (err) {
          setError('Failed to load maps');
        }
        setLoading(false);
      };

      const fetchMapConfigs = async () => {
        const configs = {};
        for (const map of maps) {
          try {
            const config = await fetchFromGitHub(`${GITHUB_CONFIG.mapsPath}/${map.id}.json`);
            if (config) configs[map.id] = config;
          } catch (err) {}
        }
        setMapConfigs(configs);
      };

      const getMapMetrics = (mapId) => {
        const config = mapConfigs[mapId];
        if (!config?.stages) return null;
        
        const allSteps = config.stages.flatMap(s => s.steps || []);
        const totalTime = allSteps.reduce((acc, s) => acc + (s.timeMinutes || s.duration || 0), 0);
        const totalPainPoints = allSteps.reduce((acc, s) => acc + (s.painPoints?.length || 0), 0);
        const highImprovements = allSteps.filter(s => s.automationOpportunity === 'high').length;
        
        const frictionMap = { none: 1, low: 2, medium: 3, high: 4, extreme: 5 };
        const frictionValues = allSteps.map(s => s.frictionScore || frictionMap[s.friction]).filter(Boolean);
        const avgFriction = frictionValues.length ? (frictionValues.reduce((a, b) => a + b, 0) / frictionValues.length).toFixed(1) : null;
        
        let totalCost = null;
        if (config.personas?.length) {
          totalCost = 0;
          allSteps.forEach(step => {
            const persona = config.personas.find(p => p.id === (step.owner || step.personaId));
            if (persona?.salary) {
              const hourlyRate = (persona.salary * (persona.burdenMultiplier || 1.4)) / (52 * 37.5);
              totalCost += ((step.timeMinutes || step.duration || 0) / 60) * hourlyRate;
            }
          });
        }
        
        return { totalTime, totalSteps: allSteps.length, stageCount: config.stages.length, totalPainPoints, highImprovements, avgFriction, totalCost };
      };

      // Calculate hourly rate from annual salary
      const calculateHourlyRate = (salary, burdenMultiplier = 1.4) => {
        return (salary * burdenMultiplier) / (52 * 37.5);
      };

      // Calculate step cost
      const calculateStepCost = (step, personas) => {
        if (!personas || !step.roleInvolvement) return 0;
        return Object.entries(step.roleInvolvement).reduce((total, [personaId, inv]) => {
          const persona = personas.find(p => p.id === personaId);
          if (!persona || !persona.salary) return total;
          const hourlyRate = calculateHourlyRate(persona.salary || persona.annualSalary, persona.burdenMultiplier);
          return total + (inv.timeMinutes / 60) * hourlyRate * (inv.headcount || 1);
        }, 0);
      };

      // Generate comprehensive report
      const generateReport = (mapId) => {
        const config = mapConfigs[mapId];
        const map = maps.find(m => m.id === mapId);
        if (!config) {
          alert('Report data not loaded yet. Please try again.');
          return;
        }

        const printWindow = window.open('', '_blank');
        if (!printWindow) {
          alert('Please allow popups to generate the report');
          return;
        }

        const allSteps = config.stages.flatMap((stage, si) => 
          stage.steps.map((step, sti) => ({ ...step, stageName: stage.name, stageIndex: si, stepIndex: sti }))
        );

        // Calculate totals
        const totalTime = allSteps.reduce((acc, s) => acc + (s.timeMinutes || 0), 0);
        const totalPainPoints = allSteps.reduce((acc, s) => acc + (s.painPoints?.length || 0), 0);
        const highAutomationCount = allSteps.filter(s => s.automationOpportunity === 'high').length;
        const frictionMap = { none: 1, low: 2, medium: 3, high: 4, extreme: 5 };
        const frictionValues = allSteps.map(s => s.frictionScore || frictionMap[s.friction]).filter(Boolean);
        const avgFriction = frictionValues.length ? (frictionValues.reduce((a, b) => a + b, 0) / frictionValues.length).toFixed(1) : 'N/A';

        // Calculate costs
        let totalCost = 0;
        const hasCostData = config.personas?.some(p => p.salary || p.annualSalary);
        if (hasCostData) {
          allSteps.forEach(step => {
            totalCost += calculateStepCost(step, config.personas);
          });
        }

        // Calculate potential savings
        const potentialSavings = allSteps.reduce((acc, s) => {
          const cost = calculateStepCost(s, config.personas);
          if (s.automationOpportunity === 'high') return acc + cost * 0.7;
          if (s.automationOpportunity === 'medium') return acc + cost * 0.4;
          if (s.automationOpportunity === 'low') return acc + cost * 0.1;
          return acc;
        }, 0);

        // Stage metrics
        const stageMetrics = config.stages.map(stage => {
          const stageSteps = stage.steps || [];
          const stageTime = stageSteps.reduce((acc, s) => acc + (s.timeMinutes || 0), 0);
          const stageCost = stageSteps.reduce((acc, s) => acc + calculateStepCost(s, config.personas), 0);
          const stagePainPoints = stageSteps.reduce((acc, s) => acc + (s.painPoints?.length || 0), 0);
          const stageFrictionValues = stageSteps.map(s => s.frictionScore || frictionMap[s.friction]).filter(Boolean);
          const avgStageFriction = stageFrictionValues.length ? (stageFrictionValues.reduce((a, b) => a + b, 0) / stageFrictionValues.length).toFixed(1) : 'N/A';
          return { name: stage.name, stepCount: stageSteps.length, time: stageTime, cost: stageCost, painPoints: stagePainPoints, avgFriction: avgStageFriction, dropOffCount: stage.dropOffCount || 0 };
        });

        // Role costs
        const roleCosts = (config.personas || []).filter(p => !p.isExternal && (p.salary || p.annualSalary)).map(persona => {
          let roleTime = 0;
          let roleCost = 0;
          allSteps.forEach(step => {
            const inv = step.roleInvolvement?.[persona.id];
            if (inv) {
              roleTime += inv.timeMinutes || 0;
              const hourlyRate = calculateHourlyRate(persona.salary || persona.annualSalary, persona.burdenMultiplier);
              roleCost += (inv.timeMinutes / 60) * hourlyRate * (inv.headcount || 1);
            }
          });
          return { label: persona.label || persona.name, color: persona.color, totalMinutes: roleTime, totalCost: roleCost };
        }).filter(r => r.totalCost > 0).sort((a, b) => b.totalCost - a.totalCost);

        // Top expensive steps
        const topExpensiveSteps = allSteps.map(s => ({ ...s, cost: calculateStepCost(s, config.personas) })).sort((a, b) => b.cost - a.cost).slice(0, 5);
        
        // Top improvement opportunities
        const topImprovements = allSteps.filter(s => s.automationOpportunity === 'high' || s.automationOpportunity === 'medium').map(s => {
          const cost = calculateStepCost(s, config.personas);
          const savings = s.automationOpportunity === 'high' ? cost * 0.7 : cost * 0.4;
          return { ...s, cost, savings };
        }).sort((a, b) => b.savings - a.savings).slice(0, 8);

        const date = new Date().toLocaleDateString('en-GB', { day: 'numeric', month: 'long', year: 'numeric' });
        const title = config.meta?.title || map?.title || 'Journey Map';

        // Build HTML using arrays to avoid nested template literals
        const parts = [];
        
        parts.push('<!DOCTYPE html><html><head><meta charset="UTF-8"><title>' + title + ' - Complete Report</title>');
        parts.push('<style>');
        parts.push('@page { margin: 15mm; size: A4; }');
        parts.push('* { box-sizing: border-box; margin: 0; padding: 0; }');
        parts.push('body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif; color: #1F2937; line-height: 1.5; padding: 32px 40px; max-width: 1000px; margin: 0 auto; font-size: 12px; }');
        parts.push('.header { background: #192B45; color: #FFF; padding: 24px 28px; border-radius: 8px; margin-bottom: 24px; display: flex; justify-content: space-between; align-items: center; }');
        parts.push('.header h1 { font-size: 24px; font-weight: 600; margin-bottom: 4px; }');
        parts.push('.header .subtitle { font-size: 14px; opacity: 0.8; }');
        parts.push('.header .meta { text-align: right; font-size: 11px; opacity: 0.7; }');
        parts.push('.section { margin-bottom: 28px; page-break-inside: avoid; }');
        parts.push('.section-title { font-size: 16px; font-weight: 600; color: #192B45; margin-bottom: 12px; padding-bottom: 6px; border-bottom: 2px solid #2D8A6E; }');
        parts.push('.summary-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 12px; margin-bottom: 20px; }');
        parts.push('.summary-grid.cols-3 { grid-template-columns: repeat(3, 1fr); }');
        parts.push('.summary-card { background: #F8FAFC; border: 1px solid #E2E8F0; border-radius: 8px; padding: 14px; text-align: center; }');
        parts.push('.summary-card.highlight-green { background: #D1FAE5; border-color: #A7F3D0; }');
        parts.push('.summary-card.highlight-red { background: #FEE2E2; border-color: #FECACA; }');
        parts.push('.summary-card.highlight-amber { background: #FEF3C7; border-color: #FDE68A; }');
        parts.push('.summary-value { font-size: 20px; font-weight: 700; color: #192B45; }');
        parts.push('.summary-label { font-size: 9px; color: #64748B; text-transform: uppercase; letter-spacing: 0.5px; margin-top: 4px; }');
        parts.push('table { width: 100%; border-collapse: collapse; font-size: 11px; margin-bottom: 16px; }');
        parts.push('th, td { padding: 8px 10px; text-align: left; border-bottom: 1px solid #E2E8F0; }');
        parts.push('th { background: #F8FAFC; font-weight: 600; color: #475569; font-size: 9px; text-transform: uppercase; }');
        parts.push('.num { text-align: right; }');
        parts.push('.text-green { color: #059669; }');
        parts.push('.text-red { color: #DC2626; }');
        parts.push('.two-column { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }');
        parts.push('.stage-header { background: #2D8A6E; color: #FFF; padding: 10px 14px; border-radius: 6px 6px 0 0; display: flex; justify-content: space-between; font-size: 12px; }');
        parts.push('.badge { display: inline-block; padding: 2px 8px; border-radius: 10px; font-size: 10px; font-weight: 500; }');
        parts.push('.badge-high { background: #D1FAE5; color: #059669; }');
        parts.push('.badge-medium { background: #FEF3C7; color: #D97706; }');
        parts.push('.badge-low { background: #E2E8F0; color: #64748B; }');
        parts.push('.rpt-footer { margin-top: 32px; padding-top: 16px; border-top: 1px solid #C8CED6; font-size: 10px; color: #8A95A5; text-align: center; }');
        parts.push('@media print { .page-break { page-break-before: always; } }');
        parts.push('</style></head><body>');

        // Header
        parts.push('<div class="header"><div><h1>' + title + '</h1><div class="subtitle">Complete Journey Analysis Report</div></div>');
        parts.push('<div class="meta">Generated: ' + date + '<br/>Version: ' + (config.meta?.version || '1.0') + '</div></div>');

        // Executive Summary
        parts.push('<div class="section"><div class="section-title">üìä Executive Summary</div>');
        parts.push('<div class="summary-grid">');
        parts.push('<div class="summary-card"><div class="summary-value">' + config.stages.length + '</div><div class="summary-label">Stages</div></div>');
        parts.push('<div class="summary-card"><div class="summary-value">' + allSteps.length + '</div><div class="summary-label">Steps</div></div>');
        parts.push('<div class="summary-card"><div class="summary-value">' + formatTime(totalTime) + '</div><div class="summary-label">Total Time</div></div>');
        parts.push('<div class="summary-card highlight-amber"><div class="summary-value">' + (hasCostData ? formatCurrency(totalCost) : 'N/A') + '</div><div class="summary-label">Total Cost</div></div>');
        parts.push('</div>');
        parts.push('<div class="summary-grid">');
        parts.push('<div class="summary-card highlight-red"><div class="summary-value">' + totalPainPoints + '</div><div class="summary-label">Pain Points</div></div>');
        parts.push('<div class="summary-card"><div class="summary-value">' + avgFriction + '/5</div><div class="summary-label">Avg Friction</div></div>');
        parts.push('<div class="summary-card"><div class="summary-value">' + highAutomationCount + '</div><div class="summary-label">High Improvement Opps</div></div>');
        parts.push('<div class="summary-card highlight-green"><div class="summary-value">' + (hasCostData ? formatCurrency(potentialSavings) : 'N/A') + '</div><div class="summary-label">Potential Savings</div></div>');
        parts.push('</div></div>');

        // Timeline Analysis
        parts.push('<div class="section"><div class="section-title">‚è±Ô∏è Timeline Analysis</div>');
        parts.push('<table><thead><tr><th>Stage</th><th class="num">Steps</th><th class="num">Time</th><th class="num">% of Total</th><th class="num">Avg Friction</th><th class="num">Pain Points</th></tr></thead><tbody>');
        stageMetrics.forEach(function(s) {
          var pct = totalTime > 0 ? ((s.time / totalTime) * 100).toFixed(1) : 0;
          parts.push('<tr><td>' + s.name + '</td><td class="num">' + s.stepCount + '</td><td class="num">' + formatTime(s.time) + '</td><td class="num">' + pct + '%</td><td class="num">' + s.avgFriction + '/5</td><td class="num">' + s.painPoints + '</td></tr>');
        });
        parts.push('<tr style="font-weight:600;background:#F8FAFC"><td>Total</td><td class="num">' + allSteps.length + '</td><td class="num">' + formatTime(totalTime) + '</td><td class="num">100%</td><td class="num">' + avgFriction + '/5</td><td class="num">' + totalPainPoints + '</td></tr>');
        parts.push('</tbody></table></div>');

        // Cost Analysis
        if (hasCostData) {
          parts.push('<div class="section"><div class="section-title">üí∞ Cost Analysis</div>');
          parts.push('<div class="two-column"><div><h4 style="font-size:12px;margin-bottom:8px;color:#475569">Cost by Stage</h4>');
          parts.push('<table><thead><tr><th>Stage</th><th class="num">Time</th><th class="num">Cost</th><th class="num">%</th></tr></thead><tbody>');
          stageMetrics.forEach(function(s) {
            var pct = totalCost > 0 ? ((s.cost / totalCost) * 100).toFixed(1) : 0;
            parts.push('<tr><td>' + s.name + '</td><td class="num">' + formatTime(s.time) + '</td><td class="num">' + formatCurrency(s.cost) + '</td><td class="num">' + pct + '%</td></tr>');
          });
          parts.push('</tbody></table></div>');
          
          parts.push('<div><h4 style="font-size:12px;margin-bottom:8px;color:#475569">Cost by Role</h4>');
          parts.push('<table><thead><tr><th>Role</th><th class="num">Time</th><th class="num">Cost</th><th class="num">%</th></tr></thead><tbody>');
          roleCosts.forEach(function(r) {
            var pct = totalCost > 0 ? ((r.totalCost / totalCost) * 100).toFixed(1) : 0;
            parts.push('<tr><td>' + r.label + '</td><td class="num">' + formatTime(r.totalMinutes) + '</td><td class="num">' + formatCurrency(r.totalCost) + '</td><td class="num">' + pct + '%</td></tr>');
          });
          parts.push('</tbody></table></div></div>');

          // Top Expensive Steps
          if (topExpensiveSteps.length > 0) {
            parts.push('<h4 style="font-size:12px;margin:16px 0 8px;color:#475569">üî• Top 5 Most Expensive Steps</h4>');
            parts.push('<table><thead><tr><th>#</th><th>Step</th><th>Stage</th><th class="num">Cost</th></tr></thead><tbody>');
            topExpensiveSteps.forEach(function(s, i) {
              parts.push('<tr><td>' + (i + 1) + '</td><td>' + s.name + '</td><td>' + s.stageName + '</td><td class="num">' + formatCurrency(s.cost) + '</td></tr>');
            });
            parts.push('</tbody></table>');
          }
          parts.push('</div>');
        }

        // Improvement Opportunities
        if (topImprovements.length > 0 && hasCostData) {
          parts.push('<div class="section"><div class="section-title">üéØ Top Improvement Opportunities</div>');
          parts.push('<table><thead><tr><th>Step</th><th>Stage</th><th class="num">Current Cost</th><th class="num">Opportunity</th><th class="num">Potential Savings</th></tr></thead><tbody>');
          topImprovements.forEach(function(s) {
            parts.push('<tr><td>' + s.name + '</td><td>' + s.stageName + '</td><td class="num">' + formatCurrency(s.cost) + '</td><td class="num"><span class="badge badge-' + s.automationOpportunity + '">' + s.automationOpportunity + '</span></td><td class="num text-green">' + formatCurrency(s.savings) + '</td></tr>');
          });
          parts.push('</tbody></table></div>');
        }

        // Detailed Stage Breakdown
        parts.push('<div class="section page-break"><div class="section-title">üìã Detailed Stage Breakdown</div>');
        config.stages.forEach(function(stage, si) {
          var stageSteps = stage.steps || [];
          var stageTime = stageSteps.reduce(function(acc, s) { return acc + (s.timeMinutes || 0); }, 0);
          var stageCost = stageSteps.reduce(function(acc, s) { return acc + calculateStepCost(s, config.personas); }, 0);
          
          parts.push('<div style="margin-bottom:16px;">');
          parts.push('<div class="stage-header"><span>' + stage.name + '</span><span>' + stageSteps.length + ' steps ¬∑ ' + formatTime(stageTime) + (hasCostData ? ' ¬∑ ' + formatCurrency(stageCost) : '') + '</span></div>');
          parts.push('<table><thead><tr><th style="width:40px">#</th><th>Step</th><th style="width:70px" class="num">Time</th>' + (hasCostData ? '<th style="width:80px" class="num">Cost</th>' : '') + '<th>Pain Points</th><th style="width:80px" class="num">Improvement</th></tr></thead><tbody>');
          
          stageSteps.forEach(function(step, sti) {
            var stepCost = calculateStepCost(step, config.personas);
            var owner = config.personas?.find(function(p) { return p.id === step.owner; });
            var painPointsHtml = (step.painPoints || []).length > 0 ? (step.painPoints || []).map(function(p) { return '‚ö† ' + p; }).join('<br/>') : '‚Äî';
            
            parts.push('<tr>');
            parts.push('<td>' + (si + 1) + '.' + (sti + 1) + '</td>');
            parts.push('<td><strong>' + step.name + '</strong><div style="font-size:10px;color:#64748B">' + (owner?.label || '') + (step.clientTouchpoint ? ' ¬∑ üë§ Client' : '') + '</div></td>');
            parts.push('<td class="num">' + formatTime(step.timeMinutes || 0) + '</td>');
            if (hasCostData) {
              parts.push('<td class="num">' + formatCurrency(stepCost) + '</td>');
            }
            parts.push('<td style="font-size:10px;color:#DC2626">' + painPointsHtml + '</td>');
            parts.push('<td class="num"><span class="badge badge-' + (step.automationOpportunity || 'none') + '">' + (step.automationOpportunity || 'none') + '</span></td>');
            parts.push('</tr>');
          });
          
          parts.push('</tbody></table></div>');
        });
        parts.push('</div>');

        // Footer
        parts.push('<div class="rpt-footer"><p>Generated by FATHOM ¬∑ ' + date + '</p><p style="margin-top:4px">üí° Use Print ‚Üí Save as PDF to save this report</p></div>');
        parts.push('<script>window.onload = function() { window.print(); }<\/script>');
        parts.push('</body></html>');

        printWindow.document.write(parts.join(''));
        printWindow.document.close();
      };

      const myMaps = maps.filter(m => m.owner === user.email).sort((a, b) => {
        if (a.favourite !== b.favourite) return a.favourite ? -1 : 1;
        return new Date(b.updatedAt) - new Date(a.updatedAt);
      });
      const sharedMaps = maps.filter(m => m.owner !== user.email && m.sharedWith?.some(s => s.email === user.email));
      
      const openMap = (mapId) => {
        if (manageMode) return; // Don't open in manage mode
        const map = maps.find(m => m.id === mapId);
        const title = mapConfigs[mapId]?.meta?.title || map?.title || 'Journey Map';
        window.location.href = `editor.html?map=${mapId}&title=${encodeURIComponent(title)}`;
      };

      // Manage mode functions
      const toggleSelectMap = (mapId) => {
        const map = maps.find(m => m.id === mapId);
        // Prevent selecting locked maps
        if (map?.locked) {
          alert('This map is locked and cannot be selected for deletion. Unlock it first.');
          return;
        }
        
        const newSelected = new Set(selectedMaps);
        if (newSelected.has(mapId)) {
          newSelected.delete(mapId);
        } else {
          newSelected.add(mapId);
        }
        setSelectedMaps(newSelected);
      };

      const toggleFavourite = async (mapId) => {
        const map = maps.find(m => m.id === mapId);
        if (!map) return;
        try {
          const updatedMap = { ...map, favourite: !map.favourite };
          const updatedMaps = maps.map(m => m.id === mapId ? updatedMap : m);
          await saveToGitHub(GITHUB_CONFIG.indexFile, { maps: updatedMaps }, token, `Toggle favourite: ${map.title}`);
          setMaps(updatedMaps);
        } catch (err) {
          console.error('Failed to toggle favourite:', err);
        }
      };

      const toggleLock = async (mapId) => {
        const map = maps.find(m => m.id === mapId);
        if (!map) return;
        try {
          const updatedMap = { ...map, locked: !map.locked };
          const updatedMaps = maps.map(m => m.id === mapId ? updatedMap : m);
          await saveToGitHub(GITHUB_CONFIG.indexFile, { maps: updatedMaps }, token, `Toggle lock: ${map.title}`);
          setMaps(updatedMaps);
        } catch (err) {
          console.error('Failed to toggle lock:', err);
        }
      };

      const deleteSelectedMaps = async () => {
        if (selectedMaps.size === 0) return;
        
        // Check for locked maps
        const lockedMaps = [...selectedMaps].filter(mapId => {
          const map = maps.find(m => m.id === mapId);
          return map?.locked;
        });
        
        if (lockedMaps.length > 0) {
          const lockedTitles = lockedMaps.map(mapId => {
            const map = maps.find(m => m.id === mapId);
            return mapConfigs[mapId]?.meta?.title || map?.title || mapId;
          }).join(', ');
          alert(`Cannot delete locked maps. Please unlock these maps first:\n\n${lockedTitles}`);
          return;
        }
        
        if (!confirm(`Delete ${selectedMaps.size} map(s)? This cannot be undone.`)) return;
        
        try {
          const mapsToDelete = [...selectedMaps];
          const updatedMaps = maps.filter(m => !selectedMaps.has(m.id));
          
          // Delete each map's config file
          for (const mapId of mapsToDelete) {
            try {
              await deleteFromGitHub(`${GITHUB_CONFIG.mapsPath}/${mapId}.json`, token, `Delete map config: ${mapId}`);
            } catch (err) {
              console.warn(`Failed to delete config for ${mapId}:`, err);
            }
          }
          
          // Update index
          await saveToGitHub(GITHUB_CONFIG.indexFile, { maps: updatedMaps }, token, `Delete ${mapsToDelete.length} map(s)`);
          setMaps(updatedMaps);
          setSelectedMaps(new Set());
          setManageMode(false);
        } catch (err) {
          console.error('Failed to delete maps:', err);
          alert('Failed to delete maps. Please try again.');
        }
      };

      const exitManageMode = () => {
        setManageMode(false);
        setSelectedMaps(new Set());
      };

      const displayMaps = activeTab === 'my-maps' ? myMaps : sharedMaps;

      return (
        <div className="page-container">
          {/* Navigation */}
          <nav className="nav">
            <div className="nav-inner">
              <div className="nav-left">
                <a href="index.html">
                  <img src="https://steveyoung74.github.io/journeymaps/logo_light.png" alt="FATHOM" className="nav-logo" />
                </a>
                <div className="nav-links">
                  <a href="dashboard.html" className="nav-link active">Dashboard</a>
                  <div className="dropdown">
                    <span className="nav-link" style={{ cursor: 'pointer' }}>Surveys ‚ñæ</span>
                    <div className="dropdown-menu">
                      <a href="survey-admin.html" className="dropdown-item">Send Surveys</a>
                      <a href="responses.html" className="dropdown-item">View Responses</a>
                    </div>
                  </div>
                  <a href="whats-new.html" className="nav-link">What's New</a>
                  <a href="about.html" className="nav-link">About</a>
                </div>
              </div>
              <div className="nav-right">
                <span className="nav-user">{user.name}</span>
                <button onClick={onLogout} className="nav-signout">Sign Out</button>
              </div>
              <button className="nav-mobile-toggle" onClick={() => setShowMobileMenu(true)}>‚ò∞</button>
            </div>
          </nav>
          
          {/* Mobile Menu - Threads-style */}
          <div className={`nav-mobile-backdrop ${showMobileMenu ? 'open' : ''}`} onClick={() => setShowMobileMenu(false)} />
          <div className={`nav-mobile-menu ${showMobileMenu ? 'open' : ''}`}>
            <div className="nav-mobile-header">
              <button className="nav-mobile-close" onClick={() => setShowMobileMenu(false)}>‚úï</button>
            </div>
            <div className="nav-mobile-links">
              <a href="dashboard.html" className="nav-mobile-link active">Dashboard</a>
              <div className="nav-mobile-section-label">Surveys</div>
              <a href="survey-admin.html" className="nav-mobile-link">Send Surveys</a>
              <a href="responses.html" className="nav-mobile-link">View Responses</a>
              <div className="nav-mobile-section-label">Info</div>
              <a href="whats-new.html" className="nav-mobile-link">What's New</a>
              <a href="about.html" className="nav-mobile-link">About</a>
            </div>
            <div className="nav-mobile-user">
              <div className="nav-mobile-user-name">Signed in as {user.name}</div>
              <button onClick={() => { setShowMobileMenu(false); onLogout(); }} className="nav-mobile-signout">Sign Out</button>
            </div>
          </div>

          {/* Main Content */}
          <main>
            <div className="main-inner">
              <div className="dash-header">
                <div className="dash-header-row">
                  <div>
                    <h1 className="dash-title">Your Journey Maps</h1>
                    <p className="dash-subtitle">Create, manage, and share operational journey maps</p>
                  </div>
                  <button onClick={() => token ? setShowCreateModal(true) : setShowTokenModal(true)} className="btn btn-primary">
                    + New Map
                  </button>
                </div>
              </div>

              {/* Tabs */}
              <div className="tabs" style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center' }}>
                <div style={{ display: 'flex', gap: '8px' }}>
                  <button className={`tab-btn ${activeTab === 'my-maps' ? 'active' : ''}`} onClick={() => { setActiveTab('my-maps'); exitManageMode(); }}>
                    My Maps ({myMaps.length})
                  </button>
                  <button className={`tab-btn ${activeTab === 'shared' ? 'active' : ''}`} onClick={() => { setActiveTab('shared'); exitManageMode(); }}>
                    Shared with Me ({sharedMaps.length})
                  </button>
                </div>
                {activeTab === 'my-maps' && token && !manageMode && (
                  <button onClick={() => setManageMode(true)} className="btn btn-ghost" style={{ fontSize: '13px' }}>
                    ‚öôÔ∏è Manage
                  </button>
                )}
                {manageMode && (
                  <button onClick={exitManageMode} className="btn btn-ghost" style={{ fontSize: '13px' }}>
                    ‚úï Done
                  </button>
                )}
              </div>

              {/* Manage Mode Bar */}
              {manageMode && (
                <div style={{ 
                  background: 'var(--slate-100)', 
                  padding: '12px 16px', 
                  borderRadius: '8px', 
                  marginBottom: '20px',
                  display: 'flex',
                  justifyContent: 'space-between',
                  alignItems: 'center'
                }}>
                  <span style={{ fontSize: '14px', color: 'var(--slate-600)' }}>
                    {selectedMaps.size} selected
                  </span>
                  <div style={{ display: 'flex', gap: '8px' }}>
                    {selectedMaps.size > 0 && (
                      <button onClick={deleteSelectedMaps} className="btn" style={{ background: 'var(--error)', color: '#FFF', fontSize: '13px', padding: '8px 16px' }}>
                        üóëÔ∏è Delete Selected
                      </button>
                    )}
                  </div>
                </div>
              )}

              {/* Content */}
              {loading ? (
                <div style={{ textAlign: 'center', padding: '60px 20px', color: 'var(--slate-500)' }}>Loading maps...</div>
              ) : error ? (
                <div style={{ textAlign: 'center', padding: '60px 20px', color: 'var(--error)' }}>{error}</div>
              ) : displayMaps.length === 0 ? (
                <div style={{ textAlign: 'center', padding: '60px 20px', color: 'var(--slate-500)' }}>
                  {activeTab === 'my-maps' ? 'No maps yet. Create your first journey map!' : 'No maps shared with you yet.'}
                </div>
              ) : (
                <div className="cards-grid">
                  {displayMaps.map(map => {
                    const metrics = getMapMetrics(map.id);
                    const isOwner = map.owner === user.email;
                    const isSelected = selectedMaps.has(map.id);
                    const isLocked = map.locked;
                    const canSelect = isOwner && !isLocked;
                    return (
                      <div 
                        key={map.id} 
                        className="card journey-card" 
                        onClick={() => manageMode && canSelect ? toggleSelectMap(map.id) : !manageMode ? openMap(map.id) : null}
                        style={{ 
                          cursor: manageMode ? (canSelect ? 'pointer' : 'not-allowed') : 'pointer',
                          border: isSelected ? '2px solid var(--amber-500)' : '1px solid var(--slate-200)',
                          opacity: manageMode && (!isOwner || isLocked) ? 0.5 : 1
                        }}
                      >
                        {/* Manage mode checkbox - only show for unlocked owned maps */}
                        {manageMode && isOwner && (
                          <div style={{ 
                            position: 'absolute', 
                            top: '12px', 
                            left: '12px',
                            width: '20px',
                            height: '20px',
                            borderRadius: '4px',
                            border: isSelected ? 'none' : isLocked ? '2px solid var(--slate-200)' : '2px solid var(--slate-300)',
                            background: isSelected ? 'var(--amber-500)' : isLocked ? 'var(--slate-100)' : '#FFF',
                            display: 'flex',
                            alignItems: 'center',
                            justifyContent: 'center',
                            color: isLocked ? 'var(--slate-400)' : '#FFF',
                            fontSize: '14px',
                            zIndex: 2
                          }}>
                            {isSelected && '‚úì'}
                            {isLocked && !isSelected && 'üîí'}
                          </div>
                        )}
                        
                        <div className="journey-card-icons">
                          {map.favourite && <span title="Favourite">‚≠ê</span>}
                          {map.locked && <span title="Locked">üîí</span>}
                        </div>
                        
                        <h3 className="journey-card-title" style={{ paddingLeft: manageMode && isOwner ? '32px' : 0 }}>{mapConfigs[map.id]?.meta?.title || map.title}</h3>
                        <p className="journey-card-desc" style={{ paddingLeft: manageMode && isOwner ? '32px' : 0 }}>{mapConfigs[map.id]?.meta?.description || map.description || 'No description'}</p>
                        
                        {metrics && (
                          <div className="journey-card-metrics">
                            <div className="metric" title="Total time">
                              <span>‚è±Ô∏è</span>
                              <span className="metric-value">{formatTime(metrics.totalTime)}</span>
                            </div>
                            <span className="metric-dot">¬∑</span>
                            <div className="metric" title="Stages / Steps">
                              <span>üìã</span>
                              <span>{metrics.stageCount} / {metrics.totalSteps}</span>
                            </div>
                            {metrics.avgFriction && (
                              <>
                                <span className="metric-dot">¬∑</span>
                                <div className="metric" title="Avg friction">
                                  <span>{metrics.avgFriction >= 4 ? 'üò∞' : metrics.avgFriction >= 3 ? 'üòê' : 'üôÇ'}</span>
                                  <span>{metrics.avgFriction}/5</span>
                                </div>
                              </>
                            )}
                            {metrics.totalPainPoints > 0 && (
                              <>
                                <span className="metric-dot">¬∑</span>
                                <div className="metric" title="Pain points">
                                  <span>‚ö†Ô∏è</span>
                                  <span style={{ color: 'var(--error)' }}>{metrics.totalPainPoints}</span>
                                </div>
                              </>
                            )}
                            {metrics.highImprovements > 0 && (
                              <>
                                <span className="metric-dot">¬∑</span>
                                <div className="metric" title="High improvement opps">
                                  <span>üéØ</span>
                                  <span style={{ color: 'var(--success)' }}>{metrics.highImprovements}</span>
                                </div>
                              </>
                            )}
                            {metrics.totalCost !== null && (
                              <>
                                <span className="metric-dot">¬∑</span>
                                <div className="metric" title="Cost per journey">
                                  <span>üí∑</span>
                                  <span className="metric-value">{formatCurrency(metrics.totalCost)}</span>
                                </div>
                              </>
                            )}
                          </div>
                        )}
                        
                        <div className="journey-card-footer">
                          <span className="journey-card-date">
                            Updated {formatDate(map.updatedAt)}
                            {map.sharedWith?.length > 0 && <span> ¬∑ üë• {map.sharedWith.length}</span>}
                          </span>
                          
                          {/* Normal mode actions */}
                          {!manageMode && isOwner && (
                            <div className="journey-card-actions" onClick={e => e.stopPropagation()}>
                              <button onClick={() => generateReport(map.id)} className="btn btn-ghost">üìÑ Report</button>
                              <button onClick={() => window.location.href = `responses.html?map=${map.id}`} className="btn btn-ghost">üìä Responses</button>
                              <button onClick={() => setShowShareModal(map.id)} className="btn btn-ghost">Share</button>
                            </div>
                          )}
                          
                          {/* Manage mode actions */}
                          {manageMode && isOwner && (
                            <div className="journey-card-actions" onClick={e => e.stopPropagation()}>
                              <button 
                                onClick={() => toggleFavourite(map.id)} 
                                className="btn btn-ghost"
                                title={map.favourite ? 'Remove favourite' : 'Add favourite'}
                              >
                                {map.favourite ? '‚≠ê' : '‚òÜ'}
                              </button>
                              <button 
                                onClick={() => toggleLock(map.id)} 
                                className="btn btn-ghost"
                                title={map.locked ? 'Unlock' : 'Lock'}
                              >
                                {map.locked ? 'üîì' : 'üîí'}
                              </button>
                            </div>
                          )}
                        </div>
                      </div>
                    );
                  })}
                </div>
              )}
            </div>
          </main>

          {/* Footer */}
          <footer className="footer">
            <div className="footer-inner">
              <div className="footer-brand">
                <img src="https://steveyoung74.github.io/journeymaps/logo_light.png" alt="Fathom" className="footer-logo" />
                <span className="footer-version">v8.8.0</span>
              </div>
              <div className="footer-copy">¬© 2025 Fathom ¬∑ Journey intelligence for modern operations</div>
            </div>
          </footer>

          {/* Token Modal */}
          {showTokenModal && (
            <div className="modal-overlay" onClick={() => setShowTokenModal(false)}>
              <div className="modal" onClick={e => e.stopPropagation()}>
                <div className="modal-content">
                  <div className="modal-header">
                    <h2 className="modal-title">GitHub Token Required</h2>
                    <button className="modal-close" onClick={() => setShowTokenModal(false)}>√ó</button>
                  </div>
                  <p className="text-muted" style={{ marginBottom: '16px' }}>To create and edit maps, you need a GitHub token.</p>
                  <TokenForm 
                    onSave={(newToken) => { onUpdateToken(newToken); setShowTokenModal(false); setShowCreateModal(true); }}
                    onCancel={() => setShowTokenModal(false)}
                  />
                </div>
              </div>
            </div>
          )}

          {/* Create Modal */}
          {showCreateModal && (
            <CreateMapModal 
              user={user}
              token={token}
              maps={maps}
              onClose={() => setShowCreateModal(false)}
              onCreated={() => { setShowCreateModal(false); fetchMaps(); }}
            />
          )}

          {/* Share Modal */}
          {showShareModal && (
            <ShareModal
              mapId={showShareModal}
              maps={maps}
              mapConfigs={mapConfigs}
              token={token}
              onClose={() => setShowShareModal(null)}
              onUpdated={fetchMaps}
            />
          )}
        </div>
      );
    }

    // Token Form
    function TokenForm({ onSave, onCancel }) {
      const [token, setToken] = useState('');
      return (
        <div>
          <div style={{ marginBottom: '16px' }}>
            <label className="label">GitHub Personal Access Token</label>
            <input type="password" className="input" value={token} onChange={e => setToken(e.target.value)} placeholder="ghp_xxxxxxxxxxxx" />
            <p className="text-muted text-small" style={{ marginTop: '6px' }}>Create a token at github.com/settings/tokens with repo access.</p>
          </div>
          <div style={{ display: 'flex', gap: '8px' }}>
            <button onClick={() => onSave(token)} className="btn btn-primary" disabled={!token.trim()}>Save Token</button>
            <button onClick={onCancel} className="btn btn-secondary">Cancel</button>
          </div>
        </div>
      );
    }

    // ============================================
    // JOURNEY TEMPLATES
    // ============================================
    const JOURNEY_TEMPLATES = [
      {
        id: 'blank',
        name: 'Blank Canvas',
        description: 'Start from scratch with an empty journey map',
        icon: 'üìÑ',
        industry: 'Any',
        stageCount: 1,
        config: {
          title: 'New Journey Map',
          currency: '¬£',
          stages: [
            { id: 'stage-1', name: 'Stage 1', steps: [{ id: 'step-1-1', name: 'First Step', time: 30, personaId: null, friction: 'none', notes: '' }] }
          ],
          personas: [
            { id: 'customer', name: 'Customer', salary: 0, isExternal: true },
            { id: 'staff', name: 'Staff Member', salary: 35000, isExternal: false }
          ],
          funnelConfig: { enabled: false, startVolume: 100, stages: {} }
        }
      },
      {
        id: 'financial_client_onboarding',
        name: 'Client Onboarding',
        description: 'Wealth management with KYC & compliance',
        icon: 'üè¶',
        industry: 'Financial Services',
        stageCount: 6,
        config: {
          title: 'Client Onboarding Journey',
          currency: '¬£',
          stages: [
            { id: 'stage-discovery', name: 'Discovery & Qualification', steps: [
              { id: 'step-1-1', name: 'Initial Enquiry Received', time: 15, personaId: 'administrator', friction: 'none', notes: 'Via web form, phone, or referral' },
              { id: 'step-1-2', name: 'Qualification Call', time: 45, personaId: 'advisor', friction: 'low', notes: 'Assess fit and requirements' },
              { id: 'step-1-3', name: 'Send Welcome Pack', time: 20, personaId: 'administrator', friction: 'none', notes: '' },
              { id: 'step-1-4', name: 'Schedule Discovery Meeting', time: 15, personaId: 'administrator', friction: 'none', notes: '' }
            ]},
            { id: 'stage-kyc', name: 'KYC & Compliance', steps: [
              { id: 'step-2-1', name: 'Collect ID Documents', time: 30, personaId: 'client', friction: 'medium', notes: 'Passport, proof of address' },
              { id: 'step-2-2', name: 'Verify Identity (AML Check)', time: 45, personaId: 'compliance', friction: 'low', notes: '' },
              { id: 'step-2-3', name: 'Source of Wealth Declaration', time: 60, personaId: 'client', friction: 'high', notes: 'Often requires chasing' },
              { id: 'step-2-4', name: 'Compliance Review & Sign-off', time: 30, personaId: 'compliance', friction: 'medium', notes: '' },
              { id: 'step-2-5', name: 'Risk Profiling Questionnaire', time: 25, personaId: 'client', friction: 'low', notes: '' }
            ]},
            { id: 'stage-factfind', name: 'Fact Find & Analysis', steps: [
              { id: 'step-3-1', name: 'Discovery Meeting', time: 90, personaId: 'advisor', friction: 'none', notes: '' },
              { id: 'step-3-2', name: 'Gather Financial Information', time: 120, personaId: 'client', friction: 'high', notes: '' },
              { id: 'step-3-3', name: 'Input Data to Planning System', time: 60, personaId: 'paraplanner', friction: 'medium', notes: '' },
              { id: 'step-3-4', name: 'Cash Flow Modelling', time: 120, personaId: 'paraplanner', friction: 'low', notes: '' },
              { id: 'step-3-5', name: 'Research & Provider Selection', time: 180, personaId: 'paraplanner', friction: 'medium', notes: '' }
            ]},
            { id: 'stage-advice', name: 'Advice & Recommendation', steps: [
              { id: 'step-4-1', name: 'Draft Suitability Report', time: 240, personaId: 'paraplanner', friction: 'medium', notes: '' },
              { id: 'step-4-2', name: 'Advisor Review', time: 60, personaId: 'advisor', friction: 'low', notes: '' },
              { id: 'step-4-3', name: 'Compliance Review', time: 45, personaId: 'compliance', friction: 'medium', notes: '' },
              { id: 'step-4-4', name: 'Recommendation Meeting', time: 90, personaId: 'advisor', friction: 'none', notes: '' }
            ]},
            { id: 'stage-implementation', name: 'Implementation', steps: [
              { id: 'step-5-1', name: 'Prepare Application Forms', time: 45, personaId: 'administrator', friction: 'medium', notes: '' },
              { id: 'step-5-2', name: 'Client Signatures', time: 30, personaId: 'client', friction: 'medium', notes: '' },
              { id: 'step-5-3', name: 'Submit Applications', time: 30, personaId: 'administrator', friction: 'low', notes: '' },
              { id: 'step-5-4', name: 'Chase Providers', time: 60, personaId: 'administrator', friction: 'high', notes: '' }
            ]},
            { id: 'stage-handover', name: 'Handover & Review', steps: [
              { id: 'step-6-1', name: 'Welcome to Service Call', time: 30, personaId: 'advisor', friction: 'none', notes: '' },
              { id: 'step-6-2', name: 'Portal Setup', time: 20, personaId: 'administrator', friction: 'low', notes: '' },
              { id: 'step-6-3', name: 'Schedule Annual Review', time: 10, personaId: 'administrator', friction: 'none', notes: '' }
            ]}
          ],
          personas: [
            { id: 'client', name: 'Client', salary: 0, isExternal: true },
            { id: 'advisor', name: 'Financial Advisor', salary: 75000, isExternal: false },
            { id: 'paraplanner', name: 'Paraplanner', salary: 45000, isExternal: false },
            { id: 'administrator', name: 'Administrator', salary: 28000, isExternal: false },
            { id: 'compliance', name: 'Compliance Officer', salary: 55000, isExternal: false }
          ],
          funnelConfig: { enabled: true, startVolume: 100, stages: { 'stage-discovery': { dropOff: 25 }, 'stage-kyc': { dropOff: 10 }, 'stage-factfind': { dropOff: 5 }, 'stage-advice': { dropOff: 10 }, 'stage-implementation': { dropOff: 5 }, 'stage-handover': { dropOff: 0 } }}
        }
      },
      { id: 'mortgage_application', name: 'Mortgage Application', description: 'Enquiry to completion, 30-60 day cycle', icon: 'üè†', industry: 'Financial Services', stageCount: 5, config: { title: 'Mortgage Application Journey', currency: '¬£', stages: [{ id: 'stage-1', name: 'Initial Enquiry', steps: [{ id: 's1-1', name: 'Customer Enquiry', time: 15, personaId: 'customer', friction: 'none', notes: '' }, { id: 's1-2', name: 'Initial Assessment', time: 30, personaId: 'advisor', friction: 'low', notes: '' }]}, { id: 'stage-2', name: 'Application', steps: [{ id: 's2-1', name: 'Full Application', time: 60, personaId: 'customer', friction: 'medium', notes: '' }, { id: 's2-2', name: 'Document Collection', time: 90, personaId: 'admin', friction: 'high', notes: '' }]}, { id: 'stage-3', name: 'Underwriting', steps: [{ id: 's3-1', name: 'Credit Check', time: 30, personaId: 'underwriter', friction: 'low', notes: '' }, { id: 's3-2', name: 'Valuation', time: 120, personaId: 'valuer', friction: 'medium', notes: '' }]}, { id: 'stage-4', name: 'Offer', steps: [{ id: 's4-1', name: 'Mortgage Offer', time: 45, personaId: 'underwriter', friction: 'low', notes: '' }, { id: 's4-2', name: 'Customer Acceptance', time: 30, personaId: 'customer', friction: 'low', notes: '' }]}, { id: 'stage-5', name: 'Completion', steps: [{ id: 's5-1', name: 'Legal Completion', time: 60, personaId: 'solicitor', friction: 'medium', notes: '' }, { id: 's5-2', name: 'Funds Transfer', time: 30, personaId: 'admin', friction: 'low', notes: '' }]}], personas: [{ id: 'customer', name: 'Customer', salary: 0, isExternal: true }, { id: 'advisor', name: 'Mortgage Advisor', salary: 45000, isExternal: false }, { id: 'admin', name: 'Administrator', salary: 28000, isExternal: false }, { id: 'underwriter', name: 'Underwriter', salary: 42000, isExternal: false }, { id: 'valuer', name: 'Valuer', salary: 0, isExternal: true }, { id: 'solicitor', name: 'Solicitor', salary: 0, isExternal: true }], funnelConfig: { enabled: true, startVolume: 100, stages: {} }}},
      { id: 'insurance_claim', name: 'Insurance Claim', description: 'FNOL to settlement with fraud checks', icon: 'üõ°Ô∏è', industry: 'Financial Services', stageCount: 5, config: { title: 'Insurance Claim Journey', currency: '¬£', stages: [{ id: 'stage-1', name: 'FNOL', steps: [{ id: 's1-1', name: 'First Notice of Loss', time: 20, personaId: 'customer', friction: 'medium', notes: '' }, { id: 's1-2', name: 'Claim Registration', time: 15, personaId: 'handler', friction: 'low', notes: '' }]}, { id: 'stage-2', name: 'Assessment', steps: [{ id: 's2-1', name: 'Document Review', time: 45, personaId: 'handler', friction: 'low', notes: '' }, { id: 's2-2', name: 'Fraud Screening', time: 30, personaId: 'fraud', friction: 'low', notes: '' }]}, { id: 'stage-3', name: 'Investigation', steps: [{ id: 's3-1', name: 'Loss Adjuster Visit', time: 120, personaId: 'adjuster', friction: 'medium', notes: '' }, { id: 's3-2', name: 'Report Compilation', time: 90, personaId: 'adjuster', friction: 'low', notes: '' }]}, { id: 'stage-4', name: 'Decision', steps: [{ id: 's4-1', name: 'Claim Decision', time: 30, personaId: 'handler', friction: 'low', notes: '' }, { id: 's4-2', name: 'Customer Notification', time: 15, personaId: 'handler', friction: 'low', notes: '' }]}, { id: 'stage-5', name: 'Settlement', steps: [{ id: 's5-1', name: 'Payment Processing', time: 30, personaId: 'finance', friction: 'low', notes: '' }, { id: 's5-2', name: 'Claim Closure', time: 15, personaId: 'handler', friction: 'none', notes: '' }]}], personas: [{ id: 'customer', name: 'Policyholder', salary: 0, isExternal: true }, { id: 'handler', name: 'Claims Handler', salary: 32000, isExternal: false }, { id: 'fraud', name: 'Fraud Analyst', salary: 38000, isExternal: false }, { id: 'adjuster', name: 'Loss Adjuster', salary: 0, isExternal: true }, { id: 'finance', name: 'Finance', salary: 35000, isExternal: false }], funnelConfig: { enabled: true, startVolume: 100, stages: {} }}},
      { id: 'bank_account', name: 'Bank Account Opening', description: 'Personal or business with AML screening', icon: 'üí≥', industry: 'Financial Services', stageCount: 4, config: { title: 'Bank Account Opening Journey', currency: '¬£', stages: [{ id: 'stage-1', name: 'Application', steps: [{ id: 's1-1', name: 'Online Application', time: 20, personaId: 'customer', friction: 'low', notes: '' }, { id: 's1-2', name: 'ID Verification', time: 15, personaId: 'customer', friction: 'medium', notes: '' }]}, { id: 'stage-2', name: 'KYC', steps: [{ id: 's2-1', name: 'AML Screening', time: 30, personaId: 'compliance', friction: 'low', notes: '' }, { id: 's2-2', name: 'Risk Assessment', time: 20, personaId: 'compliance', friction: 'low', notes: '' }]}, { id: 'stage-3', name: 'Account Setup', steps: [{ id: 's3-1', name: 'Account Creation', time: 15, personaId: 'ops', friction: 'none', notes: '' }, { id: 's3-2', name: 'Card Issuance', time: 10, personaId: 'ops', friction: 'none', notes: '' }]}, { id: 'stage-4', name: 'Activation', steps: [{ id: 's4-1', name: 'Welcome Pack', time: 10, personaId: 'ops', friction: 'none', notes: '' }, { id: 's4-2', name: 'First Login', time: 15, personaId: 'customer', friction: 'low', notes: '' }]}], personas: [{ id: 'customer', name: 'Customer', salary: 0, isExternal: true }, { id: 'compliance', name: 'Compliance', salary: 40000, isExternal: false }, { id: 'ops', name: 'Operations', salary: 28000, isExternal: false }], funnelConfig: { enabled: true, startVolume: 100, stages: {} }}},
      { id: 'personal_loan', name: 'Personal Loan', description: 'Application to disbursement', icon: 'üí∑', industry: 'Financial Services', stageCount: 4, config: { title: 'Personal Loan Journey', currency: '¬£', stages: [{ id: 'stage-1', name: 'Application', steps: [{ id: 's1-1', name: 'Loan Application', time: 20, personaId: 'customer', friction: 'low', notes: '' }, { id: 's1-2', name: 'Income Verification', time: 30, personaId: 'customer', friction: 'medium', notes: '' }]}, { id: 'stage-2', name: 'Assessment', steps: [{ id: 's2-1', name: 'Credit Check', time: 15, personaId: 'underwriter', friction: 'low', notes: '' }, { id: 's2-2', name: 'Affordability Check', time: 30, personaId: 'underwriter', friction: 'low', notes: '' }]}, { id: 'stage-3', name: 'Decision', steps: [{ id: 's3-1', name: 'Loan Decision', time: 20, personaId: 'underwriter', friction: 'low', notes: '' }, { id: 's3-2', name: 'Offer Letter', time: 15, personaId: 'ops', friction: 'none', notes: '' }]}, { id: 'stage-4', name: 'Disbursement', steps: [{ id: 's4-1', name: 'Agreement Signing', time: 15, personaId: 'customer', friction: 'low', notes: '' }, { id: 's4-2', name: 'Funds Transfer', time: 30, personaId: 'ops', friction: 'none', notes: '' }]}], personas: [{ id: 'customer', name: 'Customer', salary: 0, isExternal: true }, { id: 'underwriter', name: 'Underwriter', salary: 38000, isExternal: false }, { id: 'ops', name: 'Operations', salary: 28000, isExternal: false }], funnelConfig: { enabled: true, startVolume: 100, stages: {} }}},
      { id: 'patient_registration', name: 'Patient Registration & Admission', description: 'Front door, insurance verification, consent', icon: 'üè•', industry: 'Healthcare', stageCount: 4, config: { title: 'Patient Registration Journey', currency: '¬£', stages: [{ id: 'stage-1', name: 'Registration', steps: [{ id: 's1-1', name: 'Patient Arrival', time: 10, personaId: 'patient', friction: 'low', notes: '' }, { id: 's1-2', name: 'Demographics Collection', time: 15, personaId: 'receptionist', friction: 'low', notes: '' }]}, { id: 'stage-2', name: 'Verification', steps: [{ id: 's2-1', name: 'Insurance Verification', time: 20, personaId: 'admin', friction: 'medium', notes: '' }, { id: 's2-2', name: 'ID Check', time: 10, personaId: 'receptionist', friction: 'low', notes: '' }]}, { id: 'stage-3', name: 'Consent', steps: [{ id: 's3-1', name: 'Consent Forms', time: 15, personaId: 'patient', friction: 'medium', notes: '' }, { id: 's3-2', name: 'GDPR Acknowledgement', time: 5, personaId: 'patient', friction: 'low', notes: '' }]}, { id: 'stage-4', name: 'Admission', steps: [{ id: 's4-1', name: 'Triage', time: 20, personaId: 'nurse', friction: 'low', notes: '' }, { id: 's4-2', name: 'Ward Allocation', time: 15, personaId: 'admin', friction: 'low', notes: '' }]}], personas: [{ id: 'patient', name: 'Patient', salary: 0, isExternal: true }, { id: 'receptionist', name: 'Receptionist', salary: 24000, isExternal: false }, { id: 'admin', name: 'Admin', salary: 28000, isExternal: false }, { id: 'nurse', name: 'Nurse', salary: 35000, isExternal: false }], funnelConfig: { enabled: true, startVolume: 100, stages: {} }}},
      { id: 'patient_referral', name: 'Patient Referral', description: 'NHS/private pathway tracking', icon: 'üìã', industry: 'Healthcare', stageCount: 4, config: { title: 'Patient Referral Journey', currency: '¬£', stages: [{ id: 'stage-1', name: 'Referral', steps: [{ id: 's1-1', name: 'GP Consultation', time: 30, personaId: 'gp', friction: 'low', notes: '' }, { id: 's1-2', name: 'Referral Submission', time: 15, personaId: 'gp', friction: 'low', notes: '' }]}, { id: 'stage-2', name: 'Triage', steps: [{ id: 's2-1', name: 'Referral Review', time: 20, personaId: 'consultant', friction: 'low', notes: '' }, { id: 's2-2', name: 'Priority Assignment', time: 10, personaId: 'admin', friction: 'low', notes: '' }]}, { id: 'stage-3', name: 'Scheduling', steps: [{ id: 's3-1', name: 'Appointment Booking', time: 15, personaId: 'admin', friction: 'medium', notes: '' }, { id: 's3-2', name: 'Patient Notification', time: 10, personaId: 'admin', friction: 'low', notes: '' }]}, { id: 'stage-4', name: 'Consultation', steps: [{ id: 's4-1', name: 'Specialist Appointment', time: 45, personaId: 'consultant', friction: 'low', notes: '' }, { id: 's4-2', name: 'Treatment Plan', time: 30, personaId: 'consultant', friction: 'low', notes: '' }]}], personas: [{ id: 'patient', name: 'Patient', salary: 0, isExternal: true }, { id: 'gp', name: 'GP', salary: 0, isExternal: true }, { id: 'consultant', name: 'Consultant', salary: 100000, isExternal: false }, { id: 'admin', name: 'Admin', salary: 26000, isExternal: false }], funnelConfig: { enabled: true, startVolume: 100, stages: {} }}},
      { id: 'employee_onboarding', name: 'Employee Onboarding', description: 'Offer acceptance to full productivity', icon: 'üëã', industry: 'HR / People Operations', stageCount: 6, config: { title: 'Employee Onboarding Journey', currency: '¬£', stages: [{ id: 'stage-1', name: 'Pre-boarding', steps: [{ id: 's1-1', name: 'Send Offer Letter', time: 30, personaId: 'hr', friction: 'none', notes: '' }, { id: 's1-2', name: 'Contract Signed', time: 15, personaId: 'new-hire', friction: 'low', notes: '' }, { id: 's1-3', name: 'Right to Work Check', time: 30, personaId: 'hr', friction: 'medium', notes: '' }]}, { id: 'stage-2', name: 'IT Setup', steps: [{ id: 's2-1', name: 'Create Accounts', time: 45, personaId: 'it', friction: 'low', notes: '' }, { id: 's2-2', name: 'Provision Equipment', time: 60, personaId: 'it', friction: 'medium', notes: '' }]}, { id: 'stage-3', name: 'First Day', steps: [{ id: 's3-1', name: 'Welcome & Tour', time: 45, personaId: 'hr', friction: 'none', notes: '' }, { id: 's3-2', name: 'IT Handover', time: 30, personaId: 'it', friction: 'low', notes: '' }, { id: 's3-3', name: 'Team Introductions', time: 30, personaId: 'manager', friction: 'none', notes: '' }]}, { id: 'stage-4', name: 'First Week', steps: [{ id: 's4-1', name: 'Company Induction', time: 120, personaId: 'hr', friction: 'low', notes: '' }, { id: 's4-2', name: 'Role Training', time: 180, personaId: 'manager', friction: 'low', notes: '' }]}, { id: 'stage-5', name: 'First Month', steps: [{ id: 's5-1', name: 'Compliance Training', time: 240, personaId: 'new-hire', friction: 'medium', notes: '' }, { id: 's5-2', name: '30-Day Review', time: 45, personaId: 'manager', friction: 'low', notes: '' }]}, { id: 'stage-6', name: 'Probation', steps: [{ id: 's6-1', name: '90-Day Review', time: 60, personaId: 'manager', friction: 'low', notes: '' }, { id: 's6-2', name: 'Probation Sign-off', time: 30, personaId: 'hr', friction: 'low', notes: '' }]}], personas: [{ id: 'new-hire', name: 'New Hire', salary: 40000, isExternal: false }, { id: 'manager', name: 'Manager', salary: 65000, isExternal: false }, { id: 'hr', name: 'HR', salary: 32000, isExternal: false }, { id: 'it', name: 'IT', salary: 35000, isExternal: false }], funnelConfig: { enabled: true, startVolume: 50, stages: {} }}},
      { id: 'recruitment', name: 'Recruitment & Hiring', description: 'Requisition to offer acceptance', icon: 'üéØ', industry: 'HR / People Operations', stageCount: 5, config: { title: 'Recruitment Journey', currency: '¬£', stages: [{ id: 'stage-1', name: 'Requisition', steps: [{ id: 's1-1', name: 'Hiring Need', time: 30, personaId: 'manager', friction: 'none', notes: '' }, { id: 's1-2', name: 'Job Description', time: 60, personaId: 'recruiter', friction: 'low', notes: '' }]}, { id: 'stage-2', name: 'Sourcing', steps: [{ id: 's2-1', name: 'Post to Job Boards', time: 30, personaId: 'recruiter', friction: 'none', notes: '' }, { id: 's2-2', name: 'Direct Sourcing', time: 180, personaId: 'recruiter', friction: 'medium', notes: '' }]}, { id: 'stage-3', name: 'Screening', steps: [{ id: 's3-1', name: 'CV Review', time: 120, personaId: 'recruiter', friction: 'medium', notes: '' }, { id: 's3-2', name: 'Phone Screens', time: 180, personaId: 'recruiter', friction: 'low', notes: '' }]}, { id: 'stage-4', name: 'Interviews', steps: [{ id: 's4-1', name: 'First Round', time: 60, personaId: 'manager', friction: 'low', notes: '' }, { id: 's4-2', name: 'Final Round', time: 90, personaId: 'manager', friction: 'low', notes: '' }]}, { id: 'stage-5', name: 'Offer', steps: [{ id: 's5-1', name: 'References', time: 60, personaId: 'recruiter', friction: 'medium', notes: '' }, { id: 's5-2', name: 'Offer & Negotiation', time: 45, personaId: 'recruiter', friction: 'medium', notes: '' }]}], personas: [{ id: 'candidate', name: 'Candidate', salary: 0, isExternal: true }, { id: 'manager', name: 'Hiring Manager', salary: 65000, isExternal: false }, { id: 'recruiter', name: 'Recruiter', salary: 38000, isExternal: false }], funnelConfig: { enabled: true, startVolume: 150, stages: {} }}},
      { id: 'employee_offboarding', name: 'Employee Offboarding', description: 'Knowledge transfer, access revocation, exit', icon: 'üëã', industry: 'HR / People Operations', stageCount: 4, config: { title: 'Employee Offboarding Journey', currency: '¬£', stages: [{ id: 'stage-1', name: 'Resignation', steps: [{ id: 's1-1', name: 'Resignation Received', time: 15, personaId: 'manager', friction: 'none', notes: '' }, { id: 's1-2', name: 'HR Notification', time: 10, personaId: 'hr', friction: 'none', notes: '' }]}, { id: 'stage-2', name: 'Knowledge Transfer', steps: [{ id: 's2-1', name: 'Documentation', time: 120, personaId: 'leaver', friction: 'medium', notes: '' }, { id: 's2-2', name: 'Handover Meetings', time: 90, personaId: 'leaver', friction: 'low', notes: '' }]}, { id: 'stage-3', name: 'Access Revocation', steps: [{ id: 's3-1', name: 'System Access Removal', time: 30, personaId: 'it', friction: 'low', notes: '' }, { id: 's3-2', name: 'Equipment Return', time: 30, personaId: 'leaver', friction: 'low', notes: '' }]}, { id: 'stage-4', name: 'Exit', steps: [{ id: 's4-1', name: 'Exit Interview', time: 45, personaId: 'hr', friction: 'low', notes: '' }, { id: 's4-2', name: 'Final Payroll', time: 30, personaId: 'hr', friction: 'low', notes: '' }]}], personas: [{ id: 'leaver', name: 'Departing Employee', salary: 45000, isExternal: false }, { id: 'manager', name: 'Manager', salary: 60000, isExternal: false }, { id: 'hr', name: 'HR', salary: 32000, isExternal: false }, { id: 'it', name: 'IT', salary: 35000, isExternal: false }], funnelConfig: { enabled: false, startVolume: 100, stages: {} }}},
      { id: 'property_purchase', name: 'Property Purchase', description: 'Conveyancing from offer to completion', icon: 'üè°', industry: 'Property & Real Estate', stageCount: 5, config: { title: 'Property Purchase Journey', currency: '¬£', stages: [{ id: 'stage-1', name: 'Offer', steps: [{ id: 's1-1', name: 'Offer Accepted', time: 15, personaId: 'buyer', friction: 'none', notes: '' }, { id: 's1-2', name: 'Instruct Solicitor', time: 30, personaId: 'buyer', friction: 'low', notes: '' }]}, { id: 'stage-2', name: 'Searches', steps: [{ id: 's2-1', name: 'Local Authority Search', time: 60, personaId: 'solicitor', friction: 'low', notes: '' }, { id: 's2-2', name: 'Environmental Search', time: 45, personaId: 'solicitor', friction: 'low', notes: '' }]}, { id: 'stage-3', name: 'Survey', steps: [{ id: 's3-1', name: 'Survey Booked', time: 30, personaId: 'buyer', friction: 'low', notes: '' }, { id: 's3-2', name: 'Survey Report', time: 120, personaId: 'surveyor', friction: 'medium', notes: '' }]}, { id: 'stage-4', name: 'Exchange', steps: [{ id: 's4-1', name: 'Contract Review', time: 60, personaId: 'solicitor', friction: 'medium', notes: '' }, { id: 's4-2', name: 'Exchange of Contracts', time: 30, personaId: 'solicitor', friction: 'low', notes: '' }]}, { id: 'stage-5', name: 'Completion', steps: [{ id: 's5-1', name: 'Final Checks', time: 30, personaId: 'solicitor', friction: 'low', notes: '' }, { id: 's5-2', name: 'Key Handover', time: 30, personaId: 'agent', friction: 'none', notes: '' }]}], personas: [{ id: 'buyer', name: 'Buyer', salary: 0, isExternal: true }, { id: 'solicitor', name: 'Solicitor', salary: 0, isExternal: true }, { id: 'surveyor', name: 'Surveyor', salary: 0, isExternal: true }, { id: 'agent', name: 'Estate Agent', salary: 0, isExternal: true }], funnelConfig: { enabled: true, startVolume: 100, stages: {} }}},
      { id: 'tenant_move_in', name: 'Tenant Move-In', description: 'References, contracts, key handover', icon: 'üîë', industry: 'Property & Real Estate', stageCount: 4, config: { title: 'Tenant Move-In Journey', currency: '¬£', stages: [{ id: 'stage-1', name: 'Application', steps: [{ id: 's1-1', name: 'Viewing', time: 30, personaId: 'tenant', friction: 'low', notes: '' }, { id: 's1-2', name: 'Application Form', time: 20, personaId: 'tenant', friction: 'low', notes: '' }]}, { id: 'stage-2', name: 'Referencing', steps: [{ id: 's2-1', name: 'Credit Check', time: 30, personaId: 'agent', friction: 'low', notes: '' }, { id: 's2-2', name: 'Employer Reference', time: 60, personaId: 'agent', friction: 'medium', notes: '' }]}, { id: 'stage-3', name: 'Contract', steps: [{ id: 's3-1', name: 'AST Preparation', time: 30, personaId: 'agent', friction: 'low', notes: '' }, { id: 's3-2', name: 'Contract Signing', time: 30, personaId: 'tenant', friction: 'low', notes: '' }]}, { id: 'stage-4', name: 'Move-In', steps: [{ id: 's4-1', name: 'Inventory Check', time: 60, personaId: 'agent', friction: 'low', notes: '' }, { id: 's4-2', name: 'Key Handover', time: 30, personaId: 'agent', friction: 'none', notes: '' }]}], personas: [{ id: 'tenant', name: 'Tenant', salary: 0, isExternal: true }, { id: 'agent', name: 'Letting Agent', salary: 28000, isExternal: false }, { id: 'landlord', name: 'Landlord', salary: 0, isExternal: true }], funnelConfig: { enabled: true, startVolume: 100, stages: {} }}},
      { id: 'legal_client_intake', name: 'Client Intake (Law Firm)', description: 'Conflict checks, engagement letters, AML/KYC', icon: '‚öñÔ∏è', industry: 'Legal & Professional Services', stageCount: 4, config: { title: 'Legal Client Intake Journey', currency: '¬£', stages: [{ id: 'stage-1', name: 'Enquiry', steps: [{ id: 's1-1', name: 'Initial Contact', time: 15, personaId: 'client', friction: 'none', notes: '' }, { id: 's1-2', name: 'Matter Assessment', time: 30, personaId: 'partner', friction: 'low', notes: '' }]}, { id: 'stage-2', name: 'Conflict Check', steps: [{ id: 's2-1', name: 'Conflict Search', time: 20, personaId: 'admin', friction: 'low', notes: '' }, { id: 's2-2', name: 'Partner Sign-off', time: 15, personaId: 'partner', friction: 'low', notes: '' }]}, { id: 'stage-3', name: 'KYC/AML', steps: [{ id: 's3-1', name: 'ID Collection', time: 30, personaId: 'client', friction: 'medium', notes: '' }, { id: 's3-2', name: 'AML Check', time: 30, personaId: 'compliance', friction: 'low', notes: '' }]}, { id: 'stage-4', name: 'Engagement', steps: [{ id: 's4-1', name: 'Engagement Letter', time: 30, personaId: 'admin', friction: 'low', notes: '' }, { id: 's4-2', name: 'Retainer Receipt', time: 15, personaId: 'admin', friction: 'low', notes: '' }]}], personas: [{ id: 'client', name: 'Client', salary: 0, isExternal: true }, { id: 'partner', name: 'Partner', salary: 150000, isExternal: false }, { id: 'admin', name: 'Admin', salary: 28000, isExternal: false }, { id: 'compliance', name: 'Compliance', salary: 45000, isExternal: false }], funnelConfig: { enabled: true, startVolume: 100, stages: {} }}},
      { id: 'contract_lifecycle', name: 'Contract Lifecycle', description: 'Request, negotiation, approval, execution', icon: 'üìù', industry: 'Legal & Professional Services', stageCount: 5, config: { title: 'Contract Lifecycle Journey', currency: '¬£', stages: [{ id: 'stage-1', name: 'Request', steps: [{ id: 's1-1', name: 'Contract Request', time: 15, personaId: 'requestor', friction: 'low', notes: '' }, { id: 's1-2', name: 'Requirements Gathering', time: 30, personaId: 'legal', friction: 'low', notes: '' }]}, { id: 'stage-2', name: 'Drafting', steps: [{ id: 's2-1', name: 'Draft Contract', time: 120, personaId: 'legal', friction: 'medium', notes: '' }, { id: 's2-2', name: 'Internal Review', time: 60, personaId: 'legal', friction: 'low', notes: '' }]}, { id: 'stage-3', name: 'Negotiation', steps: [{ id: 's3-1', name: 'Send to Counterparty', time: 15, personaId: 'legal', friction: 'none', notes: '' }, { id: 's3-2', name: 'Redline Review', time: 90, personaId: 'legal', friction: 'medium', notes: '' }]}, { id: 'stage-4', name: 'Approval', steps: [{ id: 's4-1', name: 'Finance Review', time: 30, personaId: 'finance', friction: 'low', notes: '' }, { id: 's4-2', name: 'Final Approval', time: 30, personaId: 'approver', friction: 'low', notes: '' }]}, { id: 'stage-5', name: 'Execution', steps: [{ id: 's5-1', name: 'Signature', time: 30, personaId: 'approver', friction: 'low', notes: '' }, { id: 's5-2', name: 'Archival', time: 15, personaId: 'legal', friction: 'none', notes: '' }]}], personas: [{ id: 'requestor', name: 'Requestor', salary: 50000, isExternal: false }, { id: 'legal', name: 'Legal Counsel', salary: 85000, isExternal: false }, { id: 'finance', name: 'Finance', salary: 55000, isExternal: false }, { id: 'approver', name: 'Approver', salary: 75000, isExternal: false }], funnelConfig: { enabled: false, startVolume: 100, stages: {} }}},
      { id: 'saas_onboarding', name: 'Customer Onboarding (SaaS)', description: 'Implementation to go-live', icon: 'üöÄ', industry: 'B2B / SaaS', stageCount: 5, config: { title: 'Customer Onboarding Journey', currency: '¬£', stages: [{ id: 'stage-1', name: 'Handoff', steps: [{ id: 's1-1', name: 'Sales Handoff', time: 30, personaId: 'sales', friction: 'low', notes: '' }, { id: 's1-2', name: 'Kickoff Call', time: 60, personaId: 'csm', friction: 'none', notes: '' }]}, { id: 'stage-2', name: 'Setup', steps: [{ id: 's2-1', name: 'Account Configuration', time: 120, personaId: 'csm', friction: 'medium', notes: '' }, { id: 's2-2', name: 'Integration Setup', time: 180, personaId: 'tech', friction: 'high', notes: '' }]}, { id: 'stage-3', name: 'Training', steps: [{ id: 's3-1', name: 'Admin Training', time: 90, personaId: 'csm', friction: 'low', notes: '' }, { id: 's3-2', name: 'User Training', time: 120, personaId: 'csm', friction: 'low', notes: '' }]}, { id: 'stage-4', name: 'Go-Live', steps: [{ id: 's4-1', name: 'UAT', time: 60, personaId: 'customer', friction: 'medium', notes: '' }, { id: 's4-2', name: 'Production Launch', time: 30, personaId: 'tech', friction: 'low', notes: '' }]}, { id: 'stage-5', name: 'Success', steps: [{ id: 's5-1', name: '30-Day Check-in', time: 30, personaId: 'csm', friction: 'none', notes: '' }, { id: 's5-2', name: 'Success Review', time: 45, personaId: 'csm', friction: 'none', notes: '' }]}], personas: [{ id: 'customer', name: 'Customer', salary: 0, isExternal: true }, { id: 'sales', name: 'Sales Rep', salary: 55000, isExternal: false }, { id: 'csm', name: 'CSM', salary: 45000, isExternal: false }, { id: 'tech', name: 'Implementation', salary: 50000, isExternal: false }], funnelConfig: { enabled: true, startVolume: 100, stages: {} }}},
      { id: 'vendor_onboarding', name: 'Vendor/Supplier Onboarding', description: 'Due diligence, contracting, setup', icon: 'ü§ù', industry: 'B2B / SaaS', stageCount: 4, config: { title: 'Vendor Onboarding Journey', currency: '¬£', stages: [{ id: 'stage-1', name: 'Request', steps: [{ id: 's1-1', name: 'Vendor Request', time: 20, personaId: 'requestor', friction: 'low', notes: '' }, { id: 's1-2', name: 'Initial Assessment', time: 30, personaId: 'procurement', friction: 'low', notes: '' }]}, { id: 'stage-2', name: 'Due Diligence', steps: [{ id: 's2-1', name: 'Risk Assessment', time: 60, personaId: 'risk', friction: 'medium', notes: '' }, { id: 's2-2', name: 'Security Review', time: 90, personaId: 'security', friction: 'medium', notes: '' }]}, { id: 'stage-3', name: 'Contracting', steps: [{ id: 's3-1', name: 'Contract Negotiation', time: 120, personaId: 'legal', friction: 'medium', notes: '' }, { id: 's3-2', name: 'Contract Execution', time: 30, personaId: 'legal', friction: 'low', notes: '' }]}, { id: 'stage-4', name: 'Setup', steps: [{ id: 's4-1', name: 'System Setup', time: 60, personaId: 'procurement', friction: 'low', notes: '' }, { id: 's4-2', name: 'Payment Setup', time: 30, personaId: 'finance', friction: 'low', notes: '' }]}], personas: [{ id: 'vendor', name: 'Vendor', salary: 0, isExternal: true }, { id: 'requestor', name: 'Requestor', salary: 50000, isExternal: false }, { id: 'procurement', name: 'Procurement', salary: 45000, isExternal: false }, { id: 'legal', name: 'Legal', salary: 70000, isExternal: false }, { id: 'risk', name: 'Risk', salary: 55000, isExternal: false }, { id: 'security', name: 'Security', salary: 60000, isExternal: false }, { id: 'finance', name: 'Finance', salary: 50000, isExternal: false }], funnelConfig: { enabled: true, startVolume: 100, stages: {} }}},
      { id: 'enterprise_sales', name: 'Enterprise Sales Cycle', description: 'Lead to closed deal with procurement', icon: 'üìä', industry: 'B2B / SaaS', stageCount: 6, config: { title: 'Enterprise Sales Journey', currency: '¬£', stages: [{ id: 'stage-1', name: 'Lead', steps: [{ id: 's1-1', name: 'Lead Qualification', time: 30, personaId: 'sdr', friction: 'low', notes: '' }, { id: 's1-2', name: 'Discovery Call', time: 45, personaId: 'ae', friction: 'low', notes: '' }]}, { id: 'stage-2', name: 'Demo', steps: [{ id: 's2-1', name: 'Product Demo', time: 60, personaId: 'ae', friction: 'low', notes: '' }, { id: 's2-2', name: 'Technical Demo', time: 90, personaId: 'se', friction: 'low', notes: '' }]}, { id: 'stage-3', name: 'Evaluation', steps: [{ id: 's3-1', name: 'POC Setup', time: 120, personaId: 'se', friction: 'medium', notes: '' }, { id: 's3-2', name: 'POC Review', time: 60, personaId: 'ae', friction: 'low', notes: '' }]}, { id: 'stage-4', name: 'Proposal', steps: [{ id: 's4-1', name: 'Proposal Creation', time: 90, personaId: 'ae', friction: 'medium', notes: '' }, { id: 's4-2', name: 'Pricing Negotiation', time: 60, personaId: 'ae', friction: 'medium', notes: '' }]}, { id: 'stage-5', name: 'Procurement', steps: [{ id: 's5-1', name: 'Security Review', time: 180, personaId: 'se', friction: 'high', notes: '' }, { id: 's5-2', name: 'Legal Review', time: 120, personaId: 'ae', friction: 'high', notes: '' }]}, { id: 'stage-6', name: 'Close', steps: [{ id: 's6-1', name: 'Contract Signature', time: 30, personaId: 'ae', friction: 'low', notes: '' }, { id: 's6-2', name: 'Handoff to CS', time: 30, personaId: 'ae', friction: 'none', notes: '' }]}], personas: [{ id: 'prospect', name: 'Prospect', salary: 0, isExternal: true }, { id: 'sdr', name: 'SDR', salary: 35000, isExternal: false }, { id: 'ae', name: 'Account Executive', salary: 65000, isExternal: false }, { id: 'se', name: 'Solutions Engineer', salary: 70000, isExternal: false }], funnelConfig: { enabled: true, startVolume: 100, stages: {} }}},
      { id: 'grant_application', name: 'Grant Application & Award', description: 'Eligibility, assessment, disbursement', icon: 'üí∞', industry: 'Public Sector / Government', stageCount: 5, config: { title: 'Grant Application Journey', currency: '¬£', stages: [{ id: 'stage-1', name: 'Application', steps: [{ id: 's1-1', name: 'Eligibility Check', time: 30, personaId: 'applicant', friction: 'low', notes: '' }, { id: 's1-2', name: 'Application Submission', time: 90, personaId: 'applicant', friction: 'high', notes: '' }]}, { id: 'stage-2', name: 'Review', steps: [{ id: 's2-1', name: 'Initial Review', time: 60, personaId: 'officer', friction: 'low', notes: '' }, { id: 's2-2', name: 'Due Diligence', time: 120, personaId: 'officer', friction: 'medium', notes: '' }]}, { id: 'stage-3', name: 'Assessment', steps: [{ id: 's3-1', name: 'Panel Review', time: 90, personaId: 'panel', friction: 'low', notes: '' }, { id: 's3-2', name: 'Decision', time: 30, personaId: 'panel', friction: 'low', notes: '' }]}, { id: 'stage-4', name: 'Award', steps: [{ id: 's4-1', name: 'Grant Agreement', time: 45, personaId: 'officer', friction: 'low', notes: '' }, { id: 's4-2', name: 'Agreement Signing', time: 30, personaId: 'applicant', friction: 'low', notes: '' }]}, { id: 'stage-5', name: 'Disbursement', steps: [{ id: 's5-1', name: 'Bank Details Verification', time: 20, personaId: 'finance', friction: 'low', notes: '' }, { id: 's5-2', name: 'Payment', time: 30, personaId: 'finance', friction: 'low', notes: '' }]}], personas: [{ id: 'applicant', name: 'Applicant', salary: 0, isExternal: true }, { id: 'officer', name: 'Grants Officer', salary: 38000, isExternal: false }, { id: 'panel', name: 'Assessment Panel', salary: 55000, isExternal: false }, { id: 'finance', name: 'Finance', salary: 35000, isExternal: false }], funnelConfig: { enabled: true, startVolume: 100, stages: {} }}},
      { id: 'permit_license', name: 'Permit/License Application', description: 'Submission to issuance with appeals', icon: 'üèõÔ∏è', industry: 'Public Sector / Government', stageCount: 4, config: { title: 'Permit Application Journey', currency: '¬£', stages: [{ id: 'stage-1', name: 'Application', steps: [{ id: 's1-1', name: 'Form Submission', time: 45, personaId: 'applicant', friction: 'medium', notes: '' }, { id: 's1-2', name: 'Document Upload', time: 30, personaId: 'applicant', friction: 'medium', notes: '' }]}, { id: 'stage-2', name: 'Review', steps: [{ id: 's2-1', name: 'Completeness Check', time: 30, personaId: 'officer', friction: 'low', notes: '' }, { id: 's2-2', name: 'Technical Review', time: 90, personaId: 'specialist', friction: 'medium', notes: '' }]}, { id: 'stage-3', name: 'Decision', steps: [{ id: 's3-1', name: 'Assessment', time: 60, personaId: 'officer', friction: 'low', notes: '' }, { id: 's3-2', name: 'Decision Notice', time: 30, personaId: 'officer', friction: 'low', notes: '' }]}, { id: 'stage-4', name: 'Issuance', steps: [{ id: 's4-1', name: 'Fee Payment', time: 15, personaId: 'applicant', friction: 'low', notes: '' }, { id: 's4-2', name: 'Permit Issuance', time: 20, personaId: 'officer', friction: 'none', notes: '' }]}], personas: [{ id: 'applicant', name: 'Applicant', salary: 0, isExternal: true }, { id: 'officer', name: 'Licensing Officer', salary: 32000, isExternal: false }, { id: 'specialist', name: 'Technical Specialist', salary: 42000, isExternal: false }], funnelConfig: { enabled: true, startVolume: 100, stages: {} }}},
      { id: 'complaint_handling', name: 'Complaint Handling', description: 'Receipt to resolution and learning', icon: 'üì£', industry: 'Operations / Service', stageCount: 4, config: { title: 'Complaint Handling Journey', currency: '¬£', stages: [{ id: 'stage-1', name: 'Receipt', steps: [{ id: 's1-1', name: 'Complaint Received', time: 15, personaId: 'customer', friction: 'medium', notes: '' }, { id: 's1-2', name: 'Acknowledgement', time: 10, personaId: 'agent', friction: 'none', notes: '' }]}, { id: 'stage-2', name: 'Investigation', steps: [{ id: 's2-1', name: 'Gather Information', time: 45, personaId: 'agent', friction: 'low', notes: '' }, { id: 's2-2', name: 'Root Cause Analysis', time: 60, personaId: 'manager', friction: 'medium', notes: '' }]}, { id: 'stage-3', name: 'Resolution', steps: [{ id: 's3-1', name: 'Resolution Proposal', time: 30, personaId: 'manager', friction: 'low', notes: '' }, { id: 's3-2', name: 'Customer Communication', time: 20, personaId: 'agent', friction: 'low', notes: '' }]}, { id: 'stage-4', name: 'Closure', steps: [{ id: 's4-1', name: 'Confirmation', time: 15, personaId: 'customer', friction: 'low', notes: '' }, { id: 's4-2', name: 'Learning & Improvement', time: 30, personaId: 'manager', friction: 'none', notes: '' }]}], personas: [{ id: 'customer', name: 'Customer', salary: 0, isExternal: true }, { id: 'agent', name: 'Service Agent', salary: 26000, isExternal: false }, { id: 'manager', name: 'Manager', salary: 42000, isExternal: false }], funnelConfig: { enabled: false, startVolume: 100, stages: {} }}},
      { id: 'product_return', name: 'Product Return & Refund', description: 'E-commerce returns processing', icon: 'üì¶', industry: 'Operations / Service', stageCount: 4, config: { title: 'Product Return Journey', currency: '¬£', stages: [{ id: 'stage-1', name: 'Request', steps: [{ id: 's1-1', name: 'Return Request', time: 10, personaId: 'customer', friction: 'low', notes: '' }, { id: 's1-2', name: 'RMA Issued', time: 10, personaId: 'agent', friction: 'none', notes: '' }]}, { id: 'stage-2', name: 'Return', steps: [{ id: 's2-1', name: 'Ship Return', time: 30, personaId: 'customer', friction: 'medium', notes: '' }, { id: 's2-2', name: 'Receive Return', time: 20, personaId: 'warehouse', friction: 'low', notes: '' }]}, { id: 'stage-3', name: 'Inspection', steps: [{ id: 's3-1', name: 'Quality Check', time: 15, personaId: 'warehouse', friction: 'low', notes: '' }, { id: 's3-2', name: 'Decision', time: 10, personaId: 'warehouse', friction: 'low', notes: '' }]}, { id: 'stage-4', name: 'Refund', steps: [{ id: 's4-1', name: 'Process Refund', time: 15, personaId: 'finance', friction: 'low', notes: '' }, { id: 's4-2', name: 'Confirmation', time: 5, personaId: 'agent', friction: 'none', notes: '' }]}], personas: [{ id: 'customer', name: 'Customer', salary: 0, isExternal: true }, { id: 'agent', name: 'Service Agent', salary: 24000, isExternal: false }, { id: 'warehouse', name: 'Warehouse', salary: 26000, isExternal: false }, { id: 'finance', name: 'Finance', salary: 32000, isExternal: false }], funnelConfig: { enabled: true, startVolume: 100, stages: {} }}},
      { id: 'it_incident', name: 'IT Incident Management', description: 'Detection to resolution and PIR', icon: 'üîß', industry: 'Operations / Service', stageCount: 5, config: { title: 'IT Incident Journey', currency: '¬£', stages: [{ id: 'stage-1', name: 'Detection', steps: [{ id: 's1-1', name: 'Incident Detected', time: 5, personaId: 'monitoring', friction: 'none', notes: '' }, { id: 's1-2', name: 'Ticket Created', time: 5, personaId: 'l1', friction: 'none', notes: '' }]}, { id: 'stage-2', name: 'Triage', steps: [{ id: 's2-1', name: 'Initial Assessment', time: 15, personaId: 'l1', friction: 'low', notes: '' }, { id: 's2-2', name: 'Priority Assignment', time: 10, personaId: 'l1', friction: 'low', notes: '' }]}, { id: 'stage-3', name: 'Resolution', steps: [{ id: 's3-1', name: 'Investigation', time: 45, personaId: 'l2', friction: 'medium', notes: '' }, { id: 's3-2', name: 'Fix Applied', time: 30, personaId: 'l2', friction: 'low', notes: '' }]}, { id: 'stage-4', name: 'Verification', steps: [{ id: 's4-1', name: 'Testing', time: 20, personaId: 'l2', friction: 'low', notes: '' }, { id: 's4-2', name: 'User Confirmation', time: 15, personaId: 'user', friction: 'low', notes: '' }]}, { id: 'stage-5', name: 'Closure', steps: [{ id: 's5-1', name: 'Documentation', time: 15, personaId: 'l2', friction: 'low', notes: '' }, { id: 's5-2', name: 'PIR (if major)', time: 60, personaId: 'manager', friction: 'medium', notes: '' }]}], personas: [{ id: 'user', name: 'User', salary: 0, isExternal: true }, { id: 'monitoring', name: 'Monitoring', salary: 0, isExternal: false }, { id: 'l1', name: 'L1 Support', salary: 28000, isExternal: false }, { id: 'l2', name: 'L2 Support', salary: 38000, isExternal: false }, { id: 'manager', name: 'IT Manager', salary: 55000, isExternal: false }], funnelConfig: { enabled: false, startVolume: 100, stages: {} }}}
    ];

    // Create Map Modal with Templates
    // ============================================
    // AI WIZARD CONFIGURATION
    // ============================================
    const WIZARD_INDUSTRIES = {
      'financial-services': {
        label: 'Financial Services',
        roles: [
          { name: 'Client', salary: 0, isExternal: true },
          { name: 'Financial Adviser', salary: 75000, isExternal: false },
          { name: 'Paraplanner', salary: 45000, isExternal: false },
          { name: 'Administrator', salary: 28000, isExternal: false },
          { name: 'Compliance Officer', salary: 55000, isExternal: false }
        ]
      },
      'accounting': {
        label: 'Accounting & Professional Services',
        roles: [
          { name: 'Client', salary: 0, isExternal: true },
          { name: 'Partner', salary: 150000, isExternal: false },
          { name: 'Senior Accountant', salary: 55000, isExternal: false },
          { name: 'Administrator', salary: 26000, isExternal: false }
        ]
      },
      'legal': {
        label: 'Legal Services',
        roles: [
          { name: 'Client', salary: 0, isExternal: true },
          { name: 'Partner', salary: 180000, isExternal: false },
          { name: 'Associate', salary: 65000, isExternal: false },
          { name: 'Paralegal', salary: 32000, isExternal: false }
        ]
      },
      'healthcare': {
        label: 'Healthcare',
        roles: [
          { name: 'Patient', salary: 0, isExternal: true },
          { name: 'Consultant', salary: 120000, isExternal: false },
          { name: 'Nurse', salary: 38000, isExternal: false },
          { name: 'Administrator', salary: 26000, isExternal: false }
        ]
      },
      'hr': {
        label: 'HR / People Operations',
        roles: [
          { name: 'Employee', salary: 0, isExternal: true },
          { name: 'Candidate', salary: 0, isExternal: true },
          { name: 'HR Manager', salary: 55000, isExternal: false },
          { name: 'HR Administrator', salary: 28000, isExternal: false }
        ]
      },
      'property': {
        label: 'Property & Real Estate',
        roles: [
          { name: 'Buyer', salary: 0, isExternal: true },
          { name: 'Agent', salary: 35000, isExternal: false },
          { name: 'Solicitor', salary: 55000, isExternal: false }
        ]
      },
      'saas': {
        label: 'B2B / SaaS',
        roles: [
          { name: 'Customer', salary: 0, isExternal: true },
          { name: 'Account Executive', salary: 65000, isExternal: false },
          { name: 'Customer Success', salary: 45000, isExternal: false }
        ]
      },
      'other': {
        label: 'Other',
        roles: [
          { name: 'Customer', salary: 0, isExternal: true },
          { name: 'Manager', salary: 50000, isExternal: false },
          { name: 'Staff', salary: 32000, isExternal: false }
        ]
      }
    };
    
    const WIZARD_JOURNEY_TYPES = [
      'Client Onboarding', 'Employee Onboarding', 'Service Delivery', 'Sales Process',
      'Support / Case Management', 'Application Processing', 'Complaint Handling', 'Procurement', 'Other'
    ];
    
    const WIZARD_COMPLEXITY = [
      { value: 'simple', label: 'Simple', stages: '3-4 stages' },
      { value: 'medium', label: 'Medium', stages: '5-6 stages' },
      { value: 'complex', label: 'Complex', stages: '7+ stages' }
    ];

    function CreateMapModal({ user, token, maps, onClose, onCreated }) {
      // Modal mode: 'select', 'wizard', 'customize', 'generating'
      const [mode, setMode] = useState('select');
      const [wizardStep, setWizardStep] = useState(1);
      
      // Template mode state
      const [selectedTemplate, setSelectedTemplate] = useState(null);
      const [title, setTitle] = useState('');
      const [templateDescription, setTemplateDescription] = useState('');
      
      // Wizard state
      const [description, setDescription] = useState('');
      const [industry, setIndustry] = useState('');
      const [journeyType, setJourneyType] = useState('');
      const [complexity, setComplexity] = useState('medium');
      const [roles, setRoles] = useState([]);
      const [knownStages, setKnownStages] = useState('');
      const [apiKey, setApiKey] = useState('');
      const [newRoleName, setNewRoleName] = useState('');
      const [newRoleExternal, setNewRoleExternal] = useState(false);
      
      // Shared state
      const [isCreating, setIsCreating] = useState(false);
      const [error, setError] = useState('');
      
      // Load saved API key
      useEffect(() => {
        const savedKey = localStorage.getItem('fathom_anthropic_key');
        if (savedKey) setApiKey(savedKey);
      }, []);
      
      // When industry changes, suggest roles
      useEffect(() => {
        if (industry && WIZARD_INDUSTRIES[industry]) {
          const suggested = WIZARD_INDUSTRIES[industry].roles.slice(0, 3);
          setRoles(suggested.map(r => ({
            id: r.name.toLowerCase().replace(/\s+/g, '-'),
            name: r.name,
            salary: r.salary,
            isExternal: r.isExternal
          })));
        }
      }, [industry]);
      
      const handleSelectTemplate = (template) => {
        setSelectedTemplate(template);
        setTitle(template.config.title);
        setTemplateDescription(template.description);
        setMode('customize');
      };
      
      const handleStartWizard = () => {
        setMode('wizard');
        setWizardStep(1);
      };
      
      const handleBack = () => {
        if (mode === 'customize') {
          setMode('select');
          setSelectedTemplate(null);
        } else if (mode === 'wizard') {
          if (wizardStep > 1) {
            setWizardStep(wizardStep - 1);
          } else {
            setMode('select');
          }
        }
      };
      
      const addRole = (name, salary, isExternal) => {
        if (!name.trim()) return;
        if (roles.find(r => r.name.toLowerCase() === name.toLowerCase())) return;
        setRoles([...roles, {
          id: name.toLowerCase().replace(/\s+/g, '-'),
          name: name.trim(),
          salary: isExternal ? 0 : salary,
          isExternal
        }]);
      };
      
      const removeRole = (index) => {
        setRoles(roles.filter((_, i) => i !== index));
      };
      
      const addSuggestedRole = (suggestion) => {
        addRole(suggestion.name, suggestion.salary, suggestion.isExternal);
      };
      
      const handleAddCustomRole = () => {
        if (!newRoleName.trim()) return;
        addRole(newRoleName, newRoleExternal ? 0 : 35000, newRoleExternal);
        setNewRoleName('');
      };
      
      // Fallback generator (no AI required)
      const generateFallbackJourney = () => {
        let stageNames = [];
        if (knownStages.trim()) {
          stageNames = knownStages.split(/[,\n]+/).map(s => s.trim()).filter(Boolean);
        } else {
          const defaults = {
            'Client Onboarding': ['Initial Contact', 'Discovery', 'Documentation', 'Setup', 'Handover'],
            'Employee Onboarding': ['Offer', 'Pre-boarding', 'Day One', 'Training', 'Integration'],
            'Service Delivery': ['Request', 'Planning', 'Execution', 'Review', 'Delivery'],
            'Sales Process': ['Lead', 'Qualification', 'Proposal', 'Negotiation', 'Close'],
            'Support / Case Management': ['Intake', 'Triage', 'Investigation', 'Resolution', 'Follow-up'],
            'Application Processing': ['Submission', 'Validation', 'Assessment', 'Decision', 'Notification']
          };
          stageNames = defaults[journeyType] || ['Initiation', 'Planning', 'Execution', 'Review', 'Completion'];
        }
        
        const targetStages = complexity === 'simple' ? 3 : complexity === 'complex' ? 7 : 5;
        while (stageNames.length < targetStages) stageNames.push(`Stage ${stageNames.length + 1}`);
        stageNames = stageNames.slice(0, targetStages + 1);
        
        const externalRoles = roles.filter(r => r.isExternal);
        const internalRoles = roles.filter(r => !r.isExternal);
        const primaryExternal = externalRoles[0] || { id: 'customer', name: 'Customer', salary: 0, isExternal: true };
        const primaryInternal = internalRoles[0] || { id: 'staff', name: 'Staff', salary: 35000, isExternal: false };
        
        const stages = stageNames.map((stageName, si) => {
          const stepsPerStage = complexity === 'simple' ? 2 : complexity === 'complex' ? 4 : 3;
          const steps = [];
          for (let i = 0; i < stepsPerStage; i++) {
            let owner = i === 0 && externalRoles.length > 0 ? primaryExternal : 
                        internalRoles.length > 0 ? internalRoles[i % internalRoles.length] : primaryInternal;
            steps.push({
              id: `step-${si + 1}-${i + 1}`,
              name: `Step ${i + 1}`,
              description: '',
              owner: owner.id,
              timeMinutes: [15, 30, 45, 60, 90][Math.floor(Math.random() * 5)],
              frictionLevel: i === 0 ? 1 : [1, 2, 2, 3][Math.floor(Math.random() * 4)],
              notes: ''
            });
          }
          return { id: `stage-${si + 1}`, name: stageName, steps };
        });
        
        const personas = (roles.length > 0 ? roles : [primaryExternal, primaryInternal]).map(r => ({
          id: r.id,
          label: r.name,
          annualSalary: r.salary,
          isExternal: r.isExternal,
          burdenMultiplier: r.isExternal ? 1 : 1.3,
          workspaceHourlyCost: r.isExternal ? 0 : 6,
          color: r.isExternal ? '#2D8A6E' : '#5B8A9A'
        }));
        
        const journeyTitle = description.length > 60 ? description.slice(0, 60).trim() + '...' : description || `${journeyType || 'Process'} Journey`;
        return { title: journeyTitle, stages, personas };
      };
      
      // Generate with AI or fallback
      const handleGenerate = async () => {
        if (!token) {
          setError('GitHub token required. Please set up your token in settings.');
          return;
        }
        if (roles.length < 2) {
          setError('Please add at least 2 roles.');
          return;
        }
        
        setMode('generating');
        setError('');
        
        let journeyConfig;
        
        // Try AI generation if API key provided
        if (apiKey) {
          localStorage.setItem('fathom_anthropic_key', apiKey);
          try {
            const prompt = `You are an expert in operational process design. Generate a detailed journey map for:

CONTEXT:
- Description: ${description}
- Industry: ${WIZARD_INDUSTRIES[industry]?.label || 'General'}
- Journey Type: ${journeyType || 'Process'}
- Complexity: ${complexity} (${WIZARD_COMPLEXITY.find(c => c.value === complexity)?.stages})
- Roles: ${roles.map(r => r.name + (r.isExternal ? ' (external)' : '')).join(', ')}
${knownStages ? `- Key stages: ${knownStages}` : ''}

Generate a JSON object with this EXACT structure (no markdown, just JSON):
{
  "title": "Journey title",
  "stages": [{ "id": "stage-1", "name": "Stage Name", "steps": [{ "id": "step-1-1", "name": "Step name", "description": "What happens", "owner": "role-id", "timeMinutes": 30, "frictionLevel": 1, "notes": "" }] }],
  "personas": [{ "id": "role-id", "label": "Role Name", "annualSalary": 45000, "isExternal": false, "burdenMultiplier": 1.3, "workspaceHourlyCost": 6 }]
}

RULES:
1. Use roles: ${JSON.stringify(roles.map(r => ({ id: r.id, name: r.name, salary: r.salary, isExternal: r.isExternal })))}
2. frictionLevel: 1=none, 2=low, 3=medium, 4=high
3. Create ${complexity === 'simple' ? '3-4' : complexity === 'medium' ? '5-6' : '7-8'} stages with 2-5 steps each
4. External roles: salary 0, isExternal true. Internal: burdenMultiplier 1.3, workspaceHourlyCost 6
5. Return ONLY valid JSON`;

            const response = await fetch('https://api.anthropic.com/v1/messages', {
              method: 'POST',
              headers: {
                'Content-Type': 'application/json',
                'x-api-key': apiKey,
                'anthropic-version': '2023-06-01',
                'anthropic-dangerous-direct-browser-access': 'true'
              },
              body: JSON.stringify({
                model: 'claude-sonnet-4-20250514',
                max_tokens: 4000,
                messages: [{ role: 'user', content: prompt }]
              })
            });
            
            if (response.ok) {
              const data = await response.json();
              let jsonText = data.content[0].text.trim();
              if (jsonText.startsWith('`')) {
                jsonText = jsonText.replace(/^```json?\n?/, '').replace(/\n?```$/, '');
              }
              journeyConfig = JSON.parse(jsonText);
            } else {
              journeyConfig = generateFallbackJourney();
            }
          } catch (e) {
            console.warn('AI error, using fallback:', e);
            journeyConfig = generateFallbackJourney();
          }
        } else {
          journeyConfig = generateFallbackJourney();
        }
        
        // Save to GitHub
        try {
          const mapId = 'map-' + Date.now();
          const now = new Date().toISOString();
          
          const mapMetadata = {
            id: mapId,
            title: journeyConfig.title || description.slice(0, 50),
            description: description,
            owner: user.email,
            createdAt: now,
            updatedAt: now,
            sharedWith: []
          };
          
          const mapConfig = {
            meta: { title: journeyConfig.title, version: '1.0', template: 'ai-generated' },
            funnel: { enabled: false, initialVolume: 100, periodLabel: 'per month' },
            personas: journeyConfig.personas.map(p => ({
              id: p.id, label: p.label, annualSalary: p.annualSalary || p.salary || 0,
              isExternal: p.isExternal || false, burdenMultiplier: p.burdenMultiplier || 1.3,
              workspaceHourlyCost: p.workspaceHourlyCost || 6, color: p.isExternal ? '#2D8A6E' : '#5B8A9A'
            })),
            stages: journeyConfig.stages.map(stage => ({
              id: stage.id, name: stage.name, dropOffCount: 0,
              steps: stage.steps.map(step => ({
                id: step.id, name: step.name, description: step.description || '', owner: step.owner,
                timeMinutes: step.timeMinutes || 30, frictionLevel: step.frictionLevel || 1,
                painPoints: [], automationOpportunity: 'none', notes: step.notes || ''
              }))
            }))
          };
          
          await saveToGitHub(GITHUB_CONFIG.indexFile, { maps: [...maps, mapMetadata] }, token, `Create: ${journeyConfig.title}`);
          await saveToGitHub(`${GITHUB_CONFIG.mapsPath}/${mapId}.json`, mapConfig, token, `Config: ${journeyConfig.title}`);
          
          onCreated();
        } catch (err) {
          setError(err.message || 'Failed to create map');
          setMode('wizard');
          setWizardStep(3);
        }
      };
      
      const handleCreateTemplate = async () => {
        if (!title.trim() || !selectedTemplate) return;
        setIsCreating(true);
        setError('');
        
        try {
          const templateConfig = JSON.parse(JSON.stringify(selectedTemplate.config));
          const mapId = 'map-' + Date.now();
          const now = new Date().toISOString();
          
          const mapMetadata = {
            id: mapId, title: title.trim(), description: templateDescription.trim(),
            owner: user.email, createdAt: now, updatedAt: now, sharedWith: []
          };
          
          const mapConfig = {
            meta: { title: title.trim(), version: '1.0', template: selectedTemplate.id },
            funnel: { enabled: templateConfig.funnelConfig?.enabled || false, initialVolume: templateConfig.funnelConfig?.startVolume || 100, periodLabel: 'per month' },
            personas: templateConfig.personas.map(p => ({ id: p.id, label: p.name, salary: p.salary, isExternal: p.isExternal, color: p.isExternal ? '#2D8A6E' : '#5B8A9A' })),
            stages: templateConfig.stages.map(stage => ({
              id: stage.id, name: stage.name, dropOffCount: templateConfig.funnelConfig?.stages?.[stage.id]?.dropOff || 0,
              steps: stage.steps.map(step => ({
                id: step.id, name: step.name, owner: step.personaId, timeMinutes: step.time,
                frictionLevel: step.friction === 'high' ? 4 : step.friction === 'medium' ? 3 : step.friction === 'low' ? 2 : 1,
                painPoints: [], automationOpportunity: 'none', notes: step.notes || ''
              }))
            }))
          };
          
          await saveToGitHub(GITHUB_CONFIG.indexFile, { maps: [...maps, mapMetadata] }, token, `Create: ${title}`);
          await saveToGitHub(`${GITHUB_CONFIG.mapsPath}/${mapId}.json`, mapConfig, token, `Create config: ${title}`);
          onCreated();
        } catch (err) {
          setError(err.message || 'Failed to create map');
        }
        setIsCreating(false);
      };
      
      // Group templates by industry
      const templatesByIndustry = JOURNEY_TEMPLATES.reduce((acc, t) => {
        if (!acc[t.industry]) acc[t.industry] = [];
        acc[t.industry].push(t);
        return acc;
      }, {});
      
      // Get suggested roles not yet added
      const suggestedRoles = industry && WIZARD_INDUSTRIES[industry] 
        ? WIZARD_INDUSTRIES[industry].roles.filter(sr => !roles.find(r => r.name === sr.name)).slice(0, 4)
        : [];

      // Modal title based on mode
      const getTitle = () => {
        if (mode === 'select') return 'Choose a Template';
        if (mode === 'customize') return 'Customise Your Map';
        if (mode === 'generating') return 'Creating Your Journey';
        if (mode === 'wizard') {
          if (wizardStep === 1) return 'Describe Your Process';
          if (wizardStep === 2) return 'Context & Roles';
          if (wizardStep === 3) return 'Final Details';
        }
        return 'Create Map';
      };

      return (
        <div className="modal-overlay" onClick={onClose}>
          <div className="modal" onClick={e => e.stopPropagation()} style={{ maxWidth: mode === 'generating' ? '400px' : '520px', width: '95%' }}>
            <div className="modal-content" style={{ padding: '32px' }}>
              {/* Header */}
              <div style={{ display: 'flex', alignItems: 'center', gap: '12px', marginBottom: '24px' }}>
                {(mode === 'customize' || mode === 'wizard') && (
                  <button onClick={handleBack} style={{ background: 'none', border: 'none', cursor: 'pointer', fontSize: '18px', color: 'var(--slate-400)', padding: '4px' }}>‚Üê</button>
                )}
                <h2 className="modal-title" style={{ margin: 0, fontFamily: 'var(--font-display)' }}>{getTitle()}</h2>
                {mode === 'wizard' && (
                  <div style={{ marginLeft: 'auto', display: 'flex', gap: '6px', marginRight: '40px' }}>
                    {[1,2,3].map(s => (
                      <div key={s} style={{ width: s === wizardStep ? '24px' : '8px', height: '8px', borderRadius: '4px', background: s < wizardStep ? 'var(--success)' : s === wizardStep ? 'var(--navy-700)' : 'var(--slate-200)', transition: 'all 0.2s' }} />
                    ))}
                  </div>
                )}
                <button className="modal-close" onClick={onClose} style={{ marginLeft: mode === 'wizard' ? '0' : 'auto' }}>√ó</button>
              </div>
              
              {error && <div style={{ padding: '10px 12px', background: 'var(--error-light)', borderRadius: '8px', marginBottom: '16px', color: 'var(--error)', fontSize: '13px' }}>{error}</div>}
              
              {/* GENERATING STATE */}
              {mode === 'generating' && (
                <div style={{ textAlign: 'center', padding: '40px 20px' }}>
                  <div style={{ width: '60px', height: '60px', margin: '0 auto 20px', borderRadius: '50%', background: 'var(--navy-700)', display: 'flex', alignItems: 'center', justifyContent: 'center' }}>
                    <div style={{ width: '24px', height: '24px', border: '3px solid rgba(255,255,255,0.3)', borderTopColor: '#FFF', borderRadius: '50%', animation: 'spin 1s linear infinite' }} />
                  </div>
                  <p style={{ color: 'var(--slate-600)', fontSize: '14px' }}>Building your journey map...</p>
                  <style>{`@keyframes spin { to { transform: rotate(360deg); } }`}</style>
                </div>
              )}
              
              {/* SELECT MODE */}
              {mode === 'select' && (
                <>
                  <p style={{ color: 'var(--slate-500)', marginBottom: '20px', fontSize: '14px' }}>
                    Let AI build your journey, choose a template, or start from scratch.
                  </p>
                  
                  {/* AI Generate Button */}
                  <button
                    onClick={handleStartWizard}
                    style={{
                      display: 'flex', alignItems: 'center', gap: '16px', width: '100%', padding: '18px 20px',
                      background: 'linear-gradient(135deg, var(--navy-700), var(--navy-800))', border: 'none',
                      borderRadius: '12px', cursor: 'pointer', textAlign: 'left', marginBottom: '12px',
                      transition: 'all 0.2s', fontFamily: 'inherit'
                    }}
                    onMouseOver={(e) => { e.currentTarget.style.transform = 'translateY(-1px)'; e.currentTarget.style.boxShadow = '0 4px 12px rgba(25,43,69,0.3)'; }}
                    onMouseOut={(e) => { e.currentTarget.style.transform = 'translateY(0)'; e.currentTarget.style.boxShadow = 'none'; }}
                  >
                    <div style={{ fontSize: '24px' }}>‚ú®</div>
                    <div style={{ flex: 1 }}>
                      <div style={{ fontWeight: 600, color: '#FFF', fontSize: '15px' }}>AI-Powered Generation</div>
                      <div style={{ fontSize: '12px', color: 'rgba(255,255,255,0.7)' }}>Describe your process and let AI build your journey</div>
                    </div>
                    <div style={{ color: 'rgba(255,255,255,0.7)', fontSize: '16px' }}>‚Üí</div>
                  </button>
                  
                  {/* Blank Canvas */}
                  <button
                    onClick={() => handleSelectTemplate(JOURNEY_TEMPLATES.find(t => t.id === 'blank'))}
                    style={{
                      display: 'flex', alignItems: 'center', gap: '16px', width: '100%', padding: '14px 18px',
                      background: 'var(--slate-50)', border: '2px dashed var(--slate-300)', borderRadius: '10px',
                      cursor: 'pointer', textAlign: 'left', marginBottom: '20px', transition: 'all 0.15s', fontFamily: 'inherit'
                    }}
                    onMouseOver={(e) => { e.currentTarget.style.borderColor = 'var(--steel-400)'; e.currentTarget.style.background = 'var(--steel-100)'; }}
                    onMouseOut={(e) => { e.currentTarget.style.borderColor = 'var(--slate-300)'; e.currentTarget.style.background = 'var(--slate-50)'; }}
                  >
                    <div style={{ fontSize: '24px' }}>üìÑ</div>
                    <div style={{ flex: 1 }}>
                      <div style={{ fontWeight: 600, color: 'var(--navy-700)', fontSize: '14px' }}>Blank Canvas</div>
                      <div style={{ fontSize: '12px', color: 'var(--slate-500)' }}>Start from scratch</div>
                    </div>
                    <div style={{ color: 'var(--slate-400)', fontSize: '16px' }}>‚Üí</div>
                  </button>
                  
                  {/* Template List */}
                  <div style={{ maxHeight: '340px', overflowY: 'auto', marginRight: '-8px', paddingRight: '8px' }}>
                    {Object.entries(templatesByIndustry).filter(([ind]) => ind !== 'Any').map(([ind, templates]) => (
                      <div key={ind} style={{ marginBottom: '16px' }}>
                        <h3 style={{ fontSize: '10px', fontWeight: 600, color: 'var(--slate-400)', textTransform: 'uppercase', letterSpacing: '1px', marginBottom: '6px', paddingLeft: '4px' }}>{ind}</h3>
                        <div style={{ display: 'flex', flexDirection: 'column', gap: '2px' }}>
                          {templates.map(template => (
                            <button key={template.id} onClick={() => handleSelectTemplate(template)}
                              style={{ display: 'flex', alignItems: 'center', gap: '10px', width: '100%', padding: '10px 12px', background: '#FFF', border: '1px solid transparent', borderRadius: '6px', cursor: 'pointer', textAlign: 'left', transition: 'all 0.1s', fontFamily: 'inherit' }}
                              onMouseOver={(e) => { e.currentTarget.style.background = 'var(--slate-50)'; e.currentTarget.style.borderColor = 'var(--slate-200)'; }}
                              onMouseOut={(e) => { e.currentTarget.style.background = '#FFF'; e.currentTarget.style.borderColor = 'transparent'; }}
                            >
                              <div style={{ fontSize: '18px', width: '24px', textAlign: 'center' }}>{template.icon}</div>
                              <div style={{ flex: 1 }}><div style={{ fontWeight: 500, color: 'var(--navy-700)', fontSize: '13px' }}>{template.name}</div></div>
                              <div style={{ fontSize: '11px', color: 'var(--slate-400)' }}>{template.stageCount} stages</div>
                              <div style={{ color: 'var(--slate-300)', fontSize: '12px' }}>‚Ä∫</div>
                            </button>
                          ))}
                        </div>
                      </div>
                    ))}
                  </div>
                </>
              )}
              
              {/* WIZARD STEP 1: Description */}
              {mode === 'wizard' && wizardStep === 1 && (
                <>
                  <p style={{ color: 'var(--slate-500)', marginBottom: '20px', fontSize: '14px' }}>
                    Describe the process or journey you want to map. Be specific about what it involves.
                  </p>
                  <textarea
                    value={description}
                    onChange={(e) => setDescription(e.target.value)}
                    placeholder="e.g., Client onboarding for a wealth management firm, from initial enquiry through KYC checks, fact-finding, advice preparation, and implementation..."
                    rows={5}
                    style={{ width: '100%', padding: '14px', fontSize: '14px', border: '1px solid var(--slate-200)', borderRadius: '10px', resize: 'vertical', fontFamily: 'var(--font-body)', lineHeight: '1.5' }}
                    autoFocus
                  />
                  <p style={{ fontSize: '12px', color: 'var(--slate-400)', marginTop: '8px' }}>The more detail you provide, the better the generated journey will be.</p>
                  
                  <div style={{ display: 'flex', gap: '10px', marginTop: '24px' }}>
                    <button onClick={handleBack} className="btn btn-secondary" style={{ flex: 1 }}>Cancel</button>
                    <button onClick={() => setWizardStep(2)} className="btn btn-primary" style={{ flex: 1 }} disabled={description.trim().length < 10}>Continue</button>
                  </div>
                </>
              )}
              
              {/* WIZARD STEP 2: Context & Roles */}
              {mode === 'wizard' && wizardStep === 2 && (
                <>
                  <div style={{ display: 'grid', gridTemplateColumns: '1fr 1fr', gap: '12px', marginBottom: '16px' }}>
                    <div>
                      <label className="label">Industry</label>
                      <select value={industry} onChange={(e) => setIndustry(e.target.value)} className="input" style={{ width: '100%' }}>
                        <option value="">Select...</option>
                        {Object.entries(WIZARD_INDUSTRIES).map(([key, val]) => (
                          <option key={key} value={key}>{val.label}</option>
                        ))}
                      </select>
                    </div>
                    <div>
                      <label className="label">Journey Type</label>
                      <select value={journeyType} onChange={(e) => setJourneyType(e.target.value)} className="input" style={{ width: '100%' }}>
                        <option value="">Select...</option>
                        {WIZARD_JOURNEY_TYPES.map(jt => <option key={jt} value={jt}>{jt}</option>)}
                      </select>
                    </div>
                  </div>
                  
                  <div style={{ marginBottom: '20px' }}>
                    <label className="label">Complexity</label>
                    <div style={{ display: 'flex', gap: '8px' }}>
                      {WIZARD_COMPLEXITY.map(c => (
                        <button key={c.value} onClick={() => setComplexity(c.value)}
                          style={{
                            flex: 1, padding: '10px', borderRadius: '8px', border: complexity === c.value ? '2px solid var(--navy-600)' : '1px solid var(--slate-200)',
                            background: complexity === c.value ? 'var(--navy-50)' : '#FFF', cursor: 'pointer', fontFamily: 'inherit', transition: 'all 0.15s'
                          }}>
                          <div style={{ fontWeight: 600, fontSize: '13px', color: 'var(--navy-700)' }}>{c.label}</div>
                          <div style={{ fontSize: '11px', color: 'var(--slate-400)' }}>{c.stages}</div>
                        </button>
                      ))}
                    </div>
                  </div>
                  
                  <div style={{ marginBottom: '16px' }}>
                    <label className="label">Roles Involved <span style={{ fontWeight: 400, color: 'var(--slate-400)' }}>({roles.length} added)</span></label>
                    <div style={{ display: 'flex', flexWrap: 'wrap', gap: '6px', minHeight: '36px', padding: '8px', background: 'var(--slate-50)', borderRadius: '8px', marginBottom: '8px' }}>
                      {roles.map((role, i) => (
                        <span key={i} style={{ display: 'inline-flex', alignItems: 'center', gap: '6px', padding: '4px 10px', borderRadius: '16px', fontSize: '12px', background: role.isExternal ? 'var(--success-light)' : 'var(--steel-100)', color: role.isExternal ? 'var(--success)' : 'var(--steel-700)' }}>
                          {role.name}
                          {!role.isExternal && <span style={{ opacity: 0.6 }}>¬£{Math.round(role.salary/1000)}k</span>}
                          <button onClick={() => removeRole(i)} style={{ background: 'none', border: 'none', cursor: 'pointer', fontSize: '14px', opacity: 0.5, padding: 0 }}>√ó</button>
                        </span>
                      ))}
                      {roles.length === 0 && <span style={{ color: 'var(--slate-400)', fontSize: '12px' }}>Select an industry to get suggested roles</span>}
                    </div>
                    
                    {suggestedRoles.length > 0 && (
                      <div style={{ display: 'flex', flexWrap: 'wrap', gap: '6px', marginBottom: '12px' }}>
                        {suggestedRoles.map((sr, i) => (
                          <button key={i} onClick={() => addSuggestedRole(sr)}
                            style={{ padding: '4px 10px', borderRadius: '16px', border: '1px dashed var(--slate-300)', background: '#FFF', fontSize: '12px', color: 'var(--slate-500)', cursor: 'pointer', fontFamily: 'inherit' }}>
                            + {sr.name}
                          </button>
                        ))}
                      </div>
                    )}
                    
                    <div style={{ display: 'flex', gap: '8px' }}>
                      <input type="text" value={newRoleName} onChange={(e) => setNewRoleName(e.target.value)} placeholder="Add custom role..." className="input" style={{ flex: 1 }} onKeyDown={(e) => e.key === 'Enter' && handleAddCustomRole()} />
                      <label style={{ display: 'flex', alignItems: 'center', gap: '6px', fontSize: '12px', color: 'var(--slate-500)', whiteSpace: 'nowrap' }}>
                        <input type="checkbox" checked={newRoleExternal} onChange={(e) => setNewRoleExternal(e.target.checked)} /> External
                      </label>
                      <button onClick={handleAddCustomRole} className="btn btn-secondary" style={{ padding: '8px 12px' }}>Add</button>
                    </div>
                  </div>
                  
                  <div style={{ display: 'flex', gap: '10px', marginTop: '24px' }}>
                    <button onClick={handleBack} className="btn btn-secondary" style={{ flex: 1 }}>Back</button>
                    <button onClick={() => setWizardStep(3)} className="btn btn-primary" style={{ flex: 1 }} disabled={roles.length < 2}>Continue</button>
                  </div>
                </>
              )}
              
              {/* WIZARD STEP 3: Final Details */}
              {mode === 'wizard' && wizardStep === 3 && (
                <>
                  <div style={{ marginBottom: '20px' }}>
                    <label className="label">Key stages you know about <span style={{ fontWeight: 400, color: 'var(--slate-400)' }}>(optional)</span></label>
                    <textarea
                      value={knownStages}
                      onChange={(e) => setKnownStages(e.target.value)}
                      placeholder="e.g., Discovery, KYC, Fact-find, Advice, Implementation"
                      rows={2}
                      className="input"
                      style={{ resize: 'vertical' }}
                    />
                    <p style={{ fontSize: '11px', color: 'var(--slate-400)', marginTop: '4px' }}>Leave blank to auto-generate based on journey type.</p>
                  </div>
                  
                  <div style={{ padding: '16px', background: 'linear-gradient(135deg, var(--navy-50), var(--steel-100))', borderRadius: '12px', border: '1px solid var(--navy-100)', marginBottom: '20px' }}>
                    <div style={{ display: 'flex', alignItems: 'flex-start', gap: '12px' }}>
                      <span style={{ fontSize: '20px' }}>‚ú®</span>
                      <div style={{ flex: 1 }}>
                        <div style={{ fontWeight: 600, color: 'var(--navy-700)', marginBottom: '4px', fontSize: '14px' }}>AI-Enhanced Generation</div>
                        <div style={{ fontSize: '12px', color: 'var(--slate-600)', marginBottom: '10px' }}>Add your Anthropic API key for intelligent step descriptions and time estimates.</div>
                        <input
                          type="password"
                          placeholder="sk-ant-api03-..."
                          value={apiKey}
                          onChange={(e) => setApiKey(e.target.value)}
                          style={{ width: '100%', padding: '10px 12px', fontSize: '13px', fontFamily: 'monospace', borderRadius: '6px', border: '1px solid var(--slate-200)' }}
                        />
                        <div style={{ fontSize: '11px', color: 'var(--slate-400)', marginTop: '6px' }}>
                          Optional. Without a key, we'll generate a smart template structure. <a href="https://console.anthropic.com/settings/keys" target="_blank" style={{ color: 'var(--steel-600)' }}>Get an API key ‚Üí</a>
                        </div>
                      </div>
                    </div>
                  </div>
                  
                  <div style={{ display: 'flex', gap: '10px' }}>
                    <button onClick={handleBack} className="btn btn-secondary" style={{ flex: 1 }}>Back</button>
                    <button onClick={handleGenerate} className="btn btn-primary" style={{ flex: 1, background: 'linear-gradient(135deg, var(--amber-500), var(--amber-600))' }}>
                      ‚ú® Generate Journey
                    </button>
                  </div>
                </>
              )}
              
              {/* CUSTOMIZE MODE (for templates) */}
              {mode === 'customize' && selectedTemplate && (
                <>
                  <div style={{ display: 'flex', alignItems: 'center', gap: '14px', padding: '14px', background: 'var(--slate-50)', borderRadius: '10px', marginBottom: '20px' }}>
                    <div style={{ fontSize: '32px' }}>{selectedTemplate.icon}</div>
                    <div>
                      <div style={{ fontWeight: 600, color: 'var(--navy-700)', marginBottom: '2px', fontSize: '14px' }}>{selectedTemplate.name}</div>
                      <div style={{ fontSize: '12px', color: 'var(--slate-500)' }}>
                        {selectedTemplate.id === 'blank' ? 'Empty template' : `${selectedTemplate.stageCount} stages ‚Ä¢ ${selectedTemplate.config.personas.length} roles`}
                      </div>
                    </div>
                  </div>
                  
                  <div style={{ marginBottom: '16px' }}>
                    <label className="label">Map Title</label>
                    <input type="text" className="input" value={title} onChange={(e) => setTitle(e.target.value)} placeholder="e.g., Client Onboarding Journey" autoFocus />
                  </div>
                  
                  <div style={{ marginBottom: '24px' }}>
                    <label className="label">Description <span style={{ fontWeight: 400, color: 'var(--slate-400)' }}>(optional)</span></label>
                    <textarea className="input" value={templateDescription} onChange={(e) => setTemplateDescription(e.target.value)} placeholder="Brief description of this journey map" rows={3} style={{ resize: 'vertical' }} />
                  </div>
                  
                  <div style={{ display: 'flex', gap: '10px' }}>
                    <button onClick={onClose} className="btn btn-secondary" style={{ flex: 1 }}>Cancel</button>
                    <button onClick={handleCreateTemplate} className="btn btn-primary" style={{ flex: 1 }} disabled={!title.trim() || isCreating}>
                      {isCreating ? 'Creating...' : 'Create Map'}
                    </button>
                  </div>
                </>
              )}
            </div>
          </div>
        </div>
      );
    }

    // Share Modal (simplified)
    function ShareModal({ mapId, maps, mapConfigs, token, onClose, onUpdated }) {
      const map = maps.find(m => m.id === mapId);
      const displayTitle = mapConfigs?.[mapId]?.meta?.title || map?.title || 'Journey Map';
      const [email, setEmail] = useState('');
      const [permission, setPermission] = useState('view');
      const [isSharing, setIsSharing] = useState(false);

      const handleShare = async () => {
        if (!email.trim() || !email.includes('@')) return;
        setIsSharing(true);
        
        try {
          const updatedMap = {
            ...map,
            sharedWith: [...(map.sharedWith || []), { email: email.trim().toLowerCase(), permission, sharedAt: new Date().toISOString() }]
          };
          const updatedMaps = maps.map(m => m.id === mapId ? updatedMap : m);
          await saveToGitHub(GITHUB_CONFIG.indexFile, { maps: updatedMaps }, token, `Share ${displayTitle}`);
          onUpdated();
          setEmail('');
        } catch (err) {}
        setIsSharing(false);
      };

      const handleRemove = async (emailToRemove) => {
        try {
          const updatedMap = { ...map, sharedWith: map.sharedWith.filter(s => s.email !== emailToRemove) };
          const updatedMaps = maps.map(m => m.id === mapId ? updatedMap : m);
          await saveToGitHub(GITHUB_CONFIG.indexFile, { maps: updatedMaps }, token, `Unshare ${displayTitle}`);
          onUpdated();
        } catch (err) {}
      };

      return (
        <div className="modal-overlay" onClick={onClose}>
          <div className="modal" onClick={e => e.stopPropagation()}>
            <div className="modal-content">
              <div className="modal-header">
                <h2 className="modal-title">Share "{displayTitle}"</h2>
                <button className="modal-close" onClick={onClose}>√ó</button>
              </div>
              
              <div style={{ display: 'flex', gap: '8px', marginBottom: '16px' }}>
                <input type="email" className="input" value={email} onChange={e => setEmail(e.target.value)} placeholder="colleague@company.com" style={{ flex: 1 }} />
                <select className="input" value={permission} onChange={e => setPermission(e.target.value)} style={{ width: '100px' }}>
                  <option value="view">View</option>
                  <option value="edit">Edit</option>
                </select>
                <button onClick={handleShare} className="btn btn-primary" disabled={isSharing}>Share</button>
              </div>
              
              {map?.sharedWith?.length > 0 && (
                <div>
                  <p className="label" style={{ marginBottom: '8px' }}>Shared with:</p>
                  {map.sharedWith.map(s => (
                    <div key={s.email} style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', padding: '8px 0', borderBottom: '1px solid var(--slate-100)' }}>
                      <span style={{ fontSize: '14px' }}>{s.email} <span className="badge" style={{ marginLeft: '8px' }}>{s.permission}</span></span>
                      <button onClick={() => handleRemove(s.email)} className="btn btn-ghost" style={{ padding: '4px 8px', fontSize: '12px', color: 'var(--error)' }}>Remove</button>
                    </div>
                  ))}
                </div>
              )}
              
              <button onClick={onClose} className="btn btn-secondary" style={{ width: '100%', marginTop: '16px' }}>Done</button>
            </div>
          </div>
        </div>
      );
    }

    // ============================================
    // APP
    // ============================================
    function App() {
      const [user, setUser] = useState(null);
      const [token, setToken] = useState('');
      const [isLoaded, setIsLoaded] = useState(false);
      
      useEffect(() => {
        const savedUser = localStorage.getItem('fathom_user');
        const savedToken = localStorage.getItem('fathom_token');
        if (savedUser) {
          setUser(JSON.parse(savedUser));
          if (savedToken) setToken(savedToken);
        }
        setIsLoaded(true);
      }, []);
      
      const handleLogin = (userData, userToken) => {
        setUser(userData);
        setToken(userToken || '');
        localStorage.setItem('fathom_user', JSON.stringify(userData));
        if (userToken) localStorage.setItem('fathom_token', userToken);
      };
      
      const handleLogout = () => {
        setUser(null);
        setToken('');
        localStorage.removeItem('fathom_user');
        localStorage.removeItem('fathom_token');
        window.location.href = 'index.html';
      };
      
      const handleUpdateToken = (newToken) => {
        setToken(newToken);
        localStorage.setItem('fathom_token', newToken);
      };
      
      if (!isLoaded) {
        return (
          <div style={{ minHeight: '100vh', display: 'flex', alignItems: 'center', justifyContent: 'center', background: 'var(--navy-700)' }}>
            <img src="https://steveyoung74.github.io/journeymaps/logo_light.png" alt="FATHOM" style={{ height: '32px', opacity: 0.5 }} />
          </div>
        );
      }
      
      if (!user) {
        return <LoginModal onLogin={handleLogin} />;
      }
      
      return <Dashboard user={user} token={token} onLogout={handleLogout} onUpdateToken={handleUpdateToken} />;
    }
    
    ReactDOM.createRoot(document.getElementById('root')).render(<App />);
  </script>
</body>
</html>
