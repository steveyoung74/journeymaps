<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>FATHOM - See What Your Journeys Really Cost</title>
  <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <style>
    /* Interstate Font Family */
    @font-face {
      font-family: 'Interstate';
      src: url('https://steveyoung74.github.io/journeymaps/fonts/Interstate-light.ttf') format('truetype');
      font-weight: 300;
      font-style: normal;
      font-display: swap;
    }
    @font-face {
      font-family: 'Interstate';
      src: url('https://steveyoung74.github.io/journeymaps/fonts/Interstate-regular.ttf') format('truetype');
      font-weight: 400;
      font-style: normal;
      font-display: swap;
    }
    @font-face {
      font-family: 'Interstate';
      src: url('https://steveyoung74.github.io/journeymaps/fonts/Interstate-bold.ttf') format('truetype');
      font-weight: 700;
      font-style: normal;
      font-display: swap;
    }
    @font-face {
      font-family: 'Interstate Condensed';
      src: url('https://steveyoung74.github.io/journeymaps/fonts/Interstate-boldcondensed.ttf') format('truetype');
      font-weight: 700;
      font-style: normal;
      font-display: swap;
    }
    
    /* CSS Custom Properties - Fathom Color Palette */
    :root {
      --navy-950: #0C1620;
      --navy-900: #111E2E;
      --navy-800: #15243A;
      --navy-700: #192B45;
      --navy-600: #243D5C;
      --navy-500: #2F5070;
      --navy-400: #456A8A;
      --navy-300: #6889A8;
      --navy-200: #9BB1C7;
      --navy-100: #C8D5E2;
      --navy-50: #E9EEF4;
      --steel-600: #4A7485;
      --steel-500: #5B8A9A;
      --steel-400: #74A0AE;
      --steel-300: #96BCC7;
      --steel-100: #E1EEF2;
      --amber-700: #8B6914;
      --amber-500: #C4942A;
      --amber-200: #E8D5A3;
      --amber-100: #FAF0D6;
      --amber-50: #FDF8ED;
      --success: #2D8A6E;
      --success-light: #D4EDE5;
      --error: #B84A5A;
      --error-light: #F5E0E3;
      --slate-900: #1A2332;
      --slate-700: #3D4A5C;
      --slate-600: #556275;
      --slate-500: #6E7B8C;
      --slate-400: #8A95A5;
      --slate-300: #A9B2BE;
      --slate-200: #C8CED6;
      --slate-100: #E4E7EB;
      --slate-50: #F4F5F7;
    }
    
    * { box-sizing: border-box; margin: 0; padding: 0; }
    html { scroll-behavior: smooth; }
    body { 
      font-family: 'Interstate', -apple-system, BlinkMacSystemFont, sans-serif; 
      background: #FFF; 
      color: var(--slate-900);
      line-height: 1.6;
    }
    
    /* Buttons */
    .btn { 
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      padding: 14px 28px; 
      border-radius: 8px; 
      font-size: 15px; 
      font-weight: 500; 
      cursor: pointer; 
      transition: all 0.2s;
      border: none;
      font-family: inherit;
      text-decoration: none;
    }
    .btn:disabled { opacity: 0.5; cursor: not-allowed; }
    .btn-primary { background: var(--navy-700); color: #FFF; }
    .btn-primary:hover:not(:disabled) { background: var(--navy-800); transform: translateY(-1px); }
    .btn-secondary { background: #FFF; color: var(--navy-700); border: 2px solid var(--navy-700); }
    .btn-secondary:hover:not(:disabled) { background: var(--navy-50); }
    .btn-ghost { background: transparent; color: var(--slate-600); }
    .btn-ghost:hover:not(:disabled) { background: var(--slate-100); }
    .btn-light { background: rgba(255,255,255,0.15); color: #FFF; border: 1px solid rgba(255,255,255,0.3); }
    .btn-light:hover:not(:disabled) { background: rgba(255,255,255,0.25); }
    
    /* Form Elements */
    .input {
      width: 100%;
      padding: 14px 16px;
      border: 1px solid var(--slate-200);
      border-radius: 8px;
      font-size: 15px;
      font-family: inherit;
      transition: border-color 0.15s, box-shadow 0.15s;
    }
    .input:focus { 
      outline: none;
      border-color: var(--steel-500); 
      box-shadow: 0 0 0 3px rgba(91, 138, 154, 0.15);
    }
    .label {
      display: block;
      font-size: 14px;
      font-weight: 500;
      color: var(--slate-700);
      margin-bottom: 8px;
    }
    
    /* Cards */
    .card {
      background: #FFF;
      border-radius: 16px;
      box-shadow: 0 4px 24px rgba(25, 43, 69, 0.08);
    }
    
    /* Modal */
    .modal-overlay {
      position: fixed;
      inset: 0;
      background: rgba(12, 22, 32, 0.7);
      backdrop-filter: blur(4px);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 9999;
      padding: 20px;
      opacity: 0;
      animation: fadeIn 0.2s ease forwards;
    }
    @keyframes fadeIn {
      to { opacity: 1; }
    }
    
    /* Hero logo entrance animation */
    .hero-logo {
      animation: heroLogoIn 0.8s ease-out forwards;
      opacity: 0;
    }
    @keyframes heroLogoIn {
      0% {
        opacity: 0;
        transform: translateY(-20px);
      }
      100% {
        opacity: 1;
        transform: translateY(0);
      }
    }
    
    /* Hero content staggered entrance */
    .hero-badge {
      animation: heroContentIn 0.7s ease-out 0.2s forwards;
      opacity: 0;
    }
    .hero-headline {
      animation: heroContentIn 0.7s ease-out 0.35s forwards;
      opacity: 0;
    }
    .hero-subhead {
      animation: heroContentIn 0.7s ease-out 0.5s forwards;
      opacity: 0;
    }
    .hero-buttons {
      animation: heroContentIn 0.7s ease-out 0.65s forwards;
      opacity: 0;
    }
    .stats-bar {
      animation: heroContentIn 0.7s ease-out 0.85s forwards;
      opacity: 0;
    }
    @keyframes heroContentIn {
      0% {
        opacity: 0;
        transform: translateY(20px);
      }
      100% {
        opacity: 1;
        transform: translateY(0);
      }
    }
    .modal {
      background: #FFF;
      border-radius: 20px;
      max-width: 440px;
      width: 100%;
      max-height: 90vh;
      overflow-y: auto;
      transform: translateY(20px);
      animation: slideUp 0.3s ease forwards;
    }
    @keyframes slideUp {
      to { transform: translateY(0); }
    }
    
    /* Badge */
    .badge {
      display: inline-flex;
      align-items: center;
      padding: 6px 12px;
      border-radius: 20px;
      font-size: 12px;
      font-weight: 500;
    }
    .badge-owner { background: var(--steel-100); color: var(--navy-600); }
    .badge-edit { background: var(--success-light); color: var(--success); }
    .badge-view { background: var(--slate-100); color: var(--slate-600); }
    
    /* Utility */
    .text-muted { color: var(--slate-600); }
    .text-small { font-size: 13px; }
    .text-error { color: var(--error); font-size: 13px; }
    
    /* Hero gradient background with topographic pattern */
    .hero-bg {
      background: linear-gradient(135deg, var(--navy-700) 0%, var(--navy-950) 100%);
      position: relative;
      overflow: hidden;
    }
    .hero-bg::before {
      content: '';
      position: absolute;
      inset: 0;
      background: url('topography-dark.svg') center/600px 600px repeat;
      opacity: 1;
      pointer-events: none;
    }
    .hero-bg::after {
      content: '';
      position: absolute;
      top: -50%;
      right: -20%;
      width: 80%;
      height: 200%;
      background: radial-gradient(ellipse at center, rgba(91, 138, 154, 0.1) 0%, transparent 60%);
      pointer-events: none;
    }
    
    /* Section styling */
    .section {
      padding: 100px 24px;
    }
    .section-alt {
      background: var(--slate-50);
      position: relative;
    }
    .section-alt::before {
      content: '';
      position: absolute;
      inset: 0;
      background: url('topography-light.svg') center/600px 600px repeat;
      opacity: 1;
      pointer-events: none;
      z-index: 0;
    }
    .section-alt > .container {
      position: relative;
      z-index: 1;
    }
    
    /* Dashboard background with topographic pattern */
    .dashboard-bg {
      min-height: 100vh;
      background: var(--slate-50);
      position: relative;
    }
    .dashboard-bg::before {
      content: '';
      position: absolute;
      inset: 0;
      background: url('topography-light.svg') center/600px 600px repeat;
      opacity: 1;
      pointer-events: none;
      z-index: 0;
    }
    .dashboard-bg > header,
    .dashboard-bg > main {
      position: relative;
      z-index: 1;
    }
    
    /* CTA section with topographic pattern */
    .cta-section {
      background: linear-gradient(135deg, var(--navy-700) 0%, var(--navy-900) 100%);
      padding: 100px 24px;
      position: relative;
    }
    .cta-section::before {
      content: '';
      position: absolute;
      inset: 0;
      background: url('topography-dark.svg') center/600px 600px repeat;
      opacity: 1;
      pointer-events: none;
    }
    .cta-section > * {
      position: relative;
      z-index: 1;
    }
    .container {
      max-width: 1140px;
      margin: 0 auto;
    }
    
    /* Feature cards */
    .feature-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(320px, 1fr));
      gap: 24px;
    }
    .feature-card {
      padding: 32px;
      background: #FFF;
      border-radius: 16px;
      border: 1px solid var(--slate-100);
      transition: all 0.25s;
    }
    .feature-card:hover {
      border-color: var(--steel-300);
      box-shadow: 0 12px 40px rgba(25, 43, 69, 0.1);
      transform: translateY(-4px);
    }
    .feature-icon {
      width: 56px;
      height: 56px;
      background: linear-gradient(135deg, var(--navy-50) 0%, var(--steel-100) 100%);
      border-radius: 14px;
      display: flex;
      align-items: center;
      justify-content: center;
      margin-bottom: 20px;
      font-size: 26px;
    }
    
    /* Steps */
    .steps {
      display: flex;
      gap: 32px;
      flex-wrap: wrap;
      justify-content: center;
    }
    .step {
      flex: 1;
      min-width: 280px;
      max-width: 340px;
      text-align: center;
      padding: 40px 28px;
      background: #FFF;
      border-radius: 16px;
      box-shadow: 0 2px 12px rgba(25, 43, 69, 0.06);
    }
    .step-number {
      width: 56px;
      height: 56px;
      background: var(--navy-700);
      color: #FFF;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 22px;
      font-weight: 700;
      margin: 0 auto 24px;
    }
    
    /* Stats bar */
    .stats-bar {
      display: flex;
      gap: 48px;
      flex-wrap: wrap;
      justify-content: center;
      padding: 48px 0;
    }
    .stat-item {
      text-align: center;
    }
    .stat-value {
      font-size: 48px;
      font-weight: 300;
      color: var(--steel-400);
      line-height: 1;
    }
    .stat-label {
      font-size: 14px;
      color: rgba(255,255,255,0.6);
      margin-top: 8px;
    }
    
    /* Responsive */
    @media (max-width: 768px) {
      .section { padding: 60px 20px; }
      .hero-content h1 { font-size: 36px !important; }
      .hero-buttons { flex-direction: column; }
      .nav-links { display: none !important; }
      .stat-value { font-size: 36px; }
      .stats-bar { gap: 32px; }
    }
  </style>
</head>
<body>
  <div id="root"></div>
  
  <script type="text/babel">
    const { useState, useEffect } = React;
    
    const APP_VERSION = '1.3.0';
    
    // Helper to safely format dates
    const formatDate = (dateStr) => {
      if (!dateStr) return 'Unknown';
      const date = new Date(dateStr);
      if (isNaN(date.getTime())) return 'Unknown';
      return date.toLocaleDateString();
    };
    
    // GitHub configuration
    const GITHUB_CONFIG = {
      owner: 'steveyoung74',
      repo: 'journeymaps',
      branch: 'main',
      mapsPath: 'maps',
      indexFile: 'maps/index.json'
    };
    
    const getRawUrl = (path) => 
      `https://raw.githubusercontent.com/${GITHUB_CONFIG.owner}/${GITHUB_CONFIG.repo}/${GITHUB_CONFIG.branch}/${path}`;
    
    const getApiUrl = (path) => 
      `https://api.github.com/repos/${GITHUB_CONFIG.owner}/${GITHUB_CONFIG.repo}/contents/${path}`;
    
    async function fetchFromGitHub(path) {
      // Use cache-bust query param to avoid CDN caching
      // Don't use custom headers as they trigger CORS preflight which raw.githubusercontent.com doesn't support
      const cacheBust = `${Date.now()}-${Math.random().toString(36).substr(2, 9)}`;
      const url = getRawUrl(path) + '?t=' + cacheBust;
      console.log('Fetching:', url);
      const response = await fetch(url);
      if (!response.ok) {
        if (response.status === 404) return null;
        throw new Error(`GitHub fetch failed: ${response.status}`);
      }
      return response.json();
    }
    
    async function saveToGitHub(path, content, token, message = 'Update from Fathom') {
      const apiUrl = getApiUrl(path);
      let sha = null;
      
      try {
        const existingResponse = await fetch(apiUrl, {
          headers: { 'Authorization': `token ${token}` }
        });
        if (existingResponse.ok) {
          const existing = await existingResponse.json();
          sha = existing.sha;
        }
      } catch (e) {}
      
      const body = {
        message,
        content: btoa(unescape(encodeURIComponent(JSON.stringify(content, null, 2)))),
        branch: GITHUB_CONFIG.branch
      };
      if (sha) body.sha = sha;
      
      const response = await fetch(apiUrl, {
        method: 'PUT',
        headers: {
          'Authorization': `token ${token}`,
          'Content-Type': 'application/json'
        },
        body: JSON.stringify(body)
      });
      
      if (!response.ok) {
        const error = await response.json();
        throw new Error(error.message || 'Failed to save');
      }
      
      return response.json();
    }
    
    async function deleteFromGitHub(path, token, message = 'Delete from Fathom') {
      const apiUrl = getApiUrl(path);
      const existingResponse = await fetch(apiUrl, {
        headers: { 'Authorization': `token ${token}` }
      });
      if (!existingResponse.ok) throw new Error('File not found');
      const existing = await existingResponse.json();
      
      const response = await fetch(apiUrl, {
        method: 'DELETE',
        headers: {
          'Authorization': `token ${token}`,
          'Content-Type': 'application/json'
        },
        body: JSON.stringify({
          message,
          sha: existing.sha,
          branch: GITHUB_CONFIG.branch
        })
      });
      
      if (!response.ok) throw new Error('Failed to delete');
      return true;
    }
    
    // ============================================
    // LANDING PAGE
    // ============================================
    function LandingPage({ onGetStarted }) {
      const [scrolled, setScrolled] = useState(false);
      const [logoVisible, setLogoVisible] = useState(false);
      
      useEffect(() => {
        const handleScroll = () => {
          const scrollY = window.scrollY;
          setScrolled(scrollY > 50);
          // Show nav logo when hero logo scrolls out of view (around 200px)
          setLogoVisible(scrollY > 200);
        };
        window.addEventListener('scroll', handleScroll);
        return () => window.removeEventListener('scroll', handleScroll);
      }, []);
      
      return (
        <div>
          {/* Navigation */}
          <nav style={{
            position: 'fixed',
            top: 0,
            left: 0,
            right: 0,
            zIndex: 100,
            padding: '16px 32px',
            display: 'flex',
            justifyContent: 'space-between',
            alignItems: 'center',
            background: scrolled ? 'rgba(25, 43, 69, 0.98)' : 'transparent',
            backdropFilter: scrolled ? 'blur(12px)' : 'none',
            transition: 'all 0.3s',
            borderBottom: scrolled ? '1px solid rgba(255,255,255,0.1)' : 'none'
          }}>
            <img 
              src="logo_light.png" 
              alt="FATHOM" 
              style={{ 
                height: '28px',
                opacity: logoVisible ? 1 : 0,
                transform: logoVisible ? 'translateY(0)' : 'translateY(-8px)',
                transition: 'opacity 0.4s ease, transform 0.4s ease'
              }} 
            />
            <div className="nav-links" style={{ display: 'flex', gap: '40px', alignItems: 'center' }}>
              <a href="#features" style={{ color: 'rgba(255,255,255,0.8)', textDecoration: 'none', fontSize: '14px', fontWeight: 500 }}>Features</a>
              <a href="#how-it-works" style={{ color: 'rgba(255,255,255,0.8)', textDecoration: 'none', fontSize: '14px', fontWeight: 500 }}>How It Works</a>
              <a href="#use-cases" style={{ color: 'rgba(255,255,255,0.8)', textDecoration: 'none', fontSize: '14px', fontWeight: 500 }}>Use Cases</a>
              <button onClick={onGetStarted} className="btn btn-light" style={{ padding: '10px 24px' }}>
                Sign In
              </button>
            </div>
          </nav>
          
          {/* Hero Section */}
          <section className="hero-bg" style={{ minHeight: '100vh', display: 'flex', flexDirection: 'column', justifyContent: 'center', padding: '120px 24px 60px' }}>
            <div className="container" style={{ position: 'relative', zIndex: 1 }}>
              <div className="hero-content" style={{ maxWidth: '720px', marginBottom: '48px' }}>
                {/* Large Hero Logo */}
                <img 
                  src="logo_light.png" 
                  alt="FATHOM" 
                  className="hero-logo"
                  style={{ 
                    height: '80px',
                    marginBottom: '48px'
                  }} 
                />
                
                <div className="hero-badge" style={{ 
                  display: 'inline-block',
                  padding: '10px 20px', 
                  background: 'rgba(91, 138, 154, 0.2)', 
                  borderRadius: '24px', 
                  marginBottom: '28px',
                  fontSize: '13px',
                  color: 'var(--steel-300)',
                  fontWeight: 500,
                  letterSpacing: '0.5px'
                }}>
                  JOURNEY INTELLIGENCE PLATFORM
                </div>
                <h1 className="hero-headline" style={{ 
                  fontSize: '60px', 
                  fontWeight: 300, 
                  color: '#FFF', 
                  marginBottom: '24px',
                  lineHeight: 1.08,
                  letterSpacing: '-1.5px'
                }}>
                  See what your journeys <br/><span style={{ color: 'var(--steel-400)' }}>really cost</span>
                </h1>
                <p className="hero-subhead" style={{ 
                  fontSize: '20px', 
                  color: 'var(--slate-300)', 
                  marginBottom: '40px',
                  lineHeight: 1.7,
                  maxWidth: '560px'
                }}>
                  Map operational processes with precision. Capture ground-truth data from the people who do the work. Transform assumptions into actionable insights.
                </p>
                <div className="hero-buttons" style={{ display: 'flex', gap: '16px', flexWrap: 'wrap' }}>
                  <button onClick={onGetStarted} className="btn btn-primary" style={{ padding: '18px 36px', fontSize: '16px' }}>
                    Get Started Free
                    <span style={{ marginLeft: '4px' }}>‚Üí</span>
                  </button>
                  <a href="#features" className="btn btn-secondary" style={{ padding: '18px 36px', background: 'transparent', borderColor: 'rgba(255,255,255,0.3)', color: '#FFF' }}>
                    See How It Works
                  </a>
                </div>
              </div>
              
              {/* Stats Bar */}
              <div className="stats-bar" style={{ borderTop: '1px solid rgba(255,255,255,0.1)', marginTop: '40px' }}>
                <div className="stat-item">
                  <div className="stat-value">¬£2,847</div>
                  <div className="stat-label">Avg. cost per client onboarded</div>
                </div>
                <div className="stat-item">
                  <div className="stat-value">38%</div>
                  <div className="stat-label">Typical automation potential</div>
                </div>
                <div className="stat-item">
                  <div className="stat-value">6.2hrs</div>
                  <div className="stat-label">Average journey duration</div>
                </div>
              </div>
            </div>
          </section>
          
          {/* Problem Statement */}
          <section className="section" style={{ background: '#FFF' }}>
            <div className="container">
              <div style={{ maxWidth: '800px', margin: '0 auto', textAlign: 'center' }}>
                <h2 style={{ fontSize: '36px', fontWeight: 300, marginBottom: '24px', color: 'var(--navy-700)', lineHeight: 1.3 }}>
                  Your operations are more expensive than you think
                </h2>
                <p style={{ fontSize: '18px', color: 'var(--slate-600)', lineHeight: 1.8, marginBottom: '40px' }}>
                  Most organisations underestimate the true cost of their operational journeys. Hidden inefficiencies, manual handoffs, compliance overhead, and client drop-offs silently erode margins. <strong style={{ color: 'var(--navy-700)' }}>Fathom makes the invisible visible</strong> ‚Äî so you can fix what matters most.
                </p>
                <div style={{ display: 'flex', gap: '24px', justifyContent: 'center', flexWrap: 'wrap' }}>
                  <div style={{ padding: '20px 32px', background: 'var(--error-light)', borderRadius: '12px' }}>
                    <div style={{ fontSize: '14px', color: 'var(--error)', fontWeight: 600 }}>The Problem</div>
                    <div style={{ fontSize: '15px', color: 'var(--slate-700)', marginTop: '4px' }}>Spreadsheets and guesswork</div>
                  </div>
                  <div style={{ padding: '20px 32px', background: 'var(--success-light)', borderRadius: '12px' }}>
                    <div style={{ fontSize: '14px', color: 'var(--success)', fontWeight: 600 }}>The Solution</div>
                    <div style={{ fontSize: '15px', color: 'var(--slate-700)', marginTop: '4px' }}>Precision journey intelligence</div>
                  </div>
                </div>
              </div>
            </div>
          </section>
          
          {/* Features Section */}
          <section id="features" className="section section-alt">
            <div className="container">
              <div style={{ textAlign: 'center', marginBottom: '64px' }}>
                <div style={{ fontSize: '13px', color: 'var(--steel-500)', fontWeight: 600, letterSpacing: '1px', marginBottom: '12px' }}>CAPABILITIES</div>
                <h2 style={{ fontSize: '40px', fontWeight: 300, marginBottom: '16px', color: 'var(--navy-700)' }}>
                  Understand deeply. Improve decisively.
                </h2>
                <p style={{ fontSize: '18px', color: 'var(--slate-600)', maxWidth: '600px', margin: '0 auto' }}>
                  Everything you need to map, measure, and optimise your operational journeys.
                </p>
              </div>
              
              <div className="feature-grid">
                <div className="feature-card">
                  <div className="feature-icon">‚è±Ô∏è</div>
                  <h3 style={{ fontSize: '20px', fontWeight: 600, marginBottom: '12px', color: 'var(--navy-700)' }}>
                    Time Tracking
                  </h3>
                  <p style={{ color: 'var(--slate-600)', fontSize: '15px', lineHeight: 1.7 }}>
                    Capture time at every step, broken down by role. See where hours accumulate and where bottlenecks form across your entire journey.
                  </p>
                </div>
                
                <div className="feature-card">
                  <div className="feature-icon">üí∑</div>
                  <h3 style={{ fontSize: '20px', fontWeight: 600, marginBottom: '12px', color: 'var(--navy-700)' }}>
                    True Cost Analysis
                  </h3>
                  <p style={{ color: 'var(--slate-600)', fontSize: '15px', lineHeight: 1.7 }}>
                    Fully-burdened costs including salary, employer NI, pension, workspace, and third-party services. See the real numbers, not estimates.
                  </p>
                </div>
                
                <div className="feature-card">
                  <div className="feature-icon">üìâ</div>
                  <h3 style={{ fontSize: '20px', fontWeight: 600, marginBottom: '12px', color: 'var(--navy-700)' }}>
                    Funnel Analysis
                  </h3>
                  <p style={{ color: 'var(--slate-600)', fontSize: '15px', lineHeight: 1.7 }}>
                    Track client volumes through each stage. See drop-offs, calculate wasted investment, and identify your leakiest stages instantly.
                  </p>
                </div>
                
                <div className="feature-card">
                  <div className="feature-icon">üë•</div>
                  <h3 style={{ fontSize: '20px', fontWeight: 600, marginBottom: '12px', color: 'var(--navy-700)' }}>
                    Multi-Perspective Views
                  </h3>
                  <p style={{ color: 'var(--slate-600)', fontSize: '15px', lineHeight: 1.7 }}>
                    See the journey from any role's perspective ‚Äî client, advisor, operations, compliance. Different views reveal different truths.
                  </p>
                </div>
                
                <div className="feature-card">
                  <div className="feature-icon">üò§</div>
                  <h3 style={{ fontSize: '20px', fontWeight: 600, marginBottom: '12px', color: 'var(--navy-700)' }}>
                    Friction Mapping
                  </h3>
                  <p style={{ color: 'var(--slate-600)', fontSize: '15px', lineHeight: 1.7 }}>
                    Identify pain points, emotional states, and cognitive load. Not all work is equal ‚Äî some steps drain more than they should.
                  </p>
                </div>
                
                <div className="feature-card">
                  <div className="feature-icon">üéØ</div>
                  <h3 style={{ fontSize: '20px', fontWeight: 600, marginBottom: '12px', color: 'var(--navy-700)' }}>
                    Opportunity Scoring
                  </h3>
                  <p style={{ color: 'var(--slate-600)', fontSize: '15px', lineHeight: 1.7 }}>
                    Automatically flag automation opportunities. See potential savings before you start the transformation project.
                  </p>
                </div>
                
                <div className="feature-card">
                  <div className="feature-icon">üìã</div>
                  <h3 style={{ fontSize: '20px', fontWeight: 600, marginBottom: '12px', color: 'var(--navy-700)' }}>
                    Employee Surveys
                  </h3>
                  <p style={{ color: 'var(--slate-600)', fontSize: '15px', lineHeight: 1.7 }}>
                    Collect ground-truth data from the people who do the work. Role-specific questionnaires capture time, friction, and improvement ideas.
                  </p>
                </div>
                
                <div className="feature-card">
                  <div className="feature-icon">üìä</div>
                  <h3 style={{ fontSize: '20px', fontWeight: 600, marginBottom: '12px', color: 'var(--navy-700)' }}>
                    Executive Reports
                  </h3>
                  <p style={{ color: 'var(--slate-600)', fontSize: '15px', lineHeight: 1.7 }}>
                    One-click PDF exports with cost summaries, opportunity rankings, and funnel analysis. Board-ready insight without the busywork.
                  </p>
                </div>
              </div>
            </div>
          </section>
          
          {/* How It Works */}
          <section id="how-it-works" className="section">
            <div className="container">
              <div style={{ textAlign: 'center', marginBottom: '64px' }}>
                <div style={{ fontSize: '13px', color: 'var(--steel-500)', fontWeight: 600, letterSpacing: '1px', marginBottom: '12px' }}>PROCESS</div>
                <h2 style={{ fontSize: '40px', fontWeight: 300, marginBottom: '16px', color: 'var(--navy-700)' }}>
                  From complexity to clarity in three steps
                </h2>
              </div>
              
              <div className="steps">
                <div className="step">
                  <div className="step-number">1</div>
                  <h3 style={{ fontSize: '20px', fontWeight: 600, marginBottom: '12px', color: 'var(--navy-700)' }}>
                    Map Your Journey
                  </h3>
                  <p style={{ color: 'var(--slate-600)', fontSize: '15px', lineHeight: 1.7 }}>
                    Define stages and steps. Assign roles, times, and touchpoints. Capture the process as it really happens ‚Äî not as it's documented.
                  </p>
                </div>
                
                <div className="step">
                  <div className="step-number">2</div>
                  <h3 style={{ fontSize: '20px', fontWeight: 600, marginBottom: '12px', color: 'var(--navy-700)' }}>
                    Add the Numbers
                  </h3>
                  <p style={{ color: 'var(--slate-600)', fontSize: '15px', lineHeight: 1.7 }}>
                    Input salaries, burden rates, and volumes. Fathom calculates fully-loaded costs and surfaces insights you couldn't see before.
                  </p>
                </div>
                
                <div className="step">
                  <div className="step-number">3</div>
                  <h3 style={{ fontSize: '20px', fontWeight: 600, marginBottom: '12px', color: 'var(--navy-700)' }}>
                    Decide with Confidence
                  </h3>
                  <p style={{ color: 'var(--slate-600)', fontSize: '15px', lineHeight: 1.7 }}>
                    Export reports, share with stakeholders, and prioritise improvements based on real impact ‚Äî not hunches or politics.
                  </p>
                </div>
              </div>
            </div>
          </section>
          
          {/* Collaborative Intelligence Section */}
          <section className="section section-alt">
            <div className="container">
              <div style={{ display: 'flex', gap: '80px', alignItems: 'center', flexWrap: 'wrap' }}>
                <div style={{ flex: '1 1 400px' }}>
                  <div style={{ 
                    background: 'linear-gradient(145deg, #FFF 0%, var(--slate-50) 100%)',
                    borderRadius: '20px',
                    padding: '40px',
                    boxShadow: '0 8px 32px rgba(0,0,0,0.08)',
                    border: '1px solid var(--slate-200)'
                  }}>
                    {/* Survey Preview */}
                    <div style={{ marginBottom: '24px' }}>
                      <div style={{ display: 'flex', alignItems: 'center', gap: '12px', marginBottom: '20px' }}>
                        <div style={{ width: '40px', height: '40px', borderRadius: '10px', background: 'var(--navy-900)', display: 'flex', alignItems: 'center', justifyContent: 'center', color: '#FFF', fontSize: '18px' }}>üìã</div>
                        <div>
                          <div style={{ fontSize: '13px', color: 'var(--slate-500)' }}>Process Survey</div>
                          <div style={{ fontWeight: 600, color: 'var(--navy-700)' }}>Client Onboarding</div>
                        </div>
                      </div>
                    </div>
                    
                    <div style={{ background: '#FFF', borderRadius: '12px', padding: '20px', border: '1px solid var(--slate-200)', marginBottom: '16px' }}>
                      <div style={{ fontSize: '11px', color: 'var(--steel-500)', fontWeight: 600, textTransform: 'uppercase', letterSpacing: '0.5px', marginBottom: '8px' }}>Stage 2 ¬∑ Opportunity Qualification</div>
                      <div style={{ fontWeight: 600, color: 'var(--navy-700)', marginBottom: '16px' }}>Initial Client Call</div>
                      
                      <div style={{ marginBottom: '16px' }}>
                        <div style={{ fontSize: '13px', color: 'var(--slate-600)', marginBottom: '6px' }}>How long does this typically take you?</div>
                        <div style={{ display: 'flex', alignItems: 'center', gap: '8px' }}>
                          <div style={{ flex: 1, height: '38px', background: 'var(--slate-100)', borderRadius: '6px', border: '2px solid var(--slate-200)', display: 'flex', alignItems: 'center', paddingLeft: '12px', color: 'var(--slate-500)', fontSize: '14px' }}>25</div>
                          <div style={{ background: 'var(--slate-100)', padding: '8px 14px', borderRadius: '6px', fontSize: '13px', color: 'var(--slate-600)' }}>minutes</div>
                        </div>
                      </div>
                      
                      <div>
                        <div style={{ fontSize: '13px', color: 'var(--slate-600)', marginBottom: '8px' }}>How much friction do you experience?</div>
                        <div style={{ display: 'flex', gap: '8px' }}>
                          {[
                            { emoji: 'üòä', label: 'None' },
                            { emoji: 'üôÇ', label: 'Low', selected: true },
                            { emoji: 'üòê', label: 'Medium' },
                            { emoji: 'üò´', label: 'High' }
                          ].map((opt, i) => (
                            <div key={i} style={{ 
                              flex: 1, 
                              padding: '10px 6px', 
                              border: opt.selected ? '2px solid var(--steel-500)' : '1px solid var(--slate-200)', 
                              borderRadius: '8px', 
                              textAlign: 'center',
                              background: opt.selected ? 'rgba(91, 138, 154, 0.1)' : '#FFF'
                            }}>
                              <div style={{ fontSize: '20px', marginBottom: '2px' }}>{opt.emoji}</div>
                              <div style={{ fontSize: '10px', fontWeight: 600, color: 'var(--slate-600)' }}>{opt.label}</div>
                            </div>
                          ))}
                        </div>
                      </div>
                    </div>
                    
                    <div style={{ display: 'flex', alignItems: 'center', gap: '8px', color: 'var(--slate-500)', fontSize: '13px' }}>
                      <span>‚úì</span>
                      <span>Step 2 of 5 ¬∑ About 4 minutes remaining</span>
                    </div>
                  </div>
                </div>
                
                <div style={{ flex: '1 1 440px' }}>
                  <div style={{ 
                    padding: '10px 18px', 
                    background: 'var(--success-light)', 
                    borderRadius: '24px', 
                    display: 'inline-block',
                    marginBottom: '24px',
                    fontSize: '13px',
                    color: 'var(--success)',
                    fontWeight: 600,
                    letterSpacing: '0.5px'
                  }}>
                    COLLABORATIVE INTELLIGENCE
                  </div>
                  <h2 style={{ fontSize: '36px', fontWeight: 300, marginBottom: '24px', color: 'var(--navy-700)', lineHeight: 1.25 }}>
                    Don't guess.<br/>Ask the people who do the work.
                  </h2>
                  <p style={{ color: 'var(--slate-600)', fontSize: '17px', marginBottom: '20px', lineHeight: 1.8 }}>
                    Top-down process mapping misses the truth. The people doing the work know where time is wasted, what causes friction, and what could be better ‚Äî <strong style={{ color: 'var(--navy-700)' }}>but no one asks them</strong>.
                  </p>
                  <p style={{ color: 'var(--slate-600)', fontSize: '17px', marginBottom: '32px', lineHeight: 1.8 }}>
                    Fathom's built-in survey system sends personalised questionnaires to everyone involved in your process. Each person only sees the steps relevant to their role. Responses flow back into your journey map automatically ‚Äî giving you ground-truth data, not boardroom assumptions.
                  </p>
                  
                  <div style={{ display: 'flex', flexDirection: 'column', gap: '16px' }}>
                    <div style={{ display: 'flex', alignItems: 'flex-start', gap: '14px' }}>
                      <div style={{ width: '28px', height: '28px', borderRadius: '50%', background: 'var(--success-light)', display: 'flex', alignItems: 'center', justifyContent: 'center', flexShrink: 0, marginTop: '2px' }}>
                        <span style={{ color: 'var(--success)', fontSize: '14px' }}>‚úì</span>
                      </div>
                      <div>
                        <div style={{ fontWeight: 600, color: 'var(--navy-700)', marginBottom: '2px' }}>Role-specific surveys</div>
                        <div style={{ fontSize: '14px', color: 'var(--slate-600)' }}>Each person only sees steps assigned to their role</div>
                      </div>
                    </div>
                    <div style={{ display: 'flex', alignItems: 'flex-start', gap: '14px' }}>
                      <div style={{ width: '28px', height: '28px', borderRadius: '50%', background: 'var(--success-light)', display: 'flex', alignItems: 'center', justifyContent: 'center', flexShrink: 0, marginTop: '2px' }}>
                        <span style={{ color: 'var(--success)', fontSize: '14px' }}>‚úì</span>
                      </div>
                      <div>
                        <div style={{ fontWeight: 600, color: 'var(--navy-700)', marginBottom: '2px' }}>No login required</div>
                        <div style={{ fontSize: '14px', color: 'var(--slate-600)' }}>Mobile-friendly links work instantly for all respondents</div>
                      </div>
                    </div>
                    <div style={{ display: 'flex', alignItems: 'flex-start', gap: '14px' }}>
                      <div style={{ width: '28px', height: '28px', borderRadius: '50%', background: 'var(--success-light)', display: 'flex', alignItems: 'center', justifyContent: 'center', flexShrink: 0, marginTop: '2px' }}>
                        <span style={{ color: 'var(--success)', fontSize: '14px' }}>‚úì</span>
                      </div>
                      <div>
                        <div style={{ fontWeight: 600, color: 'var(--navy-700)', marginBottom: '2px' }}>Capture pain points & ideas</div>
                        <div style={{ fontSize: '14px', color: 'var(--slate-600)' }}>Time estimates, friction, regulatory notes, and improvement suggestions</div>
                      </div>
                    </div>
                    <div style={{ display: 'flex', alignItems: 'flex-start', gap: '14px' }}>
                      <div style={{ width: '28px', height: '28px', borderRadius: '50%', background: 'var(--success-light)', display: 'flex', alignItems: 'center', justifyContent: 'center', flexShrink: 0, marginTop: '2px' }}>
                        <span style={{ color: 'var(--success)', fontSize: '14px' }}>‚úì</span>
                      </div>
                      <div>
                        <div style={{ fontWeight: 600, color: 'var(--navy-700)', marginBottom: '2px' }}>Build trust, not resentment</div>
                        <div style={{ fontSize: '14px', color: 'var(--slate-600)' }}>People support change when they helped design it</div>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </section>
          
          {/* Use Case Section */}
          <section id="use-cases" className="section section-alt">
            <div className="container">
              <div style={{ display: 'flex', gap: '80px', alignItems: 'center', flexWrap: 'wrap' }}>
                <div style={{ flex: '1 1 440px' }}>
                  <div style={{ 
                    padding: '10px 18px', 
                    background: 'var(--amber-100)', 
                    borderRadius: '24px', 
                    display: 'inline-block',
                    marginBottom: '24px',
                    fontSize: '13px',
                    color: 'var(--amber-700)',
                    fontWeight: 600,
                    letterSpacing: '0.5px'
                  }}>
                    BUILT FOR FINANCIAL SERVICES
                  </div>
                  <h2 style={{ fontSize: '36px', fontWeight: 300, marginBottom: '24px', color: 'var(--navy-700)', lineHeight: 1.25 }}>
                    Client onboarding is expensive. <br/>Now you can see exactly where.
                  </h2>
                  <p style={{ color: 'var(--slate-600)', fontSize: '17px', marginBottom: '20px', lineHeight: 1.8 }}>
                    UK Financial Services firms spend thousands onboarding each client. Multiple handoffs, compliance checks, data re-entry, and manual processes add up ‚Äî but until now, the true cost was invisible.
                  </p>
                  <p style={{ color: 'var(--slate-600)', fontSize: '17px', marginBottom: '32px', lineHeight: 1.8 }}>
                    Fathom was designed for exactly this challenge. Map your onboarding journey once, and see the cost of every step, every role, every drop-off. Make your business case with real numbers.
                  </p>
                  <button onClick={onGetStarted} className="btn btn-primary">
                    Start Mapping Your Journey
                  </button>
                </div>
                <div style={{ flex: '1 1 400px' }}>
                  <div style={{ 
                    background: 'linear-gradient(145deg, var(--navy-700) 0%, var(--navy-900) 100%)',
                    borderRadius: '20px',
                    padding: '44px',
                    color: '#FFF',
                    boxShadow: '0 24px 48px rgba(12, 22, 32, 0.3)'
                  }}>
                    <div style={{ fontSize: '12px', opacity: 0.6, marginBottom: '32px', textTransform: 'uppercase', letterSpacing: '1.5px', fontWeight: 600 }}>
                      Example Insight Report
                    </div>
                    <div style={{ fontSize: '52px', fontWeight: 300, marginBottom: '8px', letterSpacing: '-1px' }}>¬£2,847</div>
                    <div style={{ fontSize: '16px', opacity: 0.7, marginBottom: '40px' }}>Average cost per client onboarded</div>
                    
                    <div style={{ display: 'grid', gridTemplateColumns: '1fr 1fr', gap: '32px' }}>
                      <div>
                        <div style={{ fontSize: '28px', fontWeight: 600, color: 'var(--error)' }}>¬£892</div>
                        <div style={{ fontSize: '13px', opacity: 0.6, marginTop: '4px' }}>Wasted on drop-offs</div>
                      </div>
                      <div>
                        <div style={{ fontSize: '28px', fontWeight: 600, color: 'var(--amber-500)' }}>38%</div>
                        <div style={{ fontSize: '13px', opacity: 0.6, marginTop: '4px' }}>Automation potential</div>
                      </div>
                      <div>
                        <div style={{ fontSize: '28px', fontWeight: 600, color: 'var(--steel-400)' }}>4.2hrs</div>
                        <div style={{ fontSize: '13px', opacity: 0.6, marginTop: '4px' }}>Compliance time</div>
                      </div>
                      <div>
                        <div style={{ fontSize: '28px', fontWeight: 600, color: 'var(--success)' }}>¬£156k</div>
                        <div style={{ fontSize: '13px', opacity: 0.6, marginTop: '4px' }}>Potential annual saving</div>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </section>
          
          {/* CTA Section */}
          <section className="cta-section">
            <div className="container" style={{ textAlign: 'center' }}>
              <h2 style={{ fontSize: '42px', fontWeight: 300, color: '#FFF', marginBottom: '20px', letterSpacing: '-0.5px' }}>
                Ready to see what your journeys really cost?
              </h2>
              <p style={{ fontSize: '18px', color: 'var(--slate-300)', marginBottom: '40px', maxWidth: '480px', margin: '0 auto 40px' }}>
                Start mapping in minutes. No credit card required. Free to use.
              </p>
              <button onClick={onGetStarted} className="btn" style={{ background: '#FFF', color: 'var(--navy-700)', padding: '18px 48px', fontSize: '16px', fontWeight: 600 }}>
                Get Started Free ‚Üí
              </button>
            </div>
          </section>
          
          {/* Footer */}
          <footer style={{ background: 'var(--navy-950)', padding: '48px 24px', color: 'var(--slate-400)' }}>
            <div className="container" style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', flexWrap: 'wrap', gap: '24px' }}>
              <div style={{ display: 'flex', alignItems: 'center', gap: '12px' }}>
                <img src="logo_light.png" alt="FATHOM" style={{ height: '24px', opacity: 0.6 }} />
                <span style={{ fontSize: '11px', opacity: 0.4 }}>v{APP_VERSION}</span>
              </div>
              <div style={{ fontSize: '13px', opacity: 0.6 }}>
                ¬© 2025 Fathom ¬∑ Journey intelligence for modern operations
              </div>
            </div>
          </footer>
        </div>
      );
    }
    
    // ============================================
    // LOGIN MODAL
    // ============================================
    function LoginModal({ onClose, onLogin }) {
      const [name, setName] = useState('');
      const [email, setEmail] = useState('');
      const [token, setToken] = useState('');
      const [error, setError] = useState('');
      const [isLoading, setIsLoading] = useState(false);

      const handleSubmit = async (e) => {
        e.preventDefault();
        if (!name.trim() || !email.trim()) {
          setError('Please enter your name and email');
          return;
        }
        if (!email.includes('@')) {
          setError('Please enter a valid email');
          return;
        }
        setIsLoading(true);
        await onLogin({ name: name.trim(), email: email.trim().toLowerCase() }, token.trim());
        setIsLoading(false);
      };

      return (
        <div className="modal-overlay" onClick={onClose}>
          <div className="modal" onClick={e => e.stopPropagation()}>
            <div style={{ padding: '36px' }}>
              <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: '28px' }}>
                <img src="logo_dark.png" alt="FATHOM" style={{ height: '32px' }} />
                <button onClick={onClose} style={{ background: 'none', border: 'none', fontSize: '28px', color: 'var(--slate-400)', cursor: 'pointer', padding: '4px', lineHeight: 1 }}>√ó</button>
              </div>
              
              <h2 style={{ fontSize: '26px', fontWeight: 400, marginBottom: '8px', color: 'var(--navy-700)' }}>Welcome to Fathom</h2>
              <p className="text-muted" style={{ marginBottom: '28px', fontSize: '15px' }}>Enter your details to access your journey maps</p>

              {error && (
                <div style={{ padding: '14px 16px', background: 'var(--error-light)', borderRadius: '10px', marginBottom: '20px', color: 'var(--error)', fontSize: '14px' }}>
                  {error}
                </div>
              )}

              <form onSubmit={handleSubmit}>
                <div style={{ marginBottom: '18px' }}>
                  <label className="label">Your Name</label>
                  <input
                    type="text"
                    className="input"
                    value={name}
                    onChange={(e) => setName(e.target.value)}
                    placeholder="Steve Young"
                    autoFocus
                  />
                </div>

                <div style={{ marginBottom: '18px' }}>
                  <label className="label">Email Address</label>
                  <input
                    type="email"
                    className="input"
                    value={email}
                    onChange={(e) => setEmail(e.target.value)}
                    placeholder="steve@company.com"
                  />
                </div>

                <div style={{ marginBottom: '28px' }}>
                  <label className="label">GitHub Token <span style={{ fontWeight: 400, color: 'var(--slate-400)' }}>(optional)</span></label>
                  <input
                    type="password"
                    className="input"
                    value={token}
                    onChange={(e) => setToken(e.target.value)}
                    placeholder="ghp_xxxxxxxxxxxx"
                  />
                  <p className="text-muted text-small" style={{ marginTop: '8px' }}>
                    Required to create and edit maps. Without it, you can view existing maps only.
                  </p>
                </div>

                <button type="submit" className="btn btn-primary" style={{ width: '100%', padding: '16px' }} disabled={isLoading}>
                  {isLoading ? 'Signing in...' : 'Sign In to Fathom'}
                </button>
              </form>
            </div>
          </div>
        </div>
      );
    }
    
    // ============================================
    // DASHBOARD
    // ============================================
    function Dashboard({ user, token, onLogout, onUpdateToken }) {
      const [maps, setMaps] = useState([]);
      const [mapConfigs, setMapConfigs] = useState({}); // Store full configs for metrics
      const [loading, setLoading] = useState(true);
      const [error, setError] = useState('');
      const [showCreateModal, setShowCreateModal] = useState(false);
      const [showDeleteModal, setShowDeleteModal] = useState(null);
      const [showShareModal, setShowShareModal] = useState(null);
      const [showTokenModal, setShowTokenModal] = useState(false);
      const [activeTab, setActiveTab] = useState('my-maps');
      const [viewMode, setViewMode] = useState(() => localStorage.getItem('fathom-view-mode') || 'grid');
      const [manageMode, setManageMode] = useState(false);
      const [selectedMaps, setSelectedMaps] = useState(new Set());

      // Persist view mode
      useEffect(() => {
        localStorage.setItem('fathom-view-mode', viewMode);
      }, [viewMode]);

      useEffect(() => {
        fetchMaps();
      }, []);

      // Fetch full configs for metrics after maps are loaded
      useEffect(() => {
        if (maps.length > 0) {
          fetchMapConfigs();
        }
      }, [maps]);

      const fetchMaps = async () => {
        setLoading(true);
        setError('');
        try {
          const index = await fetchFromGitHub(GITHUB_CONFIG.indexFile);
          if (index && index.maps) {
            setMaps(index.maps);
          } else {
            setMaps([]);
          }
        } catch (err) {
          console.error('Failed to fetch maps:', err);
          setError('Failed to load maps. Please refresh.');
        }
        setLoading(false);
      };

      const fetchMapConfigs = async () => {
        const configs = {};
        for (const map of maps) {
          try {
            const config = await fetchFromGitHub(`${GITHUB_CONFIG.mapsPath}/${map.id}.json`);
            if (config) {
              configs[map.id] = config;
            }
          } catch (err) {
            console.warn(`Failed to fetch config for ${map.id}:`, err);
          }
        }
        setMapConfigs(configs);
      };

      // Calculate metrics from config
      const getMapMetrics = (mapId) => {
        const config = mapConfigs[mapId];
        if (!config || !config.stages) return null;
        
        const allSteps = config.stages.flatMap(s => s.steps || []);
        const totalTime = allSteps.reduce((acc, s) => acc + (s.timeMinutes || 0), 0);
        const totalSteps = allSteps.length;
        const totalPainPoints = allSteps.reduce((acc, s) => acc + (s.painPoints?.length || 0), 0);
        const highImprovements = allSteps.filter(s => s.automationOpportunity === 'high').length;
        const totalRegReqs = allSteps.reduce((acc, s) => acc + (s.regulatoryRequirements?.length || 0), 0);
        
        // Calculate average friction
        const stepsWithFriction = allSteps.filter(s => s.frictionScore);
        const avgFriction = stepsWithFriction.length > 0 
          ? (stepsWithFriction.reduce((acc, s) => acc + s.frictionScore, 0) / stepsWithFriction.length).toFixed(1)
          : null;
        
        // Calculate total cost if personas exist with salaries
        let totalCost = 0;
        let hasCostData = false;
        if (config.personas && config.personas.length > 0) {
          allSteps.forEach(step => {
            const persona = config.personas.find(p => p.id === step.owner);
            if (persona && persona.salary > 0) {
              hasCostData = true;
              const hourlyRate = (persona.salary * (persona.burdenMultiplier || 1.4)) / (52 * (persona.hoursPerWeek || 37.5));
              const stepCost = ((step.timeMinutes || 0) / 60) * hourlyRate + (step.additionalCosts || 0);
              totalCost += stepCost;
            }
          });
        }
        
        return {
          totalTime,
          totalSteps,
          stageCount: config.stages.length,
          totalPainPoints,
          highImprovements,
          totalRegReqs,
          avgFriction,
          totalCost: hasCostData ? totalCost : null
        };
      };

      // Format time helper
      const formatTime = (minutes) => {
        if (!minutes) return '0m';
        const hrs = Math.floor(minutes / 60);
        const mins = minutes % 60;
        if (hrs === 0) return `${mins}m`;
        if (mins === 0) return `${hrs}h`;
        return `${hrs}h ${mins}m`;
      };

      // Format currency helper
      const formatCurrency = (amount) => {
        if (!amount) return null;
        return new Intl.NumberFormat('en-GB', { style: 'currency', currency: 'GBP', minimumFractionDigits: 0, maximumFractionDigits: 0 }).format(amount);
      };

      const myMaps = maps.filter(m => m.owner === user.email).sort((a, b) => {
        // Favourites first, then by updated date
        if (a.favourite && !b.favourite) return -1;
        if (!a.favourite && b.favourite) return 1;
        return new Date(b.updatedAt) - new Date(a.updatedAt);
      });
      const sharedMaps = maps.filter(m => 
        m.owner !== user.email && 
        m.sharedWith?.some(s => s.email === user.email)
      );

      const handleCreate = async (newMap) => {
        try {
          console.log('Creating map:', newMap.title);
          
          // Separate metadata from config
          const { config, ...mapMetadata } = newMap;
          
          // Add to maps array (metadata only for index)
          const updatedMaps = [...maps, mapMetadata];
          
          // Save metadata to index
          const indexResult = await saveToGitHub(
            GITHUB_CONFIG.indexFile,
            { maps: updatedMaps },
            token,
            `Add map: ${newMap.title}`
          );
          console.log('Index updated:', indexResult);
          
          // Save full config to separate file
          const mapResult = await saveToGitHub(
            `${GITHUB_CONFIG.mapsPath}/${newMap.id}.json`,
            config,
            token,
            `Create map: ${newMap.title}`
          );
          console.log('Map created:', mapResult);
          
          setMaps(updatedMaps);
          setShowCreateModal(false);
          
          // Show success message
          alert(`Map "${newMap.title}" created successfully!`);
        } catch (err) {
          console.error('Failed to create map:', err);
          alert(`Failed to create map: ${err.message}\n\nCheck your GitHub token has write permissions.`);
        }
      };

      const handleDelete = async (mapId) => {
        const mapToDelete = maps.find(m => m.id === mapId);
        if (!mapToDelete) return;
        
        // Check if locked
        if (mapToDelete.locked) {
          alert('This map is locked. Unlock it first to delete.');
          setShowDeleteModal(null);
          return;
        }
        
        try {
          await deleteFromGitHub(
            `${GITHUB_CONFIG.mapsPath}/${mapId}.json`,
            token,
            `Delete map: ${mapToDelete.title}`
          );
          
          const updatedMaps = maps.filter(m => m.id !== mapId);
          await saveToGitHub(
            GITHUB_CONFIG.indexFile,
            { maps: updatedMaps },
            token,
            `Remove map from index: ${mapToDelete.title}`
          );
          
          setMaps(updatedMaps);
          setShowDeleteModal(null);
          setSelectedMaps(prev => { const next = new Set(prev); next.delete(mapId); return next; });
        } catch (err) {
          console.error('Failed to delete:', err);
          alert('Failed to delete map.');
        }
      };

      const toggleFavourite = async (mapId) => {
        const map = maps.find(m => m.id === mapId);
        if (!map || map.owner !== user.email) return;
        
        const updatedMaps = maps.map(m => 
          m.id === mapId ? { ...m, favourite: !m.favourite } : m
        );
        
        try {
          await saveToGitHub(
            GITHUB_CONFIG.indexFile,
            { maps: updatedMaps },
            token,
            `Toggle favourite: ${map.title}`
          );
          setMaps(updatedMaps);
        } catch (err) {
          console.error('Failed to update favourite:', err);
        }
      };

      const toggleLock = async (mapId) => {
        const map = maps.find(m => m.id === mapId);
        if (!map || map.owner !== user.email) return;
        
        const updatedMaps = maps.map(m => 
          m.id === mapId ? { ...m, locked: !m.locked } : m
        );
        
        try {
          await saveToGitHub(
            GITHUB_CONFIG.indexFile,
            { maps: updatedMaps },
            token,
            `Toggle lock: ${map.title}`
          );
          setMaps(updatedMaps);
        } catch (err) {
          console.error('Failed to update lock:', err);
        }
      };

      const handleShare = async (mapId, shareEmail, permission) => {
        const map = maps.find(m => m.id === mapId);
        if (!map || map.owner !== user.email) return;
        
        const currentShares = map.sharedWith || [];
        const existingIndex = currentShares.findIndex(s => s.email === shareEmail);
        
        let newShares;
        if (existingIndex >= 0) {
          // Update existing share
          newShares = currentShares.map((s, i) => 
            i === existingIndex ? { ...s, permission } : s
          );
        } else {
          // Add new share
          newShares = [...currentShares, { email: shareEmail, permission }];
        }
        
        const updatedMaps = maps.map(m => 
          m.id === mapId ? { ...m, sharedWith: newShares } : m
        );
        
        try {
          await saveToGitHub(
            GITHUB_CONFIG.indexFile,
            { maps: updatedMaps },
            token,
            `Share map: ${map.title} with ${shareEmail}`
          );
          setMaps(updatedMaps);
          return true;
        } catch (err) {
          console.error('Failed to share:', err);
          return false;
        }
      };

      const removeShare = async (mapId, shareEmail) => {
        const map = maps.find(m => m.id === mapId);
        if (!map || map.owner !== user.email) return;
        
        const newShares = (map.sharedWith || []).filter(s => s.email !== shareEmail);
        
        const updatedMaps = maps.map(m => 
          m.id === mapId ? { ...m, sharedWith: newShares } : m
        );
        
        try {
          await saveToGitHub(
            GITHUB_CONFIG.indexFile,
            { maps: updatedMaps },
            token,
            `Remove share: ${map.title} from ${shareEmail}`
          );
          setMaps(updatedMaps);
        } catch (err) {
          console.error('Failed to remove share:', err);
        }
      };

      const handleBulkDelete = async () => {
        const toDelete = [...selectedMaps];
        const locked = toDelete.filter(id => maps.find(m => m.id === id)?.locked);
        
        if (locked.length > 0) {
          alert(`${locked.length} map(s) are locked and cannot be deleted. Unlock them first.`);
          return;
        }
        
        if (!confirm(`Delete ${toDelete.length} map(s)? This cannot be undone.`)) return;
        
        for (const mapId of toDelete) {
          await handleDelete(mapId);
        }
        setSelectedMaps(new Set());
        setManageMode(false);
      };

      const openMap = (mapId) => {
        if (manageMode) return; // Don't navigate in manage mode
        window.location.href = `editor.html?map=${mapId}`;
      };

      const toggleSelectMap = (mapId) => {
        setSelectedMaps(prev => {
          const next = new Set(prev);
          if (next.has(mapId)) {
            next.delete(mapId);
          } else {
            next.add(mapId);
          }
          return next;
        });
      };

      const getPermission = (map) => {
        if (map.owner === user.email) return 'owner';
        const share = map.sharedWith?.find(s => s.email === user.email);
        return share?.permission || 'view';
      };

      return (
        <div className="dashboard-bg">
          {/* Header */}
          <header style={{ 
            background: 'var(--navy-700)', 
            color: '#FFF', 
            padding: '16px 40px',
            display: 'flex',
            justifyContent: 'space-between',
            alignItems: 'center'
          }}>
            <div style={{ display: 'flex', alignItems: 'center', gap: '12px' }}>
              <img src="logo_light.png" alt="FATHOM" style={{ height: '28px' }} />
              <span style={{ fontSize: '11px', opacity: 0.4 }}>v{APP_VERSION}</span>
            </div>
            <div style={{ display: 'flex', alignItems: 'center', gap: '20px' }}>
              <span style={{ fontSize: '14px', opacity: 0.8 }}>{user.name}</span>
              <button onClick={onLogout} className="btn btn-ghost" style={{ color: 'rgba(255,255,255,0.7)', padding: '8px 16px' }}>
                Sign Out
              </button>
            </div>
          </header>

          {/* Main Content */}
          <main style={{ padding: '48px 40px', maxWidth: '1200px', margin: '0 auto' }}>
            <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: '36px' }}>
              <div>
                <h1 style={{ fontSize: '32px', fontWeight: 400, marginBottom: '6px', color: 'var(--navy-700)' }}>Your Journey Maps</h1>
                <p className="text-muted">Create, manage, and share operational journey maps</p>
              </div>
              <button 
                onClick={() => token ? setShowCreateModal(true) : setShowTokenModal(true)} 
                className="btn btn-primary"
              >
                + New Map
              </button>
            </div>

            {/* Tabs + View Toggle + Manage */}
            <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: manageMode ? '12px' : '28px', borderBottom: '1px solid var(--slate-200)', paddingBottom: '8px' }}>
              <div style={{ display: 'flex', gap: '8px', alignItems: 'center' }}>
                <button 
                  onClick={() => setActiveTab('my-maps')}
                  style={{ 
                    padding: '10px 20px', 
                    background: activeTab === 'my-maps' ? 'var(--navy-700)' : 'transparent',
                    color: activeTab === 'my-maps' ? '#FFF' : 'var(--slate-600)',
                    border: 'none',
                    borderRadius: '6px',
                    cursor: 'pointer',
                    fontFamily: 'inherit',
                    fontSize: '14px',
                    fontWeight: 500
                  }}
                >
                  My Maps ({myMaps.length})
                </button>
                <button 
                  onClick={() => setActiveTab('shared')}
                  style={{ 
                    padding: '10px 20px', 
                    background: activeTab === 'shared' ? 'var(--navy-700)' : 'transparent',
                    color: activeTab === 'shared' ? '#FFF' : 'var(--slate-600)',
                    border: 'none',
                    borderRadius: '6px',
                    cursor: 'pointer',
                    fontFamily: 'inherit',
                    fontSize: '14px',
                    fontWeight: 500
                  }}
                >
                  Shared with Me ({sharedMaps.length})
                </button>
              </div>
              
              <div style={{ display: 'flex', gap: '12px', alignItems: 'center' }}>
                {/* Manage Toggle - only for My Maps */}
                {activeTab === 'my-maps' && token && (
                  <button
                    onClick={() => { setManageMode(!manageMode); setSelectedMaps(new Set()); }}
                    style={{
                      padding: '8px 14px',
                      background: manageMode ? 'var(--amber-500)' : 'transparent',
                      color: manageMode ? '#FFF' : 'var(--slate-500)',
                      border: manageMode ? 'none' : '1px solid var(--slate-200)',
                      borderRadius: '6px',
                      cursor: 'pointer',
                      fontFamily: 'inherit',
                      fontSize: '13px',
                      fontWeight: 500,
                      display: 'flex',
                      alignItems: 'center',
                      gap: '6px'
                    }}
                  >
                    {manageMode ? '‚úì Done' : '‚öôÔ∏è Manage'}
                  </button>
                )}
                
                {/* View Toggle */}
                <div style={{ display: 'flex', gap: '4px', border: '1px solid var(--slate-200)', borderRadius: '6px', padding: '2px' }}>
                  <button
                    onClick={() => setViewMode('grid')}
                    title="Grid view"
                    style={{
                      padding: '6px 10px',
                      background: viewMode === 'grid' ? 'var(--navy-700)' : 'transparent',
                      color: viewMode === 'grid' ? '#FFF' : 'var(--slate-500)',
                      border: 'none',
                      borderRadius: '4px',
                      cursor: 'pointer',
                    fontSize: '14px'
                  }}
                >
                  ‚ñ¶
                </button>
                <button
                  onClick={() => setViewMode('list')}
                  title="List view"
                  style={{
                    padding: '6px 10px',
                    background: viewMode === 'list' ? 'var(--navy-700)' : 'transparent',
                    color: viewMode === 'list' ? '#FFF' : 'var(--slate-500)',
                    border: 'none',
                    borderRadius: '4px',
                    cursor: 'pointer',
                    fontSize: '14px'
                  }}
                >
                  ‚ò∞
                </button>
              </div>
              </div>
            </div>

            {/* Bulk Action Bar - when in manage mode */}
            {manageMode && (
              <div style={{ 
                display: 'flex', 
                justifyContent: 'space-between', 
                alignItems: 'center',
                padding: '12px 20px',
                background: 'var(--amber-50)',
                borderRadius: '8px',
                marginBottom: '20px',
                border: '1px solid var(--amber-200)'
              }}>
                <div style={{ display: 'flex', alignItems: 'center', gap: '12px' }}>
                  <span style={{ fontSize: '13px', color: 'var(--amber-700)', fontWeight: 500 }}>
                    {selectedMaps.size} selected
                  </span>
                  {selectedMaps.size > 0 && (
                    <button
                      onClick={() => setSelectedMaps(new Set())}
                      style={{
                        padding: '4px 10px',
                        background: 'transparent',
                        color: 'var(--slate-500)',
                        border: '1px solid var(--slate-300)',
                        borderRadius: '4px',
                        cursor: 'pointer',
                        fontSize: '12px'
                      }}
                    >
                      Clear
                    </button>
                  )}
                </div>
                <div style={{ display: 'flex', gap: '8px' }}>
                  {selectedMaps.size > 0 && (
                    <button
                      onClick={handleBulkDelete}
                      style={{
                        padding: '8px 14px',
                        background: 'var(--error)',
                        color: '#FFF',
                        border: 'none',
                        borderRadius: '6px',
                        cursor: 'pointer',
                        fontSize: '13px',
                        fontWeight: 500
                      }}
                    >
                      üóëÔ∏è Delete Selected
                    </button>
                  )}
                </div>
              </div>
            )}

            {/* Loading / Error / Maps */}
            {loading ? (
              <div style={{ textAlign: 'center', padding: '80px', color: 'var(--slate-500)' }}>
                Loading maps...
              </div>
            ) : error ? (
              <div style={{ textAlign: 'center', padding: '80px', color: 'var(--error)' }}>
                {error}
              </div>
            ) : viewMode === 'grid' ? (
              /* Grid View */
              <div style={{ display: 'grid', gridTemplateColumns: 'repeat(auto-fill, minmax(340px, 1fr))', gap: '24px' }}>
                {(activeTab === 'my-maps' ? myMaps : sharedMaps).map(map => {
                  const metrics = getMapMetrics(map.id);
                  const isSelected = selectedMaps.has(map.id);
                  const isOwner = map.owner === user.email;
                  return (
                  <div 
                    key={map.id} 
                    className="card" 
                    style={{ 
                      padding: '24px', 
                      cursor: manageMode ? 'default' : 'pointer', 
                      transition: 'all 0.2s',
                      border: isSelected ? '2px solid var(--amber-500)' : '1px solid var(--slate-200)',
                      position: 'relative'
                    }} 
                    onClick={() => manageMode ? (isOwner && toggleSelectMap(map.id)) : openMap(map.id)}
                  >
                    {/* Status Indicators */}
                    <div style={{ position: 'absolute', top: '12px', right: '12px', display: 'flex', gap: '6px' }}>
                      {map.favourite && <span title="Favourite" style={{ fontSize: '16px' }}>‚≠ê</span>}
                      {map.locked && <span title="Locked" style={{ fontSize: '16px' }}>üîí</span>}
                    </div>
                    
                    {/* Manage Mode Checkbox */}
                    {manageMode && isOwner && (
                      <div 
                        style={{ 
                          position: 'absolute', 
                          top: '12px', 
                          left: '12px',
                          width: '24px',
                          height: '24px',
                          borderRadius: '6px',
                          border: isSelected ? '2px solid var(--amber-500)' : '2px solid var(--slate-300)',
                          background: isSelected ? 'var(--amber-500)' : '#FFF',
                          display: 'flex',
                          alignItems: 'center',
                          justifyContent: 'center',
                          cursor: 'pointer',
                          color: '#FFF',
                          fontSize: '14px',
                          fontWeight: 'bold'
                        }}
                      >
                        {isSelected && '‚úì'}
                      </div>
                    )}
                    
                    <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'flex-start', marginBottom: '10px', paddingLeft: manageMode && isOwner ? '32px' : 0 }}>
                      <h3 style={{ fontSize: '18px', fontWeight: 600, color: 'var(--navy-700)', lineHeight: 1.3, paddingRight: (map.favourite || map.locked) ? '50px' : 0 }}>{map.title}</h3>
                      {activeTab === 'shared' && (
                        <span className={`badge badge-${getPermission(map)}`} style={{ marginRight: (map.favourite || map.locked) ? '40px' : 0 }}>{getPermission(map)}</span>
                      )}
                    </div>
                    <p className="text-muted" style={{ marginBottom: '16px', fontSize: '13px', lineHeight: 1.5 }}>
                      {map.description || 'No description'}
                    </p>
                    
                    {/* Metrics Row */}
                    {metrics ? (
                      <div style={{ 
                        display: 'flex', 
                        flexWrap: 'wrap',
                        gap: '8px', 
                        marginBottom: '16px',
                        padding: '12px',
                        background: 'var(--slate-50)',
                        borderRadius: '8px'
                      }}>
                        <div style={{ display: 'flex', alignItems: 'center', gap: '4px' }} title="Total time">
                          <span style={{ fontSize: '12px' }}>‚è±Ô∏è</span>
                          <span style={{ fontSize: '12px', fontWeight: 600, color: 'var(--navy-700)' }}>{formatTime(metrics.totalTime)}</span>
                        </div>
                        <span style={{ color: 'var(--slate-300)' }}>¬∑</span>
                        <div style={{ display: 'flex', alignItems: 'center', gap: '4px' }} title={`${metrics.stageCount} stages, ${metrics.totalSteps} steps`}>
                          <span style={{ fontSize: '12px' }}>üìã</span>
                          <span style={{ fontSize: '12px', color: 'var(--slate-600)' }}>{metrics.stageCount} / {metrics.totalSteps}</span>
                        </div>
                        {metrics.avgFriction && (
                          <>
                            <span style={{ color: 'var(--slate-300)' }}>¬∑</span>
                            <div style={{ display: 'flex', alignItems: 'center', gap: '4px' }} title="Average friction">
                              <span style={{ fontSize: '12px' }}>{metrics.avgFriction >= 4 ? 'üò∞' : metrics.avgFriction >= 3 ? 'üòê' : 'üôÇ'}</span>
                              <span style={{ fontSize: '12px', color: metrics.avgFriction >= 4 ? 'var(--error)' : 'var(--slate-600)' }}>{metrics.avgFriction}/5</span>
                            </div>
                          </>
                        )}
                        {metrics.totalPainPoints > 0 && (
                          <>
                            <span style={{ color: 'var(--slate-300)' }}>¬∑</span>
                            <div style={{ display: 'flex', alignItems: 'center', gap: '4px' }} title={`${metrics.totalPainPoints} pain points`}>
                              <span style={{ fontSize: '12px' }}>‚ö†Ô∏è</span>
                              <span style={{ fontSize: '12px', color: 'var(--error)' }}>{metrics.totalPainPoints}</span>
                            </div>
                          </>
                        )}
                        {metrics.highImprovements > 0 && (
                          <>
                            <span style={{ color: 'var(--slate-300)' }}>¬∑</span>
                            <div style={{ display: 'flex', alignItems: 'center', gap: '4px' }} title={`${metrics.highImprovements} high improvement opportunities`}>
                              <span style={{ fontSize: '12px' }}>üéØ</span>
                              <span style={{ fontSize: '12px', color: 'var(--success)' }}>{metrics.highImprovements}</span>
                            </div>
                          </>
                        )}
                        {metrics.totalCost !== null && (
                          <>
                            <span style={{ color: 'var(--slate-300)' }}>¬∑</span>
                            <div style={{ display: 'flex', alignItems: 'center', gap: '4px' }} title="Total cost per journey">
                              <span style={{ fontSize: '12px' }}>üí∑</span>
                              <span style={{ fontSize: '12px', fontWeight: 600, color: 'var(--navy-700)' }}>{formatCurrency(metrics.totalCost)}</span>
                            </div>
                          </>
                        )}
                      </div>
                    ) : (
                      <div style={{ 
                        height: '44px',
                        marginBottom: '16px',
                        padding: '12px',
                        background: 'var(--slate-50)',
                        borderRadius: '8px',
                        display: 'flex',
                        alignItems: 'center',
                        justifyContent: 'center'
                      }}>
                        <span style={{ fontSize: '12px', color: 'var(--slate-400)' }}>Loading metrics...</span>
                      </div>
                    )}
                    
                    {/* Footer */}
                    <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center' }}>
                      <span className="text-muted text-small">
                        Updated {formatDate(map.updatedAt)}
                        {map.sharedWith?.length > 0 && <span title={`Shared with ${map.sharedWith.length} people`}> ¬∑ üë• {map.sharedWith.length}</span>}
                      </span>
                      
                      {/* Normal Mode Actions */}
                      {!manageMode && isOwner && (
                        <button 
                          onClick={(e) => { e.stopPropagation(); setShowShareModal(map.id); }}
                          className="btn btn-ghost"
                          style={{ padding: '6px 12px', color: 'var(--steel-500)', fontSize: '13px' }}
                        >
                          Share
                        </button>
                      )}
                      
                      {/* Manage Mode Actions */}
                      {manageMode && isOwner && (
                        <div style={{ display: 'flex', gap: '6px' }} onClick={e => e.stopPropagation()}>
                          <button
                            onClick={() => toggleFavourite(map.id)}
                            title={map.favourite ? 'Remove favourite' : 'Add favourite'}
                            style={{
                              padding: '6px 10px',
                              background: map.favourite ? 'var(--amber-100)' : 'transparent',
                              border: '1px solid var(--slate-200)',
                              borderRadius: '4px',
                              cursor: 'pointer',
                              fontSize: '14px'
                            }}
                          >
                            {map.favourite ? '‚≠ê' : '‚òÜ'}
                          </button>
                          <button
                            onClick={() => toggleLock(map.id)}
                            title={map.locked ? 'Unlock map' : 'Lock map'}
                            style={{
                              padding: '6px 10px',
                              background: map.locked ? 'var(--slate-200)' : 'transparent',
                              border: '1px solid var(--slate-200)',
                              borderRadius: '4px',
                              cursor: 'pointer',
                              fontSize: '14px'
                            }}
                          >
                            {map.locked ? 'üîí' : 'üîì'}
                          </button>
                          <button
                            onClick={() => setShowShareModal(map.id)}
                            title="Share map"
                            style={{
                              padding: '6px 10px',
                              background: 'transparent',
                              border: '1px solid var(--slate-200)',
                              borderRadius: '4px',
                              cursor: 'pointer',
                              fontSize: '14px'
                            }}
                          >
                            üë•
                          </button>
                          <button
                            onClick={() => !map.locked && setShowDeleteModal(map.id)}
                            title={map.locked ? 'Unlock to delete' : 'Delete map'}
                            style={{
                              padding: '6px 10px',
                              background: 'transparent',
                              border: '1px solid var(--slate-200)',
                              borderRadius: '4px',
                              cursor: map.locked ? 'not-allowed' : 'pointer',
                              fontSize: '14px',
                              opacity: map.locked ? 0.4 : 1
                            }}
                          >
                            üóëÔ∏è
                          </button>
                        </div>
                      )}
                    </div>
                  </div>
                  );
                })}
                {(activeTab === 'my-maps' ? myMaps : sharedMaps).length === 0 && (
                  <div style={{ gridColumn: '1 / -1', textAlign: 'center', padding: '80px', color: 'var(--slate-500)' }}>
                    {activeTab === 'my-maps' ? 'No maps yet. Create your first one!' : 'No maps shared with you yet.'}
                  </div>
                )}
              </div>
            ) : (
              /* List View */
              <div style={{ display: 'flex', flexDirection: 'column', gap: '8px', overflowX: 'auto' }}>
                {/* List Header */}
                <div style={{ 
                  display: 'grid', 
                  gridTemplateColumns: manageMode ? '40px 2.5fr 70px 70px 60px 60px 60px 80px 90px 140px' : '2.5fr 70px 70px 60px 60px 60px 80px 90px 100px',
                  gap: '12px',
                  padding: '12px 16px',
                  background: 'var(--slate-100)',
                  borderRadius: '8px',
                  fontSize: '10px',
                  fontWeight: 600,
                  color: 'var(--slate-500)',
                  textTransform: 'uppercase',
                  letterSpacing: '0.5px',
                  minWidth: manageMode ? '950px' : '850px',
                  alignItems: 'center'
                }}>
                  {manageMode && <div></div>}
                  <div>Journey</div>
                  <div style={{ textAlign: 'center' }}>Time</div>
                  <div style={{ textAlign: 'center' }}>Steps</div>
                  <div style={{ textAlign: 'center' }}>Friction</div>
                  <div style={{ textAlign: 'center' }}>Pain</div>
                  <div style={{ textAlign: 'center' }}>Opps</div>
                  <div style={{ textAlign: 'right' }}>Cost</div>
                  <div style={{ textAlign: 'right' }}>Updated</div>
                  <div style={{ textAlign: 'right' }}>Actions</div>
                </div>
                
                {/* List Rows */}
                {(activeTab === 'my-maps' ? myMaps : sharedMaps).map(map => {
                  const metrics = getMapMetrics(map.id);
                  const isSelected = selectedMaps.has(map.id);
                  const isOwner = map.owner === user.email;
                  return (
                    <div 
                      key={map.id} 
                      className="card"
                      onClick={() => manageMode ? (isOwner && toggleSelectMap(map.id)) : openMap(map.id)}
                      style={{ 
                        display: 'grid', 
                        gridTemplateColumns: manageMode ? '40px 2.5fr 70px 70px 60px 60px 60px 80px 90px 140px' : '2.5fr 70px 70px 60px 60px 60px 80px 90px 100px',
                        gap: '12px',
                        padding: '14px 16px',
                        cursor: manageMode ? (isOwner ? 'pointer' : 'default') : 'pointer',
                        alignItems: 'center',
                        transition: 'all 0.15s',
                        minWidth: manageMode ? '950px' : '850px',
                        border: isSelected ? '2px solid var(--amber-500)' : '1px solid var(--slate-200)'
                      }}
                    >
                      {/* Checkbox */}
                      {manageMode && (
                        <div style={{ display: 'flex', justifyContent: 'center' }}>
                          {isOwner && (
                            <div 
                              style={{ 
                                width: '22px',
                                height: '22px',
                                borderRadius: '5px',
                                border: isSelected ? '2px solid var(--amber-500)' : '2px solid var(--slate-300)',
                                background: isSelected ? 'var(--amber-500)' : '#FFF',
                                display: 'flex',
                                alignItems: 'center',
                                justifyContent: 'center',
                                color: '#FFF',
                                fontSize: '12px',
                                fontWeight: 'bold'
                              }}
                            >
                              {isSelected && '‚úì'}
                            </div>
                          )}
                        </div>
                      )}
                      
                      {/* Journey Title & Description */}
                      <div>
                        <div style={{ display: 'flex', alignItems: 'center', gap: '8px', marginBottom: '3px' }}>
                          <span style={{ fontWeight: 600, color: 'var(--navy-700)', fontSize: '14px' }}>{map.title}</span>
                          {map.favourite && <span title="Favourite" style={{ fontSize: '12px' }}>‚≠ê</span>}
                          {map.locked && <span title="Locked" style={{ fontSize: '12px' }}>üîí</span>}
                          {/* Only show badge in Shared with Me tab */}
                          {activeTab === 'shared' && (
                            <span className={`badge badge-${getPermission(map)}`} style={{ fontSize: '9px', padding: '2px 6px' }}>{getPermission(map)}</span>
                          )}
                        </div>
                        <div style={{ fontSize: '12px', color: 'var(--slate-500)', overflow: 'hidden', textOverflow: 'ellipsis', whiteSpace: 'nowrap' }}>
                          {map.description || 'No description'}
                        </div>
                      </div>
                      
                      {/* Metrics */}
                      <div style={{ textAlign: 'center', fontWeight: 600, fontSize: '12px', color: 'var(--navy-700)' }}>
                        {metrics ? formatTime(metrics.totalTime) : '...'}
                      </div>
                      <div style={{ textAlign: 'center', fontSize: '12px', color: 'var(--slate-600)' }}>
                        {metrics ? `${metrics.stageCount}/${metrics.totalSteps}` : '...'}
                      </div>
                      <div style={{ textAlign: 'center', fontSize: '12px', color: metrics?.avgFriction >= 4 ? 'var(--error)' : 'var(--slate-600)' }}>
                        {metrics?.avgFriction ? `${metrics.avgFriction}` : '‚Äî'}
                      </div>
                      <div style={{ textAlign: 'center', fontSize: '12px', color: metrics?.totalPainPoints > 0 ? 'var(--error)' : 'var(--slate-400)' }}>
                        {metrics?.totalPainPoints || '‚Äî'}
                      </div>
                      <div style={{ textAlign: 'center', fontSize: '12px', color: metrics?.highImprovements > 0 ? 'var(--success)' : 'var(--slate-400)' }}>
                        {metrics?.highImprovements || '‚Äî'}
                      </div>
                      <div style={{ textAlign: 'right', fontWeight: 600, fontSize: '12px', color: 'var(--navy-700)' }}>
                        {metrics && metrics.totalCost !== null ? formatCurrency(metrics.totalCost) : '‚Äî'}
                      </div>
                      <div style={{ textAlign: 'right', fontSize: '11px', color: 'var(--slate-500)' }}>
                        {formatDate(map.updatedAt)}
                      </div>
                      
                      {/* Actions */}
                      <div style={{ display: 'flex', gap: '4px', justifyContent: 'flex-end' }} onClick={e => e.stopPropagation()}>
                        {manageMode && isOwner ? (
                          <>
                            <button
                              onClick={() => toggleFavourite(map.id)}
                              title={map.favourite ? 'Remove favourite' : 'Add favourite'}
                              style={{
                                padding: '5px 8px',
                                background: map.favourite ? 'var(--amber-100)' : 'transparent',
                                border: '1px solid var(--slate-200)',
                                borderRadius: '4px',
                                cursor: 'pointer',
                                fontSize: '12px'
                              }}
                            >
                              {map.favourite ? '‚≠ê' : '‚òÜ'}
                            </button>
                            <button
                              onClick={() => toggleLock(map.id)}
                              title={map.locked ? 'Unlock' : 'Lock'}
                              style={{
                                padding: '5px 8px',
                                background: map.locked ? 'var(--slate-200)' : 'transparent',
                                border: '1px solid var(--slate-200)',
                                borderRadius: '4px',
                                cursor: 'pointer',
                                fontSize: '12px'
                              }}
                            >
                              {map.locked ? 'üîí' : 'üîì'}
                            </button>
                            <button
                              onClick={() => setShowShareModal(map.id)}
                              title="Share"
                              style={{
                                padding: '5px 8px',
                                background: 'transparent',
                                border: '1px solid var(--slate-200)',
                                borderRadius: '4px',
                                cursor: 'pointer',
                                fontSize: '12px'
                              }}
                            >
                              üë•
                            </button>
                            <button
                              onClick={() => !map.locked && setShowDeleteModal(map.id)}
                              title={map.locked ? 'Unlock to delete' : 'Delete'}
                              style={{
                                padding: '5px 8px',
                                background: 'transparent',
                                border: '1px solid var(--slate-200)',
                                borderRadius: '4px',
                                cursor: map.locked ? 'not-allowed' : 'pointer',
                                fontSize: '12px',
                                opacity: map.locked ? 0.4 : 1
                              }}
                            >
                              üóëÔ∏è
                            </button>
                          </>
                        ) : isOwner ? (
                          <button
                            onClick={() => setShowShareModal(map.id)}
                            style={{
                              padding: '5px 10px',
                              background: 'transparent',
                              border: '1px solid var(--slate-200)',
                              borderRadius: '4px',
                              cursor: 'pointer',
                              fontSize: '11px',
                              color: 'var(--steel-500)',
                              fontWeight: 500
                            }}
                          >
                            Share
                          </button>
                        ) : null}
                      </div>
                    </div>
                  );
                })}
                {(activeTab === 'my-maps' ? myMaps : sharedMaps).length === 0 && (
                  <div style={{ textAlign: 'center', padding: '80px', color: 'var(--slate-500)' }}>
                    {activeTab === 'my-maps' ? 'No maps yet. Create your first one!' : 'No maps shared with you yet.'}
                  </div>
                )}
              </div>
            )}
          </main>

          {/* Create Modal */}
          {showCreateModal && (
            <CreateMapModal 
              onClose={() => setShowCreateModal(false)} 
              onCreate={handleCreate}
              userEmail={user.email}
            />
          )}

          {/* Delete Confirmation */}
          {showDeleteModal && (
            <div className="modal-overlay" onClick={() => setShowDeleteModal(null)}>
              <div className="modal" onClick={e => e.stopPropagation()} style={{ maxWidth: '400px' }}>
                <div style={{ padding: '36px', textAlign: 'center' }}>
                  <div style={{ fontSize: '48px', marginBottom: '20px' }}>üóëÔ∏è</div>
                  <h3 style={{ marginBottom: '10px', fontSize: '20px' }}>Delete this map?</h3>
                  <p className="text-muted" style={{ marginBottom: '28px' }}>This action cannot be undone.</p>
                  <div style={{ display: 'flex', gap: '12px' }}>
                    <button onClick={() => setShowDeleteModal(null)} className="btn btn-secondary" style={{ flex: 1, padding: '12px' }}>
                      Cancel
                    </button>
                    <button onClick={() => handleDelete(showDeleteModal)} className="btn" style={{ flex: 1, padding: '12px', background: 'var(--error)', color: '#FFF' }}>
                      Delete
                    </button>
                  </div>
                </div>
              </div>
            </div>
          )}

          {/* Share Modal */}
          {showShareModal && (() => {
            const mapToShare = maps.find(m => m.id === showShareModal);
            if (!mapToShare) return null;
            
            const ShareModalContent = () => {
              const [shareEmail, setShareEmail] = React.useState('');
              const [sharePermission, setSharePermission] = React.useState('view');
              const [sharing, setSharing] = React.useState(false);
              
              const doShare = async () => {
                if (!shareEmail.trim() || !shareEmail.includes('@')) {
                  alert('Please enter a valid email address');
                  return;
                }
                setSharing(true);
                const success = await handleShare(showShareModal, shareEmail.trim(), sharePermission);
                setSharing(false);
                if (success) {
                  setShareEmail('');
                }
              };
              
              return (
                <div style={{ padding: '32px' }}>
                  <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: '24px' }}>
                    <h3 style={{ fontSize: '20px', margin: 0 }}>Share "{mapToShare.title}"</h3>
                    <button 
                      onClick={() => setShowShareModal(null)}
                      style={{ background: 'none', border: 'none', fontSize: '24px', cursor: 'pointer', color: 'var(--slate-400)' }}
                    >
                      √ó
                    </button>
                  </div>
                  
                  {/* Add new share */}
                  <div style={{ display: 'flex', gap: '8px', marginBottom: '24px' }}>
                    <input
                      type="email"
                      className="input"
                      placeholder="Enter email address"
                      value={shareEmail}
                      onChange={(e) => setShareEmail(e.target.value)}
                      style={{ flex: 1 }}
                      onKeyDown={(e) => e.key === 'Enter' && doShare()}
                    />
                    <select
                      className="input"
                      value={sharePermission}
                      onChange={(e) => setSharePermission(e.target.value)}
                      style={{ width: '100px' }}
                    >
                      <option value="view">View</option>
                      <option value="edit">Edit</option>
                    </select>
                    <button
                      onClick={doShare}
                      disabled={sharing}
                      className="btn btn-primary"
                      style={{ padding: '10px 16px' }}
                    >
                      {sharing ? '...' : 'Share'}
                    </button>
                  </div>
                  
                  {/* Current shares */}
                  <div>
                    <div style={{ fontSize: '12px', color: 'var(--slate-500)', textTransform: 'uppercase', letterSpacing: '0.5px', marginBottom: '12px' }}>
                      Shared with
                    </div>
                    {(!mapToShare.sharedWith || mapToShare.sharedWith.length === 0) ? (
                      <p className="text-muted" style={{ fontSize: '14px', fontStyle: 'italic' }}>
                        Not shared with anyone yet
                      </p>
                    ) : (
                      <div style={{ display: 'flex', flexDirection: 'column', gap: '8px' }}>
                        {mapToShare.sharedWith.map((share, i) => (
                          <div key={i} style={{ 
                            display: 'flex', 
                            justifyContent: 'space-between', 
                            alignItems: 'center',
                            padding: '10px 12px',
                            background: 'var(--slate-50)',
                            borderRadius: '6px'
                          }}>
                            <div>
                              <div style={{ fontWeight: 500, fontSize: '14px' }}>{share.email}</div>
                              <div style={{ fontSize: '12px', color: 'var(--slate-500)' }}>Can {share.permission}</div>
                            </div>
                            <button
                              onClick={() => removeShare(showShareModal, share.email)}
                              style={{
                                background: 'none',
                                border: 'none',
                                color: 'var(--error)',
                                cursor: 'pointer',
                                fontSize: '18px',
                                padding: '4px 8px'
                              }}
                              title="Remove access"
                            >
                              √ó
                            </button>
                          </div>
                        ))}
                      </div>
                    )}
                  </div>
                  
                  <div style={{ marginTop: '24px', paddingTop: '16px', borderTop: '1px solid var(--slate-200)' }}>
                    <button 
                      onClick={() => setShowShareModal(null)} 
                      className="btn btn-secondary" 
                      style={{ width: '100%' }}
                    >
                      Done
                    </button>
                  </div>
                </div>
              );
            };
            
            return (
              <div className="modal-overlay" onClick={() => setShowShareModal(null)}>
                <div className="modal" onClick={e => e.stopPropagation()} style={{ maxWidth: '480px' }}>
                  <ShareModalContent />
                </div>
              </div>
            );
          })()}

          {/* Token Modal */}
          {showTokenModal && (
            <div className="modal-overlay" onClick={() => setShowTokenModal(false)}>
              <div className="modal" onClick={e => e.stopPropagation()} style={{ maxWidth: '440px' }}>
                <div style={{ padding: '36px' }}>
                  <h3 style={{ marginBottom: '10px', fontSize: '20px' }}>GitHub Token Required</h3>
                  <p className="text-muted" style={{ marginBottom: '24px' }}>
                    To create and edit maps, you need to provide a GitHub personal access token.
                  </p>
                  <input
                    type="password"
                    className="input"
                    placeholder="ghp_xxxxxxxxxxxx"
                    style={{ marginBottom: '16px' }}
                    onChange={(e) => {
                      if (e.target.value.trim()) {
                        onUpdateToken(e.target.value.trim());
                        setShowTokenModal(false);
                        setShowCreateModal(true);
                      }
                    }}
                  />
                  <button onClick={() => setShowTokenModal(false)} className="btn btn-secondary" style={{ width: '100%' }}>
                    Cancel
                  </button>
                </div>
              </div>
            </div>
          )}
        </div>
      );
    }
    
    // ============================================
    // JOURNEY TEMPLATES
    // ============================================
    const JOURNEY_TEMPLATES = [
      {
        id: 'blank',
        name: 'Blank Canvas',
        description: 'Start from scratch with an empty journey map',
        icon: 'üìÑ',
        industry: 'Any',
        stageCount: 1,
        config: {
          title: 'New Journey Map',
          currency: '¬£',
          stages: [
            { id: 'stage-1', name: 'Stage 1', steps: [{ id: 'step-1-1', name: 'First Step', time: 30, personaId: null, friction: 'none', notes: '' }] }
          ],
          personas: [
            { id: 'customer', name: 'Customer', salary: 0, isExternal: true },
            { id: 'staff', name: 'Staff Member', salary: 35000, isExternal: false }
          ],
          funnelConfig: { enabled: false, startVolume: 100, stages: {} }
        }
      },
      {
        id: 'financial_client_onboarding',
        name: 'Client Onboarding',
        description: 'Wealth management or advisory client onboarding with KYC, compliance, and account setup',
        icon: 'üè¶',
        industry: 'Financial Services',
        stageCount: 6,
        config: {
          title: 'Client Onboarding Journey',
          currency: '¬£',
          stages: [
            { id: 'stage-discovery', name: 'Discovery & Qualification', steps: [
              { id: 'step-1-1', name: 'Initial Enquiry Received', time: 15, personaId: 'administrator', friction: 'none', notes: 'Via web form, phone, or referral' },
              { id: 'step-1-2', name: 'Qualification Call', time: 45, personaId: 'advisor', friction: 'low', notes: 'Assess fit and requirements' },
              { id: 'step-1-3', name: 'Send Welcome Pack', time: 20, personaId: 'administrator', friction: 'none', notes: '' },
              { id: 'step-1-4', name: 'Schedule Discovery Meeting', time: 15, personaId: 'administrator', friction: 'none', notes: '' }
            ]},
            { id: 'stage-kyc', name: 'KYC & Compliance', steps: [
              { id: 'step-2-1', name: 'Collect ID Documents', time: 30, personaId: 'client', friction: 'medium', notes: 'Passport, proof of address' },
              { id: 'step-2-2', name: 'Verify Identity (AML Check)', time: 45, personaId: 'compliance', friction: 'low', notes: '' },
              { id: 'step-2-3', name: 'Source of Wealth Declaration', time: 60, personaId: 'client', friction: 'high', notes: 'Often requires chasing' },
              { id: 'step-2-4', name: 'Compliance Review & Sign-off', time: 30, personaId: 'compliance', friction: 'medium', notes: '' },
              { id: 'step-2-5', name: 'Risk Profiling Questionnaire', time: 25, personaId: 'client', friction: 'low', notes: '' }
            ]},
            { id: 'stage-factfind', name: 'Fact Find & Analysis', steps: [
              { id: 'step-3-1', name: 'Discovery Meeting', time: 90, personaId: 'advisor', friction: 'none', notes: '' },
              { id: 'step-3-2', name: 'Gather Financial Information', time: 120, personaId: 'client', friction: 'high', notes: '' },
              { id: 'step-3-3', name: 'Input Data to Planning System', time: 60, personaId: 'paraplanner', friction: 'medium', notes: '' },
              { id: 'step-3-4', name: 'Cash Flow Modelling', time: 120, personaId: 'paraplanner', friction: 'low', notes: '' },
              { id: 'step-3-5', name: 'Research & Provider Selection', time: 180, personaId: 'paraplanner', friction: 'medium', notes: '' }
            ]},
            { id: 'stage-advice', name: 'Advice & Recommendation', steps: [
              { id: 'step-4-1', name: 'Draft Suitability Report', time: 240, personaId: 'paraplanner', friction: 'medium', notes: '' },
              { id: 'step-4-2', name: 'Advisor Review', time: 60, personaId: 'advisor', friction: 'low', notes: '' },
              { id: 'step-4-3', name: 'Compliance Review', time: 45, personaId: 'compliance', friction: 'medium', notes: '' },
              { id: 'step-4-4', name: 'Recommendation Meeting', time: 90, personaId: 'advisor', friction: 'none', notes: '' }
            ]},
            { id: 'stage-implementation', name: 'Implementation', steps: [
              { id: 'step-5-1', name: 'Prepare Application Forms', time: 45, personaId: 'administrator', friction: 'medium', notes: '' },
              { id: 'step-5-2', name: 'Client Signatures', time: 30, personaId: 'client', friction: 'medium', notes: '' },
              { id: 'step-5-3', name: 'Submit Applications', time: 30, personaId: 'administrator', friction: 'low', notes: '' },
              { id: 'step-5-4', name: 'Chase Providers', time: 60, personaId: 'administrator', friction: 'high', notes: '' }
            ]},
            { id: 'stage-handover', name: 'Handover & Review', steps: [
              { id: 'step-6-1', name: 'Welcome to Service Call', time: 30, personaId: 'advisor', friction: 'none', notes: '' },
              { id: 'step-6-2', name: 'Portal Setup', time: 20, personaId: 'administrator', friction: 'low', notes: '' },
              { id: 'step-6-3', name: 'Schedule Annual Review', time: 10, personaId: 'administrator', friction: 'none', notes: '' }
            ]}
          ],
          personas: [
            { id: 'client', name: 'Client', salary: 0, isExternal: true },
            { id: 'advisor', name: 'Financial Advisor', salary: 75000, isExternal: false },
            { id: 'paraplanner', name: 'Paraplanner', salary: 45000, isExternal: false },
            { id: 'administrator', name: 'Administrator', salary: 28000, isExternal: false },
            { id: 'compliance', name: 'Compliance Officer', salary: 55000, isExternal: false }
          ],
          funnelConfig: { enabled: true, startVolume: 100, stages: { 'stage-discovery': { dropOff: 25 }, 'stage-kyc': { dropOff: 10 }, 'stage-factfind': { dropOff: 5 }, 'stage-advice': { dropOff: 10 }, 'stage-implementation': { dropOff: 5 }, 'stage-handover': { dropOff: 0 } }}
        }
      },
      {
        id: 'employee_onboarding',
        name: 'Employee Onboarding',
        description: 'New hire onboarding from offer acceptance through to full productivity',
        icon: 'üëã',
        industry: 'Human Resources',
        stageCount: 6,
        config: {
          title: 'Employee Onboarding Journey',
          currency: '¬£',
          stages: [
            { id: 'stage-preboarding', name: 'Pre-boarding', steps: [
              { id: 'step-1-1', name: 'Send Offer Letter', time: 30, personaId: 'hr', friction: 'none', notes: '' },
              { id: 'step-1-2', name: 'Receive Signed Contract', time: 15, personaId: 'new-hire', friction: 'low', notes: '' },
              { id: 'step-1-3', name: 'Collect Personal Details', time: 20, personaId: 'new-hire', friction: 'low', notes: '' },
              { id: 'step-1-4', name: 'Right to Work Check', time: 30, personaId: 'hr', friction: 'medium', notes: '' },
              { id: 'step-1-5', name: 'Send Welcome Email', time: 15, personaId: 'hr', friction: 'none', notes: '' }
            ]},
            { id: 'stage-it-setup', name: 'IT & Access Setup', steps: [
              { id: 'step-2-1', name: 'Create User Accounts', time: 45, personaId: 'it', friction: 'low', notes: '' },
              { id: 'step-2-2', name: 'Provision Equipment', time: 60, personaId: 'it', friction: 'medium', notes: '' },
              { id: 'step-2-3', name: 'Configure Access Permissions', time: 30, personaId: 'it', friction: 'medium', notes: '' },
              { id: 'step-2-4', name: 'Create Building Pass', time: 20, personaId: 'facilities', friction: 'none', notes: '' }
            ]},
            { id: 'stage-day-one', name: 'First Day', steps: [
              { id: 'step-3-1', name: 'Reception & Welcome', time: 15, personaId: 'hr', friction: 'none', notes: '' },
              { id: 'step-3-2', name: 'IT Equipment Handover', time: 30, personaId: 'it', friction: 'low', notes: '' },
              { id: 'step-3-3', name: 'HR Paperwork Session', time: 60, personaId: 'hr', friction: 'medium', notes: '' },
              { id: 'step-3-4', name: 'Manager Welcome Meeting', time: 45, personaId: 'manager', friction: 'none', notes: '' },
              { id: 'step-3-5', name: 'Team Introductions', time: 30, personaId: 'manager', friction: 'none', notes: '' }
            ]},
            { id: 'stage-first-week', name: 'First Week', steps: [
              { id: 'step-4-1', name: 'Company Induction', time: 120, personaId: 'hr', friction: 'low', notes: '' },
              { id: 'step-4-2', name: 'Health & Safety Training', time: 60, personaId: 'new-hire', friction: 'low', notes: '' },
              { id: 'step-4-3', name: 'Role-Specific Orientation', time: 180, personaId: 'manager', friction: 'low', notes: '' },
              { id: 'step-4-4', name: 'End of Week Check-in', time: 30, personaId: 'manager', friction: 'none', notes: '' }
            ]},
            { id: 'stage-first-month', name: 'First Month', steps: [
              { id: 'step-5-1', name: 'Complete Compliance Training', time: 240, personaId: 'new-hire', friction: 'medium', notes: '' },
              { id: 'step-5-2', name: 'Weekly 1:1s', time: 120, personaId: 'manager', friction: 'none', notes: '4 sessions' },
              { id: 'step-5-3', name: '30-Day Review', time: 45, personaId: 'manager', friction: 'low', notes: '' }
            ]},
            { id: 'stage-probation', name: 'Probation & Sign-off', steps: [
              { id: 'step-6-1', name: '90-Day Review', time: 60, personaId: 'manager', friction: 'low', notes: '' },
              { id: 'step-6-2', name: 'Probation Sign-off', time: 30, personaId: 'hr', friction: 'medium', notes: '' },
              { id: 'step-6-3', name: 'Onboarding Survey', time: 15, personaId: 'new-hire', friction: 'none', notes: '' }
            ]}
          ],
          personas: [
            { id: 'new-hire', name: 'New Hire', salary: 40000, isExternal: false },
            { id: 'manager', name: 'Hiring Manager', salary: 65000, isExternal: false },
            { id: 'hr', name: 'HR Coordinator', salary: 32000, isExternal: false },
            { id: 'it', name: 'IT Support', salary: 35000, isExternal: false },
            { id: 'facilities', name: 'Facilities', salary: 28000, isExternal: false }
          ],
          funnelConfig: { enabled: true, startVolume: 50, stages: { 'stage-preboarding': { dropOff: 3 }, 'stage-it-setup': { dropOff: 0 }, 'stage-day-one': { dropOff: 1 }, 'stage-first-week': { dropOff: 1 }, 'stage-first-month': { dropOff: 2 }, 'stage-probation': { dropOff: 2 } }}
        }
      },
      {
        id: 'recruitment_hiring',
        name: 'Recruitment & Hiring',
        description: 'End-to-end hiring process from job requisition to offer acceptance',
        icon: 'üéØ',
        industry: 'Human Resources',
        stageCount: 6,
        config: {
          title: 'Recruitment Journey',
          currency: '¬£',
          stages: [
            { id: 'stage-requisition', name: 'Requisition & Planning', steps: [
              { id: 'step-1-1', name: 'Hiring Need Identified', time: 30, personaId: 'hiring-manager', friction: 'none', notes: '' },
              { id: 'step-1-2', name: 'Complete Job Requisition', time: 45, personaId: 'hiring-manager', friction: 'low', notes: '' },
              { id: 'step-1-3', name: 'Budget Approval', time: 30, personaId: 'finance', friction: 'medium', notes: '' },
              { id: 'step-1-4', name: 'Draft Job Description', time: 60, personaId: 'recruiter', friction: 'low', notes: '' }
            ]},
            { id: 'stage-sourcing', name: 'Sourcing & Advertising', steps: [
              { id: 'step-2-1', name: 'Post to Job Boards', time: 30, personaId: 'recruiter', friction: 'none', notes: '' },
              { id: 'step-2-2', name: 'Direct Sourcing', time: 180, personaId: 'recruiter', friction: 'medium', notes: '' },
              { id: 'step-2-3', name: 'Referral Outreach', time: 30, personaId: 'recruiter', friction: 'none', notes: '' }
            ]},
            { id: 'stage-screening', name: 'Screening', steps: [
              { id: 'step-3-1', name: 'CV Review', time: 120, personaId: 'recruiter', friction: 'medium', notes: '' },
              { id: 'step-3-2', name: 'Phone Screens', time: 180, personaId: 'recruiter', friction: 'low', notes: '' },
              { id: 'step-3-3', name: 'Shortlist Review', time: 30, personaId: 'hiring-manager', friction: 'low', notes: '' },
              { id: 'step-3-4', name: 'Schedule Interviews', time: 45, personaId: 'recruiter', friction: 'medium', notes: '' }
            ]},
            { id: 'stage-interview', name: 'Interviews', steps: [
              { id: 'step-4-1', name: 'First Round Interview', time: 60, personaId: 'hiring-manager', friction: 'low', notes: '' },
              { id: 'step-4-2', name: 'Technical Interview', time: 90, personaId: 'interviewer', friction: 'low', notes: '' },
              { id: 'step-4-3', name: 'Final Round', time: 90, personaId: 'hiring-manager', friction: 'low', notes: '' },
              { id: 'step-4-4', name: 'Interview Debrief', time: 30, personaId: 'hiring-manager', friction: 'none', notes: '' }
            ]},
            { id: 'stage-offer', name: 'Offer & Negotiation', steps: [
              { id: 'step-5-1', name: 'Reference Checks', time: 60, personaId: 'recruiter', friction: 'medium', notes: '' },
              { id: 'step-5-2', name: 'Prepare Offer', time: 45, personaId: 'recruiter', friction: 'low', notes: '' },
              { id: 'step-5-3', name: 'Verbal Offer', time: 30, personaId: 'hiring-manager', friction: 'low', notes: '' },
              { id: 'step-5-4', name: 'Negotiation', time: 45, personaId: 'recruiter', friction: 'medium', notes: '' }
            ]},
            { id: 'stage-close', name: 'Close & Handover', steps: [
              { id: 'step-6-1', name: 'Receive Signed Offer', time: 15, personaId: 'candidate', friction: 'low', notes: '' },
              { id: 'step-6-2', name: 'Reject Other Candidates', time: 45, personaId: 'recruiter', friction: 'low', notes: '' },
              { id: 'step-6-3', name: 'Handover to Onboarding', time: 20, personaId: 'recruiter', friction: 'none', notes: '' }
            ]}
          ],
          personas: [
            { id: 'candidate', name: 'Candidate', salary: 0, isExternal: true },
            { id: 'hiring-manager', name: 'Hiring Manager', salary: 65000, isExternal: false },
            { id: 'recruiter', name: 'Recruiter', salary: 38000, isExternal: false },
            { id: 'interviewer', name: 'Interview Panel', salary: 55000, isExternal: false },
            { id: 'finance', name: 'Finance Approver', salary: 60000, isExternal: false }
          ],
          funnelConfig: { enabled: true, startVolume: 150, stages: { 'stage-requisition': { dropOff: 0 }, 'stage-sourcing': { dropOff: 0 }, 'stage-screening': { dropOff: 120 }, 'stage-interview': { dropOff: 20 }, 'stage-offer': { dropOff: 5 }, 'stage-close': { dropOff: 2 } }}
        }
      },
      {
        id: 'saas_customer_onboarding',
        name: 'Customer Onboarding (SaaS)',
        description: 'Enterprise software implementation and activation journey',
        icon: 'üöÄ',
        industry: 'Technology / SaaS',
        stageCount: 6,
        config: {
          title: 'Customer Onboarding Journey',
          currency: '¬£',
          stages: [
            { id: 'stage-handoff', name: 'Sales Handoff', steps: [
              { id: 'step-1-1', name: 'Deal Closed', time: 15, personaId: 'sales', friction: 'none', notes: '' },
              { id: 'step-1-2', name: 'Internal Handoff Meeting', time: 30, personaId: 'csm', friction: 'low', notes: '' },
              { id: 'step-1-3', name: 'Assign Implementation Team', time: 15, personaId: 'csm', friction: 'none', notes: '' },
              { id: 'step-1-4', name: 'Send Welcome Email', time: 15, personaId: 'csm', friction: 'none', notes: '' }
            ]},
            { id: 'stage-kickoff', name: 'Kickoff', steps: [
              { id: 'step-2-1', name: 'Kickoff Meeting', time: 60, personaId: 'csm', friction: 'none', notes: '' },
              { id: 'step-2-2', name: 'Gather Requirements', time: 45, personaId: 'implementation', friction: 'medium', notes: '' },
              { id: 'step-2-3', name: 'Define Success Criteria', time: 30, personaId: 'csm', friction: 'low', notes: '' },
              { id: 'step-2-4', name: 'Create Implementation Plan', time: 60, personaId: 'implementation', friction: 'low', notes: '' }
            ]},
            { id: 'stage-setup', name: 'Technical Setup', steps: [
              { id: 'step-3-1', name: 'Provision Environment', time: 30, personaId: 'implementation', friction: 'none', notes: '' },
              { id: 'step-3-2', name: 'SSO Setup', time: 90, personaId: 'implementation', friction: 'high', notes: '' },
              { id: 'step-3-3', name: 'Data Migration', time: 180, personaId: 'implementation', friction: 'high', notes: '' },
              { id: 'step-3-4', name: 'Integration Setup', time: 120, personaId: 'implementation', friction: 'high', notes: '' },
              { id: 'step-3-5', name: 'Custom Configuration', time: 90, personaId: 'implementation', friction: 'medium', notes: '' }
            ]},
            { id: 'stage-training', name: 'Training', steps: [
              { id: 'step-4-1', name: 'Admin Training', time: 90, personaId: 'implementation', friction: 'low', notes: '' },
              { id: 'step-4-2', name: 'End User Training', time: 240, personaId: 'implementation', friction: 'low', notes: 'Multiple sessions' },
              { id: 'step-4-3', name: 'Create Documentation', time: 60, personaId: 'csm', friction: 'medium', notes: '' }
            ]},
            { id: 'stage-golive', name: 'Go-Live', steps: [
              { id: 'step-5-1', name: 'User Acceptance Testing', time: 120, personaId: 'customer', friction: 'medium', notes: '' },
              { id: 'step-5-2', name: 'Fix UAT Issues', time: 90, personaId: 'implementation', friction: 'medium', notes: '' },
              { id: 'step-5-3', name: 'Go-Live Support', time: 120, personaId: 'support', friction: 'medium', notes: '' }
            ]},
            { id: 'stage-adoption', name: 'Adoption & Handover', steps: [
              { id: 'step-6-1', name: 'Monitor Adoption', time: 30, personaId: 'csm', friction: 'low', notes: '' },
              { id: 'step-6-2', name: '30-Day Success Review', time: 45, personaId: 'csm', friction: 'none', notes: '' },
              { id: 'step-6-3', name: 'Transition to BAU', time: 30, personaId: 'csm', friction: 'none', notes: '' },
              { id: 'step-6-4', name: 'Collect NPS', time: 15, personaId: 'customer', friction: 'none', notes: '' }
            ]}
          ],
          personas: [
            { id: 'customer', name: 'Customer', salary: 0, isExternal: true },
            { id: 'sales', name: 'Account Executive', salary: 70000, isExternal: false },
            { id: 'csm', name: 'Customer Success Manager', salary: 50000, isExternal: false },
            { id: 'implementation', name: 'Implementation Specialist', salary: 45000, isExternal: false },
            { id: 'support', name: 'Support Engineer', salary: 38000, isExternal: false }
          ],
          funnelConfig: { enabled: true, startVolume: 20, stages: { 'stage-handoff': { dropOff: 0 }, 'stage-kickoff': { dropOff: 1 }, 'stage-setup': { dropOff: 1 }, 'stage-training': { dropOff: 0 }, 'stage-golive': { dropOff: 1 }, 'stage-adoption': { dropOff: 0 } }}
        }
      },
      {
        id: 'insurance_claim',
        name: 'Insurance Claim',
        description: 'End-to-end claim processing from first notice to settlement',
        icon: 'üõ°Ô∏è',
        industry: 'Insurance',
        stageCount: 6,
        config: {
          title: 'Insurance Claim Journey',
          currency: '¬£',
          stages: [
            { id: 'stage-fnol', name: 'First Notice of Loss', steps: [
              { id: 'step-1-1', name: 'Claim Reported', time: 20, personaId: 'claimant', friction: 'medium', notes: '' },
              { id: 'step-1-2', name: 'Initial Logging', time: 15, personaId: 'agent', friction: 'none', notes: '' },
              { id: 'step-1-3', name: 'Policy Verification', time: 10, personaId: 'agent', friction: 'low', notes: '' },
              { id: 'step-1-4', name: 'Gather Incident Details', time: 25, personaId: 'agent', friction: 'low', notes: '' }
            ]},
            { id: 'stage-documentation', name: 'Documentation', steps: [
              { id: 'step-2-1', name: 'Request Documents', time: 15, personaId: 'agent', friction: 'none', notes: '' },
              { id: 'step-2-2', name: 'Claimant Gathers Evidence', time: 60, personaId: 'claimant', friction: 'high', notes: '' },
              { id: 'step-2-3', name: 'Chase Missing Documents', time: 30, personaId: 'agent', friction: 'high', notes: '' },
              { id: 'step-2-4', name: 'Document Review', time: 20, personaId: 'agent', friction: 'low', notes: '' }
            ]},
            { id: 'stage-assessment', name: 'Assessment', steps: [
              { id: 'step-3-1', name: 'Assign to Assessor', time: 10, personaId: 'agent', friction: 'none', notes: '' },
              { id: 'step-3-2', name: 'Review Claim Details', time: 30, personaId: 'assessor', friction: 'low', notes: '' },
              { id: 'step-3-3', name: 'Conduct Assessment', time: 90, personaId: 'assessor', friction: 'medium', notes: '' },
              { id: 'step-3-4', name: 'Write Assessment Report', time: 45, personaId: 'assessor', friction: 'low', notes: '' }
            ]},
            { id: 'stage-adjudication', name: 'Adjudication', steps: [
              { id: 'step-4-1', name: 'Review Assessment', time: 30, personaId: 'adjuster', friction: 'low', notes: '' },
              { id: 'step-4-2', name: 'Check Policy Terms', time: 20, personaId: 'adjuster', friction: 'low', notes: '' },
              { id: 'step-4-3', name: 'Fraud Screening', time: 15, personaId: 'adjuster', friction: 'low', notes: '' },
              { id: 'step-4-4', name: 'Calculate Settlement', time: 25, personaId: 'adjuster', friction: 'low', notes: '' },
              { id: 'step-4-5', name: 'Manager Approval', time: 20, personaId: 'manager', friction: 'medium', notes: '' }
            ]},
            { id: 'stage-settlement', name: 'Settlement', steps: [
              { id: 'step-5-1', name: 'Communicate Decision', time: 20, personaId: 'agent', friction: 'low', notes: '' },
              { id: 'step-5-2', name: 'Handle Disputes', time: 30, personaId: 'agent', friction: 'medium', notes: '' },
              { id: 'step-5-3', name: 'Process Payment', time: 15, personaId: 'payments', friction: 'low', notes: '' }
            ]},
            { id: 'stage-close', name: 'Closure', steps: [
              { id: 'step-6-1', name: 'Final Documentation', time: 15, personaId: 'agent', friction: 'none', notes: '' },
              { id: 'step-6-2', name: 'Close Claim', time: 10, personaId: 'agent', friction: 'none', notes: '' },
              { id: 'step-6-3', name: 'Customer Survey', time: 5, personaId: 'claimant', friction: 'none', notes: '' }
            ]}
          ],
          personas: [
            { id: 'claimant', name: 'Claimant', salary: 0, isExternal: true },
            { id: 'agent', name: 'Claims Agent', salary: 28000, isExternal: false },
            { id: 'assessor', name: 'Loss Assessor', salary: 42000, isExternal: false },
            { id: 'adjuster', name: 'Claims Adjuster', salary: 38000, isExternal: false },
            { id: 'manager', name: 'Claims Manager', salary: 55000, isExternal: false },
            { id: 'payments', name: 'Payments Team', salary: 30000, isExternal: false }
          ],
          funnelConfig: { enabled: true, startVolume: 500, stages: { 'stage-fnol': { dropOff: 25 }, 'stage-documentation': { dropOff: 40 }, 'stage-assessment': { dropOff: 15 }, 'stage-adjudication': { dropOff: 30 }, 'stage-settlement': { dropOff: 5 }, 'stage-close': { dropOff: 0 } }}
        }
      },
      {
        id: 'contract_lifecycle',
        name: 'Contract Lifecycle',
        description: 'Contract request through negotiation, approval, and execution',
        icon: 'üìù',
        industry: 'Legal / Procurement',
        stageCount: 6,
        config: {
          title: 'Contract Lifecycle Journey',
          currency: '¬£',
          stages: [
            { id: 'stage-request', name: 'Request & Intake', steps: [
              { id: 'step-1-1', name: 'Contract Request', time: 20, personaId: 'requestor', friction: 'low', notes: '' },
              { id: 'step-1-2', name: 'Initial Triage', time: 15, personaId: 'legal-ops', friction: 'none', notes: '' },
              { id: 'step-1-3', name: 'Assign to Counsel', time: 10, personaId: 'legal-ops', friction: 'none', notes: '' },
              { id: 'step-1-4', name: 'Gather Requirements', time: 30, personaId: 'legal', friction: 'low', notes: '' }
            ]},
            { id: 'stage-draft', name: 'Drafting', steps: [
              { id: 'step-2-1', name: 'Select Template', time: 15, personaId: 'legal', friction: 'none', notes: '' },
              { id: 'step-2-2', name: 'Draft Contract', time: 120, personaId: 'legal', friction: 'medium', notes: '' },
              { id: 'step-2-3', name: 'Internal Review', time: 45, personaId: 'legal', friction: 'low', notes: '' },
              { id: 'step-2-4', name: 'Requestor Review', time: 30, personaId: 'requestor', friction: 'low', notes: '' }
            ]},
            { id: 'stage-negotiation', name: 'Negotiation', steps: [
              { id: 'step-3-1', name: 'Send to Counterparty', time: 15, personaId: 'legal', friction: 'none', notes: '' },
              { id: 'step-3-2', name: 'Counterparty Review', time: 60, personaId: 'counterparty', friction: 'medium', notes: '' },
              { id: 'step-3-3', name: 'Review Redlines', time: 90, personaId: 'legal', friction: 'medium', notes: '' },
              { id: 'step-3-4', name: 'Negotiate Key Terms', time: 60, personaId: 'legal', friction: 'high', notes: '' }
            ]},
            { id: 'stage-approval', name: 'Approval', steps: [
              { id: 'step-4-1', name: 'Business Approval', time: 30, personaId: 'requestor', friction: 'low', notes: '' },
              { id: 'step-4-2', name: 'Finance Review', time: 45, personaId: 'finance', friction: 'medium', notes: '' },
              { id: 'step-4-3', name: 'Legal Sign-off', time: 20, personaId: 'legal', friction: 'none', notes: '' },
              { id: 'step-4-4', name: 'Executive Approval', time: 30, personaId: 'executive', friction: 'medium', notes: '' }
            ]},
            { id: 'stage-execution', name: 'Execution', steps: [
              { id: 'step-5-1', name: 'Internal Signature', time: 20, personaId: 'signatory', friction: 'low', notes: '' },
              { id: 'step-5-2', name: 'Send for Signature', time: 10, personaId: 'legal-ops', friction: 'none', notes: '' },
              { id: 'step-5-3', name: 'Chase Counterparty', time: 30, personaId: 'legal-ops', friction: 'medium', notes: '' },
              { id: 'step-5-4', name: 'Receive Executed Contract', time: 15, personaId: 'counterparty', friction: 'low', notes: '' }
            ]},
            { id: 'stage-post', name: 'Post-Execution', steps: [
              { id: 'step-6-1', name: 'Upload to CLM', time: 15, personaId: 'legal-ops', friction: 'none', notes: '' },
              { id: 'step-6-2', name: 'Extract Key Terms', time: 20, personaId: 'legal-ops', friction: 'low', notes: '' },
              { id: 'step-6-3', name: 'Set Reminders', time: 10, personaId: 'legal-ops', friction: 'none', notes: '' },
              { id: 'step-6-4', name: 'Close Request', time: 5, personaId: 'legal-ops', friction: 'none', notes: '' }
            ]}
          ],
          personas: [
            { id: 'counterparty', name: 'Counterparty', salary: 0, isExternal: true },
            { id: 'requestor', name: 'Business Requestor', salary: 55000, isExternal: false },
            { id: 'legal', name: 'Legal Counsel', salary: 85000, isExternal: false },
            { id: 'legal-ops', name: 'Legal Operations', salary: 38000, isExternal: false },
            { id: 'finance', name: 'Finance', salary: 60000, isExternal: false },
            { id: 'signatory', name: 'Authorised Signatory', salary: 90000, isExternal: false },
            { id: 'executive', name: 'Executive Approver', salary: 120000, isExternal: false }
          ],
          funnelConfig: { enabled: true, startVolume: 50, stages: { 'stage-request': { dropOff: 2 }, 'stage-draft': { dropOff: 3 }, 'stage-negotiation': { dropOff: 5 }, 'stage-approval': { dropOff: 2 }, 'stage-execution': { dropOff: 1 }, 'stage-post': { dropOff: 0 } }}
        }
      },
      {
        id: 'property_purchase',
        name: 'Property Purchase (UK)',
        description: 'Residential property purchase from offer to completion',
        icon: 'üè†',
        industry: 'Property / Real Estate',
        stageCount: 6,
        config: {
          title: 'Property Purchase Journey',
          currency: '¬£',
          stages: [
            { id: 'stage-offer', name: 'Offer & Instruction', steps: [
              { id: 'step-1-1', name: 'Offer Accepted', time: 15, personaId: 'buyer', friction: 'none', notes: '' },
              { id: 'step-1-2', name: 'Instruct Solicitor', time: 30, personaId: 'buyer', friction: 'low', notes: '' },
              { id: 'step-1-3', name: 'Client Care Forms', time: 45, personaId: 'buyer', friction: 'medium', notes: '' },
              { id: 'step-1-4', name: 'Pay Initial Fees', time: 15, personaId: 'buyer', friction: 'low', notes: '' }
            ]},
            { id: 'stage-mortgage', name: 'Mortgage Application', steps: [
              { id: 'step-2-1', name: 'Gather Documents', time: 90, personaId: 'buyer', friction: 'high', notes: '' },
              { id: 'step-2-2', name: 'Submit Application', time: 45, personaId: 'broker', friction: 'low', notes: '' },
              { id: 'step-2-3', name: 'Lender Processing', time: 30, personaId: 'lender', friction: 'medium', notes: '' },
              { id: 'step-2-4', name: 'Valuation', time: 60, personaId: 'surveyor', friction: 'low', notes: '' },
              { id: 'step-2-5', name: 'Mortgage Offer Issued', time: 15, personaId: 'lender', friction: 'none', notes: '' }
            ]},
            { id: 'stage-searches', name: 'Searches & Enquiries', steps: [
              { id: 'step-3-1', name: 'Order Searches', time: 20, personaId: 'solicitor', friction: 'none', notes: '' },
              { id: 'step-3-2', name: 'Receive Results', time: 30, personaId: 'solicitor', friction: 'medium', notes: '2-4 weeks' },
              { id: 'step-3-3', name: 'Review Title', time: 60, personaId: 'solicitor', friction: 'low', notes: '' },
              { id: 'step-3-4', name: 'Raise Enquiries', time: 45, personaId: 'solicitor', friction: 'medium', notes: '' },
              { id: 'step-3-5', name: 'Chase Responses', time: 60, personaId: 'solicitor', friction: 'high', notes: '' }
            ]},
            { id: 'stage-survey', name: 'Survey', steps: [
              { id: 'step-4-1', name: 'Instruct Surveyor', time: 20, personaId: 'buyer', friction: 'low', notes: '' },
              { id: 'step-4-2', name: 'Survey Conducted', time: 180, personaId: 'surveyor', friction: 'low', notes: '' },
              { id: 'step-4-3', name: 'Review Report', time: 45, personaId: 'buyer', friction: 'medium', notes: '' },
              { id: 'step-4-4', name: 'Renegotiate if Required', time: 60, personaId: 'estate-agent', friction: 'high', notes: '' }
            ]},
            { id: 'stage-exchange', name: 'Exchange', steps: [
              { id: 'step-5-1', name: 'Report on Title', time: 45, personaId: 'solicitor', friction: 'low', notes: '' },
              { id: 'step-5-2', name: 'Sign Contract', time: 30, personaId: 'buyer', friction: 'low', notes: '' },
              { id: 'step-5-3', name: 'Transfer Deposit', time: 30, personaId: 'buyer', friction: 'medium', notes: '' },
              { id: 'step-5-4', name: 'Exchange Contracts', time: 30, personaId: 'solicitor', friction: 'low', notes: '' }
            ]},
            { id: 'stage-completion', name: 'Completion', steps: [
              { id: 'step-6-1', name: 'Final Checks', time: 30, personaId: 'solicitor', friction: 'low', notes: '' },
              { id: 'step-6-2', name: 'Transfer Funds', time: 30, personaId: 'buyer', friction: 'medium', notes: '' },
              { id: 'step-6-3', name: 'Complete Purchase', time: 15, personaId: 'solicitor', friction: 'none', notes: '' },
              { id: 'step-6-4', name: 'Pay Stamp Duty', time: 15, personaId: 'solicitor', friction: 'none', notes: '' },
              { id: 'step-6-5', name: 'Register with Land Registry', time: 30, personaId: 'solicitor', friction: 'low', notes: '' }
            ]}
          ],
          personas: [
            { id: 'buyer', name: 'Buyer', salary: 0, isExternal: true },
            { id: 'solicitor', name: 'Conveyancer', salary: 48000, isExternal: false },
            { id: 'broker', name: 'Mortgage Broker', salary: 45000, isExternal: false },
            { id: 'surveyor', name: 'Surveyor', salary: 50000, isExternal: false },
            { id: 'estate-agent', name: 'Estate Agent', salary: 35000, isExternal: false },
            { id: 'lender', name: 'Mortgage Lender', salary: 40000, isExternal: false }
          ],
          funnelConfig: { enabled: true, startVolume: 100, stages: { 'stage-offer': { dropOff: 5 }, 'stage-mortgage': { dropOff: 10 }, 'stage-searches': { dropOff: 8 }, 'stage-survey': { dropOff: 12 }, 'stage-exchange': { dropOff: 5 }, 'stage-completion': { dropOff: 2 } }}
        }
      }
    ];
    
    // ============================================
    // CREATE MAP MODAL WITH TEMPLATE PICKER
    // ============================================
    function CreateMapModal({ onClose, onCreate, userEmail }) {
      const [step, setStep] = useState(1);
      const [selectedTemplate, setSelectedTemplate] = useState(null);
      const [title, setTitle] = useState('');
      const [description, setDescription] = useState('');
      
      const handleSelectTemplate = (template) => {
        setSelectedTemplate(template);
        setTitle(template.config.title);
        setDescription(template.description);
        setStep(2);
      };
      
      const handleCreate = () => {
        if (!title.trim() || !selectedTemplate) return;
        
        // Deep clone the template config
        const templateConfig = JSON.parse(JSON.stringify(selectedTemplate.config));
        
        const newMap = {
          id: Date.now().toString(36) + Math.random().toString(36).substr(2, 5),
          title: title.trim(),
          description: description.trim(),
          owner: userEmail,
          createdAt: new Date().toISOString(),
          updatedAt: new Date().toISOString(),
          sharedWith: [],
          config: {
            meta: {
              title: title.trim(),
              version: "1.0",
              product: `FATHOM v${APP_VERSION}`,
              lastUpdated: new Date().toISOString(),
              template: selectedTemplate.id
            },
            funnel: { 
              enabled: templateConfig.funnelConfig?.enabled || false, 
              initialVolume: templateConfig.funnelConfig?.startVolume || 100,
              periodLabel: 'per month'
            },
            personas: templateConfig.personas.map(p => ({
              id: p.id,
              label: p.name,
              salary: p.salary,
              isExternal: p.isExternal,
              color: p.isExternal ? '#2D8A6E' : '#5B8A9A'
            })),
            stages: templateConfig.stages.map(stage => ({
              id: stage.id,
              name: stage.name,
              dropOffCount: templateConfig.funnelConfig?.stages?.[stage.id]?.dropOff || 0,
              steps: stage.steps.map(step => ({
                id: step.id,
                name: step.name,
                persona: step.personaId,
                duration: step.time,
                friction: step.friction || 'none',
                notes: step.notes || ''
              }))
            }))
          }
        };
        
        onCreate(newMap);
      };
      
      const handleBack = () => {
        setStep(1);
      };
      
      // Group templates by industry
      const templatesByIndustry = JOURNEY_TEMPLATES.reduce((acc, t) => {
        if (!acc[t.industry]) acc[t.industry] = [];
        acc[t.industry].push(t);
        return acc;
      }, {});
      
      return (
        <div className="modal-overlay" onClick={onClose}>
          <div className="modal" onClick={e => e.stopPropagation()} style={{ maxWidth: step === 1 ? '800px' : '480px', width: '95%' }}>
            <div style={{ padding: '36px' }}>
              {/* Header */}
              <div style={{ display: 'flex', alignItems: 'center', gap: '16px', marginBottom: '28px' }}>
                {step === 2 && (
                  <button onClick={handleBack} style={{ background: 'none', border: 'none', cursor: 'pointer', fontSize: '18px', color: 'var(--slate-400)', padding: '4px' }}>
                    ‚Üê
                  </button>
                )}
                <h2 style={{ fontSize: '24px', fontWeight: 400, color: 'var(--navy-700)', margin: 0 }}>
                  {step === 1 ? 'Choose a Template' : 'Customise Your Map'}
                </h2>
              </div>
              
              {step === 1 ? (
                <>
                  <p style={{ color: 'var(--slate-500)', marginBottom: '28px', fontSize: '15px', lineHeight: 1.6 }}>
                    Start with a pre-built template or create from scratch. Templates include realistic stages, steps, roles, and timings.
                  </p>
                  
                  {/* Template Grid */}
                  <div style={{ maxHeight: '450px', overflowY: 'auto', marginRight: '-16px', paddingRight: '16px' }}>
                    {Object.entries(templatesByIndustry).map(([industry, templates]) => (
                      <div key={industry} style={{ marginBottom: '24px' }}>
                        <h3 style={{ fontSize: '12px', fontWeight: 600, color: 'var(--slate-400)', textTransform: 'uppercase', letterSpacing: '1px', marginBottom: '12px' }}>
                          {industry}
                        </h3>
                        <div style={{ display: 'grid', gridTemplateColumns: 'repeat(auto-fill, minmax(220px, 1fr))', gap: '12px' }}>
                          {templates.map(template => (
                            <button
                              key={template.id}
                              onClick={() => handleSelectTemplate(template)}
                              style={{
                                display: 'flex',
                                flexDirection: 'column',
                                alignItems: 'flex-start',
                                padding: '16px',
                                background: '#FFF',
                                border: '2px solid var(--slate-200)',
                                borderRadius: '12px',
                                cursor: 'pointer',
                                textAlign: 'left',
                                transition: 'all 0.15s',
                                fontFamily: "'Interstate', sans-serif"
                              }}
                              onMouseOver={(e) => { e.currentTarget.style.borderColor = 'var(--steel-400)'; e.currentTarget.style.transform = 'translateY(-2px)'; }}
                              onMouseOut={(e) => { e.currentTarget.style.borderColor = 'var(--slate-200)'; e.currentTarget.style.transform = 'translateY(0)'; }}
                            >
                              <div style={{ fontSize: '28px', marginBottom: '8px' }}>{template.icon}</div>
                              <div style={{ fontWeight: 600, color: 'var(--navy-700)', marginBottom: '4px', fontSize: '15px' }}>{template.name}</div>
                              <div style={{ fontSize: '12px', color: 'var(--slate-500)', lineHeight: 1.4, marginBottom: '8px' }}>
                                {template.description.length > 60 ? template.description.substring(0, 60) + '...' : template.description}
                              </div>
                              {template.id !== 'blank' && (
                                <div style={{ fontSize: '11px', color: 'var(--steel-500)', fontWeight: 500 }}>
                                  {template.stageCount} stages
                                </div>
                              )}
                            </button>
                          ))}
                        </div>
                      </div>
                    ))}
                  </div>
                </>
              ) : (
                <>
                  {/* Selected Template Preview */}
                  <div style={{ display: 'flex', alignItems: 'center', gap: '16px', padding: '16px', background: 'var(--slate-50)', borderRadius: '12px', marginBottom: '24px' }}>
                    <div style={{ fontSize: '36px' }}>{selectedTemplate.icon}</div>
                    <div>
                      <div style={{ fontWeight: 600, color: 'var(--navy-700)', marginBottom: '2px' }}>{selectedTemplate.name}</div>
                      <div style={{ fontSize: '13px', color: 'var(--slate-500)' }}>
                        {selectedTemplate.id === 'blank' ? 'Empty template' : `${selectedTemplate.stageCount} stages ‚Ä¢ ${selectedTemplate.config.personas.length} roles`}
                      </div>
                    </div>
                  </div>
                  
                  <div style={{ marginBottom: '18px' }}>
                    <label className="label">Map Title</label>
                    <input
                      type="text"
                      className="input"
                      value={title}
                      onChange={(e) => setTitle(e.target.value)}
                      placeholder="e.g., Client Onboarding Journey"
                      autoFocus
                    />
                  </div>
                  
                  <div style={{ marginBottom: '28px' }}>
                    <label className="label">Description <span style={{ fontWeight: 400, color: 'var(--slate-400)' }}>(optional)</span></label>
                    <textarea
                      className="input"
                      value={description}
                      onChange={(e) => setDescription(e.target.value)}
                      placeholder="Brief description of this journey map"
                      rows={3}
                      style={{ resize: 'vertical' }}
                    />
                  </div>
                  
                  <div style={{ display: 'flex', gap: '12px' }}>
                    <button onClick={onClose} className="btn btn-secondary" style={{ flex: 1, padding: '14px' }}>
                      Cancel
                    </button>
                    <button onClick={handleCreate} className="btn btn-primary" style={{ flex: 1, padding: '14px' }} disabled={!title.trim()}>
                      Create Map
                    </button>
                  </div>
                </>
              )}
            </div>
          </div>
        </div>
      );
    }
    
    // ============================================
    // MAIN APP
    // ============================================
    function App() {
      const [user, setUser] = useState(null);
      const [token, setToken] = useState('');
      const [showLogin, setShowLogin] = useState(false);
      const [isLoaded, setIsLoaded] = useState(false);
      
      useEffect(() => {
        // Check for existing session
        const savedUser = localStorage.getItem('fathom_user');
        const savedToken = localStorage.getItem('fathom_token');
        if (savedUser) {
          setUser(JSON.parse(savedUser));
          if (savedToken) setToken(savedToken);
        }
        setIsLoaded(true);
      }, []);
      
      const handleLogin = (userData, userToken) => {
        setUser(userData);
        setToken(userToken || '');
        localStorage.setItem('fathom_user', JSON.stringify(userData));
        if (userToken) localStorage.setItem('fathom_token', userToken);
        setShowLogin(false);
      };
      
      const handleLogout = () => {
        setUser(null);
        setToken('');
        localStorage.removeItem('fathom_user');
        localStorage.removeItem('fathom_token');
      };
      
      const handleUpdateToken = (newToken) => {
        setToken(newToken);
        localStorage.setItem('fathom_token', newToken);
      };
      
      if (!isLoaded) {
        return (
          <div style={{ minHeight: '100vh', display: 'flex', alignItems: 'center', justifyContent: 'center', background: 'var(--navy-700)' }}>
            <img src="logo_light.png" alt="FATHOM" style={{ height: '40px', opacity: 0.5 }} />
          </div>
        );
      }
      
      // If logged in, show dashboard
      if (user) {
        return (
          <Dashboard 
            user={user} 
            token={token} 
            onLogout={handleLogout}
            onUpdateToken={handleUpdateToken}
          />
        );
      }
      
      // Otherwise show landing page
      return (
        <>
          <LandingPage onGetStarted={() => setShowLogin(true)} />
          {showLogin && (
            <LoginModal 
              onClose={() => setShowLogin(false)} 
              onLogin={handleLogin}
            />
          )}
        </>
      );
    }
    
    ReactDOM.createRoot(document.getElementById('root')).render(<App />);
  </script>
</body>
</html>
