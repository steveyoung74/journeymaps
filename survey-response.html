<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Survey Response - FATHOM</title>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }
    
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', sans-serif;
      background: #F4F5F7;
      padding: 20px;
      color: #192B45;
    }
    
    .container {
      max-width: 900px;
      margin: 0 auto;
    }
    
    .header {
      background: #192B45;
      color: #FFF;
      padding: 24px 32px;
      border-radius: 12px 12px 0 0;
    }
    
    .header h1 {
      font-size: 24px;
      font-weight: 600;
      letter-spacing: 1px;
      margin-bottom: 8px;
    }
    
    .header .subtitle {
      font-size: 14px;
      opacity: 0.7;
    }
    
    .info-banner {
      background: #E1EEF2;
      border: 2px solid #5B8A9A;
      padding: 20px 32px;
      border-radius: 0 0 12px 12px;
      margin-bottom: 24px;
    }
    
    .info-banner h2 {
      font-size: 16px;
      color: #3A6070;
      margin-bottom: 12px;
    }
    
    .info-grid {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 16px;
    }
    
    .info-item {
      font-size: 13px;
    }
    
    .info-label {
      font-size: 11px;
      color: #556275;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      margin-bottom: 4px;
    }
    
    .info-value {
      font-weight: 600;
      color: #192B45;
    }
    
    .message-box {
      background: #FAF0D6;
      border-left: 4px solid #C4942A;
      padding: 16px 20px;
      border-radius: 6px;
      margin-bottom: 24px;
      font-size: 14px;
      line-height: 1.6;
      color: #8B6914;
    }
    
    .step-card {
      background: #FFF;
      border-radius: 12px;
      padding: 24px;
      margin-bottom: 16px;
      border: 2px solid #E4E7EB;
      transition: border-color 0.2s;
    }
    
    .step-card.focus {
      border-color: #5B8A9A;
      background: #F0F8FA;
      box-shadow: 0 4px 12px rgba(91, 138, 154, 0.15);
    }
    
    .step-header {
      display: flex;
      align-items: center;
      gap: 12px;
      margin-bottom: 16px;
    }
    
    .step-badge {
      padding: 4px 10px;
      background: #E9EEF4;
      color: #192B45;
      border-radius: 4px;
      font-size: 11px;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }
    
    .step-badge.focus {
      background: #5B8A9A;
      color: #FFF;
    }
    
    .step-title {
      font-size: 18px;
      font-weight: 600;
      color: #192B45;
    }
    
    .step-description {
      font-size: 14px;
      color: #556275;
      line-height: 1.6;
      margin-bottom: 20px;
    }
    
    .feedback-form {
      display: flex;
      flex-direction: column;
      gap: 16px;
    }
    
    .form-group label {
      display: block;
      font-size: 12px;
      font-weight: 600;
      color: #556275;
      margin-bottom: 8px;
    }
    
    .form-group textarea,
    .form-group input {
      width: 100%;
      padding: 12px;
      border: 2px solid #E4E7EB;
      border-radius: 6px;
      font-size: 14px;
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
      resize: vertical;
    }
    
    .form-group textarea:focus,
    .form-group input:focus {
      outline: none;
      border-color: #5B8A9A;
    }
    
    .submit-btn {
      padding: 14px 28px;
      background: #2D8A6E;
      color: #FFF;
      border: none;
      border-radius: 8px;
      font-size: 15px;
      font-weight: 600;
      cursor: pointer;
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
      margin-top: 24px;
      transition: background 0.2s;
    }
    
    .submit-btn:hover {
      background: #1E6B54;
    }
    
    .submit-btn:disabled {
      background: #A9B2BE;
      cursor: not-allowed;
    }
    
    .error-box {
      background: #F5E0E3;
      border: 2px solid #B84A5A;
      color: #B84A5A;
      padding: 20px;
      border-radius: 8px;
      text-align: center;
    }
    
    .success-box {
      background: #D4EDE5;
      border: 2px solid #2D8A6E;
      color: #1E6B54;
      padding: 32px;
      border-radius: 12px;
      text-align: center;
    }
    
    .success-box h2 {
      font-size: 24px;
      margin-bottom: 12px;
    }
    
    .loading {
      text-align: center;
      padding: 40px;
      color: #8A95A5;
    }
    
    .loading-spinner {
      width: 40px;
      height: 40px;
      border: 4px solid #E4E7EB;
      border-top-color: #5B8A9A;
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin: 0 auto 16px;
    }
    
    @keyframes spin {
      to { transform: rotate(360deg); }
    }
  </style>
</head>
<body>
  <div class="container" id="app">
    <div class="header">
      <h1>FATHOM</h1>
      <div class="subtitle">Journey Feedback Survey</div>
    </div>
    
    <div id="content">
      <div class="loading" style="margin-top: 24px;">
        <div class="loading-spinner"></div>
        <p>Loading survey...</p>
      </div>
    </div>
  </div>
  
  <script>
    // Supabase configuration - only initialize if not already present
    const SUPABASE_URL = 'https://ktctvaeulualihczwnrl.supabase.co';
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imt0Y3R2YWV1bHVhbGloY3p3bnJsIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njc0MzczNjksImV4cCI6MjA4MzAxMzM2OX0.qnvrAUvUhp3hgu37YnahR0Ql-CKR0zcDt3sKWaMq95I';
    
    let supabaseClient;
    try {
      supabaseClient = window.supabase?.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
    } catch (e) {
      console.log('Supabase not available or already initialized');
      supabaseClient = null;
    }
    
    // Decode survey token from URL
    function decodeSurveyToken() {
      const urlParams = new URLSearchParams(window.location.search);
      const token = urlParams.get('token');
      
      if (!token) {
        return { error: 'No survey token found in URL' };
      }
      
      try {
        const decoded = JSON.parse(atob(token));
        
        // Check if token has expired
        if (decoded.expires && new Date(decoded.expires) < new Date()) {
          return { error: 'This survey link has expired' };
        }
        
        return { success: true, data: decoded };
      } catch (e) {
        return { error: 'Invalid survey token' };
      }
    }
    
    // Load journey data from Supabase or localStorage
    async function loadJourneyData(mapId) {
      // First try Supabase if we have a real mapId and supabase is available
      if (supabaseClient && mapId && mapId !== 'unknown') {
        try {
          const { data, error } = await supabaseClient
            .from('journey_maps')
            .select('config')
            .eq('id', mapId)
            .single();
          
          if (!error && data) {
            console.log('Loaded from Supabase:', data.config.meta?.title);
            return data.config;
          }
        } catch (e) {
          console.log('Supabase fetch failed, trying localStorage:', e);
        }
      }
      
      // Fall back to localStorage
      console.log('Loading from localStorage...');
      const storedMaps = JSON.parse(localStorage.getItem('journeyMaps') || '[]');
      console.log('Found maps in localStorage:', storedMaps.length);
      
      if (storedMaps.length > 0) {
        // If mapId is unknown, use the first map
        if (mapId === 'unknown') {
          console.log('Using first map from localStorage');
          return storedMaps[0];
        }
        // Otherwise try to find the specific map
        const map = storedMaps.find(m => m.meta?.id === mapId);
        return map || storedMaps[0];
      }
      
      console.error('No journey data found');
      return null;
    }
    
    // Find persona label by ID
    function getPersonaLabel(config, personaId) {
      const persona = config.personas?.find(p => p.id === personaId);
      return persona ? persona.label : personaId;
    }
    
    // Render survey
    async function renderSurvey() {
      const result = decodeSurveyToken();
      const content = document.getElementById('content');
      
      if (result.error) {
        content.innerHTML = `
          <div class="error-box" style="margin-top: 24px;">
            <h2>⚠️ Unable to Load Survey</h2>
            <p style="margin-top: 12px; font-size: 14px;">${result.error}</p>
          </div>
        `;
        return;
      }
      
      const { mapId, stepId, personaId, scope, recipientEmail, expires } = result.data;
      
      // Load journey data
      const config = await loadJourneyData(mapId);
      
      if (!config || !config.stages) {
        content.innerHTML = `
          <div class="error-box" style="margin-top: 24px;">
            <h2>⚠️ Journey Not Found</h2>
            <p style="margin-top: 12px; font-size: 14px;">Could not load journey data. The journey may have been deleted or you may need to be logged in.</p>
          </div>
        `;
        return;
      }
      
      // Find the focus step
      let focusStep = null;
      let focusStage = null;
      
      for (const stage of config.stages) {
        const step = stage.steps.find(s => s.id === stepId);
        if (step) {
          focusStep = step;
          focusStage = stage;
          break;
        }
      }
      
      if (!focusStep) {
        content.innerHTML = `
          <div class="error-box" style="margin-top: 24px;">
            <h2>⚠️ Step Not Found</h2>
            <p style="margin-top: 12px; font-size: 14px;">The requested step could not be found in this journey.</p>
            <p style="margin-top: 8px; font-size: 12px; opacity: 0.7;">Looking for step ID: ${stepId}</p>
          </div>
        `;
        return;
      }
      
      // Get all steps for this persona
      const allStepsFlat = config.stages.flatMap(s => 
        s.steps
          .filter(step => step.persona === personaId)
          .map(step => ({ 
            ...step, 
            stageName: s.name,
            stageId: s.id
          }))
      );
      
      // Get steps to display based on scope
      let stepsToDisplay = [];
      
      if (scope === 'step') {
        stepsToDisplay = [{ ...focusStep, stageName: focusStage.name, isFocus: true }];
      } else if (scope === 'context') {
        const focusIndex = allStepsFlat.findIndex(s => s.id === stepId);
        const prevStep = focusIndex > 0 ? allStepsFlat[focusIndex - 1] : null;
        const nextStep = focusIndex < allStepsFlat.length - 1 ? allStepsFlat[focusIndex + 1] : null;
        
        stepsToDisplay = [
          prevStep,
          { ...focusStep, stageName: focusStage.name, isFocus: true },
          nextStep
        ].filter(Boolean);
      } else if (scope === 'full') {
        stepsToDisplay = allStepsFlat.map(s => ({
          ...s,
          isFocus: s.id === stepId
        }));
      }
      
      const personaLabel = getPersonaLabel(config, personaId);
      const journeyTitle = config.meta?.title || 'Journey Map';
      
      // Render the survey
      const infoBannerHTML = `
        <div class="info-banner">
          <h2>Survey Information</h2>
          <div class="info-grid">
            <div class="info-item">
              <div class="info-label">Journey</div>
              <div class="info-value">${journeyTitle}</div>
            </div>
            <div class="info-item">
              <div class="info-label">Your Role</div>
              <div class="info-value">${personaLabel}</div>
            </div>
            <div class="info-item">
              <div class="info-label">Focus Step</div>
              <div class="info-value">${focusStage.name} → ${focusStep.name}</div>
            </div>
            <div class="info-item">
              <div class="info-label">Expires</div>
              <div class="info-value">${new Date(expires).toLocaleDateString()}</div>
            </div>
          </div>
        </div>
      `;
      
      const stepsHTML = stepsToDisplay.map((step, index) => {
        const stepAction = step.actions?.[personaId] || 'No action defined';
        
        return `
        <div class="step-card ${step.isFocus ? 'focus' : ''}" data-step-id="${step.id}">
          <div class="step-header">
            <div class="step-badge ${step.isFocus ? 'focus' : ''}">${step.isFocus ? '→ Focus Step' : step.stageName}</div>
            <div class="step-title">${step.name}</div>
          </div>
          <div class="step-description">${stepAction}</div>
          
          <div class="feedback-form">
            <div class="form-group">
              <label>What actually happens in this step?</label>
              <textarea rows="3" placeholder="Describe what you do in practice..." data-field="description"></textarea>
            </div>
            
            <div class="form-group">
              <label>How long does this typically take? (minutes)</label>
              <input type="number" placeholder="e.g. ${step.duration || 5}" min="0" data-field="timeEstimate" />
            </div>
            
            <div class="form-group">
              <label>What challenges or pain points do you experience?</label>
              <textarea rows="3" placeholder="Any difficulties, delays, or frustrations..." data-field="painPoints"></textarea>
            </div>
            
            <div class="form-group">
              <label>How could this step be improved?</label>
              <textarea rows="2" placeholder="Suggestions for making this easier or faster..." data-field="improvements"></textarea>
            </div>
          </div>
        </div>
      `}).join('');
      
      content.innerHTML = `
        ${infoBannerHTML}
        
        <div style="margin-bottom: 24px;">
          <p style="font-size: 13px; color: #556275; line-height: 1.6;">
            Your feedback will help us improve this process. Please complete the form below for ${scope === 'step' ? 'this step' : scope === 'context' ? 'each step shown' : 'all steps for your role'}.
            ${scope === 'context' ? ' The <strong>highlighted step</strong> is the focus of this survey.' : ''}
          </p>
        </div>
        
        ${stepsHTML}
        
        <button class="submit-btn" onclick="submitSurvey()">Submit Feedback</button>
      `;
    }
    
    // Collect feedback from forms
    function collectFeedback() {
      const stepCards = document.querySelectorAll('.step-card');
      const feedback = [];
      
      stepCards.forEach(card => {
        const stepId = card.getAttribute('data-step-id');
        const fields = {};
        
        card.querySelectorAll('[data-field]').forEach(field => {
          const fieldName = field.getAttribute('data-field');
          fields[fieldName] = field.value;
        });
        
        feedback.push({
          stepId,
          ...fields
        });
      });
      
      return feedback;
    }
    
    // Submit survey
    function submitSurvey() {
      const feedback = collectFeedback();
      const result = decodeSurveyToken();
      
      // In production, this would save to Supabase
      const surveyResponse = {
        token: result.data,
        feedback,
        submittedAt: new Date().toISOString()
      };
      
      console.log('Survey response:', surveyResponse);
      
      // Store in localStorage for now
      const responses = JSON.parse(localStorage.getItem('surveyResponses') || '[]');
      responses.push(surveyResponse);
      localStorage.setItem('surveyResponses', JSON.stringify(responses));
      
      const content = document.getElementById('content');
      content.innerHTML = `
        <div class="success-box" style="margin-top: 24px;">
          <h2>✅ Thank You!</h2>
          <p style="font-size: 15px; margin-top: 12px;">Your feedback has been submitted successfully.</p>
          <p style="font-size: 13px; margin-top: 16px; opacity: 0.8;">
            Your insights will help improve this process. You can now close this window.
          </p>
        </div>
      `;
    }
    
    // Initialize
    renderSurvey();
  </script>
</body>
</html>
