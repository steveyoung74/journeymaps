<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Supabase Connection Test - FATHOM</title>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <style>
    body {
      font-family: monospace;
      padding: 20px;
      background: #1a1a1a;
      color: #0f0;
    }
    .test {
      background: #000;
      border: 1px solid #0f0;
      padding: 10px;
      margin: 10px 0;
    }
    .pass { color: #0f0; }
    .fail { color: #f00; }
    .info { color: #0ff; }
  </style>
</head>
<body>
  <h1>FATHOM Supabase Connection Diagnostics</h1>
  <div id="output"></div>

  <script>
    const output = document.getElementById('output');
    
    function log(message, type = 'info') {
      const div = document.createElement('div');
      div.className = `test ${type}`;
      div.textContent = message;
      output.appendChild(div);
      console.log(message);
    }

    async function runTests() {
      log('Starting Supabase connection tests...', 'info');
      
      // Test 1: DNS Resolution
      log('\n[TEST 1] DNS Resolution Test', 'info');
      try {
        const response = await fetch('https://ktctvaeulualihczwnrl.supabase.co/rest/v1/', {
          method: 'HEAD'
        });
        log('✓ DNS resolves correctly - Status: ' + response.status, 'pass');
      } catch (error) {
        log('✗ DNS resolution failed: ' + error.message, 'fail');
        log('This means your browser cannot reach Supabase servers', 'fail');
        return;
      }

      // Test 2: Supabase Client Creation
      log('\n[TEST 2] Supabase Client Initialization', 'info');
      const SUPABASE_URL = 'https://ktctvaeulualihczwnrl.supabase.co';
      const SUPABASE_ANON_KEY = 'sb_publishable_NlZjP1W6SO7j7jrbv8gARA_HgZlRxLY';
      
      let supabase;
      try {
        supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
        log('✓ Supabase client created successfully', 'pass');
      } catch (error) {
        log('✗ Failed to create Supabase client: ' + error.message, 'fail');
        return;
      }

      // Test 3: Table Access (Read)
      log('\n[TEST 3] Table Read Access', 'info');
      try {
        const { data, error } = await supabase
          .from('survey_responses')
          .select('id')
          .limit(1);
        
        if (error) {
          log('✗ Read failed: ' + error.message, 'fail');
          log('Error details: ' + JSON.stringify(error, null, 2), 'fail');
        } else {
          log('✓ Successfully read from survey_responses table', 'pass');
          log('Found ' + (data?.length || 0) + ' records', 'pass');
        }
      } catch (error) {
        log('✗ Read test exception: ' + error.message, 'fail');
      }

      // Test 4: Table Structure Check
      log('\n[TEST 4] Table Structure Verification', 'info');
      try {
        const { data, error } = await supabase
          .from('survey_responses')
          .select('*')
          .limit(1);
        
        if (error) {
          log('✗ Structure check failed: ' + error.message, 'fail');
        } else {
          if (data && data.length > 0) {
            const columns = Object.keys(data[0]);
            log('✓ Table columns: ' + columns.join(', '), 'pass');
          } else {
            log('⚠ Table exists but is empty', 'info');
          }
        }
      } catch (error) {
        log('✗ Structure check exception: ' + error.message, 'fail');
      }

      // Test 5: Write Permission Test
      log('\n[TEST 5] Table Write Access (Insert Test)', 'info');
      const testData = {
        map_id: null,
        step_id: 'test-diagnostic-' + Date.now(),
        persona_id: 'test-persona',
        respondent_email: 'diagnostic@test.com',
        scope: 'test',
        description: 'Diagnostic test entry',
        time_estimate: 1,
        pain_points: null,
        improvements: null,
        review_status: 'pending',
        submitted_at: new Date().toISOString()
      };

      try {
        const { data, error } = await supabase
          .from('survey_responses')
          .insert([testData])
          .select();
        
        if (error) {
          log('✗ Insert failed: ' + error.message, 'fail');
          log('Error code: ' + error.code, 'fail');
          log('Error details: ' + JSON.stringify(error, null, 2), 'fail');
          
          if (error.code === '42501') {
            log('⚠ This is a permissions error - RLS policy might be blocking inserts', 'fail');
          }
        } else {
          log('✓ Successfully inserted test record', 'pass');
          log('Inserted ID: ' + data[0].id, 'pass');
          
          // Clean up - delete the test record
          const { error: deleteError } = await supabase
            .from('survey_responses')
            .delete()
            .eq('id', data[0].id);
          
          if (!deleteError) {
            log('✓ Test record cleaned up', 'pass');
          }
        }
      } catch (error) {
        log('✗ Insert test exception: ' + error.message, 'fail');
      }

      log('\n=== TESTS COMPLETE ===', 'info');
      log('If all tests passed, the survey form should work.', 'info');
      log('If any failed, check the error messages above.', 'info');
    }

    // Run tests on page load
    runTests();
  </script>
</body>
</html>
