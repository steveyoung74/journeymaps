<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, viewport-fit=cover">
  <title>FATHOM - Journey Intelligence</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Open+Sans:wght@400;500;600;700&display=swap" rel="stylesheet">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/react/18.2.0/umd/react.production.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/react-dom/18.2.0/umd/react-dom.production.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/babel-standalone/7.23.5/babel.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <style>
    /* Interstate Font Family - Brand/Display Font */
    @font-face {
      font-family: 'Interstate';
      src: url('https://steveyoung74.github.io/journeymaps/fonts/Interstate-light.ttf') format('truetype');
      font-weight: 300;
      font-style: normal;
      font-display: swap;
    }
    @font-face {
      font-family: 'Interstate';
      src: url('https://steveyoung74.github.io/journeymaps/fonts/Interstate-regular.ttf') format('truetype');
      font-weight: 400;
      font-style: normal;
      font-display: swap;
    }
    @font-face {
      font-family: 'Interstate';
      src: url('https://steveyoung74.github.io/journeymaps/fonts/Interstate-bold.ttf') format('truetype');
      font-weight: 700;
      font-style: normal;
      font-display: swap;
    }
    @font-face {
      font-family: 'Interstate Condensed';
      src: url('https://steveyoung74.github.io/journeymaps/fonts/Interstate-boldcondensed.ttf') format('truetype');
      font-weight: 700;
      font-style: normal;
      font-display: swap;
    }
    
    /* CSS Custom Properties - Fathom Color Palette */
    :root {
      /* Font Families */
      --font-display: 'Interstate', -apple-system, BlinkMacSystemFont, sans-serif;
      --font-body: 'Open Sans', -apple-system, BlinkMacSystemFont, sans-serif;
      
      /* Navy Scale */
      --navy-950: #0C1620;
      --navy-900: #111E2E;
      --navy-800: #15243A;
      --navy-700: #192B45;
      --navy-600: #243D5C;
      --navy-500: #2F5070;
      --navy-400: #456A8A;
      --navy-300: #6889A8;
      --navy-200: #9BB1C7;
      --navy-100: #C8D5E2;
      --navy-50: #E9EEF4;
      
      /* Steel Blue Accent */
      --steel-700: #3A6070;
      --steel-600: #4A7485;
      --steel-500: #5B8A9A;
      --steel-400: #74A0AE;
      --steel-300: #96BCC7;
      --steel-200: #BDD6DE;
      --steel-100: #E1EEF2;
      
      /* Warm Accent (Amber) */
      --amber-700: #8B6914;
      --amber-600: #A67C1A;
      --amber-500: #C4942A;
      --amber-400: #D4AA4D;
      --amber-300: #E4C87A;
      --amber-200: #F0DDA8;
      --amber-100: #FAF0D6;
      
      /* Semantic Colors */
      --success: #2D8A6E;
      --success-light: #D4EDE5;
      --warning: #C4942A;
      --warning-light: #FAF0D6;
      --error: #B84A5A;
      --error-light: #F5E0E3;
      --info: #5B8A9A;
      --info-light: #E1EEF2;
      
      /* Slate Neutrals */
      --slate-900: #1A2332;
      --slate-800: #2A3544;
      --slate-700: #3D4A5C;
      --slate-600: #556275;
      --slate-500: #6E7B8C;
      --slate-400: #8A95A5;
      --slate-300: #A9B2BE;
      --slate-200: #C8CED6;
      --slate-100: #E4E7EB;
      --slate-50: #F4F5F7;
      
      /* Surfaces */
      --surface-bg: #FFFFFF;
      --surface-1: #F4F5F7;
      --surface-2: #E9EEF4;
      --surface-3: #C8D5E2;
    }
    
    * { box-sizing: border-box; margin: 0; padding: 0; }
    html {
      overflow-x: hidden;
      width: 100%;
      
    }
    body { 
      font-family: var(--font-body); 
      color: var(--slate-900); 
      overflow-x: hidden;
      width: 100%;
      max-width: 100vw;
    }
    
    /* Typography - Display font for headings */
    h1, h2, h3, h4, h5, h6 {
      font-family: var(--font-display);
    }
    
    /* Modal animations */
    .dashboard-modal-overlay {
      opacity: 0;
      animation: modalFadeIn 0.2s ease forwards;
    }
    .dashboard-modal-content {
      transform: translateY(20px);
      animation: modalSlideUp 0.3s ease forwards;
    }
    @keyframes modalFadeIn {
      to { opacity: 1; }
    }
    @keyframes modalSlideUp {
      to { transform: translateY(0); }
    }
    
    /* Loading Animation - Sinking into depths */
    @keyframes sinkIntoDepths {
      0% {
        transform: translateY(-100px);
        opacity: 0;
      }
      8% {
        opacity: 0.85;
      }
      85% {
        opacity: 0.12;
      }
      100% {
        transform: translateY(120px);
        opacity: 0;
      }
    }
    
    .loading-screen {
      min-height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
      /* Very smooth gradient with many stops to reduce banding */
      background: linear-gradient(
        180deg, 
        #2B4358 0%,
        #28404F 10%,
        #253D49 20%,
        #233A44 30%,
        #20373F 40%,
        #1E343A 50%,
        #1C3136 60%,
        #1A2E32 70%,
        #182B2E 80%,
        #16282A 90%,
        #142526 100%
      );
      position: relative;
      overflow: hidden;
    }
    
    /* Noise texture to break up any remaining banding */
    .loading-screen::before {
      content: '';
      position: absolute;
      inset: 0;
      opacity: 0.15;
      pointer-events: none;
      background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='300' height='300'%3E%3Cfilter id='n' x='0' y='0'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.75' numOctaves='4' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='300' height='300' filter='url(%23n)' opacity='1'/%3E%3C/svg%3E");
    }
    
    .loading-logo {
      height: 40px;
      animation: sinkIntoDepths 5s ease-in-out infinite;
      position: relative;
      z-index: 1;
    }
    
    /* Main app background with topographic pattern */
    /* Topographic pattern as fixed background layer */
    .topo-background {
      position: fixed;
      inset: 0;
      background: linear-gradient(135deg, #F4F5F7 0%, #E9EEF4 100%);
      z-index: -1;
    }
    .topo-background::before {
      content: '';
      position: absolute;
      inset: 0;
      background: url('topography-light.svg') center/600px 600px repeat;
      opacity: 1;
      pointer-events: none;
    }
    
    /* Main app container - no pattern here */
    .app-bg {
      position: relative;
      z-index: 1;
      overflow-x: hidden;
    }
    
    /* Header must sit above everything */
    .header-container {
      position: relative;
      z-index: 10;
    }
    
    /* Stats bar - solid white, no pattern */
    .stats-bar {
      position: relative;
      z-index: 5;
      background: #FFF !important;
      box-shadow: 0 1px 3px rgba(0,0,0,0.05);
    }
    
    /* Stage cards - solid white, no pattern */
    .stage-card {
      position: relative;
      z-index: 2;
      background: #FFF !important;
      box-shadow: 0 4px 16px rgba(0,0,0,0.1) !important;
      overflow: visible !important;
    }
    
    /* Dropdown menus - solid backgrounds */
    .dropdown-menu, .settings-dropdown {
      background: #FFF !important;
    }
    
    /* Detail panel - solid background */
    .detail-panel {
      background: #FFF !important;
    }
    
    /* Dark screen background with topographic pattern */
    .dark-bg {
      position: relative;
    }
    .dark-bg::before {
      content: '';
      position: absolute;
      inset: 0;
      background: url('topography-dark.svg') center/600px 600px repeat;
      opacity: 1;
      pointer-events: none;
      z-index: 0;
    }
    .dark-bg > * {
      position: relative;
      z-index: 1;
    }
    ::-webkit-scrollbar { height: 8px; width: 8px; }
    ::-webkit-scrollbar-track { background: var(--slate-100); }
    ::-webkit-scrollbar-thumb { background: var(--slate-300); border-radius: 4px; }
    ::-webkit-scrollbar-thumb:hover { background: var(--slate-400); }
    .tooltip { position: relative; }
    .tooltip:hover::after {
      content: attr(data-tooltip);
      position: absolute;
      bottom: 100%;
      left: 50%;
      transform: translateX(-50%);
      background: var(--navy-700);
      color: #FFF;
      padding: 10px 14px;
      border-radius: 6px;
      font-size: 12px;
      white-space: normal;
      width: 420px;
      max-width: 420px;
      z-index: 9999;
      font-family: var(--font-body);
      line-height: 1.5;
      text-align: left;
      box-shadow: 0 4px 12px rgba(25, 43, 69, 0.25);
      margin-bottom: 8px;
      pointer-events: none;
    }
    .tooltip:hover::before {
      content: '';
      position: absolute;
      bottom: 100%;
      left: 50%;
      transform: translateX(-50%);
      border: 6px solid transparent;
      border-top-color: var(--navy-700);
      margin-bottom: -4px;
      z-index: 9999;
      pointer-events: none;
    }
    .step-card:hover {
      z-index: 1050 !important;
    }
    
    /* Edge-to-edge horizontal scrolling */
    .stages-container {
      margin-left: -40px !important;
      margin-right: -40px !important;
      padding-left: 40px !important;
      padding-right: 40px !important;
      width: calc(100% + 80px) !important;
      scroll-padding-left: 40px;
      scroll-padding-right: 40px;
    }
    
    /* Fade hint at edges to show scrollability */
    .scroll-container-wrapper {
      position: relative;
    }
    .scroll-container-wrapper::before,
    .scroll-container-wrapper::after {
      content: '';
      position: absolute;
      top: 0;
      bottom: 20px;
      width: 40px;
      pointer-events: none;
      z-index: 10;
      opacity: 0;
      transition: opacity 0.2s;
    }
    .scroll-container-wrapper::before {
      left: 0;
      background: linear-gradient(to right, var(--slate-50), transparent);
    }
    .scroll-container-wrapper::after {
      right: 0;
      background: linear-gradient(to left, var(--slate-50), transparent);
    }
    .scroll-container-wrapper.can-scroll-left::before,
    .scroll-container-wrapper.can-scroll-right::after {
      opacity: 1;
    }
    
    /* Dashboard Modal - hide title text on tight screens */
    @media (max-width: 480px) {
      .dashboard-title-text {
        display: none !important;
      }
    }
    
    /* Dashboard Modal - full screen on mobile */
    @media (max-width: 768px) {
      .dashboard-modal-overlay {
        padding: 0 !important;
        align-items: stretch !important;
        justify-content: stretch !important;
      }
      .dashboard-modal-content {
        max-height: none !important;
        height: 100% !important;
        border-radius: 0 !important;
        width: 100% !important;
        max-width: none !important;
      }
    }
    
    /* iOS safe area support for dashboard */
    @supports (padding-top: env(safe-area-inset-top)) {
      @media (max-width: 768px) {
        .dashboard-modal-content {
          padding-bottom: env(safe-area-inset-bottom);
        }
      }
    }
    
    /* Cost Analysis Dashboard Mobile Responsive */
    @media (max-width: 768px) {
      .cost-analysis-panel {
        padding: 16px !important;
      }
      .cost-analysis-grid {
        display: flex !important;
        flex-direction: column !important;
      }
      .cost-analysis-grid > div {
        grid-column: auto !important;
      }
      .cost-summary-cards {
        grid-template-columns: 1fr 1fr !important;
      }
      .cost-automation-grid {
        grid-template-columns: 1fr !important;
      }
      .cost-automation-section {
        grid-column: auto !important;
      }
    }
    
    @media (max-width: 480px) {
      .cost-summary-cards {
        grid-template-columns: 1fr !important;
      }
    }
    
    /* Improvement Plan Mobile Responsive */
    @media (max-width: 900px) {
      .plan-phase-cards {
        grid-template-columns: 1fr !important;
      }
      .plan-item-grid {
        grid-template-columns: 1fr !important;
        gap: 12px !important;
      }
      .plan-item-controls {
        display: flex !important;
        flex-wrap: wrap !important;
        gap: 8px !important;
      }
    }
    
    /* Mobile Responsive Styles */
    @media (max-width: 768px) {
      /* Perspective filter: show dropdown, hide buttons */
      .perspective-buttons {
        display: none !important;
      }
      .perspective-dropdown {
        display: block !important;
      }
      .perspective-filter {
        padding: 12px 16px !important;
      }
      
      /* Header */
      .header-container {
        padding: 16px !important;
        gap: 12px !important;
      }
      
      .header-logo-title {
        flex-wrap: wrap !important;
        gap: 8px 12px !important;
      }
      
      .header-logo-title .header-title-wrapper {
        flex-basis: 100% !important;
        order: 2 !important;
      }
      
      .header-divider {
        display: none !important;
      }
      
      .header-logo-title svg {
        width: 90px !important;
        height: auto !important;
      }
      
      .header-logo-title h1 {
        font-size: 20px !important;
      }
      
      /* View toggle buttons */
      .header-buttons {
        gap: 6px !important;
      }
      
      .header-buttons button {
        padding: 7px 10px !important;
        font-size: 11px !important;
      }
      
      /* Stats bar */
      .stats-bar {
        padding: 8px 16px !important;
        gap: 12px !important;
        flex-wrap: wrap !important;
      }
      
      .stats-bar > div {
        min-width: auto !important;
      }
      
      /* Main content - keep horizontal scroll */
      .main-content {
        padding: 20px 16px !important;
      }
      
      /* Adjust edge-to-edge for mobile padding */
      .stages-container {
        margin-left: -16px !important;
        margin-right: -16px !important;
        padding-left: 16px !important;
        padding-right: 16px !important;
        width: calc(100% + 32px) !important;
        scroll-padding-left: 16px;
        scroll-padding-right: 16px;
      }
      
      .scroll-container-wrapper::before,
      .scroll-container-wrapper::after {
        width: 24px;
      }
    }
    
    /* Small mobile */
    @media (max-width: 480px) {
      .header-logo-title svg {
        width: 80px !important;
      }
      
      .header-logo-title h1 {
        font-size: 18px !important;
      }
      
      .header-buttons button {
        padding: 6px 8px !important;
        font-size: 10px !important;
      }
      
      .stats-bar > div {
        min-width: auto !important;
      }
    }
    
    /* Print Styles */
    @media print {
      body { 
        font-size: 10pt;
        -webkit-print-color-adjust: exact !important;
        print-color-adjust: exact !important;
      }
      
      .no-print { display: none !important; }
      
      .print-break-before { page-break-before: always; }
      .print-break-after { page-break-after: always; }
      .print-avoid-break { page-break-inside: avoid; }
      
      /* Header adjustments */
      header { 
        background: #192B45 !important;
        padding: 12px 24px !important;
      }
      
      /* Hide interactive elements */
      button:not(.print-show), 
      .edit-controls,
      [data-hide-print="true"] { 
        display: none !important; 
      }
      
      /* Step cards - ensure colors print */
      .step-card {
        -webkit-print-color-adjust: exact !important;
        print-color-adjust: exact !important;
        page-break-inside: avoid;
      }
      
      /* Ensure backgrounds print */
      * {
        -webkit-print-color-adjust: exact !important;
        print-color-adjust: exact !important;
      }
      
      /* Timeline section */
      .timeline-section {
        page-break-before: always;
        margin-top: 20px;
      }
      
      /* Footer */
      footer {
        position: fixed;
        bottom: 0;
        left: 0;
        right: 0;
        padding: 8px 24px !important;
        font-size: 9pt;
        border-top: 1px solid #A9B2BE;
        background: #f9f9f9 !important;
      }
    }
    
    /* Refresh button spin animation */
    @keyframes spin {
      from { transform: rotate(0deg); }
      to { transform: rotate(360deg); }
    }
    .refresh-spinning {
      animation: spin 1s linear infinite;
      display: inline-block;
    }
    
    /* Smooth transitions for interactive elements */
    .step-item {
      transition: background 0.3s ease, border 0.3s ease, margin 0.3s ease, box-shadow 0.3s ease;
    }
    .step-item:hover {
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }
    .fade-in {
      animation: fadeIn 0.3s ease;
    }
    @keyframes fadeIn {
      from { opacity: 0; }
      to { opacity: 1; }
    }
    .cost-value {
      transition: opacity 0.3s ease;
    }
    .funnel-stat {
      transition: opacity 0.3s ease, transform 0.3s ease;
    }
    .ranking-badge {
      animation: popIn 0.3s ease;
    }
    @keyframes popIn {
      from { transform: scale(0); opacity: 0; }
      to { transform: scale(1); opacity: 1; }
    }
    .view-container {
      animation: fadeIn 0.25s ease;
    }
    .savings-panel {
      animation: slideDown 0.3s ease;
    }
    @keyframes slideDown {
      from { opacity: 0; transform: translateY(-10px); }
      to { opacity: 1; transform: translateY(0); }
    }
    .slide-in-right {
      animation: slideInRight 0.3s ease;
    }
    .slide-in-right-delay-1 {
      animation: slideInRight 0.3s ease 0.1s both;
    }
    .slide-in-right-delay-2 {
      animation: slideInRight 0.3s ease 0.2s both;
    }
    @keyframes slideInRight {
      from { opacity: 0; transform: translateX(20px); }
      to { opacity: 1; transform: translateX(0); }
    }
  </style>
</head>
<body>
  <div id="root"></div>
  
  <script type="text/babel">
    const { useState, useCallback, useMemo, useEffect, useRef } = React;
    
    // Current app version - always displayed in footer
    const APP_VERSION = "9.14.0";
    
    // ============================================
    // SUPABASE CONFIGURATION
    // ============================================
    const SUPABASE_URL = 'https://ktctvaeulualihczwnrl.supabase.co';
    const SUPABASE_ANON_KEY = 'sb_publishable_NlZjP1W6SO7j7jrbv8gARA_HgZlRxLY';
    
    const supabase = window.supabase?.createClient(SUPABASE_URL, SUPABASE_ANON_KEY, {
      auth: {
        persistSession: true,
        autoRefreshToken: true,
        detectSessionInUrl: true,
        storage: window.localStorage,
        flowType: 'implicit'
      }
    });
    
    if (supabase) {
      console.log('Supabase client initialized (editor)');
    }
    
    // ============================================
    // SURVEY TOKEN & EMAIL UTILITIES
    // ============================================
    
    // Generate a unique survey token
    const generateSurveyToken = () => {
      const timestamp = Date.now().toString(36);
      const random = Math.random().toString(36).substring(2, 15);
      return `survey_${timestamp}_${random}`;
    };
    
    // Encode survey parameters into a token
    const encodeSurveyToken = (params) => {
      try {
        const jsonString = JSON.stringify(params);
        return btoa(jsonString); // Base64 encode
      } catch (e) {
        console.error('Failed to encode survey token:', e);
        return null;
      }
    };
    
    // Generate survey URL with token
    const generateSurveyUrl = (mapId, stepId, personaId, scope, recipientEmail) => {
      const token = encodeSurveyToken({
        mapId,
        stepId,
        personaId,
        scope,
        recipientEmail,
        expires: new Date(Date.now() + 14 * 24 * 60 * 60 * 1000).toISOString() // 14 days
      });
      
      const baseUrl = window.location.origin;
      return `${baseUrl}/survey-response.html?token=${token}`;
    };
    
    // Send survey request emails
    const sendSurveyEmails = async (surveyRequest, mapId, config) => {
      const { recipients, stepName, stageName, personaLabel, scope, message, journeyTitle } = surveyRequest;
      
      const emailPromises = recipients.map(async (recipient) => {
        const surveyUrl = generateSurveyUrl(mapId, surveyRequest.stepId, surveyRequest.personaId, scope, recipient.email);
        
        // Prepare email content
        const emailSubject = `Feedback requested: ${journeyTitle} - ${stepName}`;
        const emailBody = `
Hi ${recipient.name},

Your feedback has been requested on the following process step:

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
${journeyTitle}
${stageName} → ${stepName}

Your role: ${personaLabel}
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

${message ? message + '\n\n' : ''}This survey focuses on your experience with this specific step${scope === 'context' ? ', with surrounding steps shown for context' : scope === 'full' ? ', showing all steps for your role' : ''}. Your insights will help improve our processes.

Complete Survey: ${surveyUrl}

This link expires in 14 days.

───────────────────────────────────────────
Powered by FATHOM
        `.trim();
        
        // For now, we'll use mailto: link to open email client
        // In production, this would call a backend API to send via Resend/SendGrid
        return {
          recipient: recipient.email,
          subject: emailSubject,
          body: emailBody,
          surveyUrl,
          mailto: `mailto:${recipient.email}?subject=${encodeURIComponent(emailSubject)}&body=${encodeURIComponent(emailBody)}`
        };
      });
      
      return Promise.all(emailPromises);
    };
    
    // Backend email sending (for future implementation)
    const sendEmailViaBackend = async (emailData) => {
      // This would call your Supabase Edge Function or external API
      // Example:
      // const response = await fetch('/api/send-survey-email', {
      //   method: 'POST',
      //   headers: { 'Content-Type': 'application/json' },
      //   body: JSON.stringify(emailData)
      // });
      // return response.json();
      
      console.log('Email would be sent via backend:', emailData);
      return { success: true, emailData };
    };
    
    // Fathom official taglines (per Brand Lock v1.0)
    const FATHOM_TAGLINES = [
      "See what your journeys really cost",
      "Understand deeply. Improve decisively."
    ];
    
    // Stage colors - brand-aligned vibrant palette for visual differentiation
    const STAGE_COLORS = [
      { base: '#5B8A9A', light: '#96BCC7', dark: '#3A6070' },  // Steel Blue
      { base: '#456A8A', light: '#6889A8', dark: '#2F5070' },  // Navy 400
      { base: '#5A5B8A', light: '#8A8BB0', dark: '#3D3D6A' },  // Indigo
      { base: '#B84A5A', light: '#D4848F', dark: '#8A3644' },  // Rose
      { base: '#C4942A', light: '#E4C87A', dark: '#8B6914' },  // Amber
      { base: '#2D8A6E', light: '#74B89E', dark: '#1E6B54' },  // Teal
      { base: '#9A6B5B', light: '#C4A090', dark: '#6B4A3D' },  // Copper
      { base: '#6889A8', light: '#9BB1C7', dark: '#456A8A' },  // Navy 300
    ];
    
    // Helper to get stage color (cycles through palette)
    const getStageColor = (index, variant = 'base') => {
      const color = STAGE_COLORS[index % STAGE_COLORS.length];
      return color[variant] || color.base;
    };

    const generateId = () => Math.random().toString(36).substr(2, 9);

    // Rotating tagline component
    function FathomTagline() {
      const [index, setIndex] = useState(0);
      const [fade, setFade] = useState(true);
      
      useEffect(() => {
        const interval = setInterval(() => {
          setFade(false);
          setTimeout(() => {
            setIndex(i => (i + 1) % FATHOM_TAGLINES.length);
            setFade(true);
          }, 300);
        }, 6000); // 6 seconds between taglines
        return () => clearInterval(interval);
      }, []);
      
      return (
        <span style={{ 
          fontSize: '10px', 
          color: 'rgba(255,255,255,0.5)', 
          fontFamily: "'Interstate', sans-serif",
          fontStyle: 'italic',
          marginTop: '4px',
          transition: 'opacity 0.3s ease',
          opacity: fade ? 1 : 0
        }}>
          {FATHOM_TAGLINES[index]}
        </span>
      );
    }
    
    // Fathom Icon component - 3D Isometric Contour Strata
    function FathomIcon({ size = 32 }) {
      return (
        <svg width={size} height={size} viewBox="0 0 64 64" fill="none" xmlns="http://www.w3.org/2000/svg">
          <path d="M8 20 L32 8 L56 20 L56 52 L32 64 L8 52 Z" fill="#1A3A4A"/>
          <path d="M8 48 Q20 52 32 48 Q44 44 56 48 L56 52 L32 64 L8 52 Z" fill="#1A3A4A"/>
          <path d="M8 48 Q20 52 32 48 Q44 44 56 48" stroke="#2A4A5A" strokeWidth="1" fill="none"/>
          <path d="M8 40 Q20 36 32 40 Q44 44 56 40 L56 48 Q44 44 32 48 Q20 52 8 48 Z" fill="#243F4D"/>
          <path d="M8 40 Q20 36 32 40 Q44 44 56 40" stroke="#3A5A6A" strokeWidth="1" fill="none"/>
          <path d="M8 32 Q20 36 32 32 Q44 28 56 32 L56 40 Q44 44 32 40 Q20 36 8 40 Z" fill="#2D4D5D"/>
          <path d="M8 32 Q20 36 32 32 Q44 28 56 32" stroke="#4A6A7A" strokeWidth="1" fill="none"/>
          <path d="M8 24 Q20 28 32 24 Q44 20 56 24 L56 32 Q44 28 32 32 Q20 36 8 32 Z" fill="#3A5D6D"/>
          <path d="M8 24 Q20 28 32 24 Q44 20 56 24" stroke="#5A7A8A" strokeWidth="1" fill="none"/>
          <path d="M8 16 L32 4 L56 16 L56 24 Q44 20 32 24 Q20 28 8 24 Z" fill="#5B8A9A"/>
          <path d="M8 16 L32 4 L56 16" stroke="#6A9AAA" strokeWidth="1" fill="none"/>
          <path d="M8 16 L32 4 L56 16 Q44 20 32 16 Q20 12 8 16 Z" fill="#6A9AAA"/>
        </svg>
      );
    }

    // Sample configuration JSON
    // __CONFIG_START__
    const defaultConfig = {
      meta: {
        title: "Client Onboarding Journey Digital Twin",
        version: "2.0",
        product: "FATHOM v9.5.0",
        lastUpdated: new Date().toISOString(),
        audience: "Internal Operations",
        perspective: "client",
        owner: "",
        costModel: "per-journey",
        eventConfig: null
      },
      funnel: {
        enabled: true,
        initialVolume: 2042,
        periodLabel: "Feb - Dec 2025"
      },
      personas: [
        { id: "client", label: "Client", color: "#2D8A6E", annualSalary: 0, isExternal: true },
        { id: "fp", label: "Financial Planner", color: "#9A6B5B", annualSalary: 75000, burdenMultiplier: 1.3, workspaceHourlyCost: 6.5, isExternal: false },
        { id: "im", label: "Investment Manager", color: "#456A8A", annualSalary: 80000, burdenMultiplier: 1.3, workspaceHourlyCost: 6, isExternal: false },
        { id: "ops", label: "Operations", color: "#5A5B8A", annualSalary: 25000, burdenMultiplier: 1.3, workspaceHourlyCost: 6.5, isExternal: false },
        { id: "administrator", label: "FP Administrator", color: "#9A6B5B", annualSalary: 35000, burdenMultiplier: 1.3, workspaceHourlyCost: 7, isExternal: false },
        { id: "compliance", label: "Compliance", color: "#B84A5A", annualSalary: 55000, burdenMultiplier: 1.3, workspaceHourlyCost: 6, isExternal: false },
        { id: "paraplanner", label: "Paraplanner", color: "#C4942A", annualSalary: 45000, burdenMultiplier: 1.3, workspaceHourlyCost: 6, isExternal: false },
        { id: "new-business-exec", label: "New Business Exec", color: "#5B8A9A", annualSalary: 25000, burdenMultiplier: 1.3, workspaceHourlyCost: 6, isExternal: false },
        { id: "im-adminitrator", label: "IM Adminitrator", color: "#456A8A", annualSalary: 35000, burdenMultiplier: 1.3, workspaceHourlyCost: 6, isExternal: false }
      ],
      stages: [
        {
          id: "lead-receipt",
          name: "Lead Receipt",
          dropOffCount: 0,
          steps: [
            {
              id: "triage",
              name: "Triage",
              description: "Initial assessment of incoming prospect enquiries",
              timeMinutes: 5,
              owner: "new-business-exec",
              touchpoints: ["CRM", "Email"],
              painPoints: [],
              emotions: "neutral",
              frictionScore: 1,
              automationOpportunity: "high",
              automationNotes: "Could be automated with AI triage system",
              regulatoryRequirements: [],
              roleInvolvement: {
                fp: { timeMinutes: 0, headcount: 1 },
                im: { timeMinutes: 0, headcount: 1 },
                ops: { timeMinutes: 0, headcount: 1 },
                "new-business-exec": { timeMinutes: 10, headcount: 1 }
              },
              actions: {
                ops: "",
                "new-business-exec": "Reviews and categorises incoming enquiries",
                client: "Inputs information into our contact form"
              },
              clientTouchpoint: true
            },
            {
              id: "fast-track",
              name: "Fast Track",
              description: "Determine if client has provided enough information to directly contact FP to check availability for immediate call",
              timeMinutes: 10,
              owner: "new-business-exec",
              touchpoints: ["CRM", "Phone", "Email"],
              painPoints: [],
              emotions: "hopeful",
              frictionScore: 2,
              automationOpportunity: "high",
              automationNotes: "AI could assess client information completeness and check FP calendar availability automatically",
              regulatoryRequirements: [],
              roleInvolvement: {
                fp: { timeMinutes: 0, headcount: 1 },
                im: { timeMinutes: 0, headcount: 1 },
                ops: { timeMinutes: 0, headcount: 1 },
                "new-business-exec": { timeMinutes: 10, headcount: 1 }
              },
              actions: {
                ops: "",
                "new-business-exec": "Assesses client information quality, checks FP availability, routes accordingly"
              }
            }
          ]
        },
        {
          id: "opportunity-qualification",
          name: "Opportunity Qualification",
          dropOffCount: 408,
          steps: [
            {
              id: "initial-call",
              name: "Initial Call",
              description: "First contact call with prospect",
              timeMinutes: 20,
              owner: "new-business-exec",
              touchpoints: ["Phone"],
              painPoints: [],
              emotions: "curious",
              frictionScore: 2,
              automationOpportunity: "low",
              automationNotes: "Human interaction important for first contact",
              regulatoryRequirements: [],
              clientTouchpoint: true,
              roleInvolvement: {
                fp: { timeMinutes: 0, headcount: 1 },
                im: { timeMinutes: 0, headcount: 1 },
                ops: { timeMinutes: 0, headcount: 1 },
                "new-business-exec": { timeMinutes: 15, headcount: 1 }
              },
              actions: {
                ops: "",
                "new-business-exec": "Conducts initial call, gathers basic information, listens to client carefully",
                client: "Answers questions and describes the outcome they want"
              }
            },
            {
              id: "update-systems",
              name: "Update Excel, Xplan etc",
              description: "Update CRM and planning systems with prospect details",
              timeMinutes: 12,
              owner: "new-business-exec",
              touchpoints: ["Xplan", "Excel", "CRM"],
              painPoints: ["Manual data entry across multiple systems"],
              emotions: "neutral",
              frictionScore: 2,
              automationOpportunity: "high",
              automationNotes: "System integration could eliminate duplicate entry, looking to implement Evaluagent to transcribe the call information into Xplan",
              regulatoryRequirements: [],
              roleInvolvement: {
                fp: { timeMinutes: 0, headcount: 1 },
                im: { timeMinutes: 0, headcount: 1 },
                ops: { timeMinutes: 0, headcount: 1 },
                "new-business-exec": { timeMinutes: 12, headcount: 1 }
              },
              actions: {
                ops: "",
                "new-business-exec": "Updates all relevant systems with prospect information"
              }
            },
            {
              id: "review-prospect-email",
              name: "Review Prospect Email",
              description: "FP and IM review prospect communications",
              timeMinutes: 20,
              owner: "fp",
              touchpoints: ["Email"],
              painPoints: [],
              emotions: "curious",
              frictionScore: 2,
              automationOpportunity: "medium",
              automationNotes: "AI could summarise and flag key points",
              regulatoryRequirements: [],
              roleInvolvement: {
                fp: { timeMinutes: 10, headcount: 1 },
                im: { timeMinutes: 10, headcount: 1 },
                ops: { timeMinutes: 0, headcount: 1 }
              },
              actions: {
                fp: "Reviews prospect email and requirements",
                im: "Reviews prospect email for investment needs"
              }
            },
            {
              id: "prospect-call",
              name: "Prospect Call",
              description: "Detailed discovery call with prospect",
              timeMinutes: 90,
              owner: "fp",
              touchpoints: ["Phone", "Teams"],
              painPoints: ["Scheduling can be difficult"],
              emotions: "engaged",
              frictionScore: 3,
              automationOpportunity: "low",
              automationNotes: "Human interaction essential",
              regulatoryRequirements: ["Record keeping"],
              clientTouchpoint: true,
              roleInvolvement: {
                fp: { timeMinutes: 45, headcount: 1 },
                im: { timeMinutes: 45, headcount: 1 },
                ops: { timeMinutes: 0, headcount: 1 }
              },
              actions: {
                fp: "Conducts discovery call, understands financial goals",
                im: "Discusses investment approach and philosophy"
              }
            },
            {
              id: "update-xplan-triage",
              name: "Update Xplan Task (Triage)",
              description: "Update Xplan with triage outcome and next steps",
              timeMinutes: 20,
              owner: "fp",
              touchpoints: ["Xplan"],
              painPoints: [],
              emotions: "neutral",
              frictionScore: 2,
              automationOpportunity: "high",
              automationNotes: "Could auto-populate from call notes",
              regulatoryRequirements: [],
              roleInvolvement: {
                fp: { timeMinutes: 10, headcount: 1 },
                im: { timeMinutes: 10, headcount: 1 },
                ops: { timeMinutes: 0, headcount: 1 }
              },
              actions: {
                fp: "Updates Xplan with triage notes",
                im: "Adds investment-related notes"
              }
            }
          ]
        },
        {
          id: "fact-find-collateral",
          name: "Fact Find & Collateral Gathering",
          dropOffCount: 833,
          steps: [
            {
              id: "tax-residency",
              name: "Tax Residency Self Cert & GDPR",
              description: "Complete tax residency self-certification and GDPR",
              timeMinutes: 15,
              owner: "fp",
              touchpoints: ["Forms"],
              painPoints: ["Clients confused by tax questions", "No clear details of downstream impact on other processes"],
              emotions: "uncertain",
              frictionScore: 2,
              automationOpportunity: "high",
              automationNotes: "Digital forms with guidance, validation and automated triggers for downstream processes",
              regulatoryRequirements: ["CRS/FATCA requirements"],
              roleInvolvement: {
                fp: { timeMinutes: 0, headcount: 1 },
                im: { timeMinutes: 0, headcount: 1 },
                ops: { timeMinutes: 0, headcount: 1 },
                administrator: { timeMinutes: 15, headcount: 1 }
              },
              actions: {
                fp: "",
                im: "",
                client: "Completes or provides the information required by this form",
                administrator: "1, Sends the form to the client via adobe sign to complete and sign.\n2, Once completed, saves form to the clients GNL."
              },
              clientTouchpoint: true,
              isHardCheckpoint: true,
              checkpointType: "compliance",
              checkpointDetails: "Clients must have access to our Privacy Policy before we do ID&V / Screening\n"
            },
            {
              id: "idv",
              name: "ID&V",
              description: "Identity and verification checks",
              timeMinutes: 37,
              owner: "ops",
              touchpoints: ["Refinitiv Platform"],
              painPoints: ["Manual process to trigger ID&V", "Manual Process to copy across from xplan to Refinitiv"],
              emotions: "neutral",
              frictionScore: 3,
              automationOpportunity: "high",
              automationNotes: "Straight through processing for the majority of cases,",
              regulatoryRequirements: ["AML/KYC", "MLR 2017"],
              isHardCheckpoint: true,
              checkpointType: "compliance",
              checkpointDetails: "Client identity must be verified to AML/KYC standards before any financial advice can be provided. Requires valid government ID and proof of address dated within 3 months.",
              roleInvolvement: {
                fp: { timeMinutes: 0, headcount: 1 },
                im: { timeMinutes: 0, headcount: 1 },
                ops: { timeMinutes: 29, headcount: 1 },
                administrator: { timeMinutes: 8, headcount: 1 }
              },
              actions: {
                fp: "",
                im: "",
                ops: "Manage the ID&V case via the Refinitiv portal and feed back to front office",
                client: "Provides initial 5 bits of info\nProvides further documented ID or proof if required",
                administrator: "Initiates ID verification request\nCo-ordinates with client for further documentation"
              },
              clientTouchpoint: true,
              additionalCosts: [
                { id: "7nplk13i2", description: "ID & V", amount: 50, category: "third-party" }
              ]
            },
            {
              id: "screening",
              name: "Screening",
              description: "Screen for Politically Exposed Persons and sanctions",
              timeMinutes: 37,
              owner: "ops",
              touchpoints: ["Screening Platform"],
              painPoints: ["False positives require manual review"],
              emotions: "neutral",
              frictionScore: 3,
              automationOpportunity: "high",
              automationNotes: "Straight through processing for the majority of cases,",
              regulatoryRequirements: ["AML regulations", "Sanctions compliance"],
              isHardCheckpoint: true,
              checkpointType: "regulatory",
              checkpointDetails: "PEP and sanctions screening must be completed and cleared before proceeding. Any matches require escalation to Compliance for review and sign-off.",
              roleInvolvement: {
                fp: { timeMinutes: 0, headcount: 1 },
                im: { timeMinutes: 0, headcount: 1 },
                ops: { timeMinutes: 29, headcount: 1 },
                administrator: { timeMinutes: 8, headcount: 1 }
              },
              actions: {
                fp: "Reviews screening results",
                im: "Assesses investment risk implications",
                ops: "Runs screening checks and documents results"
              },
              additionalCosts: [
                { id: "lidhspxb0", description: "Screening", amount: 50, category: "third-party" }
              ]
            },
            {
              id: "loas",
              name: "LOAs",
              description: "Letters of Authority. Client must provide their authorisation for us to gather information from other suppliers.",
              timeMinutes: 488,
              owner: "ops",
              touchpoints: ["Provider Portals", "Post", "Email", "secure messaging"],
              painPoints: ["Provider delays", "Chasing responses", "Different provider processes", "3rd parties require wet signatures", "Manual internal processes"],
              emotions: "waiting",
              frictionScore: 5,
              automationOpportunity: "medium",
              automationNotes: "Opportunity to digitise internal Evelyn manual processes. However a lot of the delays come from 3rd parties which is not within our control to fix.",
              regulatoryRequirements: ["Client consent", "Data protection"],
              roleInvolvement: {
                fp: { timeMinutes: 0, headcount: 1 },
                im: { timeMinutes: 0, headcount: 1 },
                ops: { timeMinutes: 365, headcount: 1 },
                administrator: { timeMinutes: 88, headcount: 1 }
              },
              actions: {
                fp: "",
                im: "Reviews existing investment information",
                ops: "1, Script team will follow up to check that the 3rd party received the LOA and find out timescales for info return3, Once the info is returned by the provider, script team then create a \"script\" filling in the info provided and then they will contact the 3rd party to get any information that is missing.\n3, Once complete, the script team then re-key the information back into xplan",
                client: "Client will receive a LOA to physically sign that covers each provider that they have current holdings with. They will need to print out the letter, sign it, scan it and then send it back to us.",
                administrator: "1. Prepares LOA letter to send to clients.\n2. Once retuned, send LOA along with a covering letter to each provider to request asset info\n3, Create a task for the script team* to chase providers and create script for more info if required"
              },
              isHardCheckpoint: true,
              clientTouchpoint: true,
              checkpointType: "regulatory"
            },
            {
              id: "fact-find-a",
              name: "Fact Find A",
              description: "Comprehensive fact find - Part A",
              timeMinutes: 390,
              owner: "fp",
              touchpoints: ["In-person", "Teams", "Xplan"],
              painPoints: ["Time intensive", "Client preparation varies", "Large volumes of data to collect", "Manual rekeyng into xplan", "Asking for information already gathered elsewhere"],
              emotions: ["engaged", "overwhelmed"],
              frictionScore: 5,
              automationOpportunity: "medium",
              automationNotes: "Digital fact find with pre-population. Improved Source of Wealth questions.",
              regulatoryRequirements: ["COBS suitability", "Know Your Client"],
              clientTouchpoint: true,
              roleInvolvement: {
                fp: { timeMinutes: 330, headcount: 1 },
                im: { timeMinutes: 0, headcount: 1 },
                ops: { timeMinutes: 0, headcount: 1 },
                administrator: { timeMinutes: 60, headcount: 1 }
              },
              actions: {
                fp: "Conducts comprehensive fact find meeting(s), takes notes or updates forms",
                im: "",
                client: "Provides information required",
                administrator: "Updates the Fact Find A form information into Xplan"
              },
              isHardCheckpoint: true,
              checkpointType: "vetting",
              checkpointDetails: "FFA exists in the DNL and information provided reviewed"
            },
            {
              id: "craf",
              name: "CRAF",
              description: "Client Risk Assessment Form",
              timeMinutes: 103.5,
              owner: "fp",
              touchpoints: ["xplan"],
              painPoints: ["Complex risk scoring", "Poor explanation of clients Source of Wealth", "Highest cause of vetting failures", "Large amounts of back and forth with the client", "Large gap in time between gathering SOW and vetting CRAF"],
              emotions: ["frustrated"],
              frictionScore: 4,
              automationOpportunity: "high",
              automationNotes: "Potential to remove the CRAF form completely, automate the risk calculation from Source of wealth on FFA and introduce a new CRA approval process",
              regulatoryRequirements: ["FCA ATR requirements", "Capacity for loss"],
              roleInvolvement: {
                fp: { timeMinutes: 90, headcount: 1 },
                im: { timeMinutes: 0, headcount: 1 },
                ops: { timeMinutes: 13.5, headcount: 1 }
              },
              actions: {
                fp: "1. Completes the CRAF based on the information provided by the client.\n2. Uses Financial Crime guidance document to calculate the risk level\n3, Liaises with client to provide any additional info\n4. Approves final risk level",
                im: "",
                ops: "1. Vetting- reviews the CRAF to ensure that it meets the Financial Crime Guidance and cross checks the info provided with LOAs and My Wealth.\n2. Works with Front office to get more information from the client when required."
              },
              isHardCheckpoint: true,
              checkpointType: "regulatory",
              checkpointDetails: "Client Risk Assessment needs to be completed (including any enhanced due diligence and approvals) and signed off by Front Office prior to completing Fact Find B."
            },
            {
              id: "fact-find-b",
              name: "Fact Find B",
              description: "Comprehensive fact find - Part B (follow-up)",
              timeMinutes: 60,
              owner: "fp",
              touchpoints: ["xplan"],
              painPoints: [],
              emotions: ["neutral"],
              frictionScore: 3,
              automationOpportunity: "low",
              automationNotes: "Some digitisation potential. Further discovery required.",
              regulatoryRequirements: ["COBS suitability"],
              clientTouchpoint: false,
              roleInvolvement: {
                fp: { timeMinutes: 60, headcount: 1 },
                im: { timeMinutes: 0, headcount: 1 },
                ops: { timeMinutes: 0, headcount: 1 }
              },
              actions: {
                fp: "Completes the Fact Find B on xplan. This is essentially and review and overview of the information collected during Fact Find A including Oxford Risk, Client Vulnerabilities Objectives, Investment knowledge etc,",
                im: "",
                paraplanner: "Uses Fact Find B as the summary that to feeds into Advice research and analysis"
              },
              isHardCheckpoint: true,
              checkpointType: "vetting",
              checkpointDetails: "FFB needs to be in place before Stage 4 can commence"
            }
          ]
        },
        {
          id: "advice",
          name: "Advice / Contract",
          dropOffCount: 500,
          steps: [
            {
              id: "pricing-propositions",
              name: "Pricing & Propositions",
              description: "Research and analysis for pricing and investment propositions",
              timeMinutes: 894,
              owner: "paraplanner",
              touchpoints: ["Research Tools", "Planning Software"],
              painPoints: ["Time intensive research", "Complex analysis", "Paraplanners often have to request updated valuations from 3rd parties due to time lapsed since LOA", "Long wait times for clients due to Paraplanner backlogs"],
              emotions: "waiting",
              frictionScore: 5,
              automationOpportunity: "medium",
              automationNotes: "AI-assisted research and analysis tools",
              regulatoryRequirements: ["Best execution", "Suitability"],
              roleInvolvement: {
                fp: { timeMinutes: 30, headcount: 1 },
                im: { timeMinutes: 0, headcount: 1 },
                ops: { timeMinutes: 0, headcount: 1 },
                paraplanner: { timeMinutes: 864, headcount: 1 }
              },
              actions: {
                fp: "Submits request to Paraplanner",
                im: "",
                paraplanner: "1, Checks that all correct information has been collected by FP\n2, Conducts research and develops propositions"
              }
            },
            {
              id: "fee-illustration",
              name: "Fee Illustration",
              description: "Prepare fee illustrations and cost disclosures",
              timeMinutes: 84,
              owner: "paraplanner",
              touchpoints: ["Illustration Software"],
              painPoints: ["complex process"],
              emotions: ["waiting"],
              frictionScore: 2,
              automationOpportunity: "high",
              automationNotes: "Template-based generation",
              regulatoryRequirements: ["MiFID II cost disclosure", "Consumer Duty"],
              roleInvolvement: {
                fp: { timeMinutes: 0, headcount: 1 },
                im: { timeMinutes: 0, headcount: 1 },
                ops: { timeMinutes: 0, headcount: 1 },
                paraplanner: { timeMinutes: 84, headcount: 1 }
              },
              actions: {
                fp: "",
                im: "",
                paraplanner: "Prepares fee illustrations"
              }
            },
            {
              id: "advice-report",
              name: "Advice Report",
              description: "Comprehensive suitability and advice report",
              timeMinutes: 750,
              owner: "paraplanner",
              touchpoints: ["Report Software", "Siesmic"],
              painPoints: ["Report writing time intensive", "Compliance review delays", "Rekeying info"],
              emotions: "waiting",
              frictionScore: 5,
              automationOpportunity: "high",
              automationNotes: "AI-assisted report generation",
              regulatoryRequirements: ["COBS 9.4 suitability reports", "Clear, fair, not misleading"],
              roleInvolvement: {
                fp: { timeMinutes: 30, headcount: 1 },
                im: { timeMinutes: 0, headcount: 1 },
                ops: { timeMinutes: 0, headcount: 1 },
                paraplanner: { timeMinutes: 720, headcount: 1 }
              },
              actions: {
                fp: "Reviews and sends report to Client",
                im: "Contributes investment rationale section",
                paraplanner: "Writes comprehensive suitability and advice report",
                client: "Reviews report"
              }
            },
            {
              id: "account-opening-forms",
              name: "Application Forms",
              description: "Complete account opening applications",
              timeMinutes: 142,
              owner: "administrator",
              touchpoints: ["AdobeSign", "xplan", "Form finder"],
              painPoints: ["Adobesign only allows 1 single person to manage that document", "Multiple versions of each form depending on service, account type and entity", "Form finder can be complex to find the correct form", "Manual rekeying from xplan into adobe sign to prepopulate for client", "Duplication of information that already exists"],
              emotions: ["neutral"],
              frictionScore: 5,
              automationOpportunity: "high",
              automationNotes: "Digital Dynamic Forms prepopulate all Application forms with API integration for straight-through processing to and from xplan",
              regulatoryRequirements: ["Client consent", "Accurate data"],
              roleInvolvement: {
                fp: { timeMinutes: 0, headcount: 1 },
                im: { timeMinutes: 0, headcount: 1 },
                ops: { timeMinutes: 102, headcount: 1 },
                administrator: { timeMinutes: 40, headcount: 1 }
              },
              actions: {
                fp: "",
                im: "",
                ops: "TBC",
                administrator: "Manages completion of the forms with the client",
                client: "Receives Application Forms to review/complete and sign"
              },
              clientTouchpoint: true,
              isHardCheckpoint: true,
              checkpointType: "vetting",
              checkpointDetails: "Cannot open the accounts if the Account opening form has not been completed or signed"
            },
            {
              id: "vetting",
              name: "Vetting",
              description: "Internal vetting and compliance review",
              timeMinutes: 139,
              owner: "fp",
              touchpoints: ["xplan", "Case Manager", "Excel"],
              painPoints: ["Manual vetting checks using excel", "Each account to be opened has it's own set of checks", "Checking Front Office work", "vetting done at the very end of the process rather than inline", "High failure rates (60%)"],
              emotions: "waiting",
              frictionScore: 5,
              automationOpportunity: "high",
              automationNotes: "Automated asynchronous vetting checks done digitally throughout the process rather than at the end,",
              regulatoryRequirements: ["Internal compliance", "Sign-off requirements"],
              roleInvolvement: {
                fp: { timeMinutes: 20, headcount: 1 },
                im: { timeMinutes: 0, headcount: 1 },
                ops: { timeMinutes: 40, headcount: 1 },
                administrator: { timeMinutes: 79, headcount: 1 }
              },
              actions: {
                fp: "Liaise with Administrator and client when needed",
                im: "",
                ops: "Undertakes vetting checks",
                administrator: "Raise Account Opening Request\nLiaise with client and Vetting team to resolve issues, gather more info"
              },
              isHardCheckpoint: true,
              checkpointType: "vetting",
              checkpointDetails: "Cannot commence account opening until the case has passed vetting"
            },
            {
              id: "account-opening",
              name: "Account Opening",
              description: "Finalise account opening with providers",
              timeMinutes: 115,
              owner: "ops",
              touchpoints: ["xplan", "SEI", "Avaloq"],
              painPoints: ["Manual rekeying of data from xplan into Avaloq or SEI to open accounts"],
              emotions: ["neutral"],
              frictionScore: 2,
              automationOpportunity: "medium",
              automationNotes: "API submission to appropriate systems",
              regulatoryRequirements: ["Provider requirements"],
              roleInvolvement: {
                fp: { timeMinutes: 0, headcount: 1 },
                im: { timeMinutes: 0, headcount: 1 },
                ops: { timeMinutes: 115.2, headcount: 1 }
              },
              actions: {
                ops: "Key data from xplan to Avaloq or SEI to open the accounts"
              }
            }
          ]
        },
        {
          id: "transfers-in",
          name: "Transfers In",
          dropOffCount: 150,
          steps: [
            {
              id: "initiation",
              name: "Initiation",
              description: "Initiate transfer requests",
              timeMinutes: 49,
              owner: "ops",
              touchpoints: ["Provider Portals", "Origo"],
              painPoints: [],
              emotions: "hopeful",
              frictionScore: 2,
              automationOpportunity: "high",
              automationNotes: "Origo/PPEX automation",
              regulatoryRequirements: ["Transfer procedures"],
              roleInvolvement: {
                fp: { timeMinutes: 8.7, headcount: 1 },
                im: { timeMinutes: 8.7, headcount: 1 },
                ops: { timeMinutes: 40, headcount: 1 }
              },
              actions: {
                fp: "Approves transfer initiation",
                im: "Confirms transfer requirements",
                ops: "Submits transfer requests"
              }
            },
            {
              id: "new-transfer-validation",
              name: "New Transfer / Validation",
              description: "Validate incoming transfer details",
              timeMinutes: 25,
              owner: "ops",
              touchpoints: ["Back Office Systems"],
              painPoints: ["Data validation issues"],
              emotions: "neutral",
              frictionScore: 2,
              automationOpportunity: "high",
              automationNotes: "Automated validation rules",
              regulatoryRequirements: [],
              roleInvolvement: {
                fp: { timeMinutes: 0, headcount: 1 },
                im: { timeMinutes: 0, headcount: 1 },
                ops: { timeMinutes: 25, headcount: 1 }
              },
              actions: {
                ops: "Validates transfer data and documentation"
              }
            },
            {
              id: "chase-counterparty",
              name: "Chase Counterparty",
              description: "Follow up with ceding providers",
              timeMinutes: 66,
              owner: "ops",
              touchpoints: ["Phone", "Email", "Provider Portals"],
              painPoints: ["Provider delays", "Difficult to reach providers"],
              emotions: "frustrated",
              frictionScore: 3,
              automationOpportunity: "medium",
              automationNotes: "Automated chase sequences",
              regulatoryRequirements: [],
              roleInvolvement: {
                fp: { timeMinutes: 0, headcount: 1 },
                im: { timeMinutes: 0, headcount: 1 },
                ops: { timeMinutes: 66, headcount: 1 }
              },
              actions: {
                ops: "Chases ceding providers for transfer progress"
              }
            },
            {
              id: "check-valuation",
              name: "Check Valuation",
              description: "Verify transfer valuations",
              timeMinutes: 74,
              owner: "ops",
              touchpoints: ["Provider Portals", "Back Office"],
              painPoints: ["Valuation discrepancies"],
              emotions: "neutral",
              frictionScore: 2,
              automationOpportunity: "medium",
              automationNotes: "Automated valuation comparison",
              regulatoryRequirements: ["Accurate record keeping"],
              roleInvolvement: {
                fp: { timeMinutes: 30, headcount: 1 },
                im: { timeMinutes: 30, headcount: 1 },
                ops: { timeMinutes: 44, headcount: 1 }
              },
              actions: {
                fp: "Reviews valuation accuracy",
                im: "Confirms investment valuations",
                ops: "Checks and reconciles valuations"
              }
            },
            {
              id: "trades-acceptance",
              name: "Trades / Acceptance",
              description: "Accept transfers and execute trades",
              timeMinutes: 125,
              owner: "ops",
              touchpoints: ["Trading Platform", "Back Office"],
              painPoints: ["Market timing considerations"],
              emotions: "neutral",
              frictionScore: 3,
              automationOpportunity: "medium",
              automationNotes: "Automated trade execution rules",
              regulatoryRequirements: ["Best execution", "Trade reporting"],
              roleInvolvement: {
                fp: { timeMinutes: 5, headcount: 1 },
                im: { timeMinutes: 5, headcount: 1 },
                ops: { timeMinutes: 120, headcount: 1 }
              },
              actions: {
                fp: "Approves trade execution",
                im: "Confirms investment allocation",
                ops: "Executes trades and processes transfers"
              }
            },
            {
              id: "update-portfolio",
              name: "Update Portfolio",
              description: "Update portfolio systems with transferred assets",
              timeMinutes: 15,
              owner: "ops",
              touchpoints: ["Portfolio Management System"],
              painPoints: [],
              emotions: "neutral",
              frictionScore: 1,
              automationOpportunity: "high",
              automationNotes: "Automated portfolio updates",
              regulatoryRequirements: [],
              roleInvolvement: {
                fp: { timeMinutes: 0, headcount: 1 },
                im: { timeMinutes: 0, headcount: 1 },
                ops: { timeMinutes: 15, headcount: 1 }
              },
              actions: {
                ops: "Updates portfolio records"
              }
            },
            {
              id: "check-transfer-status",
              name: "Check Transfer Status",
              description: "Monitor and verify transfer completion",
              timeMinutes: 5,
              owner: "ops",
              touchpoints: ["Provider Portals"],
              painPoints: [],
              emotions: "neutral",
              frictionScore: 1,
              automationOpportunity: "high",
              automationNotes: "Automated status tracking",
              regulatoryRequirements: [],
              roleInvolvement: {
                fp: { timeMinutes: 0, headcount: 1 },
                im: { timeMinutes: 0, headcount: 1 },
                ops: { timeMinutes: 5, headcount: 1 }
              },
              actions: {
                ops: "Monitors transfer status"
              }
            },
            {
              id: "closure",
              name: "Closure",
              description: "Complete transfer and close out process",
              timeMinutes: 44,
              owner: "ops",
              touchpoints: ["Back Office", "CRM"],
              painPoints: [],
              emotions: "satisfied",
              frictionScore: 2,
              automationOpportunity: "medium",
              automationNotes: "Automated completion workflow",
              regulatoryRequirements: ["Record keeping"],
              roleInvolvement: {
                fp: { timeMinutes: 0, headcount: 1 },
                im: { timeMinutes: 0, headcount: 1 },
                ops: { timeMinutes: 44, headcount: 1 }
              },
              actions: {
                ops: "Closes transfer case, updates records"
              }
            }
          ]
        }
      ]
    };
    // __CONFIG_END__

    const emotionColors = {
      hopeful: { bg: '#D4EDE5', text: '#2D8A6E', icon: '🌱' },
      curious: { bg: '#E8F0FE', text: '#1967D2', icon: '🔍' },
      overwhelmed: { bg: '#F5E0E3', text: '#B84A5A', icon: '😰' },
      engaged: { bg: '#D4EDE5', text: '#2D8A6E', icon: '💬' },
      uncertain: { bg: '#FAF0D6', text: '#B06000', icon: '🤔' },
      waiting: { bg: '#E1EEF2', text: '#5A5B8A', icon: '⏳' },
      excited: { bg: '#D4EDE5', text: '#2D8A6E', icon: '✨' },
      neutral: { bg: '#F1F3F4', text: '#5F6368', icon: '➡️' },
      satisfied: { bg: '#D4EDE5', text: '#2D8A6E', icon: '✅' },
      frustrated: { bg: '#F5E0E3', text: '#B84A5A', icon: '😤' },
      confident: { bg: '#D4EDE5', text: '#2D8A6E', icon: '💪' },
      anxious: { bg: '#FAF0D6', text: '#B06000', icon: '😟' }
    };

    const automationColors = {
      high: { bg: '#D4EDE5', text: '#2D8A6E', label: 'High' },
      medium: { bg: '#FAF0D6', text: '#8B6914', label: 'Medium' },
      low: { bg: '#F5E0E3', text: '#B84A5A', label: 'Low' },
      none: { bg: '#F4F5F7', text: '#6E7B8C', label: 'None' }
    };

    const frictionConfig = {
      1: { emoji: '😊', color: '#2D8A6E', bg: '#D4EDE5', label: 'Low' },
      2: { emoji: '😐', color: '#84CC16', bg: '#ECFCCB', label: 'Mild' },
      3: { emoji: '😕', color: '#EAB308', bg: '#FAF0D6', label: 'Moderate' },
      4: { emoji: '😣', color: '#F97316', bg: '#FFEDD5', label: 'High' },
      5: { emoji: '🥵', color: '#B84A5A', bg: '#F5E0E3', label: 'Severe' }
    };

    // Cost calculation helpers
    const WORKING_HOURS_PER_YEAR = 1820; // 52 weeks * 35 hours (UK standard)
    
    // Calculate base hourly rate from annual salary (for display purposes)
    const calculateHourlyRate = (annualSalary) => {
      if (!annualSalary || annualSalary === 0) return 0;
      return annualSalary / WORKING_HOURS_PER_YEAR;
    };
    
    // Calculate fully-loaded hourly rate including burden and workspace
    const calculateFullyLoadedRate = (persona) => {
      if (!persona || persona.isExternal) return 0;
      // Support both annualSalary (new format) and salary (legacy/template format)
      const salary = persona.annualSalary || persona.salary || 0;
      if (salary === 0) return 0;
      const baseHourly = salary / WORKING_HOURS_PER_YEAR;
      const burdenMultiplier = persona.burdenMultiplier || 1.0;
      const workspaceHourly = persona.workspaceHourlyCost || 0;
      return (baseHourly * burdenMultiplier) + workspaceHourly;
    };

    const calculateStepCost = (step, personas) => {
      let totalCost = 0;
      
      // NEW FORMAT: Labour costs using roleInvolvement (with burden and workspace)
      if (step.roleInvolvement && Object.keys(step.roleInvolvement).length > 0) {
        Object.entries(step.roleInvolvement).forEach(([roleId, involvement]) => {
          const persona = personas.find(p => p.id === roleId);
          if (persona && !persona.isExternal && (persona.annualSalary > 0 || persona.salary > 0)) {
            const fullyLoadedRate = calculateFullyLoadedRate(persona);
            const hours = (involvement.timeMinutes || 0) / 60;
            const headcount = involvement.headcount || 1;
            totalCost += fullyLoadedRate * hours * headcount;
          }
        });
      } 
      // LEGACY FORMAT: Single owner with timeMinutes
      else if (step.owner && step.timeMinutes > 0) {
        const persona = personas.find(p => p.id === step.owner);
        if (persona && !persona.isExternal && (persona.annualSalary > 0 || persona.salary > 0)) {
          const fullyLoadedRate = calculateFullyLoadedRate(persona);
          const hours = step.timeMinutes / 60;
          totalCost += fullyLoadedRate * hours;
        }
      }
      
      // Additional costs (third-party services, materials, etc.)
      if (step.additionalCosts && Array.isArray(step.additionalCosts)) {
        step.additionalCosts.forEach(cost => {
          totalCost += cost.amount || 0;
        });
      }
      
      return totalCost;
    };
    
    // Calculate labour cost only (excluding additional costs)
    const calculateStepLabourCost = (step, personas) => {
      let totalCost = 0;
      
      // NEW FORMAT: roleInvolvement
      if (step.roleInvolvement && Object.keys(step.roleInvolvement).length > 0) {
        Object.entries(step.roleInvolvement).forEach(([roleId, involvement]) => {
          const persona = personas.find(p => p.id === roleId);
          if (persona && !persona.isExternal && (persona.annualSalary > 0 || persona.salary > 0)) {
            const fullyLoadedRate = calculateFullyLoadedRate(persona);
            const hours = (involvement.timeMinutes || 0) / 60;
            const headcount = involvement.headcount || 1;
            totalCost += fullyLoadedRate * hours * headcount;
          }
        });
      }
      // LEGACY FORMAT: Single owner with timeMinutes
      else if (step.owner && step.timeMinutes > 0) {
        const persona = personas.find(p => p.id === step.owner);
        if (persona && !persona.isExternal && (persona.annualSalary > 0 || persona.salary > 0)) {
          const fullyLoadedRate = calculateFullyLoadedRate(persona);
          const hours = step.timeMinutes / 60;
          totalCost += fullyLoadedRate * hours;
        }
      }
      
      return totalCost;
    };
    
    // Calculate additional costs only
    const calculateStepAdditionalCosts = (step) => {
      if (!step.additionalCosts || !Array.isArray(step.additionalCosts)) return 0;
      return step.additionalCosts.reduce((acc, cost) => acc + (cost.amount || 0), 0);
    };

    const formatCurrency = (amount) => {
      return new Intl.NumberFormat('en-GB', {
        style: 'currency',
        currency: 'GBP',
        minimumFractionDigits: 0,
        maximumFractionDigits: 0
      }).format(amount);
    };

    const formatCurrencyDetailed = (amount) => {
      return new Intl.NumberFormat('en-GB', {
        style: 'currency',
        currency: 'GBP',
        minimumFractionDigits: 2,
        maximumFractionDigits: 2
      }).format(amount);
    };

    // Export Report Function - generates printable HTML
    const exportReport = (reportType, config, data) => {
      const journeyTitle = config.title || 'Journey Map';
      const journeyOwner = config.owner || '';
      const date = new Date().toLocaleDateString('en-GB', { day: 'numeric', month: 'long', year: 'numeric' });
      
      let reportContent = '';
      let reportSubtitle = '';
      
      if (reportType === 'cost') {
        reportSubtitle = 'Cost Analysis';
        const { totalCost, totalMinutes, stageMetrics, roleCosts, totalAutomationSavings, formatTime, stepMetrics } = data;
        
        // Top 5 most expensive steps
        const topExpensiveSteps = stepMetrics ? [...stepMetrics].sort((a, b) => b.cost - a.cost).slice(0, 5) : [];
        // Top 5 highest cost/minute
        const topCostPerMinute = stepMetrics ? [...stepMetrics].sort((a, b) => b.costPerMinute - a.costPerMinute).slice(0, 5) : [];
        // Top improvement opportunities
        const topImprovements = stepMetrics ? [...stepMetrics].filter(s => s.automationSavings > 0).sort((a, b) => b.automationSavings - a.automationSavings).slice(0, 8) : [];
        
        reportContent = `
          <div class="summary-grid">
            <div class="summary-card highlight-amber">
              <div class="summary-value">${formatCurrency(totalCost)}</div>
              <div class="summary-label">Total Journey Cost</div>
            </div>
            <div class="summary-card">
              <div class="summary-value">${formatTime(totalMinutes)}</div>
              <div class="summary-label">Total Time</div>
            </div>
            <div class="summary-card highlight-green">
              <div class="summary-value">${formatCurrency(totalAutomationSavings)}</div>
              <div class="summary-label">Potential Savings</div>
            </div>
            <div class="summary-card">
              <div class="summary-value">${totalMinutes > 0 ? formatCurrency(totalCost / totalMinutes * 60) : '£0'}/hr</div>
              <div class="summary-label">Average Cost Rate</div>
            </div>
          </div>
          
          <div class="two-column">
            <div>
              <h2>Cost by Stage</h2>
              <table>
                <thead>
                  <tr>
                    <th>Stage</th>
                    <th class="num">Steps</th>
                    <th class="num">Time</th>
                    <th class="num">Cost</th>
                    <th class="num">%</th>
                  </tr>
                </thead>
                <tbody>
                  ${stageMetrics.map(s => `
                    <tr>
                      <td>${s.name}</td>
                      <td class="num">${s.stepCount}</td>
                      <td class="num">${formatTime(s.minutes)}</td>
                      <td class="num">${formatCurrency(s.cost)}</td>
                      <td class="num">${totalCost > 0 ? ((s.cost / totalCost) * 100).toFixed(1) : 0}%</td>
                    </tr>
                  `).join('')}
                </tbody>
              </table>
            </div>
            
            <div>
              <h2>Cost by Role</h2>
              <table>
                <thead>
                  <tr>
                    <th>Role</th>
                    <th class="num">Time</th>
                    <th class="num">Cost</th>
                    <th class="num">%</th>
                  </tr>
                </thead>
                <tbody>
                  ${roleCosts.map(r => `
                    <tr>
                      <td>${r.label || r.name || r.role || 'Unknown'}</td>
                      <td class="num">${formatTime(r.totalMinutes)}</td>
                      <td class="num">${formatCurrency(r.totalCost)}</td>
                      <td class="num">${totalCost > 0 ? ((r.totalCost / totalCost) * 100).toFixed(1) : 0}%</td>
                    </tr>
                  `).join('')}
                </tbody>
              </table>
            </div>
          </div>
          
          ${topExpensiveSteps.length > 0 ? `
          <div class="two-column">
            <div>
              <h2>🔥 Top 5 Most Expensive Steps</h2>
              <table>
                <thead>
                  <tr>
                    <th class="rank-col">#</th>
                    <th>Step</th>
                    <th class="num">Cost</th>
                  </tr>
                </thead>
                <tbody>
                  ${topExpensiveSteps.map((s, i) => `
                    <tr>
                      <td class="rank">${i + 1}</td>
                      <td>
                        <strong>${s.name}</strong>
                        <div class="meta">${s.stageName}</div>
                      </td>
                      <td class="num">${formatCurrency(s.cost)}</td>
                    </tr>
                  `).join('')}
                </tbody>
              </table>
            </div>
            
            <div>
              <h2>⚡ Highest Cost/Minute Steps</h2>
              <table>
                <thead>
                  <tr>
                    <th class="rank-col">#</th>
                    <th>Step</th>
                    <th class="num">Rate</th>
                  </tr>
                </thead>
                <tbody>
                  ${topCostPerMinute.map((s, i) => `
                    <tr>
                      <td class="rank">${i + 1}</td>
                      <td>
                        <strong>${s.name}</strong>
                        <div class="meta">${s.stageName} · ${formatTime(s.timeMinutes)}</div>
                      </td>
                      <td class="num">${formatCurrency(s.costPerMinute)}/min</td>
                    </tr>
                  `).join('')}
                </tbody>
              </table>
            </div>
          </div>
          ` : ''}
          
          ${topImprovements.length > 0 ? `
          <h2>🎯 Top Improvement Opportunities</h2>
          <p class="section-intro">Steps with highest potential savings from process improvements</p>
          <table class="improvements-table">
            <thead>
              <tr>
                <th>Step</th>
                <th>Stage</th>
                <th class="num">Current Cost</th>
                <th class="num">Opportunity</th>
                <th class="num">Potential Savings</th>
              </tr>
            </thead>
            <tbody>
              ${topImprovements.map(s => `
                <tr>
                  <td><strong>${s.name}</strong></td>
                  <td>${s.stageName}</td>
                  <td class="num">${formatCurrency(s.cost)}</td>
                  <td class="num"><span class="badge badge-${s.automationOpportunity}">${s.automationOpportunity}</span></td>
                  <td class="num text-green"><strong>${formatCurrency(s.automationSavings)}</strong></td>
                </tr>
              `).join('')}
            </tbody>
          </table>
          ` : ''}
          
          <h2>📋 Detailed Stage Breakdown</h2>
          ${data.stageBreakdown ? data.stageBreakdown.map(stage => `
            <div class="stage-section">
              <div class="stage-header-bar">
                <span class="stage-title">${stage.name}</span>
                <span class="stage-meta">${stage.steps.length} steps · ${formatTime(stage.totalTime)} · ${formatCurrency(stage.totalCost)}</span>
              </div>
              <table class="stage-table">
                <thead>
                  <tr>
                    <th style="width:40px">#</th>
                    <th style="width:200px">Step</th>
                    <th style="width:70px" class="num">Time</th>
                    <th style="width:70px" class="num">Cost</th>
                    <th>Pain Points</th>
                    <th style="width:90px" class="num">Improvement</th>
                  </tr>
                </thead>
                <tbody>
                  ${stage.steps.map((step, idx) => `
                    <tr>
                      <td>${stage.index}.${idx + 1}</td>
                      <td>
                        <strong>${step.name}</strong>
                        ${step.owners ? `<div class="meta">${step.owners}</div>` : ''}
                      </td>
                      <td class="num">${formatTime(step.timeMinutes)}</td>
                      <td class="num">${formatCurrency(step.cost)}</td>
                      <td>${step.painPoints && step.painPoints.length > 0 ? step.painPoints.map(pp => `<div class="pain-point">⚠ ${pp}</div>`).join('') : '—'}</td>
                      <td class="num"><span class="badge badge-${step.automationOpportunity || 'none'}">${step.automationOpportunity || 'none'}</span></td>
                    </tr>
                  `).join('')}
                </tbody>
              </table>
            </div>
          `).join('') : ''}
        `;
      } else if (reportType === 'time') {
        reportSubtitle = 'Timeline Analysis';
        const { totalTime, avgTimePerStep, highFrictionSteps, totalPainPoints, stageData, formatTime, topTimeSteps, frictionSteps } = data;
        
        reportContent = `
          <div class="summary-grid">
            <div class="summary-card">
              <div class="summary-value">${formatTime(totalTime)}</div>
              <div class="summary-label">Total Process Time</div>
            </div>
            <div class="summary-card">
              <div class="summary-value">${formatTime(Math.round(avgTimePerStep))}</div>
              <div class="summary-label">Avg Time per Step</div>
            </div>
            <div class="summary-card highlight-red">
              <div class="summary-value">${highFrictionSteps}</div>
              <div class="summary-label">High Friction Steps</div>
            </div>
            <div class="summary-card highlight-amber">
              <div class="summary-value">${totalPainPoints}</div>
              <div class="summary-label">Pain Points</div>
            </div>
          </div>
          
          <h2>Time by Stage</h2>
          <table>
            <thead>
              <tr>
                <th>Stage</th>
                <th class="num">Steps</th>
                <th class="num">Time</th>
                <th class="num">% of Total</th>
                <th class="num">Avg Friction</th>
              </tr>
            </thead>
            <tbody>
              ${stageData.map(s => `
                <tr>
                  <td>${s.name}</td>
                  <td class="num">${s.stepCount}</td>
                  <td class="num">${formatTime(s.time)}</td>
                  <td class="num">${totalTime > 0 ? ((s.time / totalTime) * 100).toFixed(1) : 0}%</td>
                  <td class="num">${s.avgFriction}/5</td>
                </tr>
              `).join('')}
            </tbody>
          </table>
          
          ${topTimeSteps && topTimeSteps.length > 0 ? `
          <div class="two-column">
            <div>
              <h2>⏱️ Longest Steps</h2>
              <table>
                <thead>
                  <tr>
                    <th class="rank-col">#</th>
                    <th>Step</th>
                    <th class="num">Time</th>
                  </tr>
                </thead>
                <tbody>
                  ${topTimeSteps.map((s, i) => `
                    <tr>
                      <td class="rank">${i + 1}</td>
                      <td>
                        <strong>${s.name}</strong>
                        <div class="meta">${s.stageName}</div>
                      </td>
                      <td class="num">${formatTime(s.timeMinutes)}</td>
                    </tr>
                  `).join('')}
                </tbody>
              </table>
            </div>
            
            <div>
              <h2>😰 Highest Friction Steps</h2>
              <table>
                <thead>
                  <tr>
                    <th class="rank-col">#</th>
                    <th>Step</th>
                    <th class="num">Score</th>
                  </tr>
                </thead>
                <tbody>
                  ${frictionSteps && frictionSteps.map((s, i) => `
                    <tr>
                      <td class="rank">${i + 1}</td>
                      <td>
                        <strong>${s.name}</strong>
                        <div class="meta">${s.stageName}</div>
                      </td>
                      <td class="num">${s.frictionScore || 3}/5</td>
                    </tr>
                  `).join('')}
                </tbody>
              </table>
            </div>
          </div>
          ` : ''}
        `;
      } else if (reportType === 'funnel') {
        reportSubtitle = 'Funnel Analysis';
        const { stageMetrics, initialVolume, finalVolume, totalDropOff, overallConversionRate, totalStageInvestment, totalWastedCost, periodLabel, worstStage, mostWasteful } = data;
        
        reportContent = `
          <p class="period-label">Analysis Period: <strong>${periodLabel}</strong></p>
          
          <div class="summary-grid">
            <div class="summary-card">
              <div class="summary-value">${initialVolume.toLocaleString()}</div>
              <div class="summary-label">Initial Volume</div>
            </div>
            <div class="summary-card highlight-green">
              <div class="summary-value">${finalVolume.toLocaleString()}</div>
              <div class="summary-label">Completed</div>
            </div>
            <div class="summary-card highlight-red">
              <div class="summary-value">${totalDropOff.toLocaleString()}</div>
              <div class="summary-label">Total Drop-off</div>
            </div>
            <div class="summary-card">
              <div class="summary-value">${overallConversionRate.toFixed(1)}%</div>
              <div class="summary-label">Conversion Rate</div>
            </div>
          </div>
          
          <div class="summary-grid cols-3">
            <div class="summary-card highlight-green">
              <div class="summary-value">${formatCurrency(totalStageInvestment)}</div>
              <div class="summary-label">Good Cost (Completed)</div>
            </div>
            <div class="summary-card highlight-red">
              <div class="summary-value">${formatCurrency(totalWastedCost)}</div>
              <div class="summary-label">Bad Cost (Drop-offs)</div>
            </div>
            <div class="summary-card highlight-amber">
              <div class="summary-value">${formatCurrency(totalStageInvestment + totalWastedCost)}</div>
              <div class="summary-label">Total Investment</div>
            </div>
          </div>
          
          <h2>Volume Flow by Stage</h2>
          <div class="funnel-bars">
            ${stageMetrics.map(s => {
              const widthPercent = initialVolume > 0 ? (s.exitVolume / initialVolume) * 100 : 0;
              return `
                <div class="funnel-row">
                  <div class="funnel-label">${s.stageName}</div>
                  <div class="funnel-bar-container">
                    <div class="funnel-bar" style="width: ${widthPercent}%"></div>
                    ${s.dropOff > 0 ? `<span class="funnel-dropoff">-${s.dropOff.toLocaleString()}</span>` : ''}
                  </div>
                  <div class="funnel-value">${s.exitVolume.toLocaleString()} (${Math.round(widthPercent)}%)</div>
                </div>
              `;
            }).join('')}
          </div>
          
          <h2>Stage-by-Stage Breakdown</h2>
          <table>
            <thead>
              <tr>
                <th>Stage</th>
                <th class="num">Entry</th>
                <th class="num">Drop-off</th>
                <th class="num">Exit</th>
                <th class="num">Rate</th>
                <th class="num">Cost/Client</th>
                <th class="num">Good Cost</th>
                <th class="num">Bad Cost</th>
              </tr>
            </thead>
            <tbody>
              ${stageMetrics.map(s => `
                <tr>
                  <td>${s.stageName}</td>
                  <td class="num">${s.entryVolume.toLocaleString()}</td>
                  <td class="num text-red">${s.dropOff > 0 ? '-' + s.dropOff.toLocaleString() : '—'}</td>
                  <td class="num">${s.exitVolume.toLocaleString()}</td>
                  <td class="num">${s.completionRate.toFixed(1)}%</td>
                  <td class="num">${formatCurrency(s.stageCostPerClient)}</td>
                  <td class="num text-green">${formatCurrency(s.stageInvestment)}</td>
                  <td class="num text-red">${s.wastedCost > 0 ? formatCurrency(s.wastedCost) : '—'}</td>
                </tr>
              `).join('')}
              <tr class="total-row">
                <td><strong>Total</strong></td>
                <td class="num">${initialVolume.toLocaleString()}</td>
                <td class="num text-red">-${totalDropOff.toLocaleString()}</td>
                <td class="num">${finalVolume.toLocaleString()}</td>
                <td class="num">${overallConversionRate.toFixed(1)}%</td>
                <td class="num">${formatCurrency(stageMetrics.reduce((acc, s) => acc + s.stageCostPerClient, 0))}</td>
                <td class="num text-green">${formatCurrency(totalStageInvestment)}</td>
                <td class="num text-red">${formatCurrency(totalWastedCost)}</td>
              </tr>
            </tbody>
          </table>
          
          ${worstStage || mostWasteful ? `
          <div class="insights-grid">
            ${worstStage ? `
            <div class="insight-card insight-warning">
              <div class="insight-icon">⚠️</div>
              <div class="insight-content">
                <div class="insight-title">Biggest Drop-off</div>
                <div class="insight-value">${worstStage.stageName}</div>
                <div class="insight-detail">${worstStage.dropOff.toLocaleString()} clients lost (${(100 - worstStage.completionRate).toFixed(0)}% drop-off rate)</div>
              </div>
            </div>
            ` : ''}
            ${mostWasteful ? `
            <div class="insight-card insight-cost">
              <div class="insight-icon">💸</div>
              <div class="insight-content">
                <div class="insight-title">Most Costly Drop-off</div>
                <div class="insight-value">${mostWasteful.stageName}</div>
                <div class="insight-detail">${formatCurrency(mostWasteful.wastedCost)} wasted on ${mostWasteful.dropOff.toLocaleString()} lost clients</div>
              </div>
            </div>
            ` : ''}
          </div>
          ` : ''}
        `;
      }
      
      const html = `
<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>${journeyTitle} - ${reportSubtitle}</title>
  <style>
    @page { margin: 15mm; size: A4; }
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
      color: #1F2937;
      line-height: 1.5;
      padding: 40px;
      max-width: 1000px;
      margin: 0 auto;
      font-size: 13px;
    }
    .header {
      border-bottom: 3px solid #192B45;
      padding-bottom: 16px;
      margin-bottom: 24px;
    }
    .header h1 {
      font-size: 32px;
      font-weight: 600;
      color: #192B45;
      margin-bottom: 4px;
    }
    .header .subtitle {
      font-size: 18px;
      color: #64748B;
      margin-bottom: 4px;
    }
    .header .date {
      font-size: 12px;
      color: #94A3B8;
    }
    .header .owner {
      font-size: 13px;
      color: #64748B;
      margin-bottom: 4px;
    }
    .period-label {
      font-size: 14px;
      color: #64748B;
      margin-bottom: 20px;
    }
    .section-intro {
      font-size: 13px;
      color: #64748B;
      margin-bottom: 12px;
    }
    .summary-grid {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 12px;
      margin-bottom: 24px;
    }
    .summary-grid.cols-3 {
      grid-template-columns: repeat(3, 1fr);
    }
    .summary-card {
      background: #F8FAFC;
      border: 1px solid #E2E8F0;
      border-radius: 8px;
      padding: 14px;
      text-align: center;
    }
    .summary-card.highlight-green { background: #D1FAE5; border-color: #A7F3D0; }
    .summary-card.highlight-red { background: #FEE2E2; border-color: #FECACA; }
    .summary-card.highlight-amber { background: #FEF3C7; border-color: #FDE68A; }
    .summary-value {
      font-size: 22px;
      font-weight: 700;
      color: #192B45;
    }
    .summary-label {
      font-size: 10px;
      color: #64748B;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      margin-top: 4px;
    }
    .two-column {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 24px;
      margin-bottom: 24px;
    }
    h2 {
      font-size: 14px;
      font-weight: 600;
      color: #192B45;
      margin: 20px 0 10px;
      padding-bottom: 6px;
      border-bottom: 1px solid #E2E8F0;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 12px;
      margin-bottom: 16px;
    }
    th, td {
      padding: 8px 10px;
      text-align: left;
      border-bottom: 1px solid #E2E8F0;
    }
    th {
      background: #F8FAFC;
      font-weight: 600;
      color: #475569;
      font-size: 10px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }
    .num { text-align: right; }
    .rank-col { width: 30px; }
    .rank { 
      text-align: center;
      font-weight: 600;
      color: #64748B;
    }
    .meta {
      font-size: 10px;
      color: #94A3B8;
      margin-top: 2px;
    }
    .text-green { color: #059669; }
    .text-red { color: #DC2626; }
    .badge {
      display: inline-block;
      padding: 2px 8px;
      border-radius: 4px;
      font-size: 10px;
      font-weight: 600;
      text-transform: uppercase;
    }
    .badge-high { background: #D1FAE5; color: #059669; }
    .badge-medium { background: #FEF3C7; color: #B45309; }
    .badge-low { background: #E2E8F0; color: #64748B; }
    .badge-none { background: #F1F5F9; color: #94A3B8; }
    .stage-section { margin-bottom: 24px; page-break-inside: avoid; }
    .stage-header-bar {
      background: #2D8A6E;
      color: #FFF;
      padding: 10px 16px;
      border-radius: 8px 8px 0 0;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .stage-title { font-weight: 600; font-size: 13px; }
    .stage-meta { font-size: 11px; opacity: 0.85; }
    .stage-table { border-radius: 0 0 8px 8px; overflow: hidden; }
    .stage-table th { background: #F1F5F9; }
    .pain-point { font-size: 11px; color: #B84A5A; margin-bottom: 2px; }
    .funnel-bars {
      margin-bottom: 24px;
    }
    .funnel-row {
      display: flex;
      align-items: center;
      margin-bottom: 8px;
    }
    .funnel-label {
      width: 180px;
      font-size: 12px;
      color: #475569;
      text-align: right;
      padding-right: 12px;
      flex-shrink: 0;
    }
    .funnel-bar-container {
      flex: 1;
      height: 24px;
      background: #F1F5F9;
      border-radius: 4px;
      position: relative;
      overflow: visible;
    }
    .funnel-bar {
      height: 100%;
      background: linear-gradient(90deg, #456A8A 0%, #5A8AA8 100%);
      border-radius: 4px;
      min-width: 2px;
    }
    .funnel-dropoff {
      position: absolute;
      right: -50px;
      top: 50%;
      transform: translateY(-50%);
      font-size: 10px;
      color: #DC2626;
      font-weight: 600;
      background: #FEE2E2;
      padding: 2px 6px;
      border-radius: 4px;
    }
    .funnel-value {
      width: 100px;
      font-size: 12px;
      color: #64748B;
      text-align: right;
      padding-left: 60px;
      flex-shrink: 0;
    }
    .total-row {
      background: #F8FAFC;
      font-weight: 600;
    }
    .total-row td {
      border-top: 2px solid #E2E8F0;
    }
    .insights-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 16px;
      margin-top: 24px;
    }
    .insight-card {
      display: flex;
      gap: 12px;
      padding: 16px;
      border-radius: 8px;
    }
    .insight-warning {
      background: #FEF3C7;
    }
    .insight-cost {
      background: #FEE2E2;
    }
    .insight-icon {
      font-size: 24px;
    }
    .insight-content {
      flex: 1;
    }
    .insight-title {
      font-size: 10px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      color: #78716C;
      margin-bottom: 4px;
    }
    .insight-value {
      font-size: 16px;
      font-weight: 600;
      color: #1F2937;
      margin-bottom: 4px;
    }
    .insight-detail {
      font-size: 12px;
      color: #78716C;
    }
    .footer {
      margin-top: 32px;
      padding-top: 16px;
      border-top: 1px solid #E2E8F0;
      font-size: 10px;
      color: #94A3B8;
      text-align: center;
    }
    @media print {
      body { padding: 0; }
      .no-print { display: none; }
      .two-column { break-inside: avoid; }
      .funnel-bars { break-inside: avoid; }
      .insights-grid { break-inside: avoid; }
      .funnel-dropoff { 
        position: static;
        margin-left: 8px;
        transform: none;
      }
    }
  </style>
</head>
<body>
  <div class="header">
    <h1>${journeyTitle}</h1>
    <div class="subtitle">${reportSubtitle}</div>
    ${journeyOwner ? `<div class="owner">Owner: ${journeyOwner}</div>` : ''}
    <div class="date">Generated ${date}</div>
  </div>
  
  ${reportContent}
  
  <div class="footer">
    Generated by Fathom · Journey Intelligence Platform · v8.8.0
  </div>
  
  <div class="no-print" style="margin-top: 24px; text-align: center;">
    <button onclick="window.print()" style="background: #192B45; color: white; border: none; padding: 12px 24px; border-radius: 8px; font-size: 14px; cursor: pointer;">
      🖨️ Print / Save as PDF
    </button>
  </div>
</body>
</html>`;
      
      const blob = new Blob([html], { type: 'text/html' });
      const url = URL.createObjectURL(blob);
      window.open(url, '_blank');
    };

    // Funnel calculation helpers
    const calculateFunnelMetrics = (config) => {
      const { funnel, stages, personas } = config;
      if (!funnel?.enabled || !funnel?.initialVolume) {
        return null;
      }

      let currentVolume = funnel.initialVolume;
      let totalStageInvestment = 0;
      let totalWastedCost = 0;
      let totalCostPerClient = 0;
      
      const stageMetrics = stages.map((stage, index) => {
        const entryVolume = currentVolume;
        
        // Cost per client for THIS stage only
        const stageCostPerClient = stage.steps.reduce((acc, step) => acc + calculateStepCost(step, personas), 0);
        totalCostPerClient += stageCostPerClient;
        
        const dropOff = stage.dropOffCount || 0;
        const exitVolume = Math.max(0, entryVolume - dropOff);
        const completionRate = entryVolume > 0 ? (exitVolume / entryVolume) * 100 : 0;
        
        // Stage Investment = clients who PASSED × cost (productive spend)
        const stageInvestment = exitVolume * stageCostPerClient;
        totalStageInvestment += stageInvestment;
        
        // Wasted = drop-offs × cost for THIS stage (unproductive spend)
        const wastedCost = dropOff * stageCostPerClient;
        totalWastedCost += wastedCost;
        
        currentVolume = exitVolume;
        
        return {
          stageId: stage.id,
          stageName: stage.name,
          entryVolume,
          exitVolume,
          dropOff,
          completionRate,
          stageCostPerClient,
          stageInvestment,
          wastedCost
        };
      });

      const finalVolume = currentVolume;
      const overallConversionRate = funnel.initialVolume > 0 
        ? (finalVolume / funnel.initialVolume) * 100 
        : 0;
      
      const totalDropOff = funnel.initialVolume - finalVolume;

      return {
        initialVolume: funnel.initialVolume,
        finalVolume,
        totalDropOff,
        overallConversionRate,
        totalCostPerClient,
        totalStageInvestment,
        totalWastedCost,
        periodLabel: funnel.periodLabel || 'per period',
        stageMetrics
      };
    };

    // Funnel Dashboard Component
    function FunnelDashboard({ config, formatTime, onClose }) {
      const funnelMetrics = calculateFunnelMetrics(config);
      
      if (!funnelMetrics) {
        return (
          <div style={{ padding: '24px 32px' }}>
            <p>Funnel tracking is not enabled. Enable it in settings to see volume and cost analysis.</p>
          </div>
        );
      }

      const { stageMetrics, initialVolume, finalVolume, totalDropOff, overallConversionRate, totalCostPerClient, totalStageInvestment, totalWastedCost, periodLabel } = funnelMetrics;
      
      const worstStage = [...stageMetrics].sort((a, b) => a.completionRate - b.completionRate)[0];
      const mostWasteful = [...stageMetrics].sort((a, b) => b.wastedCost - a.wastedCost)[0];

      return (
        <div style={{ padding: '20px 24px' }}>
          <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: '20px' }}>
            <h3 style={{ margin: 0, fontSize: '18px', fontWeight: 600, display: 'flex', alignItems: 'center', gap: '8px' }}>
              <span>🔻</span> Funnel Analysis Dashboard
            </h3>
            <div style={{ display: 'flex', gap: '12px', alignItems: 'center' }}>
              <span style={{ fontFamily: "'Interstate', sans-serif", fontSize: '12px', color: '#556275' }}>{periodLabel}</span>
              <button 
                onClick={() => exportReport('funnel', { title: config?.meta?.title || config?.title || 'Journey Map', owner: config?.meta?.owner }, {
                  stageMetrics, initialVolume, finalVolume, totalDropOff, overallConversionRate, 
                  totalStageInvestment, totalWastedCost, periodLabel, worstStage, mostWasteful
                })}
                style={{ 
                  background: '#E1EEF2', 
                  border: 'none', 
                  padding: '6px 12px', 
                  borderRadius: '6px', 
                  fontSize: '13px', 
                  cursor: 'pointer', 
                  color: '#456A8A',
                  display: 'flex',
                  alignItems: 'center',
                  gap: '6px',
                  fontFamily: "'Interstate', sans-serif"
                }}
              >
                📥 Export
              </button>
              {onClose && (
                <button onClick={onClose} style={{ background: 'none', border: 'none', fontSize: '20px', cursor: 'pointer', color: '#8A95A5', padding: '0 4px' }}>×</button>
              )}
            </div>
          </div>
          
          {/* Summary Cards */}
          <div style={{ display: 'grid', gridTemplateColumns: 'repeat(auto-fit, minmax(min(130px, 100%), 1fr))', gap: '12px', marginBottom: '24px' }}>
            <div style={{ background: '#E1EEF2', padding: '14px', borderRadius: '12px', textAlign: 'center' }}>
              <div style={{ fontSize: '20px', fontWeight: 700, color: '#456A8A' }}>{initialVolume.toLocaleString()}</div>
              <div style={{ fontSize: '10px', color: '#456A8A', fontFamily: "'Interstate', sans-serif", marginTop: '4px' }}>Initial Volume</div>
            </div>
            <div style={{ background: '#D4EDE5', padding: '14px', borderRadius: '12px', textAlign: 'center' }}>
              <div style={{ fontSize: '20px', fontWeight: 700, color: '#2D8A6E' }}>{finalVolume.toLocaleString()}</div>
              <div style={{ fontSize: '10px', color: '#2D8A6E', fontFamily: "'Interstate', sans-serif", marginTop: '4px' }}>Completed</div>
            </div>
            <div style={{ background: '#F5E0E3', padding: '14px', borderRadius: '12px', textAlign: 'center' }}>
              <div style={{ fontSize: '20px', fontWeight: 700, color: '#B84A5A' }}>{totalDropOff.toLocaleString()}</div>
              <div style={{ fontSize: '10px', color: '#B84A5A', fontFamily: "'Interstate', sans-serif", marginTop: '4px' }}>Total Drop-off</div>
            </div>
            <div style={{ background: '#E1EEF2', padding: '14px', borderRadius: '12px', textAlign: 'center' }}>
              <div style={{ fontSize: '20px', fontWeight: 700, color: '#5A5B8A' }}>{overallConversionRate.toFixed(1)}%</div>
              <div style={{ fontSize: '10px', color: '#5A5B8A', fontFamily: "'Interstate', sans-serif", marginTop: '4px' }}>Conversion Rate</div>
            </div>
            <div style={{ background: '#D4EDE5', padding: '14px', borderRadius: '12px', textAlign: 'center' }}>
              <div style={{ fontSize: '20px', fontWeight: 700, color: '#2D8A6E' }}>{formatCurrency(totalStageInvestment)}</div>
              <div style={{ fontSize: '10px', color: '#2D8A6E', fontFamily: "'Interstate', sans-serif", marginTop: '4px' }}>Good Cost</div>
            </div>
            <div style={{ background: '#F5E0E3', padding: '14px', borderRadius: '12px', textAlign: 'center' }}>
              <div style={{ fontSize: '20px', fontWeight: 700, color: '#B84A5A' }}>{formatCurrency(totalWastedCost)}</div>
              <div style={{ fontSize: '10px', color: '#B84A5A', fontFamily: "'Interstate', sans-serif", marginTop: '4px' }}>Bad Cost</div>
            </div>
            <div style={{ background: '#FAF0D6', padding: '14px', borderRadius: '12px', textAlign: 'center' }}>
              <div style={{ fontSize: '20px', fontWeight: 700, color: '#8B6914' }}>{formatCurrency(totalStageInvestment + totalWastedCost)}</div>
              <div style={{ fontSize: '10px', color: '#8B6914', fontFamily: "'Interstate', sans-serif", marginTop: '4px' }}>Total Spend</div>
            </div>
          </div>

          {/* Funnel Visualization */}
          <div style={{ marginBottom: '24px' }}>
            <div style={{ fontSize: '11px', fontFamily: "'Interstate', sans-serif", color: '#556275', marginBottom: '12px', textTransform: 'uppercase', letterSpacing: '0.5px' }}>
              Volume Flow by Stage
            </div>
            <div style={{ display: 'flex', flexDirection: 'column', gap: '8px' }}>
              {stageMetrics.map((stage, i) => {
                const widthPercent = initialVolume > 0 ? (stage.exitVolume / initialVolume) * 100 : 0;
                return (
                  <div key={stage.stageId} style={{ display: 'flex', alignItems: 'center', gap: '12px' }}>
                    <div style={{ width: '160px', fontSize: '12px', fontFamily: "'Interstate', sans-serif", color: '#3D4A5C', textAlign: 'right' }}>{stage.stageName}</div>
                    <div style={{ flex: 1, position: 'relative', height: '28px', background: '#F4F5F7', borderRadius: '4px' }}>
                      <div style={{ 
                        position: 'absolute', 
                        left: 0, 
                        top: 0, 
                        height: '100%', 
                        width: `${widthPercent}%`, 
                        background: getStageColor(i), 
                        borderRadius: '4px', 
                        transition: 'width 0.3s',
                        minWidth: widthPercent > 0 ? '4px' : '0'
                      }} />
                      {stage.dropOff > 0 && (
                        <div style={{ 
                          position: 'absolute', 
                          left: `${widthPercent}%`, 
                          top: '50%', 
                          transform: 'translateY(-50%)', 
                          background: '#B84A5A', 
                          color: '#FFF', 
                          padding: '3px 8px', 
                          borderRadius: '4px', 
                          fontSize: '11px', 
                          fontFamily: "'Interstate', sans-serif", 
                          fontWeight: 600, 
                          marginLeft: '8px',
                          whiteSpace: 'nowrap'
                        }}>-{stage.dropOff.toLocaleString()}</div>
                      )}
                    </div>
                    <div style={{ width: '90px', fontSize: '12px', fontFamily: "'Interstate', sans-serif", color: '#556275', textAlign: 'right' }}>
                      {stage.exitVolume.toLocaleString()} <span style={{ color: '#8A95A5' }}>({widthPercent.toFixed(0)}%)</span>
                    </div>
                  </div>
                );
              })}
            </div>
          </div>

          {/* Stage Breakdown Table */}
          <div style={{ marginTop: '24px' }}>
            <div style={{ fontSize: '11px', fontFamily: "'Interstate', sans-serif", color: '#556275', marginBottom: '8px', textTransform: 'uppercase', letterSpacing: '0.5px' }}>Stage-by-Stage Breakdown</div>
            <div style={{ overflowX: 'auto' }}>
              <table style={{ width: '100%', borderCollapse: 'collapse', fontFamily: "'Interstate', sans-serif", fontSize: '12px' }}>
                <thead>
                  <tr style={{ borderBottom: '2px solid #E4E7EB' }}>
                    <th style={{ textAlign: 'left', padding: '10px 8px', color: '#556275', fontWeight: 600 }}>Stage</th>
                    <th style={{ textAlign: 'right', padding: '10px 8px', color: '#556275', fontWeight: 600 }}>Entry</th>
                    <th style={{ textAlign: 'right', padding: '10px 8px', color: '#556275', fontWeight: 600 }}>Drop-off</th>
                    <th style={{ textAlign: 'right', padding: '10px 8px', color: '#556275', fontWeight: 600 }}>Exit</th>
                    <th style={{ textAlign: 'right', padding: '10px 8px', color: '#556275', fontWeight: 600 }}>Rate</th>
                    <th style={{ textAlign: 'right', padding: '10px 8px', color: '#556275', fontWeight: 600 }}>Cost/Client</th>
                    <th style={{ textAlign: 'right', padding: '10px 8px', color: '#2D8A6E', fontWeight: 600 }}>Good Cost</th>
                    <th style={{ textAlign: 'right', padding: '10px 8px', color: '#B84A5A', fontWeight: 600 }}>Bad Cost</th>
                  </tr>
                </thead>
                <tbody>
                  {stageMetrics.map((stage, i) => (
                    <tr key={stage.stageId} style={{ borderBottom: '1px solid #E9EEF4' }}>
                      <td style={{ padding: '10px 8px', fontWeight: 500 }}><span style={{ display: 'inline-block', width: '8px', height: '8px', borderRadius: '2px', background: getStageColor(i), marginRight: '8px' }} />{stage.stageName}</td>
                      <td style={{ textAlign: 'right', padding: '10px 8px', color: '#456A8A' }}>{stage.entryVolume.toLocaleString()}</td>
                      <td style={{ textAlign: 'right', padding: '10px 8px', color: stage.dropOff > 0 ? '#B84A5A' : '#8A95A5' }}>{stage.dropOff > 0 ? `-${stage.dropOff.toLocaleString()}` : '—'}</td>
                      <td style={{ textAlign: 'right', padding: '10px 8px', color: '#2D8A6E' }}>{stage.exitVolume.toLocaleString()}</td>
                      <td style={{ textAlign: 'right', padding: '10px 8px' }}><span style={{ padding: '2px 8px', borderRadius: '10px', background: stage.completionRate >= 90 ? '#D4EDE5' : stage.completionRate >= 70 ? '#FAF0D6' : '#F5E0E3', color: stage.completionRate >= 90 ? '#2D8A6E' : stage.completionRate >= 70 ? '#8B6914' : '#B84A5A', fontWeight: 500 }}>{stage.completionRate.toFixed(0)}%</span></td>
                      <td style={{ textAlign: 'right', padding: '10px 8px', color: '#556275' }}>{formatCurrency(stage.stageCostPerClient)}</td>
                      <td style={{ textAlign: 'right', padding: '10px 8px', fontWeight: 500, color: '#2D8A6E' }}>{formatCurrency(stage.stageInvestment)}</td>
                      <td style={{ textAlign: 'right', padding: '10px 8px', color: '#B84A5A', fontWeight: stage.wastedCost > 0 ? 600 : 400 }}>{stage.wastedCost > 0 ? formatCurrency(stage.wastedCost) : '—'}</td>
                    </tr>
                  ))}
                </tbody>
                <tfoot>
                  <tr style={{ borderTop: '2px solid #E4E7EB', background: '#F4F5F7' }}>
                    <td style={{ padding: '10px 8px', fontWeight: 600 }}>Total</td>
                    <td style={{ textAlign: 'right', padding: '10px 8px', fontWeight: 600, color: '#456A8A' }}>{initialVolume.toLocaleString()}</td>
                    <td style={{ textAlign: 'right', padding: '10px 8px', fontWeight: 600, color: '#B84A5A' }}>-{totalDropOff.toLocaleString()}</td>
                    <td style={{ textAlign: 'right', padding: '10px 8px', fontWeight: 600, color: '#2D8A6E' }}>{finalVolume.toLocaleString()}</td>
                    <td style={{ textAlign: 'right', padding: '10px 8px', fontWeight: 600 }}>{overallConversionRate.toFixed(1)}%</td>
                    <td style={{ textAlign: 'right', padding: '10px 8px', fontWeight: 600, color: '#556275' }}>{formatCurrency(totalCostPerClient)}</td>
                    <td style={{ textAlign: 'right', padding: '10px 8px', fontWeight: 600, color: '#2D8A6E' }}>{formatCurrency(totalStageInvestment)}</td>
                    <td style={{ textAlign: 'right', padding: '10px 8px', fontWeight: 600, color: '#B84A5A' }}>{formatCurrency(totalWastedCost)}</td>
                  </tr>
                </tfoot>
              </table>
            </div>
          </div>

          {/* Insights */}
          <div style={{ marginTop: '24px', display: 'grid', gridTemplateColumns: 'repeat(auto-fit, minmax(min(280px, 100%), 1fr))', gap: '16px' }}>
            <div style={{ background: '#F5E0E3', border: '1px solid #FECACA', borderRadius: '12px', padding: '16px' }}>
              <div style={{ fontSize: '11px', fontFamily: "'Interstate', sans-serif", color: '#B84A5A', textTransform: 'uppercase', letterSpacing: '0.5px', marginBottom: '8px' }}>⚠️ Biggest Drop-off</div>
              <div style={{ fontSize: '16px', fontWeight: 600, color: '#B84A5A' }}>{worstStage.stageName}</div>
              <div style={{ fontSize: '12px', color: '#B84A5A', fontFamily: "'Interstate', sans-serif", marginTop: '4px' }}>{worstStage.dropOff.toLocaleString()} clients lost ({(100 - worstStage.completionRate).toFixed(0)}% drop-off rate)</div>
            </div>
            <div style={{ background: '#FAF0D6', border: '1px solid #F0DDA8', borderRadius: '12px', padding: '16px' }}>
              <div style={{ fontSize: '11px', fontFamily: "'Interstate', sans-serif", color: '#8B6914', textTransform: 'uppercase', letterSpacing: '0.5px', marginBottom: '8px' }}>💸 Most Costly Drop-off</div>
              <div style={{ fontSize: '16px', fontWeight: 600, color: '#8B6914' }}>{mostWasteful.stageName}</div>
              <div style={{ fontSize: '12px', color: '#C4942A', fontFamily: "'Interstate', sans-serif", marginTop: '4px' }}>{formatCurrency(mostWasteful.wastedCost)} wasted on {mostWasteful.dropOff.toLocaleString()} lost clients</div>
            </div>
          </div>
        </div>
      );
    }

    // Funnel Settings Modal
    function FunnelSettingsModal({ config, onUpdate, onClose }) {
      const [localFunnel, setLocalFunnel] = useState({
        enabled: config.funnel?.enabled ?? false,
        initialVolume: config.funnel?.initialVolume ?? 1000,
        periodLabel: config.funnel?.periodLabel ?? 'per quarter'
      });
      const [localStages, setLocalStages] = useState(
        config.stages.map(s => ({ id: s.id, name: s.name, dropOffCount: s.dropOffCount || 0 }))
      );

      const handleSave = () => {
        onUpdate({
          funnel: localFunnel,
          stages: config.stages.map(stage => {
            const localStage = localStages.find(s => s.id === stage.id);
            return { ...stage, dropOffCount: localStage?.dropOffCount || 0 };
          })
        });
        onClose();
      };

      let runningVolume = localFunnel.initialVolume;
      const preview = localStages.map(stage => {
        const entry = runningVolume;
        const exit = Math.max(0, entry - stage.dropOffCount);
        runningVolume = exit;
        return { ...stage, entry, exit };
      });

      return (
        <div style={{ position: 'fixed', inset: 0, background: 'rgba(0,0,0,0.5)', display: 'flex', alignItems: 'center', justifyContent: 'center', zIndex: 1000 }} onClick={onClose}>
          <div style={{ background: '#FFF', borderRadius: '12px', padding: '32px', width: '600px', maxWidth: '95vw', maxHeight: '90vh', overflow: 'auto', boxShadow: '0 20px 60px rgba(0,0,0,0.3)' }} onClick={e => e.stopPropagation()}>
            <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: '24px' }}>
              <h3 style={{ margin: 0, fontSize: '18px', fontWeight: 600 }}>📊 Funnel Settings</h3>
              <button onClick={onClose} style={{ background: 'none', border: 'none', fontSize: '20px', cursor: 'pointer', color: '#8A95A5' }}>×</button>
            </div>

            <div style={{ marginBottom: '24px', padding: '16px', background: '#F4F5F7', borderRadius: '8px' }}>
              <label style={{ display: 'flex', alignItems: 'center', gap: '12px', cursor: 'pointer' }}>
                <input type="checkbox" checked={localFunnel.enabled} onChange={(e) => setLocalFunnel(prev => ({ ...prev, enabled: e.target.checked }))} style={{ width: '18px', height: '18px', cursor: 'pointer' }} />
                <div>
                  <div style={{ fontWeight: 500, fontSize: '14px' }}>Enable Funnel Tracking</div>
                  <div style={{ fontSize: '12px', color: '#556275', fontFamily: "'Interstate', sans-serif" }}>Track volume, drop-offs, and calculate wasted costs</div>
                </div>
              </label>
            </div>

            {localFunnel.enabled && (
              <>
                <div style={{ marginBottom: '24px' }}>
                  <label style={{ display: 'block', fontSize: '12px', fontFamily: "'Interstate', sans-serif", color: '#556275', marginBottom: '6px', textTransform: 'uppercase', letterSpacing: '0.5px' }}>Initial Volume (Starting Clients)</label>
                  <div style={{ display: 'flex', gap: '12px' }}>
                    <input type="number" value={localFunnel.initialVolume} onChange={(e) => setLocalFunnel(prev => ({ ...prev, initialVolume: parseInt(e.target.value) || 0 }))} style={{ flex: 1, padding: '10px 14px', border: '2px solid #E4E7EB', borderRadius: '8px', fontSize: '16px', fontFamily: "'Interstate', sans-serif" }} />
                    <input type="text" value={localFunnel.periodLabel} onChange={(e) => setLocalFunnel(prev => ({ ...prev, periodLabel: e.target.value }))} placeholder="per quarter" style={{ width: '150px', padding: '10px 14px', border: '2px solid #E4E7EB', borderRadius: '8px', fontSize: '14px', fontFamily: "'Interstate', sans-serif" }} />
                  </div>
                </div>

                <div>
                  <label style={{ display: 'block', fontSize: '12px', fontFamily: "'Interstate', sans-serif", color: '#556275', marginBottom: '12px', textTransform: 'uppercase', letterSpacing: '0.5px' }}>Drop-off per Stage</label>
                  <div style={{ display: 'flex', flexDirection: 'column', gap: '8px' }}>
                    {localStages.map((stage, i) => {
                      const previewData = preview[i];
                      return (
                        <div key={stage.id} style={{ display: 'flex', alignItems: 'center', gap: '12px', padding: '12px 16px', background: '#F4F5F7', borderRadius: '8px', borderLeft: `3px solid ${getStageColor(i)}` }}>
                          <div style={{ flex: 1 }}>
                            <div style={{ fontWeight: 500, fontSize: '13px' }}>{stage.name}</div>
                            <div style={{ fontSize: '11px', color: '#556275', fontFamily: "'Interstate', sans-serif", marginTop: '2px' }}>{previewData.entry.toLocaleString()} → {previewData.exit.toLocaleString()}</div>
                          </div>
                          <div style={{ display: 'flex', alignItems: 'center', gap: '8px' }}>
                            <span style={{ fontSize: '12px', color: '#556275', fontFamily: "'Interstate', sans-serif" }}>Drop:</span>
                            <input type="number" value={stage.dropOffCount} onChange={(e) => { const value = parseInt(e.target.value) || 0; setLocalStages(prev => prev.map(s => s.id === stage.id ? { ...s, dropOffCount: value } : s)); }} style={{ width: '80px', padding: '6px 10px', border: '2px solid #E4E7EB', borderRadius: '6px', fontSize: '14px', fontFamily: "'Interstate', sans-serif", textAlign: 'right' }} />
                          </div>
                        </div>
                      );
                    })}
                  </div>
                </div>

                <div style={{ marginTop: '24px', padding: '16px', background: '#EFF6FF', borderRadius: '8px', border: '1px solid #BDD6DE' }}>
                  <div style={{ fontSize: '12px', fontFamily: "'Interstate', sans-serif", color: '#456A8A', fontWeight: 600, marginBottom: '8px' }}>Preview</div>
                  <div style={{ display: 'flex', gap: '24px', fontSize: '13px', fontFamily: "'Interstate', sans-serif" }}>
                    <div><span style={{ color: '#556275' }}>Start: </span><span style={{ fontWeight: 600 }}>{localFunnel.initialVolume.toLocaleString()}</span></div>
                    <div><span style={{ color: '#556275' }}>Complete: </span><span style={{ fontWeight: 600, color: '#2D8A6E' }}>{runningVolume.toLocaleString()}</span></div>
                    <div><span style={{ color: '#556275' }}>Conversion: </span><span style={{ fontWeight: 600, color: '#5A5B8A' }}>{localFunnel.initialVolume > 0 ? ((runningVolume / localFunnel.initialVolume) * 100).toFixed(1) : 0}%</span></div>
                  </div>
                </div>
              </>
            )}

            <div style={{ marginTop: '24px', display: 'flex', gap: '12px', justifyContent: 'flex-end' }}>
              <button onClick={onClose} style={{ padding: '10px 20px', background: '#F4F5F7', border: 'none', borderRadius: '8px', cursor: 'pointer', fontFamily: "'Interstate', sans-serif", fontSize: '14px', fontWeight: 500 }}>Cancel</button>
              <button onClick={handleSave} style={{ padding: '10px 20px', background: '#1A2332', color: '#FFF', border: 'none', borderRadius: '8px', cursor: 'pointer', fontFamily: "'Interstate', sans-serif", fontSize: '14px', fontWeight: 500 }}>Save Changes</button>
            </div>
          </div>
        </div>
      );
    }

    // Journey Settings Panel - Configure cost model and event settings
    function JourneySettingsPanel({ config, setConfig, onClose }) {
      const costModel = config.meta?.costModel || 'client';
      const isEventMode = costModel === 'event';
      const [localEventConfig, setLocalEventConfig] = useState(config.meta?.eventConfig || {
        capacity: 1000,
        durationMinutes: 180,
        frequency: 'single',
        eventsPerPeriod: 1,
        periodLabel: ''
      });

      const handleSave = () => {
        setConfig(prev => ({
          ...prev,
          meta: {
            ...prev.meta,
            eventConfig: isEventMode ? localEventConfig : null
          }
        }));
        onClose();
      };

      const toggleCostModel = (model) => {
        if (config.meta?.eventConfig && model !== config.meta?.costModel) {
          if (!confirm('Changing the cost model will affect how costs are calculated. Continue?')) {
            return;
          }
        }
        setConfig(prev => ({
          ...prev,
          meta: {
            ...prev.meta,
            costModel: model,
            eventConfig: model === 'event' ? localEventConfig : null
          }
        }));
      };

      return (
        <div style={{
          position: 'fixed',
          inset: 0,
          background: 'rgba(0,0,0,0.5)',
          display: 'flex',
          alignItems: 'center',
          justifyContent: 'center',
          zIndex: 1000
        }} onClick={onClose}>
          <div style={{
            background: '#FFF',
            borderRadius: '12px',
            padding: '32px',
            width: '700px',
            maxWidth: '95vw',
            maxHeight: '90vh',
            overflow: 'auto'
          }} onClick={e => e.stopPropagation()}>
            <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: '8px' }}>
              <h3 style={{ margin: 0, fontSize: '20px' }}>⚙️ Journey Settings</h3>
              <button onClick={onClose} style={{ background: 'none', border: 'none', fontSize: '24px', cursor: 'pointer', color: '#6E7B8C' }}>×</button>
            </div>
            <p style={{ margin: '0 0 24px', color: '#556275', fontSize: '14px', fontFamily: "'Interstate', sans-serif" }}>
              Configure how costs are calculated for this journey.
            </p>

            {/* Cost Model Selection */}
            <div style={{ marginBottom: '24px' }}>
              <label style={{ display: 'block', fontSize: '12px', fontWeight: 600, color: '#3D4A5C', marginBottom: '12px', textTransform: 'uppercase', letterSpacing: '0.5px', fontFamily: "'Interstate', sans-serif" }}>
                Cost Model
              </label>
              <div style={{ display: 'grid', gridTemplateColumns: 'repeat(3, 1fr)', gap: '12px' }}>
                {/* Client Journey Option */}
                <button
                  onClick={() => toggleCostModel('client')}
                  style={{
                    padding: '16px',
                    border: `2px solid ${costModel === 'client' ? '#5B8A9A' : '#E4E7EB'}`,
                    borderRadius: '8px',
                    background: costModel === 'client' ? 'rgba(91, 138, 154, 0.08)' : '#FFF',
                    cursor: 'pointer',
                    textAlign: 'left',
                    fontFamily: "'Interstate', sans-serif"
                  }}
                >
                  <div style={{ fontSize: '16px', fontWeight: 600, color: '#1A2332', marginBottom: '4px' }}>
                    🚶 Client
                  </div>
                  <div style={{ fontSize: '12px', color: '#6E7B8C', lineHeight: 1.4 }}>
                    Customer flows through sequentially. Cost per client.
                  </div>
                  {costModel === 'client' && (
                    <div style={{ marginTop: '8px', fontSize: '11px', color: '#5B8A9A', fontWeight: 600 }}>✓ SELECTED</div>
                  )}
                </button>

                {/* Project/Pursuit Option */}
                <button
                  onClick={() => toggleCostModel('project')}
                  style={{
                    padding: '16px',
                    border: `2px solid ${costModel === 'project' ? '#5A5B8A' : '#E4E7EB'}`,
                    borderRadius: '8px',
                    background: costModel === 'project' ? 'rgba(90, 91, 138, 0.08)' : '#FFF',
                    cursor: 'pointer',
                    textAlign: 'left',
                    fontFamily: "'Interstate', sans-serif"
                  }}
                >
                  <div style={{ fontSize: '16px', fontWeight: 600, color: '#1A2332', marginBottom: '4px' }}>
                    🎯 Project
                  </div>
                  <div style={{ fontSize: '12px', color: '#6E7B8C', lineHeight: 1.4 }}>
                    Internal pursuit or delivery. Cost per project.
                  </div>
                  {costModel === 'project' && (
                    <div style={{ marginTop: '8px', fontSize: '11px', color: '#5A5B8A', fontWeight: 600 }}>✓ SELECTED</div>
                  )}
                </button>

                {/* Event/Batch Option */}
                <button
                  onClick={() => toggleCostModel('event')}
                  style={{
                    padding: '16px',
                    border: `2px solid ${costModel === 'event' ? '#C4942A' : '#E4E7EB'}`,
                    borderRadius: '8px',
                    background: costModel === 'event' ? 'rgba(196, 148, 42, 0.08)' : '#FFF',
                    cursor: 'pointer',
                    textAlign: 'left',
                    fontFamily: "'Interstate', sans-serif"
                  }}
                >
                  <div style={{ fontSize: '16px', fontWeight: 600, color: '#1A2332', marginBottom: '4px' }}>
                    🎪 Event
                  </div>
                  <div style={{ fontSize: '12px', color: '#6E7B8C', lineHeight: 1.4 }}>
                    Fixed capacity, many participants. Cost per event.
                  </div>
                  {costModel === 'event' && (
                    <div style={{ marginTop: '8px', fontSize: '11px', color: '#C4942A', fontWeight: 600 }}>✓ SELECTED</div>
                  )}
                </button>
              </div>
              
              {/* Extended descriptions */}
              <div style={{ marginTop: '16px', padding: '16px', background: '#F4F5F7', borderRadius: '8px', fontSize: '13px', color: '#556275', lineHeight: 1.6, fontFamily: "'Interstate', sans-serif" }}>
                {costModel === 'client' && (
                  <>
                    <strong style={{ color: '#1A2332' }}>Client Journey:</strong> One customer at a time flows through your process. Staff time is directly attributed per journey. 
                    <br/><em>Examples: Client onboarding, mortgage application, wealth management, customer support case.</em>
                  </>
                )}
                {costModel === 'project' && (
                  <>
                    <strong style={{ color: '#1A2332' }}>Project/Pursuit:</strong> Your team pursues or delivers a project with multiple workstreams. Costs are project-based, not per-participant.
                    <br/><em>Examples: Construction tender, RFP response, deal pursuit, product development, consulting engagement.</em>
                  </>
                )}
                {costModel === 'event' && (
                  <>
                    <strong style={{ color: '#1A2332' }}>Event/Batch:</strong> Fixed capacity event where many participants experience simultaneously. Staff deployed regardless of attendance.
                    <br/><em>Examples: Stadium matchday, conference, concert, training session, batch processing.</em>
                  </>
                )}
              </div>
            </div>

            {/* Event Configuration (only shown in event mode) */}
            {isEventMode && (
              <div style={{ background: '#FAF0D6', borderRadius: '8px', padding: '20px', border: '1px solid #E4C87A' }}>
                <div style={{ fontSize: '14px', fontWeight: 600, color: '#8B6914', marginBottom: '16px', fontFamily: "'Interstate', sans-serif" }}>
                  🎪 Event Configuration
                </div>
                
                <div style={{ display: 'grid', gridTemplateColumns: '1fr 1fr', gap: '16px' }}>
                  <div>
                    <label style={{ display: 'block', fontSize: '11px', color: '#556275', marginBottom: '6px', fontFamily: "'Interstate', sans-serif" }}>Event Capacity</label>
                    <input
                      type="number"
                      value={localEventConfig.capacity || ''}
                      onChange={(e) => setLocalEventConfig(prev => ({ ...prev, capacity: parseInt(e.target.value) || 0 }))}
                      placeholder="e.g. 40000"
                      style={{ width: '100%', padding: '10px 12px', border: '2px solid #E4E7EB', borderRadius: '6px', fontSize: '14px', boxSizing: 'border-box', fontFamily: "'Interstate', sans-serif" }}
                    />
                    <div style={{ fontSize: '10px', color: '#8A95A5', marginTop: '4px', fontFamily: "'Interstate', sans-serif" }}>Max attendees per event</div>
                  </div>
                  
                  <div>
                    <label style={{ display: 'block', fontSize: '11px', color: '#556275', marginBottom: '6px', fontFamily: "'Interstate', sans-serif" }}>Event Duration (mins)</label>
                    <input
                      type="number"
                      value={localEventConfig.durationMinutes || ''}
                      onChange={(e) => setLocalEventConfig(prev => ({ ...prev, durationMinutes: parseInt(e.target.value) || 0 }))}
                      placeholder="e.g. 360"
                      style={{ width: '100%', padding: '10px 12px', border: '2px solid #E4E7EB', borderRadius: '6px', fontSize: '14px', boxSizing: 'border-box', fontFamily: "'Interstate', sans-serif" }}
                    />
                    <div style={{ fontSize: '10px', color: '#8A95A5', marginTop: '4px', fontFamily: "'Interstate', sans-serif" }}>Total event duration</div>
                  </div>
                  
                  <div>
                    <label style={{ display: 'block', fontSize: '11px', color: '#556275', marginBottom: '6px', fontFamily: "'Interstate', sans-serif" }}>Frequency</label>
                    <select
                      value={localEventConfig.frequency || 'single'}
                      onChange={(e) => setLocalEventConfig(prev => ({ ...prev, frequency: e.target.value }))}
                      style={{ width: '100%', padding: '10px 12px', border: '2px solid #E4E7EB', borderRadius: '6px', fontSize: '14px', boxSizing: 'border-box', background: '#FFF', fontFamily: "'Interstate', sans-serif" }}
                    >
                      <option value="single">Single Event</option>
                      <option value="season">Season/Series</option>
                      <option value="annual">Annual</option>
                    </select>
                  </div>
                  
                  {localEventConfig.frequency !== 'single' && (
                    <div>
                      <label style={{ display: 'block', fontSize: '11px', color: '#556275', marginBottom: '6px', fontFamily: "'Interstate', sans-serif" }}>Events per Period</label>
                      <input
                        type="number"
                        value={localEventConfig.eventsPerPeriod || ''}
                        onChange={(e) => setLocalEventConfig(prev => ({ ...prev, eventsPerPeriod: parseInt(e.target.value) || 1 }))}
                        placeholder="e.g. 19"
                        style={{ width: '100%', padding: '10px 12px', border: '2px solid #E4E7EB', borderRadius: '6px', fontSize: '14px', boxSizing: 'border-box', fontFamily: "'Interstate', sans-serif" }}
                      />
                    </div>
                  )}
                  
                  <div style={{ gridColumn: localEventConfig.frequency === 'single' ? '2' : '1 / -1' }}>
                    <label style={{ display: 'block', fontSize: '11px', color: '#556275', marginBottom: '6px', fontFamily: "'Interstate', sans-serif" }}>Period Label (optional)</label>
                    <input
                      type="text"
                      value={localEventConfig.periodLabel || ''}
                      onChange={(e) => setLocalEventConfig(prev => ({ ...prev, periodLabel: e.target.value }))}
                      placeholder="e.g. 2025-26 Season"
                      style={{ width: '100%', padding: '10px 12px', border: '2px solid #E4E7EB', borderRadius: '6px', fontSize: '14px', boxSizing: 'border-box', fontFamily: "'Interstate', sans-serif" }}
                    />
                  </div>
                </div>

                {/* Summary */}
                {localEventConfig.capacity > 0 && (
                  <div style={{ marginTop: '16px', padding: '12px', background: '#FFF', borderRadius: '6px', display: 'flex', justifyContent: 'space-between', alignItems: 'center' }}>
                    <span style={{ fontSize: '12px', color: '#8B6914', fontFamily: "'Interstate', sans-serif" }}>
                      {localEventConfig.frequency === 'single' ? 'Single event' : `${localEventConfig.eventsPerPeriod || 1} events`}
                      {localEventConfig.periodLabel && ` · ${localEventConfig.periodLabel}`}
                    </span>
                    <span style={{ fontSize: '14px', fontWeight: 700, color: '#8B6914', fontFamily: "'Interstate', sans-serif" }}>
                      {((localEventConfig.eventsPerPeriod || 1) * (localEventConfig.capacity || 0)).toLocaleString()} total capacity
                    </span>
                  </div>
                )}
              </div>
            )}

            {/* Info note */}
            <div style={{ marginTop: '20px', padding: '12px', background: '#E1EEF2', borderRadius: '6px', fontSize: '12px', color: '#3A6070', fontFamily: "'Interstate', sans-serif" }}>
              <strong>💡 Tip:</strong> {isEventMode 
                ? " In Event mode, configure each role's deployment (headcount & hours) in the Role Management panel. Per-attendee costs will be calculated automatically."
                : " Per-Journey mode calculates costs based on time spent by each role per individual journey."
              }
            </div>

            <div style={{ marginTop: '24px', display: 'flex', justifyContent: 'flex-end', gap: '12px' }}>
              <button onClick={onClose} style={{ padding: '10px 20px', background: '#F4F5F7', border: 'none', borderRadius: '6px', cursor: 'pointer', fontSize: '14px', fontWeight: 500, fontFamily: "'Interstate', sans-serif" }}>Cancel</button>
              <button
                onClick={handleSave}
                style={{ padding: '10px 24px', background: '#2D8A6E', color: '#FFF', border: 'none', borderRadius: '6px', cursor: 'pointer', fontSize: '14px', fontWeight: 500, fontFamily: "'Interstate', sans-serif" }}
              >
                Save Changes
              </button>
            </div>
          </div>
        </div>
      );
    }

    // Event Economics Panel - Dashboard for event-based cost analysis
    function EventEconomicsPanel({ config, formatTime }) {
      const eventConfig = config.meta?.eventConfig || {};
      const personas = config.personas || [];
      const stages = config.stages || [];
      
      // Calculate event costs per persona
      const calculatePersonaEventCost = (persona) => {
        if (!persona || persona.isExternal) return 0;
        const deployment = persona.eventDeployment || { headcount: 1, hoursPerEvent: 4, rateType: 'hourly' };
        const hourlyRate = calculateFullyLoadedRate(persona);
        
        if (deployment.rateType === 'fixed') {
          return (deployment.fixedFeePerEvent || 0) * (deployment.headcount || 1);
        } else if (deployment.rateType === 'external') {
          return deployment.externalRecharge || 0;
        } else {
          return hourlyRate * (deployment.hoursPerEvent || 0) * (deployment.headcount || 1);
        }
      };
      
      // Get internal personas with costs
      const internalPersonas = personas.filter(p => !p.isExternal);
      const externalPersonas = personas.filter(p => p.isExternal);
      
      // Calculate totals
      const totalStaff = internalPersonas.reduce((sum, p) => sum + (p.eventDeployment?.headcount || 1), 0);
      const totalEventCost = internalPersonas.reduce((sum, p) => sum + calculatePersonaEventCost(p), 0);
      const costPerAttendee = eventConfig.capacity > 0 ? totalEventCost / eventConfig.capacity : 0;
      const staffRatio = eventConfig.capacity > 0 && totalStaff > 0 ? Math.round(eventConfig.capacity / totalStaff) : 0;
      const eventsPerPeriod = eventConfig.eventsPerPeriod || 1;
      const seasonTotal = totalEventCost * eventsPerPeriod;
      
      // Group costs by rate type
      const costByType = {
        hourly: internalPersonas.filter(p => (p.eventDeployment?.rateType || 'hourly') === 'hourly' || (p.eventDeployment?.rateType || 'hourly') === 'salary').reduce((sum, p) => sum + calculatePersonaEventCost(p), 0),
        fixed: internalPersonas.filter(p => p.eventDeployment?.rateType === 'fixed').reduce((sum, p) => sum + calculatePersonaEventCost(p), 0),
        external: internalPersonas.filter(p => p.eventDeployment?.rateType === 'external').reduce((sum, p) => sum + calculatePersonaEventCost(p), 0)
      };
      
      // Sort personas by event cost (descending)
      const sortedPersonas = [...internalPersonas].sort((a, b) => calculatePersonaEventCost(b) - calculatePersonaEventCost(a));
      
      // Calculate stage-level event time
      const stageMetrics = stages.map((stage, idx) => {
        const stageTime = stage.steps.reduce((sum, step) => sum + (step.timeMinutes || 0), 0);
        return {
          ...stage,
          index: idx,
          totalTime: stageTime,
          stepCount: stage.steps.length
        };
      });

      return (
        <div style={{ padding: '24px', fontFamily: "'Interstate', sans-serif" }}>
          {/* Hero Metrics */}
          <div style={{ display: 'grid', gridTemplateColumns: 'repeat(auto-fit, minmax(150px, 1fr))', gap: '16px', marginBottom: '32px' }}>
            {/* Per Attendee Cost - Hero */}
            <div style={{ background: 'linear-gradient(135deg, #C4942A 0%, #8B6914 100%)', borderRadius: '12px', padding: '20px', color: '#FFF', gridColumn: 'span 2' }}>
              <div style={{ fontSize: '12px', opacity: 0.8, marginBottom: '4px' }}>Cost Per Attendee</div>
              <div style={{ fontSize: '36px', fontWeight: 700 }}>{formatCurrency(costPerAttendee)}</div>
              <div style={{ fontSize: '12px', opacity: 0.8, marginTop: '4px' }}>
                {formatCurrency(totalEventCost)} ÷ {(eventConfig.capacity || 0).toLocaleString()} capacity
              </div>
            </div>
            
            {/* Total Event Cost */}
            <div style={{ background: '#FFF', borderRadius: '12px', padding: '20px', border: '1px solid #E4E7EB' }}>
              <div style={{ fontSize: '11px', color: '#6E7B8C', marginBottom: '4px' }}>Event Cost</div>
              <div style={{ fontSize: '28px', fontWeight: 700, color: '#192B45' }}>{formatCurrency(totalEventCost)}</div>
            </div>
            
            {/* Total Staff */}
            <div style={{ background: '#FFF', borderRadius: '12px', padding: '20px', border: '1px solid #E4E7EB' }}>
              <div style={{ fontSize: '11px', color: '#6E7B8C', marginBottom: '4px' }}>Staff Deployed</div>
              <div style={{ fontSize: '28px', fontWeight: 700, color: '#192B45' }}>{totalStaff.toLocaleString()}</div>
            </div>
            
            {/* Staff:Attendee Ratio */}
            <div style={{ background: '#FFF', borderRadius: '12px', padding: '20px', border: '1px solid #E4E7EB' }}>
              <div style={{ fontSize: '11px', color: '#6E7B8C', marginBottom: '4px' }}>Staff:Attendee</div>
              <div style={{ fontSize: '28px', fontWeight: 700, color: '#192B45' }}>1:{staffRatio || '—'}</div>
            </div>
            
            {/* Event Duration */}
            <div style={{ background: '#FFF', borderRadius: '12px', padding: '20px', border: '1px solid #E4E7EB' }}>
              <div style={{ fontSize: '11px', color: '#6E7B8C', marginBottom: '4px' }}>Event Duration</div>
              <div style={{ fontSize: '28px', fontWeight: 700, color: '#192B45' }}>{formatTime(eventConfig.durationMinutes || 0)}</div>
            </div>
            
            {/* Cost Per Hour */}
            <div style={{ background: '#FFF', borderRadius: '12px', padding: '20px', border: '1px solid #E4E7EB' }}>
              <div style={{ fontSize: '11px', color: '#6E7B8C', marginBottom: '4px' }}>Cost/Hour</div>
              <div style={{ fontSize: '28px', fontWeight: 700, color: '#192B45' }}>
                {eventConfig.durationMinutes > 0 ? formatCurrency(totalEventCost / (eventConfig.durationMinutes / 60)) : '—'}
              </div>
            </div>
          </div>

          {/* Season/Period Summary (if applicable) */}
          {eventConfig.frequency !== 'single' && eventsPerPeriod > 1 && (
            <div style={{ background: '#FAF0D6', borderRadius: '12px', padding: '20px', marginBottom: '32px', border: '1px solid #E4C87A' }}>
              <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', flexWrap: 'wrap', gap: '16px' }}>
                <div>
                  <div style={{ fontSize: '12px', color: '#8B6914', marginBottom: '4px' }}>
                    {eventConfig.periodLabel || 'Season'} Total ({eventsPerPeriod} events)
                  </div>
                  <div style={{ fontSize: '32px', fontWeight: 700, color: '#8B6914' }}>{formatCurrency(seasonTotal)}</div>
                </div>
                <div style={{ display: 'flex', gap: '24px' }}>
                  <div style={{ textAlign: 'center' }}>
                    <div style={{ fontSize: '20px', fontWeight: 700, color: '#8B6914' }}>{(eventsPerPeriod * (eventConfig.capacity || 0)).toLocaleString()}</div>
                    <div style={{ fontSize: '11px', color: '#A67C1A' }}>Total Capacity</div>
                  </div>
                  <div style={{ textAlign: 'center' }}>
                    <div style={{ fontSize: '20px', fontWeight: 700, color: '#8B6914' }}>{formatCurrency(seasonTotal / (eventsPerPeriod * (eventConfig.capacity || 1)))}</div>
                    <div style={{ fontSize: '11px', color: '#A67C1A' }}>Avg/Attendee</div>
                  </div>
                </div>
              </div>
            </div>
          )}

          {/* Two Column Layout */}
          <div style={{ display: 'grid', gridTemplateColumns: 'repeat(auto-fit, minmax(300px, 1fr))', gap: '24px' }}>
            
            {/* Staff Deployment Table */}
            <div style={{ background: '#FFF', borderRadius: '12px', padding: '20px', border: '1px solid #E4E7EB' }}>
              <h4 style={{ margin: '0 0 16px', fontSize: '14px', fontWeight: 600, color: '#192B45' }}>
                👥 Staff Deployment
              </h4>
              <div style={{ display: 'flex', flexDirection: 'column', gap: '8px' }}>
                {sortedPersonas.map(persona => {
                  const cost = calculatePersonaEventCost(persona);
                  const deployment = persona.eventDeployment || { headcount: 1, hoursPerEvent: 4, rateType: 'hourly' };
                  const costPercent = totalEventCost > 0 ? (cost / totalEventCost) * 100 : 0;
                  
                  return (
                    <div key={persona.id} style={{ 
                      display: 'flex', 
                      alignItems: 'center', 
                      gap: '12px', 
                      padding: '12px',
                      background: '#F4F5F7',
                      borderRadius: '8px',
                      borderLeft: `4px solid ${persona.color}`
                    }}>
                      <div style={{ flex: 1, minWidth: 0 }}>
                        <div style={{ fontWeight: 600, fontSize: '13px', color: '#192B45', marginBottom: '2px' }}>
                          {persona.label}
                        </div>
                        <div style={{ fontSize: '11px', color: '#6E7B8C' }}>
                          {deployment.headcount} × {deployment.hoursPerEvent}h
                          {deployment.rateType === 'fixed' && ' (fixed)'}
                          {deployment.rateType === 'external' && ' (external)'}
                        </div>
                      </div>
                      <div style={{ textAlign: 'right' }}>
                        <div style={{ fontWeight: 700, fontSize: '14px', color: '#192B45' }}>
                          {formatCurrency(cost)}
                        </div>
                        <div style={{ fontSize: '10px', color: '#6E7B8C' }}>
                          {costPercent.toFixed(1)}%
                        </div>
                      </div>
                    </div>
                  );
                })}
              </div>
              
              {/* Cost by Type Summary */}
              <div style={{ marginTop: '16px', paddingTop: '16px', borderTop: '1px solid #E4E7EB' }}>
                <div style={{ fontSize: '11px', color: '#6E7B8C', marginBottom: '8px', textTransform: 'uppercase', letterSpacing: '0.5px' }}>
                  By Rate Type
                </div>
                <div style={{ display: 'flex', gap: '12px', flexWrap: 'wrap' }}>
                  {costByType.hourly > 0 && (
                    <div style={{ padding: '8px 12px', background: '#E9EEF4', borderRadius: '6px' }}>
                      <div style={{ fontSize: '10px', color: '#456A8A' }}>Hourly/Salary</div>
                      <div style={{ fontSize: '14px', fontWeight: 600, color: '#192B45' }}>{formatCurrency(costByType.hourly)}</div>
                    </div>
                  )}
                  {costByType.fixed > 0 && (
                    <div style={{ padding: '8px 12px', background: '#E1EEF2', borderRadius: '6px' }}>
                      <div style={{ fontSize: '10px', color: '#3A6070' }}>Fixed Fees</div>
                      <div style={{ fontSize: '14px', fontWeight: 600, color: '#192B45' }}>{formatCurrency(costByType.fixed)}</div>
                    </div>
                  )}
                  {costByType.external > 0 && (
                    <div style={{ padding: '8px 12px', background: '#FAF0D6', borderRadius: '6px' }}>
                      <div style={{ fontSize: '10px', color: '#8B6914' }}>External</div>
                      <div style={{ fontSize: '14px', fontWeight: 600, color: '#192B45' }}>{formatCurrency(costByType.external)}</div>
                    </div>
                  )}
                </div>
              </div>
            </div>

            {/* Journey Timeline */}
            <div style={{ background: '#FFF', borderRadius: '12px', padding: '20px', border: '1px solid #E4E7EB' }}>
              <h4 style={{ margin: '0 0 16px', fontSize: '14px', fontWeight: 600, color: '#192B45' }}>
                🎪 Event Timeline
              </h4>
              <div style={{ position: 'relative' }}>
                {/* Timeline bar */}
                <div style={{ 
                  position: 'absolute', 
                  left: '12px', 
                  top: '24px', 
                  bottom: '24px', 
                  width: '2px', 
                  background: '#E4E7EB' 
                }} />
                
                <div style={{ display: 'flex', flexDirection: 'column', gap: '12px' }}>
                  {stageMetrics.map((stage, idx) => {
                    const timePercent = eventConfig.durationMinutes > 0 
                      ? (stage.totalTime / eventConfig.durationMinutes) * 100 
                      : 0;
                    
                    return (
                      <div key={stage.id} style={{ display: 'flex', alignItems: 'flex-start', gap: '16px', paddingLeft: '4px' }}>
                        {/* Timeline dot */}
                        <div style={{ 
                          width: '18px', 
                          height: '18px', 
                          borderRadius: '50%', 
                          background: getStageColor(idx),
                          border: '3px solid #FFF',
                          boxShadow: '0 0 0 2px ' + getStageColor(idx),
                          flexShrink: 0,
                          marginTop: '2px'
                        }} />
                        
                        <div style={{ flex: 1 }}>
                          <div style={{ fontWeight: 600, fontSize: '13px', color: '#192B45', marginBottom: '4px' }}>
                            {stage.name}
                          </div>
                          <div style={{ display: 'flex', gap: '12px', fontSize: '11px', color: '#6E7B8C' }}>
                            <span>{formatTime(stage.totalTime)}</span>
                            <span>•</span>
                            <span>{stage.stepCount} steps</span>
                            {timePercent > 0 && (
                              <>
                                <span>•</span>
                                <span>{timePercent.toFixed(0)}% of event</span>
                              </>
                            )}
                          </div>
                          {/* Mini progress bar */}
                          <div style={{ marginTop: '6px', height: '4px', background: '#E4E7EB', borderRadius: '2px', overflow: 'hidden' }}>
                            <div style={{ 
                              height: '100%', 
                              width: `${Math.min(timePercent, 100)}%`, 
                              background: getStageColor(idx),
                              borderRadius: '2px'
                            }} />
                          </div>
                        </div>
                      </div>
                    );
                  })}
                </div>
              </div>
              
              {/* Total check */}
              <div style={{ marginTop: '16px', paddingTop: '16px', borderTop: '1px solid #E4E7EB', display: 'flex', justifyContent: 'space-between', alignItems: 'center' }}>
                <span style={{ fontSize: '12px', color: '#6E7B8C' }}>Journey Total</span>
                <span style={{ fontSize: '14px', fontWeight: 600, color: '#192B45' }}>
                  {formatTime(stageMetrics.reduce((sum, s) => sum + s.totalTime, 0))}
                  {eventConfig.durationMinutes > 0 && (
                    <span style={{ 
                      marginLeft: '8px', 
                      fontSize: '11px', 
                      color: stageMetrics.reduce((sum, s) => sum + s.totalTime, 0) > eventConfig.durationMinutes ? '#B84A5A' : '#2D8A6E' 
                    }}>
                      ({((stageMetrics.reduce((sum, s) => sum + s.totalTime, 0) / eventConfig.durationMinutes) * 100).toFixed(0)}% of {formatTime(eventConfig.durationMinutes)} event)
                    </span>
                  )}
                </span>
              </div>
            </div>
          </div>

          {/* Capacity Planning Insight */}
          <div style={{ marginTop: '24px', background: '#E9EEF4', borderRadius: '12px', padding: '20px' }}>
            <h4 style={{ margin: '0 0 12px', fontSize: '14px', fontWeight: 600, color: '#192B45' }}>
              💡 Capacity Insights
            </h4>
            <div style={{ display: 'grid', gridTemplateColumns: 'repeat(auto-fit, minmax(200px, 1fr))', gap: '16px' }}>
              <div>
                <div style={{ fontSize: '11px', color: '#6E7B8C', marginBottom: '4px' }}>Break-even Attendance</div>
                <div style={{ fontSize: '18px', fontWeight: 600, color: '#192B45' }}>
                  {/* Assuming £15 average spend per attendee */}
                  {Math.ceil(totalEventCost / 15).toLocaleString()} attendees
                </div>
                <div style={{ fontSize: '10px', color: '#8A95A5' }}>@ £15 avg spend</div>
              </div>
              <div>
                <div style={{ fontSize: '11px', color: '#6E7B8C', marginBottom: '4px' }}>Utilisation at 80% Capacity</div>
                <div style={{ fontSize: '18px', fontWeight: 600, color: '#192B45' }}>
                  {formatCurrency(totalEventCost / ((eventConfig.capacity || 1) * 0.8))}/head
                </div>
                <div style={{ fontSize: '10px', color: '#8A95A5' }}>{Math.round((eventConfig.capacity || 0) * 0.8).toLocaleString()} attendees</div>
              </div>
              <div>
                <div style={{ fontSize: '11px', color: '#6E7B8C', marginBottom: '4px' }}>Staff Productivity</div>
                <div style={{ fontSize: '18px', fontWeight: 600, color: '#192B45' }}>
                  {totalStaff > 0 ? formatCurrency(totalEventCost / totalStaff) : '—'}/staff
                </div>
                <div style={{ fontSize: '10px', color: '#8A95A5' }}>Avg cost per staff member</div>
              </div>
            </div>
          </div>

          {/* Step-Level Cost Attribution */}
          <div style={{ marginTop: '24px', background: '#FFF', borderRadius: '12px', padding: '20px', border: '1px solid #E4E7EB' }}>
            <h4 style={{ margin: '0 0 16px', fontSize: '14px', fontWeight: 600, color: '#192B45' }}>
              📋 Step-Level Cost Attribution
            </h4>
            <div style={{ overflowX: 'auto' }}>
              <table style={{ width: '100%', borderCollapse: 'collapse', fontFamily: "'Interstate', sans-serif", fontSize: '12px' }}>
                <thead>
                  <tr style={{ background: '#F4F5F7' }}>
                    <th style={{ padding: '10px 12px', textAlign: 'left', fontWeight: 600, color: '#556275', borderBottom: '2px solid #E4E7EB' }}>Step</th>
                    <th style={{ padding: '10px 12px', textAlign: 'center', fontWeight: 600, color: '#556275', borderBottom: '2px solid #E4E7EB' }}>Peak Load</th>
                    <th style={{ padding: '10px 12px', textAlign: 'center', fontWeight: 600, color: '#556275', borderBottom: '2px solid #E4E7EB' }}>Active Roles</th>
                    <th style={{ padding: '10px 12px', textAlign: 'right', fontWeight: 600, color: '#556275', borderBottom: '2px solid #E4E7EB' }}>Fixed</th>
                    <th style={{ padding: '10px 12px', textAlign: 'right', fontWeight: 600, color: '#556275', borderBottom: '2px solid #E4E7EB' }}>Variable</th>
                    <th style={{ padding: '10px 12px', textAlign: 'right', fontWeight: 600, color: '#8B6914', borderBottom: '2px solid #E4E7EB' }}>Step Total</th>
                  </tr>
                </thead>
                <tbody>
                  {stages.flatMap((stage, stageIdx) => 
                    stage.steps.map((step, stepIdx) => {
                      const eventCosts = step.eventCosts || {};
                      const peakFactor = eventCosts.peakLoadFactor || 1.0;
                      const activeRoles = eventCosts.activeRoles || [];
                      const fixedCost = eventCosts.fixedCosts || 0;
                      const variableCost = (eventCosts.variableCostPerHead || 0) * (eventConfig.capacity || 0);
                      const stepTotal = fixedCost + variableCost;
                      
                      const peakLabel = peakFactor >= 2.0 ? '🔥 Extreme' : peakFactor >= 1.5 ? '😰 High' : peakFactor >= 1.25 ? '😅 Busy' : '😊 Normal';
                      
                      return (
                        <tr key={step.id} style={{ borderBottom: '1px solid #E4E7EB' }}>
                          <td style={{ padding: '10px 12px' }}>
                            <div style={{ fontWeight: 500, color: '#192B45' }}>{step.name}</div>
                            <div style={{ fontSize: '10px', color: '#8A95A5' }}>{stage.name}</div>
                          </td>
                          <td style={{ padding: '10px 12px', textAlign: 'center' }}>
                            <span style={{ 
                              padding: '4px 8px', 
                              borderRadius: '12px', 
                              fontSize: '11px',
                              background: peakFactor >= 1.5 ? '#FAF0D6' : '#F4F5F7',
                              color: peakFactor >= 1.5 ? '#8B6914' : '#6E7B8C'
                            }}>
                              {peakLabel}
                            </span>
                          </td>
                          <td style={{ padding: '10px 12px', textAlign: 'center' }}>
                            {activeRoles.length > 0 ? (
                              <div style={{ display: 'flex', gap: '4px', justifyContent: 'center', flexWrap: 'wrap' }}>
                                {activeRoles.slice(0, 3).map(roleId => {
                                  const persona = personas.find(p => p.id === roleId);
                                  return persona ? (
                                    <span key={roleId} style={{ 
                                      width: '20px', 
                                      height: '20px', 
                                      borderRadius: '50%', 
                                      background: persona.color,
                                      display: 'inline-block',
                                      border: '2px solid #FFF',
                                      boxShadow: '0 1px 2px rgba(0,0,0,0.1)'
                                    }} title={persona.label} />
                                  ) : null;
                                })}
                                {activeRoles.length > 3 && (
                                  <span style={{ fontSize: '10px', color: '#6E7B8C' }}>+{activeRoles.length - 3}</span>
                                )}
                              </div>
                            ) : (
                              <span style={{ color: '#A9B2BE', fontSize: '11px' }}>—</span>
                            )}
                          </td>
                          <td style={{ padding: '10px 12px', textAlign: 'right', color: fixedCost > 0 ? '#192B45' : '#A9B2BE' }}>
                            {fixedCost > 0 ? formatCurrency(fixedCost) : '—'}
                          </td>
                          <td style={{ padding: '10px 12px', textAlign: 'right', color: variableCost > 0 ? '#192B45' : '#A9B2BE' }}>
                            {variableCost > 0 ? formatCurrency(variableCost) : '—'}
                          </td>
                          <td style={{ padding: '10px 12px', textAlign: 'right', fontWeight: 600, color: stepTotal > 0 ? '#8B6914' : '#A9B2BE' }}>
                            {stepTotal > 0 ? formatCurrency(stepTotal) : '—'}
                          </td>
                        </tr>
                      );
                    })
                  )}
                </tbody>
                <tfoot>
                  <tr style={{ background: '#FAF0D6' }}>
                    <td colSpan="3" style={{ padding: '12px', fontWeight: 600, color: '#8B6914' }}>
                      Total Step Costs
                    </td>
                    <td style={{ padding: '12px', textAlign: 'right', fontWeight: 600, color: '#8B6914' }}>
                      {formatCurrency(stages.flatMap(s => s.steps).reduce((sum, step) => sum + (step.eventCosts?.fixedCosts || 0), 0))}
                    </td>
                    <td style={{ padding: '12px', textAlign: 'right', fontWeight: 600, color: '#8B6914' }}>
                      {formatCurrency(stages.flatMap(s => s.steps).reduce((sum, step) => sum + ((step.eventCosts?.variableCostPerHead || 0) * (eventConfig.capacity || 0)), 0))}
                    </td>
                    <td style={{ padding: '12px', textAlign: 'right', fontWeight: 700, color: '#8B6914', fontSize: '14px' }}>
                      {formatCurrency(stages.flatMap(s => s.steps).reduce((sum, step) => {
                        const ec = step.eventCosts || {};
                        return sum + (ec.fixedCosts || 0) + ((ec.variableCostPerHead || 0) * (eventConfig.capacity || 0));
                      }, 0))}
                    </td>
                  </tr>
                </tfoot>
              </table>
            </div>
            
            {/* High Peak Load Warning */}
            {stages.flatMap(s => s.steps).some(step => (step.eventCosts?.peakLoadFactor || 1.0) >= 1.5) && (
              <div style={{ marginTop: '16px', padding: '12px', background: '#FAF0D6', borderRadius: '8px', border: '1px solid #E4C87A', display: 'flex', alignItems: 'flex-start', gap: '12px' }}>
                <span style={{ fontSize: '18px' }}>⚠️</span>
                <div>
                  <div style={{ fontWeight: 600, color: '#8B6914', marginBottom: '4px', fontSize: '13px' }}>High Peak Load Steps Detected</div>
                  <div style={{ fontSize: '12px', color: '#A67C1A' }}>
                    {stages.flatMap(s => s.steps).filter(step => (step.eventCosts?.peakLoadFactor || 1.0) >= 1.5).map(s => s.name).join(', ')} 
                    — Consider additional staffing or queue management during these periods.
                  </div>
                </div>
              </div>
            )}
          </div>
        </div>
      );
    }

    // Timeline Component
    function Timeline({ stages, totalTime, formatTime, personas, onClose, showCosts = true, config }) {
      let accumulated = 0;
      const totalCost = stages.reduce((acc, stage) => 
        acc + stage.steps.reduce((stepAcc, step) => stepAcc + calculateStepCost(step, personas), 0), 0
      );
      
      // Calculate all step metrics
      const allSteps = stages.flatMap((stage, stageIndex) => 
        stage.steps.map(step => ({ ...step, stageName: stage.name, stageIndex }))
      );
      
      const totalSteps = allSteps.length;
      const avgTimePerStep = totalSteps > 0 ? totalTime / totalSteps : 0;
      
      // Sort by different metrics
      const byTime = [...allSteps].sort((a, b) => b.timeMinutes - a.timeMinutes);
      const byFriction = [...allSteps].sort((a, b) => (b.frictionScore || 3) - (a.frictionScore || 3));
      
      // High friction steps (4 or 5)
      const highFrictionSteps = allSteps.filter(s => (s.frictionScore || 3) >= 4);
      
      // Stage metrics for export
      const stageMetrics = stages.map((stage, i) => {
        const stageTime = stage.steps.reduce((acc, s) => acc + s.timeMinutes, 0);
        const avgFriction = stage.steps.length > 0 
          ? stage.steps.reduce((acc, s) => acc + (s.frictionScore || 3), 0) / stage.steps.length
          : 0;
        return { 
          ...stage, 
          stageIndex: i,
          time: stageTime, 
          avgFriction: avgFriction.toFixed(1),
          stepCount: stage.steps.length
        };
      }).sort((a, b) => b.time - a.time);
      
      // Role time breakdown
      const roleTime = personas.filter(p => !p.isExternal).map(persona => {
        const totalRoleMinutes = allSteps.reduce((acc, step) => {
          const involvement = step.roleInvolvement?.[persona.id];
          return acc + ((involvement?.timeMinutes || 0) * (involvement?.headcount || 1));
        }, 0);
        const stepCount = allSteps.filter(step => {
          const involvement = step.roleInvolvement?.[persona.id];
          return involvement?.timeMinutes > 0;
        }).length;
        return { ...persona, totalMinutes: totalRoleMinutes, stepCount };
      }).sort((a, b) => b.totalMinutes - a.totalMinutes);
      
      // Pain points
      const painPointSteps = allSteps.filter(s => s.painPoints && s.painPoints.length > 0);
      const totalPainPoints = painPointSteps.reduce((acc, s) => acc + s.painPoints.length, 0);
      
      return (
        <div style={{
          padding: '20px 24px'
        }}>
          <div style={{ 
            display: 'flex', 
            justifyContent: 'space-between', 
            alignItems: 'center',
            marginBottom: '20px'
          }}>
            <h3 style={{ 
              margin: 0, 
              fontSize: '18px', 
              fontWeight: 600,
              display: 'flex',
              alignItems: 'center',
              gap: '8px'
            }}>
              <span>📅</span> Timeline Dashboard
            </h3>
            <div style={{ display: 'flex', gap: '12px', alignItems: 'center' }}>
              {showCosts && (
                <span style={{
                  fontFamily: "'Interstate', sans-serif",
                  fontSize: '13px',
                  color: '#8B6914',
                  fontWeight: 600
                }}>
                  💰 {formatCurrency(totalCost)}
                </span>
              )}
              <button 
                onClick={() => exportReport('time', { title: config?.meta?.title || config?.title || 'Journey Map', owner: config?.meta?.owner }, {
                  totalTime, avgTimePerStep, highFrictionSteps: highFrictionSteps.length, totalPainPoints, 
                  stageData: stageMetrics.map(s => ({ name: s.name, stepCount: s.stepCount, time: s.time, avgFriction: s.avgFriction })),
                  formatTime,
                  topTimeSteps: byTime.slice(0, 5),
                  frictionSteps: byFriction.slice(0, 5)
                })}
                style={{ 
                  background: '#E1EEF2', 
                  border: 'none', 
                  padding: '6px 12px', 
                  borderRadius: '6px', 
                  fontSize: '13px', 
                  cursor: 'pointer', 
                  color: '#456A8A',
                  display: 'flex',
                  alignItems: 'center',
                  gap: '6px',
                  fontFamily: "'Interstate', sans-serif"
                }}
              >
                📥 Export
              </button>
              {onClose && (
                <button onClick={onClose} style={{ background: 'none', border: 'none', fontSize: '20px', cursor: 'pointer', color: '#8A95A5', padding: '0 4px' }}>×</button>
              )}
            </div>
          </div>
          
          {/* Summary Cards */}
          <div style={{ display: 'grid', gridTemplateColumns: 'repeat(auto-fit, minmax(min(150px, 100%), 1fr))', gap: '16px', marginBottom: '24px' }}>
            <div style={{ background: '#E1EEF2', padding: '16px', borderRadius: '12px', textAlign: 'center' }}>
              <div style={{ fontSize: '24px', fontWeight: 700, color: '#456A8A' }}>{formatTime(totalTime)}</div>
              <div style={{ fontSize: '11px', color: '#456A8A', fontFamily: "'Interstate', sans-serif", marginTop: '4px' }}>Total Time</div>
            </div>
            <div style={{ background: '#E1EEF2', padding: '16px', borderRadius: '12px', textAlign: 'center' }}>
              <div style={{ fontSize: '24px', fontWeight: 700, color: '#5A5B8A' }}>{formatTime(Math.round(avgTimePerStep))}</div>
              <div style={{ fontSize: '11px', color: '#5A5B8A', fontFamily: "'Interstate', sans-serif", marginTop: '4px' }}>Avg per Step</div>
            </div>
            <div style={{ background: '#F5E0E3', padding: '16px', borderRadius: '12px', textAlign: 'center' }}>
              <div style={{ fontSize: '24px', fontWeight: 700, color: '#B84A5A' }}>{highFrictionSteps.length}</div>
              <div style={{ fontSize: '11px', color: '#B84A5A', fontFamily: "'Interstate', sans-serif", marginTop: '4px' }}>High Friction Steps</div>
            </div>
            <div style={{ background: '#FAF0D6', padding: '16px', borderRadius: '12px', textAlign: 'center' }}>
              <div style={{ fontSize: '24px', fontWeight: 700, color: '#8B6914' }}>{totalPainPoints}</div>
              <div style={{ fontSize: '11px', color: '#8B6914', fontFamily: "'Interstate', sans-serif", marginTop: '4px' }}>Pain Points</div>
            </div>
          </div>
          
          {/* Main timeline bar */}
          <div style={{
            fontSize: '11px',
            fontFamily: "'Interstate', sans-serif",
            color: '#556275',
            marginBottom: '8px',
            textTransform: 'uppercase',
            letterSpacing: '0.5px'
          }}>
            Time Distribution by Stage
          </div>
          <div style={{
            display: 'flex',
            height: '48px',
            borderRadius: '8px',
            background: '#F4F5F7',
            position: 'relative'
          }}>
            {stages.map((stage, i) => {
              const stageTime = stage.steps.reduce((acc, step) => acc + step.timeMinutes, 0);
              const percentage = totalTime > 0 ? (stageTime / totalTime) * 100 : 0;
              accumulated += stageTime;
              
              return (
                <div
                  key={stage.id}
                  className="tooltip"
                  data-tooltip={`${stage.name}: ${formatTime(stageTime)} (${Math.round(percentage)}%)`}
                  style={{
                    width: `${percentage}%`,
                    background: getStageColor(i),
                    display: 'flex',
                    alignItems: 'center',
                    justifyContent: 'center',
                    color: '#FFF',
                    fontFamily: "'Interstate', sans-serif",
                    fontSize: '12px',
                    fontWeight: 500,
                    cursor: 'pointer',
                    transition: 'filter 0.2s',
                    borderRight: i < stages.length - 1 ? '2px solid #FFF' : 'none',
                    borderRadius: i === 0 ? '8px 0 0 8px' : i === stages.length - 1 ? '0 8px 8px 0' : '0'
                  }}
                  onMouseOver={(e) => e.currentTarget.style.filter = 'brightness(1.1)'}
                  onMouseOut={(e) => e.currentTarget.style.filter = 'brightness(1)'}
                >
                  {percentage > 8 && stage.name}
                </div>
              );
            })}
          </div>
          
          <div style={{ marginTop: '24px', display: 'grid', gridTemplateColumns: 'repeat(auto-fit, minmax(min(280px, 100%), 1fr))', gap: '24px' }}>
            {/* Top 5 Longest Steps */}
            <div>
              <h4 style={{ margin: '0 0 12px', fontSize: '13px', fontFamily: "'Interstate', sans-serif", textTransform: 'uppercase', letterSpacing: '0.5px', color: '#556275' }}>
                ⏰ Top 5 Longest Steps
              </h4>
              <div style={{ display: 'flex', flexDirection: 'column', gap: '6px' }}>
                {byTime.slice(0, 5).map((step, i) => (
                  <div key={step.id} style={{
                    display: 'flex',
                    alignItems: 'center',
                    gap: '10px',
                    padding: '10px',
                    background: i === 0 ? '#E1EEF2' : '#F4F5F7',
                    borderRadius: '8px',
                    border: i === 0 ? '1px solid #BDD6DE' : 'none'
                  }}>
                    <div style={{ 
                      width: '22px', 
                      height: '22px', 
                      borderRadius: '50%', 
                      background: i === 0 ? '#456A8A' : '#E4E7EB',
                      color: i === 0 ? '#FFF' : '#556275',
                      display: 'flex',
                      alignItems: 'center',
                      justifyContent: 'center',
                      fontSize: '11px',
                      fontWeight: 600,
                      flexShrink: 0
                    }}>
                      {i + 1}
                    </div>
                    <div style={{ flex: 1, minWidth: 0 }}>
                      <div style={{ fontWeight: 600, fontSize: '12px', whiteSpace: 'nowrap', overflow: 'hidden', textOverflow: 'ellipsis' }}>{step.name}</div>
                      <div style={{ fontSize: '10px', color: '#556275', fontFamily: "'Interstate', sans-serif" }}>{step.stageName}</div>
                    </div>
                    <div style={{ fontWeight: 600, color: '#456A8A', fontSize: '13px', flexShrink: 0 }}>{formatTime(step.timeMinutes)}</div>
                  </div>
                ))}
              </div>
            </div>
            
            {/* Top 5 Highest Friction Steps */}
            <div>
              <h4 style={{ margin: '0 0 12px', fontSize: '13px', fontFamily: "'Interstate', sans-serif", textTransform: 'uppercase', letterSpacing: '0.5px', color: '#556275' }}>
                😰 Highest Friction Steps
              </h4>
              <div style={{ display: 'flex', flexDirection: 'column', gap: '6px' }}>
                {byFriction.slice(0, 5).map((step, i) => {
                  const friction = step.frictionScore || 3;
                  return (
                    <div key={step.id} style={{
                      display: 'flex',
                      alignItems: 'center',
                      gap: '10px',
                      padding: '10px',
                      background: frictionConfig[friction]?.bg || '#F4F5F7',
                      borderRadius: '8px'
                    }}>
                      <div style={{ fontSize: '18px' }}>{frictionConfig[friction]?.emoji}</div>
                      <div style={{ flex: 1, minWidth: 0 }}>
                        <div style={{ fontWeight: 600, fontSize: '12px', whiteSpace: 'nowrap', overflow: 'hidden', textOverflow: 'ellipsis' }}>{step.name}</div>
                        <div style={{ fontSize: '10px', color: '#556275', fontFamily: "'Interstate', sans-serif" }}>{step.stageName} · {formatTime(step.timeMinutes)}</div>
                      </div>
                      <div style={{ 
                        fontWeight: 600, 
                        color: frictionConfig[friction]?.color,
                        fontSize: '12px',
                        flexShrink: 0
                      }}>
                        {friction}/5
                      </div>
                    </div>
                  );
                })}
              </div>
            </div>
            
            {/* Time by Role */}
            <div>
              <h4 style={{ margin: '0 0 12px', fontSize: '13px', fontFamily: "'Interstate', sans-serif", textTransform: 'uppercase', letterSpacing: '0.5px', color: '#556275' }}>
                👥 Time by Role
              </h4>
              <div style={{ display: 'flex', flexDirection: 'column', gap: '6px' }}>
                {roleTime.slice(0, 5).map(role => (
                  <div key={role.id} style={{
                    display: 'flex',
                    alignItems: 'center',
                    gap: '10px',
                    padding: '10px',
                    background: '#F4F5F7',
                    borderRadius: '8px',
                    borderLeft: `3px solid ${role.color}`
                  }}>
                    <div style={{ flex: 1 }}>
                      <div style={{ fontWeight: 600, fontSize: '12px', color: role.color }}>{role.label}</div>
                      <div style={{ fontSize: '10px', color: '#556275', fontFamily: "'Interstate', sans-serif" }}>
                        {role.stepCount} steps
                      </div>
                    </div>
                    <div style={{ textAlign: 'right' }}>
                      <div style={{ fontWeight: 600, color: '#456A8A', fontSize: '13px' }}>{formatTime(role.totalMinutes)}</div>
                      <div style={{ fontSize: '10px', color: '#556275', fontFamily: "'Interstate', sans-serif" }}>
                        {totalTime > 0 ? Math.round((role.totalMinutes / totalTime) * 100) : 0}%
                      </div>
                    </div>
                    <div style={{ 
                      width: '50px', 
                      height: '6px', 
                      background: '#E4E7EB', 
                      borderRadius: '3px',
                      overflow: 'hidden'
                    }}>
                      <div style={{
                        width: `${roleTime[0]?.totalMinutes > 0 ? (role.totalMinutes / roleTime[0].totalMinutes) * 100 : 0}%`,
                        height: '100%',
                        background: role.color
                      }} />
                    </div>
                  </div>
                ))}
              </div>
            </div>
            
            {/* Stage Ranking by Time */}
            <div>
              <h4 style={{ margin: '0 0 12px', fontSize: '13px', fontFamily: "'Interstate', sans-serif", textTransform: 'uppercase', letterSpacing: '0.5px', color: '#556275' }}>
                📊 Stages by Time
              </h4>
              <div style={{ display: 'flex', flexDirection: 'column', gap: '6px' }}>
                {stageMetrics.map((stage, i) => {
                  const roundedFriction = Math.round(stage.avgFriction) || 3;
                  return (
                    <div key={stage.id} style={{
                      display: 'flex',
                      alignItems: 'center',
                      gap: '10px',
                      padding: '10px',
                      background: '#F4F5F7',
                      borderRadius: '8px',
                      borderLeft: `3px solid ${getStageColor(stage.stageIndex)}`
                    }}>
                      <div style={{ flex: 1 }}>
                        <div style={{ fontWeight: 600, fontSize: '12px' }}>{stage.name}</div>
                        <div style={{ fontSize: '10px', color: '#556275', fontFamily: "'Interstate', sans-serif" }}>
                          {stage.stepCount} steps
                        </div>
                      </div>
                      <div style={{ fontSize: '14px' }}>{frictionConfig[roundedFriction]?.emoji}</div>
                      <div style={{ textAlign: 'right' }}>
                        <div style={{ fontWeight: 600, color: '#456A8A', fontSize: '13px' }}>{formatTime(stage.time)}</div>
                        <div style={{ fontSize: '10px', color: '#556275', fontFamily: "'Interstate', sans-serif" }}>
                          {totalTime > 0 ? Math.round((stage.time / totalTime) * 100) : 0}%
                        </div>
                      </div>
                    </div>
                  );
                })}
              </div>
            </div>
          </div>
          
          {/* Friction distribution */}
          <div style={{ marginTop: '24px' }}>
            <div style={{
              fontSize: '11px',
              fontFamily: "'Interstate', sans-serif",
              color: '#556275',
              marginBottom: '8px',
              textTransform: 'uppercase',
              letterSpacing: '0.5px'
            }}>
              Friction Overview
            </div>
            <div style={{ display: 'flex', gap: '12px', flexWrap: 'wrap' }}>
              {[1, 2, 3, 4, 5].map(level => {
                const count = allSteps.filter(s => (s.frictionScore || 3) === level).length;
                return (
                  <div key={level} style={{ 
                    display: 'flex', 
                    alignItems: 'center', 
                    gap: '8px', 
                    padding: '8px 12px', 
                    background: frictionConfig[level]?.bg || '#F4F5F7', 
                    borderRadius: '6px' 
                  }}>
                    <span style={{ fontSize: '16px' }}>{frictionConfig[level]?.emoji}</span>
                    <span style={{
                      fontFamily: "'Interstate', sans-serif",
                      fontSize: '12px',
                      fontWeight: 500
                    }}>
                      {count} steps
                    </span>
                  </div>
                );
              })}
            </div>
          </div>
        </div>
      );
    }

    // Survey Request Modal
    function SurveyRequestModal({ stepId, personaId, config, onClose, onSend }) {
      const step = config.stages.flatMap(s => s.steps).find(st => st.id === stepId);
      const persona = config.personas.find(p => p.id === personaId);
      const stage = config.stages.find(s => s.steps.some(st => st.id === stepId));
      
      if (!step || !persona) {
        onClose();
        return null;
      }
      
      const teamMembers = persona.teamMembers || [];
      const [selectedRecipients, setSelectedRecipients] = useState(teamMembers.map(tm => tm.id));
      const [scope, setScope] = useState('context'); // 'step', 'context', 'full'
      const [message, setMessage] = useState('');
      const [sending, setSending] = useState(false);
      
      const toggleRecipient = (memberId) => {
        setSelectedRecipients(prev => 
          prev.includes(memberId) 
            ? prev.filter(id => id !== memberId)
            : [...prev, memberId]
        );
      };
      
      const toggleSelectAll = () => {
        if (selectedRecipients.length === teamMembers.length) {
          setSelectedRecipients([]);
        } else {
          setSelectedRecipients(teamMembers.map(tm => tm.id));
        }
      };
      
      const handleSend = async () => {
        if (selectedRecipients.length === 0) {
          alert('Please select at least one recipient');
          return;
        }
        
        setSending(true);
        
        try {
          // Prepare survey request data
          const recipients = teamMembers.filter(tm => selectedRecipients.includes(tm.id));
          const surveyRequest = {
            stepId,
            personaId,
            stepName: step.name,
            stageName: stage.name,
            personaLabel: persona.label,
            recipients,
            scope,
            message: message.trim(),
            journeyTitle: config.meta?.title || 'Journey Map',
            requestedAt: new Date().toISOString()
          };
          
          // Get mapId from URL or localStorage
          const urlParams = new URLSearchParams(window.location.search);
          const mapId = urlParams.get('map') || localStorage.getItem('lastMapId') || config.meta?.id || 'demo';
          
          // For demo purposes, store the config so survey page can access it
          // In production, this would be fetched from Supabase by mapId
          if (!urlParams.get('map')) {
            localStorage.setItem('demoJourneyConfig', JSON.stringify(config));
          }
          
          // Generate emails with survey URLs
          const emails = await sendSurveyEmails(surveyRequest, mapId, config);
          
          // Show success modal with email preview
          const emailList = emails.map(e => `📧 ${e.recipient}`).join('\n');
          const shouldOpen = confirm(
            `✅ Survey requests prepared for ${recipients.length} ${recipients.length === 1 ? 'person' : 'people'}!\n\n` +
            `${emailList}\n\n` +
            `📬 For now, clicking OK will open your email client.\n` +
            `🚀 In production, emails would be sent automatically via backend.\n\n` +
            `Open email client now?`
          );
          
          if (shouldOpen && emails.length > 0) {
            // Open first email in client (for demo purposes)
            // In production, all emails would be sent via backend API
            window.open(emails[0].mailto, '_blank');
            
            // Log all survey URLs for testing
            console.log('Survey URLs generated:');
            emails.forEach(e => {
              console.log(`${e.recipient}: ${e.surveyUrl}`);
            });
          }
          
          // Store survey requests in localStorage for tracking (optional)
          const existingRequests = JSON.parse(localStorage.getItem('surveyRequests') || '[]');
          const newRequest = {
            id: generateSurveyToken(),
            ...surveyRequest,
            mapId,
            emails: emails.map(e => ({ recipient: e.recipient, surveyUrl: e.surveyUrl })),
            sentAt: new Date().toISOString()
          };
          localStorage.setItem('surveyRequests', JSON.stringify([...existingRequests, newRequest]));
          
          setSending(false);
          onClose();
          
        } catch (error) {
          console.error('Error sending survey requests:', error);
          alert('Failed to send survey requests. Please try again.');
          setSending(false);
        }
      };
      
      return (
        <div 
          style={{
            position: 'fixed',
            inset: 0,
            background: 'rgba(0,0,0,0.5)',
            display: 'flex',
            alignItems: 'center',
            justifyContent: 'center',
            zIndex: 10000
          }}
          onClick={onClose}
        >
          <div 
            style={{
              background: '#FFF',
              borderRadius: '12px',
              padding: '32px',
              width: '600px',
              maxWidth: '95vw',
              maxHeight: '90vh',
              overflow: 'auto'
            }}
            onClick={e => e.stopPropagation()}
          >
            {/* Header */}
            <div style={{ marginBottom: '8px' }}>
              <h3 style={{ margin: 0, fontSize: '20px', fontFamily: "'Interstate', sans-serif", color: '#192B45' }}>
                Request Feedback: {step.name}
              </h3>
              <p style={{ margin: '4px 0 0', fontSize: '13px', color: '#8A95A5', fontFamily: "'Interstate', sans-serif" }}>
                {stage.name} • {persona.label}
              </p>
            </div>
            
            <div style={{ height: '1px', background: '#E4E7EB', margin: '20px 0' }} />
            
            {/* Recipients Selection */}
            <div style={{ marginBottom: '24px' }}>
              <label style={{ display: 'block', fontFamily: "'Interstate', sans-serif", fontSize: '12px', fontWeight: 600, color: '#556275', marginBottom: '12px' }}>
                Who should we ask? ({teamMembers.length} team {teamMembers.length === 1 ? 'member' : 'members'})
              </label>
              
              {/* Select All */}
              <label style={{ 
                display: 'flex', 
                alignItems: 'center', 
                gap: '10px', 
                padding: '10px 12px',
                background: '#F4F5F7',
                borderRadius: '6px',
                marginBottom: '12px',
                cursor: 'pointer',
                border: '2px solid #E4E7EB'
              }}>
                <input
                  type="checkbox"
                  checked={selectedRecipients.length === teamMembers.length && teamMembers.length > 0}
                  onChange={toggleSelectAll}
                  style={{ width: '16px', height: '16px', cursor: 'pointer' }}
                />
                <span style={{ fontFamily: "'Interstate', sans-serif", fontSize: '13px', fontWeight: 600, color: '#192B45' }}>
                  Select All
                </span>
              </label>
              
              {/* Individual Recipients */}
              <div style={{ display: 'flex', flexDirection: 'column', gap: '8px' }}>
                {teamMembers.map(member => (
                  <label 
                    key={member.id}
                    style={{ 
                      display: 'flex', 
                      alignItems: 'center', 
                      gap: '10px', 
                      padding: '12px',
                      background: selectedRecipients.includes(member.id) ? '#E1EEF2' : '#FFF',
                      border: `2px solid ${selectedRecipients.includes(member.id) ? '#5B8A9A' : '#E4E7EB'}`,
                      borderRadius: '6px',
                      cursor: 'pointer',
                      transition: 'all 0.2s'
                    }}
                  >
                    <input
                      type="checkbox"
                      checked={selectedRecipients.includes(member.id)}
                      onChange={() => toggleRecipient(member.id)}
                      style={{ width: '16px', height: '16px', cursor: 'pointer' }}
                    />
                    <div style={{ flex: 1 }}>
                      <div style={{ fontFamily: "'Interstate', sans-serif", fontSize: '13px', fontWeight: 500, color: '#192B45' }}>
                        {member.name}
                      </div>
                      <div style={{ fontFamily: "'Inter', sans-serif", fontSize: '11px', color: '#8A95A5' }}>
                        {member.email}
                      </div>
                    </div>
                  </label>
                ))}
              </div>
            </div>
            
            {/* Survey Scope */}
            <div style={{ marginBottom: '24px' }}>
              <label style={{ display: 'block', fontFamily: "'Interstate', sans-serif", fontSize: '12px', fontWeight: 600, color: '#556275', marginBottom: '12px' }}>
                Survey Scope
              </label>
              
              <div style={{ display: 'flex', flexDirection: 'column', gap: '10px' }}>
                <label style={{ 
                  display: 'flex', 
                  alignItems: 'flex-start', 
                  gap: '10px', 
                  padding: '12px',
                  background: scope === 'step' ? '#E1EEF2' : '#FFF',
                  border: `2px solid ${scope === 'step' ? '#5B8A9A' : '#E4E7EB'}`,
                  borderRadius: '6px',
                  cursor: 'pointer'
                }}>
                  <input
                    type="radio"
                    name="scope"
                    value="step"
                    checked={scope === 'step'}
                    onChange={(e) => setScope(e.target.value)}
                    style={{ marginTop: '2px', cursor: 'pointer' }}
                  />
                  <div style={{ flex: 1 }}>
                    <div style={{ fontFamily: "'Interstate', sans-serif", fontSize: '13px', fontWeight: 600, color: '#192B45', marginBottom: '4px' }}>
                      This step only
                    </div>
                    <div style={{ fontFamily: "'Interstate', sans-serif", fontSize: '11px', color: '#8A95A5', lineHeight: 1.4 }}>
                      Focus on just this step
                    </div>
                  </div>
                </label>
                
                <label style={{ 
                  display: 'flex', 
                  alignItems: 'flex-start', 
                  gap: '10px', 
                  padding: '12px',
                  background: scope === 'context' ? '#E1EEF2' : '#FFF',
                  border: `2px solid ${scope === 'context' ? '#5B8A9A' : '#E4E7EB'}`,
                  borderRadius: '6px',
                  cursor: 'pointer'
                }}>
                  <input
                    type="radio"
                    name="scope"
                    value="context"
                    checked={scope === 'context'}
                    onChange={(e) => setScope(e.target.value)}
                    style={{ marginTop: '2px', cursor: 'pointer' }}
                  />
                  <div style={{ flex: 1 }}>
                    <div style={{ fontFamily: "'Interstate', sans-serif", fontSize: '13px', fontWeight: 600, color: '#192B45', marginBottom: '4px' }}>
                      This step + surrounding context
                      <span style={{ 
                        marginLeft: '8px',
                        padding: '2px 6px',
                        background: '#2D8A6E',
                        color: '#FFF',
                        borderRadius: '4px',
                        fontSize: '9px',
                        fontWeight: 700,
                        textTransform: 'uppercase',
                        letterSpacing: '0.5px'
                      }}>Recommended</span>
                    </div>
                    <div style={{ fontFamily: "'Interstate', sans-serif", fontSize: '11px', color: '#8A95A5', lineHeight: 1.4 }}>
                      Shows previous step → this step → next step for context
                    </div>
                  </div>
                </label>
                
                <label style={{ 
                  display: 'flex', 
                  alignItems: 'flex-start', 
                  gap: '10px', 
                  padding: '12px',
                  background: scope === 'full' ? '#E1EEF2' : '#FFF',
                  border: `2px solid ${scope === 'full' ? '#5B8A9A' : '#E4E7EB'}`,
                  borderRadius: '6px',
                  cursor: 'pointer'
                }}>
                  <input
                    type="radio"
                    name="scope"
                    value="full"
                    checked={scope === 'full'}
                    onChange={(e) => setScope(e.target.value)}
                    style={{ marginTop: '2px', cursor: 'pointer' }}
                  />
                  <div style={{ flex: 1 }}>
                    <div style={{ fontFamily: "'Interstate', sans-serif", fontSize: '13px', fontWeight: 600, color: '#192B45', marginBottom: '4px' }}>
                      Full journey (filtered to this role)
                    </div>
                    <div style={{ fontFamily: "'Interstate', sans-serif", fontSize: '11px', color: '#8A95A5', lineHeight: 1.4 }}>
                      All steps for {persona.label}
                    </div>
                  </div>
                </label>
              </div>
              
              {scope === 'context' && (
                <div style={{ 
                  marginTop: '12px', 
                  padding: '12px', 
                  background: '#E9EEF4', 
                  borderRadius: '6px',
                  display: 'flex',
                  gap: '8px',
                  alignItems: 'flex-start'
                }}>
                  <span style={{ fontSize: '16px' }}>ℹ️</span>
                  <div style={{ flex: 1, fontSize: '11px', color: '#556275', lineHeight: 1.5, fontFamily: "'Interstate', sans-serif" }}>
                    Recipients will see this step plus the previous and next steps for context. They can only see and edit steps for their role.
                  </div>
                </div>
              )}
            </div>
            
            {/* Optional Message */}
            <div style={{ marginBottom: '24px' }}>
              <label style={{ display: 'block', fontFamily: "'Interstate', sans-serif", fontSize: '12px', fontWeight: 600, color: '#556275', marginBottom: '8px' }}>
                Optional message to recipients
              </label>
              <textarea
                value={message}
                onChange={(e) => setMessage(e.target.value)}
                placeholder="We're reviewing our processes and would value your feedback..."
                rows={3}
                style={{
                  width: '100%',
                  padding: '10px 12px',
                  border: '1px solid #E4E7EB',
                  borderRadius: '6px',
                  fontSize: '13px',
                  fontFamily: "'Interstate', sans-serif",
                  resize: 'vertical',
                  boxSizing: 'border-box'
                }}
              />
            </div>
            
            {/* Buttons */}
            <div style={{ display: 'flex', gap: '12px', justifyContent: 'flex-end' }}>
              <button
                onClick={onClose}
                style={{
                  padding: '10px 20px',
                  background: '#F4F5F7',
                  border: 'none',
                  borderRadius: '6px',
                  cursor: 'pointer',
                  fontFamily: "'Interstate', sans-serif",
                  fontSize: '13px',
                  color: '#556275',
                  fontWeight: 600
                }}
              >
                Cancel
              </button>
              <button
                onClick={handleSend}
                disabled={sending || selectedRecipients.length === 0}
                style={{
                  padding: '10px 20px',
                  background: selectedRecipients.length === 0 ? '#A9B2BE' : '#5B8A9A',
                  border: 'none',
                  borderRadius: '6px',
                  cursor: selectedRecipients.length === 0 ? 'not-allowed' : 'pointer',
                  fontFamily: "'Interstate', sans-serif",
                  fontSize: '13px',
                  color: '#FFF',
                  fontWeight: 600,
                  display: 'flex',
                  alignItems: 'center',
                  gap: '8px'
                }}
              >
                {sending ? 'Sending...' : 'Send Survey Link →'}
              </button>
            </div>
          </div>
        </div>
      );
    }

    // Role Management Modal
    function SalarySettingsModal({ personas, config, onUpdate, onClose }) {
      const [localPersonas, setLocalPersonas] = useState(() => {
        const parsed = JSON.parse(JSON.stringify(personas));
        // Ensure all personas have teamMembers array
        return parsed.map(p => ({ ...p, teamMembers: p.teamMembers || [] }));
      });
      const [editingId, setEditingId] = useState(null);
      const [showAddForm, setShowAddForm] = useState(false);
      const [newRole, setNewRole] = useState({ label: '', color: '#556275666', annualSalary: 0, burdenMultiplier: 1.35, workspaceHourlyCost: 6.00, isExternal: false, eventDeployment: { headcount: 1, hoursPerEvent: 4, rateType: 'hourly' } });
      
      // Team member management state
      const [expandedTeamMembers, setExpandedTeamMembers] = useState({});
      const [addingTeamMemberTo, setAddingTeamMemberTo] = useState(null);
      const [newTeamMember, setNewTeamMember] = useState({ name: '', email: '' });
      
      // Check if we're in event mode
      const isEventMode = config?.meta?.costModel === 'event';
      const eventConfig = config?.meta?.eventConfig || {};
      
      const colorOptions = ['#2D8A6E', '#9A6B5B', '#456A8A', '#5A5B8A', '#B84A5A', '#2D8A6E', '#C4942A', '#556275', '#5A5B8A', '#0369A1'];

      // Calculate event cost for a persona
      const calculateEventCost = (persona) => {
        if (!persona || persona.isExternal) return 0;
        const deployment = persona.eventDeployment || { headcount: 1, hoursPerEvent: 4, rateType: 'hourly' };
        const hourlyRate = calculateFullyLoadedRate(persona);
        
        if (deployment.rateType === 'fixed') {
          return (deployment.fixedFeePerEvent || 0) * (deployment.headcount || 1);
        } else if (deployment.rateType === 'external') {
          return deployment.externalRecharge || 0;
        } else {
          // hourly or salary - both use hourly rate
          return hourlyRate * (deployment.hoursPerEvent || 0) * (deployment.headcount || 1);
        }
      };

      const handleUpdatePersona = (id, field, value) => {
        setLocalPersonas(prev => prev.map(p => {
          if (p.id !== id) return p;
          // Handle nested eventDeployment updates
          if (field.startsWith('eventDeployment.')) {
            const subField = field.replace('eventDeployment.', '');
            return { 
              ...p, 
              eventDeployment: { 
                ...(p.eventDeployment || { headcount: 1, hoursPerEvent: 4, rateType: 'hourly' }),
                [subField]: value 
              } 
            };
          }
          return { ...p, [field]: value };
        }));
      };

      const handleDeletePersona = (id) => {
        setLocalPersonas(prev => prev.filter(p => p.id !== id));
      };

      const handleAddRole = () => {
        if (!newRole.label.trim()) return;
        const id = newRole.label.toLowerCase().replace(/\s+/g, '-').replace(/[^a-z0-9-]/g, '');
        setLocalPersonas(prev => [...prev, { ...newRole, id, label: newRole.label.trim(), teamMembers: [] }]);
        setNewRole({ label: '', color: '#556275666', annualSalary: 0, burdenMultiplier: 1.35, workspaceHourlyCost: 6.00, isExternal: false });
        setShowAddForm(false);
      };
      
      // Team member management handlers
      const toggleTeamMembers = (personaId) => {
        setExpandedTeamMembers(prev => ({ ...prev, [personaId]: !prev[personaId] }));
      };
      
      const handleAddTeamMember = (personaId) => {
        const email = newTeamMember.email.trim().toLowerCase();
        const name = newTeamMember.name.trim();
        
        if (!email) return;
        
        // Basic email validation
        if (!/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email)) {
          alert('Please enter a valid email address');
          return;
        }
        
        setLocalPersonas(prev => prev.map(p => {
          if (p.id !== personaId) return p;
          const teamMembers = p.teamMembers || [];
          
          // Check for duplicate email
          if (teamMembers.some(tm => tm.email === email)) {
            alert('This email is already added to this role');
            return p;
          }
          
          return {
            ...p,
            teamMembers: [...teamMembers, {
              id: `tm-${Date.now()}-${Math.random().toString(36).substr(2, 9)}`,
              email,
              name: name || email.split('@')[0]
            }]
          };
        }));
        
        setNewTeamMember({ name: '', email: '' });
        setAddingTeamMemberTo(null);
      };
      
      const handleRemoveTeamMember = (personaId, memberId) => {
        if (!confirm('Remove this team member?')) return;
        
        setLocalPersonas(prev => prev.map(p => {
          if (p.id !== personaId) return p;
          return {
            ...p,
            teamMembers: (p.teamMembers || []).filter(tm => tm.id !== memberId)
          };
        }));
      };

      return (
        <div style={{
          position: 'fixed',
          inset: 0,
          background: 'rgba(0,0,0,0.5)',
          display: 'flex',
          alignItems: 'center',
          justifyContent: 'center',
          zIndex: 1000
        }} onClick={onClose}>
          <div style={{
            background: '#FFF',
            borderRadius: '12px',
            padding: '32px',
            width: '800px',
            maxWidth: '95vw',
            maxHeight: '90vh',
            overflow: 'auto'
          }} onClick={e => e.stopPropagation()}>
            <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: '8px' }}>
              <div style={{ display: 'flex', alignItems: 'center', gap: '12px' }}>
                <h3 style={{ margin: 0, fontSize: '20px' }}>👥 Role Management</h3>
                {isEventMode && (
                  <span style={{ padding: '4px 10px', background: '#FAF0D6', color: '#8B6914', borderRadius: '4px', fontSize: '11px', fontWeight: 600, fontFamily: "'Interstate', sans-serif" }}>
                    🎪 EVENT MODE
                  </span>
                )}
              </div>
              <button onClick={() => setShowAddForm(!showAddForm)} style={{ padding: '8px 16px', background: showAddForm ? '#F4F5F7' : '#2D8A6E', color: showAddForm ? '#556275' : '#FFF', border: 'none', borderRadius: '6px', cursor: 'pointer', fontFamily: "'Interstate', sans-serif", fontSize: '13px' }}>
                {showAddForm ? 'Cancel' : '+ Add Role'}
              </button>
            </div>
            <p style={{ margin: '0 0 16px', color: '#556275', fontFamily: "'Interstate', sans-serif", fontSize: '14px' }}>
              {isEventMode 
                ? `Configure staff deployment for events (${eventConfig.capacity?.toLocaleString() || 0} capacity, ${eventConfig.durationMinutes || 0} mins).`
                : `Manage roles and fully-loaded costs. Based on ${WORKING_HOURS_PER_YEAR} working hours/year.`
              }
            </p>

            {/* Event Staffing Summary - only in event mode */}
            {isEventMode && (
              <div style={{ marginBottom: '20px', padding: '16px', background: '#FAF0D6', borderRadius: '8px', border: '1px solid #E4C87A' }}>
                <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'flex-start', marginBottom: '12px' }}>
                  <div style={{ fontFamily: "'Interstate', sans-serif", fontSize: '13px', fontWeight: 600, color: '#8B6914' }}>
                    📊 Event Staffing Summary
                  </div>
                </div>
                <div style={{ display: 'grid', gridTemplateColumns: 'repeat(4, 1fr)', gap: '16px' }}>
                  <div style={{ textAlign: 'center' }}>
                    <div style={{ fontFamily: "'Interstate', sans-serif", fontSize: '24px', fontWeight: 700, color: '#8B6914' }}>
                      {localPersonas.filter(p => !p.isExternal).reduce((sum, p) => sum + (p.eventDeployment?.headcount || 1), 0)}
                    </div>
                    <div style={{ fontFamily: "'Interstate', sans-serif", fontSize: '11px', color: '#A67C1A' }}>Total Staff</div>
                  </div>
                  <div style={{ textAlign: 'center' }}>
                    <div style={{ fontFamily: "'Interstate', sans-serif", fontSize: '24px', fontWeight: 700, color: '#8B6914' }}>
                      {formatCurrency(localPersonas.filter(p => !p.isExternal).reduce((sum, p) => sum + calculateEventCost(p), 0))}
                    </div>
                    <div style={{ fontFamily: "'Interstate', sans-serif", fontSize: '11px', color: '#A67C1A' }}>Event Cost</div>
                  </div>
                  <div style={{ textAlign: 'center' }}>
                    <div style={{ fontFamily: "'Interstate', sans-serif", fontSize: '24px', fontWeight: 700, color: '#8B6914' }}>
                      {eventConfig.capacity > 0 
                        ? formatCurrency(localPersonas.filter(p => !p.isExternal).reduce((sum, p) => sum + calculateEventCost(p), 0) / eventConfig.capacity)
                        : '—'
                      }
                    </div>
                    <div style={{ fontFamily: "'Interstate', sans-serif", fontSize: '11px', color: '#A67C1A' }}>Per Attendee</div>
                  </div>
                  <div style={{ textAlign: 'center' }}>
                    <div style={{ fontFamily: "'Interstate', sans-serif", fontSize: '24px', fontWeight: 700, color: '#8B6914' }}>
                      1:{eventConfig.capacity > 0 && localPersonas.filter(p => !p.isExternal).reduce((sum, p) => sum + (p.eventDeployment?.headcount || 1), 0) > 0
                        ? Math.round(eventConfig.capacity / localPersonas.filter(p => !p.isExternal).reduce((sum, p) => sum + (p.eventDeployment?.headcount || 1), 0))
                        : '—'
                      }
                    </div>
                    <div style={{ fontFamily: "'Interstate', sans-serif", fontSize: '11px', color: '#A67C1A' }}>Staff:Attendee</div>
                  </div>
                </div>
                {eventConfig.frequency !== 'single' && eventConfig.eventsPerPeriod > 1 && (
                  <div style={{ marginTop: '12px', paddingTop: '12px', borderTop: '1px solid #E4C87A', textAlign: 'center' }}>
                    <span style={{ fontFamily: "'Interstate', sans-serif", fontSize: '12px', color: '#8B6914' }}>
                      Season Total ({eventConfig.eventsPerPeriod} events): <strong>{formatCurrency(localPersonas.filter(p => !p.isExternal).reduce((sum, p) => sum + calculateEventCost(p), 0) * eventConfig.eventsPerPeriod)}</strong>
                    </span>
                  </div>
                )}
              </div>
            )}

            {/* Add New Role Form */}
            {showAddForm && (
              <div style={{ padding: '20px', background: '#E1EEF2', borderRadius: '8px', marginBottom: '20px', border: '2px solid #2D8A6E' }}>
                <div style={{ fontFamily: "'Interstate', sans-serif", fontSize: '13px', fontWeight: 600, color: '#2D8A6E', marginBottom: '16px' }}>Add New Role</div>
                <div style={{ display: 'grid', gridTemplateColumns: '1fr 1fr', gap: '16px' }}>
                  <div>
                    <label style={{ display: 'block', fontFamily: "'Interstate', sans-serif", fontSize: '11px', color: '#556275', marginBottom: '6px' }}>Role Name</label>
                    <input
                      type="text"
                      value={newRole.label}
                      onChange={(e) => setNewRole(prev => ({ ...prev, label: e.target.value }))}
                      placeholder="e.g. Paraplanner"
                      style={{ width: '100%', padding: '10px 12px', border: '2px solid #E4E7EB', borderRadius: '6px', fontSize: '14px', boxSizing: 'border-box' }}
                    />
                  </div>
                  <div>
                    <label style={{ display: 'block', fontFamily: "'Interstate', sans-serif", fontSize: '11px', color: '#556275', marginBottom: '6px' }}>Annual Salary (£)</label>
                    <input
                      type="number"
                      value={newRole.annualSalary || ''}
                      onChange={(e) => setNewRole(prev => ({ ...prev, annualSalary: parseInt(e.target.value) || 0 }))}
                      placeholder="0"
                      style={{ width: '100%', padding: '10px 12px', border: '2px solid #E4E7EB', borderRadius: '6px', fontSize: '14px', boxSizing: 'border-box' }}
                    />
                  </div>
                  <div>
                    <label style={{ display: 'block', fontFamily: "'Interstate', sans-serif", fontSize: '11px', color: '#556275', marginBottom: '6px' }}>Burden Multiplier</label>
                    <input
                      type="number"
                      step="0.01"
                      value={newRole.burdenMultiplier || ''}
                      onChange={(e) => setNewRole(prev => ({ ...prev, burdenMultiplier: parseFloat(e.target.value) || 1.0 }))}
                      placeholder="1.35"
                      style={{ width: '100%', padding: '10px 12px', border: '2px solid #E4E7EB', borderRadius: '6px', fontSize: '14px', boxSizing: 'border-box' }}
                    />
                    <div style={{ fontFamily: "'Interstate', sans-serif", fontSize: '10px', color: '#8A95A5', marginTop: '4px' }}>NI, pension, benefits (typ. 1.3-1.5)</div>
                  </div>
                  <div>
                    <label style={{ display: 'block', fontFamily: "'Interstate', sans-serif", fontSize: '11px', color: '#556275', marginBottom: '6px' }}>Workspace Cost (£/hr)</label>
                    <input
                      type="number"
                      step="0.50"
                      value={newRole.workspaceHourlyCost || ''}
                      onChange={(e) => setNewRole(prev => ({ ...prev, workspaceHourlyCost: parseFloat(e.target.value) || 0 }))}
                      placeholder="6.00"
                      style={{ width: '100%', padding: '10px 12px', border: '2px solid #E4E7EB', borderRadius: '6px', fontSize: '14px', boxSizing: 'border-box' }}
                    />
                    <div style={{ fontFamily: "'Interstate', sans-serif", fontSize: '10px', color: '#8A95A5', marginTop: '4px' }}>Desk, equipment, facilities</div>
                  </div>
                  <div>
                    <label style={{ display: 'block', fontFamily: "'Interstate', sans-serif", fontSize: '11px', color: '#556275', marginBottom: '6px' }}>Colour</label>
                    <div style={{ display: 'flex', gap: '6px', flexWrap: 'wrap' }}>
                      {colorOptions.map(color => (
                        <button
                          key={color}
                          onClick={() => setNewRole(prev => ({ ...prev, color }))}
                          style={{ width: '28px', height: '28px', borderRadius: '50%', background: color, border: newRole.color === color ? '3px solid #000' : '2px solid #FFF', cursor: 'pointer', boxShadow: '0 1px 3px rgba(0,0,0,0.2)' }}
                        />
                      ))}
                    </div>
                  </div>
                  <div>
                    <label style={{ display: 'block', fontFamily: "'Interstate', sans-serif", fontSize: '11px', color: '#556275', marginBottom: '6px' }}>External (no cost)?</label>
                    <button
                      onClick={() => setNewRole(prev => ({ ...prev, isExternal: !prev.isExternal }))}
                      style={{ padding: '10px 20px', background: newRole.isExternal ? '#2D8A6E' : '#F4F5F7', color: newRole.isExternal ? '#FFF' : '#556275', border: 'none', borderRadius: '6px', cursor: 'pointer', fontFamily: "'Interstate', sans-serif", fontSize: '13px' }}
                    >
                      {newRole.isExternal ? 'Yes (External)' : 'No (Internal)'}
                    </button>
                  </div>
                </div>
                {/* Show fully-loaded rate preview */}
                {!newRole.isExternal && newRole.annualSalary > 0 && (
                  <div style={{ marginTop: '16px', padding: '12px', background: '#FAF0D6', borderRadius: '6px', display: 'flex', justifyContent: 'space-between', alignItems: 'center' }}>
                    <span style={{ fontFamily: "'Interstate', sans-serif", fontSize: '12px', color: '#8B6914' }}>Fully-loaded hourly rate:</span>
                    <span style={{ fontFamily: "'Interstate', sans-serif", fontSize: '16px', fontWeight: 700, color: '#8B6914' }}>
                      {formatCurrencyDetailed(((newRole.annualSalary / WORKING_HOURS_PER_YEAR) * (newRole.burdenMultiplier || 1)) + (newRole.workspaceHourlyCost || 0))}/hr
                    </span>
                  </div>
                )}
                <div style={{ marginTop: '16px', display: 'flex', justifyContent: 'flex-end' }}>
                  <button
                    onClick={handleAddRole}
                    disabled={!newRole.label.trim()}
                    style={{ padding: '10px 24px', background: newRole.label.trim() ? '#2D8A6E' : '#A9B2BE', color: '#FFF', border: 'none', borderRadius: '6px', cursor: newRole.label.trim() ? 'pointer' : 'not-allowed', fontFamily: "'Interstate', sans-serif", fontSize: '13px' }}
                  >
                    Add Role
                  </button>
                </div>
              </div>
            )}
            
            {/* Role List */}
            <div style={{ display: 'flex', flexDirection: 'column', gap: '12px' }}>
              {localPersonas.map(persona => (
                <div key={persona.id} style={{
                  padding: '16px',
                  background: persona.isExternal ? '#F4F5F7' : '#FFF',
                  borderRadius: '8px',
                  borderLeft: `4px solid ${persona.color}`,
                  border: '1px solid #E4E7EB'
                }}>
                  {/* Top row: Color, Name, External toggle, Delete */}
                  <div style={{ display: 'flex', alignItems: 'center', gap: '12px', marginBottom: persona.isExternal ? 0 : '12px' }}>
                    {/* Color Picker */}
                    <div style={{ position: 'relative' }}>
                      <div 
                        style={{ width: '32px', height: '32px', borderRadius: '50%', background: persona.color, cursor: 'pointer', border: '2px solid #FFF', boxShadow: '0 1px 3px rgba(0,0,0,0.2)' }}
                        onClick={() => setEditingId(editingId === persona.id ? null : persona.id)}
                      />
                      {editingId === persona.id && (
                        <div style={{ position: 'absolute', top: '40px', left: 0, background: '#FFF', padding: '8px', borderRadius: '8px', boxShadow: '0 4px 12px rgba(0,0,0,0.15)', display: 'flex', gap: '4px', flexWrap: 'wrap', width: '140px', zIndex: 10 }}>
                          {colorOptions.map(color => (
                            <button
                              key={color}
                              onClick={() => { handleUpdatePersona(persona.id, 'color', color); setEditingId(null); }}
                              style={{ width: '24px', height: '24px', borderRadius: '50%', background: color, border: persona.color === color ? '2px solid #000' : 'none', cursor: 'pointer' }}
                            />
                          ))}
                        </div>
                      )}
                    </div>

                    {/* Name */}
                    <div style={{ flex: 1, minWidth: '120px' }}>
                      <input
                        type="text"
                        value={persona.label}
                        onChange={(e) => handleUpdatePersona(persona.id, 'label', e.target.value)}
                        style={{
                          fontFamily: "'Interstate', sans-serif",
                          fontSize: '14px',
                          fontWeight: 600,
                          color: persona.color,
                          border: 'none',
                          background: 'transparent',
                          width: '100%',
                          padding: '4px 0'
                        }}
                      />
                      {persona.isExternal && (
                        <div style={{ fontFamily: "'Interstate', sans-serif", fontSize: '11px', color: '#8A95A5' }}>External (no cost)</div>
                      )}
                    </div>

                    {/* External Toggle */}
                    <button
                      onClick={() => handleUpdatePersona(persona.id, 'isExternal', !persona.isExternal)}
                      style={{ padding: '6px 12px', background: persona.isExternal ? '#E4E7EB' : '#FFF', border: '1px solid #C8CED6', borderRadius: '4px', cursor: 'pointer', fontFamily: "'Interstate', sans-serif", fontSize: '11px', color: '#556275' }}
                      title={persona.isExternal ? 'Mark as internal' : 'Mark as external (no cost)'}
                    >
                      {persona.isExternal ? 'External' : 'Internal'}
                    </button>

                    {/* Delete */}
                    <button
                      onClick={(e) => { e.stopPropagation(); handleDeletePersona(persona.id); }}
                      style={{ width: '32px', height: '32px', borderRadius: '50%', border: 'none', background: '#F5E0E3', color: '#B84A5A', cursor: 'pointer', fontSize: '16px', display: 'flex', alignItems: 'center', justifyContent: 'center' }}
                      title="Delete role"
                    >×</button>
                  </div>

                  {/* Cost fields - only for internal roles */}
                  {!persona.isExternal && (
                    <div style={{ display: 'grid', gridTemplateColumns: 'repeat(4, 1fr)', gap: '12px', paddingTop: '12px', borderTop: '1px solid #E9EEF4' }}>
                      {/* Annual Salary */}
                      <div>
                        <label style={{ display: 'block', fontFamily: "'Interstate', sans-serif", fontSize: '10px', color: '#8A95A5', marginBottom: '4px' }}>Annual Salary</label>
                        <div style={{ display: 'flex', alignItems: 'center', gap: '4px' }}>
                          <span style={{ fontFamily: "'Interstate', sans-serif", fontSize: '12px', color: '#556275' }}>£</span>
                          <input
                            type="number"
                            value={persona.annualSalary || ''}
                            onChange={(e) => handleUpdatePersona(persona.id, 'annualSalary', parseInt(e.target.value) || 0)}
                            placeholder="0"
                            style={{ width: '100%', padding: '6px 8px', border: '1px solid #E4E7EB', borderRadius: '4px', fontSize: '13px', textAlign: 'right' }}
                          />
                        </div>
                        <div style={{ fontFamily: "'Interstate', sans-serif", fontSize: '10px', color: '#8A95A5', marginTop: '2px' }}>
                          Base: {formatCurrencyDetailed(calculateHourlyRate(persona.annualSalary || 0))}/hr
                        </div>
                      </div>

                      {/* Burden Multiplier */}
                      <div>
                        <label style={{ display: 'block', fontFamily: "'Interstate', sans-serif", fontSize: '10px', color: '#8A95A5', marginBottom: '4px' }}>Burden ×</label>
                        <input
                          type="number"
                          step="0.01"
                          value={persona.burdenMultiplier || ''}
                          onChange={(e) => handleUpdatePersona(persona.id, 'burdenMultiplier', parseFloat(e.target.value) || 1.0)}
                          placeholder="1.35"
                          style={{ width: '100%', padding: '6px 8px', border: '1px solid #E4E7EB', borderRadius: '4px', fontSize: '13px', textAlign: 'right' }}
                        />
                        <div style={{ fontFamily: "'Interstate', sans-serif", fontSize: '10px', color: '#8A95A5', marginTop: '2px' }}>
                          NI, pension, benefits
                        </div>
                      </div>

                      {/* Workspace Cost */}
                      <div>
                        <label style={{ display: 'block', fontFamily: "'Interstate', sans-serif", fontSize: '10px', color: '#8A95A5', marginBottom: '4px' }}>Workspace £/hr</label>
                        <input
                          type="number"
                          step="0.50"
                          value={persona.workspaceHourlyCost || ''}
                          onChange={(e) => handleUpdatePersona(persona.id, 'workspaceHourlyCost', parseFloat(e.target.value) || 0)}
                          placeholder="6.00"
                          style={{ width: '100%', padding: '6px 8px', border: '1px solid #E4E7EB', borderRadius: '4px', fontSize: '13px', textAlign: 'right' }}
                        />
                        <div style={{ fontFamily: "'Interstate', sans-serif", fontSize: '10px', color: '#8A95A5', marginTop: '2px' }}>
                          Desk, equipment
                        </div>
                      </div>

                      {/* Fully Loaded Rate */}
                      <div style={{ background: '#FAF0D6', borderRadius: '6px', padding: '8px', display: 'flex', flexDirection: 'column', justifyContent: 'center' }}>
                        <div style={{ fontFamily: "'Interstate', sans-serif", fontSize: '10px', color: '#8B6914', marginBottom: '2px' }}>Fully Loaded</div>
                        <div style={{ fontFamily: "'Interstate', sans-serif", fontSize: '16px', fontWeight: 700, color: '#8B6914' }}>
                          {formatCurrencyDetailed(calculateFullyLoadedRate(persona))}/hr
                        </div>
                      </div>
                    </div>
                  )}

                  {/* Event Deployment Fields - only for internal roles in event mode */}
                  {!persona.isExternal && isEventMode && (
                    <div style={{ marginTop: '12px', paddingTop: '12px', borderTop: '1px dashed #E4C87A', background: 'rgba(250, 240, 214, 0.3)', margin: '12px -16px -16px', padding: '12px 16px 16px', borderRadius: '0 0 4px 4px' }}>
                      <div style={{ fontFamily: "'Interstate', sans-serif", fontSize: '11px', fontWeight: 600, color: '#8B6914', marginBottom: '12px', display: 'flex', alignItems: 'center', gap: '6px' }}>
                        🎪 Event Deployment
                      </div>
                      <div style={{ display: 'grid', gridTemplateColumns: 'repeat(4, 1fr)', gap: '12px' }}>
                        {/* Headcount */}
                        <div>
                          <label style={{ display: 'block', fontFamily: "'Interstate', sans-serif", fontSize: '10px', color: '#8A95A5', marginBottom: '4px' }}>Headcount</label>
                          <input
                            type="number"
                            value={persona.eventDeployment?.headcount || 1}
                            onChange={(e) => handleUpdatePersona(persona.id, 'eventDeployment.headcount', parseInt(e.target.value) || 1)}
                            min="1"
                            style={{ width: '100%', padding: '6px 8px', border: '1px solid #E4C87A', borderRadius: '4px', fontSize: '13px', textAlign: 'right', background: '#FFF' }}
                          />
                          <div style={{ fontFamily: "'Interstate', sans-serif", fontSize: '10px', color: '#8A95A5', marginTop: '2px' }}>
                            Staff per event
                          </div>
                        </div>

                        {/* Hours per Event */}
                        <div>
                          <label style={{ display: 'block', fontFamily: "'Interstate', sans-serif", fontSize: '10px', color: '#8A95A5', marginBottom: '4px' }}>Hours/Event</label>
                          <input
                            type="number"
                            step="0.5"
                            value={persona.eventDeployment?.hoursPerEvent || 4}
                            onChange={(e) => handleUpdatePersona(persona.id, 'eventDeployment.hoursPerEvent', parseFloat(e.target.value) || 0)}
                            style={{ width: '100%', padding: '6px 8px', border: '1px solid #E4C87A', borderRadius: '4px', fontSize: '13px', textAlign: 'right', background: '#FFF' }}
                          />
                          <div style={{ fontFamily: "'Interstate', sans-serif", fontSize: '10px', color: '#8A95A5', marginTop: '2px' }}>
                            Working hours
                          </div>
                        </div>

                        {/* Rate Type */}
                        <div>
                          <label style={{ display: 'block', fontFamily: "'Interstate', sans-serif", fontSize: '10px', color: '#8A95A5', marginBottom: '4px' }}>Rate Type</label>
                          <select
                            value={persona.eventDeployment?.rateType || 'hourly'}
                            onChange={(e) => handleUpdatePersona(persona.id, 'eventDeployment.rateType', e.target.value)}
                            style={{ width: '100%', padding: '6px 8px', border: '1px solid #E4C87A', borderRadius: '4px', fontSize: '12px', background: '#FFF', fontFamily: "'Interstate', sans-serif" }}
                          >
                            <option value="hourly">Hourly Rate</option>
                            <option value="salary">Pro-rata Salary</option>
                            <option value="fixed">Fixed Fee/Event</option>
                            <option value="external">External Recharge</option>
                          </select>
                        </div>

                        {/* Event Cost */}
                        <div style={{ background: '#FAF0D6', borderRadius: '6px', padding: '8px', display: 'flex', flexDirection: 'column', justifyContent: 'center', border: '1px solid #E4C87A' }}>
                          <div style={{ fontFamily: "'Interstate', sans-serif", fontSize: '10px', color: '#8B6914', marginBottom: '2px' }}>Event Cost</div>
                          <div style={{ fontFamily: "'Interstate', sans-serif", fontSize: '16px', fontWeight: 700, color: '#8B6914' }}>
                            {formatCurrency(calculateEventCost(persona))}
                          </div>
                        </div>
                      </div>

                      {/* Additional fields for fixed/external rate types */}
                      {(persona.eventDeployment?.rateType === 'fixed' || persona.eventDeployment?.rateType === 'external') && (
                        <div style={{ marginTop: '12px', display: 'grid', gridTemplateColumns: 'repeat(2, 1fr)', gap: '12px' }}>
                          {persona.eventDeployment?.rateType === 'fixed' && (
                            <div>
                              <label style={{ display: 'block', fontFamily: "'Interstate', sans-serif", fontSize: '10px', color: '#8A95A5', marginBottom: '4px' }}>Fixed Fee per Person/Event (£)</label>
                              <input
                                type="number"
                                step="10"
                                value={persona.eventDeployment?.fixedFeePerEvent || ''}
                                onChange={(e) => handleUpdatePersona(persona.id, 'eventDeployment.fixedFeePerEvent', parseFloat(e.target.value) || 0)}
                                placeholder="150"
                                style={{ width: '100%', padding: '6px 8px', border: '1px solid #E4C87A', borderRadius: '4px', fontSize: '13px', background: '#FFF' }}
                              />
                            </div>
                          )}
                          {persona.eventDeployment?.rateType === 'external' && (
                            <div>
                              <label style={{ display: 'block', fontFamily: "'Interstate', sans-serif", fontSize: '10px', color: '#8A95A5', marginBottom: '4px' }}>External Recharge (£)</label>
                              <input
                                type="number"
                                step="100"
                                value={persona.eventDeployment?.externalRecharge || ''}
                                onChange={(e) => handleUpdatePersona(persona.id, 'eventDeployment.externalRecharge', parseFloat(e.target.value) || 0)}
                                placeholder="5000"
                                style={{ width: '100%', padding: '6px 8px', border: '1px solid #E4C87A', borderRadius: '4px', fontSize: '13px', background: '#FFF' }}
                              />
                              <div style={{ fontFamily: "'Interstate', sans-serif", fontSize: '10px', color: '#8A95A5', marginTop: '2px' }}>
                                Total recharge amount (e.g., police, security contractor)
                              </div>
                            </div>
                          )}
                        </div>
                      )}
                    </div>
                  )}
                  
                  {/* Team Members Section */}
                  <div style={{ marginTop: '12px', paddingTop: '12px', borderTop: '1px solid #E4E7EB' }}>
                    <button
                      onClick={() => toggleTeamMembers(persona.id)}
                      style={{
                        width: '100%',
                        display: 'flex',
                        alignItems: 'center',
                        justifyContent: 'space-between',
                        background: 'transparent',
                        border: 'none',
                        padding: '4px 0',
                        cursor: 'pointer',
                        fontFamily: "'Interstate', sans-serif",
                        fontSize: '12px',
                        color: '#556275',
                        fontWeight: 600
                      }}
                    >
                      <div style={{ display: 'flex', alignItems: 'center', gap: '8px' }}>
                        <span style={{ fontSize: '14px' }}>{expandedTeamMembers[persona.id] ? '▼' : '▶'}</span>
                        <span>Team Members</span>
                        <span style={{ 
                          padding: '2px 8px', 
                          background: '#E9EEF4', 
                          borderRadius: '10px', 
                          fontSize: '11px', 
                          color: '#192B45',
                          fontWeight: 600
                        }}>
                          {(persona.teamMembers || []).length}
                        </span>
                      </div>
                      <span style={{ fontSize: '10px', color: '#8A95A5' }}>For survey requests</span>
                    </button>
                    
                    {/* Team Members List - shown when expanded */}
                    {expandedTeamMembers[persona.id] && (
                      <div style={{ marginTop: '12px' }}>
                        {(persona.teamMembers || []).length === 0 ? (
                          <div style={{ 
                            padding: '16px', 
                            background: '#F4F5F7', 
                            borderRadius: '6px', 
                            textAlign: 'center',
                            color: '#8A95A5',
                            fontSize: '12px',
                            fontStyle: 'italic'
                          }}>
                            No team members yet. Add people to request step-level feedback.
                          </div>
                        ) : (
                          <div style={{ display: 'flex', flexDirection: 'column', gap: '8px' }}>
                            {persona.teamMembers.map(member => (
                              <div
                                key={member.id}
                                style={{
                                  display: 'flex',
                                  alignItems: 'center',
                                  justifyContent: 'space-between',
                                  padding: '10px 12px',
                                  background: '#F4F5F7',
                                  borderRadius: '6px',
                                  border: '1px solid #E4E7EB'
                                }}
                              >
                                <div style={{ flex: 1 }}>
                                  <div style={{ 
                                    fontFamily: "'Interstate', sans-serif", 
                                    fontSize: '13px', 
                                    color: '#192B45',
                                    fontWeight: 500
                                  }}>
                                    {member.name}
                                  </div>
                                  <div style={{ 
                                    fontFamily: "'Inter', sans-serif", 
                                    fontSize: '11px', 
                                    color: '#8A95A5',
                                    marginTop: '2px'
                                  }}>
                                    {member.email}
                                  </div>
                                </div>
                                <button
                                  onClick={() => handleRemoveTeamMember(persona.id, member.id)}
                                  style={{
                                    width: '24px',
                                    height: '24px',
                                    borderRadius: '50%',
                                    border: 'none',
                                    background: '#F5E0E3',
                                    color: '#B84A5A',
                                    cursor: 'pointer',
                                    fontSize: '14px',
                                    display: 'flex',
                                    alignItems: 'center',
                                    justifyContent: 'center'
                                  }}
                                  title="Remove team member"
                                >×</button>
                              </div>
                            ))}
                          </div>
                        )}
                        
                        {/* Add Team Member Form */}
                        {addingTeamMemberTo === persona.id ? (
                          <div style={{ 
                            marginTop: '12px', 
                            padding: '12px', 
                            background: '#E1EEF2', 
                            borderRadius: '6px',
                            border: '2px solid #5B8A9A'
                          }}>
                            <div style={{ 
                              fontFamily: "'Interstate', sans-serif", 
                              fontSize: '12px', 
                              fontWeight: 600, 
                              color: '#3A6070', 
                              marginBottom: '12px' 
                            }}>
                              Add Team Member
                            </div>
                            <div style={{ display: 'grid', gridTemplateColumns: '1fr 1fr', gap: '8px', marginBottom: '12px' }}>
                              <div>
                                <label style={{ 
                                  display: 'block', 
                                  fontFamily: "'Interstate', sans-serif", 
                                  fontSize: '10px', 
                                  color: '#556275', 
                                  marginBottom: '4px' 
                                }}>
                                  Name (optional)
                                </label>
                                <input
                                  type="text"
                                  value={newTeamMember.name}
                                  onChange={(e) => setNewTeamMember(prev => ({ ...prev, name: e.target.value }))}
                                  placeholder="Jane Smith"
                                  style={{
                                    width: '100%',
                                    padding: '8px 10px',
                                    border: '1px solid #96BCC7',
                                    borderRadius: '4px',
                                    fontSize: '13px',
                                    boxSizing: 'border-box'
                                  }}
                                />
                              </div>
                              <div>
                                <label style={{ 
                                  display: 'block', 
                                  fontFamily: "'Interstate', sans-serif", 
                                  fontSize: '10px', 
                                  color: '#556275', 
                                  marginBottom: '4px' 
                                }}>
                                  Email *
                                </label>
                                <input
                                  type="email"
                                  value={newTeamMember.email}
                                  onChange={(e) => setNewTeamMember(prev => ({ ...prev, email: e.target.value }))}
                                  placeholder="jane@company.com"
                                  style={{
                                    width: '100%',
                                    padding: '8px 10px',
                                    border: '1px solid #96BCC7',
                                    borderRadius: '4px',
                                    fontSize: '13px',
                                    boxSizing: 'border-box'
                                  }}
                                  onKeyPress={(e) => {
                                    if (e.key === 'Enter') {
                                      e.preventDefault();
                                      handleAddTeamMember(persona.id);
                                    }
                                  }}
                                />
                              </div>
                            </div>
                            <div style={{ display: 'flex', gap: '8px', justifyContent: 'flex-end' }}>
                              <button
                                onClick={() => {
                                  setAddingTeamMemberTo(null);
                                  setNewTeamMember({ name: '', email: '' });
                                }}
                                style={{
                                  padding: '6px 12px',
                                  background: '#FFF',
                                  border: '1px solid #96BCC7',
                                  borderRadius: '4px',
                                  cursor: 'pointer',
                                  fontFamily: "'Interstate', sans-serif",
                                  fontSize: '12px',
                                  color: '#556275'
                                }}
                              >
                                Cancel
                              </button>
                              <button
                                onClick={() => handleAddTeamMember(persona.id)}
                                disabled={!newTeamMember.email.trim()}
                                style={{
                                  padding: '6px 12px',
                                  background: newTeamMember.email.trim() ? '#5B8A9A' : '#A9B2BE',
                                  border: 'none',
                                  borderRadius: '4px',
                                  cursor: newTeamMember.email.trim() ? 'pointer' : 'not-allowed',
                                  fontFamily: "'Interstate', sans-serif",
                                  fontSize: '12px',
                                  color: '#FFF',
                                  fontWeight: 600
                                }}
                              >
                                Add Member
                              </button>
                            </div>
                          </div>
                        ) : (
                          <button
                            onClick={() => setAddingTeamMemberTo(persona.id)}
                            style={{
                              width: '100%',
                              marginTop: '12px',
                              padding: '8px 12px',
                              background: '#FFF',
                              border: '1px dashed #96BCC7',
                              borderRadius: '6px',
                              cursor: 'pointer',
                              fontFamily: "'Interstate', sans-serif",
                              fontSize: '12px',
                              color: '#5B8A9A',
                              fontWeight: 500,
                              display: 'flex',
                              alignItems: 'center',
                              justifyContent: 'center',
                              gap: '6px'
                            }}
                          >
                            <span style={{ fontSize: '16px' }}>+</span>
                            Add Team Member
                          </button>
                        )}
                      </div>
                    )}
                  </div>
                </div>
              ))}
            </div>
            
            <div style={{ display: 'flex', gap: '12px', justifyContent: 'flex-end', marginTop: '24px', paddingTop: '20px', borderTop: '1px solid #E4E7EB' }}>
              <button
                onClick={onClose}
                style={{ padding: '10px 20px', background: '#F4F5F7', border: 'none', borderRadius: '6px', cursor: 'pointer', fontFamily: "'Interstate', sans-serif" }}
              >
                Cancel
              </button>
              <button
                onClick={() => onUpdate(localPersonas)}
                style={{ padding: '10px 20px', background: '#2D8A6E', color: '#FFF', border: 'none', borderRadius: '6px', cursor: 'pointer', fontFamily: "'Interstate', sans-serif" }}
              >
                Save Changes
              </button>
            </div>
          </div>
        </div>
      );
    }

    // Share Modal Component
    function ShareModal({ mapId, mapTitle, supabase, currentUser, onClose }) {
      const [shares, setShares] = useState([]);
      const [loading, setLoading] = useState(true);
      const [email, setEmail] = useState('');
      const [permission, setPermission] = useState('view');
      const [sharing, setSharing] = useState(false);
      const [error, setError] = useState(null);
      const [success, setSuccess] = useState(null);
      const [copySuccess, setCopySuccess] = useState(false);
      const [sendNotification, setSendNotification] = useState(true);
      
      // Load existing shares
      React.useEffect(() => {
        loadShares();
      }, [mapId]);
      
      const loadShares = async () => {
        if (!supabase || !mapId) return;
        
        try {
          const { data, error } = await supabase
            .from('journey_map_shares')
            .select(`
              id,
              permission,
              shared_at,
              shared_with_user_id,
              shared_with_email,
              users:shared_with_user_id (
                email,
                display_name
              )
            `)
            .eq('journey_map_id', mapId);
          
          if (error) throw error;
          setShares(data || []);
        } catch (err) {
          console.error('Error loading shares:', err);
        }
        setLoading(false);
      };
      
      // Send email notification via mailto
      const sendShareEmail = (recipientEmail, title, permissionLevel) => {
        const shareLink = `https://steveyoung74.github.io/journeymaps/editor.html?id=${mapId}`;
        const senderName = currentUser?.email?.split('@')[0] || 'Someone';
        const permissionText = permissionLevel === 'edit' ? 'edit' : 'view';
        
        const subject = encodeURIComponent(`${senderName} shared "${title}" with you`);
        const body = encodeURIComponent(`Hi,

${senderName} has shared a journey map with you on FATHOM.

Map: ${title}
Permission: Can ${permissionText}

View it here:
${shareLink}

FATHOM - Journey intelligence for modern operations`);
        
        window.open(`mailto:${recipientEmail}?subject=${subject}&body=${body}`, '_blank');
      };
      
      const addShare = async (e) => {
        e.preventDefault();
        if (!email.trim()) return;
        
        setSharing(true);
        setError(null);
        setSuccess(null);
        
        try {
          // Check if already shared
          const existingShare = shares.find(s => 
            s.shared_with_email === email.toLowerCase() ||
            s.users?.email === email.toLowerCase()
          );
          
          if (existingShare) {
            throw new Error('This map is already shared with this person');
          }
          
          // Check if user exists
          const { data: existingUser } = await supabase
            .from('users')
            .select('id, email')
            .eq('email', email.toLowerCase())
            .single();
          
          const shareData = {
            journey_map_id: mapId,
            permission,
            shared_by: currentUser?.id,
            shared_at: new Date().toISOString()
          };
          
          if (existingUser) {
            shareData.shared_with_user_id = existingUser.id;
          } else {
            shareData.shared_with_email = email.toLowerCase();
          }
          
          const { error } = await supabase
            .from('journey_map_shares')
            .insert(shareData);
          
          if (error) throw error;
          
          // Send email notification if enabled
          if (sendNotification) {
            sendShareEmail(email, mapTitle, permission);
          }
          
          setSuccess(`Shared with ${email}${sendNotification ? ' - email sent' : ''}`);
          setEmail('');
          await loadShares();
        } catch (err) {
          console.error('Share error:', err);
          setError(err.message || 'Failed to share');
        }
        
        setSharing(false);
      };
      
      const removeShare = async (shareId) => {
        try {
          const { error } = await supabase
            .from('journey_map_shares')
            .delete()
            .eq('id', shareId);
          
          if (error) throw error;
          
          setShares(prev => prev.filter(s => s.id !== shareId));
          setSuccess('Share removed');
          setTimeout(() => setSuccess(null), 2000);
        } catch (err) {
          console.error('Remove error:', err);
          setError('Failed to remove share');
        }
      };
      
      const updatePermission = async (shareId, newPermission) => {
        try {
          const { error } = await supabase
            .from('journey_map_shares')
            .update({ permission: newPermission })
            .eq('id', shareId);
          
          if (error) throw error;
          
          setShares(prev => prev.map(s => 
            s.id === shareId ? { ...s, permission: newPermission } : s
          ));
        } catch (err) {
          console.error('Update error:', err);
          setError('Failed to update permission');
        }
      };
      
      const copyLink = () => {
        const link = `https://steveyoung74.github.io/journeymaps/editor.html?id=${mapId}`;
        navigator.clipboard.writeText(link);
        setCopySuccess(true);
        setTimeout(() => setCopySuccess(false), 2000);
      };
      
      const getInitials = (name) => {
        if (!name) return '?';
        return name.split(' ').map(n => n[0]).join('').toUpperCase().slice(0, 2);
      };
      
      return (
        <div style={{
          position: 'fixed',
          inset: 0,
          background: 'rgba(0,0,0,0.5)',
          display: 'flex',
          alignItems: 'center',
          justifyContent: 'center',
          zIndex: 1000
        }} onClick={onClose}>
          <div style={{
            background: '#FFF',
            borderRadius: '12px',
            padding: '28px',
            width: '500px',
            maxWidth: '95vw',
            maxHeight: '90vh',
            overflow: 'auto'
          }} onClick={e => e.stopPropagation()}>
            <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: '20px' }}>
              <h3 style={{ margin: 0, fontSize: '18px', fontFamily: "'Interstate', sans-serif" }}>🔗 Share "{mapTitle}"</h3>
              <button 
                onClick={onClose}
                style={{ background: 'none', border: 'none', fontSize: '20px', cursor: 'pointer', color: '#8A95A5' }}
              >
                ×
              </button>
            </div>
            
            {/* Copy Link */}
            <div style={{ 
              display: 'flex', 
              gap: '8px', 
              marginBottom: '24px',
              padding: '12px',
              background: '#F4F5F7',
              borderRadius: '8px'
            }}>
              <input
                type="text"
                readOnly
                value={`https://steveyoung74.github.io/journeymaps/editor.html?id=${mapId}`}
                style={{ 
                  flex: 1, 
                  padding: '8px 12px', 
                  border: '1px solid #E4E7EB', 
                  borderRadius: '6px', 
                  fontSize: '13px',
                  fontFamily: 'monospace',
                  background: '#FFF'
                }}
              />
              <button
                onClick={copyLink}
                style={{ 
                  padding: '8px 16px', 
                  background: copySuccess ? '#2D8A6E' : '#192B45', 
                  color: '#FFF', 
                  border: 'none', 
                  borderRadius: '6px', 
                  cursor: 'pointer',
                  fontFamily: "'Interstate', sans-serif",
                  fontSize: '13px',
                  whiteSpace: 'nowrap'
                }}
              >
                {copySuccess ? '✓ Copied!' : '📋 Copy'}
              </button>
            </div>
            
            {/* Add Share Form */}
            <form onSubmit={addShare} style={{ marginBottom: '20px' }}>
              <div style={{ fontFamily: "'Interstate', sans-serif", fontSize: '13px', fontWeight: 600, color: '#556275', marginBottom: '8px' }}>
                Share with someone
              </div>
              <div style={{ display: 'flex', gap: '8px', marginBottom: '10px' }}>
                <input
                  type="email"
                  placeholder="Email address"
                  value={email}
                  onChange={(e) => setEmail(e.target.value)}
                  style={{ 
                    flex: 1, 
                    padding: '10px 12px', 
                    border: '1px solid #E4E7EB', 
                    borderRadius: '6px', 
                    fontSize: '14px',
                    fontFamily: "'Open Sans', sans-serif"
                  }}
                />
                <select
                  value={permission}
                  onChange={(e) => setPermission(e.target.value)}
                  style={{ 
                    padding: '10px 12px', 
                    border: '1px solid #E4E7EB', 
                    borderRadius: '6px', 
                    fontSize: '14px',
                    background: '#FFF',
                    fontFamily: "'Interstate', sans-serif"
                  }}
                >
                  <option value="view">Can view</option>
                  <option value="edit">Can edit</option>
                </select>
                <button
                  type="submit"
                  disabled={sharing || !email.trim()}
                  style={{ 
                    padding: '10px 16px', 
                    background: '#192B45', 
                    color: '#FFF', 
                    border: 'none', 
                    borderRadius: '6px', 
                    cursor: 'pointer',
                    fontFamily: "'Interstate', sans-serif",
                    fontSize: '13px',
                    opacity: sharing || !email.trim() ? 0.5 : 1
                  }}
                >
                  {sharing ? '...' : 'Share'}
                </button>
              </div>
              <label style={{ display: 'flex', alignItems: 'center', gap: '8px', fontSize: '13px', color: '#556275', cursor: 'pointer', fontFamily: "'Interstate', sans-serif" }}>
                <input
                  type="checkbox"
                  checked={sendNotification}
                  onChange={(e) => setSendNotification(e.target.checked)}
                  style={{ width: '16px', height: '16px', cursor: 'pointer' }}
                />
                📧 Send email notification
              </label>
            </form>
            
            {error && (
              <div style={{ 
                padding: '10px 14px', 
                background: '#F5E0E3', 
                color: '#B84A5A', 
                borderRadius: '6px', 
                marginBottom: '16px',
                fontSize: '13px',
                fontFamily: "'Interstate', sans-serif"
              }}>
                {error}
              </div>
            )}
            
            {success && (
              <div style={{ 
                padding: '10px 14px', 
                background: '#D4EDE5', 
                color: '#2D8A6E', 
                borderRadius: '6px', 
                marginBottom: '16px',
                fontSize: '13px',
                fontFamily: "'Interstate', sans-serif"
              }}>
                {success}
              </div>
            )}
            
            {/* Existing Shares */}
            {shares.length > 0 && (
              <div>
                <div style={{ fontFamily: "'Interstate', sans-serif", fontSize: '13px', fontWeight: 600, color: '#556275', marginBottom: '12px' }}>
                  Shared with ({shares.length})
                </div>
                <div style={{ display: 'flex', flexDirection: 'column', gap: '8px' }}>
                  {shares.map(share => {
                    const displayEmail = share.users?.email || share.shared_with_email;
                    const displayName = share.users?.display_name || displayEmail?.split('@')[0];
                    
                    return (
                      <div 
                        key={share.id}
                        style={{ 
                          display: 'flex', 
                          alignItems: 'center', 
                          justifyContent: 'space-between',
                          padding: '10px 12px',
                          background: '#F4F5F7',
                          borderRadius: '8px'
                        }}
                      >
                        <div style={{ display: 'flex', alignItems: 'center', gap: '10px' }}>
                          <div style={{ 
                            width: '32px', 
                            height: '32px', 
                            borderRadius: '50%', 
                            background: '#C8D5E2',
                            color: '#192B45',
                            display: 'flex',
                            alignItems: 'center',
                            justifyContent: 'center',
                            fontSize: '12px',
                            fontWeight: 600,
                            fontFamily: "'Interstate', sans-serif"
                          }}>
                            {getInitials(displayName)}
                          </div>
                          <div>
                            <div style={{ fontWeight: 500, fontSize: '14px' }}>{displayName}</div>
                            <div style={{ fontSize: '12px', color: '#8A95A5' }}>{displayEmail}</div>
                          </div>
                        </div>
                        <div style={{ display: 'flex', alignItems: 'center', gap: '8px' }}>
                          <select
                            value={share.permission}
                            onChange={(e) => updatePermission(share.id, e.target.value)}
                            style={{ 
                              padding: '6px 8px', 
                              border: '1px solid #E4E7EB', 
                              borderRadius: '4px', 
                              fontSize: '12px',
                              background: '#FFF',
                              fontFamily: "'Interstate', sans-serif"
                            }}
                          >
                            <option value="view">Can view</option>
                            <option value="edit">Can edit</option>
                          </select>
                          <button
                            onClick={() => sendShareEmail(displayEmail, mapTitle, share.permission)}
                            style={{ 
                              background: 'none', 
                              border: 'none', 
                              color: '#5B8A9A', 
                              cursor: 'pointer',
                              fontSize: '14px',
                              padding: '4px'
                            }}
                            title="Send notification email"
                          >
                            📧
                          </button>
                          <button
                            onClick={() => removeShare(share.id)}
                            style={{ 
                              background: 'none', 
                              border: 'none', 
                              color: '#B84A5A', 
                              cursor: 'pointer',
                              fontSize: '16px',
                              padding: '4px'
                            }}
                            title="Remove share"
                          >
                            ×
                          </button>
                        </div>
                      </div>
                    );
                  })}
                </div>
              </div>
            )}
            
            {shares.length === 0 && !loading && (
              <div style={{ 
                textAlign: 'center', 
                padding: '24px',
                color: '#8A95A5',
                fontFamily: "'Interstate', sans-serif",
                fontSize: '14px'
              }}>
                This map hasn't been shared with anyone yet
              </div>
            )}
          </div>
        </div>
      );
    }

    // Cost Analysis Panel
    function CostAnalysisPanel({ stages, personas, formatTime, onClose, config }) {
      const allSteps = stages.flatMap((stage, stageIndex) => 
        stage.steps.map(step => ({ ...step, stageName: stage.name, stageIndex }))
      );
      
      // Inline step cost calculator - replicates the working roleCosts logic
      const getStepCost = (step) => {
        let cost = 0;
        
        // NEW FORMAT: roleInvolvement
        if (step.roleInvolvement && Object.keys(step.roleInvolvement).length > 0) {
          Object.entries(step.roleInvolvement).forEach(([roleId, involvement]) => {
            const persona = personas.find(p => p.id === roleId);
            if (persona && !persona.isExternal) {
              const salary = persona.annualSalary || persona.salary || 0;
              if (salary > 0) {
                const baseHourly = salary / WORKING_HOURS_PER_YEAR;
                const burdenMultiplier = persona.burdenMultiplier || 1.0;
                const workspaceHourly = persona.workspaceHourlyCost || 0;
                const fullyLoadedRate = (baseHourly * burdenMultiplier) + workspaceHourly;
                const hours = (involvement.timeMinutes || 0) / 60;
                const headcount = involvement.headcount || 1;
                cost += fullyLoadedRate * hours * headcount;
              }
            }
          });
        }
        // LEGACY FORMAT: Single owner with timeMinutes
        else if (step.owner && step.timeMinutes > 0) {
          const persona = personas.find(p => p.id === step.owner);
          if (persona && !persona.isExternal) {
            const salary = persona.annualSalary || persona.salary || 0;
            if (salary > 0) {
              const baseHourly = salary / WORKING_HOURS_PER_YEAR;
              const burdenMultiplier = persona.burdenMultiplier || 1.0;
              const workspaceHourly = persona.workspaceHourlyCost || 0;
              const fullyLoadedRate = (baseHourly * burdenMultiplier) + workspaceHourly;
              const hours = step.timeMinutes / 60;
              cost += fullyLoadedRate * hours;
            }
          }
        }
        
        // Additional costs
        if (step.additionalCosts && Array.isArray(step.additionalCosts)) {
          step.additionalCosts.forEach(c => { cost += c.amount || 0; });
        }
        
        return cost;
      };
      
      // Calculate metrics for each step using inline function
      const stepMetrics = allSteps.map(step => {
        const cost = getStepCost(step);
        const costPerMinute = step.timeMinutes > 0 ? cost / step.timeMinutes : 0;
        const automationSavings = step.automationOpportunity === 'high' ? cost * 0.7 
          : step.automationOpportunity === 'medium' ? cost * 0.4 
          : step.automationOpportunity === 'low' ? cost * 0.1 
          : 0;
        return { ...step, cost, costPerMinute, automationSavings };
      });
      
      // Sort by different metrics
      const byCostPerMinute = [...stepMetrics].sort((a, b) => b.costPerMinute - a.costPerMinute);
      const byTotalCost = [...stepMetrics].sort((a, b) => b.cost - a.cost);
      const byAutomationSavings = [...stepMetrics].sort((a, b) => b.automationSavings - a.automationSavings);
      
      // Stage comparison using inline function
      const stageMetrics = stages.map((stage, i) => {
        const stageCost = stage.steps.reduce((acc, s) => acc + getStepCost(s), 0);
        const stageMinutes = stage.steps.reduce((acc, s) => acc + (s.timeMinutes || 0), 0);
        const stageCostPerMinute = stageMinutes > 0 ? stageCost / stageMinutes : 0;
        const stageAutomationSavings = stage.steps.reduce((acc, s) => {
          const cost = getStepCost(s);
          return acc + (s.automationOpportunity === 'high' ? cost * 0.7 
            : s.automationOpportunity === 'medium' ? cost * 0.4 
            : s.automationOpportunity === 'low' ? cost * 0.1 : 0);
        }, 0);
        return { 
          ...stage, 
          stageIndex: i,
          cost: stageCost, 
          minutes: stageMinutes, 
          costPerMinute: stageCostPerMinute,
          automationSavings: stageAutomationSavings,
          stepCount: stage.steps.length
        };
      });
      
      // Calculate totals from stepMetrics
      const totalCost = stepMetrics.reduce((acc, s) => acc + s.cost, 0);
      const totalMinutes = allSteps.reduce((acc, s) => acc + (s.timeMinutes || 0), 0);
      const avgCostPerMinute = totalMinutes > 0 ? totalCost / totalMinutes : 0;
      const totalAutomationSavings = stepMetrics.reduce((acc, s) => acc + s.automationSavings, 0);
      
      // Role cost breakdown using inline function
      const roleCosts = personas.filter(p => !p.isExternal).map(persona => {
        let totalRoleCost = 0;
        let totalRoleMinutes = 0;
        
        allSteps.forEach(step => {
          // NEW FORMAT: roleInvolvement
          if (step.roleInvolvement && step.roleInvolvement[persona.id]) {
            const involvement = step.roleInvolvement[persona.id];
            const fullyLoadedRate = calculateFullyLoadedRate(persona);
            const hours = (involvement.timeMinutes || 0) / 60;
            const headcount = involvement.headcount || 1;
            totalRoleCost += fullyLoadedRate * hours * headcount;
            totalRoleMinutes += (involvement.timeMinutes || 0) * headcount;
          }
          // LEGACY FORMAT: Single owner
          else if (step.owner === persona.id && step.timeMinutes > 0) {
            const fullyLoadedRate = calculateFullyLoadedRate(persona);
            const hours = step.timeMinutes / 60;
            totalRoleCost += fullyLoadedRate * hours;
            totalRoleMinutes += step.timeMinutes;
          }
        });
        
        return { ...persona, totalCost: totalRoleCost, totalMinutes: totalRoleMinutes };
      }).filter(role => role.totalMinutes > 0).sort((a, b) => b.totalCost - a.totalCost);

      // Build stage breakdown for export
      const stageBreakdown = stages.map((stage, i) => {
        const stageSteps = stage.steps.map(step => {
          // Get owner labels for legacy format
          let owners = '';
          if (step.roleInvolvement && Object.keys(step.roleInvolvement).length > 0) {
            owners = Object.entries(step.roleInvolvement)
              .map(([roleId, inv]) => {
                const persona = personas.find(p => p.id === roleId);
                return persona?.label || roleId;
              })
              .join(' · ');
          } else if (step.owner) {
            const persona = personas.find(p => p.id === step.owner);
            owners = persona?.label || '';
          }
          
          return {
            ...step,
            cost: getStepCost(step),
            owners
          };
        });
        
        return {
          name: stage.name,
          index: i + 1,
          steps: stageSteps,
          totalTime: stageSteps.reduce((acc, s) => acc + s.timeMinutes, 0),
          totalCost: stageSteps.reduce((acc, s) => acc + s.cost, 0)
        };
      });

      return (
        <div className="cost-analysis-panel" style={{
          padding: '20px 24px'
        }}>
          <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: '24px' }}>
            <h3 style={{ 
              margin: 0, 
              fontSize: '18px', 
              fontWeight: 600,
              display: 'flex',
              alignItems: 'center',
              gap: '8px'
            }}>
              <span>💰</span> Cost Analysis Dashboard
            </h3>
            <div style={{ display: 'flex', gap: '12px', alignItems: 'center' }}>
              <button 
                onClick={() => exportReport('cost', { title: config?.meta?.title || config?.title || 'Journey Map', owner: config?.meta?.owner }, {
                  totalCost, totalMinutes, stageMetrics, roleCosts, totalAutomationSavings, formatTime, stepMetrics, stageBreakdown
                })}
                style={{ 
                  background: '#E1EEF2', 
                  border: 'none', 
                  padding: '6px 12px', 
                  borderRadius: '6px', 
                  fontSize: '13px', 
                  cursor: 'pointer', 
                  color: '#456A8A',
                  display: 'flex',
                  alignItems: 'center',
                  gap: '6px',
                  fontFamily: "'Interstate', sans-serif"
                }}
              >
                📥 Export
              </button>
              {onClose && (
                <button onClick={onClose} style={{ background: 'none', border: 'none', fontSize: '20px', cursor: 'pointer', color: '#8A95A5' }}>×</button>
              )}
            </div>
          </div>
          
          {/* Summary Cards */}
          <div className="cost-summary-cards" style={{ display: 'grid', gridTemplateColumns: 'repeat(auto-fit, minmax(min(180px, 100%), 1fr))', gap: '16px', marginBottom: '32px' }}>
            <div style={{ background: '#FAF0D6', padding: '20px', borderRadius: '12px', textAlign: 'center' }}>
              <div style={{ fontSize: '28px', fontWeight: 700, color: '#8B6914' }}>{formatCurrency(totalCost)}</div>
              <div style={{ fontSize: '12px', color: '#8B6914', fontFamily: "'Interstate', sans-serif", marginTop: '4px' }}>Total Journey Cost</div>
            </div>
            <div style={{ background: '#E1EEF2', padding: '20px', borderRadius: '12px', textAlign: 'center' }}>
              <div style={{ fontSize: '28px', fontWeight: 700, color: '#456A8A' }}>{formatCurrencyDetailed(avgCostPerMinute)}</div>
              <div style={{ fontSize: '12px', color: '#456A8A', fontFamily: "'Interstate', sans-serif", marginTop: '4px' }}>Avg Cost/Minute</div>
            </div>
            <div style={{ background: '#D4EDE5', padding: '20px', borderRadius: '12px', textAlign: 'center' }}>
              <div style={{ fontSize: '28px', fontWeight: 700, color: '#2D8A6E' }}>{formatCurrency(totalAutomationSavings)} <span style={{ fontSize: '16px', opacity: 0.8 }}>({totalCost > 0 ? Math.round((totalAutomationSavings / totalCost) * 100) : 0}%)</span></div>
              <div style={{ fontSize: '12px', color: '#2D8A6E', fontFamily: "'Interstate', sans-serif", marginTop: '4px' }}>Potential Savings</div>
            </div>
            <div style={{ background: '#E1EEF2', padding: '20px', borderRadius: '12px', textAlign: 'center' }}>
              <div style={{ fontSize: '28px', fontWeight: 700, color: '#5A5B8A' }}>{formatTime(totalMinutes)}</div>
              <div style={{ fontSize: '12px', color: '#5A5B8A', fontFamily: "'Interstate', sans-serif", marginTop: '4px' }}>Total Time</div>
            </div>
          </div>
          
          <div className="cost-analysis-grid" style={{ display: 'grid', gridTemplateColumns: 'repeat(auto-fit, minmax(min(300px, 100%), 1fr))', gap: '24px' }}>
            {/* Stage Comparison */}
            <div>
              <h4 style={{ margin: '0 0 16px', fontSize: '14px', fontFamily: "'Interstate', sans-serif", textTransform: 'uppercase', letterSpacing: '0.5px', color: '#556275' }}>
                Stage Comparison
              </h4>
              <div style={{ display: 'flex', flexDirection: 'column', gap: '8px' }}>
                {stageMetrics.map((stage, i) => (
                  <div key={stage.id} style={{
                    display: 'flex',
                    alignItems: 'center',
                    gap: '12px',
                    padding: '12px',
                    background: '#F4F5F7',
                    borderRadius: '8px',
                    borderLeft: `4px solid ${getStageColor(stage.stageIndex)}`
                  }}>
                    <div style={{ flex: 1 }}>
                      <div style={{ fontWeight: 600, fontSize: '14px' }}>{stage.name}</div>
                      <div style={{ fontSize: '11px', color: '#556275', fontFamily: "'Interstate', sans-serif" }}>
                        {stage.stepCount} steps · {formatTime(stage.minutes)}
                      </div>
                    </div>
                    <div style={{ textAlign: 'right' }}>
                      <div style={{ fontWeight: 600, color: '#8B6914' }}>{formatCurrency(stage.cost)}</div>
                      <div style={{ fontSize: '11px', color: '#556275', fontFamily: "'Interstate', sans-serif" }}>
                        {formatCurrencyDetailed(stage.costPerMinute)}/min
                      </div>
                    </div>
                    <div style={{ 
                      width: '60px', 
                      height: '8px', 
                      background: '#E4E7EB', 
                      borderRadius: '4px',
                      overflow: 'hidden'
                    }}>
                      <div style={{
                        width: `${(stage.cost / Math.max(...stageMetrics.map(s => s.cost))) * 100}%`,
                        height: '100%',
                        background: getStageColor(stage.stageIndex)
                      }} />
                    </div>
                  </div>
                ))}
              </div>
            </div>
            
            {/* Cost by Role */}
            <div>
              <h4 style={{ margin: '0 0 16px', fontSize: '14px', fontFamily: "'Interstate', sans-serif", textTransform: 'uppercase', letterSpacing: '0.5px', color: '#556275' }}>
                Cost by Role
              </h4>
              <div style={{ display: 'flex', flexDirection: 'column', gap: '8px' }}>
                {roleCosts.map(role => (
                  <div key={role.id} style={{
                    display: 'flex',
                    alignItems: 'center',
                    gap: '12px',
                    padding: '12px',
                    background: '#F4F5F7',
                    borderRadius: '8px',
                    borderLeft: `4px solid ${role.color}`
                  }}>
                    <div style={{ flex: 1 }}>
                      <div style={{ fontWeight: 600, fontSize: '14px', color: role.color }}>{role.label}</div>
                      <div style={{ fontSize: '11px', color: '#556275', fontFamily: "'Interstate', sans-serif" }}>
                        {formatTime(role.totalMinutes)} total time
                      </div>
                    </div>
                    <div style={{ textAlign: 'right' }}>
                      <div style={{ fontWeight: 600, color: '#8B6914' }}>{formatCurrency(role.totalCost)}</div>
                      <div style={{ fontSize: '11px', color: '#556275', fontFamily: "'Interstate', sans-serif" }}>
                        {totalCost > 0 ? Math.round((role.totalCost / totalCost) * 100) : 0}% of total
                      </div>
                    </div>
                    <div style={{ 
                      width: '60px', 
                      height: '8px', 
                      background: '#E4E7EB', 
                      borderRadius: '4px',
                      overflow: 'hidden'
                    }}>
                      <div style={{
                        width: `${roleCosts[0]?.totalCost > 0 ? (role.totalCost / roleCosts[0].totalCost) * 100 : 0}%`,
                        height: '100%',
                        background: role.color
                      }} />
                    </div>
                  </div>
                ))}
              </div>
            </div>
            
            {/* Most Expensive Steps */}
            <div>
              <h4 style={{ margin: '0 0 16px', fontSize: '14px', fontFamily: "'Interstate', sans-serif", textTransform: 'uppercase', letterSpacing: '0.5px', color: '#556275' }}>
                💰 Top 5 Most Expensive Steps
              </h4>
              <div style={{ display: 'flex', flexDirection: 'column', gap: '8px' }}>
                {byTotalCost.slice(0, 5).map((step, i) => (
                  <div key={step.id} style={{
                    display: 'flex',
                    alignItems: 'center',
                    gap: '12px',
                    padding: '12px',
                    background: i === 0 ? '#F5E0E3' : '#F4F5F7',
                    borderRadius: '8px',
                    border: i === 0 ? '1px solid #F5E0E3' : 'none'
                  }}>
                    <div style={{ 
                      width: '24px', 
                      height: '24px', 
                      borderRadius: '50%', 
                      background: i === 0 ? '#B84A5A' : '#E4E7EB',
                      color: i === 0 ? '#FFF' : '#556275',
                      display: 'flex',
                      alignItems: 'center',
                      justifyContent: 'center',
                      fontSize: '12px',
                      fontWeight: 600
                    }}>
                      {i + 1}
                    </div>
                    <div style={{ flex: 1 }}>
                      <div style={{ fontWeight: 600, fontSize: '13px' }}>{step.name}</div>
                      <div style={{ fontSize: '11px', color: '#556275', fontFamily: "'Interstate', sans-serif" }}>{step.stageName}</div>
                    </div>
                    <div style={{ fontWeight: 600, color: '#8B6914' }}>{formatCurrency(step.cost)}</div>
                  </div>
                ))}
              </div>
            </div>
            
            {/* Highest Cost per Minute */}
            <div>
              <h4 style={{ margin: '0 0 16px', fontSize: '14px', fontFamily: "'Interstate', sans-serif", textTransform: 'uppercase', letterSpacing: '0.5px', color: '#556275' }}>
                ⚡ Highest Cost/Minute Steps
              </h4>
              <div style={{ display: 'flex', flexDirection: 'column', gap: '8px' }}>
                {byCostPerMinute.slice(0, 5).map((step, i) => (
                  <div key={step.id} style={{
                    display: 'flex',
                    alignItems: 'center',
                    gap: '12px',
                    padding: '12px',
                    background: i === 0 ? '#E1EEF2' : '#F4F5F7',
                    borderRadius: '8px',
                    border: i === 0 ? '1px solid #BDD6DE' : 'none'
                  }}>
                    <div style={{ 
                      width: '24px', 
                      height: '24px', 
                      borderRadius: '50%', 
                      background: i === 0 ? '#456A8A' : '#E4E7EB',
                      color: i === 0 ? '#FFF' : '#556275',
                      display: 'flex',
                      alignItems: 'center',
                      justifyContent: 'center',
                      fontSize: '12px',
                      fontWeight: 600
                    }}>
                      {i + 1}
                    </div>
                    <div style={{ flex: 1 }}>
                      <div style={{ fontWeight: 600, fontSize: '13px' }}>{step.name}</div>
                      <div style={{ fontSize: '11px', color: '#556275', fontFamily: "'Interstate', sans-serif" }}>{step.stageName} · {formatTime(step.timeMinutes)}</div>
                    </div>
                    <div style={{ textAlign: 'right' }}>
                      <div style={{ fontWeight: 600, color: '#456A8A' }}>{formatCurrencyDetailed(step.costPerMinute)}/min</div>
                    </div>
                  </div>
                ))}
              </div>
            </div>
            
            {/* Best Improvement Opportunities */}
            <div className="cost-automation-section" style={{ gridColumn: '1 / -1' }}>
              <h4 style={{ margin: '0 0 16px', fontSize: '14px', fontFamily: "'Interstate', sans-serif", textTransform: 'uppercase', letterSpacing: '0.5px', color: '#2D8A6E' }}>
                🎯 Top Improvement Opportunities (by potential savings)
              </h4>
              <div className="cost-automation-grid" style={{ display: 'grid', gridTemplateColumns: 'repeat(auto-fit, minmax(min(280px, 100%), 1fr))', gap: '12px' }}>
                {byAutomationSavings.filter(s => s.automationSavings > 0).slice(0, 8).map((step, i) => (
                  <div key={step.id} style={{
                    display: 'flex',
                    alignItems: 'center',
                    gap: '10px',
                    padding: '12px',
                    background: '#FFF',
                    borderRadius: '8px',
                    border: '2px solid #D4EDE5',
                    minWidth: 0
                  }}>
                    <div style={{
                      width: '36px',
                      height: '36px',
                      borderRadius: '50%',
                      background: '#2D8A6E',
                      color: '#FFF',
                      display: 'flex',
                      alignItems: 'center',
                      justifyContent: 'center',
                      fontSize: '16px',
                      flexShrink: 0
                    }}>
                      🎯
                    </div>
                    <div style={{ flex: 1, minWidth: 0, overflow: 'hidden' }}>
                      <div style={{ fontWeight: 600, fontSize: '13px', color: '#1A2332', whiteSpace: 'nowrap', overflow: 'hidden', textOverflow: 'ellipsis' }}>{step.name}</div>
                      <div style={{ fontSize: '10px', color: '#556275', fontFamily: "'Interstate', sans-serif", whiteSpace: 'nowrap', overflow: 'hidden', textOverflow: 'ellipsis' }}>
                        {step.stageName} · {step.automationOpportunity}
                      </div>
                    </div>
                    <div style={{ textAlign: 'right', flexShrink: 0 }}>
                      <div style={{ fontWeight: 700, fontSize: '14px', color: '#2D8A6E' }}>
                        {formatCurrency(step.automationSavings)} <span style={{ fontSize: '11px', opacity: 0.8 }}>({step.automationOpportunity === 'high' ? '70' : step.automationOpportunity === 'medium' ? '40' : '10'}%)</span>
                      </div>
                      <div style={{ fontSize: '9px', color: '#556275', fontFamily: "'Interstate', sans-serif" }}>
                        potential savings
                      </div>
                    </div>
                  </div>
                ))}
              </div>
            </div>
          </div>
        </div>
      );
    }

    // Improvement Plan Component
    function ImprovementPlan({ config, stages, personas, formatTime, updateConfig }) {
      const formatCurrency = (amount) => {
        if (amount >= 1000) return `£${(amount / 1000).toFixed(1)}k`;
        return `£${Math.round(amount)}`;
      };
      
      // Get all steps with opportunity data
      const allSteps = stages.flatMap((stage, stageIndex) => 
        stage.steps.map(step => ({ ...step, stageName: stage.name, stageIndex }))
      );
      
      // Calculate cost per step (simplified version)
      const getStepCost = (step) => {
        let cost = 0;
        const timeMinutes = step.timeMinutes || 0;
        
        if (step.roleInvolvement && step.roleInvolvement.length > 0) {
          step.roleInvolvement.forEach(ri => {
            const persona = personas.find(p => p.id === ri.roleId);
            if (persona && ri.timeMinutes) {
              const baseSalary = persona.salary || 0;
              const burdenMultiplier = config.costSettings?.burdenMultiplier || 1.4;
              const hoursPerYear = config.costSettings?.hoursPerYear || 1820;
              const workspaceCost = config.costSettings?.workspaceCostPerYear || 5000;
              const fullyLoadedSalary = (baseSalary * burdenMultiplier) + workspaceCost;
              const hourlyRate = fullyLoadedSalary / hoursPerYear;
              cost += (ri.timeMinutes / 60) * hourlyRate;
            }
          });
        } else if (step.owner) {
          const persona = personas.find(p => p.id === step.owner);
          if (persona) {
            const baseSalary = persona.salary || 0;
            const burdenMultiplier = config.costSettings?.burdenMultiplier || 1.4;
            const hoursPerYear = config.costSettings?.hoursPerYear || 1820;
            const workspaceCost = config.costSettings?.workspaceCostPerYear || 5000;
            const fullyLoadedSalary = (baseSalary * burdenMultiplier) + workspaceCost;
            const hourlyRate = fullyLoadedSalary / hoursPerYear;
            cost = (timeMinutes / 60) * hourlyRate;
          }
        }
        
        if (step.thirdPartyCost) {
          cost += step.thirdPartyCost;
        }
        
        return cost;
      };
      
      // Build opportunities list
      const opportunities = allSteps
        .filter(step => step.automationOpportunity && step.automationOpportunity !== 'none')
        .map(step => {
          const cost = getStepCost(step);
          const savingsPercent = step.automationOpportunity === 'high' ? 0.7 
            : step.automationOpportunity === 'medium' ? 0.4 
            : 0.1;
          const savings = cost * savingsPercent;
          
          // Get existing plan data from config or defaults
          const planData = config.improvementPlan?.items?.find(item => item.stepId === step.id) || {};
          
          return {
            stepId: step.id,
            stepName: step.name,
            stageName: step.stageName,
            opportunity: step.automationOpportunity,
            cost,
            savings,
            savingsPercent: Math.round(savingsPercent * 100),
            painPoints: step.painPoints?.length || 0,
            effort: planData.effort || (step.automationOpportunity === 'high' ? 'M' : step.automationOpportunity === 'medium' ? 'S' : 'S'),
            phase: planData.phase || (step.automationOpportunity === 'high' && savings > 100 ? 2 : step.automationOpportunity === 'high' ? 1 : 3),
            owner: planData.owner || '',
            status: planData.status || 'not-started'
          };
        })
        .sort((a, b) => b.savings - a.savings);
      
      // Group by phase
      const phases = [
        { id: 1, name: 'Quick Wins', description: 'Low effort, high impact', color: '#2D8A6E' },
        { id: 2, name: 'Core Improvements', description: 'Medium effort, significant value', color: '#C4942A' },
        { id: 3, name: 'Strategic Initiatives', description: 'Higher effort, transformational', color: '#5B8A9A' }
      ];
      
      const getPhaseItems = (phaseId) => opportunities.filter(o => o.phase === phaseId);
      
      const updateOpportunity = (stepId, field, value) => {
        const existingPlan = config.improvementPlan || { items: [] };
        const existingItems = existingPlan.items || [];
        const itemIndex = existingItems.findIndex(item => item.stepId === stepId);
        
        let newItems;
        if (itemIndex >= 0) {
          newItems = existingItems.map((item, i) => 
            i === itemIndex ? { ...item, [field]: value } : item
          );
        } else {
          newItems = [...existingItems, { stepId, [field]: value }];
        }
        
        updateConfig({
          ...config,
          improvementPlan: { ...existingPlan, items: newItems }
        });
      };
      
      const totalSavings = opportunities.reduce((acc, o) => acc + o.savings, 0);
      const phaseSavings = phases.map(p => ({
        ...p,
        savings: getPhaseItems(p.id).reduce((acc, o) => acc + o.savings, 0),
        count: getPhaseItems(p.id).length
      }));
      
      const effortLabels = { S: 'Small', M: 'Medium', L: 'Large', XL: 'Extra Large' };
      const effortColors = { S: '#2D8A6E', M: '#5B8A9A', L: '#C4942A', XL: '#B84A5A' };
      const statusLabels = { 'not-started': 'Not Started', 'in-progress': 'In Progress', 'complete': 'Complete' };
      const statusColors = { 'not-started': '#8A95A5', 'in-progress': '#C4942A', 'complete': '#2D8A6E' };
      
      // Export functions
      const exportToExcel = () => {
        let csv = 'Phase,Step,Stage,Opportunity Level,Effort,Owner,Status,Current Cost,Potential Savings,Savings %\n';
        phases.forEach(phase => {
          getPhaseItems(phase.id).forEach(item => {
            csv += `"${phase.name}","${item.stepName}","${item.stageName}","${item.opportunity}","${effortLabels[item.effort]}","${item.owner}","${statusLabels[item.status]}","${item.cost.toFixed(2)}","${item.savings.toFixed(2)}","${item.savingsPercent}%"\n`;
          });
        });
        
        const blob = new Blob([csv], { type: 'text/csv' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `${config.meta?.title || 'journey'}-improvement-plan.csv`;
        a.click();
        URL.revokeObjectURL(url);
      };
      
      const exportToPDF = () => {
        // Create printable HTML
        const printWindow = window.open('', '_blank');
        printWindow.document.write(`
          <!DOCTYPE html>
          <html>
          <head>
            <title>Improvement Plan - ${config.meta?.title || 'Journey'}</title>
            <style>
              body { font-family: 'Segoe UI', Arial, sans-serif; padding: 40px; color: #1A2332; line-height: 1.6; }
              h1 { color: #192B45; margin-bottom: 8px; }
              .subtitle { color: #556275; margin-bottom: 32px; }
              .summary { display: flex; gap: 24px; margin-bottom: 40px; }
              .summary-card { background: #F4F5F7; padding: 20px; border-radius: 8px; flex: 1; }
              .summary-card h3 { margin: 0 0 8px; font-size: 14px; color: #556275; text-transform: uppercase; }
              .summary-card .value { font-size: 28px; font-weight: 700; color: #192B45; }
              .phase { margin-bottom: 32px; }
              .phase-header { display: flex; align-items: center; gap: 12px; margin-bottom: 16px; padding-bottom: 8px; border-bottom: 2px solid #E4E7EB; }
              .phase-dot { width: 12px; height: 12px; border-radius: 50%; }
              .phase-name { font-size: 18px; font-weight: 600; }
              .phase-savings { margin-left: auto; font-weight: 600; color: #2D8A6E; }
              table { width: 100%; border-collapse: collapse; font-size: 13px; }
              th { text-align: left; padding: 10px 12px; background: #F4F5F7; font-weight: 600; }
              td { padding: 10px 12px; border-bottom: 1px solid #E4E7EB; }
              .badge { display: inline-block; padding: 2px 8px; border-radius: 4px; font-size: 11px; font-weight: 600; }
              @media print { body { padding: 20px; } }
            </style>
          </head>
          <body>
            <h1>Improvement Plan</h1>
            <p class="subtitle">${config.meta?.title || 'Journey Map'} · Generated ${new Date().toLocaleDateString('en-GB')}</p>
            
            <div class="summary">
              <div class="summary-card">
                <h3>Total Opportunities</h3>
                <div class="value">${opportunities.length}</div>
              </div>
              <div class="summary-card">
                <h3>Total Potential Savings</h3>
                <div class="value" style="color: #2D8A6E;">${formatCurrency(totalSavings)}</div>
              </div>
            </div>
            
            ${phases.map(phase => {
              const items = getPhaseItems(phase.id);
              if (items.length === 0) return '';
              const phaseSaving = items.reduce((acc, o) => acc + o.savings, 0);
              return `
                <div class="phase">
                  <div class="phase-header">
                    <div class="phase-dot" style="background: ${phase.color}"></div>
                    <div class="phase-name">${phase.name}</div>
                    <div style="color: #8A95A5; font-size: 13px;">${phase.description}</div>
                    <div class="phase-savings">${formatCurrency(phaseSaving)}</div>
                  </div>
                  <table>
                    <thead>
                      <tr>
                        <th>Step</th>
                        <th>Stage</th>
                        <th>Effort</th>
                        <th>Owner</th>
                        <th>Savings</th>
                      </tr>
                    </thead>
                    <tbody>
                      ${items.map(item => `
                        <tr>
                          <td><strong>${item.stepName}</strong></td>
                          <td>${item.stageName}</td>
                          <td><span class="badge" style="background: ${effortColors[item.effort]}20; color: ${effortColors[item.effort]}">${effortLabels[item.effort]}</span></td>
                          <td>${item.owner || '—'}</td>
                          <td style="font-weight: 600; color: #2D8A6E;">${formatCurrency(item.savings)}</td>
                        </tr>
                      `).join('')}
                    </tbody>
                  </table>
                </div>
              `;
            }).join('')}
          </body>
          </html>
        `);
        printWindow.document.close();
        setTimeout(() => printWindow.print(), 250);
      };
      
      return (
        <div style={{ padding: '24px', maxWidth: '1200px', margin: '0 auto' }}>
          {/* Header */}
          <div style={{ display: 'flex', alignItems: 'center', justifyContent: 'space-between', marginBottom: '24px', flexWrap: 'wrap', gap: '16px' }}>
            <div>
              <h3 style={{ margin: 0, fontSize: '20px', fontFamily: "'Interstate', sans-serif", color: '#192B45' }}>
                📋 Improvement Plan
              </h3>
              <p style={{ margin: '4px 0 0', fontSize: '14px', color: '#556275' }}>
                {opportunities.length} opportunities identified · {formatCurrency(totalSavings)} potential savings
              </p>
            </div>
            <div style={{ display: 'flex', gap: '8px' }}>
              <button
                onClick={exportToExcel}
                style={{
                  padding: '8px 16px',
                  background: '#FFF',
                  border: '1px solid #C8CED6',
                  borderRadius: '6px',
                  cursor: 'pointer',
                  fontSize: '13px',
                  fontFamily: "'Interstate', sans-serif",
                  display: 'flex',
                  alignItems: 'center',
                  gap: '6px'
                }}
              >
                📊 Export Excel
              </button>
              <button
                onClick={exportToPDF}
                style={{
                  padding: '8px 16px',
                  background: '#FFF',
                  border: '1px solid #C8CED6',
                  borderRadius: '6px',
                  cursor: 'pointer',
                  fontSize: '13px',
                  fontFamily: "'Interstate', sans-serif",
                  display: 'flex',
                  alignItems: 'center',
                  gap: '6px'
                }}
              >
                📄 Export PDF
              </button>
            </div>
          </div>
          
          {/* Phase Summary Cards */}
          <div style={{ display: 'grid', gridTemplateColumns: 'repeat(3, 1fr)', gap: '16px', marginBottom: '32px' }}>
            {phaseSavings.map(phase => (
              <div key={phase.id} style={{
                background: '#FFF',
                border: `2px solid ${phase.color}20`,
                borderRadius: '12px',
                padding: '20px',
                borderLeft: `4px solid ${phase.color}`
              }}>
                <div style={{ display: 'flex', alignItems: 'center', gap: '8px', marginBottom: '8px' }}>
                  <span style={{ fontSize: '14px' }}>{phase.id === 1 ? '🚀' : phase.id === 2 ? '🔧' : '🎯'}</span>
                  <span style={{ fontFamily: "'Interstate', sans-serif", fontWeight: 600, fontSize: '14px', color: '#192B45' }}>{phase.name}</span>
                </div>
                <div style={{ fontSize: '12px', color: '#8A95A5', marginBottom: '12px' }}>{phase.description}</div>
                <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'baseline' }}>
                  <span style={{ fontSize: '24px', fontWeight: 700, color: phase.color }}>{formatCurrency(phase.savings)}</span>
                  <span style={{ fontSize: '12px', color: '#556275' }}>{phase.count} items</span>
                </div>
              </div>
            ))}
          </div>
          
          {/* Phase Lists */}
          {phases.map(phase => {
            const items = getPhaseItems(phase.id);
            if (items.length === 0) return null;
            
            return (
              <div key={phase.id} style={{ marginBottom: '32px' }}>
                <div style={{ 
                  display: 'flex', 
                  alignItems: 'center', 
                  gap: '12px', 
                  marginBottom: '16px',
                  paddingBottom: '12px',
                  borderBottom: `2px solid ${phase.color}30`
                }}>
                  <div style={{ width: '10px', height: '10px', borderRadius: '50%', background: phase.color }} />
                  <h4 style={{ margin: 0, fontFamily: "'Interstate', sans-serif", fontSize: '16px', color: '#192B45' }}>
                    {phase.name}
                  </h4>
                  <span style={{ fontSize: '13px', color: '#8A95A5' }}>{phase.description}</span>
                  <span style={{ marginLeft: 'auto', fontWeight: 600, color: phase.color }}>
                    {formatCurrency(items.reduce((acc, o) => acc + o.savings, 0))}
                  </span>
                </div>
                
                <div style={{ display: 'flex', flexDirection: 'column', gap: '8px' }}>
                  {items.map((item, index) => (
                    <div key={item.stepId} style={{
                      background: '#FFF',
                      border: '1px solid #E4E7EB',
                      borderRadius: '8px',
                      padding: '16px',
                      display: 'grid',
                      gridTemplateColumns: '1fr auto auto auto auto',
                      gap: '16px',
                      alignItems: 'center'
                    }}>
                      {/* Step Info */}
                      <div style={{ minWidth: 0 }}>
                        <div style={{ fontWeight: 600, fontSize: '14px', color: '#192B45', marginBottom: '2px' }}>
                          {item.stepName}
                        </div>
                        <div style={{ fontSize: '12px', color: '#8A95A5' }}>
                          {item.stageName}
                          {item.painPoints > 0 && <span style={{ color: '#B84A5A', marginLeft: '8px' }}>⚠️ {item.painPoints} pain points</span>}
                        </div>
                      </div>
                      
                      {/* Effort Dropdown */}
                      <div>
                        <label style={{ fontSize: '10px', color: '#8A95A5', display: 'block', marginBottom: '4px', fontFamily: "'Interstate', sans-serif" }}>EFFORT</label>
                        <select
                          value={item.effort}
                          onChange={(e) => updateOpportunity(item.stepId, 'effort', e.target.value)}
                          style={{
                            padding: '6px 24px 6px 8px',
                            border: '1px solid #C8CED6',
                            borderRadius: '4px',
                            fontSize: '12px',
                            background: `${effortColors[item.effort]}15`,
                            color: effortColors[item.effort],
                            fontWeight: 600,
                            cursor: 'pointer',
                            appearance: 'none',
                            backgroundImage: `url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 24 24' fill='none' stroke='%238A95A5' stroke-width='2'%3E%3Cpath d='M6 9l6 6 6-6'/%3E%3C/svg%3E")`,
                            backgroundRepeat: 'no-repeat',
                            backgroundPosition: 'right 6px center'
                          }}
                        >
                          <option value="S">Small</option>
                          <option value="M">Medium</option>
                          <option value="L">Large</option>
                          <option value="XL">X-Large</option>
                        </select>
                      </div>
                      
                      {/* Phase Dropdown */}
                      <div>
                        <label style={{ fontSize: '10px', color: '#8A95A5', display: 'block', marginBottom: '4px', fontFamily: "'Interstate', sans-serif" }}>PHASE</label>
                        <select
                          value={item.phase}
                          onChange={(e) => updateOpportunity(item.stepId, 'phase', parseInt(e.target.value))}
                          style={{
                            padding: '6px 24px 6px 8px',
                            border: '1px solid #C8CED6',
                            borderRadius: '4px',
                            fontSize: '12px',
                            cursor: 'pointer',
                            appearance: 'none',
                            backgroundImage: `url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 24 24' fill='none' stroke='%238A95A5' stroke-width='2'%3E%3Cpath d='M6 9l6 6 6-6'/%3E%3C/svg%3E")`,
                            backgroundRepeat: 'no-repeat',
                            backgroundPosition: 'right 6px center'
                          }}
                        >
                          {phases.map(p => (
                            <option key={p.id} value={p.id}>{p.name}</option>
                          ))}
                        </select>
                      </div>
                      
                      {/* Owner Input */}
                      <div>
                        <label style={{ fontSize: '10px', color: '#8A95A5', display: 'block', marginBottom: '4px', fontFamily: "'Interstate', sans-serif" }}>OWNER</label>
                        <input
                          type="text"
                          value={item.owner}
                          onChange={(e) => updateOpportunity(item.stepId, 'owner', e.target.value)}
                          placeholder="Assign..."
                          style={{
                            padding: '6px 8px',
                            border: '1px solid #C8CED6',
                            borderRadius: '4px',
                            fontSize: '12px',
                            width: '100px'
                          }}
                        />
                      </div>
                      
                      {/* Savings */}
                      <div style={{ textAlign: 'right' }}>
                        <div style={{ fontWeight: 700, fontSize: '16px', color: '#2D8A6E' }}>
                          {formatCurrency(item.savings)}
                        </div>
                        <div style={{ fontSize: '11px', color: '#8A95A5' }}>
                          {item.savingsPercent}% savings
                        </div>
                      </div>
                    </div>
                  ))}
                </div>
              </div>
            );
          })}
          
          {opportunities.length === 0 && (
            <div style={{ 
              textAlign: 'center', 
              padding: '60px 24px', 
              background: '#F4F5F7', 
              borderRadius: '12px',
              color: '#556275'
            }}>
              <div style={{ fontSize: '48px', marginBottom: '16px' }}>🎯</div>
              <h4 style={{ margin: '0 0 8px', color: '#192B45' }}>No improvement opportunities identified</h4>
              <p style={{ margin: 0, fontSize: '14px' }}>
                Mark steps with automation/improvement potential in the editor to see them here
              </p>
            </div>
          )}
        </div>
      );
    }

    // Add Stage Modal
    function AddStageModal({ onAdd, onClose }) {
      const [name, setName] = useState('');
      
      return (
        <div style={{
          position: 'fixed',
          inset: 0,
          background: 'rgba(0,0,0,0.5)',
          display: 'flex',
          alignItems: 'center',
          justifyContent: 'center',
          zIndex: 1000
        }} onClick={onClose}>
          <div style={{
            background: '#FFF',
            borderRadius: '12px',
            padding: '32px',
            width: '400px',
            maxWidth: '90vw'
          }} onClick={e => e.stopPropagation()}>
            <h3 style={{ margin: '0 0 24px', fontSize: '20px' }}>Add New Stage</h3>
            <input
              type="text"
              value={name}
              onChange={(e) => setName(e.target.value)}
              placeholder="Stage name..."
              autoFocus
              style={{
                width: '100%',
                padding: '12px 16px',
                border: '2px solid #E4E7EB',
                borderRadius: '8px',
                fontSize: '16px',
                marginBottom: '24px'
              }}
              onKeyDown={(e) => {
                if (e.key === 'Enter' && name.trim()) {
                  onAdd(name.trim());
                }
              }}
            />
            <div style={{ display: 'flex', gap: '12px', justifyContent: 'flex-end' }}>
              <button
                onClick={onClose}
                style={{
                  padding: '10px 20px',
                  background: '#F4F5F7',
                  border: 'none',
                  borderRadius: '6px',
                  cursor: 'pointer',
                  fontFamily: "'Interstate', sans-serif"
                }}
              >
                Cancel
              </button>
              <button
                onClick={() => name.trim() && onAdd(name.trim())}
                disabled={!name.trim()}
                style={{
                  padding: '10px 20px',
                  background: name.trim() ? '#2D8A6E' : '#A9B2BE',
                  color: '#FFF',
                  border: 'none',
                  borderRadius: '6px',
                  cursor: name.trim() ? 'pointer' : 'not-allowed',
                  fontFamily: "'Interstate', sans-serif"
                }}
              >
                Add Stage
              </button>
            </div>
          </div>
        </div>
      );
    }

    // Add Step Modal
    function AddStepModal({ stageId, stageName, personas, onAdd, onClose }) {
      const [step, setStep] = useState({
        name: '',
        description: '',
        timeMinutes: 30,
        owner: personas[0]?.id || 'client',
        frictionScore: 3,
        automationOpportunity: 'medium'
      });
      
      return (
        <div style={{
          position: 'fixed',
          inset: 0,
          background: 'rgba(0,0,0,0.5)',
          display: 'flex',
          alignItems: 'center',
          justifyContent: 'center',
          zIndex: 1000
        }} onClick={onClose}>
          <div style={{
            background: '#FFF',
            borderRadius: '12px',
            padding: '32px',
            width: '500px',
            maxWidth: '90vw',
            maxHeight: '90vh',
            overflow: 'auto'
          }} onClick={e => e.stopPropagation()}>
            <h3 style={{ margin: '0 0 8px', fontSize: '20px' }}>Add New Step</h3>
            <p style={{ 
              margin: '0 0 24px', 
              color: '#556275',
              fontFamily: "'Interstate', sans-serif",
              fontSize: '14px'
            }}>
              Adding to: {stageName}
            </p>
            
            <div style={{ display: 'flex', flexDirection: 'column', gap: '16px' }}>
              <div>
                <label style={{
                  display: 'block',
                  fontFamily: "'Interstate', sans-serif",
                  fontSize: '12px',
                  color: '#556275',
                  marginBottom: '6px',
                  textTransform: 'uppercase',
                  letterSpacing: '0.5px'
                }}>
                  Step Name *
                </label>
                <input
                  type="text"
                  value={step.name}
                  onChange={(e) => setStep({ ...step, name: e.target.value })}
                  placeholder="e.g., Initial Assessment"
                  autoFocus
                  style={{
                    width: '100%',
                    padding: '10px 14px',
                    border: '2px solid #E4E7EB',
                    borderRadius: '6px',
                    fontSize: '14px'
                  }}
                />
              </div>
              
              <div>
                <label style={{
                  display: 'block',
                  fontFamily: "'Interstate', sans-serif",
                  fontSize: '12px',
                  color: '#556275',
                  marginBottom: '6px',
                  textTransform: 'uppercase',
                  letterSpacing: '0.5px'
                }}>
                  Description
                </label>
                <textarea
                  value={step.description}
                  onChange={(e) => setStep({ ...step, description: e.target.value })}
                  placeholder="Brief description of this step..."
                  rows={2}
                  style={{
                    width: '100%',
                    padding: '10px 14px',
                    border: '2px solid #E4E7EB',
                    borderRadius: '6px',
                    fontSize: '14px',
                    resize: 'vertical'
                  }}
                />
              </div>
              
              <div style={{ display: 'grid', gridTemplateColumns: '1fr 1fr', gap: '16px' }}>
                <div>
                  <label style={{
                    display: 'block',
                    fontFamily: "'Interstate', sans-serif",
                    fontSize: '12px',
                    color: '#556275',
                    marginBottom: '6px',
                    textTransform: 'uppercase',
                    letterSpacing: '0.5px'
                  }}>
                    Time (minutes)
                  </label>
                  <input
                    type="number"
                    value={step.timeMinutes}
                    onChange={(e) => setStep({ ...step, timeMinutes: parseInt(e.target.value) || 0 })}
                    min="1"
                    style={{
                      width: '100%',
                      padding: '10px 14px',
                      border: '2px solid #E4E7EB',
                      borderRadius: '6px',
                      fontSize: '14px'
                    }}
                  />
                </div>
                
                <div>
                  <label style={{
                    display: 'block',
                    fontFamily: "'Interstate', sans-serif",
                    fontSize: '12px',
                    color: '#556275',
                    marginBottom: '6px',
                    textTransform: 'uppercase',
                    letterSpacing: '0.5px'
                  }}>
                    Owner
                  </label>
                  <select
                    value={step.owner}
                    onChange={(e) => setStep({ ...step, owner: e.target.value })}
                    style={{
                      width: '100%',
                      padding: '10px 14px',
                      border: '2px solid #E4E7EB',
                      borderRadius: '6px',
                      fontSize: '14px',
                      background: '#FFF'
                    }}
                  >
                    {personas.map(p => (
                      <option key={p.id} value={p.id}>{p.label}</option>
                    ))}
                  </select>
                </div>
              </div>
              
              <div style={{ display: 'grid', gridTemplateColumns: '1fr 1fr', gap: '16px' }}>
                <div>
                  <label style={{
                    display: 'block',
                    fontFamily: "'Interstate', sans-serif",
                    fontSize: '12px',
                    color: '#556275',
                    marginBottom: '6px',
                    textTransform: 'uppercase',
                    letterSpacing: '0.5px'
                  }}>
                    Friction {step.frictionScore && <span style={{ marginLeft: '8px' }}>{frictionConfig[step.frictionScore]?.emoji} {frictionConfig[step.frictionScore]?.label}</span>}
                  </label>
                  <div style={{ display: 'flex', gap: '8px' }}>
                    {[1,2,3,4,5].map(n => (
                      <button
                        key={n}
                        type="button"
                        onClick={() => setStep({ ...step, frictionScore: n })}
                        style={{
                          width: '36px',
                          height: '36px',
                          border: '2px solid',
                          borderColor: step.frictionScore >= n ? frictionConfig[step.frictionScore]?.color : '#E4E7EB',
                          borderRadius: '6px',
                          background: step.frictionScore >= n ? frictionConfig[step.frictionScore]?.color : '#FFF',
                          color: step.frictionScore >= n ? '#FFF' : '#3D4A5C',
                          cursor: 'pointer',
                          fontWeight: 600,
                          transition: 'all 0.15s'
                        }}
                      >
                        {n}
                      </button>
                    ))}
                  </div>
                </div>
                
                <div>
                  <label style={{
                    display: 'block',
                    fontFamily: "'Interstate', sans-serif",
                    fontSize: '12px',
                    color: '#556275',
                    marginBottom: '6px',
                    textTransform: 'uppercase',
                    letterSpacing: '0.5px'
                  }}>
                    Improvement Potential
                  </label>
                  <select
                    value={step.automationOpportunity}
                    onChange={(e) => setStep({ ...step, automationOpportunity: e.target.value })}
                    style={{
                      width: '100%',
                      padding: '10px 14px',
                      border: '2px solid #E4E7EB',
                      borderRadius: '6px',
                      fontSize: '14px',
                      background: '#FFF'
                    }}
                  >
                    <option value="high">High</option>
                    <option value="medium">Medium</option>
                    <option value="low">Low</option>
                    <option value="none">None</option>
                  </select>
                </div>
              </div>
            </div>
            
            <div style={{ display: 'flex', gap: '12px', justifyContent: 'flex-end', marginTop: '24px' }}>
              <button
                onClick={onClose}
                style={{
                  padding: '10px 20px',
                  background: '#F4F5F7',
                  border: 'none',
                  borderRadius: '6px',
                  cursor: 'pointer',
                  fontFamily: "'Interstate', sans-serif"
                }}
              >
                Cancel
              </button>
              <button
                onClick={() => step.name.trim() && onAdd(stageId, step)}
                disabled={!step.name.trim()}
                style={{
                  padding: '10px 20px',
                  background: step.name.trim() ? '#2D8A6E' : '#A9B2BE',
                  color: '#FFF',
                  border: 'none',
                  borderRadius: '6px',
                  cursor: step.name.trim() ? 'pointer' : 'not-allowed',
                  fontFamily: "'Interstate', sans-serif"
                }}
              >
                Add Step
              </button>
            </div>
          </div>
        </div>
      );
    }

    // GitHub Settings Modal
    function GitHubSettingsModal({ config, onUpdate, onClose, onSave, onLoad, status }) {
      const [localConfig, setLocalConfig] = useState(config);
      const [showToken, setShowToken] = useState(false);

      return (
        <div style={{
          position: 'fixed',
          inset: 0,
          background: 'rgba(0,0,0,0.5)',
          display: 'flex',
          alignItems: 'center',
          justifyContent: 'center',
          zIndex: 1000
        }} onClick={onClose}>
          <div style={{
            background: '#FFF',
            borderRadius: '12px',
            width: '500px',
            maxWidth: '95vw',
            maxHeight: '90vh',
            overflow: 'auto'
          }} onClick={e => e.stopPropagation()}>
            {/* Header */}
            <div style={{ padding: '24px 32px', borderBottom: '1px solid #E4E7EB', display: 'flex', justifyContent: 'space-between', alignItems: 'center' }}>
              <div style={{ display: 'flex', alignItems: 'center', gap: '12px' }}>
                <span style={{ fontSize: '24px' }}>🐙</span>
                <div>
                  <h3 style={{ margin: 0, fontSize: '20px', fontWeight: 600 }}>GitHub Settings</h3>
                  <p style={{ margin: '4px 0 0', fontSize: '13px', color: '#556275' }}>Connect to save & load your journey</p>
                </div>
              </div>
              <button onClick={onClose} style={{ background: 'none', border: 'none', fontSize: '24px', cursor: 'pointer', color: '#8A95A5' }}>×</button>
            </div>

            {/* Content */}
            <div style={{ padding: '24px 32px' }}>
              <div style={{ marginBottom: '20px' }}>
                <label style={{ display: 'block', fontSize: '13px', fontWeight: 500, marginBottom: '6px', color: '#3D4A5C' }}>Repository Owner</label>
                <input
                  type="text"
                  value={localConfig.owner}
                  onChange={(e) => setLocalConfig({ ...localConfig, owner: e.target.value })}
                  placeholder="e.g., steveyoung74"
                  style={{ width: '100%', padding: '10px 12px', border: '1px solid #C8CED6', borderRadius: '6px', fontSize: '14px' }}
                />
              </div>

              <div style={{ marginBottom: '20px' }}>
                <label style={{ display: 'block', fontSize: '13px', fontWeight: 500, marginBottom: '6px', color: '#3D4A5C' }}>Repository Name</label>
                <input
                  type="text"
                  value={localConfig.repo}
                  onChange={(e) => setLocalConfig({ ...localConfig, repo: e.target.value })}
                  placeholder="e.g., journeymaps"
                  style={{ width: '100%', padding: '10px 12px', border: '1px solid #C8CED6', borderRadius: '6px', fontSize: '14px' }}
                />
              </div>

              <div style={{ marginBottom: '20px' }}>
                <label style={{ display: 'block', fontSize: '13px', fontWeight: 500, marginBottom: '6px', color: '#3D4A5C' }}>File Path</label>
                <input
                  type="text"
                  value={localConfig.path}
                  onChange={(e) => setLocalConfig({ ...localConfig, path: e.target.value })}
                  placeholder="e.g., onboarding/journey-map.json"
                  style={{ width: '100%', padding: '10px 12px', border: '1px solid #C8CED6', borderRadius: '6px', fontSize: '14px' }}
                />
              </div>

              <div style={{ marginBottom: '20px' }}>
                <label style={{ display: 'block', fontSize: '13px', fontWeight: 500, marginBottom: '6px', color: '#3D4A5C' }}>Branch</label>
                <input
                  type="text"
                  value={localConfig.branch}
                  onChange={(e) => setLocalConfig({ ...localConfig, branch: e.target.value })}
                  placeholder="e.g., main"
                  style={{ width: '100%', padding: '10px 12px', border: '1px solid #C8CED6', borderRadius: '6px', fontSize: '14px' }}
                />
              </div>

              <div style={{ marginBottom: '24px' }}>
                <label style={{ display: 'block', fontSize: '13px', fontWeight: 500, marginBottom: '6px', color: '#3D4A5C' }}>
                  Personal Access Token
                  <a href="https://github.com/settings/tokens/new?scopes=repo&description=Journey%20Map" target="_blank" rel="noopener noreferrer" style={{ marginLeft: '8px', fontSize: '12px', color: '#2563EB' }}>Generate token →</a>
                </label>
                <div style={{ position: 'relative' }}>
                  <input
                    type={showToken ? 'text' : 'password'}
                    value={localConfig.token}
                    onChange={(e) => setLocalConfig({ ...localConfig, token: e.target.value })}
                    placeholder="ghp_xxxxxxxxxxxx"
                    style={{ width: '100%', padding: '10px 12px', paddingRight: '80px', border: '1px solid #C8CED6', borderRadius: '6px', fontSize: '14px', fontFamily: 'monospace' }}
                  />
                  <button
                    onClick={() => setShowToken(!showToken)}
                    style={{ position: 'absolute', right: '8px', top: '50%', transform: 'translateY(-50%)', background: '#F4F5F7', border: 'none', borderRadius: '4px', padding: '4px 8px', fontSize: '12px', cursor: 'pointer' }}
                  >
                    {showToken ? 'Hide' : 'Show'}
                  </button>
                </div>
                <p style={{ margin: '8px 0 0', fontSize: '12px', color: '#556275' }}>
                  🔒 Stored locally in your browser only. Never sent anywhere except GitHub.
                </p>
              </div>

              {/* Status message */}
              {status.message && (
                <div style={{ 
                  padding: '12px 16px', 
                  background: status.error ? '#F5E0E3' : status.loading ? '#F0F9FF' : '#E1EEF2', 
                  borderRadius: '8px', 
                  marginBottom: '20px',
                  color: status.error ? '#B84A5A' : status.loading ? '#1D4ED8' : '#2D8A6E',
                  fontSize: '14px',
                  display: 'flex',
                  alignItems: 'center',
                  gap: '8px'
                }}>
                  {status.loading && <span style={{ animation: 'spin 1s linear infinite' }}>⏳</span>}
                  {status.message}
                </div>
              )}

              {/* Action Buttons */}
              <div style={{ display: 'flex', gap: '12px' }}>
                <button
                  onClick={() => { onUpdate(localConfig); onLoad(); }}
                  disabled={!localConfig.token || status.loading}
                  style={{ 
                    flex: 1, 
                    padding: '12px', 
                    background: localConfig.token && !status.loading ? '#2563EB' : '#E4E7EB', 
                    color: localConfig.token && !status.loading ? '#FFF' : '#8A95A5', 
                    border: 'none', 
                    borderRadius: '8px', 
                    cursor: localConfig.token && !status.loading ? 'pointer' : 'not-allowed',
                    fontSize: '14px',
                    fontWeight: 500,
                    display: 'flex',
                    alignItems: 'center',
                    justifyContent: 'center',
                    gap: '8px'
                  }}
                >
                  <span>📥</span> Load from GitHub
                </button>
                <button
                  onClick={() => { onUpdate(localConfig); onSave(); }}
                  disabled={!localConfig.token || status.loading}
                  style={{ 
                    flex: 1, 
                    padding: '12px', 
                    background: localConfig.token && !status.loading ? '#2D8A6E' : '#E4E7EB', 
                    color: localConfig.token && !status.loading ? '#FFF' : '#8A95A5', 
                    border: 'none', 
                    borderRadius: '8px', 
                    cursor: localConfig.token && !status.loading ? 'pointer' : 'not-allowed',
                    fontSize: '14px',
                    fontWeight: 500,
                    display: 'flex',
                    alignItems: 'center',
                    justifyContent: 'center',
                    gap: '8px'
                  }}
                >
                  <span>📤</span> Save to GitHub
                </button>
              </div>
            </div>

            {/* Footer */}
            <div style={{ padding: '16px 32px', borderTop: '1px solid #E4E7EB', display: 'flex', justifyContent: 'space-between', alignItems: 'center' }}>
              <button
                onClick={() => { setLocalConfig({ ...localConfig, token: '' }); onUpdate({ ...localConfig, token: '' }); }}
                style={{ padding: '8px 16px', background: '#F5E0E3', color: '#B84A5A', border: 'none', borderRadius: '6px', cursor: 'pointer', fontSize: '13px' }}
              >
                Clear Token
              </button>
              <button
                onClick={() => { onUpdate(localConfig); onClose(); }}
                style={{ padding: '10px 24px', background: '#1A2332', color: '#FFF', border: 'none', borderRadius: '6px', cursor: 'pointer', fontWeight: 500 }}
              >
                Done
              </button>
            </div>
          </div>
        </div>
      );
    }

    // Structure Configuration Panel
    function StructurePanel({ config, onMoveStage, onMoveStep, onInsertStage, onInsertStep, onRemoveStage, onRemoveStep, onClose, onRenameStage, onRenameStep }) {
      const [addingStageAfter, setAddingStageAfter] = useState(null); // index or -1 for start
      const [addingStepIn, setAddingStepIn] = useState(null); // { stageId, afterIndex }
      const [newStageName, setNewStageName] = useState('');
      const [newStepName, setNewStepName] = useState('');
      const [expandedStages, setExpandedStages] = useState(config.stages.map(s => s.id));
      const [editingStage, setEditingStage] = useState(null); // stageId
      const [editingStageName, setEditingStageName] = useState('');
      const [editingStepId, setEditingStepId] = useState(null); // stepId
      const [editingStepName, setEditingStepName] = useState('');

      const toggleExpand = (stageId) => {
        setExpandedStages(prev => 
          prev.includes(stageId) 
            ? prev.filter(id => id !== stageId)
            : [...prev, stageId]
        );
      };

      const handleAddStage = () => {
        if (newStageName.trim()) {
          onInsertStage(newStageName.trim(), addingStageAfter);
          setNewStageName('');
          setAddingStageAfter(null);
        }
      };

      const handleAddStep = () => {
        if (newStepName.trim() && addingStepIn) {
          onInsertStep(addingStepIn.stageId, { name: newStepName.trim() }, addingStepIn.afterIndex);
          setNewStepName('');
          setAddingStepIn(null);
        }
      };

      const startEditingStage = (stageId, currentName) => {
        setEditingStage(stageId);
        setEditingStageName(currentName);
      };

      const saveStageEdit = (stageId) => {
        if (editingStageName.trim() && onRenameStage) {
          onRenameStage(stageId, editingStageName.trim());
        }
        setEditingStage(null);
        setEditingStageName('');
      };

      const startEditingStep = (stepId, currentName) => {
        setEditingStepId(stepId);
        setEditingStepName(currentName);
      };

      const saveStepEdit = (stageId, stepId) => {
        if (editingStepName.trim() && onRenameStep) {
          onRenameStep(stageId, stepId, editingStepName.trim());
        }
        setEditingStepId(null);
        setEditingStepName('');
      };

      return (
        <div style={{
          position: 'fixed',
          inset: 0,
          background: 'rgba(0,0,0,0.5)',
          display: 'flex',
          alignItems: 'center',
          justifyContent: 'center',
          zIndex: 1000
        }} onClick={onClose}>
          <div style={{
            background: '#FFF',
            borderRadius: '12px',
            width: '600px',
            maxWidth: '95vw',
            maxHeight: '85vh',
            display: 'flex',
            flexDirection: 'column',
            overflow: 'hidden'
          }} onClick={e => e.stopPropagation()}>
            {/* Header */}
            <div style={{ padding: '24px 32px', borderBottom: '1px solid #E4E7EB', display: 'flex', justifyContent: 'space-between', alignItems: 'center' }}>
              <div>
                <h3 style={{ margin: 0, fontSize: '20px', fontWeight: 600 }}>Structure Configuration</h3>
                <p style={{ margin: '4px 0 0', fontSize: '13px', color: '#556275' }}>Add, remove, and reorder stages and steps</p>
              </div>
              <button onClick={onClose} style={{ background: 'none', border: 'none', fontSize: '24px', cursor: 'pointer', color: '#8A95A5' }}>×</button>
            </div>

            {/* Content */}
            <div style={{ flex: 1, overflow: 'auto', padding: '24px 32px' }}>
              {/* Add Stage at Start */}
              {addingStageAfter === -1 ? (
                <div style={{ display: 'flex', gap: '8px', marginBottom: '16px', padding: '12px', background: '#E1EEF2', borderRadius: '8px', border: '2px solid #2D8A6E' }}>
                  <input
                    type="text"
                    value={newStageName}
                    onChange={(e) => setNewStageName(e.target.value)}
                    placeholder="New stage name..."
                    autoFocus
                    style={{ flex: 1, padding: '8px 12px', border: '1px solid #C8CED6', borderRadius: '6px', fontSize: '14px' }}
                    onKeyDown={(e) => e.key === 'Enter' && handleAddStage()}
                  />
                  <button onClick={handleAddStage} style={{ padding: '8px 16px', background: '#2D8A6E', color: '#FFF', border: 'none', borderRadius: '6px', cursor: 'pointer', fontWeight: 500 }}>Add</button>
                  <button onClick={() => { setAddingStageAfter(null); setNewStageName(''); }} style={{ padding: '8px 12px', background: '#F4F5F7', border: 'none', borderRadius: '6px', cursor: 'pointer' }}>Cancel</button>
                </div>
              ) : (
                <button 
                  onClick={() => setAddingStageAfter(-1)}
                  style={{ display: 'flex', alignItems: 'center', gap: '8px', padding: '10px 16px', background: '#F4F5F7', border: '2px dashed #D1D5DB', borderRadius: '8px', cursor: 'pointer', marginBottom: '16px', color: '#6E7B8C', fontSize: '14px', width: '100%', justifyContent: 'center' }}
                >
                  <span style={{ fontSize: '18px' }}>+</span> Add Stage at Start
                </button>
              )}

              {/* Stages List */}
              {config.stages.map((stage, stageIndex) => (
                <div key={stage.id} style={{ marginBottom: '12px' }}>
                  {/* Stage Row */}
                  <div style={{ 
                    display: 'flex', 
                    alignItems: 'center', 
                    gap: '8px', 
                    padding: '12px 16px', 
                    background: getStageColor(stageIndex), 
                    borderRadius: expandedStages.includes(stage.id) ? '8px 8px 0 0' : '8px',
                    color: '#FFF'
                  }}>
                    <button 
                      onClick={() => toggleExpand(stage.id)}
                      style={{ background: 'none', border: 'none', color: '#FFF', cursor: 'pointer', fontSize: '12px', padding: '4px' }}
                    >
                      {expandedStages.includes(stage.id) ? '▼' : '▶'}
                    </button>
                    {editingStage === stage.id ? (
                      <input
                        type="text"
                        value={editingStageName}
                        onChange={(e) => setEditingStageName(e.target.value)}
                        onBlur={() => saveStageEdit(stage.id)}
                        onKeyDown={(e) => {
                          if (e.key === 'Enter') saveStageEdit(stage.id);
                          if (e.key === 'Escape') { setEditingStage(null); setEditingStageName(''); }
                        }}
                        autoFocus
                        style={{
                          flex: 1,
                          background: 'rgba(255,255,255,0.2)',
                          border: '1px solid rgba(255,255,255,0.4)',
                          borderRadius: '4px',
                          padding: '4px 8px',
                          color: '#FFF',
                          fontSize: '14px',
                          fontWeight: 500,
                          fontFamily: "'Interstate', sans-serif"
                        }}
                      />
                    ) : (
                      <span 
                        style={{ 
                          fontWeight: 500, 
                          flex: 1, 
                          cursor: 'pointer',
                          padding: '4px 8px',
                          borderRadius: '4px',
                          transition: 'background 0.15s'
                        }}
                        onClick={() => startEditingStage(stage.id, stage.name)}
                        onMouseEnter={(e) => e.currentTarget.style.background = 'rgba(255,255,255,0.15)'}
                        onMouseLeave={(e) => e.currentTarget.style.background = 'transparent'}
                        title="Click to rename stage"
                      >
                        Stage {stageIndex + 1}: {stage.name}
                      </span>
                    )}
                    <span style={{ fontSize: '12px', opacity: 0.8 }}>{stage.steps.length} steps</span>
                    <div style={{ display: 'flex', gap: '4px' }}>
                      <button 
                        onClick={() => onMoveStage(stage.id, 'up')} 
                        disabled={stageIndex === 0}
                        style={{ padding: '4px 8px', background: 'rgba(255,255,255,0.2)', border: 'none', borderRadius: '4px', cursor: stageIndex === 0 ? 'not-allowed' : 'pointer', color: '#FFF', opacity: stageIndex === 0 ? 0.3 : 1 }}
                      >↑</button>
                      <button 
                        onClick={() => onMoveStage(stage.id, 'down')} 
                        disabled={stageIndex === config.stages.length - 1}
                        style={{ padding: '4px 8px', background: 'rgba(255,255,255,0.2)', border: 'none', borderRadius: '4px', cursor: stageIndex === config.stages.length - 1 ? 'not-allowed' : 'pointer', color: '#FFF', opacity: stageIndex === config.stages.length - 1 ? 0.3 : 1 }}
                      >↓</button>
                      <button 
                        onClick={() => onRemoveStage(stage.id)}
                        style={{ padding: '4px 8px', background: 'rgba(255,255,255,0.2)', border: 'none', borderRadius: '4px', cursor: 'pointer', color: '#FFF' }}
                      >🗑</button>
                    </div>
                  </div>

                  {/* Steps within Stage */}
                  {expandedStages.includes(stage.id) && (
                    <div style={{ background: '#F4F5F7', borderRadius: '0 0 8px 8px', padding: '8px', borderLeft: `3px solid ${getStageColor(stageIndex)}` }}>
                      {/* Add Step at Start of Stage */}
                      {addingStepIn?.stageId === stage.id && addingStepIn?.afterIndex === -1 ? (
                        <div style={{ display: 'flex', gap: '8px', marginBottom: '8px', padding: '8px', background: '#FFF', borderRadius: '6px', border: '2px solid #2D8A6E' }}>
                          <input
                            type="text"
                            value={newStepName}
                            onChange={(e) => setNewStepName(e.target.value)}
                            placeholder="New step name..."
                            autoFocus
                            style={{ flex: 1, padding: '6px 10px', border: '1px solid #C8CED6', borderRadius: '4px', fontSize: '13px' }}
                            onKeyDown={(e) => e.key === 'Enter' && handleAddStep()}
                          />
                          <button onClick={handleAddStep} style={{ padding: '6px 12px', background: '#2D8A6E', color: '#FFF', border: 'none', borderRadius: '4px', cursor: 'pointer', fontSize: '12px' }}>Add</button>
                          <button onClick={() => { setAddingStepIn(null); setNewStepName(''); }} style={{ padding: '6px 8px', background: '#F4F5F7', border: 'none', borderRadius: '4px', cursor: 'pointer', fontSize: '12px' }}>×</button>
                        </div>
                      ) : (
                        <button 
                          onClick={() => setAddingStepIn({ stageId: stage.id, afterIndex: -1 })}
                          style={{ display: 'flex', alignItems: 'center', gap: '6px', padding: '6px 12px', background: '#FFF', border: '1px dashed #D1D5DB', borderRadius: '6px', cursor: 'pointer', marginBottom: '8px', color: '#6E7B8C', fontSize: '12px', width: '100%', justifyContent: 'center' }}
                        >
                          <span>+</span> Add Step at Start
                        </button>
                      )}

                      {stage.steps.map((step, stepIndex) => (
                        <React.Fragment key={step.id}>
                          <div style={{ 
                            display: 'flex', 
                            alignItems: 'center', 
                            gap: '8px', 
                            padding: '10px 12px', 
                            background: step.isHardCheckpoint ? '#F5E0E3' : '#FFF', 
                            borderRadius: '6px',
                            marginBottom: '4px',
                            border: step.isHardCheckpoint ? '1px solid #F5E0E3' : '1px solid #E4E7EB'
                          }}>
                            <span style={{ color: '#8A95A5', fontSize: '12px', minWidth: '36px' }}>{stageIndex + 1}.{stepIndex + 1}</span>
                            {step.isHardCheckpoint && <span style={{ fontSize: '12px' }}>🚧</span>}
                            {editingStepId === step.id ? (
                              <input
                                type="text"
                                value={editingStepName}
                                onChange={(e) => setEditingStepName(e.target.value)}
                                onBlur={() => saveStepEdit(stage.id, step.id)}
                                onKeyDown={(e) => {
                                  if (e.key === 'Enter') saveStepEdit(stage.id, step.id);
                                  if (e.key === 'Escape') { setEditingStepId(null); setEditingStepName(''); }
                                }}
                                autoFocus
                                style={{
                                  flex: 1,
                                  background: '#FFF',
                                  border: '1px solid #5B8A9A',
                                  borderRadius: '4px',
                                  padding: '4px 8px',
                                  fontSize: '14px',
                                  color: step.isHardCheckpoint ? '#B84A5A' : '#3D4A5C',
                                  fontFamily: "'Interstate', sans-serif"
                                }}
                              />
                            ) : (
                              <span 
                                style={{ 
                                  flex: 1, 
                                  fontSize: '14px', 
                                  color: step.isHardCheckpoint ? '#B84A5A' : '#3D4A5C',
                                  cursor: 'pointer',
                                  padding: '4px 8px',
                                  borderRadius: '4px',
                                  transition: 'background 0.15s'
                                }}
                                onClick={() => startEditingStep(step.id, step.name)}
                                onMouseEnter={(e) => e.currentTarget.style.background = '#E9EEF4'}
                                onMouseLeave={(e) => e.currentTarget.style.background = 'transparent'}
                                title="Click to rename step"
                              >
                                {step.name}
                              </span>
                            )}
                            <div style={{ display: 'flex', gap: '4px' }}>
                              <button 
                                onClick={() => onMoveStep(stage.id, step.id, 'up')} 
                                disabled={stepIndex === 0}
                                style={{ padding: '4px 8px', background: '#F4F5F7', border: 'none', borderRadius: '4px', cursor: stepIndex === 0 ? 'not-allowed' : 'pointer', fontSize: '12px', opacity: stepIndex === 0 ? 0.3 : 1 }}
                              >↑</button>
                              <button 
                                onClick={() => onMoveStep(stage.id, step.id, 'down')} 
                                disabled={stepIndex === stage.steps.length - 1}
                                style={{ padding: '4px 8px', background: '#F4F5F7', border: 'none', borderRadius: '4px', cursor: stepIndex === stage.steps.length - 1 ? 'not-allowed' : 'pointer', fontSize: '12px', opacity: stepIndex === stage.steps.length - 1 ? 0.3 : 1 }}
                              >↓</button>
                              <button 
                                onClick={() => onRemoveStep(stage.id, step.id)}
                                style={{ padding: '4px 8px', background: '#F5E0E3', border: 'none', borderRadius: '4px', cursor: 'pointer', fontSize: '12px' }}
                              >🗑</button>
                            </div>
                          </div>
                          
                          {/* Add Step After This One */}
                          {addingStepIn?.stageId === stage.id && addingStepIn?.afterIndex === stepIndex ? (
                            <div style={{ display: 'flex', gap: '8px', marginBottom: '8px', padding: '8px', background: '#FFF', borderRadius: '6px', border: '2px solid #2D8A6E', marginLeft: '36px' }}>
                              <input
                                type="text"
                                value={newStepName}
                                onChange={(e) => setNewStepName(e.target.value)}
                                placeholder="New step name..."
                                autoFocus
                                style={{ flex: 1, padding: '6px 10px', border: '1px solid #C8CED6', borderRadius: '4px', fontSize: '13px' }}
                                onKeyDown={(e) => e.key === 'Enter' && handleAddStep()}
                              />
                              <button onClick={handleAddStep} style={{ padding: '6px 12px', background: '#2D8A6E', color: '#FFF', border: 'none', borderRadius: '4px', cursor: 'pointer', fontSize: '12px' }}>Add</button>
                              <button onClick={() => { setAddingStepIn(null); setNewStepName(''); }} style={{ padding: '6px 8px', background: '#F4F5F7', border: 'none', borderRadius: '4px', cursor: 'pointer', fontSize: '12px' }}>×</button>
                            </div>
                          ) : (
                            <button 
                              onClick={() => setAddingStepIn({ stageId: stage.id, afterIndex: stepIndex })}
                              style={{ display: 'block', padding: '4px', background: 'transparent', border: 'none', cursor: 'pointer', color: '#2D8A6E', fontSize: '16px', marginLeft: '36px', marginBottom: '4px', opacity: 0.5 }}
                              onMouseOver={(e) => e.currentTarget.style.opacity = 1}
                              onMouseOut={(e) => e.currentTarget.style.opacity = 0.5}
                              title="Add step here"
                            >+</button>
                          )}
                        </React.Fragment>
                      ))}

                      {stage.steps.length === 0 && (
                        <p style={{ color: '#8A95A5', fontSize: '13px', fontStyle: 'italic', textAlign: 'center', padding: '12px' }}>No steps yet</p>
                      )}
                    </div>
                  )}

                  {/* Add Stage After This One */}
                  {addingStageAfter === stageIndex ? (
                    <div style={{ display: 'flex', gap: '8px', marginTop: '8px', padding: '12px', background: '#E1EEF2', borderRadius: '8px', border: '2px solid #2D8A6E' }}>
                      <input
                        type="text"
                        value={newStageName}
                        onChange={(e) => setNewStageName(e.target.value)}
                        placeholder="New stage name..."
                        autoFocus
                        style={{ flex: 1, padding: '8px 12px', border: '1px solid #C8CED6', borderRadius: '6px', fontSize: '14px' }}
                        onKeyDown={(e) => e.key === 'Enter' && handleAddStage()}
                      />
                      <button onClick={handleAddStage} style={{ padding: '8px 16px', background: '#2D8A6E', color: '#FFF', border: 'none', borderRadius: '6px', cursor: 'pointer', fontWeight: 500 }}>Add</button>
                      <button onClick={() => { setAddingStageAfter(null); setNewStageName(''); }} style={{ padding: '8px 12px', background: '#F4F5F7', border: 'none', borderRadius: '6px', cursor: 'pointer' }}>Cancel</button>
                    </div>
                  ) : (
                    <button 
                      onClick={() => setAddingStageAfter(stageIndex)}
                      style={{ display: 'block', margin: '8px auto', padding: '4px 12px', background: 'transparent', border: 'none', cursor: 'pointer', color: '#2D8A6E', fontSize: '12px', opacity: 0.5 }}
                      onMouseOver={(e) => e.currentTarget.style.opacity = 1}
                      onMouseOut={(e) => e.currentTarget.style.opacity = 0.5}
                    >
                      + Add Stage Here
                    </button>
                  )}
                </div>
              ))}

              {config.stages.length === 0 && (
                <p style={{ color: '#8A95A5', fontSize: '14px', fontStyle: 'italic', textAlign: 'center', padding: '24px' }}>No stages yet. Add your first stage above.</p>
              )}
            </div>

            {/* Footer */}
            <div style={{ padding: '16px 32px', borderTop: '1px solid #E4E7EB', display: 'flex', justifyContent: 'flex-end' }}>
              <button onClick={onClose} style={{ padding: '10px 24px', background: '#2D8A6E', color: '#FFF', border: 'none', borderRadius: '6px', cursor: 'pointer', fontWeight: 500 }}>Done</button>
            </div>
          </div>
        </div>
      );
    }

    function JourneyMap() {
      // Read URL parameters
      const urlParams = new URLSearchParams(window.location.search);
      const mapId = urlParams.get('id'); // Supabase UUID
      const legacyMapId = urlParams.get('map'); // Legacy GitHub mode
      const mapTitle = urlParams.get('title') || 'Journey Map';
      const isSupabaseMode = !!mapId;
      const isMultiUserMode = !!legacyMapId; // Legacy
      
      // For Supabase mode, no GitHub URL needed
      // For legacy multi-user mode, use GitHub
      const PUBLIC_CONFIG_URL = isMultiUserMode 
        ? `https://raw.githubusercontent.com/steveyoung74/journeymaps/main/maps/${legacyMapId}.json`
        : 'https://raw.githubusercontent.com/steveyoung74/journeymaps/main/onboarding/journey-map.json';
      
      // Use map-specific localStorage key
      const STORAGE_KEY = isSupabaseMode 
        ? `journeymap-config-${mapId}` 
        : (isMultiUserMode ? `journeymap-config-${legacyMapId}` : 'journeymap-config');
      
      // Normalize config to handle different field names from templates vs editor
      const normalizeConfig = (data) => {
        if (!data) return defaultConfig;
        
        // Ensure meta exists
        if (!data.meta) {
          data.meta = { title: mapTitle || 'Journey Map', version: '1.0' };
        }
        
        // Backward compatibility: migrate 'per-journey' to 'client'
        if (data.meta.costModel === 'per-journey') {
          data.meta.costModel = 'client';
        }
        
        // Default to 'client' if no costModel specified
        if (!data.meta.costModel) {
          data.meta.costModel = 'client';
        }
        
        // Ensure funnel object exists
        if (!data.funnel) {
          data.funnel = { enabled: true, initialVolume: 1000, periodLabel: 'per quarter' };
        }
        
        // Ensure stages array exists
        if (!data.stages) {
          data.stages = [];
        }
        
        // Normalize stages
        data.stages = data.stages.map(stage => ({
          ...stage,
          dropOffCount: stage.dropOffCount || stage.dropOff || 0,
          steps: (stage.steps || []).map(step => ({
            ...step,
            // Convert duration to timeMinutes if needed
            timeMinutes: step.timeMinutes ?? step.duration ?? step.time ?? 0,
            // Ensure friction exists
            friction: step.friction || 'none',
            frictionScore: step.frictionScore ?? (step.friction === 'high' ? 5 : step.friction === 'medium' ? 3 : 1),
            // Ensure notes exists
            notes: step.notes || '',
            painPoints: step.painPoints || [],
            // Map persona field
            persona: step.persona || null
          }))
        }));
        
        // Ensure personas array exists
        if (!data.personas) {
          data.personas = [];
        }
        
        // Normalize personas
        data.personas = data.personas.map(persona => ({
          ...persona,
          burdenMultiplier: persona.burdenMultiplier || (persona.isExternal ? undefined : 1.35),
          workspaceHourlyCost: persona.workspaceHourlyCost || (persona.isExternal ? undefined : 6.00)
        }));
        
        return data;
      };
      
      const [config, setConfig] = useState(() => {
        // In Supabase mode or multi-user mode, start with default config and load in useEffect
        if (isSupabaseMode || isMultiUserMode) {
          console.log('📄 Will load from ' + (isSupabaseMode ? 'Supabase' : 'GitHub') + '...');
          return defaultConfig;
        }
        
        // Legacy mode: try localStorage first
        const saved = localStorage.getItem(STORAGE_KEY);
        if (saved) {
          try {
            const parsed = JSON.parse(saved);
            console.log('📂 Loaded config from localStorage');
            return normalizeConfig(parsed);
          } catch (e) {
            console.warn('Failed to parse saved config, using default');
          }
        }
        // Return default for now - will try GitHub in useEffect
        console.log('📄 No localStorage data, will try GitHub...');
        return defaultConfig;
      });
      
      const [configLoading, setConfigLoading] = useState(() => {
        // In Supabase or multi-user mode, always show loading to fetch data
        // For legacy mode, only show loading if no localStorage data
        return isSupabaseMode || isMultiUserMode || !localStorage.getItem(STORAGE_KEY);
      });
      
      // Scroll to top on mount to fix iOS/iPad viewport issues
      React.useEffect(() => {
        window.scrollTo(0, 0);
      }, []);
      
      // Load config - Supabase for new maps, GitHub for legacy
      React.useEffect(() => {
        const loadConfig = async () => {
          // SUPABASE MODE - load from Supabase
          if (isSupabaseMode && supabase) {
            console.log('🌐 Fetching config from Supabase...');
            try {
              const { data, error } = await supabase
                .from('journey_maps')
                .select('*')
                .eq('id', mapId)
                .single();
              
              if (error) throw error;
              
              if (data && data.config) {
                console.log('✅ Loaded config from Supabase');
                // Update title in URL params display
                document.title = `${data.title || 'Journey Map'} - FATHOM`;
                
                // Store map creator for settings access check
                if (data.created_by) {
                  setMapCreatedBy(data.created_by);
                  console.log('📝 Map created by:', data.created_by);
                }
                
                const normalized = normalizeConfig(data.config);
                setConfig(normalized);
                localStorage.setItem(STORAGE_KEY, JSON.stringify(normalized));
              } else {
                console.warn('⚠️ Map not found in Supabase');
              }
            } catch (err) {
              console.error('⚠️ Supabase fetch failed:', err.message);
              // Try localStorage as fallback
              const saved = localStorage.getItem(STORAGE_KEY);
              if (saved) {
                try {
                  const parsed = JSON.parse(saved);
                  console.log('⚠️ Using localStorage fallback');
                  setConfig(normalizeConfig(parsed));
                } catch (e) {
                  console.warn('⚠️ localStorage invalid');
                }
              }
            }
            setConfigLoading(false);
            return;
          }
          
          // LEGACY MODE - load from GitHub or localStorage
          // For legacy mode with localStorage data, skip GitHub fetch
          if (!isMultiUserMode && localStorage.getItem(STORAGE_KEY)) {
            setConfigLoading(false);
            return;
          }
          
          console.log('🌐 Fetching config from GitHub...');
          try {
            const response = await fetch(PUBLIC_CONFIG_URL + '?t=' + Date.now()); // Cache bust
            if (response.ok) {
              const data = await response.json();
              console.log('✅ Loaded config from GitHub');
              
              const normalized = normalizeConfig(data);
              setConfig(normalized);
              localStorage.setItem(STORAGE_KEY, JSON.stringify(normalized));
            } else {
              // GitHub fetch failed - try localStorage as fallback for multi-user mode
              if (isMultiUserMode) {
                const saved = localStorage.getItem(STORAGE_KEY);
                if (saved) {
                  try {
                    const parsed = JSON.parse(saved);
                    console.log('⚠️ GitHub unavailable, using localStorage fallback');
                    setConfig(normalizeConfig(parsed));
                  } catch (e) {
                    console.warn('⚠️ localStorage also invalid, using default');
                  }
                }
              }
              console.warn('⚠️ Could not load from GitHub');
            }
          } catch (err) {
            console.warn('⚠️ GitHub fetch failed:', err.message);
            // Try localStorage as fallback
            if (isMultiUserMode) {
              const saved = localStorage.getItem(STORAGE_KEY);
              if (saved) {
                try {
                  const parsed = JSON.parse(saved);
                  console.log('⚠️ Using localStorage fallback');
                  setConfig(normalizeConfig(parsed));
                } catch (e) {
                  console.warn('⚠️ localStorage invalid');
                }
              }
            }
          }
          setConfigLoading(false);
        };
        
        loadConfig();
      }, []);
      
      // Update document title in multi-user mode (Supabase title is set in loadConfig)
      React.useEffect(() => {
        if (isMultiUserMode && !isSupabaseMode) {
          document.title = `${mapTitle} - FATHOM`;
        }
      }, [isMultiUserMode, isSupabaseMode, mapTitle]);
      
      const [selectedStep, setSelectedStep] = useState(null);
      const [editingStep, setEditingStep] = useState(null);
      const [editingTitle, setEditingTitle] = useState(false);
      const [activePerspective, setActivePerspective] = useState('all');
      const [showJson, setShowJson] = useState(false);
      const [editMode, setEditMode] = useState(false);
      const [preEditState, setPreEditState] = useState(null);
      const [showAddStage, setShowAddStage] = useState(false);
      const [addStepTo, setAddStepTo] = useState(null);
      const [showTimeline, setShowTimeline] = useState(false);
      const [showSalarySettings, setShowSalarySettings] = useState(false);
      const [showCostAnalysis, setShowCostAnalysis] = useState(false);
      const [showFunnel, setShowFunnel] = useState(false);
      const [showFunnelDashboard, setShowFunnelDashboard] = useState(false);
      const [showFunnelSettings, setShowFunnelSettings] = useState(false);
      const [showDashboard, setShowDashboard] = useState(false);
      const [dashboardTab, setDashboardTab] = useState('time'); // 'time', 'costs', 'funnel'
      const [highlightOpportunities, setHighlightOpportunities] = useState(false);
      const [viewMode, setViewMode] = useState('stages'); // 'steps' or 'stages';
      const [showSettingsMenu, setShowSettingsMenu] = useState(false);
      const [showStructurePanel, setShowStructurePanel] = useState(false);
      const [showGitHubSettings, setShowGitHubSettings] = useState(false);
      const [showPasswordPrompt, setShowPasswordPrompt] = useState(false);
      const [showShareModal, setShowShareModal] = useState(false);
      const [showJourneySettings, setShowJourneySettings] = useState(false);
      const [showProfileMenu, setShowProfileMenu] = useState(false);
      const [showSurveyRequestModal, setShowSurveyRequestModal] = useState(null); // { stepId, personaId }
      const [shares, setShares] = useState([]);
      const [isMobile, setIsMobile] = useState(() => window.innerWidth < 768);
      const [isCompact, setIsCompact] = useState(() => window.innerWidth < 1024 && window.innerWidth >= 768);
      const [showCosts, setShowCosts] = useState(true);
      
      // Auth state for role-based settings access
      const [currentUser, setCurrentUser] = useState(null);
      const [userProfile, setUserProfile] = useState(null);
      const [userRole, setUserRole] = useState(null);
      const [mapCreatedBy, setMapCreatedBy] = useState(null);
      const [mapPermission, setMapPermission] = useState(null); // 'owner', 'edit', 'view', or null
      const [authChecked, setAuthChecked] = useState(false);
      const [mapOrgId, setMapOrgId] = useState(null);
      
      // Can user edit this map?
      const canEdit = useMemo(() => {
        // In legacy (non-Supabase) mode, always allow edit
        if (!isSupabaseMode) return true;
        
        // If no user logged in, no edit
        if (!currentUser) return false;
        
        // Map owner can always edit
        if (mapPermission === 'owner') return true;
        
        // Explicit edit permission
        if (mapPermission === 'edit') return true;
        
        // Owner and admin roles can edit any map in their org
        if ((userRole === 'owner' || userRole === 'admin') && mapOrgId) return true;
        
        return false;
      }, [isSupabaseMode, currentUser, mapPermission, userRole, mapOrgId]);
      
      // Settings access: owner/admin can always access, creator can access their own maps
      const canAccessSettings = useMemo(() => {
        // In legacy (non-Supabase) mode, always allow access
        if (!isSupabaseMode) return true;
        
        // If no user logged in, no access
        if (!currentUser) return false;
        
        // Owner and admin roles always have access
        if (userRole === 'owner' || userRole === 'admin') return true;
        
        // Creator of this specific map has access
        if (mapCreatedBy && currentUser.id === mapCreatedBy) return true;
        
        // Users with edit permission can access settings
        if (mapPermission === 'edit' || mapPermission === 'owner') return true;
        
        // Viewers don't have settings access
        return false;
      }, [isSupabaseMode, currentUser, userRole, mapCreatedBy, mapPermission]);
      
      // Legacy password state (kept for non-Supabase mode compatibility)
      const [passwords, setPasswords] = useState(null);
      const [isSettingsUnlocked, setIsSettingsUnlocked] = useState(() => {
        return localStorage.getItem('journeymap-settings-unlocked') === 'true';
      });
      
      // Fetch user auth, role, and map permissions in Supabase mode
      React.useEffect(() => {
        if (!isSupabaseMode || !supabase) {
          setAuthChecked(true);
          return;
        }
        
        const fetchUserAuth = async () => {
          try {
            const { data: { session } } = await supabase.auth.getSession();
            
            if (!session?.user) {
              console.log('⚠️ Editor: No authenticated user - redirecting to login');
              setAuthChecked(true);
              // Redirect to dashboard with return URL
              const returnUrl = encodeURIComponent(window.location.href);
              window.location.href = `dashboard.html?login=required&return=${returnUrl}`;
              return;
            }
            
            setCurrentUser(session.user);
            console.log('✅ Editor: User authenticated:', session.user.id);
            
            // Fetch user's role and org from profile
            const { data: profile } = await supabase
              .from('users')
              .select('role, organisation_id, display_name, avatar_url')
              .eq('id', session.user.id)
              .single();
            
            if (profile) {
              setUserRole(profile.role);
              setUserProfile(profile);
              console.log('✅ Editor: User role:', profile.role);
              
              // Now check permission for this specific map
              // First, get the map details
              const { data: mapData, error: mapError } = await supabase
                .from('journey_maps')
                .select('created_by, organisation_id')
                .eq('id', mapId)
                .single();
              
              if (mapError) {
                console.error('Failed to fetch map details:', mapError);
                setAuthChecked(true);
                return;
              }
              
              setMapOrgId(mapData.organisation_id);
              
              // Check if user is the creator
              if (mapData.created_by === session.user.id) {
                setMapPermission('owner');
                console.log('✅ Editor: User is map creator (owner)');
                setAuthChecked(true);
                return;
              }
              
              // Check if user is in the same organisation
              if (mapData.organisation_id === profile.organisation_id) {
                // Same org - permission based on role
                if (profile.role === 'owner' || profile.role === 'admin') {
                  setMapPermission('owner');
                  console.log('✅ Editor: User is org owner/admin');
                } else if (profile.role === 'member') {
                  setMapPermission('edit');
                  console.log('✅ Editor: User is org member (can edit)');
                } else {
                  setMapPermission('view');
                  console.log('✅ Editor: User is org viewer');
                }
                setAuthChecked(true);
                return;
              }
              
              // Not in same org - check for explicit share
              const { data: shareData } = await supabase
                .from('journey_map_shares')
                .select('permission')
                .eq('journey_map_id', mapId)
                .eq('shared_with_user_id', session.user.id)
                .single();
              
              if (shareData) {
                setMapPermission(shareData.permission);
                console.log('✅ Editor: User has shared permission:', shareData.permission);
              } else {
                // No share found - check by email
                const { data: emailShare } = await supabase
                  .from('journey_map_shares')
                  .select('permission')
                  .eq('journey_map_id', mapId)
                  .eq('shared_with_email', session.user.email.toLowerCase())
                  .single();
                
                if (emailShare) {
                  setMapPermission(emailShare.permission);
                  console.log('✅ Editor: User has email share:', emailShare.permission);
                  
                  // Update the share record with the user ID
                  await supabase
                    .from('journey_map_shares')
                    .update({ shared_with_user_id: session.user.id })
                    .eq('journey_map_id', mapId)
                    .eq('shared_with_email', session.user.email.toLowerCase());
                } else {
                  console.log('⚠️ Editor: User has no access to this map');
                  setMapPermission(null);
                  // Optionally redirect or show error
                }
              }
            }
            
            setAuthChecked(true);
          } catch (err) {
            console.error('Auth check failed:', err);
            setAuthChecked(true);
          }
        };
        
        fetchUserAuth();
      }, [isSupabaseMode]);
      
      // Fetch passwords from GitHub on mount (for legacy settings protection only)
      React.useEffect(() => {
        // Skip password fetch in Supabase mode - we use role-based access
        if (isSupabaseMode) return;
        
        const fetchPasswords = async () => {
          try {
            // Decode resource location
            const _0x = 'u92cq5yckJ3b3N3chB3LnlmZu92YvcmbpRmch9mYu92LulWYt9ycwFWb5VmbyV3bq9CN3cmb19WelZXZ0N3Lt92YuQnblRnbvNmclNXdiVHa0l2ZucXYy9yL6MHc0RHa';
            const _l = atob(_0x.split('').reverse().join(''));
            const response = await fetch(_l);
            if (response.ok) {
              const data = await response.json();
              setPasswords(data);
            }
          } catch (error) {
            console.error('Failed to load configuration:', error);
          }
        };
        fetchPasswords();
      }, [isSupabaseMode]);
      
      // Mobile detection effect
      React.useEffect(() => {
        const handleResize = () => {
          const width = window.innerWidth;
          setIsMobile(width < 768);
          setIsCompact(width < 1024 && width >= 768);
        };
        window.addEventListener('resize', handleResize);
        return () => window.removeEventListener('resize', handleResize);
      }, []);
      
      // Persist showCosts to localStorage
      React.useEffect(() => {
        localStorage.setItem('journeymap-show-costs', showCosts.toString());
        // If costs are hidden, also hide related views
        if (!showCosts) {
          setShowCostAnalysis(false);
          setHighlightOpportunities(false);
        }
      }, [showCosts]);
      
      const [gitHubConfig, setGitHubConfig] = useState(() => {
        // In multi-user mode, use token from dashboard and map-specific path
        if (isMultiUserMode) {
          const dashboardToken = localStorage.getItem('journeymap-github-token') || '';
          return {
            owner: 'steveyoung74',
            repo: 'journeymaps',
            path: `maps/${mapId}.json`,
            branch: 'main',
            token: dashboardToken
          };
        }
        // Legacy mode - use the old config storage
        const saved = localStorage.getItem('journeymap-github-config');
        return saved ? JSON.parse(saved) : {
          owner: 'steveyoung74',
          repo: 'journeymaps',
          path: 'onboarding/journey-map.json',
          branch: 'main',
          token: ''
        };
      });
      const [gitHubStatus, setGitHubStatus] = useState({ loading: false, message: '', error: false });
      const [refreshStatus, setRefreshStatus] = useState({ loading: false, message: '' });

      // Save GitHub config to localStorage (only in legacy mode)
      useEffect(() => {
        if (!isMultiUserMode) {
          localStorage.setItem('journeymap-github-config', JSON.stringify(gitHubConfig));
        }
      }, [gitHubConfig]);

      // Save journey config to localStorage whenever it changes
      useEffect(() => {
        localStorage.setItem(STORAGE_KEY, JSON.stringify(config));
      }, [config]);

      // Auto-save to Supabase when config changes (debounced)
      const autoSaveTimerRef = useRef(null);
      useEffect(() => {
        if (!isSupabaseMode || !supabase || configLoading) return;
        
        // Don't auto-save if user doesn't have edit permission
        if (!canEdit) {
          console.log('⚠️ Auto-save skipped: read-only mode');
          return;
        }
        
        // Clear any pending save
        if (autoSaveTimerRef.current) {
          clearTimeout(autoSaveTimerRef.current);
        }
        
        // Debounce auto-save by 1 second
        autoSaveTimerRef.current = setTimeout(async () => {
          try {
            const { error } = await supabase
              .from('journey_maps')
              .update({ 
                config: config,
                title: config.meta?.title || 'Journey Map',
                updated_at: new Date().toISOString()
              })
              .eq('id', mapId);
            
            if (error) throw error;
            console.log('✅ Auto-saved to Supabase');
          } catch (error) {
            console.error('❌ Auto-save failed:', error);
          }
        }, 1000);
        
        return () => {
          if (autoSaveTimerRef.current) {
            clearTimeout(autoSaveTimerRef.current);
          }
        };
      }, [config, isSupabaseMode, mapId, configLoading, canEdit]);

      // Supabase save function
      const saveToSupabase = useCallback(async () => {
        if (!isSupabaseMode || !supabase) {
          console.warn('Not in Supabase mode or Supabase not initialized');
          return;
        }
        
        // Don't save if user doesn't have edit permission
        if (!canEdit) {
          console.warn('Cannot save: read-only mode');
          setGitHubStatus({ loading: false, message: 'View only - changes not saved', error: true });
          return;
        }
        
        setGitHubStatus({ loading: true, message: 'Saving...', error: false });
        
        try {
          const { data, error } = await supabase
            .from('journey_maps')
            .update({ 
              config: config,
              title: config.meta?.title || 'Journey Map',
              updated_at: new Date().toISOString()
            })
            .eq('id', mapId)
            .select();
          
          if (error) throw error;
          
          console.log('✅ Saved to Supabase');
          setGitHubStatus({ loading: false, message: '✓ Saved!', error: false });
          setTimeout(() => setGitHubStatus({ loading: false, message: '', error: false }), 3000);
        } catch (error) {
          console.error('❌ Supabase save failed:', error);
          setGitHubStatus({ loading: false, message: `Error: ${error.message}`, error: true });
        }
      }, [isSupabaseMode, mapId, config]);

      // Supabase load/refresh function
      const loadFromSupabase = useCallback(async () => {
        if (!isSupabaseMode || !supabase) return;
        
        setRefreshStatus({ loading: true, message: 'Refreshing...' });
        
        try {
          const { data, error } = await supabase
            .from('journey_maps')
            .select('*')
            .eq('id', mapId)
            .single();
          
          if (error) throw error;
          
          if (data && data.config) {
            const normalized = normalizeConfig(data.config);
            setConfig(normalized);
            localStorage.setItem(STORAGE_KEY, JSON.stringify(normalized));
            setRefreshStatus({ loading: false, message: '✓ Updated!' });
            setTimeout(() => setRefreshStatus({ loading: false, message: '' }), 2000);
          }
        } catch (error) {
          console.error('Supabase refresh failed:', error);
          setRefreshStatus({ loading: false, message: '✗ Failed' });
          setTimeout(() => setRefreshStatus({ loading: false, message: '' }), 3000);
        }
      }, [isSupabaseMode, mapId]);

      // GitHub functions
      const saveToGitHub = useCallback(async () => {
        if (!gitHubConfig.token) {
          setShowGitHubSettings(true);
          return;
        }
        
        setGitHubStatus({ loading: true, message: 'Saving to GitHub...', error: false });
        
        try {
          const { owner, repo, path, branch, token } = gitHubConfig;
          const apiUrl = `https://api.github.com/repos/${owner}/${repo}/contents/${path}`;
          
          // First, try to get existing file to get its SHA
          let sha = null;
          try {
            const getResponse = await fetch(apiUrl + `?ref=${branch}`, {
              headers: {
                'Authorization': `token ${token}`,
                'Accept': 'application/vnd.github.v3+json'
              }
            });
            if (getResponse.ok) {
              const data = await getResponse.json();
              sha = data.sha;
            }
          } catch (e) {
            // File doesn't exist yet, that's fine
          }
          
          // Save just the JSON config
          const jsonContent = JSON.stringify(config, null, 2);
          
          // Prepare content
          const content = btoa(unescape(encodeURIComponent(jsonContent)));
          const commitMessage = `Update ${config.meta.title} - ${new Date().toLocaleString()}`;
          
          // Create or update file
          const response = await fetch(apiUrl, {
            method: 'PUT',
            headers: {
              'Authorization': `token ${token}`,
              'Accept': 'application/vnd.github.v3+json',
              'Content-Type': 'application/json'
            },
            body: JSON.stringify({
              message: commitMessage,
              content: content,
              branch: branch,
              ...(sha && { sha })
            })
          });
          
          if (!response.ok) {
            const error = await response.json();
            // If SHA mismatch, it might be a new file - retry without SHA
            if (error.message && error.message.includes('does not match') && sha) {
              console.log('SHA mismatch, retrying without SHA for new file creation...');
              const retryResponse = await fetch(apiUrl, {
                method: 'PUT',
                headers: {
                  'Authorization': `token ${token}`,
                  'Accept': 'application/vnd.github.v3+json',
                  'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                  message: commitMessage,
                  content: content,
                  branch: branch
                })
              });
              if (!retryResponse.ok) {
                const retryError = await retryResponse.json();
                throw new Error(retryError.message || 'Failed to save');
              }
            } else {
              throw new Error(error.message || 'Failed to save');
            }
          }
          
          setGitHubStatus({ loading: false, message: '✓ Saved to GitHub!', error: false });
          setTimeout(() => setGitHubStatus({ loading: false, message: '', error: false }), 3000);
        } catch (error) {
          setGitHubStatus({ loading: false, message: `Error: ${error.message}`, error: true });
        }
      }, [gitHubConfig, config]);

      const loadFromGitHub = useCallback(async () => {
        if (!gitHubConfig.token) {
          setShowGitHubSettings(true);
          return;
        }
        
        setGitHubStatus({ loading: true, message: 'Loading from GitHub...', error: false });
        
        try {
          const { owner, repo, path, branch, token } = gitHubConfig;
          const apiUrl = `https://api.github.com/repos/${owner}/${repo}/contents/${path}?ref=${branch}`;
          
          const response = await fetch(apiUrl, {
            headers: {
              'Authorization': `token ${token}`,
              'Accept': 'application/vnd.github.v3+json'
            }
          });
          
          if (!response.ok) {
            if (response.status === 404) {
              throw new Error('File not found. Save first to create it.');
            }
            const error = await response.json();
            throw new Error(error.message || 'Failed to load');
          }
          
          const data = await response.json();
          const content = decodeURIComponent(escape(atob(data.content)));
          
          // Parse JSON config
          const loadedConfig = JSON.parse(content);
          const normalized = normalizeConfig(loadedConfig);
          
          setConfig(normalized);
          
          setGitHubStatus({ loading: false, message: '✓ Loaded from GitHub!', error: false });
          setTimeout(() => setGitHubStatus({ loading: false, message: '', error: false }), 3000);
        } catch (error) {
          setGitHubStatus({ loading: false, message: `Error: ${error.message}`, error: true });
        }
      }, [gitHubConfig]);

      // Refresh from public GitHub (no auth required) or Supabase
      const refreshFromPublicGitHub = useCallback(async () => {
        // In Supabase mode, refresh from Supabase
        if (isSupabaseMode) {
          await loadFromSupabase();
          return;
        }
        
        setRefreshStatus({ loading: true, message: 'Refreshing...' });
        
        try {
          const response = await fetch(PUBLIC_CONFIG_URL + '?t=' + Date.now()); // Cache bust
          if (!response.ok) {
            throw new Error('Could not fetch latest data');
          }
          
          const data = await response.json();
          const normalized = normalizeConfig(data);
          
          setConfig(normalized);
          localStorage.setItem(STORAGE_KEY, JSON.stringify(normalized));
          
          setRefreshStatus({ loading: false, message: '✓ Updated!' });
          setTimeout(() => setRefreshStatus({ loading: false, message: '' }), 2000);
        } catch (error) {
          setRefreshStatus({ loading: false, message: '✗ Failed' });
          setTimeout(() => setRefreshStatus({ loading: false, message: '' }), 3000);
        }
      }, [isSupabaseMode, loadFromSupabase]);

      // Edit mode functions
      const enterEditMode = useCallback(() => {
        setPreEditState({
          config: JSON.parse(JSON.stringify(config)),
          showTimeline,
          showCostAnalysis,
          highlightOpportunities,
          viewMode
        });
        setShowTimeline(false);
        setShowCostAnalysis(false);
        setHighlightOpportunities(false);
        setViewMode('steps');
        setSelectedStep(null);
        setEditMode(true);
        setShowSettingsMenu(false);
      }, [config, showTimeline, showCostAnalysis, highlightOpportunities, viewMode]);

      const cancelEdit = useCallback(() => {
        if (preEditState) {
          setConfig(preEditState.config);
          setShowTimeline(preEditState.showTimeline);
          setShowCostAnalysis(preEditState.showCostAnalysis);
          setHighlightOpportunities(preEditState.highlightOpportunities);
          setViewMode(preEditState.viewMode);
        }
        setEditMode(false);
        setSelectedStep(null);
        setPreEditState(null);
      }, [preEditState]);

      const saveEdit = useCallback(() => {
        if (preEditState) {
          setShowTimeline(preEditState.showTimeline);
          setShowCostAnalysis(preEditState.showCostAnalysis);
          setHighlightOpportunities(preEditState.highlightOpportunities);
          setViewMode(preEditState.viewMode);
        }
        setConfig(prev => ({ ...prev, meta: { ...prev.meta, lastUpdated: new Date().toISOString() } }));
        setEditMode(false);
        setSelectedStep(null);
        setPreEditState(null);
        
        // Auto-save to Supabase or GitHub based on mode
        if (isSupabaseMode) {
          setTimeout(() => saveToSupabase(), 100);
        } else if (gitHubConfig.token) {
          setTimeout(() => saveToGitHub(), 100);
        }
      }, [preEditState, isSupabaseMode, gitHubConfig.token]);

      // Step-level edit handlers
      const startStepEdit = useCallback(() => {
        if (selectedStep && canEdit) {
          setEditingStep({ ...selectedStep });
        }
      }, [selectedStep, canEdit]);

      const cancelStepEdit = useCallback(() => {
        setEditingStep(null);
      }, []);

      const saveStepEdit = useCallback(() => {
        if (editingStep) {
          // Update the step in the config
          updateStep(editingStep.stageId, editingStep.id, editingStep);
          // Update the selected step display
          setSelectedStep(editingStep);
          // Close edit mode
          setEditingStep(null);
        }
      }, [editingStep]);

      // Close menus when clicking outside
      useEffect(() => {
        const handleClickOutside = () => {
          setShowSettingsMenu(false);
        };
        if (showSettingsMenu) {
          document.addEventListener('click', handleClickOutside);
          return () => document.removeEventListener('click', handleClickOutside);
        }
      }, [showSettingsMenu]);
      
      // Close profile menu when clicking outside
      useEffect(() => {
        const handleClickOutside = (e) => {
          if (showProfileMenu && !e.target.closest('.profile-container')) {
            setShowProfileMenu(false);
          }
        };
        document.addEventListener('click', handleClickOutside);
        return () => document.removeEventListener('click', handleClickOutside);
      }, [showProfileMenu]);
      
      // Helper to get user initials
      const getInitials = (name) => {
        if (!name) return '?';
        return name.split(' ').map(n => n[0]).join('').toUpperCase().slice(0, 2);
      };

      const totalTime = useMemo(() => 
        config.stages.reduce((acc, stage) => 
          acc + stage.steps.reduce((stepAcc, step) => stepAcc + step.timeMinutes, 0), 0
        ), [config.stages]
      );

      const formatTime = (minutes) => {
        const roundedMins = Math.round(minutes);
        if (roundedMins < 60) return `${roundedMins}m`;
        const hours = Math.floor(roundedMins / 60);
        const mins = roundedMins % 60;
        return mins > 0 ? `${hours}h ${mins}m` : `${hours}h`;
      };

      const getPersonaColor = (personaId) => {
        const persona = config.personas.find(p => p.id === personaId);
        return persona?.color || '#556275';
      };

      const updateStep = useCallback((stageId, stepId, updates) => {
        setConfig(prev => ({
          ...prev,
          stages: prev.stages.map(stage => 
            stage.id === stageId 
              ? {
                  ...stage,
                  steps: stage.steps.map(step =>
                    step.id === stepId ? { ...step, ...updates } : step
                  )
                }
              : stage
          )
        }));
      }, []);

      const updateStage = useCallback((stageId, updates) => {
        setConfig(prev => ({
          ...prev,
          stages: prev.stages.map(stage => 
            stage.id === stageId ? { ...stage, ...updates } : stage
          )
        }));
      }, []);

      const addStage = useCallback((name) => {
        const newStage = {
          id: generateId(),
          name,
          steps: []
        };
        setConfig(prev => ({
          ...prev,
          stages: [...prev.stages, newStage]
        }));
        setShowAddStage(false);
      }, []);

      const removeStage = useCallback((stageId) => {
        if (window.confirm('Are you sure you want to delete this stage and all its steps?')) {
          setConfig(prev => ({
            ...prev,
            stages: prev.stages.filter(s => s.id !== stageId)
          }));
        }
      }, []);

      const addStep = useCallback((stageId, stepData) => {
        const newStep = {
          id: generateId(),
          name: stepData.name,
          description: stepData.description || '',
          timeMinutes: stepData.timeMinutes || 30,
          owner: stepData.owner,
          touchpoints: [],
          painPoints: [],
          emotions: [],
          frictionScore: stepData.frictionScore || 3,
          automationOpportunity: stepData.automationOpportunity || 'medium',
          automationNotes: '',
          regulatoryRequirements: [],
          actions: {}
        };
        setConfig(prev => ({
          ...prev,
          stages: prev.stages.map(stage =>
            stage.id === stageId
              ? { ...stage, steps: [...stage.steps, newStep] }
              : stage
          )
        }));
        setAddStepTo(null);
      }, []);

      const removeStep = useCallback((stageId, stepId) => {
        if (window.confirm('Are you sure you want to delete this step?')) {
          setConfig(prev => ({
            ...prev,
            stages: prev.stages.map(stage =>
              stage.id === stageId
                ? { ...stage, steps: stage.steps.filter(s => s.id !== stepId) }
                : stage
            )
          }));
          if (selectedStep?.id === stepId) {
            setSelectedStep(null);
          }
        }
      }, [selectedStep]);

      // Structure manipulation functions
      const moveStage = useCallback((stageId, direction) => {
        setConfig(prev => {
          const stages = [...prev.stages];
          const index = stages.findIndex(s => s.id === stageId);
          if (index === -1) return prev;
          const newIndex = direction === 'up' ? index - 1 : index + 1;
          if (newIndex < 0 || newIndex >= stages.length) return prev;
          [stages[index], stages[newIndex]] = [stages[newIndex], stages[index]];
          return { ...prev, stages };
        });
      }, []);

      const moveStep = useCallback((stageId, stepId, direction) => {
        setConfig(prev => ({
          ...prev,
          stages: prev.stages.map(stage => {
            if (stage.id !== stageId) return stage;
            const steps = [...stage.steps];
            const index = steps.findIndex(s => s.id === stepId);
            if (index === -1) return stage;
            const newIndex = direction === 'up' ? index - 1 : index + 1;
            if (newIndex < 0 || newIndex >= steps.length) return stage;
            [steps[index], steps[newIndex]] = [steps[newIndex], steps[index]];
            return { ...stage, steps };
          })
        }));
      }, []);

      const insertStageAt = useCallback((name, afterIndex) => {
        const newStage = {
          id: generateId(),
          name,
          steps: []
        };
        setConfig(prev => {
          const stages = [...prev.stages];
          stages.splice(afterIndex + 1, 0, newStage);
          return { ...prev, stages };
        });
      }, []);

      const insertStepAt = useCallback((stageId, stepData, afterIndex) => {
        const newStep = {
          id: generateId(),
          name: stepData.name,
          description: stepData.description || '',
          timeMinutes: stepData.timeMinutes || 30,
          owner: stepData.owner || 'ops',
          touchpoints: [],
          painPoints: [],
          emotions: [],
          frictionScore: stepData.frictionScore || 3,
          automationOpportunity: stepData.automationOpportunity || 'medium',
          automationNotes: '',
          regulatoryRequirements: [],
          actions: {}
        };
        setConfig(prev => ({
          ...prev,
          stages: prev.stages.map(stage => {
            if (stage.id !== stageId) return stage;
            const steps = [...stage.steps];
            steps.splice(afterIndex + 1, 0, newStep);
            return { ...stage, steps };
          })
        }));
      }, []);

      const renameStage = useCallback((stageId, newName) => {
        setConfig(prev => ({
          ...prev,
          stages: prev.stages.map(stage =>
            stage.id === stageId ? { ...stage, name: newName } : stage
          )
        }));
      }, []);

      const renameStep = useCallback((stageId, stepId, newName) => {
        setConfig(prev => ({
          ...prev,
          stages: prev.stages.map(stage =>
            stage.id === stageId
              ? {
                  ...stage,
                  steps: stage.steps.map(step =>
                    step.id === stepId ? { ...step, name: newName } : step
                  )
                }
              : stage
          )
        }));
      }, []);

      const addPainPoint = useCallback((stageId, stepId, painPoint) => {
        if (!painPoint.trim()) return;
        setConfig(prev => ({
          ...prev,
          stages: prev.stages.map(stage => 
            stage.id === stageId 
              ? {
                  ...stage,
                  steps: stage.steps.map(step =>
                    step.id === stepId 
                      ? { ...step, painPoints: [...step.painPoints, painPoint] }
                      : step
                  )
                }
              : stage
          )
        }));
      }, []);

      const removePainPoint = useCallback((stageId, stepId, index) => {
        setConfig(prev => ({
          ...prev,
          stages: prev.stages.map(stage => 
            stage.id === stageId 
              ? {
                  ...stage,
                  steps: stage.steps.map(step =>
                    step.id === stepId 
                      ? { ...step, painPoints: step.painPoints.filter((_, i) => i !== index) }
                      : step
                  )
                }
              : stage
          )
        }));
      }, []);

      const addRegRequirement = useCallback((stageId, stepId, req) => {
        if (!req.trim()) return;
        setConfig(prev => ({
          ...prev,
          stages: prev.stages.map(stage => 
            stage.id === stageId 
              ? {
                  ...stage,
                  steps: stage.steps.map(step =>
                    step.id === stepId 
                      ? { ...step, regulatoryRequirements: [...(step.regulatoryRequirements || []), req] }
                      : step
                  )
                }
              : stage
          )
        }));
      }, []);

      const removeRegRequirement = useCallback((stageId, stepId, index) => {
        setConfig(prev => ({
          ...prev,
          stages: prev.stages.map(stage => 
            stage.id === stageId 
              ? {
                  ...stage,
                  steps: stage.steps.map(step =>
                    step.id === stepId 
                      ? { ...step, regulatoryRequirements: step.regulatoryRequirements.filter((_, i) => i !== index) }
                      : step
                  )
                }
              : stage
          )
        }));
      }, []);

      const updateSalaries = useCallback((newPersonas) => {
        // Get IDs of deleted personas
        const newIds = new Set(newPersonas.map(p => p.id));
        
        setConfig(prev => ({
          ...prev,
          personas: newPersonas,
          // Clean up roleInvolvement for deleted roles
          stages: prev.stages.map(stage => ({
            ...stage,
            steps: stage.steps.map(step => ({
              ...step,
              roleInvolvement: Object.fromEntries(
                Object.entries(step.roleInvolvement || {}).filter(([roleId]) => newIds.has(roleId))
              ),
              // Update owner if deleted
              owner: newIds.has(step.owner) ? step.owner : (newPersonas[0]?.id || step.owner)
            }))
          }))
        }));
        setShowSalarySettings(false);
      }, []);

      const updateRoleInvolvement = useCallback((stageId, stepId, roleId, field, value) => {
        setConfig(prev => ({
          ...prev,
          stages: prev.stages.map(stage => 
            stage.id === stageId 
              ? {
                  ...stage,
                  steps: stage.steps.map(step => {
                    if (step.id !== stepId) return step;
                    
                    // Update the roleInvolvement
                    const newRoleInvolvement = {
                      ...(step.roleInvolvement || {}),
                      [roleId]: {
                        ...(step.roleInvolvement?.[roleId] || { timeMinutes: 0, headcount: 1 }),
                        [field]: value
                      }
                    };
                    
                    // Calculate total timeMinutes from all roles
                    const totalTime = Object.values(newRoleInvolvement).reduce(
                      (sum, inv) => sum + (inv.timeMinutes || 0), 0
                    );
                    
                    return { 
                      ...step, 
                      roleInvolvement: newRoleInvolvement,
                      timeMinutes: totalTime
                    };
                  })
                }
              : stage
          )
        }));
      }, []);

      const exportConfig = () => {
        const exportData = { ...config, meta: { ...config.meta, lastUpdated: new Date().toISOString() } };
        const blob = new Blob([JSON.stringify(exportData, null, 2)], { type: 'application/json' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = 'journey-map-config.json';
        a.click();
        URL.revokeObjectURL(url);
      };

      const importConfig = (event) => {
        const file = event.target.files[0];
        if (file) {
          const reader = new FileReader();
          reader.onload = (e) => {
            try {
              const imported = JSON.parse(e.target.result);
              const normalized = normalizeConfig(imported);
              setConfig(normalized);
              setSelectedStep(null);
            } catch (err) {
              alert('Invalid JSON file');
            }
          };
          reader.readAsText(file);
        }
      };

      // Generate PDF using browser print
      // Generate PDF using browser print
      const generatePDF = (reportType = 'summary') => {
        const printWindow = window.open('', '_blank');
        if (!printWindow) {
          alert('Please allow popups for this site to export reports');
          return;
        }
        
        const allSteps = config.stages.flatMap((stage, si) => 
          stage.steps.map((step, sti) => ({ ...step, stageName: stage.name, stageIndex: si, stepIndex: sti }))
        );
        
        const totalCost = allSteps.reduce((acc, s) => acc + calculateStepCost(s, config.personas), 0);
        const totalPainPoints = allSteps.reduce((acc, s) => acc + s.painPoints.length, 0);
        const highAutomationCount = allSteps.filter(s => s.automationOpportunity === 'high').length;
        const potentialSavings = allSteps.reduce((acc, s) => {
          const cost = calculateStepCost(s, config.personas);
          if (s.automationOpportunity === 'high') return acc + cost * 0.7;
          if (s.automationOpportunity === 'medium') return acc + cost * 0.4;
          if (s.automationOpportunity === 'low') return acc + cost * 0.1;
          return acc;
        }, 0);

        const roleCosts = config.personas.filter(p => !p.isExternal).map(persona => {
          let roleCost = 0;
          let roleTimeTotal = 0;
          
          allSteps.forEach(step => {
            // NEW FORMAT: roleInvolvement
            if (step.roleInvolvement && step.roleInvolvement[persona.id]) {
              const inv = step.roleInvolvement[persona.id];
              const fullyLoadedRate = calculateFullyLoadedRate(persona);
              const hours = (inv.timeMinutes || 0) / 60;
              const headcount = inv.headcount || 1;
              roleCost += fullyLoadedRate * hours * headcount;
              roleTimeTotal += (inv.timeMinutes || 0) * headcount;
            }
            // LEGACY FORMAT: Single owner
            else if (step.owner === persona.id && step.timeMinutes > 0) {
              const fullyLoadedRate = calculateFullyLoadedRate(persona);
              const hours = step.timeMinutes / 60;
              roleCost += fullyLoadedRate * hours;
              roleTimeTotal += step.timeMinutes;
            }
          });
          
          return { ...persona, totalCost: roleCost, totalTime: roleTimeTotal };
        }).filter(r => r.totalTime > 0).sort((a, b) => b.totalCost - a.totalCost);

        const styles = `
          * { box-sizing: border-box; margin: 0; padding: 0; }
          body { font-family: 'Interstate', sans-serif; font-size: 10pt; line-height: 1.5; padding: 32px 40px; color: #1A2332; max-width: 1100px; margin: 0 auto; }
          h1 { font-size: 22pt; margin-bottom: 4px; color: #1A2332; font-weight: 600; }
          h2 { font-size: 14pt; margin: 28px 0 14px; color: #2D8A6E; border-bottom: 2px solid #2D8A6E; padding-bottom: 6px; font-weight: 600; }
          .header-bar { background: #192B45; color: #FFF; padding: 20px 24px; border-radius: 8px; margin-bottom: 24px; display: flex; justify-content: space-between; align-items: center; }
          .header-bar h1 { color: #FFF; margin: 0; font-size: 18pt; }
          .header-bar .meta { font-size: 10pt; opacity: 0.7; }
          .summary-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 12px; margin-bottom: 28px; }
          .summary-card { background: #F4F5F7; padding: 16px; border-radius: 8px; text-align: center; border: 1px solid #E4E7EB; }
          .summary-card.highlight { background: #FAF0D6; border-color: #F0DDA8; }
          .summary-card.success { background: #D4EDE5; border-color: #96BCC7; }
          .summary-value { font-size: 22pt; font-weight: 700; color: #2D8A6E; }
          .summary-card.highlight .summary-value { color: #8B6914; }
          .summary-card.success .summary-value { color: #2D8A6E; }
          .summary-label { font-size: 9pt; color: #556275; text-transform: uppercase; margin-top: 4px; }
          .stage { margin-bottom: 20px; page-break-inside: avoid; }
          .stage-header { background: #2D8A6E; color: #FFF; padding: 10px 14px; border-radius: 6px 6px 0 0; display: flex; justify-content: space-between; }
          .stage-name { font-weight: 600; font-size: 11pt; }
          .stage-stats { font-size: 9pt; opacity: 0.85; }
          table { width: 100%; border-collapse: collapse; background: #FFF; margin-bottom: 16px; }
          th { background: #F4F5F7; padding: 8px 10px; text-align: left; font-size: 9pt; font-weight: 600; color: #556275; border-bottom: 2px solid #E4E7EB; }
          td { padding: 10px; border-bottom: 1px solid #EEE; font-size: 10pt; vertical-align: top; }
          .cost { color: #8B6914; font-weight: 600; }
          .time { color: #556275; }
          .step-name { font-weight: 500; }
          .step-desc { font-size: 9pt; color: #888; margin-top: 2px; }
          .pain-point { font-size: 9pt; color: #B84A5A; }
          .reg-req { font-size: 9pt; color: #5A5B8A; }
          .auto-high { background: #D4EDE5; color: #2D8A6E; padding: 2px 8px; border-radius: 10px; font-size: 9pt; }
          .auto-medium { background: #FAF0D6; color: #8B6914; padding: 2px 8px; border-radius: 10px; font-size: 9pt; }
          .auto-low { background: #E4E7EB; color: #556275; padding: 2px 8px; border-radius: 10px; font-size: 9pt; }
          .role-bar { display: flex; align-items: center; gap: 16px; padding: 12px 16px; background: #F4F5F7; border-radius: 6px; margin-bottom: 8px; border-left: 4px solid #556275; }
          .opp-card { background: #E1EEF2; border: 1px solid #96BCC7; border-radius: 8px; padding: 12px 16px; margin-bottom: 8px; display: flex; justify-content: space-between; }
          .footer { margin-top: 32px; padding-top: 16px; border-top: 1px solid #C8CED6; font-size: 9pt; color: #8A95A5; display: flex; justify-content: space-between; }
          @media print { body { padding: 16px; } }
        `;

        let html = '<!DOCTYPE html><html><head><title>' + config.meta.title + ' - Report</title><style>' + styles + '</style></head><body>';
        
        // Header
        html += '<div class="header-bar"><div><h1>' + config.meta.title + '</h1><div class="meta">' + (reportType === 'cost-analysis' ? 'Cost Analysis Report' : reportType === 'detailed' ? 'Detailed Process Report' : 'Summary Report') + '</div></div>';
        html += '<div class="meta" style="text-align:right;">Generated: ' + new Date().toLocaleDateString('en-GB') + '<br/>Version: ' + config.meta.version + '</div></div>';

        // Summary cards
        html += '<div class="summary-grid">';
        html += '<div class="summary-card"><div class="summary-value">' + config.stages.length + '</div><div class="summary-label">Stages</div></div>';
        html += '<div class="summary-card"><div class="summary-value">' + allSteps.length + '</div><div class="summary-label">Steps</div></div>';
        html += '<div class="summary-card"><div class="summary-value">' + formatTime(totalTime) + '</div><div class="summary-label">Total Time</div></div>';
        html += '<div class="summary-card highlight"><div class="summary-value">' + formatCurrency(totalCost) + '</div><div class="summary-label">Total Cost</div></div>';
        html += '</div>';

        if (reportType === 'summary' || reportType === 'detailed') {
          // Second row of summary cards
          html += '<div class="summary-grid">';
          html += '<div class="summary-card"><div class="summary-value">' + totalPainPoints + '</div><div class="summary-label">Pain Points</div></div>';
          html += '<div class="summary-card"><div class="summary-value">' + highAutomationCount + '</div><div class="summary-label">High Improv Opps</div></div>';
          html += '<div class="summary-card success"><div class="summary-value">' + formatCurrency(potentialSavings) + ' (' + (totalCost > 0 ? Math.round((potentialSavings / totalCost) * 100) : 0) + '%)</div><div class="summary-label">Potential Savings</div></div>';
          html += '<div class="summary-card"><div class="summary-value">' + formatCurrencyDetailed(totalCost / totalTime) + '/m</div><div class="summary-label">Cost per Minute</div></div>';
          html += '</div>';

          // Stages
          config.stages.forEach((stage, si) => {
            const stageCost = stage.steps.reduce((acc, s) => acc + calculateStepCost(s, config.personas), 0);
            const stageTime = stage.steps.reduce((acc, s) => acc + s.timeMinutes, 0);
            
            html += '<div class="stage"><div class="stage-header"><div class="stage-name">' + stage.name + '</div>';
            html += '<div class="stage-stats">' + stage.steps.length + ' steps · ' + formatTime(stageTime) + ' · ' + formatCurrency(stageCost) + '</div></div>';
            
            html += '<table><thead><tr><th style="width:40px">#</th><th style="width:180px">Step</th><th style="width:70px">Time</th><th style="width:70px">Cost</th>';
            if (reportType === 'detailed') {
              html += '<th style="width:35%">Pain Points</th><th style="width:20%">Improvement</th>';
            } else {
              html += '<th style="width:35%">Pain Points</th><th style="width:90px">Improvement</th>';
            }
            html += '</tr></thead><tbody>';
            
            stage.steps.forEach((step, sti) => {
              const stepCost = calculateStepCost(step, config.personas);
              const owner = config.personas.find(p => p.id === step.owner);
              html += '<tr><td>' + (si+1) + '.' + (sti+1) + '</td>';
              html += '<td><div class="step-name">' + step.name + '</div><div class="step-desc">' + (owner?.label || '') + (step.clientTouchpoint ? ' · 👤 Client' : '') + '</div></td>';
              html += '<td class="time">' + formatTime(step.timeMinutes) + '</td>';
              html += '<td class="cost">' + formatCurrency(stepCost) + '</td>';
              
              // Pain Points column for all report types
              html += '<td>' + (step.painPoints.length > 0 ? step.painPoints.map(pp => '<div class="pain-point">⚠ ' + pp + '</div>').join('') : '—') + '</td>';
              
              if (reportType === 'detailed') {
                html += '<td>' + ((step.regulatoryRequirements || []).length > 0 ? step.regulatoryRequirements.map(rr => '<div class="reg-req">📋 ' + rr + '</div>').join('') : '—') + '</td>';
              } else {
                const autoClass = step.automationOpportunity === 'high' ? 'auto-high' : step.automationOpportunity === 'medium' ? 'auto-medium' : step.automationOpportunity === 'low' ? 'auto-low' : '';
                html += '<td><span class="' + autoClass + '">' + (step.automationOpportunity || 'none') + '</span></td>';
              }
              html += '</tr>';
            });
            
            html += '</tbody></table></div>';
          });
        }

        if (reportType === 'cost-analysis') {
          // Cost by role
          html += '<h2>Cost by Role</h2>';
          roleCosts.forEach(role => {
            html += '<div class="role-bar" style="border-color:' + role.color + '">';
            html += '<div style="min-width:140px;font-weight:600;color:' + role.color + '">' + role.label + '</div>';
            html += '<div style="flex:1;display:flex;gap:24px">';
            html += '<div style="text-align:center"><div style="font-size:14pt;font-weight:600;color:' + role.color + '">' + formatCurrency(role.totalCost) + '</div><div style="font-size:8pt;color:#556275">COST</div></div>';
            html += '<div style="text-align:center"><div style="font-size:14pt;font-weight:600">' + formatTime(role.totalTime) + '</div><div style="font-size:8pt;color:#556275">TIME</div></div>';
            html += '<div style="text-align:center"><div style="font-size:14pt;font-weight:600">' + Math.round((role.totalCost / totalCost) * 100) + '%</div><div style="font-size:8pt;color:#556275">OF TOTAL</div></div>';
            html += '</div></div>';
          });

          // Top improvement opportunities
          html += '<h2>Top Improvement Opportunities</h2>';
          const opportunities = allSteps
            .filter(s => s.automationOpportunity === 'high' || s.automationOpportunity === 'medium')
            .map(step => {
              const stepCost = calculateStepCost(step, config.personas);
              const savings = step.automationOpportunity === 'high' ? stepCost * 0.7 : stepCost * 0.4;
              return { ...step, savings, stepCost };
            })
            .sort((a, b) => b.savings - a.savings)
            .slice(0, 8);
          
          opportunities.forEach(step => {
            html += '<div class="opp-card"><div><div style="font-weight:500">' + step.name + '</div>';
            html += '<div style="font-size:9pt;color:#556275">' + step.stageName + ' · ' + formatTime(step.timeMinutes) + ' · Current: ' + formatCurrency(step.stepCost) + '</div></div>';
            html += '<div style="text-align:right"><div style="font-size:14pt;font-weight:700;color:#2D8A6E">Save ' + formatCurrency(step.savings) + '</div>';
            html += '<div style="font-size:9pt;color:#2D8A6E">' + step.automationOpportunity + ' potential</div></div></div>';
          });

          // Most expensive steps
          html += '<h2>Most Expensive Steps</h2>';
          html += '<table><thead><tr><th>Rank</th><th>Step</th><th>Stage</th><th>Time</th><th>Cost</th></tr></thead><tbody>';
          allSteps
            .map(step => ({ ...step, stepCost: calculateStepCost(step, config.personas) }))
            .sort((a, b) => b.stepCost - a.stepCost)
            .slice(0, 10)
            .forEach((step, i) => {
              html += '<tr><td style="font-weight:600;color:' + (i < 3 ? '#B84A5A' : '#556275') + '">#' + (i+1) + '</td>';
              html += '<td class="step-name">' + step.name + '</td>';
              html += '<td style="color:#556275">' + step.stageName + '</td>';
              html += '<td>' + formatTime(step.timeMinutes) + '</td>';
              html += '<td class="cost">' + formatCurrency(step.stepCost) + '</td></tr>';
            });
          html += '</tbody></table>';
        }

        // Footer
        html += '<div class="footer"><span>' + config.meta.product + ' · v' + config.meta.version + '</span>';
        html += '<span>Generated ' + new Date().toLocaleDateString('en-GB') + ' at ' + new Date().toLocaleTimeString('en-GB') + '</span></div>';
        
        html += '</body></html>';
        
        printWindow.document.write(html);
        printWindow.document.close();
      };

      // Calculate summary stats
      // Calculate summary stats
      const stats = useMemo(() => {
        const allSteps = config.stages.flatMap(s => s.steps);
        const totalPainPoints = allSteps.reduce((acc, s) => acc + s.painPoints.length, 0);
        const avgFriction = allSteps.length ? (allSteps.reduce((acc, s) => acc + (s.frictionScore || 3), 0) / allSteps.length).toFixed(1) : 0;
        const highAutomation = allSteps.filter(s => s.automationOpportunity === 'high').length;
        const totalRegReqs = allSteps.reduce((acc, s) => acc + (s.regulatoryRequirements?.length || 0), 0);
        const totalCost = allSteps.reduce((acc, s) => acc + calculateStepCost(s, config.personas), 0);
        return { totalPainPoints, avgFriction, highAutomation, totalRegReqs, totalSteps: allSteps.length, totalCost };
      }, [config.stages, config.personas]);

      // Funnel metrics calculation
      const funnelMetrics = useMemo(() => calculateFunnelMetrics(config), [config]);

      // Update funnel settings handler
      const updateFunnelSettings = useCallback((updates) => {
        setConfig(prev => ({
          ...prev,
          funnel: updates.funnel,
          stages: updates.stages
        }));
      }, []);

      // Loading screen while fetching config
      if (configLoading) {
        return (
          <div className="loading-screen">
            <img 
              src="https://steveyoung74.github.io/journeymaps/logo_light.png" 
              alt="FATHOM" 
              className="loading-logo"
            />
          </div>
        );
      }

      return (
        <>
          {/* Fixed topographic background layer */}
          <div className="topo-background"></div>
          
          <div className="app-bg" style={{
            height: isMobile ? 'auto' : '100vh',
            minHeight: isMobile ? '100vh' : 'auto',
            display: 'flex',
            flexDirection: 'column',
            background: 'transparent',
            fontFamily: "'Interstate', sans-serif",
            color: '#1A2332',
            overflow: isMobile ? 'auto' : 'hidden'
          }}>
            {/* Header */}
            <header className="header-container" style={{
              background: '#192B45',
              color: '#E9EEF4',
              padding: '16px 24px',
              display: 'flex',
              flexDirection: 'column',
              gap: '12px',
              flexShrink: 0
            }}>
            {/* Row 1: Back + Logo + Title (left) | Desktop nav + Export/Settings (right) */}
            <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', gap: '16px' }}>
              {/* Left side: Back Button (multi-user mode) + Logo + Divider + Title */}
              <div className="header-logo-title" style={{ display: 'flex', alignItems: 'center', gap: isMobile ? '12px' : '16px', flex: 1, minWidth: 0 }}>
                {/* Back to Dashboard Button - show in Supabase mode OR legacy multi-user mode */}
                {(isSupabaseMode || isMultiUserMode) && (
                  <button
                    onClick={() => window.location.href = 'dashboard.html'}
                    style={{
                      background: 'rgba(255,255,255,0.1)',
                      border: '1px solid rgba(255,255,255,0.3)',
                      borderRadius: '6px',
                      padding: isMobile ? '6px 10px' : '8px 12px',
                      color: '#FFF',
                      cursor: 'pointer',
                      fontFamily: "'Interstate', sans-serif",
                      fontSize: '12px',
                      display: 'flex',
                      alignItems: 'center',
                      gap: '4px',
                      flexShrink: 0,
                      transition: 'all 0.15s'
                    }}
                    onMouseOver={(e) => { e.currentTarget.style.background = 'rgba(255,255,255,0.2)'; }}
                    onMouseOut={(e) => { e.currentTarget.style.background = 'rgba(255,255,255,0.1)'; }}
                    title="Back to Dashboard"
                  >
                    ←
                  </button>
                )}
                
                {/* Fathom Logo - Light version for dark background */}
                <img src="logo_light.png" alt="FATHOM" style={{ height: '32px', width: 'auto', flexShrink: 0 }} />
                
                {/* Vertical Divider - desktop only */}
                {!isMobile && <div className="header-divider" style={{ width: '1px', height: '32px', background: 'rgba(255,255,255,0.2)', flexShrink: 0 }} />}
                
                {/* Title */}
                <div className="header-title-wrapper" style={{ minWidth: 0, flex: 1, display: 'flex', alignItems: 'center', gap: '12px' }}>
                  <h1 style={{ margin: 0, fontSize: isMobile ? '16px' : '18px', fontWeight: 500, letterSpacing: '-0.3px', display: 'flex', alignItems: 'center', gap: '8px' }}>
                    {editingTitle ? (
                      <input 
                        type="text" 
                        value={config.meta.title} 
                        onChange={(e) => setConfig(prev => ({ ...prev, meta: { ...prev.meta, title: e.target.value } }))}
                        onBlur={() => {
                          setEditingTitle(false);
                          if (isSupabaseMode) {
                            saveToSupabase();
                          } else if (isMultiUserMode && gitHubConfig.token) {
                            saveToGitHub();
                          }
                        }}
                        onKeyDown={(e) => {
                          if (e.key === 'Enter') {
                            e.target.blur();
                          } else if (e.key === 'Escape') {
                            setEditingTitle(false);
                          }
                        }}
                        autoFocus
                        placeholder="Journey Title"
                        style={{ 
                          background: 'rgba(255,255,255,0.1)', 
                          border: '1px solid rgba(255,255,255,0.3)', 
                          borderRadius: '4px', 
                          padding: '4px 8px', 
                          fontSize: isMobile ? '16px' : '18px', 
                          fontWeight: 500, 
                          letterSpacing: '-0.3px', 
                          color: '#F4F5F7', 
                          fontFamily: "'Interstate', sans-serif", 
                          width: `${Math.max(200, Math.min(400, config.meta.title.length * 10 + 40))}px`,
                          outline: 'none'
                        }}
                      />
                    ) : (
                      <div 
                        style={{ 
                          display: 'flex', 
                          alignItems: 'center', 
                          gap: '8px',
                          cursor: 'pointer',
                          padding: '4px 8px',
                          borderRadius: '4px',
                          transition: 'background 0.15s'
                        }}
                        onMouseEnter={(e) => { 
                          e.currentTarget.style.background = 'rgba(255,255,255,0.1)'; 
                          e.currentTarget.querySelector('.edit-pencil').style.opacity = '1';
                        }}
                        onMouseLeave={(e) => { 
                          e.currentTarget.style.background = 'transparent'; 
                          e.currentTarget.querySelector('.edit-pencil').style.opacity = '0';
                        }}
                        onClick={() => setEditingTitle(true)}
                        title="Click to edit journey name"
                      >
                        <span style={{ whiteSpace: 'nowrap', overflow: 'hidden', textOverflow: 'ellipsis' }}>
                          {config.meta.title}
                        </span>
                        <span 
                          className="edit-pencil"
                          style={{ 
                            fontSize: '14px', 
                            opacity: '0', 
                            transition: 'opacity 0.15s',
                            flexShrink: 0
                          }}
                        >✏️</span>
                      </div>
                    )}
                  </h1>
                  {/* Cost Model Badge */}
                  {config.meta?.costModel === 'event' ? (
                    <span style={{
                      background: '#C4942A',
                      color: '#FFF',
                      padding: '3px 10px',
                      borderRadius: '12px',
                      fontSize: '11px',
                      fontWeight: 600,
                      textTransform: 'uppercase',
                      letterSpacing: '0.5px',
                      flexShrink: 0,
                      display: 'flex',
                      alignItems: 'center',
                      gap: '4px'
                    }}>
                      🎪 Event
                    </span>
                  ) : config.meta?.costModel === 'project' ? (
                    <span style={{
                      background: '#5A5B8A',
                      color: '#FFF',
                      padding: '3px 10px',
                      borderRadius: '12px',
                      fontSize: '11px',
                      fontWeight: 600,
                      textTransform: 'uppercase',
                      letterSpacing: '0.5px',
                      flexShrink: 0,
                      display: 'flex',
                      alignItems: 'center',
                      gap: '4px'
                    }}>
                      🎯 Project
                    </span>
                  ) : (
                    <span style={{
                      background: '#5B8A9A',
                      color: '#FFF',
                      padding: '3px 10px',
                      borderRadius: '12px',
                      fontSize: '11px',
                      fontWeight: 600,
                      textTransform: 'uppercase',
                      letterSpacing: '0.5px',
                      flexShrink: 0,
                      display: 'flex',
                      alignItems: 'center',
                      gap: '4px'
                    }}>
                      🚶 Client
                    </span>
                  )}
                  {/* Read-only badge */}
                  {isSupabaseMode && authChecked && !canEdit && (
                    <span style={{
                      background: 'rgba(255,255,255,0.15)',
                      color: 'rgba(255,255,255,0.8)',
                      padding: '3px 10px',
                      borderRadius: '12px',
                      fontSize: '11px',
                      fontWeight: 600,
                      textTransform: 'uppercase',
                      letterSpacing: '0.5px',
                      flexShrink: 0
                    }}>View Only</span>
                  )}
                </div>
              </div>
              
              {/* Desktop Menu - between title and export */}
              {!isMobile && !editMode && (
                <>
                  <div className="header-divider" style={{ width: '1px', height: '32px', background: 'rgba(255,255,255,0.2)', flexShrink: 0 }} />
                  <div className="no-print" style={{ display: 'flex', gap: '6px', alignItems: 'center', flexShrink: 0 }}>
                    
                    {/* GROUP 1: View Mode */}
                    <div style={{ display: 'flex', borderRadius: '4px', overflow: 'hidden', border: '1px solid rgba(255,255,255,0.3)' }}>
                      <button onClick={() => { setViewMode('stages'); }} style={{ padding: '6px 10px', background: viewMode === 'stages' ? '#556275' : 'transparent', color: '#F4F5F7', border: 'none', cursor: 'pointer', fontFamily: "'Interstate', sans-serif", fontSize: '11px', display: 'flex', alignItems: 'center', gap: '4px' }}>
                        📁{!isCompact && ' Stages'}
                      </button>
                      <button onClick={() => setViewMode('steps')} style={{ padding: '6px 10px', background: viewMode === 'steps' ? '#556275' : 'transparent', color: '#F4F5F7', border: 'none', borderLeft: '1px solid rgba(255,255,255,0.2)', cursor: 'pointer', fontFamily: "'Interstate', sans-serif", fontSize: '11px', display: 'flex', alignItems: 'center', gap: '4px' }}>
                        📋{!isCompact && ' Steps'}
                      </button>
                    </div>
                    
                    {/* GROUP 2: View Layers (what info shows on cards) */}
                    {(showCosts || config.funnel?.enabled) && (
                      <>
                        <div style={{ width: '1px', height: '20px', background: 'rgba(255,255,255,0.15)', margin: '0 2px' }} />
                        {!isCompact && <span style={{ fontSize: '9px', color: 'rgba(255,255,255,0.4)', fontFamily: "'Interstate', sans-serif", textTransform: 'uppercase', letterSpacing: '0.5px' }}>Show</span>}
                        <div style={{ display: 'flex', borderRadius: '4px', overflow: 'hidden', border: '1px solid rgba(255,255,255,0.3)' }}>
                          {showCosts && (
                            <button 
                              onClick={() => { 
                                if (highlightOpportunities) {
                                  setHighlightOpportunities(false);
                                } else {
                                  setHighlightOpportunities(true);
                                  setShowFunnel(false);
                                }
                              }} 
                              style={{ 
                                padding: '6px 10px', 
                                background: highlightOpportunities ? '#2D8A6E' : 'transparent', 
                                color: '#F4F5F7', 
                                border: 'none', 
                                cursor: 'pointer', 
                                fontFamily: "'Interstate', sans-serif", 
                                fontSize: '11px',
                                display: 'flex',
                                alignItems: 'center',
                                gap: '4px',
                                borderRight: config.funnel?.enabled ? '1px solid rgba(255,255,255,0.2)' : 'none'
                              }}
                            >
                              🎯{!isCompact && ' Opps'}
                            </button>
                          )}
                          {config.funnel?.enabled && (
                            <button 
                              onClick={() => { 
                                if (showFunnel) {
                                  setShowFunnel(false);
                                } else {
                                  setShowFunnel(true);
                                  setHighlightOpportunities(false);
                                }
                              }} 
                              style={{ 
                                padding: '6px 10px', 
                                background: showFunnel ? '#5A5B8A' : 'transparent', 
                                color: '#F4F5F7', 
                                border: 'none', 
                                cursor: 'pointer', 
                                fontFamily: "'Interstate', sans-serif", 
                                fontSize: '11px',
                                display: 'flex',
                                alignItems: 'center',
                                gap: '4px'
                              }}
                            >
                              🔻{!isCompact && ' Funnel'}
                            </button>
                          )}
                        </div>
                      </>
                    )}
                    
                    {/* GROUP 3: Dashboard */}
                    <div style={{ width: '1px', height: '20px', background: 'rgba(255,255,255,0.15)', margin: '0 2px' }} />
                    <button 
                      onClick={() => setShowDashboard(true)} 
                      style={{ 
                        padding: '6px 10px', 
                        background: 'transparent', 
                        color: '#F4F5F7', 
                        border: '1px solid rgba(255,255,255,0.3)', 
                        borderRadius: '4px',
                        cursor: 'pointer', 
                        fontFamily: "'Interstate', sans-serif", 
                        fontSize: '11px',
                        display: 'flex',
                        alignItems: 'center',
                        gap: '4px'
                      }}
                    >
                      📊{!isCompact && ' Dashboard'}
                    </button>
                    
                  </div>
                </>
              )}
              
              {/* Right side: Configure Structure + Export & Settings - Desktop only (mobile shows in row 2) */}
              {!isMobile && (
              <div className="no-print" style={{ display: 'flex', gap: '6px', alignItems: 'center', flexShrink: 0 }}>
                {!editMode && (
                  <>
                    {/* Configure Structure Button - Always visible */}
                    <button 
                      onClick={() => setShowStructurePanel(true)}
                      style={{ 
                        padding: '6px 10px', 
                        background: 'transparent', 
                        color: '#F4F5F7', 
                        border: '1px solid rgba(255,255,255,0.4)', 
                        borderRadius: '4px', 
                        cursor: 'pointer', 
                        fontFamily: "'Interstate', sans-serif", 
                        fontSize: '11px', 
                        display: 'flex', 
                        alignItems: 'center', 
                        gap: '4px',
                        transition: 'all 0.15s'
                      }}
                      onMouseOver={(e) => { e.currentTarget.style.background = 'rgba(255,255,255,0.1)'; }}
                      onMouseOut={(e) => { e.currentTarget.style.background = 'transparent'; }}
                      title="Add, remove, and reorder stages and steps"
                    >
                      🏗️{!isCompact && ' Structure'}
                    </button>
                    <div style={{ width: '1px', height: '20px', background: 'rgba(255,255,255,0.15)' }} />
                  </>
                )}
                {editMode ? (
                  <>
                    <span style={{ fontFamily: "'Interstate', sans-serif", fontSize: '11px', color: '#F4F5F7', opacity: 0.7, marginRight: '4px' }}>✏️ Editing</span>
                    <button onClick={cancelEdit} style={{ padding: '6px 12px', background: 'transparent', color: '#F4F5F7', border: '1px solid rgba(255,255,255,0.4)', borderRadius: '4px', cursor: 'pointer', fontFamily: "'Interstate', sans-serif", fontSize: '11px' }}>
                      Cancel
                    </button>
                    <button onClick={saveEdit} style={{ padding: '6px 12px', background: '#2D8A6E', color: '#F4F5F7', border: 'none', borderRadius: '4px', cursor: 'pointer', fontFamily: "'Interstate', sans-serif", fontSize: '11px', fontWeight: 500, display: 'flex', alignItems: 'center', gap: '4px' }}>
                      💾 Save {gitHubConfig.token && <span style={{ opacity: 0.7 }}>→ 🐙</span>}
                    </button>
                  </>
                ) : (
                  <>
                    {/* Share Button (Supabase mode only) */}
                    {isSupabaseMode && canAccessSettings && (
                      <button 
                        onClick={() => setShowShareModal(true)}
                        style={{ 
                          padding: '6px 10px', 
                          background: 'transparent', 
                          color: '#F4F5F7', 
                          border: '1px solid rgba(255,255,255,0.4)', 
                          borderRadius: '4px', 
                          cursor: 'pointer', 
                          fontFamily: "'Interstate', sans-serif", 
                          fontSize: '11px', 
                          display: 'flex', 
                          alignItems: 'center', 
                          gap: '4px',
                          marginRight: '8px'
                        }}
                        title="Share this map"
                      >
                        🔗 Share
                      </button>
                    )}
                    
                    {/* Settings Dropdown - hidden for view-only users in Supabase mode */}
                    {(!isSupabaseMode || canAccessSettings) && (
                    <div style={{ position: 'relative' }}>
                      <button onClick={(e) => { 
                        e.stopPropagation(); 
                        // In Supabase mode, use role-based access; in legacy mode, use password
                        const hasAccess = isSupabaseMode ? canAccessSettings : isSettingsUnlocked;
                        if (hasAccess) {
                          setShowSettingsMenu(!showSettingsMenu);
                        } else if (!isSupabaseMode) {
                          setShowPasswordPrompt(true);
                        }
                      }} style={{ padding: '6px 10px', background: showSettingsMenu ? '#556275' : 'transparent', color: '#F4F5F7', border: '1px solid rgba(255,255,255,0.4)', borderRadius: '4px', cursor: 'pointer', fontFamily: "'Interstate', sans-serif", fontSize: '11px', display: 'flex', alignItems: 'center', gap: '4px' }} title="Settings">
                        {(isSupabaseMode ? canAccessSettings : isSettingsUnlocked) ? '⚙️' : '🔒'} <span style={{ fontSize: '8px' }}>▼</span>
                      </button>
                      {showSettingsMenu && (isSupabaseMode ? canAccessSettings : isSettingsUnlocked) && (
                        <div onClick={(e) => e.stopPropagation()} style={{ position: 'absolute', top: '100%', right: 0, marginTop: '8px', background: '#FFF', borderRadius: '12px', boxShadow: '0 8px 32px rgba(0,0,0,0.2)', overflow: 'hidden', zIndex: 9999, minWidth: '220px', padding: '8px 0' }}>
                          <div style={{ color: '#6E7B8C', fontSize: '10px', fontWeight: 600, textTransform: 'uppercase', letterSpacing: '0.5px', padding: '8px 16px 4px' }}>Configuration</div>
                          {canEdit && (
                            <button onClick={() => { setShowJourneySettings(true); setShowSettingsMenu(false); }} style={{ display: 'flex', alignItems: 'center', gap: '12px', width: '100%', padding: '10px 16px', border: 'none', background: 'transparent', cursor: 'pointer', textAlign: 'left', fontFamily: "'Interstate', sans-serif", fontSize: '14px', color: '#3D4A5C', transition: 'background 0.1s' }} onMouseOver={(e) => e.currentTarget.style.background = '#F4F5F7'} onMouseOut={(e) => e.currentTarget.style.background = 'transparent'}>
                              <span style={{ width: '18px', textAlign: 'center' }}>⚙️</span> Journey Settings
                              {config.meta?.costModel === 'event' && <span style={{ marginLeft: 'auto', padding: '2px 6px', background: '#FAF0D6', color: '#8B6914', borderRadius: '4px', fontSize: '9px', fontWeight: 600 }}>EVENT</span>}
                            </button>
                          )}
                          {!isSupabaseMode && (
                            <>
                              <div style={{ height: '1px', background: '#E4E7EB', margin: '4px 0' }} />
                              <div style={{ color: '#6E7B8C', fontSize: '10px', fontWeight: 600, textTransform: 'uppercase', letterSpacing: '0.5px', padding: '8px 16px 4px' }}>Data</div>
                              <button onClick={() => { setShowGitHubSettings(true); setShowSettingsMenu(false); }} style={{ display: 'flex', alignItems: 'center', gap: '12px', width: '100%', padding: '10px 16px', border: 'none', background: 'transparent', cursor: 'pointer', textAlign: 'left', fontFamily: "'Interstate', sans-serif", fontSize: '14px', color: '#3D4A5C', transition: 'background 0.1s' }} onMouseOver={(e) => e.currentTarget.style.background = '#F4F5F7'} onMouseOut={(e) => e.currentTarget.style.background = 'transparent'}>
                                <span style={{ width: '18px', textAlign: 'center' }}>🐙</span> GitHub Settings
                              </button>
                            </>
                          )}
                          <div style={{ height: '1px', background: '#E4E7EB', margin: '4px 0' }} />
                          <button 
                            onClick={() => setShowCosts(!showCosts)} 
                            style={{ 
                              display: 'flex', 
                              alignItems: 'center', 
                              gap: '12px', 
                              width: '100%', 
                              padding: '10px 16px', 
                              border: 'none', 
                              background: 'transparent', 
                              cursor: 'pointer', 
                              textAlign: 'left', 
                              fontFamily: "'Interstate', sans-serif", 
                              fontSize: '14px', 
                              color: '#3D4A5C',
                              transition: 'background 0.1s'
                            }} 
                            onMouseOver={(e) => e.currentTarget.style.background = '#F4F5F7'} 
                            onMouseOut={(e) => e.currentTarget.style.background = 'transparent'}
                          >
                            <span style={{ width: '18px', textAlign: 'center' }}>{showCosts ? '💰' : '🚫'}</span> 
                            <span style={{ flex: 1 }}>Cost Data</span>
                            <span style={{ 
                              padding: '3px 10px', 
                              borderRadius: '12px', 
                              fontSize: '10px', 
                              fontWeight: 600,
                              background: showCosts ? 'rgba(45, 138, 110, 0.15)' : 'rgba(184, 74, 90, 0.15)',
                              color: showCosts ? '#2D8A6E' : '#B84A5A'
                            }}>
                              {showCosts ? 'VISIBLE' : 'HIDDEN'}
                            </span>
                          </button>
                        </div>
                      )}
                    </div>
                    )}
                    
                    {/* Profile Dropdown (Supabase mode only) */}
                    {isSupabaseMode && currentUser && (
                      <div className="profile-container" style={{ position: 'relative', marginLeft: '8px' }}>
                        <button 
                          onClick={(e) => { e.stopPropagation(); setShowProfileMenu(!showProfileMenu); }}
                          style={{ 
                            display: 'flex', 
                            alignItems: 'center', 
                            padding: '3px',
                            background: 'transparent',
                            border: 'none',
                            borderRadius: '50%',
                            cursor: 'pointer',
                            transition: 'all 0.15s',
                            position: 'relative'
                          }}
                        >
                          <div style={{ 
                            width: '36px', 
                            height: '36px', 
                            borderRadius: '50%', 
                            background: 'var(--steel-500, #5B8A9A)', 
                            display: 'flex', 
                            alignItems: 'center', 
                            justifyContent: 'center', 
                            color: '#FFF', 
                            fontSize: '14px', 
                            fontWeight: 600,
                            border: '2px solid rgba(255,255,255,0.2)',
                            transition: 'border-color 0.15s',
                            overflow: 'hidden'
                          }}>
                            {userProfile?.avatar_url ? (
                              <img src={userProfile.avatar_url} alt="" style={{ width: '100%', height: '100%', objectFit: 'cover' }} />
                            ) : (
                              getInitials(userProfile?.display_name || currentUser?.email)
                            )}
                          </div>
                          <span style={{ 
                            position: 'absolute',
                            bottom: '2px',
                            right: '0',
                            width: '14px',
                            height: '14px',
                            background: 'var(--navy-700, #1A2332)',
                            borderRadius: '50%',
                            display: 'flex',
                            alignItems: 'center',
                            justifyContent: 'center',
                            color: 'rgba(255,255,255,0.8)',
                            fontSize: '8px',
                            border: '2px solid var(--navy-800, #15243A)'
                          }}>▼</span>
                        </button>
                        
                        {showProfileMenu && (
                          <div onClick={(e) => e.stopPropagation()} style={{ 
                            position: 'absolute', 
                            top: 'calc(100% + 8px)', 
                            right: 0, 
                            background: '#FFF', 
                            borderRadius: '12px', 
                            boxShadow: '0 8px 32px rgba(0,0,0,0.2)', 
                            minWidth: '220px', 
                            padding: '8px 0',
                            zIndex: 9999
                          }}>
                            <div style={{ display: 'flex', alignItems: 'center', gap: '12px', padding: '12px 16px', borderBottom: '1px solid #E4E7EB', marginBottom: '4px' }}>
                              <div style={{ width: '40px', height: '40px', borderRadius: '50%', background: '#5B8A9A', display: 'flex', alignItems: 'center', justifyContent: 'center', color: '#FFF', fontSize: '16px', fontWeight: 600, flexShrink: 0, overflow: 'hidden' }}>
                                {userProfile?.avatar_url ? (
                                  <img src={userProfile.avatar_url} alt="" style={{ width: '100%', height: '100%', objectFit: 'cover' }} />
                                ) : (
                                  getInitials(userProfile?.display_name || currentUser?.email)
                                )}
                              </div>
                              <div style={{ flex: 1, minWidth: 0 }}>
                                <div style={{ fontWeight: 600, color: '#1A2332', fontSize: '14px', overflow: 'hidden', textOverflow: 'ellipsis', whiteSpace: 'nowrap' }}>
                                  {userProfile?.display_name || currentUser?.email?.split('@')[0]}
                                </div>
                                <div style={{ color: '#6E7B8C', fontSize: '12px', overflow: 'hidden', textOverflow: 'ellipsis', whiteSpace: 'nowrap' }}>
                                  {currentUser?.email}
                                </div>
                              </div>
                            </div>
                            
                            <a href="profile.html" style={{ display: 'flex', alignItems: 'center', gap: '12px', padding: '10px 16px', color: '#3D4A5C', textDecoration: 'none', fontSize: '14px', transition: 'background 0.1s' }} 
                               onMouseOver={(e) => e.currentTarget.style.background = '#F4F5F7'} 
                               onMouseOut={(e) => e.currentTarget.style.background = 'transparent'}>
                              <span style={{ width: '18px', textAlign: 'center' }}>👤</span>
                              Profile Settings
                            </a>
                            
                            <a href="team.html" style={{ display: 'flex', alignItems: 'center', gap: '12px', padding: '10px 16px', color: '#3D4A5C', textDecoration: 'none', fontSize: '14px', transition: 'background 0.1s' }} 
                               onMouseOver={(e) => e.currentTarget.style.background = '#F4F5F7'} 
                               onMouseOut={(e) => e.currentTarget.style.background = 'transparent'}>
                              <span style={{ width: '18px', textAlign: 'center' }}>👥</span>
                              Team Management
                            </a>
                            
                            <div style={{ height: '1px', background: '#E4E7EB', margin: '4px 0' }} />
                            
                            <a href="dashboard.html" style={{ display: 'flex', alignItems: 'center', gap: '12px', padding: '10px 16px', color: '#3D4A5C', textDecoration: 'none', fontSize: '14px', transition: 'background 0.1s' }} 
                               onMouseOver={(e) => e.currentTarget.style.background = '#F4F5F7'} 
                               onMouseOut={(e) => e.currentTarget.style.background = 'transparent'}>
                              <span style={{ width: '18px', textAlign: 'center' }}>📊</span>
                              Dashboard
                            </a>
                            
                            <a href="whats-new.html" style={{ display: 'flex', alignItems: 'center', gap: '12px', padding: '10px 16px', color: '#3D4A5C', textDecoration: 'none', fontSize: '14px', transition: 'background 0.1s' }} 
                               onMouseOver={(e) => e.currentTarget.style.background = '#F4F5F7'} 
                               onMouseOut={(e) => e.currentTarget.style.background = 'transparent'}>
                              <span style={{ width: '18px', textAlign: 'center' }}>✨</span>
                              What's New
                            </a>
                            
                            <div style={{ height: '1px', background: '#E4E7EB', margin: '4px 0' }} />
                            
                            <button 
                              onClick={() => { 
                                setShowProfileMenu(false);
                                supabase?.auth.signOut().then(() => {
                                  window.location.href = 'dashboard.html';
                                });
                              }}
                              style={{ display: 'flex', alignItems: 'center', gap: '12px', padding: '10px 16px', color: '#B84A5A', background: 'none', border: 'none', width: '100%', textAlign: 'left', fontSize: '14px', cursor: 'pointer', fontFamily: 'inherit', transition: 'background 0.1s' }} 
                              onMouseOver={(e) => e.currentTarget.style.background = 'rgba(184, 74, 90, 0.08)'} 
                              onMouseOut={(e) => e.currentTarget.style.background = 'transparent'}
                            >
                              <span style={{ width: '18px', textAlign: 'center' }}>🚪</span>
                              Sign Out
                            </button>
                          </div>
                        )}
                      </div>
                    )}
                  </>
                )}
              </div>
              )}
            </div>
            
            {/* Row 2: View Toggles - Mobile only */}
            {isMobile && !editMode && (
              <div className="no-print header-buttons" style={{ display: 'flex', gap: '6px', alignItems: 'center', flexWrap: 'wrap' }}>
                {/* GROUP 1: View Mode */}
                <div style={{ display: 'flex', borderRadius: '5px', overflow: 'hidden', border: '1px solid rgba(255,255,255,0.35)' }}>
                  <button onClick={() => { setViewMode('stages'); }} style={{ padding: '7px 12px', background: viewMode === 'stages' ? '#556275' : 'transparent', color: '#F4F5F7', border: 'none', cursor: 'pointer', fontFamily: "'Interstate', sans-serif", fontSize: '11px', display: 'flex', alignItems: 'center', gap: '5px' }}>
                    📁 Stages
                  </button>
                  <button onClick={() => setViewMode('steps')} style={{ padding: '7px 12px', background: viewMode === 'steps' ? '#556275' : 'transparent', color: '#F4F5F7', border: 'none', borderLeft: '1px solid rgba(255,255,255,0.25)', cursor: 'pointer', fontFamily: "'Interstate', sans-serif", fontSize: '11px', display: 'flex', alignItems: 'center', gap: '5px' }}>
                    📋 Steps
                  </button>
                </div>
                
                {/* GROUP 2: View Layers */}
                {(showCosts || config.funnel?.enabled) && (
                  <div style={{ display: 'flex', borderRadius: '5px', overflow: 'hidden', border: '1px solid rgba(255,255,255,0.35)' }}>
                    {showCosts && (
                      <button 
                        onClick={() => { 
                          if (highlightOpportunities) {
                            setHighlightOpportunities(false);
                          } else {
                            setHighlightOpportunities(true);
                            setShowFunnel(false);
                          }
                        }} 
                        style={{ 
                          padding: '7px 12px', 
                          background: highlightOpportunities ? '#2D8A6E' : 'transparent', 
                          color: '#F4F5F7', 
                          border: 'none', 
                          cursor: 'pointer', 
                          fontFamily: "'Interstate', sans-serif", 
                          fontSize: '11px',
                          display: 'flex',
                          alignItems: 'center',
                          gap: '5px',
                          borderRight: config.funnel?.enabled ? '1px solid rgba(255,255,255,0.25)' : 'none'
                        }}
                      >
                        🎯
                      </button>
                    )}
                    {config.funnel?.enabled && (
                      <button 
                        onClick={() => { 
                          if (showFunnel) {
                            setShowFunnel(false);
                          } else {
                            setShowFunnel(true);
                            setHighlightOpportunities(false);
                          }
                        }} 
                        style={{ 
                          padding: '7px 12px', 
                          background: showFunnel ? '#5A5B8A' : 'transparent', 
                          color: '#F4F5F7', 
                          border: 'none', 
                          cursor: 'pointer', 
                          fontFamily: "'Interstate', sans-serif", 
                          fontSize: '11px',
                          display: 'flex',
                          alignItems: 'center',
                          gap: '5px'
                        }}
                      >
                        🔻
                      </button>
                    )}
                  </div>
                )}
                
                {/* GROUP 3: Dashboard + Configure Structure */}
                <button 
                  onClick={() => setShowDashboard(true)} 
                  style={{ 
                    padding: '7px 12px', 
                    background: 'transparent', 
                    color: '#F4F5F7', 
                    border: '1px solid rgba(255,255,255,0.35)', 
                    borderRadius: '5px',
                    cursor: 'pointer', 
                    fontFamily: "'Interstate', sans-serif", 
                    fontSize: '11px',
                    display: 'flex',
                    alignItems: 'center',
                    gap: '5px'
                  }}
                >
                  📊
                </button>
                
                <button 
                  onClick={() => setShowStructurePanel(true)} 
                  style={{ 
                    padding: '7px 12px', 
                    background: 'transparent', 
                    color: '#F4F5F7', 
                    border: '1px solid rgba(255,255,255,0.35)', 
                    borderRadius: '5px',
                    cursor: 'pointer', 
                    fontFamily: "'Interstate', sans-serif", 
                    fontSize: '11px',
                    display: 'flex',
                    alignItems: 'center',
                    gap: '5px'
                  }}
                  title="Configure Structure"
                >
                  🏗️
                </button>
                
                {/* Settings - pushed to right */}
                <div style={{ display: 'flex', gap: '6px', alignItems: 'center', marginLeft: 'auto' }}>
                  {/* Settings Dropdown - hidden for view-only users in Supabase mode */}
                  {(!isSupabaseMode || canAccessSettings) && (
                  <div style={{ position: 'relative' }}>
                    <button onClick={(e) => { 
                      e.stopPropagation(); 
                      // In Supabase mode, use role-based access; in legacy mode, use password
                      const hasAccess = isSupabaseMode ? canAccessSettings : isSettingsUnlocked;
                      if (hasAccess) {
                        setShowSettingsMenu(!showSettingsMenu);
                      } else if (!isSupabaseMode) {
                        setShowPasswordPrompt(true);
                      }
                    }} style={{ padding: '7px 10px', background: showSettingsMenu ? '#556275' : 'transparent', color: '#F4F5F7', border: '1px solid rgba(255,255,255,0.35)', borderRadius: '5px', cursor: 'pointer', fontFamily: "'Interstate', sans-serif", fontSize: '11px', display: 'flex', alignItems: 'center', gap: '4px' }} title="Settings">
                      {(isSupabaseMode ? canAccessSettings : isSettingsUnlocked) ? '⚙️' : '🔒'} <span style={{ fontSize: '8px' }}>▼</span>
                    </button>
                    {showSettingsMenu && (isSupabaseMode ? canAccessSettings : isSettingsUnlocked) && (
                      <div onClick={(e) => e.stopPropagation()} style={{ position: 'absolute', top: '100%', right: 0, marginTop: '8px', background: '#FFF', borderRadius: '12px', boxShadow: '0 8px 32px rgba(0,0,0,0.2)', overflow: 'hidden', zIndex: 9999, minWidth: '220px', padding: '8px 0' }}>
                        <div style={{ color: '#6E7B8C', fontSize: '10px', fontWeight: 600, textTransform: 'uppercase', letterSpacing: '0.5px', padding: '8px 16px 4px' }}>Configuration</div>
                        {canEdit && (
                          <button onClick={() => { setShowJourneySettings(true); setShowSettingsMenu(false); }} style={{ display: 'flex', alignItems: 'center', gap: '12px', width: '100%', padding: '10px 16px', border: 'none', background: 'transparent', cursor: 'pointer', textAlign: 'left', fontFamily: "'Interstate', sans-serif", fontSize: '14px', color: '#3D4A5C', transition: 'background 0.1s' }} onMouseOver={(e) => e.currentTarget.style.background = '#F4F5F7'} onMouseOut={(e) => e.currentTarget.style.background = 'transparent'}>
                            <span style={{ width: '18px', textAlign: 'center' }}>⚙️</span> Journey Settings
                            {config.meta?.costModel === 'event' && <span style={{ marginLeft: 'auto', padding: '2px 6px', background: '#FAF0D6', color: '#8B6914', borderRadius: '4px', fontSize: '9px', fontWeight: 600 }}>EVENT</span>}
                          </button>
                        )}
                        {!isSupabaseMode && (
                          <>
                            <div style={{ height: '1px', background: '#E4E7EB', margin: '4px 0' }} />
                            <div style={{ color: '#6E7B8C', fontSize: '10px', fontWeight: 600, textTransform: 'uppercase', letterSpacing: '0.5px', padding: '8px 16px 4px' }}>Data</div>
                            <button onClick={() => { setShowGitHubSettings(true); setShowSettingsMenu(false); }} style={{ display: 'flex', alignItems: 'center', gap: '12px', width: '100%', padding: '10px 16px', border: 'none', background: 'transparent', cursor: 'pointer', textAlign: 'left', fontFamily: "'Interstate', sans-serif", fontSize: '14px', color: '#3D4A5C', transition: 'background 0.1s' }} onMouseOver={(e) => e.currentTarget.style.background = '#F4F5F7'} onMouseOut={(e) => e.currentTarget.style.background = 'transparent'}>
                              <span style={{ width: '18px', textAlign: 'center' }}>🐙</span> GitHub Settings
                            </button>
                          </>
                        )}
                        <div style={{ height: '1px', background: '#E4E7EB', margin: '4px 0' }} />
                        <button 
                          onClick={() => setShowCosts(!showCosts)} 
                          style={{ 
                            display: 'flex', 
                            alignItems: 'center', 
                            gap: '12px', 
                            width: '100%', 
                            padding: '10px 16px', 
                            border: 'none', 
                            background: 'transparent', 
                            cursor: 'pointer', 
                            textAlign: 'left', 
                            fontFamily: "'Interstate', sans-serif", 
                            fontSize: '14px', 
                            color: '#3D4A5C',
                            transition: 'background 0.1s'
                          }} 
                          onMouseOver={(e) => e.currentTarget.style.background = '#F4F5F7'} 
                          onMouseOut={(e) => e.currentTarget.style.background = 'transparent'}
                        >
                          <span style={{ width: '18px', textAlign: 'center' }}>{showCosts ? '💰' : '🚫'}</span> 
                          <span style={{ flex: 1 }}>Cost Data</span>
                          <span style={{ 
                            padding: '3px 10px', 
                            borderRadius: '12px', 
                            fontSize: '10px', 
                            fontWeight: 600,
                            background: showCosts ? 'rgba(45, 138, 110, 0.15)' : 'rgba(184, 74, 90, 0.15)',
                            color: showCosts ? '#2D8A6E' : '#B84A5A'
                          }}>
                            {showCosts ? 'VISIBLE' : 'HIDDEN'}
                          </span>
                        </button>
                      </div>
                    )}
                  </div>
                  )}
                </div>
              </div>
            )}
          </header>

          {/* GitHub Status Toast */}
          {gitHubStatus.message && !showGitHubSettings && (
            <div style={{
              position: 'fixed',
              top: '80px',
              right: '20px',
              padding: '12px 20px',
              background: gitHubStatus.error ? '#F5E0E3' : gitHubStatus.loading ? '#F0F9FF' : '#E1EEF2',
              color: gitHubStatus.error ? '#B84A5A' : gitHubStatus.loading ? '#1D4ED8' : '#2D8A6E',
              borderRadius: '8px',
              boxShadow: '0 4px 12px rgba(0,0,0,0.15)',
              zIndex: 1000,
              fontSize: '14px',
              display: 'flex',
              alignItems: 'center',
              gap: '8px',
              fontFamily: "'Interstate', sans-serif"
            }}>
              {gitHubStatus.loading ? '⏳' : gitHubStatus.error ? '❌' : '✓'}
              {gitHubStatus.message}
            </div>
          )}

          {/* Stats Bar */}
          <div className="stats-bar" style={{ background: '#FFF', borderBottom: '1px solid #E0E0E0', padding: '10px 24px', display: 'flex', gap: '8px', alignItems: 'center', flexWrap: 'wrap', flexShrink: 0 }}>
            <div style={{ display: 'flex', alignItems: 'center', gap: '6px', padding: '6px 12px', background: '#F4F5F7', borderRadius: '6px' }} title="Total Time">
              <span style={{ fontSize: '14px' }}>⏱️</span>
              <span style={{ fontWeight: 600, fontSize: '13px', fontFamily: "'Interstate', sans-serif", color: '#3D4A5C' }}>{formatTime(totalTime)}</span>
            </div>
            <div style={{ display: 'flex', alignItems: 'center', gap: '6px', padding: '6px 12px', background: '#F4F5F7', borderRadius: '6px' }} title="Average Friction">
              <span style={{ fontSize: '14px' }}>{frictionConfig[Math.round(stats.avgFriction) || 3]?.emoji || '😕'}</span>
              <span style={{ fontWeight: 600, fontSize: '13px', fontFamily: "'Interstate', sans-serif", color: frictionConfig[Math.round(stats.avgFriction) || 3]?.color || '#556275' }}>{stats.avgFriction}/5</span>
            </div>
            <div style={{ display: 'flex', alignItems: 'center', gap: '6px', padding: '6px 12px', background: '#F4F5F7', borderRadius: '6px' }} title="Pain Points">
              <span style={{ fontSize: '14px' }}>⚠️</span>
              <span style={{ fontWeight: 600, fontSize: '13px', fontFamily: "'Interstate', sans-serif", color: '#3D4A5C' }}>{stats.totalPainPoints}</span>
            </div>
            <div style={{ display: 'flex', alignItems: 'center', gap: '6px', padding: '6px 12px', background: '#F4F5F7', borderRadius: '6px' }} title="High Improvement Opportunities">
              <span style={{ fontSize: '14px' }}>🎯</span>
              <span style={{ fontWeight: 600, fontSize: '13px', fontFamily: "'Interstate', sans-serif", color: '#3D4A5C' }}>{stats.highAutomation}</span>
            </div>
            <div style={{ display: 'flex', alignItems: 'center', gap: '6px', padding: '6px 12px', background: '#F4F5F7', borderRadius: '6px' }} title="Regulatory Requirements">
              <span style={{ fontSize: '14px' }}>📋</span>
              <span style={{ fontWeight: 600, fontSize: '13px', fontFamily: "'Interstate', sans-serif", color: '#3D4A5C' }}>{stats.totalRegReqs}</span>
            </div>
            {showCosts && (
              <div style={{ display: 'flex', alignItems: 'center', gap: '8px', marginLeft: 'auto' }}>
                <div style={{ display: 'flex', alignItems: 'center', gap: '6px', padding: '6px 12px', background: '#FAF0D6', borderRadius: '6px' }} title="Total Journey Cost">
                  <span style={{ fontSize: '14px' }}>💰</span>
                  <span style={{ fontWeight: 600, color: '#8B6914', fontSize: '14px', fontFamily: "'Interstate', sans-serif" }}>{formatCurrency(stats.totalCost)}</span>
                </div>
                <div style={{ 
                  display: 'flex', 
                  alignItems: 'center', 
                  gap: '6px', 
                  padding: highlightOpportunities ? '6px 12px' : '0', 
                  background: '#2D8A6E', 
                  borderRadius: '6px',
                  maxWidth: highlightOpportunities ? '300px' : '0',
                  opacity: highlightOpportunities ? 1 : 0,
                  overflow: 'hidden',
                  transition: 'max-width 0.3s ease, opacity 0.3s ease, padding 0.3s ease',
                  whiteSpace: 'nowrap'
                }} title="Potential Savings from Improvement Opportunities">
                    <span style={{ fontSize: '14px' }}>✨</span>
                    <span style={{ fontWeight: 600, color: '#FFF', fontSize: '13px', fontFamily: "'Interstate', sans-serif" }}>
                      {(() => {
                        const totalSavings = config.stages.reduce((acc, stage) => 
                          acc + stage.steps.reduce((stepAcc, step) => {
                            const stepCost = calculateStepCost(step, config.personas);
                            const savings = step.automationOpportunity === 'high' ? stepCost * 0.7 
                              : step.automationOpportunity === 'medium' ? stepCost * 0.4 
                              : step.automationOpportunity === 'low' ? stepCost * 0.1 : 0;
                            return stepAcc + savings;
                          }, 0), 0);
                        const percentage = stats.totalCost > 0 ? Math.round((totalSavings / stats.totalCost) * 100) : 0;
                        return `Save ${formatCurrency(totalSavings)} (${percentage}%)`;
                      })()}
                    </span>
                </div>
                {funnelMetrics && (
                  <div style={{ 
                    display: 'flex', 
                    alignItems: 'center', 
                    gap: '8px', 
                    padding: showFunnel ? '6px 12px' : '0',
                    background: '#5A5B8A', 
                    borderRadius: '6px',
                    maxWidth: showFunnel ? '400px' : '0',
                    opacity: showFunnel ? 1 : 0,
                    overflow: 'hidden',
                    transition: 'max-width 0.3s ease, opacity 0.3s ease, padding 0.3s ease',
                    whiteSpace: 'nowrap'
                  }} title="Funnel Analysis">
                    <span style={{ fontSize: '14px' }}>🔻</span>
                    <span style={{ fontWeight: 600, color: '#FFF', fontSize: '13px', fontFamily: "'Interstate', sans-serif" }}>
                      {funnelMetrics.initialVolume}→{funnelMetrics.finalVolume}
                    </span>
                    <span style={{ padding: '2px 6px', borderRadius: '4px', fontSize: '11px', fontWeight: 600, background: 'rgba(255,255,255,0.2)', color: '#FFF' }}>
                      {funnelMetrics.overallConversionRate.toFixed(0)}%
                    </span>
                    <span style={{ color: 'rgba(255,255,255,0.6)', fontSize: '11px' }}>|</span>
                    <span style={{ color: '#FFF', fontSize: '12px' }}>✓{formatCurrency(funnelMetrics.totalStageInvestment)}</span>
                    <span style={{ background: 'rgba(239,68,68,0.9)', padding: '2px 6px', borderRadius: '4px', fontSize: '11px', fontWeight: 600 }}>💸{formatCurrency(funnelMetrics.totalWastedCost)}</span>
                  </div>
                )}
              </div>
            )}
          </div>

          {/* Perspective Filter - only show in steps view */}
          {viewMode === 'steps' && (
            <div className="perspective-filter no-print" style={{ background: '#F9F9F9', borderBottom: '1px solid #E0E0E0', padding: '12px 40px', display: 'flex', gap: '12px', alignItems: 'center', flexWrap: 'wrap' }}>
              <span style={{ fontFamily: "'Interstate', sans-serif", fontSize: '13px', color: '#556275', marginRight: '8px' }}>Filter by perspective:</span>
              
              {/* Desktop: Button row */}
              <div className="perspective-buttons" style={{ display: 'flex', gap: '8px', flexWrap: 'wrap' }}>
                <button onClick={() => setActivePerspective('all')} style={{ padding: '8px 16px', background: activePerspective === 'all' ? '#1A2332' : '#FFF', color: activePerspective === 'all' ? '#FFF' : '#1A2332', border: '1px solid #C8CED6', borderRadius: '20px', cursor: 'pointer', fontFamily: "'Interstate', sans-serif", fontSize: '12px', fontWeight: 500 }}>All</button>
                {config.personas.map(persona => (
                  <button key={persona.id} onClick={() => setActivePerspective(persona.id)} style={{ padding: '8px 16px', background: activePerspective === persona.id ? persona.color : '#FFF', color: activePerspective === persona.id ? '#FFF' : '#1A2332', border: '1px solid #C8CED6', borderRadius: '20px', cursor: 'pointer', fontFamily: "'Interstate', sans-serif", fontSize: '12px', fontWeight: 500 }}>{persona.label}</button>
                ))}
              </div>
              
              {/* Mobile: Dropdown */}
              <div className="perspective-dropdown" style={{ display: 'none' }}>
                <select 
                  value={activePerspective} 
                  onChange={(e) => setActivePerspective(e.target.value)}
                  style={{ 
                    padding: '8px 32px 8px 12px', 
                    background: activePerspective === 'all' ? '#1A2332' : (config.personas.find(p => p.id === activePerspective)?.color || '#1A2332'),
                    color: '#FFF',
                    border: 'none',
                    borderRadius: '20px',
                    cursor: 'pointer',
                    fontFamily: "'Interstate', sans-serif",
                    fontSize: '12px',
                    fontWeight: 500,
                    appearance: 'none',
                    backgroundImage: `url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 12 12'%3E%3Cpath fill='white' d='M3 5l3 3 3-3'/%3E%3C/svg%3E")`,
                    backgroundRepeat: 'no-repeat',
                    backgroundPosition: 'right 10px center'
                  }}
                >
                  <option value="all" style={{ background: '#FFF', color: '#1A2332' }}>All Perspectives</option>
                  {config.personas.map(persona => (
                    <option key={persona.id} value={persona.id} style={{ background: '#FFF', color: '#1A2332' }}>{persona.label}</option>
                  ))}
                </select>
              </div>
            </div>
          )}

          {/* JSON Panel */}
          {showJson && (
            <div className="no-print" style={{ background: '#1E1E1E', color: '#D4D4D4', padding: '20px 40px', fontFamily: "'Monaco', 'Menlo', 'Courier New', monospace", fontSize: '12px', maxHeight: '300px', overflow: 'auto', borderBottom: '1px solid #3D4A5C' }}>
              <pre style={{ margin: 0 }}>{JSON.stringify(config, null, 2)}</pre>
            </div>
          )}

          {/* Main Journey Map */}
          <main className="main-content" style={{ 
            padding: isMobile ? '20px 16px' : '40px', 
            flex: isMobile ? 'none' : 1, 
            overflow: 'visible', 
            display: 'flex', 
            flexDirection: 'column' 
          }}>
            <div className="stages-container" style={{ 
              display: 'flex', 
              flexWrap: 'nowrap',
              gap: '16px', 
              overflowX: 'auto', 
              overflowY: 'visible',
              paddingTop: '16px',
              paddingBottom: '20px', 
              flex: isMobile ? 'none' : 1, 
              alignItems: 'flex-start'
            }}>
              {viewMode === 'stages' ? (
                /* Stages Summary View */
                <>
                  {(() => {
                    // Calculate global ranking of all opportunities
                    const allOpportunitySteps = config.stages.flatMap((stage, stageIdx) => 
                      stage.steps.map(step => {
                        const stepCost = calculateStepCost(step, config.personas);
                        const savings = step.automationOpportunity === 'high' ? stepCost * 0.7 
                          : step.automationOpportunity === 'medium' ? stepCost * 0.4 
                          : step.automationOpportunity === 'low' ? stepCost * 0.1 : 0;
                        return { id: step.id, savings, hasOpportunity: step.automationOpportunity === 'high' || step.automationOpportunity === 'medium' };
                      })
                    ).filter(s => s.hasOpportunity).sort((a, b) => b.savings - a.savings);
                    
                    // Create a map of step id to rank (1-5 for top 5)
                    const opportunityRanks = {};
                    allOpportunitySteps.slice(0, 5).forEach((step, idx) => {
                      opportunityRanks[step.id] = idx + 1;
                    });
                    
                    return config.stages.map((stage, stageIndex) => {
                  const stageTime = stage.steps.reduce((acc, step) => acc + step.timeMinutes, 0);
                  const stageCost = stage.steps.reduce((acc, step) => acc + calculateStepCost(step, config.personas), 0);
                  const totalPainPoints = stage.steps.reduce((acc, step) => acc + (step.painPoints?.length || 0), 0);
                  const totalRegReqs = stage.steps.reduce((acc, step) => acc + (step.regulatoryRequirements?.length || 0), 0);
                  const highAutoOps = stage.steps.filter(step => step.automationOpportunity === 'high').length;
                  const medAutoOps = stage.steps.filter(step => step.automationOpportunity === 'medium').length;
                  const checkpointCount = stage.steps.filter(step => step.isHardCheckpoint).length;
                  const maxStepTime = Math.max(...stage.steps.map(s => s.timeMinutes), 1);
                  const stageColor = getStageColor(stageIndex);
                  const stageColorLight = getStageColor(stageIndex, 'light');
                  
                  // Get funnel metrics for this stage
                  const stageFunnelData = funnelMetrics?.stageMetrics?.[stageIndex];
                  
                  // Calculate stage-level savings
                  const stageSavings = stage.steps.reduce((acc, step) => {
                    const stepCost = calculateStepCost(step, config.personas);
                    const savings = step.automationOpportunity === 'high' ? stepCost * 0.7 
                      : step.automationOpportunity === 'medium' ? stepCost * 0.4 
                      : step.automationOpportunity === 'low' ? stepCost * 0.1 : 0;
                    return acc + savings;
                  }, 0);
                  const stageTimeSavings = stage.steps.reduce((acc, step) => {
                    const savings = step.automationOpportunity === 'high' ? step.timeMinutes * 0.7 
                      : step.automationOpportunity === 'medium' ? step.timeMinutes * 0.4 
                      : step.automationOpportunity === 'low' ? step.timeMinutes * 0.1 : 0;
                    return acc + savings;
                  }, 0);
                  const hasOpportunities = highAutoOps > 0 || medAutoOps > 0;
                  
                  return (
                    <div key={stage.id} className="stage-card" style={{ 
                      flex: '0 0 auto', 
                      width: '320px',
                      minWidth: '280px',
                      maxWidth: '400px',
                      background: '#FFF', 
                      borderRadius: '12px', 
                      overflow: 'visible',
                      boxShadow: '0 4px 16px rgba(0,0,0,0.1)',
                      display: 'flex',
                      flexDirection: 'column',
                      maxHeight: isMobile ? 'none' : '100%',
                      position: 'relative'
                    }}>
                      {/* Stage Header */}
                      <div style={{ 
                        background: getStageColor(stageIndex), 
                        padding: '16px 20px',
                        color: '#FFF',
                        flexShrink: 0,
                        borderRadius: '12px 12px 0 0'
                      }}>
                        {/* Top row: Stage title and time/cost */}
                        <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'flex-start' }}>
                          <div>
                            <div style={{ fontSize: '10px', opacity: 0.7, textTransform: 'uppercase', letterSpacing: '0.5px', marginBottom: '2px' }}>Stage {stageIndex + 1}</div>
                            <h2 style={{ margin: 0, fontSize: '18px', fontWeight: 600, lineHeight: 1.2 }}>{stage.name}</h2>
                          </div>
                          <div style={{ textAlign: 'right' }}>
                            <div style={{ fontSize: '16px', fontWeight: 600 }}>{formatTime(stageTime)}</div>
                            {showCosts && <div style={{ fontSize: '12px', opacity: 0.8 }}>{formatCurrency(stageCost)}</div>}
                          </div>
                        </div>
                        
                        {/* Funnel row (when enabled) */}
                        {stageFunnelData && (
                          <div className="funnel-stat" style={{ 
                            marginTop: showFunnel ? '12px' : '0', 
                            paddingTop: showFunnel ? '12px' : '0',
                            maxHeight: showFunnel ? '100px' : '0',
                            opacity: showFunnel ? 1 : 0,
                            overflow: 'hidden',
                            borderTop: showFunnel ? '1px solid rgba(255,255,255,0.2)' : '1px solid transparent',
                            display: 'flex',
                            alignItems: 'center',
                            gap: '12px',
                            flexWrap: 'wrap',
                            transition: 'max-height 0.3s ease, opacity 0.3s ease, margin 0.3s ease, padding 0.3s ease, border 0.3s ease'
                          }}>
                            <div style={{ display: 'flex', alignItems: 'center', gap: '6px' }}>
                              <span style={{ fontSize: '14px', fontWeight: 600 }}>{stageFunnelData.entryVolume.toLocaleString()}</span>
                              <span style={{ fontSize: '11px', opacity: 0.7 }}>→</span>
                              {stageFunnelData.dropOff > 0 && (
                                <span style={{ fontSize: '11px', background: 'rgba(239,68,68,0.9)', padding: '2px 6px', borderRadius: '4px', fontWeight: 600 }}>-{stageFunnelData.dropOff.toLocaleString()}</span>
                              )}
                              <span style={{ fontSize: '11px', opacity: 0.7 }}>→</span>
                              <span style={{ fontSize: '14px', fontWeight: 600, color: '#86EFAC' }}>{stageFunnelData.exitVolume.toLocaleString()}</span>
                            </div>
                            <span style={{ 
                              padding: '2px 8px', 
                              borderRadius: '10px', 
                              fontSize: '11px',
                              background: stageFunnelData.completionRate >= 90 ? 'rgba(134,239,172,0.3)' : stageFunnelData.completionRate >= 70 ? 'rgba(253,224,71,0.3)' : 'rgba(252,165,165,0.3)',
                              fontWeight: 600
                            }}>
                              {stageFunnelData.completionRate.toFixed(0)}% pass
                            </span>
                            {showCosts && (
                              <div style={{ display: 'flex', alignItems: 'center', gap: '6px', fontSize: '11px' }}>
                                <span style={{ opacity: 0.85 }}>✓ {formatCurrency(stageFunnelData.stageInvestment)}</span>
                                {stageFunnelData.wastedCost > 0 && (
                                  <span style={{ 
                                    background: 'rgba(239,68,68,0.9)', 
                                    padding: '2px 8px', 
                                    borderRadius: '4px', 
                                    fontWeight: 600 
                                  }}>
                                    💸 {formatCurrency(stageFunnelData.wastedCost)}
                                  </span>
                                )}
                              </div>
                            )}
                          </div>
                        )}
                      </div>
                      
                      {/* Stage Body */}
                      <div style={{ padding: '16px 20px', flex: isMobile ? 'none' : 1, overflowY: isMobile ? 'visible' : 'auto', overflowX: 'visible', borderRadius: '0 0 12px 12px' }}>
                        {/* Steps List */}
                        <div style={{ marginBottom: '16px', overflow: 'visible' }}>
                          <div style={{ fontSize: '11px', color: '#8A95A5', textTransform: 'uppercase', letterSpacing: '0.5px', marginBottom: '8px' }}>
                            {stage.steps.length} Steps
                          </div>
                          <div style={{ display: 'flex', flexDirection: 'column', gap: highlightOpportunities ? '8px' : '6px', paddingTop: highlightOpportunities ? '12px' : 0, paddingLeft: highlightOpportunities ? '12px' : 0, overflow: 'visible' }}>
                            {stage.steps.map((step, idx) => {
                              const timeBarWidth = maxStepTime > 0 ? (step.timeMinutes / maxStepTime) * 100 : 0;
                              const isHighOpp = step.automationOpportunity === 'high';
                              const isMedOpp = step.automationOpportunity === 'medium';
                              const stepCost = calculateStepCost(step, config.personas);
                              const stepSavings = isHighOpp ? stepCost * 0.7 : isMedOpp ? stepCost * 0.4 : 0;
                              const stepTimeSavings = isHighOpp ? step.timeMinutes * 0.7 : isMedOpp ? step.timeMinutes * 0.4 : 0;
                              const showOppHighlight = highlightOpportunities && (isHighOpp || isMedOpp);
                              const isTopFive = opportunityRanks[step.id] !== undefined;
                              return (
                              <div key={step.id} className="step-item" style={{ 
                                display: 'flex', 
                                alignItems: 'center', 
                                gap: '8px',
                                padding: '8px 12px',
                                background: showOppHighlight 
                                  ? (isTopFive 
                                    ? (isHighOpp ? 'linear-gradient(90deg, #D4EDE5 0%, #96BCC7 100%)' : 'linear-gradient(90deg, #FAF0D6 0%, #F0DDA8 100%)')
                                    : (isHighOpp ? '#E1EEF2' : '#FAF0D6'))
                                  : '#F4F5F7',
                                borderRadius: '6px',
                                fontSize: '13px',
                                border: showOppHighlight 
                                  ? (isTopFive
                                    ? (isHighOpp ? '2px solid #96BCC7' : '2px solid #FCD34D')
                                    : (isHighOpp ? '1px solid #BBF7D0' : '1px solid #FEF08A'))
                                  : '1px solid transparent',
                                position: 'relative',
                                overflow: 'visible',
                                marginTop: showOppHighlight && isTopFive ? '6px' : 0,
                                marginLeft: showOppHighlight && isTopFive ? '6px' : 0
                              }}>
                                {/* Top 5 Ranking Badge - overlaid in top-left corner */}
                                {showOppHighlight && isTopFive && (
                                  <span className="ranking-badge" style={{ 
                                    position: 'absolute',
                                    top: '-10px',
                                    left: '-10px',
                                    zIndex: 2,
                                    display: 'inline-flex',
                                    alignItems: 'center',
                                    justifyContent: 'center',
                                    width: '24px',
                                    height: '24px',
                                    borderRadius: '50%',
                                    background: isHighOpp ? '#2D8A6E' : '#C4942A',
                                    color: '#FFF',
                                    fontSize: '12px',
                                    fontWeight: 700,
                                    boxShadow: '0 2px 6px rgba(0,0,0,0.25)',
                                    flexShrink: 0
                                  }}>
                                    {opportunityRanks[step.id]}
                                  </span>
                                )}
                                {/* Time Bar Background - only show when not highlighting opportunities */}
                                {!showOppHighlight && (
                                  <div style={{
                                    position: 'absolute',
                                    top: 0,
                                    left: 0,
                                    width: `${timeBarWidth}%`,
                                    height: '100%',
                                    background: stageColorLight,
                                    opacity: 0.25,
                                    transition: 'width 0.3s ease',
                                    zIndex: 0
                                  }} />
                                )}
                                <span style={{ color: '#8A95A5', fontWeight: 500, minWidth: '24px', position: 'relative', zIndex: 1 }}>{stageIndex + 1}.{idx + 1}</span>
                                {step.isHardCheckpoint && <span style={{ fontSize: '12px', position: 'relative', zIndex: 1 }}>🚧</span>}
                                <span style={{ flex: 1, color: showOppHighlight ? (isHighOpp ? '#2D8A6E' : '#8B6914') : step.isHardCheckpoint ? '#B84A5A' : '#3D4A5C', position: 'relative', zIndex: 1, fontWeight: showOppHighlight && isTopFive ? 600 : showOppHighlight ? 500 : 400, opacity: showOppHighlight && !isTopFive ? 0.8 : 1 }}>{step.name}</span>
                                {showOppHighlight ? (
                                  <span style={{ color: isHighOpp ? '#2D8A6E' : '#8B6914', fontSize: '11px', position: 'relative', zIndex: 1, fontWeight: isTopFive ? 700 : 500, opacity: isTopFive ? 1 : 0.7 }}>
                                    {formatTime(Math.round(stepTimeSavings))} · {formatCurrency(stepSavings)} ({isHighOpp ? '70' : '40'}%)
                                  </span>
                                ) : (
                                  <span style={{ color: '#556275', fontSize: '12px', position: 'relative', zIndex: 1 }}>{formatTime(step.timeMinutes)}</span>
                                )}
                              </div>
                            );})}
                          </div>
                        </div>
                        
                        {/* Savings Summary - show when highlighting opportunities */}
                        {highlightOpportunities && hasOpportunities && (
                          <div className="savings-panel" style={{ 
                            padding: '12px 16px', 
                            background: 'linear-gradient(135deg, #2D8A6E 0%, #2D8A6E 100%)', 
                            borderRadius: '8px',
                            marginBottom: '16px',
                            color: '#FFF'
                          }}>
                            <div style={{ fontSize: '11px', opacity: 0.9, textTransform: 'uppercase', letterSpacing: '0.5px', marginBottom: '4px' }}>
                              Potential Savings
                            </div>
                            <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center' }}>
                              <div style={{ fontSize: '18px', fontWeight: 700 }}>
                                {formatTime(Math.round(stageTimeSavings))}
                              </div>
                              <div style={{ fontSize: '18px', fontWeight: 700 }}>
                                {formatCurrency(stageSavings)} ({stageCost > 0 ? Math.round((stageSavings / stageCost) * 100) : 0}%)
                              </div>
                            </div>
                          </div>
                        )}
                        
                        {/* Badges Row */}
                        <div style={{ display: 'flex', gap: '8px', flexWrap: 'wrap', paddingTop: '16px', borderTop: '1px solid #EEE' }}>
                          {highAutoOps > 0 && (
                            <div style={{ 
                              display: 'flex', 
                              alignItems: 'center', 
                              gap: '6px', 
                              padding: '6px 12px', 
                              background: '#D4EDE5', 
                              borderRadius: '16px',
                              fontSize: '12px',
                              color: '#2D8A6E',
                              cursor: 'default'
                            }}
                            title={`${highAutoOps} high improvement opportunit${highAutoOps !== 1 ? 'ies' : 'y'}`}>
                              <span>🎯</span>
                              <span>{highAutoOps} high</span>
                            </div>
                          )}
                          {medAutoOps > 0 && (
                            <div style={{ 
                              display: 'flex', 
                              alignItems: 'center', 
                              gap: '6px', 
                              padding: '6px 12px', 
                              background: '#FAF0D6', 
                              borderRadius: '16px',
                              fontSize: '12px',
                              color: '#8B6914',
                              cursor: 'default'
                            }}
                            title={`${medAutoOps} medium improvement opportunit${medAutoOps !== 1 ? 'ies' : 'y'}`}>
                              <span>🎯</span>
                              <span>{medAutoOps} medium</span>
                            </div>
                          )}
                          {totalPainPoints > 0 && (
                            <div style={{ 
                              display: 'flex', 
                              alignItems: 'center', 
                              gap: '6px', 
                              padding: '6px 12px', 
                              background: '#F5E0E3', 
                              borderRadius: '16px',
                              fontSize: '12px',
                              color: '#B84A5A',
                              cursor: 'default'
                            }}
                            title={`${totalPainPoints} pain point${totalPainPoints !== 1 ? 's' : ''}`}>
                              <span>⚠️</span>
                              <span>{totalPainPoints} pain</span>
                            </div>
                          )}
                          {totalRegReqs > 0 && (
                            <div style={{ 
                              display: 'flex', 
                              alignItems: 'center', 
                              gap: '6px', 
                              padding: '6px 12px', 
                              background: '#E1EEF2', 
                              borderRadius: '16px',
                              fontSize: '12px',
                              color: '#5A5B8A',
                              cursor: 'default'
                            }}
                            title={`${totalRegReqs} regulatory requirement${totalRegReqs !== 1 ? 's' : ''}`}>
                              <span>📋</span>
                              <span>{totalRegReqs} reg</span>
                            </div>
                          )}
                          {checkpointCount > 0 && (
                            <div style={{ 
                              display: 'flex', 
                              alignItems: 'center', 
                              gap: '6px', 
                              padding: '6px 12px', 
                              background: '#FEF3C7', 
                              borderRadius: '16px',
                              fontSize: '12px',
                              color: '#92400E',
                              cursor: 'default'
                            }}
                            title={`${checkpointCount} checkpoint${checkpointCount !== 1 ? 's' : ''}`}>
                              <span>🚧</span>
                              <span>{checkpointCount} checkpoint{checkpointCount !== 1 ? 's' : ''}</span>
                            </div>
                          )}
                        </div>
                      </div>
                    </div>
                  );
                })
                  })()}
                </>
              ) : (
                /* Steps Detail View (existing) */
                <>
                {config.stages.map((stage, stageIndex) => {
                const stageTime = stage.steps.reduce((acc, step) => acc + step.timeMinutes, 0);
                const stageCost = stage.steps.reduce((acc, step) => acc + calculateStepCost(step, config.personas), 0);
                const stageFunnelData = funnelMetrics?.stageMetrics?.[stageIndex];
                return (
                  <div key={stage.id} className="stage-card" style={{ 
                    flex: stage.steps.length > 0 ? `${stage.steps.length} 0 ${stage.steps.length * 220}px` : '0 0 220px', 
                    minWidth: stage.steps.length > 0 ? stage.steps.length * 220 + 'px' : '220px',
                    borderRadius: '12px',
                    overflow: 'visible',
                    boxShadow: '0 4px 16px rgba(0,0,0,0.1)',
                    position: 'relative'
                  }}>
                    {/* Stage Header */}
                    <div style={{ background: getStageColor(stageIndex), padding: '16px 20px', color: '#FFF', borderRadius: '12px 12px 0 0' }}>
                      <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'flex-start' }}>
                        <div>
                          <div style={{ fontSize: '10px', opacity: 0.7, textTransform: 'uppercase', letterSpacing: '0.5px', marginBottom: '2px' }}>Stage {stageIndex + 1}</div>
                          {editMode ? (
                            <input 
                              type="text" 
                              value={stage.name} 
                              onChange={(e) => updateStage(stage.id, { name: e.target.value })}
                              onClick={(e) => e.stopPropagation()}
                              style={{ 
                                background: 'rgba(255,255,255,0.9)', 
                                border: 'none', 
                                borderRadius: '4px', 
                                padding: '6px 10px', 
                                fontSize: '18px', 
                                fontWeight: 600, 
                                color: '#1A2332', 
                                fontFamily: "'Interstate', sans-serif", 
                                width: `${Math.max(120, Math.min(300, stage.name.length * 11 + 20))}px`
                              }}
                            />
                          ) : (
                            <h2 style={{ margin: 0, fontSize: '18px', fontWeight: 600, lineHeight: 1.2 }}>{stage.name}</h2>
                          )}
                        </div>
                        <div style={{ textAlign: 'right' }}>
                          <div style={{ fontSize: '16px', fontWeight: 600 }}>{formatTime(stageTime)}</div>
                          {showCosts && <div style={{ fontSize: '12px', opacity: 0.8 }}>{formatCurrency(stageCost)}</div>}
                        </div>
                      </div>
                      
                      {/* Funnel row (when enabled) */}
                      {stageFunnelData && (
                        <div className="funnel-stat" style={{ 
                          marginTop: showFunnel ? '12px' : '0', 
                          paddingTop: showFunnel ? '12px' : '0',
                          maxHeight: showFunnel ? '100px' : '0',
                          opacity: showFunnel ? 1 : 0,
                          overflow: 'hidden',
                          borderTop: showFunnel ? '1px solid rgba(255,255,255,0.2)' : '1px solid transparent',
                          display: 'flex',
                          alignItems: 'center',
                          gap: '12px',
                          flexWrap: 'wrap',
                          transition: 'max-height 0.3s ease, opacity 0.3s ease, margin 0.3s ease, padding 0.3s ease, border 0.3s ease'
                        }}>
                          <div style={{ display: 'flex', alignItems: 'center', gap: '6px' }}>
                            <span style={{ fontSize: '14px', fontWeight: 600 }}>{stageFunnelData.entryVolume.toLocaleString()}</span>
                            <span style={{ fontSize: '11px', opacity: 0.7 }}>→</span>
                            {stageFunnelData.dropOff > 0 && (
                              <span style={{ fontSize: '11px', background: 'rgba(239,68,68,0.9)', padding: '2px 6px', borderRadius: '4px', fontWeight: 600 }}>-{stageFunnelData.dropOff.toLocaleString()}</span>
                            )}
                            <span style={{ fontSize: '11px', opacity: 0.7 }}>→</span>
                            <span style={{ fontSize: '14px', fontWeight: 600, color: '#86EFAC' }}>{stageFunnelData.exitVolume.toLocaleString()}</span>
                          </div>
                          <span style={{ 
                            padding: '2px 8px', 
                            borderRadius: '10px', 
                            fontSize: '11px',
                            background: stageFunnelData.completionRate >= 90 ? 'rgba(134,239,172,0.3)' : stageFunnelData.completionRate >= 70 ? 'rgba(253,224,71,0.3)' : 'rgba(252,165,165,0.3)',
                            fontWeight: 600
                          }}>
                            {stageFunnelData.completionRate.toFixed(0)}% pass
                          </span>
                          {showCosts && (
                            <div style={{ display: 'flex', alignItems: 'center', gap: '6px', fontSize: '11px' }}>
                              <span style={{ opacity: 0.85 }}>✓ {formatCurrency(stageFunnelData.stageInvestment)}</span>
                              {stageFunnelData.wastedCost > 0 && (
                                <span style={{ 
                                  background: 'rgba(239,68,68,0.9)', 
                                  padding: '2px 8px', 
                                  borderRadius: '4px', 
                                  fontWeight: 600 
                                }}>
                                  💸 {formatCurrency(stageFunnelData.wastedCost)}
                                </span>
                              )}
                            </div>
                          )}
                        </div>
                      )}
                    </div>

                    {/* Steps Row */}
                    <div style={{ 
                      display: 'flex', 
                      background: '#FFF',
                      alignItems: 'stretch',
                      borderRadius: '0 0 12px 12px',
                      overflow: 'visible',
                      paddingTop: highlightOpportunities ? '14px' : '0'
                    }}>
                      {stage.steps.map((step, stepIndex) => {
                        const isSelected = selectedStep?.id === step.id;
                        const isFiltered = activePerspective !== 'all' && !step.actions[activePerspective] && step.owner !== activePerspective && !(activePerspective === 'client' && step.clientTouchpoint);
                        const stepCost = calculateStepCost(step, config.personas);
                        const costPerMinute = step.timeMinutes > 0 ? stepCost / step.timeMinutes : 0;
                        const automationSavings = step.automationOpportunity === 'high' ? stepCost * 0.7 
                          : step.automationOpportunity === 'medium' ? stepCost * 0.4 
                          : step.automationOpportunity === 'low' ? stepCost * 0.1 : 0;
                        const timeSavings = step.automationOpportunity === 'high' ? step.timeMinutes * 0.7 
                          : step.automationOpportunity === 'medium' ? step.timeMinutes * 0.4 
                          : step.automationOpportunity === 'low' ? step.timeMinutes * 0.1 : 0;
                        const isHighOpportunity = highlightOpportunities && step.automationOpportunity === 'high' && stepCost > 50;
                        const isMediumOpportunity = highlightOpportunities && step.automationOpportunity === 'medium' && stepCost > 100;
                        const stageColor = getStageColor(stageIndex);
                        const stageColorDark = getStageColor(stageIndex, 'dark');
                        
                        const isFirstStep = stepIndex === 0;
                        
                        return (
                          <div key={step.id} className="step-card" onClick={() => setSelectedStep(isSelected ? null : { ...step, stageId: stage.id, stageIndex })} style={{ 
                            flex: '1 0 218px', 
                            background: isSelected ? '#FFF' : isHighOpportunity ? 'linear-gradient(135deg, #D4EDE5 0%, #96BCC7 100%)' : isMediumOpportunity ? 'linear-gradient(135deg, #FAF0D6 0%, #F0DDA8 100%)' : '#FFF', 
                            padding: '20px', 
                            cursor: 'pointer', 
                            opacity: isFiltered ? 0.4 : 1, 
                            borderLeft: isFirstStep ? 'none' : (isHighOpportunity || isMediumOpportunity) ? 'none' : '1px solid #E4E7EB',
                            display: 'flex', 
                            flexDirection: 'column', 
                            position: 'relative',
                            boxShadow: isSelected 
                              ? `0 0 0 2px ${stageColorDark}, 0 8px 24px rgba(0, 0, 0, 0.15)` 
                              : isHighOpportunity 
                                ? 'inset 0 0 0 2px #2D8A6E' 
                                : isMediumOpportunity 
                                  ? 'inset 0 0 0 2px #C4942A' 
                                  : 'none',
                            borderRadius: (isSelected || isHighOpportunity || isMediumOpportunity) ? '8px' : '0',
                            transform: isSelected ? 'translateY(-2px)' : 'none',
                            transition: 'all 0.15s ease',
                            zIndex: isSelected ? 10 : (isHighOpportunity || isMediumOpportunity) ? 5 : 1
                          }}>
                            {/* Opportunity Badge */}
                            {showCosts && (isHighOpportunity || isMediumOpportunity) && (
                              <div style={{
                                position: 'absolute',
                                top: '-8px',
                                right: '12px',
                                background: isHighOpportunity ? '#2D8A6E' : '#C4942A',
                                color: '#FFF',
                                padding: '4px 10px',
                                borderRadius: '12px',
                                fontSize: '10px',
                                fontFamily: "'Interstate', sans-serif",
                                fontWeight: 600,
                                display: 'flex',
                                alignItems: 'center',
                                gap: '4px',
                                boxShadow: '0 2px 4px rgba(0,0,0,0.1)'
                              }}>
                                🎯 Save {formatTime(Math.round(timeSavings))} · {formatCurrency(automationSavings)} ({step.automationOpportunity === 'high' ? '70' : '40'}%)
                              </div>
                            )}
                            <div style={{ display: 'flex', justifyContent: 'space-between', marginBottom: '12px' }}>
                              <span style={{ fontFamily: "'Interstate', sans-serif", fontSize: '11px', color: '#8A95A5', textTransform: 'uppercase', letterSpacing: '0.5px' }}>Step {stageIndex + 1}.{stepIndex + 1}</span>
                              <div style={{ display: 'flex', gap: '6px', alignItems: 'center' }}>
                                <span style={{ fontFamily: "'Interstate', sans-serif", fontSize: '12px', color: '#556275', background: '#E9EEF4', padding: '2px 8px', borderRadius: '10px' }}>{formatTime(step.timeMinutes)}</span>
                                {showCosts && (
                                  <span style={{ fontFamily: "'Interstate', sans-serif", fontSize: '12px', color: '#8B6914', background: '#FAF0D6', padding: '2px 8px', borderRadius: '10px', fontWeight: 500 }}>
                                    {formatCurrency(stepCost)}
                                    {highlightOpportunities && <span style={{ fontSize: '10px', marginLeft: '3px', opacity: 0.8 }}>({formatCurrencyDetailed(costPerMinute)}/m)</span>}
                                  </span>
                                )}
                              </div>
                            </div>
                            {editMode ? (
                              <textarea 
                                value={step.name} 
                                onChange={(e) => updateStep(stage.id, step.id, { name: e.target.value })}
                                onClick={(e) => e.stopPropagation()}
                                rows={step.name.length > 25 ? 2 : 1}
                                style={{ 
                                  margin: '0 0 8px', 
                                  fontSize: '16px', 
                                  fontWeight: 600, 
                                  lineHeight: 1.3, 
                                  width: '100%', 
                                  padding: '4px 6px', 
                                  border: '1px solid #C8CED6', 
                                  borderRadius: '4px', 
                                  fontFamily: "'Interstate', sans-serif",
                                  resize: 'none',
                                  overflow: 'hidden'
                                }}
                              />
                            ) : (
                              <h3 style={{ margin: '0 0 8px', fontSize: '16px', fontWeight: 600, lineHeight: 1.3, paddingRight: '20px' }}>{step.name}</h3>
                            )}
                            {editMode ? (
                              <textarea 
                                value={step.description} 
                                onChange={(e) => updateStep(stage.id, step.id, { description: e.target.value })}
                                onClick={(e) => e.stopPropagation()}
                                rows={2}
                                style={{ margin: '0 0 12px', fontSize: '13px', lineHeight: 1.5, color: '#555', fontFamily: "'Interstate', sans-serif", width: '100%', padding: '4px 6px', border: '1px solid #C8CED6', borderRadius: '4px', resize: 'vertical' }}
                              />
                            ) : (
                              <p style={{ margin: '0 0 12px', fontSize: '13px', lineHeight: 1.5, color: '#555', fontFamily: "'Interstate', sans-serif" }}>{step.description}</p>
                            )}
                            {/* Role involvement list */}
                            <div style={{ display: 'flex', flexDirection: 'column', gap: '4px', marginBottom: '10px' }}>
                              {(() => {
                                const involvedRoles = Object.entries(step.roleInvolvement || {})
                                  .filter(([roleId, inv]) => inv.timeMinutes > 0)
                                  .map(([roleId, inv]) => ({
                                    roleId,
                                    ...inv,
                                    persona: config.personas.find(p => p.id === roleId),
                                    isOwner: roleId === step.owner
                                  }))
                                  .sort((a, b) => {
                                    if (a.isOwner) return -1;
                                    if (b.isOwner) return 1;
                                    return b.timeMinutes - a.timeMinutes;
                                  });
                                
                                return involvedRoles.map((role, idx) => (
                                  <div key={role.roleId} style={{ display: 'inline-flex', alignItems: 'center', gap: '6px' }}>
                                    <span style={{ width: '8px', height: '8px', borderRadius: '50%', background: role.isOwner ? (role.persona?.color || '#556275') : 'transparent', border: role.isOwner ? 'none' : `2px solid ${role.persona?.color || '#556275'}`, boxSizing: 'border-box' }} />
                                    <span style={{ fontFamily: "'Interstate', sans-serif", fontSize: '11px', color: role.persona?.color || '#556275', fontWeight: role.isOwner ? 600 : 400 }}>
                                      {role.persona?.label || role.roleId}
                                    </span>
                                    <span style={{ fontFamily: "'Interstate', sans-serif", fontSize: '10px', color: '#8A95A5' }}>
                                      {formatTime(role.timeMinutes)}{role.headcount > 1 ? ` × ${role.headcount}` : ''}
                                    </span>
                                  </div>
                                ));
                              })()}
                            </div>
                            <div style={{ display: 'flex', gap: '8px', marginBottom: '8px', flexWrap: 'wrap' }}>
                              <div style={{ display: 'flex', alignItems: 'center', gap: '4px', padding: '4px 8px', background: frictionConfig[step.frictionScore || 3]?.bg || '#F4F5F7', borderRadius: '12px' }}>
                                <span style={{ fontSize: '10px' }}>{frictionConfig[step.frictionScore || 3]?.emoji || '😕'}</span>
                                <div style={{ display: 'flex', gap: '2px' }}>
                                  {[1,2,3,4,5].map(n => (<div key={n} style={{ width: '6px', height: '6px', borderRadius: '1px', background: n <= (step.frictionScore || 3) ? frictionConfig[step.frictionScore || 3]?.color : '#C8CED6' }} />))}
                                </div>
                              </div>
                              <div style={{ display: 'flex', alignItems: 'center', gap: '4px', padding: '4px 8px', background: automationColors[step.automationOpportunity]?.bg || '#F4F5F7', borderRadius: '12px' }}>
                                <span style={{ fontSize: '10px' }}>🎯</span>
                                <span style={{ fontFamily: "'Interstate', sans-serif", fontSize: '10px', color: automationColors[step.automationOpportunity]?.text || '#556275', fontWeight: 500 }}>{automationColors[step.automationOpportunity]?.label || 'N/A'}</span>
                              </div>
                              {step.clientTouchpoint && (
                                <div style={{ display: 'flex', alignItems: 'center', gap: '4px', padding: '4px 8px', background: '#D4EDE5', borderRadius: '12px', border: '1px solid #2D8A6E' }}>
                                  <span style={{ fontSize: '10px' }}>👤</span>
                                  <span style={{ fontFamily: "'Interstate', sans-serif", fontSize: '10px', color: '#2D8A6E', fontWeight: 500 }}>Client</span>
                                </div>
                              )}
                            </div>
                            {(() => {
                              const stepEmotions = Array.isArray(step.emotions) ? step.emotions : (step.emotions ? [step.emotions] : []);
                              return stepEmotions.length > 0 && (
                                <div style={{ display: 'flex', flexWrap: 'wrap', gap: '4px', marginBottom: '8px' }}>
                                  {stepEmotions.map(emotion => (
                                    <div key={emotion} style={{ display: 'inline-flex', alignItems: 'center', gap: '4px', padding: '4px 8px', background: emotionColors[emotion]?.bg || '#F4F5F7', borderRadius: '12px' }}>
                                      <span style={{ fontSize: '12px' }}>{emotionColors[emotion]?.icon || '😐'}</span>
                                      <span style={{ fontFamily: "'Interstate', sans-serif", fontSize: '10px', color: emotionColors[emotion]?.text || '#556275', textTransform: 'capitalize', fontWeight: 500 }}>{emotion}</span>
                                    </div>
                                  ))}
                                </div>
                              );
                            })()}
                            {/* Spacer to push reg reqs and pain points to bottom */}
                            <div style={{ flex: 1 }} />
                            {/* Checkpoint indicator */}
                            {step.isHardCheckpoint && (
                              <div 
                                className="tooltip" 
                                data-tooltip={`${(step.checkpointType || 'Compliance').charAt(0).toUpperCase() + (step.checkpointType || 'compliance').slice(1)}: ${step.checkpointDetails || 'Must be completed before proceeding'}`}
                                style={{ display: 'flex', alignItems: 'center', gap: '8px', padding: '10px 12px', background: '#F5E0E3', borderRadius: '6px', border: '2px solid #B84A5A', marginBottom: '8px', cursor: 'help' }}
                              >
                                <span style={{ fontSize: '16px' }}>🚧</span>
                                <div style={{ fontFamily: "'Interstate', sans-serif", fontSize: '12px', color: '#B84A5A', fontWeight: 600, textTransform: 'uppercase', letterSpacing: '0.5px' }}>Checkpoint</div>
                              </div>
                            )}
                            {/* Reg requirements and Pain points at bottom */}
                            <div style={{ display: 'flex', flexDirection: 'column', gap: '6px' }}>
                              {step.regulatoryRequirements?.length > 0 && (
                                <div 
                                  className="tooltip" 
                                  data-tooltip={step.regulatoryRequirements.join(' • ')}
                                  style={{ display: 'flex', alignItems: 'center', gap: '6px', padding: '8px 12px', background: '#E1EEF2', borderRadius: '6px', cursor: 'help' }}
                                >
                                  <span style={{ fontSize: '14px' }}>📋</span>
                                  <span style={{ fontFamily: "'Interstate', sans-serif", fontSize: '12px', color: '#5A5B8A', fontWeight: 500 }}>{step.regulatoryRequirements.length} reg. requirement{step.regulatoryRequirements.length > 1 ? 's' : ''}</span>
                                </div>
                              )}
                              {step.painPoints.length > 0 && (
                                <div 
                                  className="tooltip" 
                                  data-tooltip={step.painPoints.join(' • ')}
                                  style={{ display: 'flex', alignItems: 'center', gap: '6px', padding: '8px 12px', background: '#F5E0E3', borderRadius: '6px', cursor: 'help' }}
                                >
                                  <span style={{ fontSize: '14px' }}>⚠️</span>
                                  <span style={{ fontFamily: "'Interstate', sans-serif", fontSize: '12px', color: '#B84A5A', fontWeight: 500 }}>{step.painPoints.length} pain point{step.painPoints.length > 1 ? 's' : ''}</span>
                                </div>
                              )}
                            </div>
                          </div>
                        );
                      })}
                    </div>
                  </div>
                );
                })
                }
                </>
              )}
            </div>

            {/* Selected Step Detail Panel - slide-out modal on desktop, inline on mobile */}
            {selectedStep && (
              <>
                {/* Overlay - desktop only */}
                {!isMobile && (
                  <div 
                    onClick={() => setSelectedStep(null)} 
                    style={{ 
                      position: 'fixed', 
                      top: 0, 
                      left: 0, 
                      right: 0, 
                      bottom: 0, 
                      background: 'rgba(0,0,0,0.3)', 
                      zIndex: 1999 
                    }} 
                  />
                )}
                {/* Panel */}
                <div className="no-print" style={ isMobile ? {
                  marginTop: '32px',
                  background: '#FFF', 
                  borderRadius: '12px',
                  boxShadow: '0 4px 24px rgba(0,0,0,0.08)',
                  overflow: 'hidden'
                } : { 
                  position: 'fixed', 
                  top: 0, 
                  right: 0, 
                  bottom: 0, 
                  width: '500px', 
                  maxWidth: '90vw',
                  background: '#FFF', 
                  boxShadow: '-4px 0 24px rgba(0,0,0,0.15)', 
                  zIndex: 2000,
                  display: 'flex',
                  flexDirection: 'column',
                  overflow: 'hidden'
                }}>
                <div style={{ background: getStageColor(selectedStep.stageIndex || 0, 'dark'), color: '#FFF', padding: isMobile ? '20px 24px' : '24px 32px', display: 'flex', justifyContent: 'space-between', alignItems: 'center', flexShrink: 0 }}>
                  <div style={{ flex: 1 }}>
                    <h2 style={{ margin: 0, fontSize: isMobile ? '20px' : '24px', fontWeight: 400 }}>{editingStep ? editingStep.name : selectedStep.name}</h2>
                    <p style={{ margin: '8px 0 0', opacity: 0.7, fontFamily: "'Interstate', sans-serif", fontSize: '14px' }}>{editingStep ? editingStep.description || 'No description' : selectedStep.description || 'No description'}</p>
                  </div>
                  <div style={{ display: 'flex', gap: '12px', alignItems: 'center' }}>
                    {editingStep ? (
                      <>
                        <button 
                          onClick={cancelStepEdit}
                          style={{ 
                            padding: '8px 16px', 
                            background: 'rgba(255,255,255,0.2)', 
                            color: '#FFF', 
                            border: '1px solid rgba(255,255,255,0.3)', 
                            borderRadius: '6px', 
                            cursor: 'pointer',
                            fontFamily: "'Interstate', sans-serif",
                            fontSize: '13px',
                            fontWeight: 500
                          }}
                        >
                          Cancel
                        </button>
                        <button 
                          onClick={saveStepEdit}
                          style={{ 
                            padding: '8px 16px', 
                            background: '#FFF', 
                            color: getStageColor(selectedStep.stageIndex || 0, 'dark'), 
                            border: 'none', 
                            borderRadius: '6px', 
                            cursor: 'pointer',
                            fontFamily: "'Interstate', sans-serif",
                            fontSize: '13px',
                            fontWeight: 600
                          }}
                        >
                          Save Changes
                        </button>
                      </>
                    ) : (
                      canEdit && (
                        <button 
                          onClick={startStepEdit}
                          style={{ 
                            padding: '8px 16px', 
                            background: 'rgba(255,255,255,0.2)', 
                            color: '#FFF', 
                            border: '1px solid rgba(255,255,255,0.3)', 
                            borderRadius: '6px', 
                            cursor: 'pointer',
                            fontFamily: "'Interstate', sans-serif",
                            fontSize: '13px',
                            fontWeight: 500,
                            display: 'flex',
                            alignItems: 'center',
                            gap: '6px'
                          }}
                        >
                          ✏️ Edit
                        </button>
                      )
                    )}
                    <button onClick={() => { setSelectedStep(null); setEditingStep(null); }} style={{ background: 'transparent', border: 'none', color: '#FFF', fontSize: '28px', cursor: 'pointer', opacity: 0.7, padding: '0 8px' }}>×</button>
                  </div>
                </div>
                <div style={{ padding: isMobile ? '24px' : '32px', flex: isMobile ? 'none' : 1, overflowY: isMobile ? 'visible' : 'auto' }}>
                  <div style={{ display: 'flex', flexDirection: 'column', gap: '24px' }}>
                    {/* Description Field */}
                    <div style={{ padding: '16px', background: '#F4F5F7', borderRadius: '8px' }}>
                      <label style={{ display: 'block', fontFamily: "'Interstate', sans-serif", fontSize: '11px', color: '#556275', textTransform: 'uppercase', letterSpacing: '0.5px', marginBottom: '8px' }}>Description</label>
                      {editingStep ? (
                        <textarea 
                          value={editingStep.description || ''} 
                          onChange={(e) => setEditingStep(prev => ({ ...prev, description: e.target.value }))} 
                          placeholder="Brief description of this step..." 
                          style={{ 
                            width: '100%', 
                            padding: '10px', 
                            border: '1px solid #C8CED6', 
                            borderRadius: '6px', 
                            fontSize: '14px', 
                            fontFamily: "'Open Sans', sans-serif", 
                            resize: 'vertical', 
                            minHeight: '80px',
                            lineHeight: 1.5
                          }} 
                        />
                      ) : (
                        <p style={{ 
                          margin: 0, 
                          fontSize: '14px', 
                          color: '#3D4A5C', 
                          fontFamily: "'Open Sans', sans-serif", 
                          lineHeight: 1.6,
                          minHeight: '40px'
                        }}>
                          {selectedStep.description || <span style={{ fontStyle: 'italic', color: '#8A95A5' }}>No description provided</span>}
                        </p>
                      )}
                    </div>
                    <div style={{ display: 'grid', gridTemplateColumns: '1fr 1fr', gap: '16px' }}>
                      <div style={{ padding: '16px', background: '#F4F5F7', borderRadius: '8px' }}>
                        <label style={{ display: 'block', fontFamily: "'Interstate', sans-serif", fontSize: '11px', color: '#556275', textTransform: 'uppercase', letterSpacing: '0.5px', marginBottom: '8px' }}>Time Required</label>
                        <span style={{ fontSize: '24px', fontWeight: 600 }}>{formatTime((editingStep || selectedStep).timeMinutes)}</span>
                        {editingStep && (
                          <div style={{ fontFamily: "'Interstate', sans-serif", fontSize: '10px', color: '#8A95A5', marginTop: '4px' }}>
                            Auto-calculated from roles below
                          </div>
                        )}
                      </div>
                      <div style={{ padding: '16px', background: '#F4F5F7', borderRadius: '8px' }}>
                        <label style={{ display: 'block', fontFamily: "'Interstate', sans-serif", fontSize: '11px', color: '#556275', textTransform: 'uppercase', letterSpacing: '0.5px', marginBottom: '8px' }}>Primary Owner</label>
                        {editingStep ? (
                          <select 
                            value={editingStep.owner} 
                            onChange={(e) => setEditingStep(prev => ({ ...prev, owner: e.target.value }))} 
                            style={{ width: '100%', padding: '8px', border: '1px solid #C8CED6', borderRadius: '4px', fontSize: '14px', background: '#FFF' }}
                          >
                            {config.personas.map(p => (<option key={p.id} value={p.id}>{p.label}</option>))}
                          </select>
                        ) : (
                          <div style={{ display: 'flex', alignItems: 'center', gap: '8px' }}>
                            <span style={{ width: '12px', height: '12px', borderRadius: '50%', background: getPersonaColor(selectedStep.owner) }} />
                            <span style={{ fontSize: '16px', fontWeight: 500 }}>{config.personas.find(p => p.id === selectedStep.owner)?.label}</span>
                          </div>
                        )}
                      </div>
                    </div>
                    {/* Friction */}
                    <div style={{ padding: '16px', background: frictionConfig[(editingStep || selectedStep).frictionScore || 3]?.bg || '#F4F5F7', borderRadius: '8px', marginBottom: '16px', transition: 'background 0.2s' }}>
                      <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: '12px' }}>
                        <label style={{ fontFamily: "'Interstate', sans-serif", fontSize: '11px', color: '#556275', textTransform: 'uppercase', letterSpacing: '0.5px' }}>Friction</label>
                        <div style={{ display: 'flex', alignItems: 'center', gap: '6px' }}>
                          <span style={{ fontSize: '18px' }}>{frictionConfig[(editingStep || selectedStep).frictionScore || 3]?.emoji}</span>
                          <span style={{ fontFamily: "'Interstate', sans-serif", fontSize: '12px', fontWeight: 600, color: frictionConfig[(editingStep || selectedStep).frictionScore || 3]?.color }}>{frictionConfig[(editingStep || selectedStep).frictionScore || 3]?.label}</span>
                        </div>
                      </div>
                      <div style={{ display: 'flex', gap: '8px' }}>
                        {[1,2,3,4,5].map(n => (
                          <button 
                            key={n} 
                            onClick={() => { 
                              if (editingStep) { 
                                setEditingStep(prev => ({ ...prev, frictionScore: n })); 
                              }
                            }} 
                            disabled={!editingStep} 
                            style={{ 
                              width: '40px', 
                              height: '40px', 
                              border: '2px solid', 
                              borderColor: ((editingStep || selectedStep).frictionScore || 3) >= n ? frictionConfig[(editingStep || selectedStep).frictionScore || 3]?.color : '#E4E7EB', 
                              borderRadius: '8px', 
                              background: ((editingStep || selectedStep).frictionScore || 3) >= n ? frictionConfig[(editingStep || selectedStep).frictionScore || 3]?.color : '#FFF', 
                              color: ((editingStep || selectedStep).frictionScore || 3) >= n ? '#FFF' : '#3D4A5C', 
                              cursor: editingStep ? 'pointer' : 'default', 
                              fontWeight: 600, 
                              fontSize: '14px', 
                              transition: 'all 0.2s' 
                            }}
                          >
                            {n}
                          </button>
                        ))}
                      </div>
                    </div>
                    {/* Improvement Opportunity */}
                    <div style={{ padding: '16px', background: '#F4F5F7', borderRadius: '8px', marginBottom: '16px' }}>
                      <label style={{ display: 'block', fontFamily: "'Interstate', sans-serif", fontSize: '11px', color: '#556275', textTransform: 'uppercase', letterSpacing: '0.5px', marginBottom: '12px' }}>Improvement Opportunity</label>
                      {editingStep ? (
                        <>
                          <div style={{ display: 'flex', gap: '8px', marginBottom: '12px' }}>
                            {['high', 'medium', 'low', 'none'].map(level => (
                              <button 
                                key={level} 
                                onClick={() => setEditingStep(prev => ({ ...prev, automationOpportunity: level }))} 
                                style={{ 
                                  padding: '8px 16px', 
                                  border: '2px solid', 
                                  borderColor: editingStep.automationOpportunity === level ? automationColors[level].text : '#E4E7EB', 
                                  borderRadius: '20px', 
                                  background: editingStep.automationOpportunity === level ? automationColors[level].bg : '#FFF', 
                                  color: editingStep.automationOpportunity === level ? automationColors[level].text : '#556275', 
                                  cursor: 'pointer', 
                                  fontFamily: "'Interstate', sans-serif", 
                                  fontSize: '12px', 
                                  fontWeight: 500, 
                                  textTransform: 'capitalize' 
                                }}
                              >
                                {level}
                              </button>
                            ))}
                          </div>
                          <textarea 
                            value={editingStep.automationNotes || ''} 
                            onChange={(e) => setEditingStep(prev => ({ ...prev, automationNotes: e.target.value }))} 
                            placeholder="Notes on improvement potential..." 
                            style={{ 
                              width: '100%', 
                              padding: '10px', 
                              border: '1px solid #C8CED6', 
                              borderRadius: '6px', 
                              fontSize: '13px', 
                              fontFamily: "'Interstate', sans-serif", 
                              resize: 'vertical', 
                              minHeight: '60px' 
                            }} 
                          />
                        </>
                      ) : (
                        <>
                          <div style={{ display: 'inline-flex', alignItems: 'center', gap: '8px', padding: '8px 16px', background: automationColors[selectedStep.automationOpportunity]?.bg, borderRadius: '20px', marginBottom: selectedStep.automationNotes ? '12px' : 0 }}>
                            <span>🎯</span>
                            <span style={{ fontFamily: "'Interstate', sans-serif", fontSize: '14px', color: automationColors[selectedStep.automationOpportunity]?.text, fontWeight: 500, textTransform: 'capitalize' }}>{selectedStep.automationOpportunity} potential</span>
                          </div>
                          {selectedStep.automationNotes && <p style={{ margin: 0, fontSize: '13px', color: '#556275', fontFamily: "'Interstate', sans-serif", lineHeight: 1.5 }}>{selectedStep.automationNotes}</p>}
                        </>
                      )}
                    </div>
                    
                    {/* Client Touchpoint */}
                    <div style={{ padding: '16px', background: (editingStep || selectedStep).clientTouchpoint ? '#D4EDE5' : '#F4F5F7', borderRadius: '8px', marginBottom: '16px', border: (editingStep || selectedStep).clientTouchpoint ? '1px solid #2D8A6E' : '1px solid transparent' }}>
                      <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center' }}>
                        <div>
                          <label style={{ display: 'block', fontFamily: "'Interstate', sans-serif", fontSize: '11px', color: '#556275', textTransform: 'uppercase', letterSpacing: '0.5px', marginBottom: '8px' }}>Client Touchpoint</label>
                          <div style={{ display: 'flex', alignItems: 'center', gap: '8px' }}>
                            <span style={{ fontSize: '16px' }}>{(editingStep || selectedStep).clientTouchpoint ? '👤' : '👤'}</span>
                            <span style={{ fontFamily: "'Interstate', sans-serif", fontSize: '13px', color: (editingStep || selectedStep).clientTouchpoint ? '#2D8A6E' : '#556275', fontWeight: 500 }}>
                              {(editingStep || selectedStep).clientTouchpoint ? 'This step has direct client involvement' : 'This step DOES NOT have direct client involvement'}
                            </span>
                          </div>
                        </div>
                        {editingStep && (
                          <button 
                            onClick={() => setEditingStep(prev => ({ ...prev, clientTouchpoint: !prev.clientTouchpoint }))} 
                            style={{ 
                              width: '60px', 
                              height: '32px', 
                              borderRadius: '16px', 
                              border: 'none',
                              background: editingStep.clientTouchpoint ? '#2D8A6E' : '#A9B2BE',
                              cursor: 'pointer',
                              position: 'relative',
                              transition: 'background 0.2s',
                              flexShrink: 0
                            }}
                          >
                            <div style={{
                              width: '26px',
                              height: '26px',
                              borderRadius: '50%',
                              background: '#FFF',
                              position: 'absolute',
                              top: '3px',
                              left: editingStep.clientTouchpoint ? '31px' : '3px',
                              transition: 'left 0.2s',
                              boxShadow: '0 1px 3px rgba(0,0,0,0.2)'
                            }} />
                          </button>
                        )}
                      </div>
                    </div>
                    
                    {/* Cost Breakdown - only show when costs are enabled */}
                    {showCosts && (
                    <div style={{ padding: '16px', background: '#FAF0D6', borderRadius: '8px', marginBottom: '16px', border: '1px solid #F0DDA8' }}>
                      <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'flex-start', marginBottom: '16px' }}>
                        <label style={{
                          display: 'block',
                          fontFamily: "'Interstate', sans-serif",
                          fontSize: '11px',
                          color: '#8B6914',
                          textTransform: 'uppercase',
                          letterSpacing: '0.5px',
                          fontWeight: 600
                        }}>
                          💰 Cost Breakdown
                        </label>
                        <div style={{ textAlign: 'right' }}>
                          <div style={{
                            fontFamily: "'Interstate', sans-serif",
                            fontSize: '20px',
                            fontWeight: 700,
                            color: '#8B6914'
                          }}>
                            {formatCurrency(calculateStepCost(selectedStep, config.personas))}
                          </div>
                          <div style={{
                            fontFamily: "'Interstate', sans-serif",
                            fontSize: '11px',
                            color: '#C4942A'
                          }}>
                            {formatCurrencyDetailed(selectedStep.timeMinutes > 0 ? calculateStepCost(selectedStep, config.personas) / selectedStep.timeMinutes : 0)}/min
                          </div>
                        </div>
                      </div>
                      
                      {/* Potential Savings Banner */}
                      {selectedStep.automationOpportunity && selectedStep.automationOpportunity !== 'none' && (
                        <div style={{
                          background: 'linear-gradient(135deg, #D4EDE5 0%, #96BCC7 100%)',
                          borderRadius: '8px',
                          padding: '12px 16px',
                          marginBottom: '16px',
                          display: 'flex',
                          alignItems: 'center',
                          justifyContent: 'space-between',
                          border: '1px solid #96BCC7'
                        }}>
                          <div style={{ display: 'flex', alignItems: 'center', gap: '8px' }}>
                            <span style={{ fontSize: '20px' }}>🎯</span>
                            <div>
                              <div style={{ fontFamily: "'Interstate', sans-serif", fontSize: '12px', fontWeight: 600, color: '#2D8A6E' }}>
                                Improvement Opportunity ({selectedStep.automationOpportunity})
                              </div>
                              <div style={{ fontFamily: "'Interstate', sans-serif", fontSize: '11px', color: '#2D8A6E' }}>
                                {selectedStep.automationOpportunity === 'high' ? '~70%' : selectedStep.automationOpportunity === 'medium' ? '~40%' : '~10%'} potential reduction
                              </div>
                            </div>
                          </div>
                          <div style={{ textAlign: 'right' }}>
                            <div style={{ fontFamily: "'Interstate', sans-serif", fontSize: '14px', fontWeight: 600, color: '#2D8A6E', marginBottom: '2px' }}>
                              {formatTime(Math.round(selectedStep.timeMinutes * (selectedStep.automationOpportunity === 'high' ? 0.7 : selectedStep.automationOpportunity === 'medium' ? 0.4 : 0.1)))}
                            </div>
                            <div style={{ fontFamily: "'Interstate', sans-serif", fontSize: '18px', fontWeight: 700, color: '#2D8A6E' }}>
                              {formatCurrency(
                                calculateStepCost(selectedStep, config.personas) * 
                                (selectedStep.automationOpportunity === 'high' ? 0.7 : selectedStep.automationOpportunity === 'medium' ? 0.4 : 0.1)
                              )} <span style={{ fontSize: '14px', opacity: 0.8 }}>({selectedStep.automationOpportunity === 'high' ? '70' : selectedStep.automationOpportunity === 'medium' ? '40' : '10'}%)</span>
                            </div>
                            <div style={{ fontFamily: "'Interstate', sans-serif", fontSize: '10px', color: '#2D8A6E' }}>potential savings</div>
                          </div>
                        </div>
                      )}
                      
                      {/* Labour Costs Section */}
                      <div style={{ marginBottom: '16px' }}>
                        <div style={{ fontFamily: "'Interstate', sans-serif", fontSize: '10px', color: '#8B6914', textTransform: 'uppercase', letterSpacing: '0.5px', marginBottom: '8px', fontWeight: 600 }}>
                          👤 Labour Costs ({formatCurrency(calculateStepLabourCost(selectedStep, config.personas))})
                        </div>
                        <div style={{ display: 'flex', flexDirection: 'column', gap: '8px' }}>
                          {config.personas.filter(p => !p.isExternal).map(persona => {
                            const involvement = (editingStep || selectedStep).roleInvolvement?.[persona.id] || { timeMinutes: 0, headcount: 1 };
                            const fullyLoadedRate = calculateFullyLoadedRate(persona);
                            const roleCost = (involvement.timeMinutes / 60) * fullyLoadedRate * (involvement.headcount || 1);
                            
                            if (!editingStep && involvement.timeMinutes === 0) return null;
                            
                            return (
                              <div key={persona.id} style={{
                                display: 'flex',
                                alignItems: 'center',
                                gap: '12px',
                                padding: '12px',
                                background: '#FFF',
                                borderRadius: '6px',
                                borderLeft: `3px solid ${persona.color}`
                              }}>
                                <div style={{ flex: 1, minWidth: '100px' }}>
                                  <div style={{
                                    fontFamily: "'Interstate', sans-serif",
                                    fontSize: '12px',
                                    fontWeight: 600,
                                    color: persona.color
                                  }}>
                                    {persona.label}
                                  </div>
                                  <div style={{
                                    fontFamily: "'Interstate', sans-serif",
                                    fontSize: '10px',
                                    color: '#8A95A5'
                                  }}>
                                    {formatCurrencyDetailed(fullyLoadedRate)}/hr (loaded)
                                  </div>
                                </div>
                                
                                {editingStep ? (
                                  <>
                                    <div style={{ display: 'flex', flexDirection: 'column', alignItems: 'center', gap: '2px' }}>
                                      <span style={{ fontFamily: "'Interstate', sans-serif", fontSize: '9px', color: '#8A95A5', textTransform: 'uppercase' }}>Mins</span>
                                      <input
                                        type="number"
                                        value={involvement.timeMinutes || 0}
                                        onChange={(e) => {
                                          const newVal = parseInt(e.target.value) || 0;
                                          setEditingStep(prev => {
                                            const newRoleInvolvement = {
                                              ...(prev.roleInvolvement || {}),
                                              [persona.id]: { ...involvement, timeMinutes: newVal }
                                            };
                                            const totalTime = Object.values(newRoleInvolvement).reduce(
                                              (sum, inv) => sum + (inv.timeMinutes || 0), 0
                                            );
                                            return {
                                              ...prev,
                                              roleInvolvement: newRoleInvolvement,
                                              timeMinutes: totalTime
                                            };
                                          });
                                        }}
                                        style={{
                                          width: '60px',
                                          padding: '6px',
                                          border: '1px solid #C8CED6',
                                          borderRadius: '4px',
                                          fontSize: '12px',
                                          textAlign: 'center'
                                        }}
                                      />
                                    </div>
                                    <div style={{ display: 'flex', flexDirection: 'column', alignItems: 'center', gap: '2px' }}>
                                      <span style={{ fontFamily: "'Interstate', sans-serif", fontSize: '9px', color: '#8A95A5', textTransform: 'uppercase' }}>People</span>
                                      <input
                                        type="number"
                                        min="1"
                                        value={involvement.headcount || 1}
                                        onChange={(e) => {
                                          const newVal = parseInt(e.target.value) || 1;
                                          setEditingStep(prev => ({
                                            ...prev,
                                            roleInvolvement: {
                                              ...(prev.roleInvolvement || {}),
                                              [persona.id]: { ...involvement, headcount: newVal }
                                            }
                                          }));
                                        }}
                                        style={{
                                          width: '50px',
                                          padding: '6px',
                                          border: '1px solid #C8CED6',
                                          borderRadius: '4px',
                                          fontSize: '12px',
                                          textAlign: 'center'
                                        }}
                                      />
                                    </div>
                                  </>
                                ) : (
                                  <>
                                    <div style={{ fontFamily: "'Interstate', sans-serif", fontSize: '12px', color: '#556275' }}>
                                      {involvement.timeMinutes}m × {involvement.headcount || 1} {(involvement.headcount || 1) > 1 ? 'people' : 'person'}
                                    </div>
                                  </>
                                )}
                                
                                <div style={{
                                  fontFamily: "'Interstate', sans-serif",
                                  fontSize: '14px',
                                  fontWeight: 600,
                                  color: '#8B6914',
                                  minWidth: '60px',
                                  textAlign: 'right'
                                }}>
                                  {formatCurrency(roleCost)}
                                </div>
                              </div>
                            );
                          })}
                        </div>
                      </div>
                      
                      {/* Additional Costs Section (Third-party, Materials) */}
                      <div>
                        <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: '8px' }}>
                          <div style={{ fontFamily: "'Interstate', sans-serif", fontSize: '10px', color: '#8B6914', textTransform: 'uppercase', letterSpacing: '0.5px', fontWeight: 600 }}>
                            📦 Additional Costs ({formatCurrency(calculateStepAdditionalCosts(editingStep || selectedStep))})
                          </div>
                          {editingStep && (
                            <button
                              onClick={() => {
                                const newCost = { id: generateId(), description: 'New cost', amount: 0, category: 'third-party' };
                                setEditingStep(prev => ({
                                  ...prev,
                                  additionalCosts: [...(prev.additionalCosts || []), newCost]
                                }));
                              }}
                              style={{ padding: '4px 10px', background: '#8B6914', color: '#FFF', border: 'none', borderRadius: '4px', cursor: 'pointer', fontFamily: "'Interstate', sans-serif", fontSize: '11px' }}
                            >
                              + Add Cost
                            </button>
                          )}
                        </div>
                        
                        {(!(editingStep || selectedStep).additionalCosts || (editingStep || selectedStep).additionalCosts.length === 0) && !editingStep ? (
                          <div style={{ padding: '12px', background: '#FFF', borderRadius: '6px', fontFamily: "'Interstate', sans-serif", fontSize: '12px', color: '#8A95A5', fontStyle: 'italic' }}>
                            No additional costs
                          </div>
                        ) : (
                          <div style={{ display: 'flex', flexDirection: 'column', gap: '8px' }}>
                            {((editingStep || selectedStep).additionalCosts || []).map((cost, index) => (
                              <div key={cost.id || index} style={{
                                display: 'flex',
                                alignItems: 'center',
                                gap: '12px',
                                padding: '12px',
                                background: '#FFF',
                                borderRadius: '6px',
                                borderLeft: '3px solid #6E7B8C'
                              }}>
                                {editingStep ? (
                                  <>
                                    <select
                                      value={cost.category || 'third-party'}
                                      onChange={(e) => {
                                        setEditingStep(prev => {
                                          const newCosts = [...(prev.additionalCosts || [])];
                                          newCosts[index] = { ...cost, category: e.target.value };
                                          return { ...prev, additionalCosts: newCosts };
                                        });
                                      }}
                                      style={{ padding: '6px', border: '1px solid #C8CED6', borderRadius: '4px', fontSize: '11px', fontFamily: "'Interstate', sans-serif" }}
                                    >
                                      <option value="third-party">🔌 Third-party</option>
                                      <option value="materials">📄 Materials</option>
                                      <option value="other">📎 Other</option>
                                    </select>
                                    <input
                                      type="text"
                                      value={cost.description}
                                      onChange={(e) => {
                                        setEditingStep(prev => {
                                          const newCosts = [...(prev.additionalCosts || [])];
                                          newCosts[index] = { ...cost, description: e.target.value };
                                          return { ...prev, additionalCosts: newCosts };
                                        });
                                      }}
                                      placeholder="Description"
                                      style={{ flex: 1, padding: '6px', border: '1px solid #C8CED6', borderRadius: '4px', fontSize: '12px', fontFamily: "'Interstate', sans-serif" }}
                                    />
                                    <div style={{ display: 'flex', alignItems: 'center', gap: '4px' }}>
                                      <span style={{ fontFamily: "'Interstate', sans-serif", fontSize: '12px', color: '#556275' }}>£</span>
                                      <input
                                        type="number"
                                        step="0.01"
                                        value={cost.amount || ''}
                                        onChange={(e) => {
                                          setEditingStep(prev => {
                                            const newCosts = [...(prev.additionalCosts || [])];
                                            newCosts[index] = { ...cost, amount: parseFloat(e.target.value) || 0 };
                                            return { ...prev, additionalCosts: newCosts };
                                          });
                                        }}
                                        style={{ width: '70px', padding: '6px', border: '1px solid #C8CED6', borderRadius: '4px', fontSize: '12px', textAlign: 'right' }}
                                      />
                                    </div>
                                    <button
                                      onClick={() => {
                                        setEditingStep(prev => ({
                                          ...prev,
                                          additionalCosts: (prev.additionalCosts || []).filter((_, i) => i !== index)
                                        }));
                                      }}
                                      style={{ width: '24px', height: '24px', borderRadius: '50%', border: 'none', background: '#F5E0E3', color: '#B84A5A', cursor: 'pointer', fontSize: '14px', display: 'flex', alignItems: 'center', justifyContent: 'center' }}
                                    >×</button>
                                  </>
                                ) : (
                                  <>
                                    <span style={{ fontSize: '14px' }}>
                                      {cost.category === 'materials' ? '📄' : cost.category === 'other' ? '📎' : '🔌'}
                                    </span>
                                    <div style={{ flex: 1, fontFamily: "'Interstate', sans-serif", fontSize: '12px', color: '#374151' }}>
                                      {cost.description}
                                    </div>
                                    <div style={{ fontFamily: "'Interstate', sans-serif", fontSize: '14px', fontWeight: 600, color: '#8B6914' }}>
                                      {formatCurrency(cost.amount)}
                                    </div>
                                  </>
                                )}
                              </div>
                            ))}
                          </div>
                        )}
                      </div>
                    </div>
                    )}

                    {/* Event Step Costs - only show in event mode */}
                    {showCosts && config.meta?.costModel === 'event' && (
                    <div style={{ padding: '16px', background: 'linear-gradient(135deg, #FAF0D6 0%, #F0DDA8 100%)', borderRadius: '8px', marginBottom: '16px', border: '1px solid #E4C87A' }}>
                      <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'flex-start', marginBottom: '16px' }}>
                        <label style={{
                          display: 'block',
                          fontFamily: "'Interstate', sans-serif",
                          fontSize: '11px',
                          color: '#8B6914',
                          textTransform: 'uppercase',
                          letterSpacing: '0.5px',
                          fontWeight: 600
                        }}>
                          🎪 Event Step Configuration
                        </label>
                      </div>
                      
                      {/* Peak Load Factor */}
                      <div style={{ marginBottom: '16px' }}>
                        <div style={{ fontFamily: "'Interstate', sans-serif", fontSize: '10px', color: '#8B6914', textTransform: 'uppercase', letterSpacing: '0.5px', marginBottom: '8px', fontWeight: 600 }}>
                          ⚡ Peak Load Factor
                        </div>
                        <div style={{ display: 'flex', gap: '8px', flexWrap: 'wrap' }}>
                          {[
                            { value: 1.0, label: 'Normal', emoji: '😊', desc: 'Standard staffing' },
                            { value: 1.25, label: 'Busy', emoji: '😅', desc: '+25% demand' },
                            { value: 1.5, label: 'High', emoji: '😰', desc: '+50% demand' },
                            { value: 2.0, label: 'Extreme', emoji: '🔥', desc: '2× demand' }
                          ].map(level => {
                            const currentFactor = (editingStep || selectedStep).eventCosts?.peakLoadFactor || 1.0;
                            const isSelected = Math.abs(currentFactor - level.value) < 0.01;
                            return (
                              <button
                                key={level.value}
                                onClick={() => {
                                  if (editingStep) {
                                    setEditingStep(prev => ({
                                      ...prev,
                                      eventCosts: { ...(prev.eventCosts || {}), peakLoadFactor: level.value }
                                    }));
                                  }
                                }}
                                disabled={!editingStep}
                                style={{
                                  padding: '10px 14px',
                                  border: `2px solid ${isSelected ? '#8B6914' : '#E4C87A'}`,
                                  borderRadius: '8px',
                                  background: isSelected ? '#FFF' : 'rgba(255,255,255,0.5)',
                                  cursor: editingStep ? 'pointer' : 'default',
                                  fontFamily: "'Interstate', sans-serif",
                                  fontSize: '12px',
                                  display: 'flex',
                                  flexDirection: 'column',
                                  alignItems: 'center',
                                  gap: '4px',
                                  minWidth: '70px',
                                  transition: 'all 0.15s'
                                }}
                              >
                                <span style={{ fontSize: '18px' }}>{level.emoji}</span>
                                <span style={{ fontWeight: 600, color: isSelected ? '#8B6914' : '#A67C1A' }}>{level.label}</span>
                                <span style={{ fontSize: '10px', color: '#8A95A5' }}>{level.value}×</span>
                              </button>
                            );
                          })}
                        </div>
                        <div style={{ fontFamily: "'Interstate', sans-serif", fontSize: '11px', color: '#A67C1A', marginTop: '8px' }}>
                          Peak load affects staffing requirements during this step (e.g., half-time rush)
                        </div>
                      </div>
                      
                      {/* Active Roles during this step */}
                      <div style={{ marginBottom: '16px' }}>
                        <div style={{ fontFamily: "'Interstate', sans-serif", fontSize: '10px', color: '#8B6914', textTransform: 'uppercase', letterSpacing: '0.5px', marginBottom: '8px', fontWeight: 600 }}>
                          👥 Active Roles During Step
                        </div>
                        <div style={{ display: 'flex', flexWrap: 'wrap', gap: '8px' }}>
                          {config.personas.filter(p => !p.isExternal).map(persona => {
                            const activeRoles = (editingStep || selectedStep).eventCosts?.activeRoles || [];
                            const isActive = activeRoles.includes(persona.id);
                            return (
                              <button
                                key={persona.id}
                                onClick={() => {
                                  if (editingStep) {
                                    const newActiveRoles = isActive 
                                      ? activeRoles.filter(id => id !== persona.id)
                                      : [...activeRoles, persona.id];
                                    setEditingStep(prev => ({
                                      ...prev,
                                      eventCosts: { ...(prev.eventCosts || {}), activeRoles: newActiveRoles }
                                    }));
                                  }
                                }}
                                disabled={!editingStep}
                                style={{
                                  padding: '8px 12px',
                                  border: `2px solid ${isActive ? persona.color : '#E4C87A'}`,
                                  borderRadius: '20px',
                                  background: isActive ? persona.color : 'rgba(255,255,255,0.5)',
                                  color: isActive ? '#FFF' : '#6E7B8C',
                                  cursor: editingStep ? 'pointer' : 'default',
                                  fontFamily: "'Interstate', sans-serif",
                                  fontSize: '12px',
                                  fontWeight: 500,
                                  transition: 'all 0.15s',
                                  display: 'flex',
                                  alignItems: 'center',
                                  gap: '6px'
                                }}
                              >
                                {isActive && <span>✓</span>}
                                {persona.label}
                              </button>
                            );
                          })}
                        </div>
                        <div style={{ fontFamily: "'Interstate', sans-serif", fontSize: '11px', color: '#A67C1A', marginTop: '8px' }}>
                          Select which roles are actively engaged during this step
                        </div>
                      </div>
                      
                      {/* Fixed Step Costs */}
                      <div style={{ marginBottom: '16px' }}>
                        <div style={{ fontFamily: "'Interstate', sans-serif", fontSize: '10px', color: '#8B6914', textTransform: 'uppercase', letterSpacing: '0.5px', marginBottom: '8px', fontWeight: 600 }}>
                          💷 Fixed Step Costs
                        </div>
                        <div style={{ display: 'grid', gridTemplateColumns: '1fr 1fr', gap: '12px' }}>
                          <div>
                            <label style={{ display: 'block', fontFamily: "'Interstate', sans-serif", fontSize: '10px', color: '#8A95A5', marginBottom: '4px' }}>Fixed Cost (£)</label>
                            {editingStep ? (
                              <input
                                type="number"
                                step="10"
                                value={editingStep.eventCosts?.fixedCosts || ''}
                                onChange={(e) => {
                                  setEditingStep(prev => ({
                                    ...prev,
                                    eventCosts: { ...(prev.eventCosts || {}), fixedCosts: parseFloat(e.target.value) || 0 }
                                  }));
                                }}
                                placeholder="0"
                                style={{ width: '100%', padding: '8px', border: '1px solid #E4C87A', borderRadius: '6px', fontSize: '13px', background: '#FFF' }}
                              />
                            ) : (
                              <div style={{ fontFamily: "'Interstate', sans-serif", fontSize: '16px', fontWeight: 600, color: '#8B6914' }}>
                                {formatCurrency(selectedStep.eventCosts?.fixedCosts || 0)}
                              </div>
                            )}
                            <div style={{ fontFamily: "'Interstate', sans-serif", fontSize: '10px', color: '#8A95A5', marginTop: '2px' }}>
                              Consumables, wastage, etc.
                            </div>
                          </div>
                          <div>
                            <label style={{ display: 'block', fontFamily: "'Interstate', sans-serif", fontSize: '10px', color: '#8A95A5', marginBottom: '4px' }}>Variable Cost/Head (£)</label>
                            {editingStep ? (
                              <input
                                type="number"
                                step="0.10"
                                value={editingStep.eventCosts?.variableCostPerHead || ''}
                                onChange={(e) => {
                                  setEditingStep(prev => ({
                                    ...prev,
                                    eventCosts: { ...(prev.eventCosts || {}), variableCostPerHead: parseFloat(e.target.value) || 0 }
                                  }));
                                }}
                                placeholder="0"
                                style={{ width: '100%', padding: '8px', border: '1px solid #E4C87A', borderRadius: '6px', fontSize: '13px', background: '#FFF' }}
                              />
                            ) : (
                              <div style={{ fontFamily: "'Interstate', sans-serif", fontSize: '16px', fontWeight: 600, color: '#8B6914' }}>
                                {formatCurrency(selectedStep.eventCosts?.variableCostPerHead || 0)}
                              </div>
                            )}
                            <div style={{ fontFamily: "'Interstate', sans-serif", fontSize: '10px', color: '#8A95A5', marginTop: '2px' }}>
                              Per attendee (food, materials)
                            </div>
                          </div>
                        </div>
                      </div>
                      
                      {/* Step Cost Summary */}
                      <div style={{ background: '#FFF', borderRadius: '8px', padding: '12px', border: '1px solid #E4C87A' }}>
                        <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center' }}>
                          <div style={{ fontFamily: "'Interstate', sans-serif", fontSize: '12px', color: '#8B6914' }}>
                            Estimated Step Cost
                          </div>
                          <div style={{ textAlign: 'right' }}>
                            <div style={{ fontFamily: "'Interstate', sans-serif", fontSize: '18px', fontWeight: 700, color: '#8B6914' }}>
                              {formatCurrency(
                                (selectedStep.eventCosts?.fixedCosts || 0) + 
                                ((selectedStep.eventCosts?.variableCostPerHead || 0) * (config.meta?.eventConfig?.capacity || 0))
                              )}
                            </div>
                            <div style={{ fontFamily: "'Interstate', sans-serif", fontSize: '10px', color: '#A67C1A' }}>
                              Fixed + ({formatCurrency(selectedStep.eventCosts?.variableCostPerHead || 0)} × {(config.meta?.eventConfig?.capacity || 0).toLocaleString()} attendees)
                            </div>
                          </div>
                        </div>
                      </div>
                    </div>
                    )}

                    {/* Pain Points */}
                    <div style={{ marginBottom: '24px' }}>
                      <label style={{ display: 'block', fontFamily: "'Interstate', sans-serif", fontSize: '11px', color: '#556275', textTransform: 'uppercase', letterSpacing: '0.5px', marginBottom: '12px' }}>Pain Points</label>
                      {((editingStep || selectedStep).painPoints || []).length === 0 && !editingStep ? (
                        <p style={{ color: '#8A95A5', fontStyle: 'italic', fontFamily: "'Interstate', sans-serif", fontSize: '14px' }}>No pain points identified</p>
                      ) : (
                        <ul style={{ margin: 0, padding: 0, listStyle: 'none' }}>
                          {((editingStep || selectedStep).painPoints || []).map((pp, i) => (
                            <li key={i} style={{ display: 'flex', alignItems: 'flex-start', gap: '12px', padding: '12px', background: '#F5E0E3', borderRadius: '6px', marginBottom: '8px', fontFamily: "'Interstate', sans-serif", fontSize: '14px', color: '#B84A5A' }}>
                              <span>⚠️</span>
                              <span style={{ flex: 1 }}>{pp}</span>
                              {editingStep && <button onClick={(e) => { e.stopPropagation(); setEditingStep(prev => ({ ...prev, painPoints: (prev.painPoints || []).filter((_, idx) => idx !== i) })); }} style={{ background: 'none', border: 'none', color: '#B84A5A', cursor: 'pointer', fontSize: '16px' }}>×</button>}
                            </li>
                          ))}
                        </ul>
                      )}
                      {editingStep && (
                        <div style={{ marginTop: '12px', display: 'flex', gap: '8px' }}>
                          <input type="text" placeholder="Add a pain point..." id="new-pain-point" style={{ flex: 1, padding: '10px 12px', border: '1px solid #C8CED6', borderRadius: '6px', fontSize: '14px', fontFamily: "'Interstate', sans-serif" }} onKeyDown={(e) => { if (e.key === 'Enter' && e.target.value.trim()) { const val = e.target.value.trim(); setEditingStep(prev => ({ ...prev, painPoints: [...(prev.painPoints || []), val] })); e.target.value = ''; }}} />
                          <button onClick={() => { const input = document.getElementById('new-pain-point'); if (input.value.trim()) { const val = input.value.trim(); setEditingStep(prev => ({ ...prev, painPoints: [...(prev.painPoints || []), val] })); input.value = ''; }}} style={{ padding: '10px 20px', background: '#B84A5A', color: '#FFF', border: 'none', borderRadius: '6px', cursor: 'pointer', fontFamily: "'Interstate', sans-serif", fontSize: '13px' }}>Add</button>
                        </div>
                      )}
                    </div>
                    {/* Checkpoint */}
                    <div style={{ marginBottom: '24px' }}>
                      <label style={{ display: 'block', fontFamily: "'Interstate', sans-serif", fontSize: '11px', color: '#556275', textTransform: 'uppercase', letterSpacing: '0.5px', marginBottom: '12px' }}>Checkpoint</label>
                      {editingStep ? (
                        <div style={{ display: 'flex', flexDirection: 'column', gap: '12px' }}>
                          <label style={{ display: 'flex', alignItems: 'center', gap: '12px', cursor: 'pointer' }}>
                            <input 
                              type="checkbox" 
                              checked={editingStep.isHardCheckpoint || false} 
                              onChange={(e) => { 
                                setEditingStep(prev => ({ ...prev, isHardCheckpoint: e.target.checked }));
                              }}
                              style={{ width: '20px', height: '20px', accentColor: '#B84A5A' }}
                            />
                            <span style={{ fontFamily: "'Interstate', sans-serif", fontSize: '14px' }}>This step is a checkpoint</span>
                          </label>
                          {editingStep.isHardCheckpoint && (
                            <>
                              <div>
                                <label style={{ display: 'block', fontFamily: "'Interstate', sans-serif", fontSize: '12px', color: '#556275', marginBottom: '6px' }}>Checkpoint Type</label>
                                <select 
                                  value={editingStep.checkpointType || 'compliance'} 
                                  onChange={(e) => { 
                                    setEditingStep(prev => ({ ...prev, checkpointType: e.target.value }));
                                  }}
                                  style={{ width: '100%', padding: '10px 12px', border: '1px solid #C8CED6', borderRadius: '6px', fontSize: '14px', fontFamily: "'Interstate', sans-serif" }}
                                >
                                  <option value="compliance">Compliance</option>
                                  <option value="regulatory">Regulatory</option>
                                  <option value="vetting">Vetting</option>
                                  <option value="approval">Approval</option>
                                  <option value="verification">Verification</option>
                                </select>
                              </div>
                              <div>
                                <label style={{ display: 'block', fontFamily: "'Interstate', sans-serif", fontSize: '12px', color: '#556275', marginBottom: '6px' }}>Checkpoint Requirements</label>
                                <textarea 
                                  value={editingStep.checkpointDetails || ''} 
                                  onChange={(e) => { 
                                    setEditingStep(prev => ({ ...prev, checkpointDetails: e.target.value }));
                                  }}
                                  placeholder="Describe what must be verified or completed at this checkpoint..."
                                  style={{ width: '100%', minHeight: '80px', padding: '10px 12px', border: '1px solid #C8CED6', borderRadius: '6px', fontSize: '14px', fontFamily: "'Interstate', sans-serif", resize: 'vertical' }}
                                />
                              </div>
                            </>
                          )}
                        </div>
                      ) : selectedStep.isHardCheckpoint ? (
                        <div style={{ padding: '16px', background: '#F5E0E3', borderRadius: '8px', border: '2px solid #B84A5A' }}>
                          <div style={{ display: 'flex', alignItems: 'center', gap: '10px', marginBottom: '8px' }}>
                            <span style={{ fontSize: '20px' }}>🚧</span>
                            <span style={{ fontFamily: "'Interstate', sans-serif", fontSize: '14px', color: '#B84A5A', fontWeight: 600, textTransform: 'uppercase' }}>{selectedStep.checkpointType || 'Compliance'} Checkpoint</span>
                          </div>
                          <p style={{ margin: 0, fontSize: '14px', lineHeight: 1.6, fontFamily: "'Interstate', sans-serif", color: '#9D174D' }}>{selectedStep.checkpointDetails || 'No details specified'}</p>
                        </div>
                      ) : (
                        <p style={{ color: '#8A95A5', fontStyle: 'italic', fontFamily: "'Interstate', sans-serif", fontSize: '14px' }}>No checkpoint set for this step</p>
                      )}
                    </div>
                    {/* Regulatory */}
                    <div>
                      <label style={{ display: 'block', fontFamily: "'Interstate', sans-serif", fontSize: '11px', color: '#556275', textTransform: 'uppercase', letterSpacing: '0.5px', marginBottom: '12px' }}>Regulatory Requirements</label>
                      {(!(editingStep || selectedStep).regulatoryRequirements || (editingStep || selectedStep).regulatoryRequirements.length === 0) && !editingStep ? (
                        <p style={{ color: '#8A95A5', fontStyle: 'italic', fontFamily: "'Interstate', sans-serif", fontSize: '14px' }}>No regulatory requirements specified</p>
                      ) : (
                        <ul style={{ margin: 0, padding: 0, listStyle: 'none' }}>
                          {((editingStep || selectedStep).regulatoryRequirements || []).map((req, i) => (
                            <li key={i} style={{ display: 'flex', alignItems: 'flex-start', gap: '12px', padding: '12px', background: '#E1EEF2', borderRadius: '6px', marginBottom: '8px', fontFamily: "'Interstate', sans-serif", fontSize: '14px', color: '#5A5B8A' }}>
                              <span>📋</span>
                              <span style={{ flex: 1 }}>{req}</span>
                              {editingStep && <button onClick={(e) => { e.stopPropagation(); setEditingStep(prev => ({ ...prev, regulatoryRequirements: (prev.regulatoryRequirements || []).filter((_, idx) => idx !== i) })); }} style={{ background: 'none', border: 'none', color: '#5A5B8A', cursor: 'pointer', fontSize: '16px' }}>×</button>}
                            </li>
                          ))}
                        </ul>
                      )}
                      {editingStep && (
                        <div style={{ marginTop: '12px', display: 'flex', gap: '8px' }}>
                          <input type="text" placeholder="Add a regulatory requirement..." id="new-reg-req" style={{ flex: 1, padding: '10px 12px', border: '1px solid #C8CED6', borderRadius: '6px', fontSize: '14px', fontFamily: "'Interstate', sans-serif" }} onKeyDown={(e) => { if (e.key === 'Enter' && e.target.value.trim()) { const val = e.target.value.trim(); setEditingStep(prev => ({ ...prev, regulatoryRequirements: [...(prev.regulatoryRequirements || []), val] })); e.target.value = ''; }}} />
                          <button onClick={() => { const input = document.getElementById('new-reg-req'); if (input.value.trim()) { const val = input.value.trim(); setEditingStep(prev => ({ ...prev, regulatoryRequirements: [...(prev.regulatoryRequirements || []), val] })); input.value = ''; }}} style={{ padding: '10px 20px', background: '#5A5B8A', color: '#FFF', border: 'none', borderRadius: '6px', cursor: 'pointer', fontFamily: "'Interstate', sans-serif", fontSize: '13px' }}>Add</button>
                        </div>
                      )}
                    </div>
                    {/* Actions by Role */}
                    <div>
                    <label style={{ display: 'block', fontFamily: "'Interstate', sans-serif", fontSize: '11px', color: '#556275', textTransform: 'uppercase', letterSpacing: '0.5px', marginBottom: '16px' }}>Actions by Role</label>
                    <div style={{ display: 'flex', flexDirection: 'column', gap: '12px' }}>
                      {config.personas.map(persona => {
                        const action = (editingStep || selectedStep).actions?.[persona.id];
                        if (!action && !editingStep) return null;
                        return (
                          <div key={persona.id} style={{ padding: '16px', background: '#F4F5F7', borderRadius: '8px', borderLeft: `4px solid ${persona.color}` }}>
                            <div style={{ fontFamily: "'Interstate', sans-serif", fontSize: '12px', color: persona.color, fontWeight: 600, marginBottom: '8px', textTransform: 'uppercase', letterSpacing: '0.5px' }}>{persona.label}</div>
                            {editingStep ? (
                              <textarea 
                                value={action || ''} 
                                onChange={(e) => { 
                                  setEditingStep(prev => ({ 
                                    ...prev, 
                                    actions: { ...(prev.actions || {}), [persona.id]: e.target.value } 
                                  })); 
                                }} 
                                placeholder={`What does the ${persona.label.toLowerCase()} do?`} 
                                style={{ width: '100%', minHeight: '60px', padding: '8px', border: '1px solid #C8CED6', borderRadius: '4px', fontSize: '14px', fontFamily: "'Interstate', sans-serif", resize: 'vertical' }} 
                              />
                            ) : (
                              <>
                                <p style={{ margin: '0 0 12px', fontSize: '14px', lineHeight: 1.5, fontFamily: "'Interstate', sans-serif" }}>{action}</p>
                                
                                {/* Request Feedback Button */}
                                {(() => {
                                  const teamMemberCount = (persona.teamMembers || []).length;
                                  return (
                                    <button
                                      onClick={() => {
                                        if (teamMemberCount === 0) return;
                                        setShowSurveyRequestModal({ stepId: selectedStep.id, personaId: persona.id });
                                      }}
                                      disabled={teamMemberCount === 0}
                                      style={{
                                        width: '100%',
                                        padding: '8px 12px',
                                        background: teamMemberCount === 0 ? '#F4F5F7' : '#5B8A9A',
                                        color: teamMemberCount === 0 ? '#A9B2BE' : '#FFF',
                                        border: teamMemberCount === 0 ? '1px solid #E4E7EB' : 'none',
                                        borderRadius: '6px',
                                        cursor: teamMemberCount === 0 ? 'not-allowed' : 'pointer',
                                        fontFamily: "'Interstate', sans-serif",
                                        fontSize: '12px',
                                        fontWeight: 600,
                                        display: 'flex',
                                        alignItems: 'center',
                                        justifyContent: 'center',
                                        gap: '8px',
                                        transition: 'background 0.2s'
                                      }}
                                      onMouseEnter={(e) => {
                                        if (teamMemberCount > 0) {
                                          e.currentTarget.style.background = '#4A7485';
                                        }
                                      }}
                                      onMouseLeave={(e) => {
                                        if (teamMemberCount > 0) {
                                          e.currentTarget.style.background = '#5B8A9A';
                                        }
                                      }}
                                      title={teamMemberCount === 0 ? 'Add team members to this role first' : `Request feedback from ${teamMemberCount} team ${teamMemberCount === 1 ? 'member' : 'members'}`}
                                    >
                                      <span style={{ fontSize: '14px' }}>📧</span>
                                      <span>Request Feedback</span>
                                      <span style={{ 
                                        padding: '2px 8px', 
                                        background: teamMemberCount === 0 ? '#E4E7EB' : 'rgba(255,255,255,0.2)', 
                                        borderRadius: '10px', 
                                        fontSize: '11px',
                                        fontWeight: 700
                                      }}>
                                        {teamMemberCount} {teamMemberCount === 1 ? 'person' : 'people'}
                                      </span>
                                    </button>
                                  );
                                })()}
                              </>
                            )}
                          </div>
                        );
                      })}
                    </div>
                    </div>
                    {/* Touchpoints */}
                    <div style={{ marginTop: '24px' }}>
                      <label style={{ display: 'block', fontFamily: "'Interstate', sans-serif", fontSize: '11px', color: '#556275', textTransform: 'uppercase', letterSpacing: '0.5px', marginBottom: '12px' }}>Touchpoints</label>
                      <div style={{ display: 'flex', flexWrap: 'wrap', gap: '8px' }}>
                        {((editingStep || selectedStep).touchpoints || []).map((tp, i) => (
                          <span key={i} style={{ padding: '6px 12px', background: '#E8E8E8', borderRadius: '16px', fontFamily: "'Interstate', sans-serif", fontSize: '13px', display: 'flex', alignItems: 'center', gap: '6px' }}>
                            {tp}
                            {editingStep && (
                              <button 
                                onClick={() => { 
                                  setEditingStep(prev => ({
                                    ...prev,
                                    touchpoints: prev.touchpoints.filter((_, idx) => idx !== i)
                                  }));
                                }} 
                                style={{ background: 'none', border: 'none', color: '#556275', cursor: 'pointer', fontSize: '14px', padding: '0 0 0 2px', lineHeight: 1 }}
                              >×</button>
                            )}
                          </span>
                        ))}
                      </div>
                      {editingStep && (
                        <div style={{ marginTop: '12px', display: 'flex', gap: '8px' }}>
                          <input 
                            type="text" 
                            placeholder="Add a touchpoint..." 
                            id="new-touchpoint" 
                            style={{ flex: 1, padding: '8px 12px', border: '1px solid #C8CED6', borderRadius: '6px', fontSize: '13px', fontFamily: "'Interstate', sans-serif" }} 
                            onKeyDown={(e) => { 
                              if (e.key === 'Enter' && e.target.value.trim()) { 
                                const val = e.target.value.trim(); 
                                setEditingStep(prev => ({
                                  ...prev,
                                  touchpoints: [...(prev.touchpoints || []), val]
                                }));
                                e.target.value = ''; 
                              }
                            }} 
                          />
                          <button 
                            onClick={() => { 
                              const input = document.getElementById('new-touchpoint'); 
                              if (input.value.trim()) { 
                                const val = input.value.trim(); 
                                setEditingStep(prev => ({
                                  ...prev,
                                  touchpoints: [...(prev.touchpoints || []), val]
                                }));
                                input.value = ''; 
                              }
                            }} 
                            style={{ padding: '8px 16px', background: '#556275', color: '#FFF', border: 'none', borderRadius: '6px', cursor: 'pointer', fontFamily: "'Interstate', sans-serif", fontSize: '13px' }}
                          >Add</button>
                        </div>
                      )}
                    </div>
                    {/* Emotion */}
                    <div style={{ marginTop: '24px' }}>
                      <label style={{ display: 'block', fontFamily: "'Interstate', sans-serif", fontSize: '11px', color: '#556275', textTransform: 'uppercase', letterSpacing: '0.5px', marginBottom: '12px' }}>Client Emotions <span style={{ fontWeight: 400, textTransform: 'none' }}>(select multiple)</span></label>
                      {editingStep ? (
                        <div style={{ display: 'flex', flexWrap: 'wrap', gap: '8px' }}>
                          {Object.entries(emotionColors).map(([emotion, colors]) => {
                            const currentEmotions = Array.isArray(editingStep.emotions) ? editingStep.emotions : (editingStep.emotions ? [editingStep.emotions] : []);
                            const isSelected = currentEmotions.includes(emotion);
                            return (
                              <button key={emotion} onClick={() => { 
                                const newEmotions = isSelected 
                                  ? currentEmotions.filter(e => e !== emotion)
                                  : [...currentEmotions, emotion];
                                setEditingStep(prev => ({ ...prev, emotions: newEmotions }));
                              }} style={{ padding: '8px 14px', background: isSelected ? colors.bg : '#F4F5F7', border: '2px solid', borderColor: isSelected ? colors.text : 'transparent', borderRadius: '20px', cursor: 'pointer', display: 'flex', alignItems: 'center', gap: '6px' }}>
                                <span>{colors.icon}</span>
                                <span style={{ fontFamily: "'Interstate', sans-serif", fontSize: '12px', color: isSelected ? colors.text : '#556275', textTransform: 'capitalize' }}>{emotion}</span>
                              </button>
                            );
                          })}
                        </div>
                      ) : (
                        <div style={{ display: 'flex', flexWrap: 'wrap', gap: '8px' }}>
                          {(() => {
                            const displayEmotions = Array.isArray(selectedStep.emotions) ? selectedStep.emotions : (selectedStep.emotions ? [selectedStep.emotions] : []);
                            return displayEmotions.length > 0 ? displayEmotions.map(emotion => (
                              <div key={emotion} style={{ display: 'inline-flex', alignItems: 'center', gap: '8px', padding: '10px 16px', background: emotionColors[emotion]?.bg || '#F4F5F7', borderRadius: '20px' }}>
                                <span style={{ fontSize: '18px' }}>{emotionColors[emotion]?.icon || '😐'}</span>
                                <span style={{ fontFamily: "'Interstate', sans-serif", fontSize: '14px', color: emotionColors[emotion]?.text || '#556275', textTransform: 'capitalize', fontWeight: 500 }}>{emotion}</span>
                              </div>
                            )) : (
                              <div style={{ display: 'inline-flex', alignItems: 'center', gap: '8px', padding: '10px 16px', background: '#F4F5F7', borderRadius: '20px' }}>
                                <span style={{ fontSize: '18px' }}>😐</span>
                                <span style={{ fontFamily: "'Interstate', sans-serif", fontSize: '14px', color: '#556275', fontWeight: 500 }}>No emotion set</span>
                              </div>
                            );
                          })()}
                        </div>
                      )}
                    </div>
                  </div>
                </div>
              </div>
              </>
            )}
          </main>

          {/* Footer */}
          <footer style={{ background: '#192B45', color: '#8A95A5', padding: '20px 40px', fontFamily: "'Interstate', sans-serif", fontSize: '12px', display: 'flex', justifyContent: 'space-between', alignItems: 'center', flexShrink: 0 }}>
            <span>{isMultiUserMode ? `${mapTitle} · ` : "FATHOM "}v{APP_VERSION}</span>
            <div style={{ display: 'flex', alignItems: 'center', gap: '16px' }}>
              <button 
                onClick={refreshFromPublicGitHub}
                disabled={refreshStatus.loading}
                style={{ 
                  background: 'transparent', 
                  border: '1px solid #556275', 
                  borderRadius: '4px', 
                  padding: '4px 12px', 
                  color: refreshStatus.message ? (refreshStatus.message.includes('✓') ? '#4ADE80' : refreshStatus.message.includes('✗') ? '#F87171' : '#8A95A5') : '#8A95A5', 
                  cursor: refreshStatus.loading ? 'wait' : 'pointer', 
                  fontFamily: "'Interstate', sans-serif", 
                  fontSize: '11px',
                  display: 'flex',
                  alignItems: 'center',
                  gap: '6px',
                  transition: 'all 0.2s'
                }}
                onMouseOver={(e) => !refreshStatus.loading && (e.currentTarget.style.borderColor = '#8A95A5', e.currentTarget.style.color = '#A9B2BE')}
                onMouseOut={(e) => (e.currentTarget.style.borderColor = '#556275', e.currentTarget.style.color = refreshStatus.message ? (refreshStatus.message.includes('✓') ? '#4ADE80' : '#F87171') : '#8A95A5')}
              >
                <span className={refreshStatus.loading ? 'refresh-spinning' : ''}>🔄</span>
                {refreshStatus.loading ? 'Refreshing...' : refreshStatus.message || 'Refresh Data'}
              </button>
              <span>Last updated: {new Date(config.meta?.lastUpdated || new Date()).toLocaleDateString('en-GB')}</span>
            </div>
          </footer>

          {/* Modals */}
          {/* Unified Dashboard Modal */}
          {showDashboard && (
            <div className="dashboard-modal-overlay" style={{ position: 'fixed', top: 0, left: 0, right: 0, bottom: 0, background: 'rgba(12,22,32,0.6)', backdropFilter: 'blur(8px)', WebkitBackdropFilter: 'blur(8px)', display: 'flex', alignItems: 'center', justifyContent: 'center', zIndex: 3000, padding: '12px' }} onClick={() => setShowDashboard(false)}>
              <div className="dashboard-modal-content" onClick={(e) => e.stopPropagation()} style={{ background: '#FFF', borderRadius: '12px', maxWidth: '1400px', width: '100%', maxHeight: '90vh', display: 'flex', flexDirection: 'column', overflow: 'hidden', boxShadow: '0 20px 60px rgba(0,0,0,0.3)' }}>
                {/* Dashboard Header with Tabs */}
                <div style={{ background: '#192B45', padding: '12px 16px', paddingTop: 'max(12px, env(safe-area-inset-top))', display: 'flex', alignItems: 'center', justifyContent: 'space-between', gap: '12px', flexShrink: 0 }}>
                  {/* Left: Icon + Title (title hidden on mobile) */}
                  <div style={{ display: 'flex', alignItems: 'center', gap: '8px', flexShrink: 0 }}>
                    <span style={{ fontSize: '18px' }}>📊</span>
                    <h2 className="dashboard-title-text" style={{ margin: 0, color: '#FFF', fontSize: '16px', fontWeight: 500, fontFamily: "'Interstate', sans-serif" }}>Dashboard</h2>
                  </div>
                  {/* Center: Tabs */}
                  <div style={{ display: 'flex', gap: '4px', background: 'rgba(255,255,255,0.1)', borderRadius: '8px', padding: '4px' }}>
                    <button 
                      onClick={() => setDashboardTab('time')}
                      style={{ 
                        padding: '8px 14px', 
                        background: dashboardTab === 'time' ? '#FFF' : 'transparent',
                        color: dashboardTab === 'time' ? '#192B45' : 'rgba(255,255,255,0.7)',
                        border: 'none',
                        borderRadius: '6px',
                        cursor: 'pointer',
                        fontFamily: "'Interstate', sans-serif",
                        fontSize: '12px',
                        fontWeight: 500,
                        display: 'flex',
                        alignItems: 'center',
                        gap: '5px',
                        transition: 'all 0.15s'
                      }}
                    >
                      📅 Time
                    </button>
                    {showCosts && (
                      <button 
                        onClick={() => setDashboardTab('costs')}
                        style={{ 
                          padding: '8px 14px', 
                          background: dashboardTab === 'costs' ? '#FFF' : 'transparent',
                          color: dashboardTab === 'costs' ? '#192B45' : 'rgba(255,255,255,0.7)',
                          border: 'none',
                          borderRadius: '6px',
                          cursor: 'pointer',
                          fontFamily: "'Interstate', sans-serif",
                          fontSize: '12px',
                          fontWeight: 500,
                          display: 'flex',
                          alignItems: 'center',
                          gap: '5px',
                          transition: 'all 0.15s'
                        }}
                      >
                        💰 Costs
                      </button>
                    )}
                    {config.funnel?.enabled && (
                      <button 
                        onClick={() => setDashboardTab('funnel')}
                        style={{ 
                          padding: '8px 14px', 
                          background: dashboardTab === 'funnel' ? '#FFF' : 'transparent',
                          color: dashboardTab === 'funnel' ? '#192B45' : 'rgba(255,255,255,0.7)',
                          border: 'none',
                          borderRadius: '6px',
                          cursor: 'pointer',
                          fontFamily: "'Interstate', sans-serif",
                          fontSize: '12px',
                          fontWeight: 500,
                          display: 'flex',
                          alignItems: 'center',
                          gap: '5px',
                          transition: 'all 0.15s'
                        }}
                      >
                        🔻 Funnel
                      </button>
                    )}
                    {config.meta?.costModel === 'event' && showCosts && (
                      <button 
                        onClick={() => setDashboardTab('event')}
                        style={{ 
                          padding: '8px 14px', 
                          background: dashboardTab === 'event' ? '#FFF' : 'transparent',
                          color: dashboardTab === 'event' ? '#192B45' : 'rgba(255,255,255,0.7)',
                          border: 'none',
                          borderRadius: '6px',
                          cursor: 'pointer',
                          fontFamily: "'Interstate', sans-serif",
                          fontSize: '12px',
                          fontWeight: 500,
                          display: 'flex',
                          alignItems: 'center',
                          gap: '5px',
                          transition: 'all 0.15s'
                        }}
                      >
                        🎪 Event
                      </button>
                    )}
                    <button 
                      onClick={() => setDashboardTab('plan')}
                      style={{ 
                        padding: '8px 14px', 
                        background: dashboardTab === 'plan' ? '#FFF' : 'transparent',
                        color: dashboardTab === 'plan' ? '#192B45' : 'rgba(255,255,255,0.7)',
                        border: 'none',
                        borderRadius: '6px',
                        cursor: 'pointer',
                        fontFamily: "'Interstate', sans-serif",
                        fontSize: '12px',
                        fontWeight: 500,
                        display: 'flex',
                        alignItems: 'center',
                        gap: '5px',
                        transition: 'all 0.15s'
                      }}
                    >
                      📋 Plan
                    </button>
                  </div>
                  {/* Right: Close button */}
                  <button 
                    onClick={() => setShowDashboard(false)}
                    style={{ 
                      background: 'rgba(255,255,255,0.1)', 
                      border: 'none', 
                      color: '#FFF', 
                      width: '32px', 
                      height: '32px', 
                      borderRadius: '8px', 
                      cursor: 'pointer',
                      fontSize: '18px',
                      display: 'flex',
                      alignItems: 'center',
                      justifyContent: 'center',
                      flexShrink: 0
                    }}
                  >
                    ×
                  </button>
                </div>
                {/* Dashboard Content */}
                <div style={{ flex: 1, overflow: 'auto' }}>
                  {dashboardTab === 'time' && (
                    <Timeline stages={config.stages} totalTime={totalTime} formatTime={formatTime} personas={config.personas} showCosts={showCosts} config={config} />
                  )}
                  {dashboardTab === 'costs' && showCosts && (
                    <div style={{ height: '100%', display: 'flex', flexDirection: 'column' }}>
                      {/* Costs Tab Header with Manage Roles Button */}
                      {canEdit && (
                        <div style={{ 
                          padding: '16px 24px', 
                          borderBottom: '1px solid #E4E7EB',
                          display: 'flex',
                          justifyContent: 'space-between',
                          alignItems: 'center',
                          background: '#F4F5F7'
                        }}>
                          <div>
                            <h3 style={{ margin: 0, fontSize: '16px', fontWeight: 600, color: '#1A2332' }}>Cost Analysis</h3>
                            <p style={{ margin: '4px 0 0', fontSize: '13px', color: '#6E7B8C' }}>Configure roles and their costs</p>
                          </div>
                          <button
                            onClick={() => {
                              setShowSalarySettings(true);
                              setShowDashboard(false);
                            }}
                            style={{
                              padding: '8px 16px',
                              background: '#192B45',
                              color: '#FFF',
                              border: 'none',
                              borderRadius: '6px',
                              cursor: 'pointer',
                              fontFamily: "'Interstate', sans-serif",
                              fontSize: '13px',
                              fontWeight: 500,
                              display: 'flex',
                              alignItems: 'center',
                              gap: '6px',
                              transition: 'all 0.15s'
                            }}
                            onMouseOver={(e) => { e.currentTarget.style.background = '#243D5C'; }}
                            onMouseOut={(e) => { e.currentTarget.style.background = '#192B45'; }}
                          >
                            👥 Manage Roles
                          </button>
                        </div>
                      )}
                      <div style={{ flex: 1, overflow: 'auto' }}>
                        <CostAnalysisPanel stages={config.stages} personas={config.personas} formatTime={formatTime} config={config} />
                      </div>
                    </div>
                  )}
                  {dashboardTab === 'funnel' && config.funnel?.enabled && (
                    <div style={{ height: '100%', display: 'flex', flexDirection: 'column' }}>
                      {/* Funnel Tab Header with Settings Button */}
                      {canEdit && (
                        <div style={{ 
                          padding: '16px 24px', 
                          borderBottom: '1px solid #E4E7EB',
                          display: 'flex',
                          justifyContent: 'space-between',
                          alignItems: 'center',
                          background: '#F4F5F7'
                        }}>
                          <div>
                            <h3 style={{ margin: 0, fontSize: '16px', fontWeight: 600, color: '#1A2332' }}>Conversion Funnel</h3>
                            <p style={{ margin: '4px 0 0', fontSize: '13px', color: '#6E7B8C' }}>Configure drop-off rates and volumes</p>
                          </div>
                          <button
                            onClick={() => {
                              setShowFunnelSettings(true);
                              setShowDashboard(false);
                            }}
                            style={{
                              padding: '8px 16px',
                              background: '#192B45',
                              color: '#FFF',
                              border: 'none',
                              borderRadius: '6px',
                              cursor: 'pointer',
                              fontFamily: "'Interstate', sans-serif",
                              fontSize: '13px',
                              fontWeight: 500,
                              display: 'flex',
                              alignItems: 'center',
                              gap: '6px',
                              transition: 'all 0.15s'
                            }}
                            onMouseOver={(e) => { e.currentTarget.style.background = '#243D5C'; }}
                            onMouseOut={(e) => { e.currentTarget.style.background = '#192B45'; }}
                          >
                            ⚙️ Funnel Settings
                          </button>
                        </div>
                      )}
                      <div style={{ flex: 1, overflow: 'auto' }}>
                        <FunnelDashboard config={config} formatTime={formatTime} />
                      </div>
                    </div>
                  )}
                  {dashboardTab === 'event' && config.meta?.costModel === 'event' && showCosts && (
                    <EventEconomicsPanel config={config} formatTime={formatTime} />
                  )}
                  {dashboardTab === 'plan' && (
                    <ImprovementPlan config={config} stages={config.stages} personas={config.personas} formatTime={formatTime} updateConfig={setConfig} />
                  )}
                </div>
              </div>
            </div>
          )}
          
          {showAddStage && <AddStageModal onAdd={addStage} onClose={() => setShowAddStage(false)} />}
          {addStepTo && <AddStepModal stageId={addStepTo.id} stageName={addStepTo.name} personas={config.personas} onAdd={addStep} onClose={() => setAddStepTo(null)} />}
          {showSalarySettings && <SalarySettingsModal personas={config.personas} config={config} onUpdate={updateSalaries} onClose={() => setShowSalarySettings(false)} />}
          {showSurveyRequestModal && (
            <SurveyRequestModal 
              stepId={showSurveyRequestModal.stepId}
              personaId={showSurveyRequestModal.personaId}
              config={config}
              onClose={() => setShowSurveyRequestModal(null)}
              onSend={(surveyRequest) => {
                // Phase 3: Implement actual email sending
                console.log('Survey request:', surveyRequest);
              }}
            />
          )}
          {showShareModal && isSupabaseMode && (
            <ShareModal 
              mapId={mapId}
              mapTitle={config?.meta?.title || 'Journey Map'}
              supabase={supabase}
              currentUser={currentUser}
              onClose={() => setShowShareModal(false)} 
            />
          )}
          {showStructurePanel && <StructurePanel 
            config={config} 
            onMoveStage={moveStage}
            onMoveStep={moveStep}
            onInsertStage={insertStageAt}
            onInsertStep={insertStepAt}
            onRemoveStage={removeStage}
            onRenameStage={renameStage}
            onRenameStep={renameStep}
            onRemoveStep={(stageId, stepId) => {
              setConfig(prev => ({
                ...prev,
                stages: prev.stages.map(stage =>
                  stage.id === stageId
                    ? { ...stage, steps: stage.steps.filter(s => s.id !== stepId) }
                    : stage
                )
              }));
            }}
            onClose={() => setShowStructurePanel(false)} 
          />}
          {showGitHubSettings && !isSupabaseMode && <GitHubSettingsModal 
            config={gitHubConfig}
            onUpdate={setGitHubConfig}
            onSave={saveToGitHub}
            onLoad={loadFromGitHub}
            status={gitHubStatus}
            onClose={() => setShowGitHubSettings(false)} 
          />}
          
          {/* Funnel Settings Modal */}
          {showFunnelSettings && <FunnelSettingsModal config={config} onUpdate={updateFunnelSettings} onClose={() => setShowFunnelSettings(false)} />}
          
          {/* Journey Settings Modal */}
          {showJourneySettings && <JourneySettingsPanel config={config} setConfig={setConfig} onClose={() => setShowJourneySettings(false)} />}
          
          {/* Password Prompt Modal - only in legacy (non-Supabase) mode */}
          {showPasswordPrompt && !isSupabaseMode && (
            <div style={{ position: 'fixed', top: 0, left: 0, right: 0, bottom: 0, background: 'rgba(0,0,0,0.5)', display: 'flex', alignItems: 'center', justifyContent: 'center', zIndex: 10000 }} onClick={() => setShowPasswordPrompt(false)}>
              <div onClick={(e) => e.stopPropagation()} style={{ background: '#FFF', borderRadius: '12px', padding: '32px', width: '320px', maxWidth: '90%', boxShadow: '0 20px 60px rgba(0,0,0,0.3)' }}>
                <h3 style={{ margin: '0 0 8px', fontSize: '18px', fontWeight: 600 }}>🔒 Settings Locked</h3>
                <p style={{ margin: '0 0 20px', fontSize: '14px', color: '#556275', fontFamily: "'Interstate', sans-serif" }}>Enter password to access settings</p>
                <input 
                  type="password" 
                  id="settings-password"
                  placeholder="Password"
                  autoFocus
                  onKeyDown={(e) => {
                    if (e.key === 'Enter') {
                      if (e.target.value === passwords?.settings) {
                        setIsSettingsUnlocked(true);
                        localStorage.setItem('journeymap-settings-unlocked', 'true');
                        setShowPasswordPrompt(false);
                        setShowSettingsMenu(true);
                      } else {
                        e.target.value = '';
                        e.target.placeholder = 'Incorrect password';
                        e.target.style.borderColor = '#B84A5A';
                      }
                    }
                  }}
                  style={{ 
                    width: '100%', 
                    padding: '12px 16px', 
                    border: '2px solid #E4E7EB', 
                    borderRadius: '8px', 
                    fontSize: '16px', 
                    marginBottom: '16px',
                    fontFamily: "'Interstate', sans-serif"
                  }} 
                />
                <div style={{ display: 'flex', gap: '12px' }}>
                  <button 
                    onClick={() => setShowPasswordPrompt(false)}
                    style={{ flex: 1, padding: '12px', background: '#F4F5F7', border: 'none', borderRadius: '8px', cursor: 'pointer', fontFamily: "'Interstate', sans-serif", fontSize: '14px', fontWeight: 500 }}
                  >
                    Cancel
                  </button>
                  <button 
                    onClick={() => {
                      const input = document.getElementById('settings-password');
                      if (input.value === passwords?.settings) {
                        setIsSettingsUnlocked(true);
                        localStorage.setItem('journeymap-settings-unlocked', 'true');
                        setShowPasswordPrompt(false);
                        setShowSettingsMenu(true);
                      } else {
                        input.value = '';
                        input.placeholder = 'Incorrect password';
                        input.style.borderColor = '#B84A5A';
                      }
                    }}
                    style={{ flex: 1, padding: '12px', background: '#1A2332', color: '#FFF', border: 'none', borderRadius: '8px', cursor: 'pointer', fontFamily: "'Interstate', sans-serif", fontSize: '14px', fontWeight: 500 }}
                  >
                    Unlock
                  </button>
                </div>
              </div>
            </div>
          )}
        </div>
        </>
      );
    }

    ReactDOM.createRoot(document.getElementById('root')).render(<JourneyMap />);
  </script>
</body>
</html>
