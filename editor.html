<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Client Onboarding Journey Map</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/react/18.2.0/umd/react.production.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/react-dom/18.2.0/umd/react-dom.production.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/babel-standalone/7.23.5/babel.min.js"></script>
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body { font-family: Georgia, 'Times New Roman', serif; }
    ::-webkit-scrollbar { height: 8px; width: 8px; }
    ::-webkit-scrollbar-track { background: #f1f1f1; }
    ::-webkit-scrollbar-thumb { background: #ccc; border-radius: 4px; }
    ::-webkit-scrollbar-thumb:hover { background: #999; }
    .tooltip { position: relative; }
    .tooltip:hover::after {
      content: attr(data-tooltip);
      position: absolute;
      top: 100%;
      left: 50%;
      transform: translateX(-50%);
      background: #1A1A1A;
      color: #FFF;
      padding: 8px 12px;
      border-radius: 6px;
      font-size: 12px;
      white-space: nowrap;
      z-index: 9999;
      font-family: 'Helvetica Neue', Arial, sans-serif;
      line-height: 1.4;
      text-align: left;
      box-shadow: 0 4px 12px rgba(0,0,0,0.15);
      margin-top: 6px;
      pointer-events: none;
    }
    .step-card:hover {
      z-index: 1050 !important;
    }
    
    /* Edge-to-edge horizontal scrolling */
    .stages-container {
      margin-left: -40px !important;
      margin-right: -40px !important;
      padding-left: 40px !important;
      padding-right: 40px !important;
      width: calc(100% + 80px) !important;
      scroll-padding-left: 40px;
      scroll-padding-right: 40px;
    }
    
    /* Fade hint at edges to show scrollability */
    .scroll-container-wrapper {
      position: relative;
    }
    .scroll-container-wrapper::before,
    .scroll-container-wrapper::after {
      content: '';
      position: absolute;
      top: 0;
      bottom: 20px;
      width: 40px;
      pointer-events: none;
      z-index: 10;
      opacity: 0;
      transition: opacity 0.2s;
    }
    .scroll-container-wrapper::before {
      left: 0;
      background: linear-gradient(to right, #FAFAFA, transparent);
    }
    .scroll-container-wrapper::after {
      right: 0;
      background: linear-gradient(to left, #FAFAFA, transparent);
    }
    .scroll-container-wrapper.can-scroll-left::before,
    .scroll-container-wrapper.can-scroll-right::after {
      opacity: 1;
    }
    
    /* Cost Analysis Dashboard Mobile Responsive */
    @media (max-width: 768px) {
      .cost-analysis-panel {
        padding: 16px !important;
        margin: 0 -16px 24px -16px !important;
        border-radius: 0 !important;
        border-left: none !important;
        border-right: none !important;
      }
      .cost-analysis-grid {
        display: flex !important;
        flex-direction: column !important;
      }
      .cost-analysis-grid > div {
        grid-column: auto !important;
      }
      .cost-summary-cards {
        grid-template-columns: 1fr 1fr !important;
      }
      .cost-automation-grid {
        grid-template-columns: 1fr !important;
      }
      .cost-automation-section {
        grid-column: auto !important;
      }
    }
    
    @media (max-width: 480px) {
      .cost-summary-cards {
        grid-template-columns: 1fr !important;
      }
    }
    
    /* Mobile Responsive Styles */
    @media (max-width: 768px) {
      /* Perspective filter: show dropdown, hide buttons */
      .perspective-buttons {
        display: none !important;
      }
      .perspective-dropdown {
        display: block !important;
      }
      .perspective-filter {
        padding: 12px 16px !important;
      }
      
      /* Header */
      .header-container {
        padding: 16px !important;
        gap: 12px !important;
      }
      
      .header-logo-title {
        flex-direction: column !important;
        align-items: flex-start !important;
        gap: 8px !important;
      }
      
      .header-divider {
        display: none !important;
      }
      
      .header-logo-title svg {
        width: 90px !important;
        height: auto !important;
      }
      
      .header-logo-title h1 {
        font-size: 20px !important;
      }
      
      /* View toggle buttons */
      .header-buttons {
        gap: 6px !important;
      }
      
      .header-buttons button {
        padding: 7px 10px !important;
        font-size: 11px !important;
      }
      
      /* Stats bar */
      .stats-bar {
        padding: 12px 16px !important;
        gap: 12px !important;
        flex-wrap: wrap !important;
        justify-content: space-between !important;
      }
      
      .stats-bar > div {
        flex: 0 0 calc(50% - 8px) !important;
        min-width: 100px !important;
      }
      
      /* Main content - keep horizontal scroll */
      .main-content {
        padding: 20px 16px !important;
      }
      
      /* Adjust edge-to-edge for mobile padding */
      .stages-container {
        margin-left: -16px !important;
        margin-right: -16px !important;
        padding-left: 16px !important;
        padding-right: 16px !important;
        width: calc(100% + 32px) !important;
        scroll-padding-left: 16px;
        scroll-padding-right: 16px;
      }
      
      .scroll-container-wrapper::before,
      .scroll-container-wrapper::after {
        width: 24px;
      }
    }
    
    /* Small mobile */
    @media (max-width: 480px) {
      .header-logo-title svg {
        width: 80px !important;
      }
      
      .header-logo-title h1 {
        font-size: 18px !important;
      }
      
      .header-buttons button {
        padding: 6px 8px !important;
        font-size: 10px !important;
      }
      
      .stats-bar > div {
        flex: 0 0 calc(50% - 6px) !important;
        min-width: 90px !important;
      }
    }
    
    /* Print Styles */
    @media print {
      body { 
        font-size: 10pt;
        -webkit-print-color-adjust: exact !important;
        print-color-adjust: exact !important;
      }
      
      .no-print { display: none !important; }
      
      .print-break-before { page-break-before: always; }
      .print-break-after { page-break-after: always; }
      .print-avoid-break { page-break-inside: avoid; }
      
      /* Header adjustments */
      header { 
        background: #1A1A1A !important;
        padding: 12px 24px !important;
      }
      
      /* Hide interactive elements */
      button:not(.print-show), 
      .edit-controls,
      [data-hide-print="true"] { 
        display: none !important; 
      }
      
      /* Step cards - ensure colors print */
      .step-card {
        -webkit-print-color-adjust: exact !important;
        print-color-adjust: exact !important;
        page-break-inside: avoid;
      }
      
      /* Ensure backgrounds print */
      * {
        -webkit-print-color-adjust: exact !important;
        print-color-adjust: exact !important;
      }
      
      /* Timeline section */
      .timeline-section {
        page-break-before: always;
        margin-top: 20px;
      }
      
      /* Footer */
      footer {
        position: fixed;
        bottom: 0;
        left: 0;
        right: 0;
        padding: 8px 24px !important;
        font-size: 9pt;
        border-top: 1px solid #ccc;
        background: #f9f9f9 !important;
      }
    }
    
    /* Refresh button spin animation */
    @keyframes spin {
      from { transform: rotate(0deg); }
      to { transform: rotate(360deg); }
    }
    .refresh-spinning {
      animation: spin 1s linear infinite;
      display: inline-block;
    }
    
    /* Smooth transitions for interactive elements */
    .step-item {
      transition: background 0.3s ease, border 0.3s ease, margin 0.3s ease, box-shadow 0.3s ease;
    }
    .step-item:hover {
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }
    .fade-in {
      animation: fadeIn 0.3s ease;
    }
    @keyframes fadeIn {
      from { opacity: 0; }
      to { opacity: 1; }
    }
    .cost-value {
      transition: opacity 0.3s ease;
    }
    .funnel-stat {
      transition: opacity 0.3s ease, transform 0.3s ease;
    }
    .ranking-badge {
      animation: popIn 0.3s ease;
    }
    @keyframes popIn {
      from { transform: scale(0); opacity: 0; }
      to { transform: scale(1); opacity: 1; }
    }
    .view-container {
      animation: fadeIn 0.25s ease;
    }
    .savings-panel {
      animation: slideDown 0.3s ease;
    }
    @keyframes slideDown {
      from { opacity: 0; transform: translateY(-10px); }
      to { opacity: 1; transform: translateY(0); }
    }
    .slide-in-right {
      animation: slideInRight 0.3s ease;
    }
    .slide-in-right-delay-1 {
      animation: slideInRight 0.3s ease 0.1s both;
    }
    .slide-in-right-delay-2 {
      animation: slideInRight 0.3s ease 0.2s both;
    }
    @keyframes slideInRight {
      from { opacity: 0; transform: translateX(20px); }
      to { opacity: 1; transform: translateX(0); }
    }
  </style>
</head>
<body>
  <div id="root"></div>
  
  <script type="text/babel">
    const { useState, useCallback, useMemo, useEffect, useRef } = React;
    
    // Current app version - always displayed in footer
    const APP_VERSION = "8.6.0";

    const generateId = () => Math.random().toString(36).substr(2, 9);

    // Sample configuration JSON
    // __CONFIG_START__
    const defaultConfig = {
      meta: {
        title: "Client Onboarding Journey Digital Twin",
        version: "2.0",
        product: "Steve's Journey Map v8.3.5",
        lastUpdated: new Date().toISOString(),
        audience: "Internal Operations",
        perspective: "client"
      },
      funnel: {
        enabled: true,
        initialVolume: 2042,
        periodLabel: "Feb - Dec 2025"
      },
      personas: [
        { id: "client", label: "Client", color: "#2D5A4B", annualSalary: 0, isExternal: true },
        { id: "fp", label: "Financial Planner", color: "#8B4513", annualSalary: 75000, burdenMultiplier: 1.3, workspaceHourlyCost: 6.5, isExternal: false },
        { id: "im", label: "Investment Manager", color: "#1E40AF", annualSalary: 80000, burdenMultiplier: 1.3, workspaceHourlyCost: 6, isExternal: false },
        { id: "ops", label: "Operations", color: "#6B46C1", annualSalary: 25000, burdenMultiplier: 1.3, workspaceHourlyCost: 6.5, isExternal: false },
        { id: "administrator", label: "FP Administrator", color: "#8B4513", annualSalary: 35000, burdenMultiplier: 1.3, workspaceHourlyCost: 7, isExternal: false },
        { id: "compliance", label: "Compliance", color: "#C53030", annualSalary: 55000, burdenMultiplier: 1.3, workspaceHourlyCost: 6, isExternal: false },
        { id: "paraplanner", label: "Paraplanner", color: "#B45309", annualSalary: 45000, burdenMultiplier: 1.3, workspaceHourlyCost: 6, isExternal: false },
        { id: "new-business-exec", label: "New Business Exec", color: "#7C3AED", annualSalary: 25000, burdenMultiplier: 1.3, workspaceHourlyCost: 6, isExternal: false },
        { id: "im-adminitrator", label: "IM Adminitrator", color: "#1E40AF", annualSalary: 35000, burdenMultiplier: 1.3, workspaceHourlyCost: 6, isExternal: false }
      ],
      stages: [
        {
          id: "lead-receipt",
          name: "Lead Receipt",
          dropOffCount: 0,
          steps: [
            {
              id: "triage",
              name: "Triage",
              description: "Initial assessment of incoming prospect enquiries",
              timeMinutes: 5,
              owner: "new-business-exec",
              touchpoints: ["CRM", "Email"],
              painPoints: [],
              emotions: "neutral",
              frictionScore: 1,
              automationOpportunity: "high",
              automationNotes: "Could be automated with AI triage system",
              regulatoryRequirements: [],
              roleInvolvement: {
                fp: { timeMinutes: 0, headcount: 1 },
                im: { timeMinutes: 0, headcount: 1 },
                ops: { timeMinutes: 0, headcount: 1 },
                "new-business-exec": { timeMinutes: 10, headcount: 1 }
              },
              actions: {
                ops: "",
                "new-business-exec": "Reviews and categorises incoming enquiries",
                client: "Inputs information into our contact form"
              },
              clientTouchpoint: true
            },
            {
              id: "fast-track",
              name: "Fast Track",
              description: "Determine if client has provided enough information to directly contact FP to check availability for immediate call",
              timeMinutes: 10,
              owner: "new-business-exec",
              touchpoints: ["CRM", "Phone", "Email"],
              painPoints: [],
              emotions: "hopeful",
              frictionScore: 2,
              automationOpportunity: "high",
              automationNotes: "AI could assess client information completeness and check FP calendar availability automatically",
              regulatoryRequirements: [],
              roleInvolvement: {
                fp: { timeMinutes: 0, headcount: 1 },
                im: { timeMinutes: 0, headcount: 1 },
                ops: { timeMinutes: 0, headcount: 1 },
                "new-business-exec": { timeMinutes: 10, headcount: 1 }
              },
              actions: {
                ops: "",
                "new-business-exec": "Assesses client information quality, checks FP availability, routes accordingly"
              }
            }
          ]
        },
        {
          id: "opportunity-qualification",
          name: "Opportunity Qualification",
          dropOffCount: 408,
          steps: [
            {
              id: "initial-call",
              name: "Initial Call",
              description: "First contact call with prospect",
              timeMinutes: 20,
              owner: "new-business-exec",
              touchpoints: ["Phone"],
              painPoints: [],
              emotions: "curious",
              frictionScore: 2,
              automationOpportunity: "low",
              automationNotes: "Human interaction important for first contact",
              regulatoryRequirements: [],
              clientTouchpoint: true,
              roleInvolvement: {
                fp: { timeMinutes: 0, headcount: 1 },
                im: { timeMinutes: 0, headcount: 1 },
                ops: { timeMinutes: 0, headcount: 1 },
                "new-business-exec": { timeMinutes: 15, headcount: 1 }
              },
              actions: {
                ops: "",
                "new-business-exec": "Conducts initial call, gathers basic information, listens to client carefully",
                client: "Answers questions and describes the outcome they want"
              }
            },
            {
              id: "update-systems",
              name: "Update Excel, Xplan etc",
              description: "Update CRM and planning systems with prospect details",
              timeMinutes: 12,
              owner: "new-business-exec",
              touchpoints: ["Xplan", "Excel", "CRM"],
              painPoints: ["Manual data entry across multiple systems"],
              emotions: "neutral",
              frictionScore: 2,
              automationOpportunity: "high",
              automationNotes: "System integration could eliminate duplicate entry, looking to implement Evaluagent to transcribe the call information into Xplan",
              regulatoryRequirements: [],
              roleInvolvement: {
                fp: { timeMinutes: 0, headcount: 1 },
                im: { timeMinutes: 0, headcount: 1 },
                ops: { timeMinutes: 0, headcount: 1 },
                "new-business-exec": { timeMinutes: 12, headcount: 1 }
              },
              actions: {
                ops: "",
                "new-business-exec": "Updates all relevant systems with prospect information"
              }
            },
            {
              id: "review-prospect-email",
              name: "Review Prospect Email",
              description: "FP and IM review prospect communications",
              timeMinutes: 20,
              owner: "fp",
              touchpoints: ["Email"],
              painPoints: [],
              emotions: "curious",
              frictionScore: 2,
              automationOpportunity: "medium",
              automationNotes: "AI could summarise and flag key points",
              regulatoryRequirements: [],
              roleInvolvement: {
                fp: { timeMinutes: 10, headcount: 1 },
                im: { timeMinutes: 10, headcount: 1 },
                ops: { timeMinutes: 0, headcount: 1 }
              },
              actions: {
                fp: "Reviews prospect email and requirements",
                im: "Reviews prospect email for investment needs"
              }
            },
            {
              id: "prospect-call",
              name: "Prospect Call",
              description: "Detailed discovery call with prospect",
              timeMinutes: 90,
              owner: "fp",
              touchpoints: ["Phone", "Teams"],
              painPoints: ["Scheduling can be difficult"],
              emotions: "engaged",
              frictionScore: 3,
              automationOpportunity: "low",
              automationNotes: "Human interaction essential",
              regulatoryRequirements: ["Record keeping"],
              clientTouchpoint: true,
              roleInvolvement: {
                fp: { timeMinutes: 45, headcount: 1 },
                im: { timeMinutes: 45, headcount: 1 },
                ops: { timeMinutes: 0, headcount: 1 }
              },
              actions: {
                fp: "Conducts discovery call, understands financial goals",
                im: "Discusses investment approach and philosophy"
              }
            },
            {
              id: "update-xplan-triage",
              name: "Update Xplan Task (Triage)",
              description: "Update Xplan with triage outcome and next steps",
              timeMinutes: 20,
              owner: "fp",
              touchpoints: ["Xplan"],
              painPoints: [],
              emotions: "neutral",
              frictionScore: 2,
              automationOpportunity: "high",
              automationNotes: "Could auto-populate from call notes",
              regulatoryRequirements: [],
              roleInvolvement: {
                fp: { timeMinutes: 10, headcount: 1 },
                im: { timeMinutes: 10, headcount: 1 },
                ops: { timeMinutes: 0, headcount: 1 }
              },
              actions: {
                fp: "Updates Xplan with triage notes",
                im: "Adds investment-related notes"
              }
            }
          ]
        },
        {
          id: "fact-find-collateral",
          name: "Fact Find & Collateral Gathering",
          dropOffCount: 833,
          steps: [
            {
              id: "tax-residency",
              name: "Tax Residency Self Cert & GDPR",
              description: "Complete tax residency self-certification and GDPR",
              timeMinutes: 15,
              owner: "fp",
              touchpoints: ["Forms"],
              painPoints: ["Clients confused by tax questions", "No clear details of downstream impact on other processes"],
              emotions: "uncertain",
              frictionScore: 2,
              automationOpportunity: "high",
              automationNotes: "Digital forms with guidance, validation and automated triggers for downstream processes",
              regulatoryRequirements: ["CRS/FATCA requirements"],
              roleInvolvement: {
                fp: { timeMinutes: 0, headcount: 1 },
                im: { timeMinutes: 0, headcount: 1 },
                ops: { timeMinutes: 0, headcount: 1 },
                administrator: { timeMinutes: 15, headcount: 1 }
              },
              actions: {
                fp: "",
                im: "",
                client: "Completes or provides the information required by this form",
                administrator: "1, Sends the form to the client via adobe sign to complete and sign.\n2, Once completed, saves form to the clients GNL."
              },
              clientTouchpoint: true,
              isHardCheckpoint: true,
              checkpointType: "compliance",
              checkpointDetails: "Clients must have access to our Privacy Policy before we do ID&V / Screening\n"
            },
            {
              id: "idv",
              name: "ID&V",
              description: "Identity and verification checks",
              timeMinutes: 37,
              owner: "ops",
              touchpoints: ["Refinitiv Platform"],
              painPoints: ["Manual process to trigger ID&V", "Manual Process to copy across from xplan to Refinitiv"],
              emotions: "neutral",
              frictionScore: 3,
              automationOpportunity: "high",
              automationNotes: "Straight through processing for the majority of cases,",
              regulatoryRequirements: ["AML/KYC", "MLR 2017"],
              isHardCheckpoint: true,
              checkpointType: "compliance",
              checkpointDetails: "Client identity must be verified to AML/KYC standards before any financial advice can be provided. Requires valid government ID and proof of address dated within 3 months.",
              roleInvolvement: {
                fp: { timeMinutes: 0, headcount: 1 },
                im: { timeMinutes: 0, headcount: 1 },
                ops: { timeMinutes: 29, headcount: 1 },
                administrator: { timeMinutes: 8, headcount: 1 }
              },
              actions: {
                fp: "",
                im: "",
                ops: "Manage the ID&V case via the Refinitiv portal and feed back to front office",
                client: "Provides initial 5 bits of info\nProvides further documented ID or proof if required",
                administrator: "Initiates ID verification request\nCo-ordinates with client for further documentation"
              },
              clientTouchpoint: true,
              additionalCosts: [
                { id: "7nplk13i2", description: "ID & V", amount: 50, category: "third-party" }
              ]
            },
            {
              id: "screening",
              name: "Screening",
              description: "Screen for Politically Exposed Persons and sanctions",
              timeMinutes: 37,
              owner: "ops",
              touchpoints: ["Screening Platform"],
              painPoints: ["False positives require manual review"],
              emotions: "neutral",
              frictionScore: 3,
              automationOpportunity: "high",
              automationNotes: "Straight through processing for the majority of cases,",
              regulatoryRequirements: ["AML regulations", "Sanctions compliance"],
              isHardCheckpoint: true,
              checkpointType: "regulatory",
              checkpointDetails: "PEP and sanctions screening must be completed and cleared before proceeding. Any matches require escalation to Compliance for review and sign-off.",
              roleInvolvement: {
                fp: { timeMinutes: 0, headcount: 1 },
                im: { timeMinutes: 0, headcount: 1 },
                ops: { timeMinutes: 29, headcount: 1 },
                administrator: { timeMinutes: 8, headcount: 1 }
              },
              actions: {
                fp: "Reviews screening results",
                im: "Assesses investment risk implications",
                ops: "Runs screening checks and documents results"
              },
              additionalCosts: [
                { id: "lidhspxb0", description: "Screening", amount: 50, category: "third-party" }
              ]
            },
            {
              id: "loas",
              name: "LOAs",
              description: "Letters of Authority. Client must provide their authorisation for us to gather information from other suppliers.",
              timeMinutes: 488,
              owner: "ops",
              touchpoints: ["Provider Portals", "Post", "Email", "secure messaging"],
              painPoints: ["Provider delays", "Chasing responses", "Different provider processes", "3rd parties require wet signatures", "Manual internal processes"],
              emotions: "waiting",
              frictionScore: 5,
              automationOpportunity: "medium",
              automationNotes: "Opportunity to digitise internal Evelyn manual processes. However a lot of the delays come from 3rd parties which is not within our control to fix.",
              regulatoryRequirements: ["Client consent", "Data protection"],
              roleInvolvement: {
                fp: { timeMinutes: 0, headcount: 1 },
                im: { timeMinutes: 0, headcount: 1 },
                ops: { timeMinutes: 365, headcount: 1 },
                administrator: { timeMinutes: 88, headcount: 1 }
              },
              actions: {
                fp: "",
                im: "Reviews existing investment information",
                ops: "1, Script team will follow up to check that the 3rd party received the LOA and find out timescales for info return3, Once the info is returned by the provider, script team then create a \"script\" filling in the info provided and then they will contact the 3rd party to get any information that is missing.\n3, Once complete, the script team then re-key the information back into xplan",
                client: "Client will receive a LOA to physically sign that covers each provider that they have current holdings with. They will need to print out the letter, sign it, scan it and then send it back to us.",
                administrator: "1. Prepares LOA letter to send to clients.\n2. Once retuned, send LOA along with a covering letter to each provider to request asset info\n3, Create a task for the script team* to chase providers and create script for more info if required"
              },
              isHardCheckpoint: true,
              clientTouchpoint: true,
              checkpointType: "regulatory"
            },
            {
              id: "fact-find-a",
              name: "Fact Find A",
              description: "Comprehensive fact find - Part A",
              timeMinutes: 390,
              owner: "fp",
              touchpoints: ["In-person", "Teams", "Xplan"],
              painPoints: ["Time intensive", "Client preparation varies", "Large volumes of data to collect", "Manual rekeyng into xplan", "Asking for information already gathered elsewhere"],
              emotions: ["engaged", "overwhelmed"],
              frictionScore: 5,
              automationOpportunity: "medium",
              automationNotes: "Digital fact find with pre-population. Improved Source of Wealth questions.",
              regulatoryRequirements: ["COBS suitability", "Know Your Client"],
              clientTouchpoint: true,
              roleInvolvement: {
                fp: { timeMinutes: 330, headcount: 1 },
                im: { timeMinutes: 0, headcount: 1 },
                ops: { timeMinutes: 0, headcount: 1 },
                administrator: { timeMinutes: 60, headcount: 1 }
              },
              actions: {
                fp: "Conducts comprehensive fact find meeting(s), takes notes or updates forms",
                im: "",
                client: "Provides information required",
                administrator: "Updates the Fact Find A form information into Xplan"
              },
              isHardCheckpoint: true,
              checkpointType: "vetting",
              checkpointDetails: "FFA exists in the DNL and information provided reviewed"
            },
            {
              id: "craf",
              name: "CRAF",
              description: "Client Risk Assessment Form",
              timeMinutes: 103.5,
              owner: "fp",
              touchpoints: ["xplan"],
              painPoints: ["Complex risk scoring", "Poor explanation of clients Source of Wealth", "Highest cause of vetting failures", "Large amounts of back and forth with the client", "Large gap in time between gathering SOW and vetting CRAF"],
              emotions: ["frustrated"],
              frictionScore: 4,
              automationOpportunity: "high",
              automationNotes: "Potential to remove the CRAF form completely, automate the risk calculation from Source of wealth on FFA and introduce a new CRA approval process",
              regulatoryRequirements: ["FCA ATR requirements", "Capacity for loss"],
              roleInvolvement: {
                fp: { timeMinutes: 90, headcount: 1 },
                im: { timeMinutes: 0, headcount: 1 },
                ops: { timeMinutes: 13.5, headcount: 1 }
              },
              actions: {
                fp: "1. Completes the CRAF based on the information provided by the client.\n2. Uses Financial Crime guidance document to calculate the risk level\n3, Liaises with client to provide any additional info\n4. Approves final risk level",
                im: "",
                ops: "1. Vetting- reviews the CRAF to ensure that it meets the Financial Crime Guidance and cross checks the info provided with LOAs and My Wealth.\n2. Works with Front office to get more information from the client when required."
              },
              isHardCheckpoint: true,
              checkpointType: "regulatory",
              checkpointDetails: "Client Risk Assessment needs to be completed (including any enhanced due diligence and approvals) and signed off by Front Office prior to completing Fact Find B."
            },
            {
              id: "fact-find-b",
              name: "Fact Find B",
              description: "Comprehensive fact find - Part B (follow-up)",
              timeMinutes: 60,
              owner: "fp",
              touchpoints: ["xplan"],
              painPoints: [],
              emotions: ["neutral"],
              frictionScore: 3,
              automationOpportunity: "low",
              automationNotes: "Some digitisation potential. Further discovery required.",
              regulatoryRequirements: ["COBS suitability"],
              clientTouchpoint: false,
              roleInvolvement: {
                fp: { timeMinutes: 60, headcount: 1 },
                im: { timeMinutes: 0, headcount: 1 },
                ops: { timeMinutes: 0, headcount: 1 }
              },
              actions: {
                fp: "Completes the Fact Find B on xplan. This is essentially and review and overview of the information collected during Fact Find A including Oxford Risk, Client Vulnerabilities Objectives, Investment knowledge etc,",
                im: "",
                paraplanner: "Uses Fact Find B as the summary that to feeds into Advice research and analysis"
              },
              isHardCheckpoint: true,
              checkpointType: "vetting",
              checkpointDetails: "FFB needs to be in place before Stage 4 can commence"
            }
          ]
        },
        {
          id: "advice",
          name: "Advice / Contract",
          dropOffCount: 500,
          steps: [
            {
              id: "pricing-propositions",
              name: "Pricing & Propositions",
              description: "Research and analysis for pricing and investment propositions",
              timeMinutes: 894,
              owner: "paraplanner",
              touchpoints: ["Research Tools", "Planning Software"],
              painPoints: ["Time intensive research", "Complex analysis", "Paraplanners often have to request updated valuations from 3rd parties due to time lapsed since LOA", "Long wait times for clients due to Paraplanner backlogs"],
              emotions: "waiting",
              frictionScore: 5,
              automationOpportunity: "medium",
              automationNotes: "AI-assisted research and analysis tools",
              regulatoryRequirements: ["Best execution", "Suitability"],
              roleInvolvement: {
                fp: { timeMinutes: 30, headcount: 1 },
                im: { timeMinutes: 0, headcount: 1 },
                ops: { timeMinutes: 0, headcount: 1 },
                paraplanner: { timeMinutes: 864, headcount: 1 }
              },
              actions: {
                fp: "Submits request to Paraplanner",
                im: "",
                paraplanner: "1, Checks that all correct information has been collected by FP\n2, Conducts research and develops propositions"
              }
            },
            {
              id: "fee-illustration",
              name: "Fee Illustration",
              description: "Prepare fee illustrations and cost disclosures",
              timeMinutes: 84,
              owner: "paraplanner",
              touchpoints: ["Illustration Software"],
              painPoints: ["complex process"],
              emotions: ["waiting"],
              frictionScore: 2,
              automationOpportunity: "high",
              automationNotes: "Template-based generation",
              regulatoryRequirements: ["MiFID II cost disclosure", "Consumer Duty"],
              roleInvolvement: {
                fp: { timeMinutes: 0, headcount: 1 },
                im: { timeMinutes: 0, headcount: 1 },
                ops: { timeMinutes: 0, headcount: 1 },
                paraplanner: { timeMinutes: 84, headcount: 1 }
              },
              actions: {
                fp: "",
                im: "",
                paraplanner: "Prepares fee illustrations"
              }
            },
            {
              id: "advice-report",
              name: "Advice Report",
              description: "Comprehensive suitability and advice report",
              timeMinutes: 750,
              owner: "paraplanner",
              touchpoints: ["Report Software", "Siesmic"],
              painPoints: ["Report writing time intensive", "Compliance review delays", "Rekeying info"],
              emotions: "waiting",
              frictionScore: 5,
              automationOpportunity: "high",
              automationNotes: "AI-assisted report generation",
              regulatoryRequirements: ["COBS 9.4 suitability reports", "Clear, fair, not misleading"],
              roleInvolvement: {
                fp: { timeMinutes: 30, headcount: 1 },
                im: { timeMinutes: 0, headcount: 1 },
                ops: { timeMinutes: 0, headcount: 1 },
                paraplanner: { timeMinutes: 720, headcount: 1 }
              },
              actions: {
                fp: "Reviews and sends report to Client",
                im: "Contributes investment rationale section",
                paraplanner: "Writes comprehensive suitability and advice report",
                client: "Reviews report"
              }
            },
            {
              id: "account-opening-forms",
              name: "Application Forms",
              description: "Complete account opening applications",
              timeMinutes: 142,
              owner: "administrator",
              touchpoints: ["AdobeSign", "xplan", "Form finder"],
              painPoints: ["Adobesign only allows 1 single person to manage that document", "Multiple versions of each form depending on service, account type and entity", "Form finder can be complex to find the correct form", "Manual rekeying from xplan into adobe sign to prepopulate for client", "Duplication of information that already exists"],
              emotions: ["neutral"],
              frictionScore: 5,
              automationOpportunity: "high",
              automationNotes: "Digital Dynamic Forms prepopulate all Application forms with API integration for straight-through processing to and from xplan",
              regulatoryRequirements: ["Client consent", "Accurate data"],
              roleInvolvement: {
                fp: { timeMinutes: 0, headcount: 1 },
                im: { timeMinutes: 0, headcount: 1 },
                ops: { timeMinutes: 102, headcount: 1 },
                administrator: { timeMinutes: 40, headcount: 1 }
              },
              actions: {
                fp: "",
                im: "",
                ops: "TBC",
                administrator: "Manages completion of the forms with the client",
                client: "Receives Application Forms to review/complete and sign"
              },
              clientTouchpoint: true,
              isHardCheckpoint: true,
              checkpointType: "vetting",
              checkpointDetails: "Cannot open the accounts if the Account opening form has not been completed or signed"
            },
            {
              id: "vetting",
              name: "Vetting",
              description: "Internal vetting and compliance review",
              timeMinutes: 139,
              owner: "fp",
              touchpoints: ["xplan", "Case Manager", "Excel"],
              painPoints: ["Manual vetting checks using excel", "Each account to be opened has it's own set of checks", "Checking Front Office work", "vetting done at the very end of the process rather than inline", "High failure rates (60%)"],
              emotions: "waiting",
              frictionScore: 5,
              automationOpportunity: "high",
              automationNotes: "Automated asynchronous vetting checks done digitally throughout the process rather than at the end,",
              regulatoryRequirements: ["Internal compliance", "Sign-off requirements"],
              roleInvolvement: {
                fp: { timeMinutes: 20, headcount: 1 },
                im: { timeMinutes: 0, headcount: 1 },
                ops: { timeMinutes: 40, headcount: 1 },
                administrator: { timeMinutes: 79, headcount: 1 }
              },
              actions: {
                fp: "Liaise with Administrator and client when needed",
                im: "",
                ops: "Undertakes vetting checks",
                administrator: "Raise Account Opening Request\nLiaise with client and Vetting team to resolve issues, gather more info"
              },
              isHardCheckpoint: true,
              checkpointType: "vetting",
              checkpointDetails: "Cannot commence account opening until the case has passed vetting"
            },
            {
              id: "account-opening",
              name: "Account Opening",
              description: "Finalise account opening with providers",
              timeMinutes: 115,
              owner: "ops",
              touchpoints: ["xplan", "SEI", "Avaloq"],
              painPoints: ["Manual rekeying of data from xplan into Avaloq or SEI to open accounts"],
              emotions: ["neutral"],
              frictionScore: 2,
              automationOpportunity: "medium",
              automationNotes: "API submission to appropriate systems",
              regulatoryRequirements: ["Provider requirements"],
              roleInvolvement: {
                fp: { timeMinutes: 0, headcount: 1 },
                im: { timeMinutes: 0, headcount: 1 },
                ops: { timeMinutes: 115.2, headcount: 1 }
              },
              actions: {
                ops: "Key data from xplan to Avaloq or SEI to open the accounts"
              }
            }
          ]
        },
        {
          id: "transfers-in",
          name: "Transfers In",
          dropOffCount: 150,
          steps: [
            {
              id: "initiation",
              name: "Initiation",
              description: "Initiate transfer requests",
              timeMinutes: 49,
              owner: "ops",
              touchpoints: ["Provider Portals", "Origo"],
              painPoints: [],
              emotions: "hopeful",
              frictionScore: 2,
              automationOpportunity: "high",
              automationNotes: "Origo/PPEX automation",
              regulatoryRequirements: ["Transfer procedures"],
              roleInvolvement: {
                fp: { timeMinutes: 8.7, headcount: 1 },
                im: { timeMinutes: 8.7, headcount: 1 },
                ops: { timeMinutes: 40, headcount: 1 }
              },
              actions: {
                fp: "Approves transfer initiation",
                im: "Confirms transfer requirements",
                ops: "Submits transfer requests"
              }
            },
            {
              id: "new-transfer-validation",
              name: "New Transfer / Validation",
              description: "Validate incoming transfer details",
              timeMinutes: 25,
              owner: "ops",
              touchpoints: ["Back Office Systems"],
              painPoints: ["Data validation issues"],
              emotions: "neutral",
              frictionScore: 2,
              automationOpportunity: "high",
              automationNotes: "Automated validation rules",
              regulatoryRequirements: [],
              roleInvolvement: {
                fp: { timeMinutes: 0, headcount: 1 },
                im: { timeMinutes: 0, headcount: 1 },
                ops: { timeMinutes: 25, headcount: 1 }
              },
              actions: {
                ops: "Validates transfer data and documentation"
              }
            },
            {
              id: "chase-counterparty",
              name: "Chase Counterparty",
              description: "Follow up with ceding providers",
              timeMinutes: 66,
              owner: "ops",
              touchpoints: ["Phone", "Email", "Provider Portals"],
              painPoints: ["Provider delays", "Difficult to reach providers"],
              emotions: "frustrated",
              frictionScore: 3,
              automationOpportunity: "medium",
              automationNotes: "Automated chase sequences",
              regulatoryRequirements: [],
              roleInvolvement: {
                fp: { timeMinutes: 0, headcount: 1 },
                im: { timeMinutes: 0, headcount: 1 },
                ops: { timeMinutes: 66, headcount: 1 }
              },
              actions: {
                ops: "Chases ceding providers for transfer progress"
              }
            },
            {
              id: "check-valuation",
              name: "Check Valuation",
              description: "Verify transfer valuations",
              timeMinutes: 74,
              owner: "ops",
              touchpoints: ["Provider Portals", "Back Office"],
              painPoints: ["Valuation discrepancies"],
              emotions: "neutral",
              frictionScore: 2,
              automationOpportunity: "medium",
              automationNotes: "Automated valuation comparison",
              regulatoryRequirements: ["Accurate record keeping"],
              roleInvolvement: {
                fp: { timeMinutes: 30, headcount: 1 },
                im: { timeMinutes: 30, headcount: 1 },
                ops: { timeMinutes: 44, headcount: 1 }
              },
              actions: {
                fp: "Reviews valuation accuracy",
                im: "Confirms investment valuations",
                ops: "Checks and reconciles valuations"
              }
            },
            {
              id: "trades-acceptance",
              name: "Trades / Acceptance",
              description: "Accept transfers and execute trades",
              timeMinutes: 125,
              owner: "ops",
              touchpoints: ["Trading Platform", "Back Office"],
              painPoints: ["Market timing considerations"],
              emotions: "neutral",
              frictionScore: 3,
              automationOpportunity: "medium",
              automationNotes: "Automated trade execution rules",
              regulatoryRequirements: ["Best execution", "Trade reporting"],
              roleInvolvement: {
                fp: { timeMinutes: 5, headcount: 1 },
                im: { timeMinutes: 5, headcount: 1 },
                ops: { timeMinutes: 120, headcount: 1 }
              },
              actions: {
                fp: "Approves trade execution",
                im: "Confirms investment allocation",
                ops: "Executes trades and processes transfers"
              }
            },
            {
              id: "update-portfolio",
              name: "Update Portfolio",
              description: "Update portfolio systems with transferred assets",
              timeMinutes: 15,
              owner: "ops",
              touchpoints: ["Portfolio Management System"],
              painPoints: [],
              emotions: "neutral",
              frictionScore: 1,
              automationOpportunity: "high",
              automationNotes: "Automated portfolio updates",
              regulatoryRequirements: [],
              roleInvolvement: {
                fp: { timeMinutes: 0, headcount: 1 },
                im: { timeMinutes: 0, headcount: 1 },
                ops: { timeMinutes: 15, headcount: 1 }
              },
              actions: {
                ops: "Updates portfolio records"
              }
            },
            {
              id: "check-transfer-status",
              name: "Check Transfer Status",
              description: "Monitor and verify transfer completion",
              timeMinutes: 5,
              owner: "ops",
              touchpoints: ["Provider Portals"],
              painPoints: [],
              emotions: "neutral",
              frictionScore: 1,
              automationOpportunity: "high",
              automationNotes: "Automated status tracking",
              regulatoryRequirements: [],
              roleInvolvement: {
                fp: { timeMinutes: 0, headcount: 1 },
                im: { timeMinutes: 0, headcount: 1 },
                ops: { timeMinutes: 5, headcount: 1 }
              },
              actions: {
                ops: "Monitors transfer status"
              }
            },
            {
              id: "closure",
              name: "Closure",
              description: "Complete transfer and close out process",
              timeMinutes: 44,
              owner: "ops",
              touchpoints: ["Back Office", "CRM"],
              painPoints: [],
              emotions: "satisfied",
              frictionScore: 2,
              automationOpportunity: "medium",
              automationNotes: "Automated completion workflow",
              regulatoryRequirements: ["Record keeping"],
              roleInvolvement: {
                fp: { timeMinutes: 0, headcount: 1 },
                im: { timeMinutes: 0, headcount: 1 },
                ops: { timeMinutes: 44, headcount: 1 }
              },
              actions: {
                ops: "Closes transfer case, updates records"
              }
            }
          ]
        }
      ]
    };
    // __CONFIG_END__

    const emotionColors = {
      hopeful: { bg: '#E6F4EA', text: '#137333', icon: 'ðŸŒ±' },
      curious: { bg: '#E8F0FE', text: '#1967D2', icon: 'ðŸ”' },
      overwhelmed: { bg: '#FCE8E6', text: '#C5221F', icon: 'ðŸ˜°' },
      engaged: { bg: '#E6F4EA', text: '#137333', icon: 'ðŸ’¬' },
      uncertain: { bg: '#FEF7E0', text: '#B06000', icon: 'ðŸ¤”' },
      waiting: { bg: '#F3E8FF', text: '#7C3AED', icon: 'â³' },
      excited: { bg: '#E6F4EA', text: '#137333', icon: 'âœ¨' },
      neutral: { bg: '#F1F3F4', text: '#5F6368', icon: 'âž¡ï¸' },
      satisfied: { bg: '#E6F4EA', text: '#137333', icon: 'âœ…' },
      frustrated: { bg: '#FCE8E6', text: '#C5221F', icon: 'ðŸ˜¤' },
      confident: { bg: '#E6F4EA', text: '#137333', icon: 'ðŸ’ª' },
      anxious: { bg: '#FEF7E0', text: '#B06000', icon: 'ðŸ˜Ÿ' }
    };

    const automationColors = {
      high: { bg: '#DCFCE7', text: '#166534', label: 'High' },
      medium: { bg: '#FEF9C3', text: '#854D0E', label: 'Medium' },
      low: { bg: '#FEE2E2', text: '#991B1B', label: 'Low' },
      none: { bg: '#F3F4F6', text: '#6B7280', label: 'None' }
    };

    const frictionConfig = {
      1: { emoji: 'ðŸ˜Š', color: '#22C55E', bg: '#DCFCE7', label: 'Low' },
      2: { emoji: 'ðŸ˜', color: '#84CC16', bg: '#ECFCCB', label: 'Mild' },
      3: { emoji: 'ðŸ˜•', color: '#EAB308', bg: '#FEF9C3', label: 'Moderate' },
      4: { emoji: 'ðŸ˜£', color: '#F97316', bg: '#FFEDD5', label: 'High' },
      5: { emoji: 'ðŸ¥µ', color: '#EF4444', bg: '#FEE2E2', label: 'Severe' }
    };

    // Cost calculation helpers
    const WORKING_HOURS_PER_YEAR = 1820; // 52 weeks * 35 hours (UK standard)
    
    // Calculate base hourly rate from annual salary (for display purposes)
    const calculateHourlyRate = (annualSalary) => {
      if (!annualSalary || annualSalary === 0) return 0;
      return annualSalary / WORKING_HOURS_PER_YEAR;
    };
    
    // Calculate fully-loaded hourly rate including burden and workspace
    const calculateFullyLoadedRate = (persona) => {
      if (!persona || persona.isExternal || !persona.annualSalary) return 0;
      const baseHourly = persona.annualSalary / WORKING_HOURS_PER_YEAR;
      const burdenMultiplier = persona.burdenMultiplier || 1.0;
      const workspaceHourly = persona.workspaceHourlyCost || 0;
      return (baseHourly * burdenMultiplier) + workspaceHourly;
    };

    const calculateStepCost = (step, personas) => {
      let totalCost = 0;
      
      // Labour costs (with burden and workspace)
      if (step.roleInvolvement) {
        Object.entries(step.roleInvolvement).forEach(([roleId, involvement]) => {
          const persona = personas.find(p => p.id === roleId);
          if (persona && !persona.isExternal && persona.annualSalary > 0) {
            const fullyLoadedRate = calculateFullyLoadedRate(persona);
            const hours = (involvement.timeMinutes || 0) / 60;
            const headcount = involvement.headcount || 1;
            totalCost += fullyLoadedRate * hours * headcount;
          }
        });
      }
      
      // Additional costs (third-party services, materials, etc.)
      if (step.additionalCosts && Array.isArray(step.additionalCosts)) {
        step.additionalCosts.forEach(cost => {
          totalCost += cost.amount || 0;
        });
      }
      
      return totalCost;
    };
    
    // Calculate labour cost only (excluding additional costs)
    const calculateStepLabourCost = (step, personas) => {
      if (!step.roleInvolvement) return 0;
      
      let totalCost = 0;
      Object.entries(step.roleInvolvement).forEach(([roleId, involvement]) => {
        const persona = personas.find(p => p.id === roleId);
        if (persona && !persona.isExternal && persona.annualSalary > 0) {
          const fullyLoadedRate = calculateFullyLoadedRate(persona);
          const hours = (involvement.timeMinutes || 0) / 60;
          const headcount = involvement.headcount || 1;
          totalCost += fullyLoadedRate * hours * headcount;
        }
      });
      return totalCost;
    };
    
    // Calculate additional costs only
    const calculateStepAdditionalCosts = (step) => {
      if (!step.additionalCosts || !Array.isArray(step.additionalCosts)) return 0;
      return step.additionalCosts.reduce((acc, cost) => acc + (cost.amount || 0), 0);
    };

    const formatCurrency = (amount) => {
      return new Intl.NumberFormat('en-GB', {
        style: 'currency',
        currency: 'GBP',
        minimumFractionDigits: 0,
        maximumFractionDigits: 0
      }).format(amount);
    };

    const formatCurrencyDetailed = (amount) => {
      return new Intl.NumberFormat('en-GB', {
        style: 'currency',
        currency: 'GBP',
        minimumFractionDigits: 2,
        maximumFractionDigits: 2
      }).format(amount);
    };

    // Funnel calculation helpers
    const calculateFunnelMetrics = (config) => {
      const { funnel, stages, personas } = config;
      if (!funnel?.enabled || !funnel?.initialVolume) {
        return null;
      }

      let currentVolume = funnel.initialVolume;
      let totalStageInvestment = 0;
      let totalWastedCost = 0;
      let totalCostPerClient = 0;
      
      const stageMetrics = stages.map((stage, index) => {
        const entryVolume = currentVolume;
        
        // Cost per client for THIS stage only
        const stageCostPerClient = stage.steps.reduce((acc, step) => acc + calculateStepCost(step, personas), 0);
        totalCostPerClient += stageCostPerClient;
        
        const dropOff = stage.dropOffCount || 0;
        const exitVolume = Math.max(0, entryVolume - dropOff);
        const completionRate = entryVolume > 0 ? (exitVolume / entryVolume) * 100 : 0;
        
        // Stage Investment = clients who PASSED Ã— cost (productive spend)
        const stageInvestment = exitVolume * stageCostPerClient;
        totalStageInvestment += stageInvestment;
        
        // Wasted = drop-offs Ã— cost for THIS stage (unproductive spend)
        const wastedCost = dropOff * stageCostPerClient;
        totalWastedCost += wastedCost;
        
        currentVolume = exitVolume;
        
        return {
          stageId: stage.id,
          stageName: stage.name,
          entryVolume,
          exitVolume,
          dropOff,
          completionRate,
          stageCostPerClient,
          stageInvestment,
          wastedCost
        };
      });

      const finalVolume = currentVolume;
      const overallConversionRate = funnel.initialVolume > 0 
        ? (finalVolume / funnel.initialVolume) * 100 
        : 0;
      
      const totalDropOff = funnel.initialVolume - finalVolume;

      return {
        initialVolume: funnel.initialVolume,
        finalVolume,
        totalDropOff,
        overallConversionRate,
        totalCostPerClient,
        totalStageInvestment,
        totalWastedCost,
        periodLabel: funnel.periodLabel || 'per period',
        stageMetrics
      };
    };

    // Funnel Dashboard Component
    function FunnelDashboard({ config, formatTime, onClose }) {
      const funnelMetrics = calculateFunnelMetrics(config);
      
      if (!funnelMetrics) {
        return (
          <div style={{ padding: '24px 32px' }}>
            <p>Funnel tracking is not enabled. Enable it in settings to see volume and cost analysis.</p>
          </div>
        );
      }

      const { stageMetrics, initialVolume, finalVolume, totalDropOff, overallConversionRate, totalCostPerClient, totalStageInvestment, totalWastedCost, periodLabel } = funnelMetrics;
      
      const worstStage = [...stageMetrics].sort((a, b) => a.completionRate - b.completionRate)[0];
      const mostWasteful = [...stageMetrics].sort((a, b) => b.wastedCost - a.wastedCost)[0];

      return (
        <div style={{ padding: '24px 32px' }}>
          <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: '20px' }}>
            <h3 style={{ margin: 0, fontSize: '18px', fontWeight: 600, display: 'flex', alignItems: 'center', gap: '8px' }}>
              <span>ðŸ”»</span> Funnel Analysis Dashboard
            </h3>
            <div style={{ display: 'flex', gap: '24px', alignItems: 'center' }}>
              <span style={{ fontFamily: "'Helvetica Neue', Arial, sans-serif", fontSize: '12px', color: '#666' }}>{periodLabel}</span>
              {onClose && <button onClick={onClose} style={{ background: 'none', border: 'none', fontSize: '20px', cursor: 'pointer', color: '#999', padding: '0 4px' }}>Ã—</button>}
            </div>
          </div>
          
          {/* Summary Cards */}
          <div style={{ display: 'grid', gridTemplateColumns: 'repeat(auto-fit, minmax(130px, 1fr))', gap: '12px', marginBottom: '24px' }}>
            <div style={{ background: '#DBEAFE', padding: '14px', borderRadius: '12px', textAlign: 'center' }}>
              <div style={{ fontSize: '20px', fontWeight: 700, color: '#1E40AF' }}>{initialVolume.toLocaleString()}</div>
              <div style={{ fontSize: '10px', color: '#1E40AF', fontFamily: "'Helvetica Neue', Arial, sans-serif", marginTop: '4px' }}>Initial Volume</div>
            </div>
            <div style={{ background: '#DCFCE7', padding: '14px', borderRadius: '12px', textAlign: 'center' }}>
              <div style={{ fontSize: '20px', fontWeight: 700, color: '#166534' }}>{finalVolume.toLocaleString()}</div>
              <div style={{ fontSize: '10px', color: '#166534', fontFamily: "'Helvetica Neue', Arial, sans-serif", marginTop: '4px' }}>Completed</div>
            </div>
            <div style={{ background: '#FEE2E2', padding: '14px', borderRadius: '12px', textAlign: 'center' }}>
              <div style={{ fontSize: '20px', fontWeight: 700, color: '#DC2626' }}>{totalDropOff.toLocaleString()}</div>
              <div style={{ fontSize: '10px', color: '#DC2626', fontFamily: "'Helvetica Neue', Arial, sans-serif", marginTop: '4px' }}>Total Drop-off</div>
            </div>
            <div style={{ background: '#F3E8FF', padding: '14px', borderRadius: '12px', textAlign: 'center' }}>
              <div style={{ fontSize: '20px', fontWeight: 700, color: '#7C3AED' }}>{overallConversionRate.toFixed(1)}%</div>
              <div style={{ fontSize: '10px', color: '#7C3AED', fontFamily: "'Helvetica Neue', Arial, sans-serif", marginTop: '4px' }}>Conversion Rate</div>
            </div>
            <div style={{ background: '#DCFCE7', padding: '14px', borderRadius: '12px', textAlign: 'center' }}>
              <div style={{ fontSize: '20px', fontWeight: 700, color: '#166534' }}>{formatCurrency(totalStageInvestment)}</div>
              <div style={{ fontSize: '10px', color: '#166534', fontFamily: "'Helvetica Neue', Arial, sans-serif", marginTop: '4px' }}>Good Cost</div>
            </div>
            <div style={{ background: '#FEE2E2', padding: '14px', borderRadius: '12px', textAlign: 'center' }}>
              <div style={{ fontSize: '20px', fontWeight: 700, color: '#DC2626' }}>{formatCurrency(totalWastedCost)}</div>
              <div style={{ fontSize: '10px', color: '#DC2626', fontFamily: "'Helvetica Neue', Arial, sans-serif", marginTop: '4px' }}>Bad Cost</div>
            </div>
            <div style={{ background: '#FEF3C7', padding: '14px', borderRadius: '12px', textAlign: 'center' }}>
              <div style={{ fontSize: '20px', fontWeight: 700, color: '#92400E' }}>{formatCurrency(totalStageInvestment + totalWastedCost)}</div>
              <div style={{ fontSize: '10px', color: '#92400E', fontFamily: "'Helvetica Neue', Arial, sans-serif", marginTop: '4px' }}>Total Spend</div>
            </div>
          </div>

          {/* Funnel Visualization */}
          <div style={{ marginBottom: '24px' }}>
            <div style={{ fontSize: '11px', fontFamily: "'Helvetica Neue', Arial, sans-serif", color: '#666', marginBottom: '8px', textTransform: 'uppercase', letterSpacing: '0.5px' }}>
              Volume Flow by Stage
            </div>
            <div style={{ display: 'flex', flexDirection: 'column', gap: '4px' }}>
              {stageMetrics.map((stage, i) => {
                const widthPercent = initialVolume > 0 ? (stage.entryVolume / initialVolume) * 100 : 0;
                const exitWidthPercent = initialVolume > 0 ? (stage.exitVolume / initialVolume) * 100 : 0;
                return (
                  <div key={stage.stageId} style={{ display: 'flex', alignItems: 'center', gap: '12px' }}>
                    <div style={{ width: '140px', fontSize: '12px', fontFamily: "'Helvetica Neue', Arial, sans-serif", color: '#333', textAlign: 'right' }}>{stage.stageName}</div>
                    <div style={{ flex: 1, position: 'relative', height: '32px', background: '#F5F5F5', borderRadius: '4px' }}>
                      <div style={{ position: 'absolute', left: 0, top: 0, height: '100%', width: `${widthPercent}%`, background: `hsl(${i * 45 + 180}, 35%, 75%)`, borderRadius: '4px', transition: 'width 0.3s' }} />
                      <div style={{ position: 'absolute', left: 0, top: 0, height: '100%', width: `${exitWidthPercent}%`, background: `hsl(${i * 45 + 180}, 35%, 55%)`, borderRadius: '4px', transition: 'width 0.3s' }} />
                      {stage.dropOff > 0 && (
                        <div style={{ position: 'absolute', left: `${exitWidthPercent}%`, top: '50%', transform: 'translateY(-50%)', background: '#EF4444', color: '#FFF', padding: '2px 6px', borderRadius: '4px', fontSize: '10px', fontFamily: "'Helvetica Neue', Arial, sans-serif", fontWeight: 600, marginLeft: '4px' }}>-{stage.dropOff}</div>
                      )}
                    </div>
                    <div style={{ width: '80px', fontSize: '12px', fontFamily: "'Helvetica Neue', Arial, sans-serif", color: '#666' }}>{stage.exitVolume.toLocaleString()} ({stage.completionRate.toFixed(0)}%)</div>
                  </div>
                );
              })}
            </div>
          </div>

          {/* Stage Breakdown Table */}
          <div style={{ marginTop: '24px' }}>
            <div style={{ fontSize: '11px', fontFamily: "'Helvetica Neue', Arial, sans-serif", color: '#666', marginBottom: '8px', textTransform: 'uppercase', letterSpacing: '0.5px' }}>Stage-by-Stage Breakdown</div>
            <div style={{ overflowX: 'auto' }}>
              <table style={{ width: '100%', borderCollapse: 'collapse', fontFamily: "'Helvetica Neue', Arial, sans-serif", fontSize: '12px' }}>
                <thead>
                  <tr style={{ borderBottom: '2px solid #E5E5E5' }}>
                    <th style={{ textAlign: 'left', padding: '10px 8px', color: '#666', fontWeight: 600 }}>Stage</th>
                    <th style={{ textAlign: 'right', padding: '10px 8px', color: '#666', fontWeight: 600 }}>Entry</th>
                    <th style={{ textAlign: 'right', padding: '10px 8px', color: '#666', fontWeight: 600 }}>Drop-off</th>
                    <th style={{ textAlign: 'right', padding: '10px 8px', color: '#666', fontWeight: 600 }}>Exit</th>
                    <th style={{ textAlign: 'right', padding: '10px 8px', color: '#666', fontWeight: 600 }}>Rate</th>
                    <th style={{ textAlign: 'right', padding: '10px 8px', color: '#666', fontWeight: 600 }}>Cost/Client</th>
                    <th style={{ textAlign: 'right', padding: '10px 8px', color: '#166534', fontWeight: 600 }}>Good Cost</th>
                    <th style={{ textAlign: 'right', padding: '10px 8px', color: '#DC2626', fontWeight: 600 }}>Bad Cost</th>
                  </tr>
                </thead>
                <tbody>
                  {stageMetrics.map((stage, i) => (
                    <tr key={stage.stageId} style={{ borderBottom: '1px solid #F0F0F0' }}>
                      <td style={{ padding: '10px 8px', fontWeight: 500 }}><span style={{ display: 'inline-block', width: '8px', height: '8px', borderRadius: '2px', background: `hsl(${i * 45 + 180}, 35%, 55%)`, marginRight: '8px' }} />{stage.stageName}</td>
                      <td style={{ textAlign: 'right', padding: '10px 8px', color: '#1E40AF' }}>{stage.entryVolume.toLocaleString()}</td>
                      <td style={{ textAlign: 'right', padding: '10px 8px', color: stage.dropOff > 0 ? '#DC2626' : '#999' }}>{stage.dropOff > 0 ? `-${stage.dropOff.toLocaleString()}` : 'â€”'}</td>
                      <td style={{ textAlign: 'right', padding: '10px 8px', color: '#166534' }}>{stage.exitVolume.toLocaleString()}</td>
                      <td style={{ textAlign: 'right', padding: '10px 8px' }}><span style={{ padding: '2px 8px', borderRadius: '10px', background: stage.completionRate >= 90 ? '#DCFCE7' : stage.completionRate >= 70 ? '#FEF9C3' : '#FEE2E2', color: stage.completionRate >= 90 ? '#166534' : stage.completionRate >= 70 ? '#854D0E' : '#DC2626', fontWeight: 500 }}>{stage.completionRate.toFixed(0)}%</span></td>
                      <td style={{ textAlign: 'right', padding: '10px 8px', color: '#666' }}>{formatCurrency(stage.stageCostPerClient)}</td>
                      <td style={{ textAlign: 'right', padding: '10px 8px', fontWeight: 500, color: '#166534' }}>{formatCurrency(stage.stageInvestment)}</td>
                      <td style={{ textAlign: 'right', padding: '10px 8px', color: '#DC2626', fontWeight: stage.wastedCost > 0 ? 600 : 400 }}>{stage.wastedCost > 0 ? formatCurrency(stage.wastedCost) : 'â€”'}</td>
                    </tr>
                  ))}
                </tbody>
                <tfoot>
                  <tr style={{ borderTop: '2px solid #E5E5E5', background: '#F9FAFB' }}>
                    <td style={{ padding: '10px 8px', fontWeight: 600 }}>Total</td>
                    <td style={{ textAlign: 'right', padding: '10px 8px', fontWeight: 600, color: '#1E40AF' }}>{initialVolume.toLocaleString()}</td>
                    <td style={{ textAlign: 'right', padding: '10px 8px', fontWeight: 600, color: '#DC2626' }}>-{totalDropOff.toLocaleString()}</td>
                    <td style={{ textAlign: 'right', padding: '10px 8px', fontWeight: 600, color: '#166534' }}>{finalVolume.toLocaleString()}</td>
                    <td style={{ textAlign: 'right', padding: '10px 8px', fontWeight: 600 }}>{overallConversionRate.toFixed(1)}%</td>
                    <td style={{ textAlign: 'right', padding: '10px 8px', fontWeight: 600, color: '#666' }}>{formatCurrency(totalCostPerClient)}</td>
                    <td style={{ textAlign: 'right', padding: '10px 8px', fontWeight: 600, color: '#166534' }}>{formatCurrency(totalStageInvestment)}</td>
                    <td style={{ textAlign: 'right', padding: '10px 8px', fontWeight: 600, color: '#DC2626' }}>{formatCurrency(totalWastedCost)}</td>
                  </tr>
                </tfoot>
              </table>
            </div>
          </div>

          {/* Insights */}
          <div style={{ marginTop: '24px', display: 'grid', gridTemplateColumns: 'repeat(auto-fit, minmax(280px, 1fr))', gap: '16px' }}>
            <div style={{ background: '#FEF2F2', border: '1px solid #FECACA', borderRadius: '12px', padding: '16px' }}>
              <div style={{ fontSize: '11px', fontFamily: "'Helvetica Neue', Arial, sans-serif", color: '#DC2626', textTransform: 'uppercase', letterSpacing: '0.5px', marginBottom: '8px' }}>âš ï¸ Biggest Drop-off</div>
              <div style={{ fontSize: '16px', fontWeight: 600, color: '#991B1B' }}>{worstStage.stageName}</div>
              <div style={{ fontSize: '12px', color: '#DC2626', fontFamily: "'Helvetica Neue', Arial, sans-serif", marginTop: '4px' }}>{worstStage.dropOff.toLocaleString()} clients lost ({(100 - worstStage.completionRate).toFixed(0)}% drop-off rate)</div>
            </div>
            <div style={{ background: '#FEF3C7', border: '1px solid #FDE68A', borderRadius: '12px', padding: '16px' }}>
              <div style={{ fontSize: '11px', fontFamily: "'Helvetica Neue', Arial, sans-serif", color: '#92400E', textTransform: 'uppercase', letterSpacing: '0.5px', marginBottom: '8px' }}>ðŸ’¸ Most Costly Drop-off</div>
              <div style={{ fontSize: '16px', fontWeight: 600, color: '#92400E' }}>{mostWasteful.stageName}</div>
              <div style={{ fontSize: '12px', color: '#B45309', fontFamily: "'Helvetica Neue', Arial, sans-serif", marginTop: '4px' }}>{formatCurrency(mostWasteful.wastedCost)} wasted on {mostWasteful.dropOff.toLocaleString()} lost clients</div>
            </div>
          </div>
        </div>
      );
    }

    // Funnel Settings Modal
    function FunnelSettingsModal({ config, onUpdate, onClose }) {
      const [localFunnel, setLocalFunnel] = useState({
        enabled: config.funnel?.enabled ?? false,
        initialVolume: config.funnel?.initialVolume ?? 1000,
        periodLabel: config.funnel?.periodLabel ?? 'per quarter'
      });
      const [localStages, setLocalStages] = useState(
        config.stages.map(s => ({ id: s.id, name: s.name, dropOffCount: s.dropOffCount || 0 }))
      );

      const handleSave = () => {
        onUpdate({
          funnel: localFunnel,
          stages: config.stages.map(stage => {
            const localStage = localStages.find(s => s.id === stage.id);
            return { ...stage, dropOffCount: localStage?.dropOffCount || 0 };
          })
        });
        onClose();
      };

      let runningVolume = localFunnel.initialVolume;
      const preview = localStages.map(stage => {
        const entry = runningVolume;
        const exit = Math.max(0, entry - stage.dropOffCount);
        runningVolume = exit;
        return { ...stage, entry, exit };
      });

      return (
        <div style={{ position: 'fixed', inset: 0, background: 'rgba(0,0,0,0.5)', display: 'flex', alignItems: 'center', justifyContent: 'center', zIndex: 1000 }} onClick={onClose}>
          <div style={{ background: '#FFF', borderRadius: '12px', padding: '32px', width: '600px', maxWidth: '95vw', maxHeight: '90vh', overflow: 'auto', boxShadow: '0 20px 60px rgba(0,0,0,0.3)' }} onClick={e => e.stopPropagation()}>
            <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: '24px' }}>
              <h3 style={{ margin: 0, fontSize: '18px', fontWeight: 600 }}>ðŸ“Š Funnel Settings</h3>
              <button onClick={onClose} style={{ background: 'none', border: 'none', fontSize: '20px', cursor: 'pointer', color: '#999' }}>Ã—</button>
            </div>

            <div style={{ marginBottom: '24px', padding: '16px', background: '#F9FAFB', borderRadius: '8px' }}>
              <label style={{ display: 'flex', alignItems: 'center', gap: '12px', cursor: 'pointer' }}>
                <input type="checkbox" checked={localFunnel.enabled} onChange={(e) => setLocalFunnel(prev => ({ ...prev, enabled: e.target.checked }))} style={{ width: '18px', height: '18px', cursor: 'pointer' }} />
                <div>
                  <div style={{ fontWeight: 500, fontSize: '14px' }}>Enable Funnel Tracking</div>
                  <div style={{ fontSize: '12px', color: '#666', fontFamily: "'Helvetica Neue', Arial, sans-serif" }}>Track volume, drop-offs, and calculate wasted costs</div>
                </div>
              </label>
            </div>

            {localFunnel.enabled && (
              <>
                <div style={{ marginBottom: '24px' }}>
                  <label style={{ display: 'block', fontSize: '12px', fontFamily: "'Helvetica Neue', Arial, sans-serif", color: '#666', marginBottom: '6px', textTransform: 'uppercase', letterSpacing: '0.5px' }}>Initial Volume (Starting Clients)</label>
                  <div style={{ display: 'flex', gap: '12px' }}>
                    <input type="number" value={localFunnel.initialVolume} onChange={(e) => setLocalFunnel(prev => ({ ...prev, initialVolume: parseInt(e.target.value) || 0 }))} style={{ flex: 1, padding: '10px 14px', border: '2px solid #E5E5E5', borderRadius: '8px', fontSize: '16px', fontFamily: "'Helvetica Neue', Arial, sans-serif" }} />
                    <input type="text" value={localFunnel.periodLabel} onChange={(e) => setLocalFunnel(prev => ({ ...prev, periodLabel: e.target.value }))} placeholder="per quarter" style={{ width: '150px', padding: '10px 14px', border: '2px solid #E5E5E5', borderRadius: '8px', fontSize: '14px', fontFamily: "'Helvetica Neue', Arial, sans-serif" }} />
                  </div>
                </div>

                <div>
                  <label style={{ display: 'block', fontSize: '12px', fontFamily: "'Helvetica Neue', Arial, sans-serif", color: '#666', marginBottom: '12px', textTransform: 'uppercase', letterSpacing: '0.5px' }}>Drop-off per Stage</label>
                  <div style={{ display: 'flex', flexDirection: 'column', gap: '8px' }}>
                    {localStages.map((stage, i) => {
                      const previewData = preview[i];
                      return (
                        <div key={stage.id} style={{ display: 'flex', alignItems: 'center', gap: '12px', padding: '12px 16px', background: '#F9FAFB', borderRadius: '8px', borderLeft: `3px solid hsl(${i * 45 + 180}, 35%, 55%)` }}>
                          <div style={{ flex: 1 }}>
                            <div style={{ fontWeight: 500, fontSize: '13px' }}>{stage.name}</div>
                            <div style={{ fontSize: '11px', color: '#666', fontFamily: "'Helvetica Neue', Arial, sans-serif", marginTop: '2px' }}>{previewData.entry.toLocaleString()} â†’ {previewData.exit.toLocaleString()}</div>
                          </div>
                          <div style={{ display: 'flex', alignItems: 'center', gap: '8px' }}>
                            <span style={{ fontSize: '12px', color: '#666', fontFamily: "'Helvetica Neue', Arial, sans-serif" }}>Drop:</span>
                            <input type="number" value={stage.dropOffCount} onChange={(e) => { const value = parseInt(e.target.value) || 0; setLocalStages(prev => prev.map(s => s.id === stage.id ? { ...s, dropOffCount: value } : s)); }} style={{ width: '80px', padding: '6px 10px', border: '2px solid #E5E5E5', borderRadius: '6px', fontSize: '14px', fontFamily: "'Helvetica Neue', Arial, sans-serif", textAlign: 'right' }} />
                          </div>
                        </div>
                      );
                    })}
                  </div>
                </div>

                <div style={{ marginTop: '24px', padding: '16px', background: '#EFF6FF', borderRadius: '8px', border: '1px solid #BFDBFE' }}>
                  <div style={{ fontSize: '12px', fontFamily: "'Helvetica Neue', Arial, sans-serif", color: '#1E40AF', fontWeight: 600, marginBottom: '8px' }}>Preview</div>
                  <div style={{ display: 'flex', gap: '24px', fontSize: '13px', fontFamily: "'Helvetica Neue', Arial, sans-serif" }}>
                    <div><span style={{ color: '#666' }}>Start: </span><span style={{ fontWeight: 600 }}>{localFunnel.initialVolume.toLocaleString()}</span></div>
                    <div><span style={{ color: '#666' }}>Complete: </span><span style={{ fontWeight: 600, color: '#166534' }}>{runningVolume.toLocaleString()}</span></div>
                    <div><span style={{ color: '#666' }}>Conversion: </span><span style={{ fontWeight: 600, color: '#7C3AED' }}>{localFunnel.initialVolume > 0 ? ((runningVolume / localFunnel.initialVolume) * 100).toFixed(1) : 0}%</span></div>
                  </div>
                </div>
              </>
            )}

            <div style={{ marginTop: '24px', display: 'flex', gap: '12px', justifyContent: 'flex-end' }}>
              <button onClick={onClose} style={{ padding: '10px 20px', background: '#F3F4F6', border: 'none', borderRadius: '8px', cursor: 'pointer', fontFamily: "'Helvetica Neue', Arial, sans-serif", fontSize: '14px', fontWeight: 500 }}>Cancel</button>
              <button onClick={handleSave} style={{ padding: '10px 20px', background: '#1A1A1A', color: '#FFF', border: 'none', borderRadius: '8px', cursor: 'pointer', fontFamily: "'Helvetica Neue', Arial, sans-serif", fontSize: '14px', fontWeight: 500 }}>Save Changes</button>
            </div>
          </div>
        </div>
      );
    }

    // Timeline Component
    function Timeline({ stages, totalTime, formatTime, personas, onClose, showCosts = true }) {
      let accumulated = 0;
      const totalCost = stages.reduce((acc, stage) => 
        acc + stage.steps.reduce((stepAcc, step) => stepAcc + calculateStepCost(step, personas), 0), 0
      );
      
      // Calculate all step metrics
      const allSteps = stages.flatMap((stage, stageIndex) => 
        stage.steps.map(step => ({ ...step, stageName: stage.name, stageIndex }))
      );
      
      const totalSteps = allSteps.length;
      const avgTimePerStep = totalSteps > 0 ? totalTime / totalSteps : 0;
      
      // Sort by different metrics
      const byTime = [...allSteps].sort((a, b) => b.timeMinutes - a.timeMinutes);
      const byFriction = [...allSteps].sort((a, b) => (b.frictionScore || 3) - (a.frictionScore || 3));
      
      // High friction steps (4 or 5)
      const highFrictionSteps = allSteps.filter(s => (s.frictionScore || 3) >= 4);
      
      // Stage metrics
      const stageMetrics = stages.map((stage, i) => {
        const stageTime = stage.steps.reduce((acc, s) => acc + s.timeMinutes, 0);
        const avgFriction = stage.steps.length > 0 
          ? stage.steps.reduce((acc, s) => acc + (s.frictionScore || 3), 0) / stage.steps.length
          : 0;
        return { 
          ...stage, 
          stageIndex: i,
          time: stageTime, 
          avgFriction,
          stepCount: stage.steps.length
        };
      }).sort((a, b) => b.time - a.time);
      
      // Role time breakdown
      const roleTime = personas.filter(p => !p.isExternal).map(persona => {
        const totalRoleMinutes = allSteps.reduce((acc, step) => {
          const involvement = step.roleInvolvement?.[persona.id];
          return acc + ((involvement?.timeMinutes || 0) * (involvement?.headcount || 1));
        }, 0);
        const stepCount = allSteps.filter(step => {
          const involvement = step.roleInvolvement?.[persona.id];
          return involvement?.timeMinutes > 0;
        }).length;
        return { ...persona, totalMinutes: totalRoleMinutes, stepCount };
      }).sort((a, b) => b.totalMinutes - a.totalMinutes);
      
      // Pain points
      const painPointSteps = allSteps.filter(s => s.painPoints && s.painPoints.length > 0);
      const totalPainPoints = painPointSteps.reduce((acc, s) => acc + s.painPoints.length, 0);
      
      return (
        <div style={{
          padding: '24px 32px'
        }}>
          <div style={{ 
            display: 'flex', 
            justifyContent: 'space-between', 
            alignItems: 'center',
            marginBottom: '20px'
          }}>
            <h3 style={{ 
              margin: 0, 
              fontSize: '18px', 
              fontWeight: 600,
              display: 'flex',
              alignItems: 'center',
              gap: '8px'
            }}>
              <span>ðŸ“…</span> Timeline Dashboard
            </h3>
            <div style={{ display: 'flex', gap: '24px', alignItems: 'center' }}>
              {showCosts && (
                <span style={{
                  fontFamily: "'Helvetica Neue', Arial, sans-serif",
                  fontSize: '13px',
                  color: '#92400E',
                  fontWeight: 600
                }}>
                  ðŸ’° {formatCurrency(totalCost)}
                </span>
              )}
              {onClose && (
                <button onClick={onClose} style={{ background: 'none', border: 'none', fontSize: '20px', cursor: 'pointer', color: '#999', padding: '0 4px' }}>Ã—</button>
              )}
            </div>
          </div>
          
          {/* Summary Cards */}
          <div style={{ display: 'grid', gridTemplateColumns: 'repeat(auto-fit, minmax(150px, 1fr))', gap: '16px', marginBottom: '24px' }}>
            <div style={{ background: '#DBEAFE', padding: '16px', borderRadius: '12px', textAlign: 'center' }}>
              <div style={{ fontSize: '24px', fontWeight: 700, color: '#1E40AF' }}>{formatTime(totalTime)}</div>
              <div style={{ fontSize: '11px', color: '#1E40AF', fontFamily: "'Helvetica Neue', Arial, sans-serif", marginTop: '4px' }}>Total Time</div>
            </div>
            <div style={{ background: '#F3E8FF', padding: '16px', borderRadius: '12px', textAlign: 'center' }}>
              <div style={{ fontSize: '24px', fontWeight: 700, color: '#6B21A8' }}>{formatTime(Math.round(avgTimePerStep))}</div>
              <div style={{ fontSize: '11px', color: '#6B21A8', fontFamily: "'Helvetica Neue', Arial, sans-serif", marginTop: '4px' }}>Avg per Step</div>
            </div>
            <div style={{ background: '#FEE2E2', padding: '16px', borderRadius: '12px', textAlign: 'center' }}>
              <div style={{ fontSize: '24px', fontWeight: 700, color: '#DC2626' }}>{highFrictionSteps.length}</div>
              <div style={{ fontSize: '11px', color: '#DC2626', fontFamily: "'Helvetica Neue', Arial, sans-serif", marginTop: '4px' }}>High Friction Steps</div>
            </div>
            <div style={{ background: '#FEF3C7', padding: '16px', borderRadius: '12px', textAlign: 'center' }}>
              <div style={{ fontSize: '24px', fontWeight: 700, color: '#92400E' }}>{totalPainPoints}</div>
              <div style={{ fontSize: '11px', color: '#92400E', fontFamily: "'Helvetica Neue', Arial, sans-serif", marginTop: '4px' }}>Pain Points</div>
            </div>
          </div>
          
          {/* Main timeline bar */}
          <div style={{
            fontSize: '11px',
            fontFamily: "'Helvetica Neue', Arial, sans-serif",
            color: '#666',
            marginBottom: '8px',
            textTransform: 'uppercase',
            letterSpacing: '0.5px'
          }}>
            Time Distribution by Stage
          </div>
          <div style={{
            display: 'flex',
            height: '48px',
            borderRadius: '8px',
            background: '#F5F5F5',
            position: 'relative'
          }}>
            {stages.map((stage, i) => {
              const stageTime = stage.steps.reduce((acc, step) => acc + step.timeMinutes, 0);
              const percentage = totalTime > 0 ? (stageTime / totalTime) * 100 : 0;
              accumulated += stageTime;
              
              return (
                <div
                  key={stage.id}
                  className="tooltip"
                  data-tooltip={`${stage.name}: ${formatTime(stageTime)} (${Math.round(percentage)}%)`}
                  style={{
                    width: `${percentage}%`,
                    background: `hsl(${i * 45 + 180}, 35%, 55%)`,
                    display: 'flex',
                    alignItems: 'center',
                    justifyContent: 'center',
                    color: '#FFF',
                    fontFamily: "'Helvetica Neue', Arial, sans-serif",
                    fontSize: '12px',
                    fontWeight: 500,
                    cursor: 'pointer',
                    transition: 'filter 0.2s',
                    borderRight: i < stages.length - 1 ? '2px solid #FFF' : 'none',
                    borderRadius: i === 0 ? '8px 0 0 8px' : i === stages.length - 1 ? '0 8px 8px 0' : '0'
                  }}
                  onMouseOver={(e) => e.currentTarget.style.filter = 'brightness(1.1)'}
                  onMouseOut={(e) => e.currentTarget.style.filter = 'brightness(1)'}
                >
                  {percentage > 8 && stage.name}
                </div>
              );
            })}
          </div>
          
          <div style={{ marginTop: '24px', display: 'grid', gridTemplateColumns: 'repeat(auto-fit, minmax(280px, 1fr))', gap: '24px' }}>
            {/* Top 5 Longest Steps */}
            <div>
              <h4 style={{ margin: '0 0 12px', fontSize: '13px', fontFamily: "'Helvetica Neue', Arial, sans-serif", textTransform: 'uppercase', letterSpacing: '0.5px', color: '#666' }}>
                â° Top 5 Longest Steps
              </h4>
              <div style={{ display: 'flex', flexDirection: 'column', gap: '6px' }}>
                {byTime.slice(0, 5).map((step, i) => (
                  <div key={step.id} style={{
                    display: 'flex',
                    alignItems: 'center',
                    gap: '10px',
                    padding: '10px',
                    background: i === 0 ? '#DBEAFE' : '#F9FAFB',
                    borderRadius: '8px',
                    border: i === 0 ? '1px solid #BFDBFE' : 'none'
                  }}>
                    <div style={{ 
                      width: '22px', 
                      height: '22px', 
                      borderRadius: '50%', 
                      background: i === 0 ? '#1E40AF' : '#E5E5E5',
                      color: i === 0 ? '#FFF' : '#666',
                      display: 'flex',
                      alignItems: 'center',
                      justifyContent: 'center',
                      fontSize: '11px',
                      fontWeight: 600,
                      flexShrink: 0
                    }}>
                      {i + 1}
                    </div>
                    <div style={{ flex: 1, minWidth: 0 }}>
                      <div style={{ fontWeight: 600, fontSize: '12px', whiteSpace: 'nowrap', overflow: 'hidden', textOverflow: 'ellipsis' }}>{step.name}</div>
                      <div style={{ fontSize: '10px', color: '#666', fontFamily: "'Helvetica Neue', Arial, sans-serif" }}>{step.stageName}</div>
                    </div>
                    <div style={{ fontWeight: 600, color: '#1E40AF', fontSize: '13px', flexShrink: 0 }}>{formatTime(step.timeMinutes)}</div>
                  </div>
                ))}
              </div>
            </div>
            
            {/* Top 5 Highest Friction Steps */}
            <div>
              <h4 style={{ margin: '0 0 12px', fontSize: '13px', fontFamily: "'Helvetica Neue', Arial, sans-serif", textTransform: 'uppercase', letterSpacing: '0.5px', color: '#666' }}>
                ðŸ˜° Highest Friction Steps
              </h4>
              <div style={{ display: 'flex', flexDirection: 'column', gap: '6px' }}>
                {byFriction.slice(0, 5).map((step, i) => {
                  const friction = step.frictionScore || 3;
                  return (
                    <div key={step.id} style={{
                      display: 'flex',
                      alignItems: 'center',
                      gap: '10px',
                      padding: '10px',
                      background: frictionConfig[friction]?.bg || '#F9FAFB',
                      borderRadius: '8px'
                    }}>
                      <div style={{ fontSize: '18px' }}>{frictionConfig[friction]?.emoji}</div>
                      <div style={{ flex: 1, minWidth: 0 }}>
                        <div style={{ fontWeight: 600, fontSize: '12px', whiteSpace: 'nowrap', overflow: 'hidden', textOverflow: 'ellipsis' }}>{step.name}</div>
                        <div style={{ fontSize: '10px', color: '#666', fontFamily: "'Helvetica Neue', Arial, sans-serif" }}>{step.stageName} Â· {formatTime(step.timeMinutes)}</div>
                      </div>
                      <div style={{ 
                        fontWeight: 600, 
                        color: frictionConfig[friction]?.color,
                        fontSize: '12px',
                        flexShrink: 0
                      }}>
                        {friction}/5
                      </div>
                    </div>
                  );
                })}
              </div>
            </div>
            
            {/* Time by Role */}
            <div>
              <h4 style={{ margin: '0 0 12px', fontSize: '13px', fontFamily: "'Helvetica Neue', Arial, sans-serif", textTransform: 'uppercase', letterSpacing: '0.5px', color: '#666' }}>
                ðŸ‘¥ Time by Role
              </h4>
              <div style={{ display: 'flex', flexDirection: 'column', gap: '6px' }}>
                {roleTime.slice(0, 5).map(role => (
                  <div key={role.id} style={{
                    display: 'flex',
                    alignItems: 'center',
                    gap: '10px',
                    padding: '10px',
                    background: '#F9FAFB',
                    borderRadius: '8px',
                    borderLeft: `3px solid ${role.color}`
                  }}>
                    <div style={{ flex: 1 }}>
                      <div style={{ fontWeight: 600, fontSize: '12px', color: role.color }}>{role.label}</div>
                      <div style={{ fontSize: '10px', color: '#666', fontFamily: "'Helvetica Neue', Arial, sans-serif" }}>
                        {role.stepCount} steps
                      </div>
                    </div>
                    <div style={{ textAlign: 'right' }}>
                      <div style={{ fontWeight: 600, color: '#1E40AF', fontSize: '13px' }}>{formatTime(role.totalMinutes)}</div>
                      <div style={{ fontSize: '10px', color: '#666', fontFamily: "'Helvetica Neue', Arial, sans-serif" }}>
                        {totalTime > 0 ? Math.round((role.totalMinutes / totalTime) * 100) : 0}%
                      </div>
                    </div>
                    <div style={{ 
                      width: '50px', 
                      height: '6px', 
                      background: '#E5E5E5', 
                      borderRadius: '3px',
                      overflow: 'hidden'
                    }}>
                      <div style={{
                        width: `${roleTime[0]?.totalMinutes > 0 ? (role.totalMinutes / roleTime[0].totalMinutes) * 100 : 0}%`,
                        height: '100%',
                        background: role.color
                      }} />
                    </div>
                  </div>
                ))}
              </div>
            </div>
            
            {/* Stage Ranking by Time */}
            <div>
              <h4 style={{ margin: '0 0 12px', fontSize: '13px', fontFamily: "'Helvetica Neue', Arial, sans-serif", textTransform: 'uppercase', letterSpacing: '0.5px', color: '#666' }}>
                ðŸ“Š Stages by Time
              </h4>
              <div style={{ display: 'flex', flexDirection: 'column', gap: '6px' }}>
                {stageMetrics.map((stage, i) => {
                  const roundedFriction = Math.round(stage.avgFriction) || 3;
                  return (
                    <div key={stage.id} style={{
                      display: 'flex',
                      alignItems: 'center',
                      gap: '10px',
                      padding: '10px',
                      background: '#F9FAFB',
                      borderRadius: '8px',
                      borderLeft: `3px solid hsl(${stage.stageIndex * 45 + 180}, 35%, 55%)`
                    }}>
                      <div style={{ flex: 1 }}>
                        <div style={{ fontWeight: 600, fontSize: '12px' }}>{stage.name}</div>
                        <div style={{ fontSize: '10px', color: '#666', fontFamily: "'Helvetica Neue', Arial, sans-serif" }}>
                          {stage.stepCount} steps
                        </div>
                      </div>
                      <div style={{ fontSize: '14px' }}>{frictionConfig[roundedFriction]?.emoji}</div>
                      <div style={{ textAlign: 'right' }}>
                        <div style={{ fontWeight: 600, color: '#1E40AF', fontSize: '13px' }}>{formatTime(stage.time)}</div>
                        <div style={{ fontSize: '10px', color: '#666', fontFamily: "'Helvetica Neue', Arial, sans-serif" }}>
                          {totalTime > 0 ? Math.round((stage.time / totalTime) * 100) : 0}%
                        </div>
                      </div>
                    </div>
                  );
                })}
              </div>
            </div>
          </div>
          
          {/* Friction distribution */}
          <div style={{ marginTop: '24px' }}>
            <div style={{
              fontSize: '11px',
              fontFamily: "'Helvetica Neue', Arial, sans-serif",
              color: '#666',
              marginBottom: '8px',
              textTransform: 'uppercase',
              letterSpacing: '0.5px'
            }}>
              Friction Overview
            </div>
            <div style={{ display: 'flex', gap: '12px', flexWrap: 'wrap' }}>
              {[1, 2, 3, 4, 5].map(level => {
                const count = allSteps.filter(s => (s.frictionScore || 3) === level).length;
                return (
                  <div key={level} style={{ 
                    display: 'flex', 
                    alignItems: 'center', 
                    gap: '8px', 
                    padding: '8px 12px', 
                    background: frictionConfig[level]?.bg || '#F5F5F5', 
                    borderRadius: '6px' 
                  }}>
                    <span style={{ fontSize: '16px' }}>{frictionConfig[level]?.emoji}</span>
                    <span style={{
                      fontFamily: "'Helvetica Neue', Arial, sans-serif",
                      fontSize: '12px',
                      fontWeight: 500
                    }}>
                      {count} steps
                    </span>
                  </div>
                );
              })}
            </div>
          </div>
        </div>
      );
    }

    // Role Management Modal
    function SalarySettingsModal({ personas, onUpdate, onClose }) {
      const [localPersonas, setLocalPersonas] = useState(JSON.parse(JSON.stringify(personas)));
      const [editingId, setEditingId] = useState(null);
      const [showAddForm, setShowAddForm] = useState(false);
      const [newRole, setNewRole] = useState({ label: '', color: '#666666', annualSalary: 0, burdenMultiplier: 1.35, workspaceHourlyCost: 6.00, isExternal: false });
      
      const colorOptions = ['#2D5A4B', '#8B4513', '#1E40AF', '#6B46C1', '#C53030', '#047857', '#B45309', '#4A5568', '#7C3AED', '#0369A1'];

      const handleUpdatePersona = (id, field, value) => {
        setLocalPersonas(prev => prev.map(p => p.id === id ? { ...p, [field]: value } : p));
      };

      const handleDeletePersona = (id) => {
        setLocalPersonas(prev => prev.filter(p => p.id !== id));
      };

      const handleAddRole = () => {
        if (!newRole.label.trim()) return;
        const id = newRole.label.toLowerCase().replace(/\s+/g, '-').replace(/[^a-z0-9-]/g, '');
        setLocalPersonas(prev => [...prev, { ...newRole, id, label: newRole.label.trim() }]);
        setNewRole({ label: '', color: '#666666', annualSalary: 0, burdenMultiplier: 1.35, workspaceHourlyCost: 6.00, isExternal: false });
        setShowAddForm(false);
      };

      return (
        <div style={{
          position: 'fixed',
          inset: 0,
          background: 'rgba(0,0,0,0.5)',
          display: 'flex',
          alignItems: 'center',
          justifyContent: 'center',
          zIndex: 1000
        }} onClick={onClose}>
          <div style={{
            background: '#FFF',
            borderRadius: '12px',
            padding: '32px',
            width: '800px',
            maxWidth: '95vw',
            maxHeight: '90vh',
            overflow: 'auto'
          }} onClick={e => e.stopPropagation()}>
            <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: '8px' }}>
              <h3 style={{ margin: 0, fontSize: '20px' }}>ðŸ‘¥ Role Management</h3>
              <button onClick={() => setShowAddForm(!showAddForm)} style={{ padding: '8px 16px', background: showAddForm ? '#F5F5F5' : '#2D5A4B', color: showAddForm ? '#666' : '#FFF', border: 'none', borderRadius: '6px', cursor: 'pointer', fontFamily: "'Helvetica Neue', Arial, sans-serif", fontSize: '13px' }}>
                {showAddForm ? 'Cancel' : '+ Add Role'}
              </button>
            </div>
            <p style={{ margin: '0 0 24px', color: '#666', fontFamily: "'Helvetica Neue', Arial, sans-serif", fontSize: '14px' }}>
              Manage roles and fully-loaded costs. Based on {WORKING_HOURS_PER_YEAR} working hours/year.
            </p>

            {/* Add New Role Form */}
            {showAddForm && (
              <div style={{ padding: '20px', background: '#F0FDF4', borderRadius: '8px', marginBottom: '20px', border: '2px solid #2D5A4B' }}>
                <div style={{ fontFamily: "'Helvetica Neue', Arial, sans-serif", fontSize: '13px', fontWeight: 600, color: '#2D5A4B', marginBottom: '16px' }}>Add New Role</div>
                <div style={{ display: 'grid', gridTemplateColumns: '1fr 1fr', gap: '16px' }}>
                  <div>
                    <label style={{ display: 'block', fontFamily: "'Helvetica Neue', Arial, sans-serif", fontSize: '11px', color: '#666', marginBottom: '6px' }}>Role Name</label>
                    <input
                      type="text"
                      value={newRole.label}
                      onChange={(e) => setNewRole(prev => ({ ...prev, label: e.target.value }))}
                      placeholder="e.g. Paraplanner"
                      style={{ width: '100%', padding: '10px 12px', border: '2px solid #E5E5E5', borderRadius: '6px', fontSize: '14px', boxSizing: 'border-box' }}
                    />
                  </div>
                  <div>
                    <label style={{ display: 'block', fontFamily: "'Helvetica Neue', Arial, sans-serif", fontSize: '11px', color: '#666', marginBottom: '6px' }}>Annual Salary (Â£)</label>
                    <input
                      type="number"
                      value={newRole.annualSalary || ''}
                      onChange={(e) => setNewRole(prev => ({ ...prev, annualSalary: parseInt(e.target.value) || 0 }))}
                      placeholder="0"
                      style={{ width: '100%', padding: '10px 12px', border: '2px solid #E5E5E5', borderRadius: '6px', fontSize: '14px', boxSizing: 'border-box' }}
                    />
                  </div>
                  <div>
                    <label style={{ display: 'block', fontFamily: "'Helvetica Neue', Arial, sans-serif", fontSize: '11px', color: '#666', marginBottom: '6px' }}>Burden Multiplier</label>
                    <input
                      type="number"
                      step="0.01"
                      value={newRole.burdenMultiplier || ''}
                      onChange={(e) => setNewRole(prev => ({ ...prev, burdenMultiplier: parseFloat(e.target.value) || 1.0 }))}
                      placeholder="1.35"
                      style={{ width: '100%', padding: '10px 12px', border: '2px solid #E5E5E5', borderRadius: '6px', fontSize: '14px', boxSizing: 'border-box' }}
                    />
                    <div style={{ fontFamily: "'Helvetica Neue', Arial, sans-serif", fontSize: '10px', color: '#999', marginTop: '4px' }}>NI, pension, benefits (typ. 1.3-1.5)</div>
                  </div>
                  <div>
                    <label style={{ display: 'block', fontFamily: "'Helvetica Neue', Arial, sans-serif", fontSize: '11px', color: '#666', marginBottom: '6px' }}>Workspace Cost (Â£/hr)</label>
                    <input
                      type="number"
                      step="0.50"
                      value={newRole.workspaceHourlyCost || ''}
                      onChange={(e) => setNewRole(prev => ({ ...prev, workspaceHourlyCost: parseFloat(e.target.value) || 0 }))}
                      placeholder="6.00"
                      style={{ width: '100%', padding: '10px 12px', border: '2px solid #E5E5E5', borderRadius: '6px', fontSize: '14px', boxSizing: 'border-box' }}
                    />
                    <div style={{ fontFamily: "'Helvetica Neue', Arial, sans-serif", fontSize: '10px', color: '#999', marginTop: '4px' }}>Desk, equipment, facilities</div>
                  </div>
                  <div>
                    <label style={{ display: 'block', fontFamily: "'Helvetica Neue', Arial, sans-serif", fontSize: '11px', color: '#666', marginBottom: '6px' }}>Colour</label>
                    <div style={{ display: 'flex', gap: '6px', flexWrap: 'wrap' }}>
                      {colorOptions.map(color => (
                        <button
                          key={color}
                          onClick={() => setNewRole(prev => ({ ...prev, color }))}
                          style={{ width: '28px', height: '28px', borderRadius: '50%', background: color, border: newRole.color === color ? '3px solid #000' : '2px solid #FFF', cursor: 'pointer', boxShadow: '0 1px 3px rgba(0,0,0,0.2)' }}
                        />
                      ))}
                    </div>
                  </div>
                  <div>
                    <label style={{ display: 'block', fontFamily: "'Helvetica Neue', Arial, sans-serif", fontSize: '11px', color: '#666', marginBottom: '6px' }}>External (no cost)?</label>
                    <button
                      onClick={() => setNewRole(prev => ({ ...prev, isExternal: !prev.isExternal }))}
                      style={{ padding: '10px 20px', background: newRole.isExternal ? '#2D5A4B' : '#F5F5F5', color: newRole.isExternal ? '#FFF' : '#666', border: 'none', borderRadius: '6px', cursor: 'pointer', fontFamily: "'Helvetica Neue', Arial, sans-serif", fontSize: '13px' }}
                    >
                      {newRole.isExternal ? 'Yes (External)' : 'No (Internal)'}
                    </button>
                  </div>
                </div>
                {/* Show fully-loaded rate preview */}
                {!newRole.isExternal && newRole.annualSalary > 0 && (
                  <div style={{ marginTop: '16px', padding: '12px', background: '#FEF3C7', borderRadius: '6px', display: 'flex', justifyContent: 'space-between', alignItems: 'center' }}>
                    <span style={{ fontFamily: "'Helvetica Neue', Arial, sans-serif", fontSize: '12px', color: '#92400E' }}>Fully-loaded hourly rate:</span>
                    <span style={{ fontFamily: "'Helvetica Neue', Arial, sans-serif", fontSize: '16px', fontWeight: 700, color: '#92400E' }}>
                      {formatCurrencyDetailed(((newRole.annualSalary / WORKING_HOURS_PER_YEAR) * (newRole.burdenMultiplier || 1)) + (newRole.workspaceHourlyCost || 0))}/hr
                    </span>
                  </div>
                )}
                <div style={{ marginTop: '16px', display: 'flex', justifyContent: 'flex-end' }}>
                  <button
                    onClick={handleAddRole}
                    disabled={!newRole.label.trim()}
                    style={{ padding: '10px 24px', background: newRole.label.trim() ? '#2D5A4B' : '#CCC', color: '#FFF', border: 'none', borderRadius: '6px', cursor: newRole.label.trim() ? 'pointer' : 'not-allowed', fontFamily: "'Helvetica Neue', Arial, sans-serif", fontSize: '13px' }}
                  >
                    Add Role
                  </button>
                </div>
              </div>
            )}
            
            {/* Role List */}
            <div style={{ display: 'flex', flexDirection: 'column', gap: '12px' }}>
              {localPersonas.map(persona => (
                <div key={persona.id} style={{
                  padding: '16px',
                  background: persona.isExternal ? '#F9FAFB' : '#FFF',
                  borderRadius: '8px',
                  borderLeft: `4px solid ${persona.color}`,
                  border: '1px solid #E5E5E5'
                }}>
                  {/* Top row: Color, Name, External toggle, Delete */}
                  <div style={{ display: 'flex', alignItems: 'center', gap: '12px', marginBottom: persona.isExternal ? 0 : '12px' }}>
                    {/* Color Picker */}
                    <div style={{ position: 'relative' }}>
                      <div 
                        style={{ width: '32px', height: '32px', borderRadius: '50%', background: persona.color, cursor: 'pointer', border: '2px solid #FFF', boxShadow: '0 1px 3px rgba(0,0,0,0.2)' }}
                        onClick={() => setEditingId(editingId === persona.id ? null : persona.id)}
                      />
                      {editingId === persona.id && (
                        <div style={{ position: 'absolute', top: '40px', left: 0, background: '#FFF', padding: '8px', borderRadius: '8px', boxShadow: '0 4px 12px rgba(0,0,0,0.15)', display: 'flex', gap: '4px', flexWrap: 'wrap', width: '140px', zIndex: 10 }}>
                          {colorOptions.map(color => (
                            <button
                              key={color}
                              onClick={() => { handleUpdatePersona(persona.id, 'color', color); setEditingId(null); }}
                              style={{ width: '24px', height: '24px', borderRadius: '50%', background: color, border: persona.color === color ? '2px solid #000' : 'none', cursor: 'pointer' }}
                            />
                          ))}
                        </div>
                      )}
                    </div>

                    {/* Name */}
                    <div style={{ flex: 1, minWidth: '120px' }}>
                      <input
                        type="text"
                        value={persona.label}
                        onChange={(e) => handleUpdatePersona(persona.id, 'label', e.target.value)}
                        style={{
                          fontFamily: "'Helvetica Neue', Arial, sans-serif",
                          fontSize: '14px',
                          fontWeight: 600,
                          color: persona.color,
                          border: 'none',
                          background: 'transparent',
                          width: '100%',
                          padding: '4px 0'
                        }}
                      />
                      {persona.isExternal && (
                        <div style={{ fontFamily: "'Helvetica Neue', Arial, sans-serif", fontSize: '11px', color: '#999' }}>External (no cost)</div>
                      )}
                    </div>

                    {/* External Toggle */}
                    <button
                      onClick={() => handleUpdatePersona(persona.id, 'isExternal', !persona.isExternal)}
                      style={{ padding: '6px 12px', background: persona.isExternal ? '#E5E5E5' : '#FFF', border: '1px solid #DDD', borderRadius: '4px', cursor: 'pointer', fontFamily: "'Helvetica Neue', Arial, sans-serif", fontSize: '11px', color: '#666' }}
                      title={persona.isExternal ? 'Mark as internal' : 'Mark as external (no cost)'}
                    >
                      {persona.isExternal ? 'External' : 'Internal'}
                    </button>

                    {/* Delete */}
                    <button
                      onClick={(e) => { e.stopPropagation(); handleDeletePersona(persona.id); }}
                      style={{ width: '32px', height: '32px', borderRadius: '50%', border: 'none', background: '#FEE2E2', color: '#B42318', cursor: 'pointer', fontSize: '16px', display: 'flex', alignItems: 'center', justifyContent: 'center' }}
                      title="Delete role"
                    >Ã—</button>
                  </div>

                  {/* Cost fields - only for internal roles */}
                  {!persona.isExternal && (
                    <div style={{ display: 'grid', gridTemplateColumns: 'repeat(4, 1fr)', gap: '12px', paddingTop: '12px', borderTop: '1px solid #F0F0F0' }}>
                      {/* Annual Salary */}
                      <div>
                        <label style={{ display: 'block', fontFamily: "'Helvetica Neue', Arial, sans-serif", fontSize: '10px', color: '#999', marginBottom: '4px' }}>Annual Salary</label>
                        <div style={{ display: 'flex', alignItems: 'center', gap: '4px' }}>
                          <span style={{ fontFamily: "'Helvetica Neue', Arial, sans-serif", fontSize: '12px', color: '#666' }}>Â£</span>
                          <input
                            type="number"
                            value={persona.annualSalary || ''}
                            onChange={(e) => handleUpdatePersona(persona.id, 'annualSalary', parseInt(e.target.value) || 0)}
                            placeholder="0"
                            style={{ width: '100%', padding: '6px 8px', border: '1px solid #E5E5E5', borderRadius: '4px', fontSize: '13px', textAlign: 'right' }}
                          />
                        </div>
                        <div style={{ fontFamily: "'Helvetica Neue', Arial, sans-serif", fontSize: '10px', color: '#999', marginTop: '2px' }}>
                          Base: {formatCurrencyDetailed(calculateHourlyRate(persona.annualSalary || 0))}/hr
                        </div>
                      </div>

                      {/* Burden Multiplier */}
                      <div>
                        <label style={{ display: 'block', fontFamily: "'Helvetica Neue', Arial, sans-serif", fontSize: '10px', color: '#999', marginBottom: '4px' }}>Burden Ã—</label>
                        <input
                          type="number"
                          step="0.01"
                          value={persona.burdenMultiplier || ''}
                          onChange={(e) => handleUpdatePersona(persona.id, 'burdenMultiplier', parseFloat(e.target.value) || 1.0)}
                          placeholder="1.35"
                          style={{ width: '100%', padding: '6px 8px', border: '1px solid #E5E5E5', borderRadius: '4px', fontSize: '13px', textAlign: 'right' }}
                        />
                        <div style={{ fontFamily: "'Helvetica Neue', Arial, sans-serif", fontSize: '10px', color: '#999', marginTop: '2px' }}>
                          NI, pension, benefits
                        </div>
                      </div>

                      {/* Workspace Cost */}
                      <div>
                        <label style={{ display: 'block', fontFamily: "'Helvetica Neue', Arial, sans-serif", fontSize: '10px', color: '#999', marginBottom: '4px' }}>Workspace Â£/hr</label>
                        <input
                          type="number"
                          step="0.50"
                          value={persona.workspaceHourlyCost || ''}
                          onChange={(e) => handleUpdatePersona(persona.id, 'workspaceHourlyCost', parseFloat(e.target.value) || 0)}
                          placeholder="6.00"
                          style={{ width: '100%', padding: '6px 8px', border: '1px solid #E5E5E5', borderRadius: '4px', fontSize: '13px', textAlign: 'right' }}
                        />
                        <div style={{ fontFamily: "'Helvetica Neue', Arial, sans-serif", fontSize: '10px', color: '#999', marginTop: '2px' }}>
                          Desk, equipment
                        </div>
                      </div>

                      {/* Fully Loaded Rate */}
                      <div style={{ background: '#FEF3C7', borderRadius: '6px', padding: '8px', display: 'flex', flexDirection: 'column', justifyContent: 'center' }}>
                        <div style={{ fontFamily: "'Helvetica Neue', Arial, sans-serif", fontSize: '10px', color: '#92400E', marginBottom: '2px' }}>Fully Loaded</div>
                        <div style={{ fontFamily: "'Helvetica Neue', Arial, sans-serif", fontSize: '16px', fontWeight: 700, color: '#92400E' }}>
                          {formatCurrencyDetailed(calculateFullyLoadedRate(persona))}/hr
                        </div>
                      </div>
                    </div>
                  )}
                </div>
              ))}
            </div>
            
            <div style={{ display: 'flex', gap: '12px', justifyContent: 'flex-end', marginTop: '24px', paddingTop: '20px', borderTop: '1px solid #E5E5E5' }}>
              <button
                onClick={onClose}
                style={{ padding: '10px 20px', background: '#F5F5F5', border: 'none', borderRadius: '6px', cursor: 'pointer', fontFamily: "'Helvetica Neue', Arial, sans-serif" }}
              >
                Cancel
              </button>
              <button
                onClick={() => onUpdate(localPersonas)}
                style={{ padding: '10px 20px', background: '#2D5A4B', color: '#FFF', border: 'none', borderRadius: '6px', cursor: 'pointer', fontFamily: "'Helvetica Neue', Arial, sans-serif" }}
              >
                Save Changes
              </button>
            </div>
          </div>
        </div>
      );
    }

    // Cost Analysis Panel
    function CostAnalysisPanel({ stages, personas, formatTime, onClose }) {
      const allSteps = stages.flatMap((stage, stageIndex) => 
        stage.steps.map(step => ({ ...step, stageName: stage.name, stageIndex }))
      );
      
      const totalCost = allSteps.reduce((acc, s) => acc + calculateStepCost(s, personas), 0);
      const totalMinutes = allSteps.reduce((acc, s) => acc + s.timeMinutes, 0);
      const avgCostPerMinute = totalMinutes > 0 ? totalCost / totalMinutes : 0;
      
      // Calculate metrics for each step
      const stepMetrics = allSteps.map(step => {
        const cost = calculateStepCost(step, personas);
        const costPerMinute = step.timeMinutes > 0 ? cost / step.timeMinutes : 0;
        const automationSavings = step.automationOpportunity === 'high' ? cost * 0.7 
          : step.automationOpportunity === 'medium' ? cost * 0.4 
          : step.automationOpportunity === 'low' ? cost * 0.1 
          : 0;
        return { ...step, cost, costPerMinute, automationSavings };
      });
      
      // Sort by different metrics
      const byCostPerMinute = [...stepMetrics].sort((a, b) => b.costPerMinute - a.costPerMinute);
      const byTotalCost = [...stepMetrics].sort((a, b) => b.cost - a.cost);
      const byAutomationSavings = [...stepMetrics].sort((a, b) => b.automationSavings - a.automationSavings);
      
      // Stage comparison
      const stageMetrics = stages.map((stage, i) => {
        const stageCost = stage.steps.reduce((acc, s) => acc + calculateStepCost(s, personas), 0);
        const stageMinutes = stage.steps.reduce((acc, s) => acc + s.timeMinutes, 0);
        const stageCostPerMinute = stageMinutes > 0 ? stageCost / stageMinutes : 0;
        const stageAutomationSavings = stage.steps.reduce((acc, s) => {
          const cost = calculateStepCost(s, personas);
          return acc + (s.automationOpportunity === 'high' ? cost * 0.7 
            : s.automationOpportunity === 'medium' ? cost * 0.4 
            : s.automationOpportunity === 'low' ? cost * 0.1 : 0);
        }, 0);
        return { 
          ...stage, 
          stageIndex: i,
          cost: stageCost, 
          minutes: stageMinutes, 
          costPerMinute: stageCostPerMinute,
          automationSavings: stageAutomationSavings,
          stepCount: stage.steps.length
        };
      });
      
      const totalAutomationSavings = stepMetrics.reduce((acc, s) => acc + s.automationSavings, 0);
      
      // Role cost breakdown
      const roleCosts = personas.filter(p => !p.isExternal).map(persona => {
        const totalRoleCost = allSteps.reduce((acc, step) => {
          const involvement = step.roleInvolvement?.[persona.id];
          if (!involvement) return acc;
          const hourlyRate = calculateHourlyRate(persona.annualSalary || 0);
          return acc + (involvement.timeMinutes / 60) * hourlyRate * (involvement.headcount || 1);
        }, 0);
        const totalRoleMinutes = allSteps.reduce((acc, step) => {
          const involvement = step.roleInvolvement?.[persona.id];
          return acc + (involvement?.timeMinutes || 0) * (involvement?.headcount || 1);
        }, 0);
        return { ...persona, totalCost: totalRoleCost, totalMinutes: totalRoleMinutes };
      }).sort((a, b) => b.totalCost - a.totalCost);

      return (
        <div className="cost-analysis-panel" style={{
          padding: '24px 32px'
        }}>
          <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: '24px' }}>
            <h3 style={{ 
              margin: 0, 
              fontSize: '18px', 
              fontWeight: 600,
              display: 'flex',
              alignItems: 'center',
              gap: '8px'
            }}>
              <span>ðŸ’°</span> Cost Analysis Dashboard
            </h3>
            <button onClick={onClose} style={{ background: 'none', border: 'none', fontSize: '20px', cursor: 'pointer', color: '#999' }}>Ã—</button>
          </div>
          
          {/* Summary Cards */}
          <div className="cost-summary-cards" style={{ display: 'grid', gridTemplateColumns: 'repeat(auto-fit, minmax(180px, 1fr))', gap: '16px', marginBottom: '32px' }}>
            <div style={{ background: '#FEF3C7', padding: '20px', borderRadius: '12px', textAlign: 'center' }}>
              <div style={{ fontSize: '28px', fontWeight: 700, color: '#92400E' }}>{formatCurrency(totalCost)}</div>
              <div style={{ fontSize: '12px', color: '#92400E', fontFamily: "'Helvetica Neue', Arial, sans-serif", marginTop: '4px' }}>Total Journey Cost</div>
            </div>
            <div style={{ background: '#DBEAFE', padding: '20px', borderRadius: '12px', textAlign: 'center' }}>
              <div style={{ fontSize: '28px', fontWeight: 700, color: '#1E40AF' }}>{formatCurrencyDetailed(avgCostPerMinute)}</div>
              <div style={{ fontSize: '12px', color: '#1E40AF', fontFamily: "'Helvetica Neue', Arial, sans-serif", marginTop: '4px' }}>Avg Cost/Minute</div>
            </div>
            <div style={{ background: '#D1FAE5', padding: '20px', borderRadius: '12px', textAlign: 'center' }}>
              <div style={{ fontSize: '28px', fontWeight: 700, color: '#065F46' }}>{formatCurrency(totalAutomationSavings)} <span style={{ fontSize: '16px', opacity: 0.8 }}>({totalCost > 0 ? Math.round((totalAutomationSavings / totalCost) * 100) : 0}%)</span></div>
              <div style={{ fontSize: '12px', color: '#065F46', fontFamily: "'Helvetica Neue', Arial, sans-serif", marginTop: '4px' }}>Potential Savings</div>
            </div>
            <div style={{ background: '#F3E8FF', padding: '20px', borderRadius: '12px', textAlign: 'center' }}>
              <div style={{ fontSize: '28px', fontWeight: 700, color: '#6B21A8' }}>{formatTime(totalMinutes)}</div>
              <div style={{ fontSize: '12px', color: '#6B21A8', fontFamily: "'Helvetica Neue', Arial, sans-serif", marginTop: '4px' }}>Total Time</div>
            </div>
          </div>
          
          <div className="cost-analysis-grid" style={{ display: 'grid', gridTemplateColumns: 'repeat(auto-fit, minmax(300px, 1fr))', gap: '24px' }}>
            {/* Stage Comparison */}
            <div>
              <h4 style={{ margin: '0 0 16px', fontSize: '14px', fontFamily: "'Helvetica Neue', Arial, sans-serif", textTransform: 'uppercase', letterSpacing: '0.5px', color: '#666' }}>
                Stage Comparison
              </h4>
              <div style={{ display: 'flex', flexDirection: 'column', gap: '8px' }}>
                {stageMetrics.map((stage, i) => (
                  <div key={stage.id} style={{
                    display: 'flex',
                    alignItems: 'center',
                    gap: '12px',
                    padding: '12px',
                    background: '#F9FAFB',
                    borderRadius: '8px',
                    borderLeft: `4px solid hsl(${stage.stageIndex * 45 + 180}, 35%, 55%)`
                  }}>
                    <div style={{ flex: 1 }}>
                      <div style={{ fontWeight: 600, fontSize: '14px' }}>{stage.name}</div>
                      <div style={{ fontSize: '11px', color: '#666', fontFamily: "'Helvetica Neue', Arial, sans-serif" }}>
                        {stage.stepCount} steps Â· {formatTime(stage.minutes)}
                      </div>
                    </div>
                    <div style={{ textAlign: 'right' }}>
                      <div style={{ fontWeight: 600, color: '#92400E' }}>{formatCurrency(stage.cost)}</div>
                      <div style={{ fontSize: '11px', color: '#666', fontFamily: "'Helvetica Neue', Arial, sans-serif" }}>
                        {formatCurrencyDetailed(stage.costPerMinute)}/min
                      </div>
                    </div>
                    <div style={{ 
                      width: '60px', 
                      height: '8px', 
                      background: '#E5E5E5', 
                      borderRadius: '4px',
                      overflow: 'hidden'
                    }}>
                      <div style={{
                        width: `${(stage.cost / Math.max(...stageMetrics.map(s => s.cost))) * 100}%`,
                        height: '100%',
                        background: `hsl(${stage.stageIndex * 45 + 180}, 35%, 55%)`
                      }} />
                    </div>
                  </div>
                ))}
              </div>
            </div>
            
            {/* Cost by Role */}
            <div>
              <h4 style={{ margin: '0 0 16px', fontSize: '14px', fontFamily: "'Helvetica Neue', Arial, sans-serif", textTransform: 'uppercase', letterSpacing: '0.5px', color: '#666' }}>
                Cost by Role
              </h4>
              <div style={{ display: 'flex', flexDirection: 'column', gap: '8px' }}>
                {roleCosts.map(role => (
                  <div key={role.id} style={{
                    display: 'flex',
                    alignItems: 'center',
                    gap: '12px',
                    padding: '12px',
                    background: '#F9FAFB',
                    borderRadius: '8px',
                    borderLeft: `4px solid ${role.color}`
                  }}>
                    <div style={{ flex: 1 }}>
                      <div style={{ fontWeight: 600, fontSize: '14px', color: role.color }}>{role.label}</div>
                      <div style={{ fontSize: '11px', color: '#666', fontFamily: "'Helvetica Neue', Arial, sans-serif" }}>
                        {formatTime(role.totalMinutes)} total time
                      </div>
                    </div>
                    <div style={{ textAlign: 'right' }}>
                      <div style={{ fontWeight: 600, color: '#92400E' }}>{formatCurrency(role.totalCost)}</div>
                      <div style={{ fontSize: '11px', color: '#666', fontFamily: "'Helvetica Neue', Arial, sans-serif" }}>
                        {totalCost > 0 ? Math.round((role.totalCost / totalCost) * 100) : 0}% of total
                      </div>
                    </div>
                    <div style={{ 
                      width: '60px', 
                      height: '8px', 
                      background: '#E5E5E5', 
                      borderRadius: '4px',
                      overflow: 'hidden'
                    }}>
                      <div style={{
                        width: `${roleCosts[0]?.totalCost > 0 ? (role.totalCost / roleCosts[0].totalCost) * 100 : 0}%`,
                        height: '100%',
                        background: role.color
                      }} />
                    </div>
                  </div>
                ))}
              </div>
            </div>
            
            {/* Most Expensive Steps */}
            <div>
              <h4 style={{ margin: '0 0 16px', fontSize: '14px', fontFamily: "'Helvetica Neue', Arial, sans-serif", textTransform: 'uppercase', letterSpacing: '0.5px', color: '#666' }}>
                ðŸ’° Top 5 Most Expensive Steps
              </h4>
              <div style={{ display: 'flex', flexDirection: 'column', gap: '8px' }}>
                {byTotalCost.slice(0, 5).map((step, i) => (
                  <div key={step.id} style={{
                    display: 'flex',
                    alignItems: 'center',
                    gap: '12px',
                    padding: '12px',
                    background: i === 0 ? '#FEF3F2' : '#F9FAFB',
                    borderRadius: '8px',
                    border: i === 0 ? '1px solid #FEE4E2' : 'none'
                  }}>
                    <div style={{ 
                      width: '24px', 
                      height: '24px', 
                      borderRadius: '50%', 
                      background: i === 0 ? '#DC2626' : '#E5E5E5',
                      color: i === 0 ? '#FFF' : '#666',
                      display: 'flex',
                      alignItems: 'center',
                      justifyContent: 'center',
                      fontSize: '12px',
                      fontWeight: 600
                    }}>
                      {i + 1}
                    </div>
                    <div style={{ flex: 1 }}>
                      <div style={{ fontWeight: 600, fontSize: '13px' }}>{step.name}</div>
                      <div style={{ fontSize: '11px', color: '#666', fontFamily: "'Helvetica Neue', Arial, sans-serif" }}>{step.stageName}</div>
                    </div>
                    <div style={{ fontWeight: 600, color: '#92400E' }}>{formatCurrency(step.cost)}</div>
                  </div>
                ))}
              </div>
            </div>
            
            {/* Highest Cost per Minute */}
            <div>
              <h4 style={{ margin: '0 0 16px', fontSize: '14px', fontFamily: "'Helvetica Neue', Arial, sans-serif", textTransform: 'uppercase', letterSpacing: '0.5px', color: '#666' }}>
                âš¡ Highest Cost/Minute Steps
              </h4>
              <div style={{ display: 'flex', flexDirection: 'column', gap: '8px' }}>
                {byCostPerMinute.slice(0, 5).map((step, i) => (
                  <div key={step.id} style={{
                    display: 'flex',
                    alignItems: 'center',
                    gap: '12px',
                    padding: '12px',
                    background: i === 0 ? '#DBEAFE' : '#F9FAFB',
                    borderRadius: '8px',
                    border: i === 0 ? '1px solid #BFDBFE' : 'none'
                  }}>
                    <div style={{ 
                      width: '24px', 
                      height: '24px', 
                      borderRadius: '50%', 
                      background: i === 0 ? '#1E40AF' : '#E5E5E5',
                      color: i === 0 ? '#FFF' : '#666',
                      display: 'flex',
                      alignItems: 'center',
                      justifyContent: 'center',
                      fontSize: '12px',
                      fontWeight: 600
                    }}>
                      {i + 1}
                    </div>
                    <div style={{ flex: 1 }}>
                      <div style={{ fontWeight: 600, fontSize: '13px' }}>{step.name}</div>
                      <div style={{ fontSize: '11px', color: '#666', fontFamily: "'Helvetica Neue', Arial, sans-serif" }}>{step.stageName} Â· {formatTime(step.timeMinutes)}</div>
                    </div>
                    <div style={{ textAlign: 'right' }}>
                      <div style={{ fontWeight: 600, color: '#1E40AF' }}>{formatCurrencyDetailed(step.costPerMinute)}/min</div>
                    </div>
                  </div>
                ))}
              </div>
            </div>
            
            {/* Best Improvement Opportunities */}
            <div className="cost-automation-section" style={{ gridColumn: '1 / -1' }}>
              <h4 style={{ margin: '0 0 16px', fontSize: '14px', fontFamily: "'Helvetica Neue', Arial, sans-serif", textTransform: 'uppercase', letterSpacing: '0.5px', color: '#065F46' }}>
                ðŸ’¡ Top Improvement Opportunities (by potential savings)
              </h4>
              <div className="cost-automation-grid" style={{ display: 'grid', gridTemplateColumns: 'repeat(auto-fit, minmax(280px, 1fr))', gap: '12px' }}>
                {byAutomationSavings.filter(s => s.automationSavings > 0).slice(0, 8).map((step, i) => (
                  <div key={step.id} style={{
                    display: 'flex',
                    alignItems: 'center',
                    gap: '10px',
                    padding: '12px',
                    background: 'linear-gradient(135deg, #D1FAE5 0%, #A7F3D0 100%)',
                    borderRadius: '8px',
                    border: '1px solid #6EE7B7',
                    minWidth: 0
                  }}>
                    <div style={{
                      width: '36px',
                      height: '36px',
                      borderRadius: '50%',
                      background: '#065F46',
                      color: '#FFF',
                      display: 'flex',
                      alignItems: 'center',
                      justifyContent: 'center',
                      fontSize: '16px',
                      flexShrink: 0
                    }}>
                      ðŸ’¡
                    </div>
                    <div style={{ flex: 1, minWidth: 0, overflow: 'hidden' }}>
                      <div style={{ fontWeight: 600, fontSize: '13px', color: '#065F46', whiteSpace: 'nowrap', overflow: 'hidden', textOverflow: 'ellipsis' }}>{step.name}</div>
                      <div style={{ fontSize: '10px', color: '#047857', fontFamily: "'Helvetica Neue', Arial, sans-serif", whiteSpace: 'nowrap', overflow: 'hidden', textOverflow: 'ellipsis' }}>
                        {step.stageName} Â· {step.automationOpportunity}
                      </div>
                    </div>
                    <div style={{ textAlign: 'right', flexShrink: 0 }}>
                      <div style={{ fontWeight: 700, fontSize: '14px', color: '#065F46' }}>
                        {formatCurrency(step.automationSavings)} <span style={{ fontSize: '11px', opacity: 0.8 }}>({step.automationOpportunity === 'high' ? '70' : step.automationOpportunity === 'medium' ? '40' : '10'}%)</span>
                      </div>
                      <div style={{ fontSize: '9px', color: '#047857', fontFamily: "'Helvetica Neue', Arial, sans-serif" }}>
                        potential savings
                      </div>
                    </div>
                  </div>
                ))}
              </div>
            </div>
          </div>
        </div>
      );
    }

    // Add Stage Modal
    function AddStageModal({ onAdd, onClose }) {
      const [name, setName] = useState('');
      
      return (
        <div style={{
          position: 'fixed',
          inset: 0,
          background: 'rgba(0,0,0,0.5)',
          display: 'flex',
          alignItems: 'center',
          justifyContent: 'center',
          zIndex: 1000
        }} onClick={onClose}>
          <div style={{
            background: '#FFF',
            borderRadius: '12px',
            padding: '32px',
            width: '400px',
            maxWidth: '90vw'
          }} onClick={e => e.stopPropagation()}>
            <h3 style={{ margin: '0 0 24px', fontSize: '20px' }}>Add New Stage</h3>
            <input
              type="text"
              value={name}
              onChange={(e) => setName(e.target.value)}
              placeholder="Stage name..."
              autoFocus
              style={{
                width: '100%',
                padding: '12px 16px',
                border: '2px solid #E5E5E5',
                borderRadius: '8px',
                fontSize: '16px',
                marginBottom: '24px'
              }}
              onKeyDown={(e) => {
                if (e.key === 'Enter' && name.trim()) {
                  onAdd(name.trim());
                }
              }}
            />
            <div style={{ display: 'flex', gap: '12px', justifyContent: 'flex-end' }}>
              <button
                onClick={onClose}
                style={{
                  padding: '10px 20px',
                  background: '#F5F5F5',
                  border: 'none',
                  borderRadius: '6px',
                  cursor: 'pointer',
                  fontFamily: "'Helvetica Neue', Arial, sans-serif"
                }}
              >
                Cancel
              </button>
              <button
                onClick={() => name.trim() && onAdd(name.trim())}
                disabled={!name.trim()}
                style={{
                  padding: '10px 20px',
                  background: name.trim() ? '#2D5A4B' : '#CCC',
                  color: '#FFF',
                  border: 'none',
                  borderRadius: '6px',
                  cursor: name.trim() ? 'pointer' : 'not-allowed',
                  fontFamily: "'Helvetica Neue', Arial, sans-serif"
                }}
              >
                Add Stage
              </button>
            </div>
          </div>
        </div>
      );
    }

    // Add Step Modal
    function AddStepModal({ stageId, stageName, personas, onAdd, onClose }) {
      const [step, setStep] = useState({
        name: '',
        description: '',
        timeMinutes: 30,
        owner: personas[0]?.id || 'client',
        frictionScore: 3,
        automationOpportunity: 'medium'
      });
      
      return (
        <div style={{
          position: 'fixed',
          inset: 0,
          background: 'rgba(0,0,0,0.5)',
          display: 'flex',
          alignItems: 'center',
          justifyContent: 'center',
          zIndex: 1000
        }} onClick={onClose}>
          <div style={{
            background: '#FFF',
            borderRadius: '12px',
            padding: '32px',
            width: '500px',
            maxWidth: '90vw',
            maxHeight: '90vh',
            overflow: 'auto'
          }} onClick={e => e.stopPropagation()}>
            <h3 style={{ margin: '0 0 8px', fontSize: '20px' }}>Add New Step</h3>
            <p style={{ 
              margin: '0 0 24px', 
              color: '#666',
              fontFamily: "'Helvetica Neue', Arial, sans-serif",
              fontSize: '14px'
            }}>
              Adding to: {stageName}
            </p>
            
            <div style={{ display: 'flex', flexDirection: 'column', gap: '16px' }}>
              <div>
                <label style={{
                  display: 'block',
                  fontFamily: "'Helvetica Neue', Arial, sans-serif",
                  fontSize: '12px',
                  color: '#666',
                  marginBottom: '6px',
                  textTransform: 'uppercase',
                  letterSpacing: '0.5px'
                }}>
                  Step Name *
                </label>
                <input
                  type="text"
                  value={step.name}
                  onChange={(e) => setStep({ ...step, name: e.target.value })}
                  placeholder="e.g., Initial Assessment"
                  autoFocus
                  style={{
                    width: '100%',
                    padding: '10px 14px',
                    border: '2px solid #E5E5E5',
                    borderRadius: '6px',
                    fontSize: '14px'
                  }}
                />
              </div>
              
              <div>
                <label style={{
                  display: 'block',
                  fontFamily: "'Helvetica Neue', Arial, sans-serif",
                  fontSize: '12px',
                  color: '#666',
                  marginBottom: '6px',
                  textTransform: 'uppercase',
                  letterSpacing: '0.5px'
                }}>
                  Description
                </label>
                <textarea
                  value={step.description}
                  onChange={(e) => setStep({ ...step, description: e.target.value })}
                  placeholder="Brief description of this step..."
                  rows={2}
                  style={{
                    width: '100%',
                    padding: '10px 14px',
                    border: '2px solid #E5E5E5',
                    borderRadius: '6px',
                    fontSize: '14px',
                    resize: 'vertical'
                  }}
                />
              </div>
              
              <div style={{ display: 'grid', gridTemplateColumns: '1fr 1fr', gap: '16px' }}>
                <div>
                  <label style={{
                    display: 'block',
                    fontFamily: "'Helvetica Neue', Arial, sans-serif",
                    fontSize: '12px',
                    color: '#666',
                    marginBottom: '6px',
                    textTransform: 'uppercase',
                    letterSpacing: '0.5px'
                  }}>
                    Time (minutes)
                  </label>
                  <input
                    type="number"
                    value={step.timeMinutes}
                    onChange={(e) => setStep({ ...step, timeMinutes: parseInt(e.target.value) || 0 })}
                    min="1"
                    style={{
                      width: '100%',
                      padding: '10px 14px',
                      border: '2px solid #E5E5E5',
                      borderRadius: '6px',
                      fontSize: '14px'
                    }}
                  />
                </div>
                
                <div>
                  <label style={{
                    display: 'block',
                    fontFamily: "'Helvetica Neue', Arial, sans-serif",
                    fontSize: '12px',
                    color: '#666',
                    marginBottom: '6px',
                    textTransform: 'uppercase',
                    letterSpacing: '0.5px'
                  }}>
                    Owner
                  </label>
                  <select
                    value={step.owner}
                    onChange={(e) => setStep({ ...step, owner: e.target.value })}
                    style={{
                      width: '100%',
                      padding: '10px 14px',
                      border: '2px solid #E5E5E5',
                      borderRadius: '6px',
                      fontSize: '14px',
                      background: '#FFF'
                    }}
                  >
                    {personas.map(p => (
                      <option key={p.id} value={p.id}>{p.label}</option>
                    ))}
                  </select>
                </div>
              </div>
              
              <div style={{ display: 'grid', gridTemplateColumns: '1fr 1fr', gap: '16px' }}>
                <div>
                  <label style={{
                    display: 'block',
                    fontFamily: "'Helvetica Neue', Arial, sans-serif",
                    fontSize: '12px',
                    color: '#666',
                    marginBottom: '6px',
                    textTransform: 'uppercase',
                    letterSpacing: '0.5px'
                  }}>
                    Friction {step.frictionScore && <span style={{ marginLeft: '8px' }}>{frictionConfig[step.frictionScore]?.emoji} {frictionConfig[step.frictionScore]?.label}</span>}
                  </label>
                  <div style={{ display: 'flex', gap: '8px' }}>
                    {[1,2,3,4,5].map(n => (
                      <button
                        key={n}
                        type="button"
                        onClick={() => setStep({ ...step, frictionScore: n })}
                        style={{
                          width: '36px',
                          height: '36px',
                          border: '2px solid',
                          borderColor: step.frictionScore >= n ? frictionConfig[step.frictionScore]?.color : '#E5E5E5',
                          borderRadius: '6px',
                          background: step.frictionScore >= n ? frictionConfig[step.frictionScore]?.color : '#FFF',
                          color: step.frictionScore >= n ? '#FFF' : '#333',
                          cursor: 'pointer',
                          fontWeight: 600,
                          transition: 'all 0.15s'
                        }}
                      >
                        {n}
                      </button>
                    ))}
                  </div>
                </div>
                
                <div>
                  <label style={{
                    display: 'block',
                    fontFamily: "'Helvetica Neue', Arial, sans-serif",
                    fontSize: '12px',
                    color: '#666',
                    marginBottom: '6px',
                    textTransform: 'uppercase',
                    letterSpacing: '0.5px'
                  }}>
                    Improvement Potential
                  </label>
                  <select
                    value={step.automationOpportunity}
                    onChange={(e) => setStep({ ...step, automationOpportunity: e.target.value })}
                    style={{
                      width: '100%',
                      padding: '10px 14px',
                      border: '2px solid #E5E5E5',
                      borderRadius: '6px',
                      fontSize: '14px',
                      background: '#FFF'
                    }}
                  >
                    <option value="high">High</option>
                    <option value="medium">Medium</option>
                    <option value="low">Low</option>
                    <option value="none">None</option>
                  </select>
                </div>
              </div>
            </div>
            
            <div style={{ display: 'flex', gap: '12px', justifyContent: 'flex-end', marginTop: '24px' }}>
              <button
                onClick={onClose}
                style={{
                  padding: '10px 20px',
                  background: '#F5F5F5',
                  border: 'none',
                  borderRadius: '6px',
                  cursor: 'pointer',
                  fontFamily: "'Helvetica Neue', Arial, sans-serif"
                }}
              >
                Cancel
              </button>
              <button
                onClick={() => step.name.trim() && onAdd(stageId, step)}
                disabled={!step.name.trim()}
                style={{
                  padding: '10px 20px',
                  background: step.name.trim() ? '#2D5A4B' : '#CCC',
                  color: '#FFF',
                  border: 'none',
                  borderRadius: '6px',
                  cursor: step.name.trim() ? 'pointer' : 'not-allowed',
                  fontFamily: "'Helvetica Neue', Arial, sans-serif"
                }}
              >
                Add Step
              </button>
            </div>
          </div>
        </div>
      );
    }

    // GitHub Settings Modal
    function GitHubSettingsModal({ config, onUpdate, onClose, onSave, onLoad, status }) {
      const [localConfig, setLocalConfig] = useState(config);
      const [showToken, setShowToken] = useState(false);

      return (
        <div style={{
          position: 'fixed',
          inset: 0,
          background: 'rgba(0,0,0,0.5)',
          display: 'flex',
          alignItems: 'center',
          justifyContent: 'center',
          zIndex: 1000
        }} onClick={onClose}>
          <div style={{
            background: '#FFF',
            borderRadius: '12px',
            width: '500px',
            maxWidth: '95vw',
            maxHeight: '90vh',
            overflow: 'auto'
          }} onClick={e => e.stopPropagation()}>
            {/* Header */}
            <div style={{ padding: '24px 32px', borderBottom: '1px solid #E5E5E5', display: 'flex', justifyContent: 'space-between', alignItems: 'center' }}>
              <div style={{ display: 'flex', alignItems: 'center', gap: '12px' }}>
                <span style={{ fontSize: '24px' }}>ðŸ™</span>
                <div>
                  <h3 style={{ margin: 0, fontSize: '20px', fontWeight: 600 }}>GitHub Settings</h3>
                  <p style={{ margin: '4px 0 0', fontSize: '13px', color: '#666' }}>Connect to save & load your journey map</p>
                </div>
              </div>
              <button onClick={onClose} style={{ background: 'none', border: 'none', fontSize: '24px', cursor: 'pointer', color: '#999' }}>Ã—</button>
            </div>

            {/* Content */}
            <div style={{ padding: '24px 32px' }}>
              <div style={{ marginBottom: '20px' }}>
                <label style={{ display: 'block', fontSize: '13px', fontWeight: 500, marginBottom: '6px', color: '#333' }}>Repository Owner</label>
                <input
                  type="text"
                  value={localConfig.owner}
                  onChange={(e) => setLocalConfig({ ...localConfig, owner: e.target.value })}
                  placeholder="e.g., steveyoung74"
                  style={{ width: '100%', padding: '10px 12px', border: '1px solid #DDD', borderRadius: '6px', fontSize: '14px' }}
                />
              </div>

              <div style={{ marginBottom: '20px' }}>
                <label style={{ display: 'block', fontSize: '13px', fontWeight: 500, marginBottom: '6px', color: '#333' }}>Repository Name</label>
                <input
                  type="text"
                  value={localConfig.repo}
                  onChange={(e) => setLocalConfig({ ...localConfig, repo: e.target.value })}
                  placeholder="e.g., journeymaps"
                  style={{ width: '100%', padding: '10px 12px', border: '1px solid #DDD', borderRadius: '6px', fontSize: '14px' }}
                />
              </div>

              <div style={{ marginBottom: '20px' }}>
                <label style={{ display: 'block', fontSize: '13px', fontWeight: 500, marginBottom: '6px', color: '#333' }}>File Path</label>
                <input
                  type="text"
                  value={localConfig.path}
                  onChange={(e) => setLocalConfig({ ...localConfig, path: e.target.value })}
                  placeholder="e.g., onboarding/journey-map.json"
                  style={{ width: '100%', padding: '10px 12px', border: '1px solid #DDD', borderRadius: '6px', fontSize: '14px' }}
                />
              </div>

              <div style={{ marginBottom: '20px' }}>
                <label style={{ display: 'block', fontSize: '13px', fontWeight: 500, marginBottom: '6px', color: '#333' }}>Branch</label>
                <input
                  type="text"
                  value={localConfig.branch}
                  onChange={(e) => setLocalConfig({ ...localConfig, branch: e.target.value })}
                  placeholder="e.g., main"
                  style={{ width: '100%', padding: '10px 12px', border: '1px solid #DDD', borderRadius: '6px', fontSize: '14px' }}
                />
              </div>

              <div style={{ marginBottom: '24px' }}>
                <label style={{ display: 'block', fontSize: '13px', fontWeight: 500, marginBottom: '6px', color: '#333' }}>
                  Personal Access Token
                  <a href="https://github.com/settings/tokens/new?scopes=repo&description=Journey%20Map" target="_blank" rel="noopener noreferrer" style={{ marginLeft: '8px', fontSize: '12px', color: '#2563EB' }}>Generate token â†’</a>
                </label>
                <div style={{ position: 'relative' }}>
                  <input
                    type={showToken ? 'text' : 'password'}
                    value={localConfig.token}
                    onChange={(e) => setLocalConfig({ ...localConfig, token: e.target.value })}
                    placeholder="ghp_xxxxxxxxxxxx"
                    style={{ width: '100%', padding: '10px 12px', paddingRight: '80px', border: '1px solid #DDD', borderRadius: '6px', fontSize: '14px', fontFamily: 'monospace' }}
                  />
                  <button
                    onClick={() => setShowToken(!showToken)}
                    style={{ position: 'absolute', right: '8px', top: '50%', transform: 'translateY(-50%)', background: '#F5F5F5', border: 'none', borderRadius: '4px', padding: '4px 8px', fontSize: '12px', cursor: 'pointer' }}
                  >
                    {showToken ? 'Hide' : 'Show'}
                  </button>
                </div>
                <p style={{ margin: '8px 0 0', fontSize: '12px', color: '#666' }}>
                  ðŸ”’ Stored locally in your browser only. Never sent anywhere except GitHub.
                </p>
              </div>

              {/* Status message */}
              {status.message && (
                <div style={{ 
                  padding: '12px 16px', 
                  background: status.error ? '#FEF2F2' : status.loading ? '#F0F9FF' : '#F0FDF4', 
                  borderRadius: '8px', 
                  marginBottom: '20px',
                  color: status.error ? '#B91C1C' : status.loading ? '#1D4ED8' : '#166534',
                  fontSize: '14px',
                  display: 'flex',
                  alignItems: 'center',
                  gap: '8px'
                }}>
                  {status.loading && <span style={{ animation: 'spin 1s linear infinite' }}>â³</span>}
                  {status.message}
                </div>
              )}

              {/* Action Buttons */}
              <div style={{ display: 'flex', gap: '12px' }}>
                <button
                  onClick={() => { onUpdate(localConfig); onLoad(); }}
                  disabled={!localConfig.token || status.loading}
                  style={{ 
                    flex: 1, 
                    padding: '12px', 
                    background: localConfig.token && !status.loading ? '#2563EB' : '#E5E5E5', 
                    color: localConfig.token && !status.loading ? '#FFF' : '#999', 
                    border: 'none', 
                    borderRadius: '8px', 
                    cursor: localConfig.token && !status.loading ? 'pointer' : 'not-allowed',
                    fontSize: '14px',
                    fontWeight: 500,
                    display: 'flex',
                    alignItems: 'center',
                    justifyContent: 'center',
                    gap: '8px'
                  }}
                >
                  <span>ðŸ“¥</span> Load from GitHub
                </button>
                <button
                  onClick={() => { onUpdate(localConfig); onSave(); }}
                  disabled={!localConfig.token || status.loading}
                  style={{ 
                    flex: 1, 
                    padding: '12px', 
                    background: localConfig.token && !status.loading ? '#22C55E' : '#E5E5E5', 
                    color: localConfig.token && !status.loading ? '#FFF' : '#999', 
                    border: 'none', 
                    borderRadius: '8px', 
                    cursor: localConfig.token && !status.loading ? 'pointer' : 'not-allowed',
                    fontSize: '14px',
                    fontWeight: 500,
                    display: 'flex',
                    alignItems: 'center',
                    justifyContent: 'center',
                    gap: '8px'
                  }}
                >
                  <span>ðŸ“¤</span> Save to GitHub
                </button>
              </div>
            </div>

            {/* Footer */}
            <div style={{ padding: '16px 32px', borderTop: '1px solid #E5E5E5', display: 'flex', justifyContent: 'space-between', alignItems: 'center' }}>
              <button
                onClick={() => { setLocalConfig({ ...localConfig, token: '' }); onUpdate({ ...localConfig, token: '' }); }}
                style={{ padding: '8px 16px', background: '#FEF2F2', color: '#B91C1C', border: 'none', borderRadius: '6px', cursor: 'pointer', fontSize: '13px' }}
              >
                Clear Token
              </button>
              <button
                onClick={() => { onUpdate(localConfig); onClose(); }}
                style={{ padding: '10px 24px', background: '#1A1A1A', color: '#FFF', border: 'none', borderRadius: '6px', cursor: 'pointer', fontWeight: 500 }}
              >
                Done
              </button>
            </div>
          </div>
        </div>
      );
    }

    // Structure Configuration Panel
    function StructurePanel({ config, onMoveStage, onMoveStep, onInsertStage, onInsertStep, onRemoveStage, onRemoveStep, onClose }) {
      const [addingStageAfter, setAddingStageAfter] = useState(null); // index or -1 for start
      const [addingStepIn, setAddingStepIn] = useState(null); // { stageId, afterIndex }
      const [newStageName, setNewStageName] = useState('');
      const [newStepName, setNewStepName] = useState('');
      const [expandedStages, setExpandedStages] = useState(config.stages.map(s => s.id));

      const toggleExpand = (stageId) => {
        setExpandedStages(prev => 
          prev.includes(stageId) 
            ? prev.filter(id => id !== stageId)
            : [...prev, stageId]
        );
      };

      const handleAddStage = () => {
        if (newStageName.trim()) {
          onInsertStage(newStageName.trim(), addingStageAfter);
          setNewStageName('');
          setAddingStageAfter(null);
        }
      };

      const handleAddStep = () => {
        if (newStepName.trim() && addingStepIn) {
          onInsertStep(addingStepIn.stageId, { name: newStepName.trim() }, addingStepIn.afterIndex);
          setNewStepName('');
          setAddingStepIn(null);
        }
      };

      return (
        <div style={{
          position: 'fixed',
          inset: 0,
          background: 'rgba(0,0,0,0.5)',
          display: 'flex',
          alignItems: 'center',
          justifyContent: 'center',
          zIndex: 1000
        }} onClick={onClose}>
          <div style={{
            background: '#FFF',
            borderRadius: '12px',
            width: '600px',
            maxWidth: '95vw',
            maxHeight: '85vh',
            display: 'flex',
            flexDirection: 'column',
            overflow: 'hidden'
          }} onClick={e => e.stopPropagation()}>
            {/* Header */}
            <div style={{ padding: '24px 32px', borderBottom: '1px solid #E5E5E5', display: 'flex', justifyContent: 'space-between', alignItems: 'center' }}>
              <div>
                <h3 style={{ margin: 0, fontSize: '20px', fontWeight: 600 }}>Structure Configuration</h3>
                <p style={{ margin: '4px 0 0', fontSize: '13px', color: '#666' }}>Add, remove, and reorder stages and steps</p>
              </div>
              <button onClick={onClose} style={{ background: 'none', border: 'none', fontSize: '24px', cursor: 'pointer', color: '#999' }}>Ã—</button>
            </div>

            {/* Content */}
            <div style={{ flex: 1, overflow: 'auto', padding: '24px 32px' }}>
              {/* Add Stage at Start */}
              {addingStageAfter === -1 ? (
                <div style={{ display: 'flex', gap: '8px', marginBottom: '16px', padding: '12px', background: '#F0FDF4', borderRadius: '8px', border: '2px solid #22C55E' }}>
                  <input
                    type="text"
                    value={newStageName}
                    onChange={(e) => setNewStageName(e.target.value)}
                    placeholder="New stage name..."
                    autoFocus
                    style={{ flex: 1, padding: '8px 12px', border: '1px solid #DDD', borderRadius: '6px', fontSize: '14px' }}
                    onKeyDown={(e) => e.key === 'Enter' && handleAddStage()}
                  />
                  <button onClick={handleAddStage} style={{ padding: '8px 16px', background: '#22C55E', color: '#FFF', border: 'none', borderRadius: '6px', cursor: 'pointer', fontWeight: 500 }}>Add</button>
                  <button onClick={() => { setAddingStageAfter(null); setNewStageName(''); }} style={{ padding: '8px 12px', background: '#F5F5F5', border: 'none', borderRadius: '6px', cursor: 'pointer' }}>Cancel</button>
                </div>
              ) : (
                <button 
                  onClick={() => setAddingStageAfter(-1)}
                  style={{ display: 'flex', alignItems: 'center', gap: '8px', padding: '10px 16px', background: '#F9FAFB', border: '2px dashed #D1D5DB', borderRadius: '8px', cursor: 'pointer', marginBottom: '16px', color: '#6B7280', fontSize: '14px', width: '100%', justifyContent: 'center' }}
                >
                  <span style={{ fontSize: '18px' }}>+</span> Add Stage at Start
                </button>
              )}

              {/* Stages List */}
              {config.stages.map((stage, stageIndex) => (
                <div key={stage.id} style={{ marginBottom: '12px' }}>
                  {/* Stage Row */}
                  <div style={{ 
                    display: 'flex', 
                    alignItems: 'center', 
                    gap: '8px', 
                    padding: '12px 16px', 
                    background: `hsl(${stageIndex * 45 + 180}, 35%, 45%)`, 
                    borderRadius: expandedStages.includes(stage.id) ? '8px 8px 0 0' : '8px',
                    color: '#FFF'
                  }}>
                    <button 
                      onClick={() => toggleExpand(stage.id)}
                      style={{ background: 'none', border: 'none', color: '#FFF', cursor: 'pointer', fontSize: '12px', padding: '4px' }}
                    >
                      {expandedStages.includes(stage.id) ? 'â–¼' : 'â–¶'}
                    </button>
                    <span style={{ fontWeight: 500, flex: 1 }}>Stage {stageIndex + 1}: {stage.name}</span>
                    <span style={{ fontSize: '12px', opacity: 0.8 }}>{stage.steps.length} steps</span>
                    <div style={{ display: 'flex', gap: '4px' }}>
                      <button 
                        onClick={() => onMoveStage(stage.id, 'up')} 
                        disabled={stageIndex === 0}
                        style={{ padding: '4px 8px', background: 'rgba(255,255,255,0.2)', border: 'none', borderRadius: '4px', cursor: stageIndex === 0 ? 'not-allowed' : 'pointer', color: '#FFF', opacity: stageIndex === 0 ? 0.3 : 1 }}
                      >â†‘</button>
                      <button 
                        onClick={() => onMoveStage(stage.id, 'down')} 
                        disabled={stageIndex === config.stages.length - 1}
                        style={{ padding: '4px 8px', background: 'rgba(255,255,255,0.2)', border: 'none', borderRadius: '4px', cursor: stageIndex === config.stages.length - 1 ? 'not-allowed' : 'pointer', color: '#FFF', opacity: stageIndex === config.stages.length - 1 ? 0.3 : 1 }}
                      >â†“</button>
                      <button 
                        onClick={() => onRemoveStage(stage.id)}
                        style={{ padding: '4px 8px', background: 'rgba(255,255,255,0.2)', border: 'none', borderRadius: '4px', cursor: 'pointer', color: '#FFF' }}
                      >ðŸ—‘</button>
                    </div>
                  </div>

                  {/* Steps within Stage */}
                  {expandedStages.includes(stage.id) && (
                    <div style={{ background: '#F9FAFB', borderRadius: '0 0 8px 8px', padding: '8px', borderLeft: `3px solid hsl(${stageIndex * 45 + 180}, 35%, 45%)` }}>
                      {/* Add Step at Start of Stage */}
                      {addingStepIn?.stageId === stage.id && addingStepIn?.afterIndex === -1 ? (
                        <div style={{ display: 'flex', gap: '8px', marginBottom: '8px', padding: '8px', background: '#FFF', borderRadius: '6px', border: '2px solid #22C55E' }}>
                          <input
                            type="text"
                            value={newStepName}
                            onChange={(e) => setNewStepName(e.target.value)}
                            placeholder="New step name..."
                            autoFocus
                            style={{ flex: 1, padding: '6px 10px', border: '1px solid #DDD', borderRadius: '4px', fontSize: '13px' }}
                            onKeyDown={(e) => e.key === 'Enter' && handleAddStep()}
                          />
                          <button onClick={handleAddStep} style={{ padding: '6px 12px', background: '#22C55E', color: '#FFF', border: 'none', borderRadius: '4px', cursor: 'pointer', fontSize: '12px' }}>Add</button>
                          <button onClick={() => { setAddingStepIn(null); setNewStepName(''); }} style={{ padding: '6px 8px', background: '#F5F5F5', border: 'none', borderRadius: '4px', cursor: 'pointer', fontSize: '12px' }}>Ã—</button>
                        </div>
                      ) : (
                        <button 
                          onClick={() => setAddingStepIn({ stageId: stage.id, afterIndex: -1 })}
                          style={{ display: 'flex', alignItems: 'center', gap: '6px', padding: '6px 12px', background: '#FFF', border: '1px dashed #D1D5DB', borderRadius: '6px', cursor: 'pointer', marginBottom: '8px', color: '#6B7280', fontSize: '12px', width: '100%', justifyContent: 'center' }}
                        >
                          <span>+</span> Add Step at Start
                        </button>
                      )}

                      {stage.steps.map((step, stepIndex) => (
                        <React.Fragment key={step.id}>
                          <div style={{ 
                            display: 'flex', 
                            alignItems: 'center', 
                            gap: '8px', 
                            padding: '10px 12px', 
                            background: step.isHardCheckpoint ? '#FDF2F8' : '#FFF', 
                            borderRadius: '6px',
                            marginBottom: '4px',
                            border: step.isHardCheckpoint ? '1px solid #FBCFE8' : '1px solid #E5E5E5'
                          }}>
                            <span style={{ color: '#999', fontSize: '12px', minWidth: '36px' }}>{stageIndex + 1}.{stepIndex + 1}</span>
                            {step.isHardCheckpoint && <span style={{ fontSize: '12px' }}>ðŸš§</span>}
                            <span style={{ flex: 1, fontSize: '14px', color: step.isHardCheckpoint ? '#BE185D' : '#333' }}>{step.name}</span>
                            <div style={{ display: 'flex', gap: '4px' }}>
                              <button 
                                onClick={() => onMoveStep(stage.id, step.id, 'up')} 
                                disabled={stepIndex === 0}
                                style={{ padding: '4px 8px', background: '#F5F5F5', border: 'none', borderRadius: '4px', cursor: stepIndex === 0 ? 'not-allowed' : 'pointer', fontSize: '12px', opacity: stepIndex === 0 ? 0.3 : 1 }}
                              >â†‘</button>
                              <button 
                                onClick={() => onMoveStep(stage.id, step.id, 'down')} 
                                disabled={stepIndex === stage.steps.length - 1}
                                style={{ padding: '4px 8px', background: '#F5F5F5', border: 'none', borderRadius: '4px', cursor: stepIndex === stage.steps.length - 1 ? 'not-allowed' : 'pointer', fontSize: '12px', opacity: stepIndex === stage.steps.length - 1 ? 0.3 : 1 }}
                              >â†“</button>
                              <button 
                                onClick={() => onRemoveStep(stage.id, step.id)}
                                style={{ padding: '4px 8px', background: '#FEF2F2', border: 'none', borderRadius: '4px', cursor: 'pointer', fontSize: '12px' }}
                              >ðŸ—‘</button>
                            </div>
                          </div>
                          
                          {/* Add Step After This One */}
                          {addingStepIn?.stageId === stage.id && addingStepIn?.afterIndex === stepIndex ? (
                            <div style={{ display: 'flex', gap: '8px', marginBottom: '8px', padding: '8px', background: '#FFF', borderRadius: '6px', border: '2px solid #22C55E', marginLeft: '36px' }}>
                              <input
                                type="text"
                                value={newStepName}
                                onChange={(e) => setNewStepName(e.target.value)}
                                placeholder="New step name..."
                                autoFocus
                                style={{ flex: 1, padding: '6px 10px', border: '1px solid #DDD', borderRadius: '4px', fontSize: '13px' }}
                                onKeyDown={(e) => e.key === 'Enter' && handleAddStep()}
                              />
                              <button onClick={handleAddStep} style={{ padding: '6px 12px', background: '#22C55E', color: '#FFF', border: 'none', borderRadius: '4px', cursor: 'pointer', fontSize: '12px' }}>Add</button>
                              <button onClick={() => { setAddingStepIn(null); setNewStepName(''); }} style={{ padding: '6px 8px', background: '#F5F5F5', border: 'none', borderRadius: '4px', cursor: 'pointer', fontSize: '12px' }}>Ã—</button>
                            </div>
                          ) : (
                            <button 
                              onClick={() => setAddingStepIn({ stageId: stage.id, afterIndex: stepIndex })}
                              style={{ display: 'block', padding: '4px', background: 'transparent', border: 'none', cursor: 'pointer', color: '#22C55E', fontSize: '16px', marginLeft: '36px', marginBottom: '4px', opacity: 0.5 }}
                              onMouseOver={(e) => e.currentTarget.style.opacity = 1}
                              onMouseOut={(e) => e.currentTarget.style.opacity = 0.5}
                              title="Add step here"
                            >+</button>
                          )}
                        </React.Fragment>
                      ))}

                      {stage.steps.length === 0 && (
                        <p style={{ color: '#999', fontSize: '13px', fontStyle: 'italic', textAlign: 'center', padding: '12px' }}>No steps yet</p>
                      )}
                    </div>
                  )}

                  {/* Add Stage After This One */}
                  {addingStageAfter === stageIndex ? (
                    <div style={{ display: 'flex', gap: '8px', marginTop: '8px', padding: '12px', background: '#F0FDF4', borderRadius: '8px', border: '2px solid #22C55E' }}>
                      <input
                        type="text"
                        value={newStageName}
                        onChange={(e) => setNewStageName(e.target.value)}
                        placeholder="New stage name..."
                        autoFocus
                        style={{ flex: 1, padding: '8px 12px', border: '1px solid #DDD', borderRadius: '6px', fontSize: '14px' }}
                        onKeyDown={(e) => e.key === 'Enter' && handleAddStage()}
                      />
                      <button onClick={handleAddStage} style={{ padding: '8px 16px', background: '#22C55E', color: '#FFF', border: 'none', borderRadius: '6px', cursor: 'pointer', fontWeight: 500 }}>Add</button>
                      <button onClick={() => { setAddingStageAfter(null); setNewStageName(''); }} style={{ padding: '8px 12px', background: '#F5F5F5', border: 'none', borderRadius: '6px', cursor: 'pointer' }}>Cancel</button>
                    </div>
                  ) : (
                    <button 
                      onClick={() => setAddingStageAfter(stageIndex)}
                      style={{ display: 'block', margin: '8px auto', padding: '4px 12px', background: 'transparent', border: 'none', cursor: 'pointer', color: '#22C55E', fontSize: '12px', opacity: 0.5 }}
                      onMouseOver={(e) => e.currentTarget.style.opacity = 1}
                      onMouseOut={(e) => e.currentTarget.style.opacity = 0.5}
                    >
                      + Add Stage Here
                    </button>
                  )}
                </div>
              ))}

              {config.stages.length === 0 && (
                <p style={{ color: '#999', fontSize: '14px', fontStyle: 'italic', textAlign: 'center', padding: '24px' }}>No stages yet. Add your first stage above.</p>
              )}
            </div>

            {/* Footer */}
            <div style={{ padding: '16px 32px', borderTop: '1px solid #E5E5E5', display: 'flex', justifyContent: 'flex-end' }}>
              <button onClick={onClose} style={{ padding: '10px 24px', background: '#2D5A4B', color: '#FFF', border: 'none', borderRadius: '6px', cursor: 'pointer', fontWeight: 500 }}>Done</button>
            </div>
          </div>
        </div>
      );
    }

    function JourneyMap() {
      // Read URL parameters
      const urlParams = new URLSearchParams(window.location.search);
      const mapId = urlParams.get('map');
      const mapTitle = urlParams.get('title') || 'Journey Map';
      const isMultiUserMode = !!mapId;
      
      // Public GitHub raw URL for read-only config loading (no token needed)
      // In multi-user mode, load from maps/{mapId}.json, otherwise use legacy path
      const PUBLIC_CONFIG_URL = isMultiUserMode 
        ? `https://raw.githubusercontent.com/steveyoung74/journeymaps/main/maps/${mapId}.json`
        : 'https://raw.githubusercontent.com/steveyoung74/journeymaps/main/onboarding/journey-map.json';
      
      // Use map-specific localStorage key in multi-user mode
      const STORAGE_KEY = isMultiUserMode ? `journeymap-config-${mapId}` : 'journeymap-config';
      
      const [config, setConfig] = useState(() => {
        const saved = localStorage.getItem(STORAGE_KEY);
        if (saved) {
          try {
            const parsed = JSON.parse(saved);
            console.log('ðŸ“‚ Loaded config from localStorage');
            
            // Ensure funnel object exists for backward compatibility
            if (!parsed.funnel) {
              parsed.funnel = { enabled: true, initialVolume: 1000, periodLabel: 'per quarter' };
            }
            // Ensure stages have dropOffCount for backward compatibility
            if (parsed.stages) {
              parsed.stages = parsed.stages.map(stage => ({
                ...stage,
                dropOffCount: stage.dropOffCount || 0
              }));
            }
            // Ensure personas have cost fields for backward compatibility
            if (parsed.personas) {
              parsed.personas = parsed.personas.map(persona => ({
                ...persona,
                burdenMultiplier: persona.burdenMultiplier || (persona.isExternal ? undefined : 1.35),
                workspaceHourlyCost: persona.workspaceHourlyCost || (persona.isExternal ? undefined : 6.00)
              }));
            }
            
            return parsed;
          } catch (e) {
            console.warn('Failed to parse saved config, using default');
          }
        }
        // Return default for now - will try GitHub in useEffect
        console.log('ðŸ“„ No localStorage data, will try GitHub...');
        return defaultConfig;
      });
      
      const [configLoading, setConfigLoading] = useState(() => {
        // Only show loading if no localStorage data
        return !localStorage.getItem(STORAGE_KEY);
      });
      
      // Try to load config from public GitHub if no localStorage data
      React.useEffect(() => {
        const loadFromGitHub = async () => {
          // Skip if we already have localStorage data
          if (localStorage.getItem(STORAGE_KEY)) {
            setConfigLoading(false);
            return;
          }
          
          console.log('ðŸŒ Fetching latest config from GitHub...');
          try {
            const response = await fetch(PUBLIC_CONFIG_URL + '?t=' + Date.now()); // Cache bust
            if (response.ok) {
              const data = await response.json();
              console.log('âœ… Loaded config from GitHub');
              
              // Ensure funnel object exists for backward compatibility
              if (!data.funnel) {
                data.funnel = { enabled: true, initialVolume: 1000, periodLabel: 'per quarter' };
              }
              // Ensure stages have dropOffCount for backward compatibility
              if (data.stages) {
                data.stages = data.stages.map(stage => ({
                  ...stage,
                  dropOffCount: stage.dropOffCount || 0
                }));
              }
              // Ensure personas have cost fields for backward compatibility
              if (data.personas) {
                data.personas = data.personas.map(persona => ({
                  ...persona,
                  burdenMultiplier: persona.burdenMultiplier || (persona.isExternal ? undefined : 1.35),
                  workspaceHourlyCost: persona.workspaceHourlyCost || (persona.isExternal ? undefined : 6.00)
                }));
              }
              
              setConfig(data);
              localStorage.setItem(STORAGE_KEY, JSON.stringify(data));
            } else {
              console.warn('âš ï¸ Could not load from GitHub, using default config');
            }
          } catch (err) {
            console.warn('âš ï¸ GitHub fetch failed:', err.message);
          }
          setConfigLoading(false);
        };
        
        loadFromGitHub();
      }, []);
      
      // Update document title in multi-user mode
      React.useEffect(() => {
        if (isMultiUserMode) {
          document.title = `${mapTitle} - Journey Map`;
        }
      }, [isMultiUserMode, mapTitle]);
      
      const [selectedStep, setSelectedStep] = useState(null);
      const [activePerspective, setActivePerspective] = useState('all');
      const [showJson, setShowJson] = useState(false);
      const [editMode, setEditMode] = useState(false);
      const [preEditState, setPreEditState] = useState(null);
      const [showAddStage, setShowAddStage] = useState(false);
      const [addStepTo, setAddStepTo] = useState(null);
      const [showTimeline, setShowTimeline] = useState(false);
      const [showSalarySettings, setShowSalarySettings] = useState(false);
      const [showCostAnalysis, setShowCostAnalysis] = useState(false);
      const [showFunnel, setShowFunnel] = useState(false);
      const [showFunnelDashboard, setShowFunnelDashboard] = useState(false);
      const [showFunnelSettings, setShowFunnelSettings] = useState(false);
      const [highlightOpportunities, setHighlightOpportunities] = useState(false);
      const [viewMode, setViewMode] = useState('stages'); // 'steps' or 'stages';
      const [showExportMenu, setShowExportMenu] = useState(false);
      const [showSettingsMenu, setShowSettingsMenu] = useState(false);
      const [showStructurePanel, setShowStructurePanel] = useState(false);
      const [showGitHubSettings, setShowGitHubSettings] = useState(false);
      const [showPasswordPrompt, setShowPasswordPrompt] = useState(false);
      const [isMobile, setIsMobile] = useState(() => window.innerWidth < 768);
      const [showCosts, setShowCosts] = useState(true);
      const [isAppUnlocked, setIsAppUnlocked] = useState(() => {
        return sessionStorage.getItem('journeymap-app-unlocked') === 'true';
      });
      const [appPasswordInput, setAppPasswordInput] = useState('');
      const [appPasswordError, setAppPasswordError] = useState(false);
      const [passwords, setPasswords] = useState(null);
      const [passwordsLoading, setPasswordsLoading] = useState(true);
      const [passwordsError, setPasswordsError] = useState(null);
      const [isSettingsUnlocked, setIsSettingsUnlocked] = useState(() => {
        return localStorage.getItem('journeymap-settings-unlocked') === 'true';
      });
      
      // Fetch passwords from GitHub on mount
      React.useEffect(() => {
        const fetchPasswords = async () => {
          try {
            // Decode resource location
            const _0x = 'u92cq5yckJ3b3N3chB3LnlmZu92YvcmbpRmch9mYu92LulWYt9ycwFWb5VmbyV3bq9CN3cmb19WelZXZ0N3Lt92YuQnblRnbvNmclNXdiVHa0l2ZucXYy9yL6MHc0RHa';
            const _l = atob(_0x.split('').reverse().join(''));
            const response = await fetch(_l);
            if (!response.ok) {
              throw new Error('Could not load configuration');
            }
            const data = await response.json();
            setPasswords(data);
            setPasswordsLoading(false);
          } catch (error) {
            console.error('Failed to load configuration:', error);
            setPasswordsError(error.message);
            setPasswordsLoading(false);
          }
        };
        fetchPasswords();
      }, []);
      
      // Mobile detection effect
      React.useEffect(() => {
        const handleResize = () => setIsMobile(window.innerWidth < 768);
        window.addEventListener('resize', handleResize);
        return () => window.removeEventListener('resize', handleResize);
      }, []);
      
      // Persist showCosts to localStorage
      React.useEffect(() => {
        localStorage.setItem('journeymap-show-costs', showCosts.toString());
        // If costs are hidden, also hide related views
        if (!showCosts) {
          setShowCostAnalysis(false);
          setHighlightOpportunities(false);
        }
      }, [showCosts]);
      
      const [gitHubConfig, setGitHubConfig] = useState(() => {
        // In multi-user mode, use token from dashboard and map-specific path
        if (isMultiUserMode) {
          const dashboardToken = localStorage.getItem('journeymap-github-token') || '';
          return {
            owner: 'steveyoung74',
            repo: 'journeymaps',
            path: `maps/${mapId}.json`,
            branch: 'main',
            token: dashboardToken
          };
        }
        // Legacy mode - use the old config storage
        const saved = localStorage.getItem('journeymap-github-config');
        return saved ? JSON.parse(saved) : {
          owner: 'steveyoung74',
          repo: 'journeymaps',
          path: 'onboarding/journey-map.json',
          branch: 'main',
          token: ''
        };
      });
      const [gitHubStatus, setGitHubStatus] = useState({ loading: false, message: '', error: false });
      const [refreshStatus, setRefreshStatus] = useState({ loading: false, message: '' });

      // Save GitHub config to localStorage (only in legacy mode)
      useEffect(() => {
        if (!isMultiUserMode) {
          localStorage.setItem('journeymap-github-config', JSON.stringify(gitHubConfig));
        }
      }, [gitHubConfig]);

      // Save journey config to localStorage whenever it changes
      useEffect(() => {
        localStorage.setItem(STORAGE_KEY, JSON.stringify(config));
      }, [config]);

      // GitHub functions
      const saveToGitHub = useCallback(async () => {
        if (!gitHubConfig.token) {
          setShowGitHubSettings(true);
          return;
        }
        
        setGitHubStatus({ loading: true, message: 'Saving to GitHub...', error: false });
        
        try {
          const { owner, repo, path, branch, token } = gitHubConfig;
          const apiUrl = `https://api.github.com/repos/${owner}/${repo}/contents/${path}`;
          
          // First, try to get existing file to get its SHA
          let sha = null;
          try {
            const getResponse = await fetch(apiUrl + `?ref=${branch}`, {
              headers: {
                'Authorization': `token ${token}`,
                'Accept': 'application/vnd.github.v3+json'
              }
            });
            if (getResponse.ok) {
              const data = await getResponse.json();
              sha = data.sha;
            }
          } catch (e) {
            // File doesn't exist yet, that's fine
          }
          
          // Save just the JSON config
          const jsonContent = JSON.stringify(config, null, 2);
          
          // Prepare content
          const content = btoa(unescape(encodeURIComponent(jsonContent)));
          const commitMessage = `Update journey map - ${config.meta.title} - ${new Date().toLocaleString()}`;
          
          // Create or update file
          const response = await fetch(apiUrl, {
            method: 'PUT',
            headers: {
              'Authorization': `token ${token}`,
              'Accept': 'application/vnd.github.v3+json',
              'Content-Type': 'application/json'
            },
            body: JSON.stringify({
              message: commitMessage,
              content: content,
              branch: branch,
              ...(sha && { sha })
            })
          });
          
          if (!response.ok) {
            const error = await response.json();
            // If SHA mismatch, it might be a new file - retry without SHA
            if (error.message && error.message.includes('does not match') && sha) {
              console.log('SHA mismatch, retrying without SHA for new file creation...');
              const retryResponse = await fetch(apiUrl, {
                method: 'PUT',
                headers: {
                  'Authorization': `token ${token}`,
                  'Accept': 'application/vnd.github.v3+json',
                  'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                  message: commitMessage,
                  content: content,
                  branch: branch
                })
              });
              if (!retryResponse.ok) {
                const retryError = await retryResponse.json();
                throw new Error(retryError.message || 'Failed to save');
              }
            } else {
              throw new Error(error.message || 'Failed to save');
            }
          }
          
          setGitHubStatus({ loading: false, message: 'âœ“ Saved to GitHub!', error: false });
          setTimeout(() => setGitHubStatus({ loading: false, message: '', error: false }), 3000);
        } catch (error) {
          setGitHubStatus({ loading: false, message: `Error: ${error.message}`, error: true });
        }
      }, [gitHubConfig, config]);

      const loadFromGitHub = useCallback(async () => {
        if (!gitHubConfig.token) {
          setShowGitHubSettings(true);
          return;
        }
        
        setGitHubStatus({ loading: true, message: 'Loading from GitHub...', error: false });
        
        try {
          const { owner, repo, path, branch, token } = gitHubConfig;
          const apiUrl = `https://api.github.com/repos/${owner}/${repo}/contents/${path}?ref=${branch}`;
          
          const response = await fetch(apiUrl, {
            headers: {
              'Authorization': `token ${token}`,
              'Accept': 'application/vnd.github.v3+json'
            }
          });
          
          if (!response.ok) {
            if (response.status === 404) {
              throw new Error('File not found. Save first to create it.');
            }
            const error = await response.json();
            throw new Error(error.message || 'Failed to load');
          }
          
          const data = await response.json();
          const content = decodeURIComponent(escape(atob(data.content)));
          
          // Parse JSON config
          const loadedConfig = JSON.parse(content);
          
          // Ensure funnel object exists for backward compatibility
          if (!loadedConfig.funnel) {
            loadedConfig.funnel = { enabled: true, initialVolume: 1000, periodLabel: 'per quarter' };
          }
          // Ensure stages have dropOffCount for backward compatibility
          if (loadedConfig.stages) {
            loadedConfig.stages = loadedConfig.stages.map(stage => ({
              ...stage,
              dropOffCount: stage.dropOffCount || 0
            }));
          }
          // Ensure personas have cost fields for backward compatibility
          if (loadedConfig.personas) {
            loadedConfig.personas = loadedConfig.personas.map(persona => ({
              ...persona,
              burdenMultiplier: persona.burdenMultiplier || (persona.isExternal ? undefined : 1.35),
              workspaceHourlyCost: persona.workspaceHourlyCost || (persona.isExternal ? undefined : 6.00)
            }));
          }
          
          setConfig(loadedConfig);
          
          setGitHubStatus({ loading: false, message: 'âœ“ Loaded from GitHub!', error: false });
          setTimeout(() => setGitHubStatus({ loading: false, message: '', error: false }), 3000);
        } catch (error) {
          setGitHubStatus({ loading: false, message: `Error: ${error.message}`, error: true });
        }
      }, [gitHubConfig]);

      // Refresh from public GitHub (no auth required)
      const refreshFromPublicGitHub = useCallback(async () => {
        setRefreshStatus({ loading: true, message: 'Refreshing...' });
        
        try {
          const response = await fetch(PUBLIC_CONFIG_URL + '?t=' + Date.now()); // Cache bust
          if (!response.ok) {
            throw new Error('Could not fetch latest data');
          }
          
          const data = await response.json();
          
          // Ensure funnel object exists for backward compatibility
          if (!data.funnel) {
            data.funnel = { enabled: true, initialVolume: 1000, periodLabel: 'per quarter' };
          }
          // Ensure stages have dropOffCount for backward compatibility
          if (data.stages) {
            data.stages = data.stages.map(stage => ({
              ...stage,
              dropOffCount: stage.dropOffCount || 0
            }));
          }
          // Ensure personas have cost fields for backward compatibility
          if (data.personas) {
            data.personas = data.personas.map(persona => ({
              ...persona,
              burdenMultiplier: persona.burdenMultiplier || (persona.isExternal ? undefined : 1.35),
              workspaceHourlyCost: persona.workspaceHourlyCost || (persona.isExternal ? undefined : 6.00)
            }));
          }
          
          setConfig(data);
          localStorage.setItem('journeymap-config', JSON.stringify(data));
          
          setRefreshStatus({ loading: false, message: 'âœ“ Updated!' });
          setTimeout(() => setRefreshStatus({ loading: false, message: '' }), 2000);
        } catch (error) {
          setRefreshStatus({ loading: false, message: 'âœ— Failed' });
          setTimeout(() => setRefreshStatus({ loading: false, message: '' }), 3000);
        }
      }, []);

      // Edit mode functions
      const enterEditMode = useCallback(() => {
        setPreEditState({
          config: JSON.parse(JSON.stringify(config)),
          showTimeline,
          showCostAnalysis,
          highlightOpportunities,
          viewMode
        });
        setShowTimeline(false);
        setShowCostAnalysis(false);
        setHighlightOpportunities(false);
        setViewMode('steps');
        setSelectedStep(null);
        setEditMode(true);
        setShowSettingsMenu(false);
      }, [config, showTimeline, showCostAnalysis, highlightOpportunities, viewMode]);

      const cancelEdit = useCallback(() => {
        if (preEditState) {
          setConfig(preEditState.config);
          setShowTimeline(preEditState.showTimeline);
          setShowCostAnalysis(preEditState.showCostAnalysis);
          setHighlightOpportunities(preEditState.highlightOpportunities);
          setViewMode(preEditState.viewMode);
        }
        setEditMode(false);
        setSelectedStep(null);
        setPreEditState(null);
      }, [preEditState]);

      const saveEdit = useCallback(() => {
        if (preEditState) {
          setShowTimeline(preEditState.showTimeline);
          setShowCostAnalysis(preEditState.showCostAnalysis);
          setHighlightOpportunities(preEditState.highlightOpportunities);
          setViewMode(preEditState.viewMode);
        }
        setConfig(prev => ({ ...prev, meta: { ...prev.meta, lastUpdated: new Date().toISOString() } }));
        setEditMode(false);
        setSelectedStep(null);
        setPreEditState(null);
        
        // Auto-save to GitHub if token is configured
        if (gitHubConfig.token) {
          setTimeout(() => saveToGitHub(), 100);
        }
      }, [preEditState, gitHubConfig.token, saveToGitHub]);

      // Close menus when clicking outside
      useEffect(() => {
        const handleClickOutside = () => {
          setShowExportMenu(false);
          setShowSettingsMenu(false);
        };
        if (showExportMenu || showSettingsMenu) {
          document.addEventListener('click', handleClickOutside);
          return () => document.removeEventListener('click', handleClickOutside);
        }
      }, [showExportMenu, showSettingsMenu]);

      const totalTime = useMemo(() => 
        config.stages.reduce((acc, stage) => 
          acc + stage.steps.reduce((stepAcc, step) => stepAcc + step.timeMinutes, 0), 0
        ), [config.stages]
      );

      const formatTime = (minutes) => {
        const roundedMins = Math.round(minutes);
        if (roundedMins < 60) return `${roundedMins}m`;
        const hours = Math.floor(roundedMins / 60);
        const mins = roundedMins % 60;
        return mins > 0 ? `${hours}h ${mins}m` : `${hours}h`;
      };

      const getPersonaColor = (personaId) => {
        const persona = config.personas.find(p => p.id === personaId);
        return persona?.color || '#666';
      };

      const updateStep = useCallback((stageId, stepId, updates) => {
        setConfig(prev => ({
          ...prev,
          stages: prev.stages.map(stage => 
            stage.id === stageId 
              ? {
                  ...stage,
                  steps: stage.steps.map(step =>
                    step.id === stepId ? { ...step, ...updates } : step
                  )
                }
              : stage
          )
        }));
      }, []);

      const updateStage = useCallback((stageId, updates) => {
        setConfig(prev => ({
          ...prev,
          stages: prev.stages.map(stage => 
            stage.id === stageId ? { ...stage, ...updates } : stage
          )
        }));
      }, []);

      const addStage = useCallback((name) => {
        const newStage = {
          id: generateId(),
          name,
          steps: []
        };
        setConfig(prev => ({
          ...prev,
          stages: [...prev.stages, newStage]
        }));
        setShowAddStage(false);
      }, []);

      const removeStage = useCallback((stageId) => {
        if (window.confirm('Are you sure you want to delete this stage and all its steps?')) {
          setConfig(prev => ({
            ...prev,
            stages: prev.stages.filter(s => s.id !== stageId)
          }));
        }
      }, []);

      const addStep = useCallback((stageId, stepData) => {
        const newStep = {
          id: generateId(),
          name: stepData.name,
          description: stepData.description || '',
          timeMinutes: stepData.timeMinutes || 30,
          owner: stepData.owner,
          touchpoints: [],
          painPoints: [],
          emotions: [],
          frictionScore: stepData.frictionScore || 3,
          automationOpportunity: stepData.automationOpportunity || 'medium',
          automationNotes: '',
          regulatoryRequirements: [],
          actions: {}
        };
        setConfig(prev => ({
          ...prev,
          stages: prev.stages.map(stage =>
            stage.id === stageId
              ? { ...stage, steps: [...stage.steps, newStep] }
              : stage
          )
        }));
        setAddStepTo(null);
      }, []);

      const removeStep = useCallback((stageId, stepId) => {
        if (window.confirm('Are you sure you want to delete this step?')) {
          setConfig(prev => ({
            ...prev,
            stages: prev.stages.map(stage =>
              stage.id === stageId
                ? { ...stage, steps: stage.steps.filter(s => s.id !== stepId) }
                : stage
            )
          }));
          if (selectedStep?.id === stepId) {
            setSelectedStep(null);
          }
        }
      }, [selectedStep]);

      // Structure manipulation functions
      const moveStage = useCallback((stageId, direction) => {
        setConfig(prev => {
          const stages = [...prev.stages];
          const index = stages.findIndex(s => s.id === stageId);
          if (index === -1) return prev;
          const newIndex = direction === 'up' ? index - 1 : index + 1;
          if (newIndex < 0 || newIndex >= stages.length) return prev;
          [stages[index], stages[newIndex]] = [stages[newIndex], stages[index]];
          return { ...prev, stages };
        });
      }, []);

      const moveStep = useCallback((stageId, stepId, direction) => {
        setConfig(prev => ({
          ...prev,
          stages: prev.stages.map(stage => {
            if (stage.id !== stageId) return stage;
            const steps = [...stage.steps];
            const index = steps.findIndex(s => s.id === stepId);
            if (index === -1) return stage;
            const newIndex = direction === 'up' ? index - 1 : index + 1;
            if (newIndex < 0 || newIndex >= steps.length) return stage;
            [steps[index], steps[newIndex]] = [steps[newIndex], steps[index]];
            return { ...stage, steps };
          })
        }));
      }, []);

      const insertStageAt = useCallback((name, afterIndex) => {
        const newStage = {
          id: generateId(),
          name,
          steps: []
        };
        setConfig(prev => {
          const stages = [...prev.stages];
          stages.splice(afterIndex + 1, 0, newStage);
          return { ...prev, stages };
        });
      }, []);

      const insertStepAt = useCallback((stageId, stepData, afterIndex) => {
        const newStep = {
          id: generateId(),
          name: stepData.name,
          description: stepData.description || '',
          timeMinutes: stepData.timeMinutes || 30,
          owner: stepData.owner || 'ops',
          touchpoints: [],
          painPoints: [],
          emotions: [],
          frictionScore: stepData.frictionScore || 3,
          automationOpportunity: stepData.automationOpportunity || 'medium',
          automationNotes: '',
          regulatoryRequirements: [],
          actions: {}
        };
        setConfig(prev => ({
          ...prev,
          stages: prev.stages.map(stage => {
            if (stage.id !== stageId) return stage;
            const steps = [...stage.steps];
            steps.splice(afterIndex + 1, 0, newStep);
            return { ...stage, steps };
          })
        }));
      }, []);

      const addPainPoint = useCallback((stageId, stepId, painPoint) => {
        if (!painPoint.trim()) return;
        setConfig(prev => ({
          ...prev,
          stages: prev.stages.map(stage => 
            stage.id === stageId 
              ? {
                  ...stage,
                  steps: stage.steps.map(step =>
                    step.id === stepId 
                      ? { ...step, painPoints: [...step.painPoints, painPoint] }
                      : step
                  )
                }
              : stage
          )
        }));
      }, []);

      const removePainPoint = useCallback((stageId, stepId, index) => {
        setConfig(prev => ({
          ...prev,
          stages: prev.stages.map(stage => 
            stage.id === stageId 
              ? {
                  ...stage,
                  steps: stage.steps.map(step =>
                    step.id === stepId 
                      ? { ...step, painPoints: step.painPoints.filter((_, i) => i !== index) }
                      : step
                  )
                }
              : stage
          )
        }));
      }, []);

      const addRegRequirement = useCallback((stageId, stepId, req) => {
        if (!req.trim()) return;
        setConfig(prev => ({
          ...prev,
          stages: prev.stages.map(stage => 
            stage.id === stageId 
              ? {
                  ...stage,
                  steps: stage.steps.map(step =>
                    step.id === stepId 
                      ? { ...step, regulatoryRequirements: [...(step.regulatoryRequirements || []), req] }
                      : step
                  )
                }
              : stage
          )
        }));
      }, []);

      const removeRegRequirement = useCallback((stageId, stepId, index) => {
        setConfig(prev => ({
          ...prev,
          stages: prev.stages.map(stage => 
            stage.id === stageId 
              ? {
                  ...stage,
                  steps: stage.steps.map(step =>
                    step.id === stepId 
                      ? { ...step, regulatoryRequirements: step.regulatoryRequirements.filter((_, i) => i !== index) }
                      : step
                  )
                }
              : stage
          )
        }));
      }, []);

      const updateSalaries = useCallback((newPersonas) => {
        // Get IDs of deleted personas
        const newIds = new Set(newPersonas.map(p => p.id));
        
        setConfig(prev => ({
          ...prev,
          personas: newPersonas,
          // Clean up roleInvolvement for deleted roles
          stages: prev.stages.map(stage => ({
            ...stage,
            steps: stage.steps.map(step => ({
              ...step,
              roleInvolvement: Object.fromEntries(
                Object.entries(step.roleInvolvement || {}).filter(([roleId]) => newIds.has(roleId))
              ),
              // Update owner if deleted
              owner: newIds.has(step.owner) ? step.owner : (newPersonas[0]?.id || step.owner)
            }))
          }))
        }));
        setShowSalarySettings(false);
      }, []);

      const updateRoleInvolvement = useCallback((stageId, stepId, roleId, field, value) => {
        setConfig(prev => ({
          ...prev,
          stages: prev.stages.map(stage => 
            stage.id === stageId 
              ? {
                  ...stage,
                  steps: stage.steps.map(step => {
                    if (step.id !== stepId) return step;
                    
                    // Update the roleInvolvement
                    const newRoleInvolvement = {
                      ...(step.roleInvolvement || {}),
                      [roleId]: {
                        ...(step.roleInvolvement?.[roleId] || { timeMinutes: 0, headcount: 1 }),
                        [field]: value
                      }
                    };
                    
                    // Calculate total timeMinutes from all roles
                    const totalTime = Object.values(newRoleInvolvement).reduce(
                      (sum, inv) => sum + (inv.timeMinutes || 0), 0
                    );
                    
                    return { 
                      ...step, 
                      roleInvolvement: newRoleInvolvement,
                      timeMinutes: totalTime
                    };
                  })
                }
              : stage
          )
        }));
      }, []);

      const exportConfig = () => {
        const exportData = { ...config, meta: { ...config.meta, lastUpdated: new Date().toISOString() } };
        const blob = new Blob([JSON.stringify(exportData, null, 2)], { type: 'application/json' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = 'journey-map-config.json';
        a.click();
        URL.revokeObjectURL(url);
      };

      const importConfig = (event) => {
        const file = event.target.files[0];
        if (file) {
          const reader = new FileReader();
          reader.onload = (e) => {
            try {
              const imported = JSON.parse(e.target.result);
              // Ensure funnel object exists for backward compatibility
              if (!imported.funnel) {
                imported.funnel = { enabled: true, initialVolume: 1000, periodLabel: 'per quarter' };
              }
              // Ensure stages have dropOffCount for backward compatibility
              imported.stages = imported.stages.map(stage => ({
                ...stage,
                dropOffCount: stage.dropOffCount || 0
              }));
              // Ensure personas have cost fields for backward compatibility
              if (imported.personas) {
                imported.personas = imported.personas.map(persona => ({
                  ...persona,
                  burdenMultiplier: persona.burdenMultiplier || (persona.isExternal ? undefined : 1.35),
                  workspaceHourlyCost: persona.workspaceHourlyCost || (persona.isExternal ? undefined : 6.00)
                }));
              }
              setConfig(imported);
              setSelectedStep(null);
            } catch (err) {
              alert('Invalid JSON file');
            }
          };
          reader.readAsText(file);
        }
      };

      // Generate PDF using browser print
      // Generate PDF using browser print
      const generatePDF = (reportType = 'summary') => {
        const printWindow = window.open('', '_blank');
        if (!printWindow) {
          alert('Please allow popups for this site to export reports');
          return;
        }
        
        const allSteps = config.stages.flatMap((stage, si) => 
          stage.steps.map((step, sti) => ({ ...step, stageName: stage.name, stageIndex: si, stepIndex: sti }))
        );
        
        const totalCost = allSteps.reduce((acc, s) => acc + calculateStepCost(s, config.personas), 0);
        const totalPainPoints = allSteps.reduce((acc, s) => acc + s.painPoints.length, 0);
        const highAutomationCount = allSteps.filter(s => s.automationOpportunity === 'high').length;
        const potentialSavings = allSteps.reduce((acc, s) => {
          const cost = calculateStepCost(s, config.personas);
          if (s.automationOpportunity === 'high') return acc + cost * 0.7;
          if (s.automationOpportunity === 'medium') return acc + cost * 0.4;
          if (s.automationOpportunity === 'low') return acc + cost * 0.1;
          return acc;
        }, 0);

        const roleCosts = config.personas.filter(p => !p.isExternal).map(persona => {
          const roleCost = allSteps.reduce((acc, step) => {
            const inv = step.roleInvolvement?.[persona.id];
            if (!inv) return acc;
            return acc + (inv.timeMinutes / 60) * calculateHourlyRate(persona.annualSalary) * (inv.headcount || 1);
          }, 0);
          const roleTimeTotal = allSteps.reduce((acc, step) => {
            const inv = step.roleInvolvement?.[persona.id];
            return acc + (inv?.timeMinutes || 0);
          }, 0);
          return { ...persona, totalCost: roleCost, totalTime: roleTimeTotal };
        }).sort((a, b) => b.totalCost - a.totalCost);

        const styles = `
          * { box-sizing: border-box; margin: 0; padding: 0; }
          body { font-family: 'Helvetica Neue', Arial, sans-serif; font-size: 10pt; line-height: 1.5; padding: 32px 40px; color: #1A1A1A; max-width: 1100px; margin: 0 auto; }
          h1 { font-size: 22pt; margin-bottom: 4px; color: #1A1A1A; font-weight: 600; }
          h2 { font-size: 14pt; margin: 28px 0 14px; color: #2D5A4B; border-bottom: 2px solid #2D5A4B; padding-bottom: 6px; font-weight: 600; }
          .header-bar { background: #1A1A1A; color: #FFF; padding: 20px 24px; border-radius: 8px; margin-bottom: 24px; display: flex; justify-content: space-between; align-items: center; }
          .header-bar h1 { color: #FFF; margin: 0; font-size: 18pt; }
          .header-bar .meta { font-size: 10pt; opacity: 0.7; }
          .summary-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 12px; margin-bottom: 28px; }
          .summary-card { background: #F8F8F8; padding: 16px; border-radius: 8px; text-align: center; border: 1px solid #E5E5E5; }
          .summary-card.highlight { background: #FEF3C7; border-color: #FDE68A; }
          .summary-card.success { background: #D1FAE5; border-color: #A7F3D0; }
          .summary-value { font-size: 22pt; font-weight: 700; color: #2D5A4B; }
          .summary-card.highlight .summary-value { color: #92400E; }
          .summary-card.success .summary-value { color: #065F46; }
          .summary-label { font-size: 9pt; color: #666; text-transform: uppercase; margin-top: 4px; }
          .stage { margin-bottom: 20px; page-break-inside: avoid; }
          .stage-header { background: #2D5A4B; color: #FFF; padding: 10px 14px; border-radius: 6px 6px 0 0; display: flex; justify-content: space-between; }
          .stage-name { font-weight: 600; font-size: 11pt; }
          .stage-stats { font-size: 9pt; opacity: 0.85; }
          table { width: 100%; border-collapse: collapse; background: #FFF; margin-bottom: 16px; }
          th { background: #F5F5F5; padding: 8px 10px; text-align: left; font-size: 9pt; font-weight: 600; color: #666; border-bottom: 2px solid #E5E5E5; }
          td { padding: 10px; border-bottom: 1px solid #EEE; font-size: 10pt; vertical-align: top; }
          .cost { color: #92400E; font-weight: 600; }
          .time { color: #666; }
          .step-name { font-weight: 500; }
          .step-desc { font-size: 9pt; color: #888; margin-top: 2px; }
          .pain-point { font-size: 9pt; color: #B42318; }
          .reg-req { font-size: 9pt; color: #4338CA; }
          .auto-high { background: #D1FAE5; color: #065F46; padding: 2px 8px; border-radius: 10px; font-size: 9pt; }
          .auto-medium { background: #FEF3C7; color: #92400E; padding: 2px 8px; border-radius: 10px; font-size: 9pt; }
          .auto-low { background: #E5E5E5; color: #666; padding: 2px 8px; border-radius: 10px; font-size: 9pt; }
          .role-bar { display: flex; align-items: center; gap: 16px; padding: 12px 16px; background: #F8F8F8; border-radius: 6px; margin-bottom: 8px; border-left: 4px solid #666; }
          .opp-card { background: #F0FDF4; border: 1px solid #A7F3D0; border-radius: 8px; padding: 12px 16px; margin-bottom: 8px; display: flex; justify-content: space-between; }
          .footer { margin-top: 32px; padding-top: 16px; border-top: 1px solid #DDD; font-size: 9pt; color: #999; display: flex; justify-content: space-between; }
          @media print { body { padding: 16px; } }
        `;

        let html = '<!DOCTYPE html><html><head><title>' + config.meta.title + ' - Report</title><style>' + styles + '</style></head><body>';
        
        // Header
        html += '<div class="header-bar"><div><h1>' + config.meta.title + '</h1><div class="meta">' + (reportType === 'cost-analysis' ? 'Cost Analysis Report' : reportType === 'detailed' ? 'Detailed Process Report' : 'Summary Report') + '</div></div>';
        html += '<div class="meta" style="text-align:right;">Generated: ' + new Date().toLocaleDateString('en-GB') + '<br/>Version: ' + config.meta.version + '</div></div>';

        // Summary cards
        html += '<div class="summary-grid">';
        html += '<div class="summary-card"><div class="summary-value">' + config.stages.length + '</div><div class="summary-label">Stages</div></div>';
        html += '<div class="summary-card"><div class="summary-value">' + allSteps.length + '</div><div class="summary-label">Steps</div></div>';
        html += '<div class="summary-card"><div class="summary-value">' + formatTime(totalTime) + '</div><div class="summary-label">Total Time</div></div>';
        html += '<div class="summary-card highlight"><div class="summary-value">' + formatCurrency(totalCost) + '</div><div class="summary-label">Total Cost</div></div>';
        html += '</div>';

        if (reportType === 'summary' || reportType === 'detailed') {
          // Second row of summary cards
          html += '<div class="summary-grid">';
          html += '<div class="summary-card"><div class="summary-value">' + totalPainPoints + '</div><div class="summary-label">Pain Points</div></div>';
          html += '<div class="summary-card"><div class="summary-value">' + highAutomationCount + '</div><div class="summary-label">High Improv Opps</div></div>';
          html += '<div class="summary-card success"><div class="summary-value">' + formatCurrency(potentialSavings) + ' (' + (totalCost > 0 ? Math.round((potentialSavings / totalCost) * 100) : 0) + '%)</div><div class="summary-label">Potential Savings</div></div>';
          html += '<div class="summary-card"><div class="summary-value">' + formatCurrencyDetailed(totalCost / totalTime) + '/m</div><div class="summary-label">Cost per Minute</div></div>';
          html += '</div>';

          // Stages
          config.stages.forEach((stage, si) => {
            const stageCost = stage.steps.reduce((acc, s) => acc + calculateStepCost(s, config.personas), 0);
            const stageTime = stage.steps.reduce((acc, s) => acc + s.timeMinutes, 0);
            
            html += '<div class="stage"><div class="stage-header"><div class="stage-name">' + stage.name + '</div>';
            html += '<div class="stage-stats">' + stage.steps.length + ' steps Â· ' + formatTime(stageTime) + ' Â· ' + formatCurrency(stageCost) + '</div></div>';
            
            html += '<table><thead><tr><th style="width:50px">#</th><th>Step</th><th style="width:70px">Time</th><th style="width:80px">Cost</th>';
            if (reportType === 'detailed') {
              html += '<th>Pain Points</th><th>Reg Requirements</th>';
            } else {
              html += '<th style="width:90px">Improvement</th>';
            }
            html += '</tr></thead><tbody>';
            
            stage.steps.forEach((step, sti) => {
              const stepCost = calculateStepCost(step, config.personas);
              const owner = config.personas.find(p => p.id === step.owner);
              html += '<tr><td>' + (si+1) + '.' + (sti+1) + '</td>';
              html += '<td><div class="step-name">' + step.name + '</div><div class="step-desc">' + (owner?.label || '') + (step.clientTouchpoint ? ' Â· ðŸ‘¤ Client' : '') + '</div></td>';
              html += '<td class="time">' + formatTime(step.timeMinutes) + '</td>';
              html += '<td class="cost">' + formatCurrency(stepCost) + '</td>';
              
              if (reportType === 'detailed') {
                html += '<td>' + (step.painPoints.length > 0 ? step.painPoints.map(pp => '<div class="pain-point">âš  ' + pp + '</div>').join('') : 'â€”') + '</td>';
                html += '<td>' + ((step.regulatoryRequirements || []).length > 0 ? step.regulatoryRequirements.map(rr => '<div class="reg-req">ðŸ“‹ ' + rr + '</div>').join('') : 'â€”') + '</td>';
              } else {
                const autoClass = step.automationOpportunity === 'high' ? 'auto-high' : step.automationOpportunity === 'medium' ? 'auto-medium' : step.automationOpportunity === 'low' ? 'auto-low' : '';
                html += '<td><span class="' + autoClass + '">' + (step.automationOpportunity || 'none') + '</span></td>';
              }
              html += '</tr>';
            });
            
            html += '</tbody></table></div>';
          });
        }

        if (reportType === 'cost-analysis') {
          // Cost by role
          html += '<h2>Cost by Role</h2>';
          roleCosts.forEach(role => {
            html += '<div class="role-bar" style="border-color:' + role.color + '">';
            html += '<div style="min-width:140px;font-weight:600;color:' + role.color + '">' + role.label + '</div>';
            html += '<div style="flex:1;display:flex;gap:24px">';
            html += '<div style="text-align:center"><div style="font-size:14pt;font-weight:600;color:' + role.color + '">' + formatCurrency(role.totalCost) + '</div><div style="font-size:8pt;color:#666">COST</div></div>';
            html += '<div style="text-align:center"><div style="font-size:14pt;font-weight:600">' + formatTime(role.totalTime) + '</div><div style="font-size:8pt;color:#666">TIME</div></div>';
            html += '<div style="text-align:center"><div style="font-size:14pt;font-weight:600">' + Math.round((role.totalCost / totalCost) * 100) + '%</div><div style="font-size:8pt;color:#666">OF TOTAL</div></div>';
            html += '</div></div>';
          });

          // Top improvement opportunities
          html += '<h2>Top Improvement Opportunities</h2>';
          const opportunities = allSteps
            .filter(s => s.automationOpportunity === 'high' || s.automationOpportunity === 'medium')
            .map(step => {
              const stepCost = calculateStepCost(step, config.personas);
              const savings = step.automationOpportunity === 'high' ? stepCost * 0.7 : stepCost * 0.4;
              return { ...step, savings, stepCost };
            })
            .sort((a, b) => b.savings - a.savings)
            .slice(0, 8);
          
          opportunities.forEach(step => {
            html += '<div class="opp-card"><div><div style="font-weight:500">' + step.name + '</div>';
            html += '<div style="font-size:9pt;color:#666">' + step.stageName + ' Â· ' + formatTime(step.timeMinutes) + ' Â· Current: ' + formatCurrency(step.stepCost) + '</div></div>';
            html += '<div style="text-align:right"><div style="font-size:14pt;font-weight:700;color:#065F46">Save ' + formatCurrency(step.savings) + '</div>';
            html += '<div style="font-size:9pt;color:#065F46">' + step.automationOpportunity + ' potential</div></div></div>';
          });

          // Most expensive steps
          html += '<h2>Most Expensive Steps</h2>';
          html += '<table><thead><tr><th>Rank</th><th>Step</th><th>Stage</th><th>Time</th><th>Cost</th></tr></thead><tbody>';
          allSteps
            .map(step => ({ ...step, stepCost: calculateStepCost(step, config.personas) }))
            .sort((a, b) => b.stepCost - a.stepCost)
            .slice(0, 10)
            .forEach((step, i) => {
              html += '<tr><td style="font-weight:600;color:' + (i < 3 ? '#B42318' : '#666') + '">#' + (i+1) + '</td>';
              html += '<td class="step-name">' + step.name + '</td>';
              html += '<td style="color:#666">' + step.stageName + '</td>';
              html += '<td>' + formatTime(step.timeMinutes) + '</td>';
              html += '<td class="cost">' + formatCurrency(step.stepCost) + '</td></tr>';
            });
          html += '</tbody></table>';
        }

        // Footer
        html += '<div class="footer"><span>' + config.meta.product + ' Â· v' + config.meta.version + '</span>';
        html += '<span>Generated ' + new Date().toLocaleDateString('en-GB') + ' at ' + new Date().toLocaleTimeString('en-GB') + '</span></div>';
        
        html += '</body></html>';
        
        printWindow.document.write(html);
        printWindow.document.close();
      };

      // Calculate summary stats
      // Calculate summary stats
      const stats = useMemo(() => {
        const allSteps = config.stages.flatMap(s => s.steps);
        const totalPainPoints = allSteps.reduce((acc, s) => acc + s.painPoints.length, 0);
        const avgFriction = allSteps.length ? (allSteps.reduce((acc, s) => acc + (s.frictionScore || 3), 0) / allSteps.length).toFixed(1) : 0;
        const highAutomation = allSteps.filter(s => s.automationOpportunity === 'high').length;
        const totalRegReqs = allSteps.reduce((acc, s) => acc + (s.regulatoryRequirements?.length || 0), 0);
        const totalCost = allSteps.reduce((acc, s) => acc + calculateStepCost(s, config.personas), 0);
        return { totalPainPoints, avgFriction, highAutomation, totalRegReqs, totalSteps: allSteps.length, totalCost };
      }, [config.stages, config.personas]);

      // Funnel metrics calculation
      const funnelMetrics = useMemo(() => calculateFunnelMetrics(config), [config]);

      // Update funnel settings handler
      const updateFunnelSettings = useCallback((updates) => {
        setConfig(prev => ({
          ...prev,
          funnel: updates.funnel,
          stages: updates.stages
        }));
      }, []);

      // App unlock handler
      const handleAppUnlock = (e) => {
        e.preventDefault();
        if (passwords && appPasswordInput === passwords.app) {
          sessionStorage.setItem('journeymap-app-unlocked', 'true');
          setIsAppUnlocked(true);
          setAppPasswordError(false);
        } else {
          setAppPasswordError(true);
        }
      };

      // Loading screen while fetching passwords or config
      if (passwordsLoading || configLoading) {
        return (
          <div style={{
            minHeight: '100vh',
            display: 'flex',
            alignItems: 'center',
            justifyContent: 'center',
            background: 'linear-gradient(135deg, #1A1A1A 0%, #2D2D2D 100%)',
            fontFamily: "'Georgia', 'Times New Roman', serif"
          }}>
            <div style={{ textAlign: 'center', color: '#FFF' }}>
              <div style={{ fontSize: '24px', marginBottom: '16px' }}>Loading...</div>
              <div style={{ fontSize: '14px', opacity: 0.7, fontFamily: "'Helvetica Neue', Arial, sans-serif" }}>
                {configLoading ? 'Loading latest journey map...' : 'Initializing...'}
              </div>
            </div>
          </div>
        );
      }

      // Error screen if passwords failed to load
      if (passwordsError) {
        return (
          <div style={{
            minHeight: '100vh',
            display: 'flex',
            alignItems: 'center',
            justifyContent: 'center',
            background: 'linear-gradient(135deg, #1A1A1A 0%, #2D2D2D 100%)',
            fontFamily: "'Georgia', 'Times New Roman', serif"
          }}>
            <div style={{
              background: '#FFF',
              borderRadius: '16px',
              padding: '48px',
              boxShadow: '0 20px 60px rgba(0,0,0,0.3)',
              maxWidth: '400px',
              width: '90%',
              textAlign: 'center'
            }}>
              <div style={{ fontSize: '48px', marginBottom: '16px' }}>âš ï¸</div>
              <h1 style={{ margin: '0 0 8px', fontSize: '20px', fontWeight: 600, color: '#DC2626' }}>
                Configuration Error
              </h1>
              <p style={{ margin: '0 0 24px', fontSize: '14px', color: '#666', fontFamily: "'Helvetica Neue', Arial, sans-serif" }}>
                Could not load application configuration.<br/>
                Please contact the administrator.
              </p>
              <button
                onClick={() => window.location.reload()}
                style={{
                  padding: '12px 24px',
                  fontSize: '14px',
                  color: '#FFF',
                  background: '#1A1A1A',
                  border: 'none',
                  borderRadius: '8px',
                  cursor: 'pointer',
                  fontFamily: "'Helvetica Neue', Arial, sans-serif"
                }}
              >
                Retry
              </button>
            </div>
          </div>
        );
      }

      // Login screen
      if (!isAppUnlocked) {
        return (
          <div style={{
            minHeight: '100vh',
            display: 'flex',
            alignItems: 'center',
            justifyContent: 'center',
            background: 'linear-gradient(135deg, #1A1A1A 0%, #2D2D2D 100%)',
            fontFamily: "'Georgia', 'Times New Roman', serif"
          }}>
            <div style={{
              background: '#FFF',
              borderRadius: '16px',
              padding: '48px',
              boxShadow: '0 20px 60px rgba(0,0,0,0.3)',
              maxWidth: '400px',
              width: '90%',
              textAlign: 'center'
            }}>
              <h1 style={{ 
                margin: '0 0 8px', 
                fontSize: '24px', 
                fontWeight: 400,
                color: '#1A1A1A'
              }}>
                Steve's Journey Map
              </h1>
              <p style={{ 
                margin: '0 0 32px', 
                fontSize: '14px', 
                color: '#666',
                fontFamily: "'Helvetica Neue', Arial, sans-serif"
              }}>
                Enter password to continue
              </p>
              
              <form onSubmit={handleAppUnlock}>
                <input
                  type="password"
                  value={appPasswordInput}
                  onChange={(e) => { setAppPasswordInput(e.target.value); setAppPasswordError(false); }}
                  placeholder="Password"
                  autoFocus
                  style={{
                    width: '100%',
                    padding: '14px 16px',
                    fontSize: '16px',
                    border: appPasswordError ? '2px solid #DC2626' : '1px solid #DDD',
                    borderRadius: '8px',
                    marginBottom: '16px',
                    fontFamily: "'Helvetica Neue', Arial, sans-serif",
                    boxSizing: 'border-box',
                    outline: 'none'
                  }}
                />
                {appPasswordError && (
                  <p style={{ 
                    margin: '-8px 0 16px', 
                    fontSize: '13px', 
                    color: '#DC2626',
                    fontFamily: "'Helvetica Neue', Arial, sans-serif"
                  }}>
                    Incorrect password
                  </p>
                )}
                <button
                  type="submit"
                  style={{
                    width: '100%',
                    padding: '14px 24px',
                    fontSize: '14px',
                    fontWeight: 600,
                    color: '#FFF',
                    background: '#1A1A1A',
                    border: 'none',
                    borderRadius: '8px',
                    cursor: 'pointer',
                    fontFamily: "'Helvetica Neue', Arial, sans-serif"
                  }}
                >
                  Enter
                </button>
              </form>
            </div>
          </div>
        );
      }

      return (
        <div style={{
          height: isMobile ? 'auto' : '100vh',
          minHeight: isMobile ? '100vh' : 'auto',
          display: 'flex',
          flexDirection: 'column',
          background: 'linear-gradient(135deg, #FAFAFA 0%, #F0F0F0 100%)',
          fontFamily: "'Georgia', 'Times New Roman', serif",
          color: '#1A1A1A',
          overflow: isMobile ? 'auto' : 'hidden'
        }}>
          {/* Header */}
          <header className="header-container" style={{
            background: '#1A1A1A',
            color: '#FAFAFA',
            padding: '16px 24px',
            display: 'flex',
            flexDirection: 'column',
            gap: '12px',
            flexShrink: 0
          }}>
            {/* Row 1: Logo + Title/Stats (left) | Export/Settings (right) */}
            <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', gap: '20px' }}>
              {/* Left side: Back Button (multi-user mode) + Logo + Divider + Title/Stats */}
              <div className="header-logo-title" style={{ display: 'flex', alignItems: 'center', gap: '20px', flex: 1, minWidth: 0 }}>
                {/* Back to Dashboard Button - only in multi-user mode */}
                {isMultiUserMode && (
                  <button
                    onClick={() => window.location.href = 'index.html'}
                    style={{
                      background: 'rgba(255,255,255,0.1)',
                      border: '1px solid rgba(255,255,255,0.3)',
                      borderRadius: '6px',
                      padding: '8px 14px',
                      color: '#FFF',
                      cursor: 'pointer',
                      fontFamily: "'Helvetica Neue', Arial, sans-serif",
                      fontSize: '13px',
                      display: 'flex',
                      alignItems: 'center',
                      gap: '6px',
                      flexShrink: 0,
                      transition: 'all 0.15s'
                    }}
                    onMouseOver={(e) => { e.currentTarget.style.background = 'rgba(255,255,255,0.2)'; }}
                    onMouseOut={(e) => { e.currentTarget.style.background = 'rgba(255,255,255,0.1)'; }}
                  >
                    â† Dashboard
                  </button>
                )}
                
                {/* Evelyn Partners Logo */}
                <svg className="header-logo" width="110" height="40" viewBox="0 0 173.61 65.85" fill="none" xmlns="http://www.w3.org/2000/svg" style={{ flexShrink: 0 }}>
                  <g clipPath="url(#clip0_logo)">
                    <path d="M69.2642 56.0118V54.4309H61.6699V65.723H69.4058V64.1421H63.4496V60.6973H68.4753V59.2007H63.4496V56.0118H69.2642Z" fill="#C69D64"/>
                    <path d="M49.6732 57.7613L56.054 65.723H57.5475V54.4309H55.7408V62.5612L49.2787 54.4309H47.8936V65.723H49.6732V57.7613Z" fill="#C69D64"/>
                    <path d="M40.9768 65.723V56.0118H44.7318V54.4309H35.415V56.0118H39.2001V65.723H40.9768Z" fill="#C69D64"/>
                    <path d="M32.8192 58.1016C32.8192 56.072 31.3347 54.4309 29.3171 54.4309H24.4028V65.723H26.1855V61.8084H28.8083L31.2383 65.723H33.2408L30.5879 61.432C31.9158 60.9773 32.8192 59.541 32.8192 58.1016ZM29.29 60.2094H26.1855V55.9937H29.1967C30.2235 55.9937 30.9733 56.9543 30.9733 58.0835C30.9733 59.2127 30.3681 60.2185 29.29 60.2185V60.2094Z" fill="#C69D64"/>
                    <path d="M81.3783 58.1016C81.3783 56.072 79.8938 54.4309 77.8762 54.4309H72.9619V65.723H74.7325V61.8084H77.3553L79.7854 65.723H81.7878L79.1349 61.432C80.4749 60.9773 81.3783 59.541 81.3783 58.1016ZM77.8491 60.2094H74.7325V55.9937H77.7437C78.7706 55.9937 79.5204 56.9543 79.5204 58.0835C79.5204 59.2127 78.9272 60.2185 77.8491 60.2185V60.2094Z" fill="#C69D64"/>
                    <path d="M10.9971 65.723H12.8881L14.0745 62.6485H18.4228L19.6272 65.723H21.4882L17.0286 54.4309H15.4748L10.9971 65.723ZM18.0825 61.3206H14.3847L16.2757 56.4605L18.0825 61.3206Z" fill="#C69D64"/>
                    <path d="M1.48438 54.4309V65.723H3.261V61.8084H6.31137C8.38309 61.8084 9.7261 60.0017 9.7261 58.1106C9.7261 56.1624 8.24156 54.4399 6.22705 54.4399L1.48438 54.4309ZM7.91936 58.1016C7.91936 59.2037 7.31712 60.2094 6.19694 60.2094H3.261V55.9937H6.11263C7.22076 56.0118 7.91936 56.9724 7.91936 58.1016Z" fill="#C69D64"/>
                    <path d="M84.6697 57.7914C84.6697 59.8149 86.4764 60.369 88.1537 60.8357C89.6774 61.2543 91.1348 61.5674 91.1348 62.787C91.1348 63.8319 90.1471 64.2294 88.9306 64.2294C87.5484 64.2294 85.8561 63.5217 85.1214 62.787L84.2451 64.3137C85.5919 65.3126 87.2267 65.8474 88.9035 65.8374C91.6979 65.8374 93.0258 64.4462 93.0258 62.5912C93.0258 60.4834 91.469 59.9173 89.6894 59.4174C88.1025 58.9687 86.5336 58.7369 86.5336 57.5083C86.5336 56.3791 87.437 55.9274 88.7349 55.9274C89.8068 55.9274 91.1619 56.4634 91.7822 57.0867L92.5742 55.6173C91.473 54.8023 90.1409 54.3593 88.771 54.3525C86.4554 54.3525 84.6697 55.5902 84.6697 57.7914Z" fill="#C69D64"/>
                    <path d="M94.0043 6.88667V37.0622C94.0043 40.9767 93.7032 42.2926 90.978 43.7712V44.274H105.57V44.274H105.57V43.7712C102.842 42.2926 102.544 40.9647 102.544 37.0622V0H90.7251V0.502874C93.5135 1.80372 94.0043 3.16179 94.0043 6.88667Z" fill="#FFFFFF"/>
                    <path d="M14.9447 44.8643C21.5875 44.8643 26.3091 41.2267 28.1128 34.9935L27.372 34.8158C25.5924 38.9533 22.3945 40.8383 18.6214 40.8383C12.5719 40.8383 8.65727 35.9932 8.65727 28.5706H28.2302C28.2302 20.5667 24.0145 14.5955 14.8875 14.5955C6.82042 14.5955 0 20.6179 0 29.7871C0 39.3688 6.7602 44.8643 14.9447 44.8643ZM14.8273 15.7247C19.0972 15.7247 19.8078 20.8678 19.8078 27.1673H8.71749C8.95538 20.2746 11.3282 15.7247 14.8273 15.7247Z" fill="#FFFFFF"/>
                    <path d="M74.9677 44.8643C81.6104 44.8643 86.332 41.2267 88.1358 34.9935L87.395 34.8158C85.6154 38.9533 82.4204 40.8383 78.6474 40.8383C72.5948 40.8383 68.6802 35.9932 68.6802 28.5706H88.2532C88.2532 20.5667 84.0375 14.5955 74.9104 14.5955C66.8434 14.5955 60.0229 20.6179 60.0229 29.7871C60.0229 39.3688 66.7832 44.8643 74.9677 44.8643ZM74.8502 15.7247C79.1201 15.7247 79.8338 20.8678 79.8338 27.1673H68.7404C68.9783 20.2746 71.3512 15.7247 74.8502 15.7247Z" fill="#FFFFFF"/>
                    <path d="M61.0735 15.2068H52.2506V15.7097C55.2257 16.8208 55.6713 18.9738 54.1507 22.0061L48.1011 34.7135L38.8687 15.2068H28.4077V15.7097C30.6752 16.9413 30.9582 17.8175 32.8583 21.5906L44.4094 44.8794H44.9213L56.12 21.7682C57.9599 17.9861 59.1613 16.7817 61.0855 15.7097L61.0735 15.2068Z" fill="#FFFFFF"/>
                    <path d="M170.544 37.062V24.8877C170.544 18.7387 167.283 14.6013 161.233 14.6013C156.192 14.6013 152.395 17.3506 150.853 22.7316V15.2066H139.627V15.8088C141.799 16.4924 142.313 18.1576 142.313 21.7409V37.05C142.313 40.9646 142.012 42.2805 139.302 43.759V44.2619H153.892V43.759C151.163 42.2805 150.88 40.9525 150.88 37.05V28.3174C150.88 22.4636 153.491 18.8291 157.168 18.8291C160.667 18.8291 162.031 21.5392 162.031 24.8515V32.6988V44.2378H173.597V43.7349C170.842 42.3076 170.544 40.9646 170.544 37.062Z" fill="#FFFFFF"/>
                    <path d="M129.772 15.2068V15.7097C132.744 16.8208 132.97 18.7871 131.669 22.0061L126.035 35.659L116.429 15.2068H105.929V15.7097C108.193 16.9413 108.479 17.8175 110.377 21.5906L122.075 45.0781C118.501 53.1181 115.396 59.9446 112.49 61.8266C111.96 59.0653 110.383 57.3097 108.127 57.3097C107.598 57.3101 107.074 57.4153 106.586 57.6191C106.098 57.823 105.655 58.1215 105.282 58.4974C104.91 58.8734 104.616 59.3194 104.417 59.8096C104.218 60.2999 104.117 60.8247 104.122 61.3538C104.122 64.0368 106.125 65.8255 108.976 65.8255C113.894 65.8255 117.489 59.3544 123.731 44.8342L133.635 21.7411C133.711 21.5635 133.861 21.2774 133.861 21.2774C135.514 17.8928 136.237 16.6221 138.107 15.791V15.1887L129.772 15.2068Z" fill="#FFFFFF"/>
                  </g>
                  <defs>
                    <clipPath id="clip0_logo">
                      <rect width="173.57" height="65.8374" fill="white"/>
                    </clipPath>
                  </defs>
                </svg>
                
                {/* Vertical Divider - desktop only */}
                <div className="header-divider" style={{ width: '1px', height: '40px', background: 'rgba(255,255,255,0.3)', flexShrink: 0 }} />
                
                {/* Title and Stats */}
                <div style={{ minWidth: 0 }}>
                  <h1 style={{ margin: 0, fontSize: '20px', fontWeight: 400, letterSpacing: '-0.5px', whiteSpace: 'nowrap', overflow: 'hidden', textOverflow: 'ellipsis' }}>
                    {editMode ? (
                      <input 
                        type="text" 
                        value={config.meta.title} 
                        onChange={(e) => setConfig(prev => ({ ...prev, meta: { ...prev.meta, title: e.target.value } }))}
                        style={{ 
                          background: 'rgba(255,255,255,0.1)', 
                          border: '1px solid rgba(255,255,255,0.3)', 
                          borderRadius: '4px', 
                          padding: '4px 8px', 
                          fontSize: '20px', 
                          fontWeight: 400, 
                          letterSpacing: '-0.5px', 
                          color: '#FAFAFA', 
                          fontFamily: 'Georgia, serif', 
                          width: `${Math.max(200, Math.min(500, config.meta.title.length * 12 + 20))}px`
                        }}
                      />
                    ) : config.meta.title}
                  </h1>
                  <p style={{ margin: '2px 0 0', opacity: 0.6, fontSize: '11px', fontFamily: "'Helvetica Neue', Arial, sans-serif", whiteSpace: 'nowrap' }}>
                    {formatTime(totalTime)} Â· {config.stages.length} stages Â· {stats.totalSteps} steps Â· {stats.totalPainPoints} pain points
                  </p>
                </div>
              </div>
              
              {/* Desktop Menu - between title and export */}
              {!isMobile && !editMode && (
                <>
                  <div className="header-divider" style={{ width: '1px', height: '40px', background: 'rgba(255,255,255,0.3)', flexShrink: 0 }} />
                  <div className="no-print" style={{ display: 'flex', gap: '6px', alignItems: 'center', flexShrink: 0 }}>
                    
                    {/* GROUP 1: View Mode */}
                    <div style={{ display: 'flex', borderRadius: '5px', overflow: 'hidden', border: '1px solid rgba(255,255,255,0.35)' }}>
                      <button onClick={() => { setViewMode('stages'); }} style={{ padding: '7px 12px', background: viewMode === 'stages' ? '#4A5568' : 'transparent', color: '#FAFAFA', border: 'none', cursor: 'pointer', fontFamily: "'Helvetica Neue', Arial, sans-serif", fontSize: '11px', display: 'flex', alignItems: 'center', gap: '5px' }}>
                        ðŸ“ Stages
                      </button>
                      <button onClick={() => setViewMode('steps')} style={{ padding: '7px 12px', background: viewMode === 'steps' ? '#4A5568' : 'transparent', color: '#FAFAFA', border: 'none', borderLeft: '1px solid rgba(255,255,255,0.25)', cursor: 'pointer', fontFamily: "'Helvetica Neue', Arial, sans-serif", fontSize: '11px', display: 'flex', alignItems: 'center', gap: '5px' }}>
                        ðŸ“‹ Steps
                      </button>
                    </div>
                    
                    {/* GROUP 2: View Layers (what info shows on cards) */}
                    {(showCosts || config.funnel?.enabled) && (
                      <>
                        <div style={{ width: '1px', height: '24px', background: 'rgba(255,255,255,0.2)', margin: '0 4px' }} />
                        <span style={{ fontSize: '10px', color: 'rgba(255,255,255,0.5)', fontFamily: "'Helvetica Neue', Arial, sans-serif", textTransform: 'uppercase', letterSpacing: '0.5px' }}>Show</span>
                        <div style={{ display: 'flex', borderRadius: '5px', overflow: 'hidden', border: '1px solid rgba(255,255,255,0.35)' }}>
                          {showCosts && (
                            <button 
                              onClick={() => { 
                                if (highlightOpportunities) {
                                  setHighlightOpportunities(false);
                                } else {
                                  setHighlightOpportunities(true);
                                  setShowFunnel(false);
                                }
                              }} 
                              style={{ 
                                padding: '7px 12px', 
                                background: highlightOpportunities ? '#059669' : 'transparent', 
                                color: '#FAFAFA', 
                                border: 'none', 
                                cursor: 'pointer', 
                                fontFamily: "'Helvetica Neue', Arial, sans-serif", 
                                fontSize: '11px',
                                display: 'flex',
                                alignItems: 'center',
                                gap: '5px',
                                borderRight: config.funnel?.enabled ? '1px solid rgba(255,255,255,0.25)' : 'none'
                              }}
                            >
                              ðŸŽ¯ Opportunities
                            </button>
                          )}
                          {config.funnel?.enabled && (
                            <button 
                              onClick={() => { 
                                if (showFunnel) {
                                  setShowFunnel(false);
                                } else {
                                  setShowFunnel(true);
                                  setHighlightOpportunities(false);
                                }
                              }} 
                              style={{ 
                                padding: '7px 12px', 
                                background: showFunnel ? '#6366F1' : 'transparent', 
                                color: '#FAFAFA', 
                                border: 'none', 
                                cursor: 'pointer', 
                                fontFamily: "'Helvetica Neue', Arial, sans-serif", 
                                fontSize: '11px',
                                display: 'flex',
                                alignItems: 'center',
                                gap: '5px'
                              }}
                            >
                              ðŸ”» Funnel
                            </button>
                          )}
                        </div>
                      </>
                    )}
                    
                    {/* GROUP 3: Dashboards (open modal overlays) */}
                    <div style={{ width: '1px', height: '24px', background: 'rgba(255,255,255,0.2)', margin: '0 4px' }} />
                    <span style={{ fontSize: '10px', color: 'rgba(255,255,255,0.5)', fontFamily: "'Helvetica Neue', Arial, sans-serif", textTransform: 'uppercase', letterSpacing: '0.5px' }}>Analyse</span>
                    <div style={{ display: 'flex', borderRadius: '5px', overflow: 'hidden', border: '1px solid rgba(255,255,255,0.35)' }}>
                      <button onClick={() => setShowTimeline(!showTimeline)} style={{ padding: '7px 12px', background: showTimeline ? '#4A5568' : 'transparent', color: '#FAFAFA', border: 'none', cursor: 'pointer', fontFamily: "'Helvetica Neue', Arial, sans-serif", fontSize: '11px', display: 'flex', alignItems: 'center', gap: '5px', borderRight: '1px solid rgba(255,255,255,0.25)' }}>
                        ðŸ“… Timeline
                      </button>
                      {showCosts && (
                        <button onClick={() => setShowCostAnalysis(!showCostAnalysis)} style={{ padding: '7px 12px', background: showCostAnalysis ? '#4A5568' : 'transparent', color: '#FAFAFA', border: 'none', cursor: 'pointer', fontFamily: "'Helvetica Neue', Arial, sans-serif", fontSize: '11px', display: 'flex', alignItems: 'center', gap: '5px', borderRight: config.funnel?.enabled ? '1px solid rgba(255,255,255,0.25)' : 'none' }}>
                          ðŸ’° Costs
                        </button>
                      )}
                      {config.funnel?.enabled && (
                        <button 
                          onClick={() => setShowFunnelDashboard(true)} 
                          style={{ 
                            padding: '7px 12px', 
                            background: 'transparent', 
                            color: '#FAFAFA', 
                            border: 'none', 
                            cursor: 'pointer', 
                            fontFamily: "'Helvetica Neue', Arial, sans-serif", 
                            fontSize: '11px',
                            display: 'flex',
                            alignItems: 'center',
                            gap: '5px'
                          }}
                        >
                          ðŸ”» Funnel
                        </button>
                      )}
                    </div>
                    
                  </div>
                </>
              )}
              
              {/* Right side: Export & Settings */}
              <div className="no-print" style={{ display: 'flex', gap: '6px', alignItems: 'center', flexShrink: 0 }}>
                {editMode ? (
                  <>
                    <span style={{ fontFamily: "'Helvetica Neue', Arial, sans-serif", fontSize: '11px', color: '#FAFAFA', opacity: 0.7, marginRight: '4px' }}>âœï¸ Editing</span>
                    <button onClick={cancelEdit} style={{ padding: '6px 12px', background: 'transparent', color: '#FAFAFA', border: '1px solid rgba(255,255,255,0.4)', borderRadius: '4px', cursor: 'pointer', fontFamily: "'Helvetica Neue', Arial, sans-serif", fontSize: '11px' }}>
                      Cancel
                    </button>
                    <button onClick={saveEdit} style={{ padding: '6px 12px', background: '#2D5A4B', color: '#FAFAFA', border: 'none', borderRadius: '4px', cursor: 'pointer', fontFamily: "'Helvetica Neue', Arial, sans-serif", fontSize: '11px', fontWeight: 500, display: 'flex', alignItems: 'center', gap: '4px' }}>
                      ðŸ’¾ Save {gitHubConfig.token && <span style={{ opacity: 0.7 }}>â†’ ðŸ™</span>}
                    </button>
                  </>
                ) : (
                  <>
                    {/* Export Dropdown */}
                    <div style={{ position: 'relative' }}>
                      <button onClick={(e) => { e.stopPropagation(); setShowExportMenu(!showExportMenu); setShowSettingsMenu(false); }} style={{ padding: '6px 10px', background: showExportMenu ? '#4A5568' : 'transparent', color: '#FAFAFA', border: '1px solid rgba(255,255,255,0.4)', borderRadius: '4px', cursor: 'pointer', fontFamily: "'Helvetica Neue', Arial, sans-serif", fontSize: '11px', display: 'flex', alignItems: 'center', gap: '4px' }}>
                        ðŸ“¤ <span style={{ fontSize: '8px' }}>â–¼</span>
                      </button>
                      {showExportMenu && (
                        <div onClick={(e) => e.stopPropagation()} style={{ position: 'absolute', top: '100%', right: 0, marginTop: '4px', background: '#FFF', borderRadius: '8px', boxShadow: '0 4px 20px rgba(0,0,0,0.2)', overflow: 'hidden', zIndex: 100, minWidth: '180px' }}>
                          <button onClick={() => { generatePDF('summary'); setShowExportMenu(false); }} style={{ display: 'flex', alignItems: 'center', gap: '10px', width: '100%', padding: '10px 14px', border: 'none', background: '#FFF', cursor: 'pointer', textAlign: 'left', fontFamily: "'Helvetica Neue', Arial, sans-serif", fontSize: '13px', color: '#333', borderBottom: '1px solid #EEE' }} onMouseOver={(e) => e.currentTarget.style.background = '#F5F5F5'} onMouseOut={(e) => e.currentTarget.style.background = '#FFF'}>
                            <span>ðŸ“‹</span> Summary Report
                          </button>
                          <button onClick={() => { generatePDF('detailed'); setShowExportMenu(false); }} style={{ display: 'flex', alignItems: 'center', gap: '10px', width: '100%', padding: '10px 14px', border: 'none', background: '#FFF', cursor: 'pointer', textAlign: 'left', fontFamily: "'Helvetica Neue', Arial, sans-serif", fontSize: '13px', color: '#333', borderBottom: showCosts ? '1px solid #EEE' : 'none' }} onMouseOver={(e) => e.currentTarget.style.background = '#F5F5F5'} onMouseOut={(e) => e.currentTarget.style.background = '#FFF'}>
                            <span>ðŸ“„</span> Detailed Report
                          </button>
                          {showCosts && (
                            <button onClick={() => { generatePDF('cost-analysis'); setShowExportMenu(false); }} style={{ display: 'flex', alignItems: 'center', gap: '10px', width: '100%', padding: '10px 14px', border: 'none', background: '#FFF', cursor: 'pointer', textAlign: 'left', fontFamily: "'Helvetica Neue', Arial, sans-serif", fontSize: '13px', color: '#333' }} onMouseOver={(e) => e.currentTarget.style.background = '#F5F5F5'} onMouseOut={(e) => e.currentTarget.style.background = '#FFF'}>
                              <span>ðŸ’°</span> Cost Analysis
                            </button>
                          )}
                        </div>
                      )}
                    </div>

                    {/* Settings Dropdown */}
                    <div style={{ position: 'relative' }}>
                      <button onClick={(e) => { 
                        e.stopPropagation(); 
                        if (isSettingsUnlocked) {
                          setShowSettingsMenu(!showSettingsMenu); 
                          setShowExportMenu(false);
                        } else {
                          setShowPasswordPrompt(true);
                        }
                      }} style={{ padding: '6px 10px', background: showSettingsMenu ? '#4A5568' : 'transparent', color: '#FAFAFA', border: '1px solid rgba(255,255,255,0.4)', borderRadius: '4px', cursor: 'pointer', fontFamily: "'Helvetica Neue', Arial, sans-serif", fontSize: '11px', display: 'flex', alignItems: 'center', gap: '4px' }}>
                        {isSettingsUnlocked ? 'âš™ï¸' : 'ðŸ”’'} <span style={{ fontSize: '8px' }}>â–¼</span>
                      </button>
                      {showSettingsMenu && isSettingsUnlocked && (
                        <div onClick={(e) => e.stopPropagation()} style={{ position: 'absolute', top: '100%', right: 0, marginTop: '4px', background: '#FFF', borderRadius: '8px', boxShadow: '0 4px 20px rgba(0,0,0,0.2)', overflow: 'hidden', zIndex: 100, minWidth: '180px' }}>
                          <button onClick={enterEditMode} style={{ display: 'flex', alignItems: 'center', gap: '10px', width: '100%', padding: '10px 14px', border: 'none', background: '#FFF', cursor: 'pointer', textAlign: 'left', fontFamily: "'Helvetica Neue', Arial, sans-serif", fontSize: '13px', color: '#333', borderBottom: '1px solid #EEE' }} onMouseOver={(e) => e.currentTarget.style.background = '#F5F5F5'} onMouseOut={(e) => e.currentTarget.style.background = '#FFF'}>
                            <span>âœï¸</span> Edit Mode
                          </button>
                          <button onClick={() => { setShowSalarySettings(true); setShowSettingsMenu(false); }} style={{ display: 'flex', alignItems: 'center', gap: '10px', width: '100%', padding: '10px 14px', border: 'none', background: '#FFF', cursor: 'pointer', textAlign: 'left', fontFamily: "'Helvetica Neue', Arial, sans-serif", fontSize: '13px', color: '#333', borderBottom: '1px solid #EEE' }} onMouseOver={(e) => e.currentTarget.style.background = '#F5F5F5'} onMouseOut={(e) => e.currentTarget.style.background = '#FFF'}>
                            <span>ðŸ‘¥</span> Manage Roles
                          </button>
                          <button onClick={() => { setShowStructurePanel(true); setShowSettingsMenu(false); }} style={{ display: 'flex', alignItems: 'center', gap: '10px', width: '100%', padding: '10px 14px', border: 'none', background: '#FFF', cursor: 'pointer', textAlign: 'left', fontFamily: "'Helvetica Neue', Arial, sans-serif", fontSize: '13px', color: '#333', borderBottom: '1px solid #EEE' }} onMouseOver={(e) => e.currentTarget.style.background = '#F5F5F5'} onMouseOut={(e) => e.currentTarget.style.background = '#FFF'}>
                            <span>ðŸ—ï¸</span> Configure Structure
                          </button>
                          <button onClick={() => { setShowFunnelSettings(true); setShowSettingsMenu(false); }} style={{ display: 'flex', alignItems: 'center', gap: '10px', width: '100%', padding: '10px 14px', border: 'none', background: '#FFF', cursor: 'pointer', textAlign: 'left', fontFamily: "'Helvetica Neue', Arial, sans-serif", fontSize: '13px', color: '#333', borderBottom: '1px solid #EEE' }} onMouseOver={(e) => e.currentTarget.style.background = '#F5F5F5'} onMouseOut={(e) => e.currentTarget.style.background = '#FFF'}>
                            <span>ðŸ”»</span> Funnel Settings
                          </button>
                          <div style={{ height: '1px', background: '#EEE', margin: '4px 0' }}></div>
                          <button onClick={() => { setShowGitHubSettings(true); setShowSettingsMenu(false); }} style={{ display: 'flex', alignItems: 'center', gap: '10px', width: '100%', padding: '10px 14px', border: 'none', background: '#FFF', cursor: 'pointer', textAlign: 'left', fontFamily: "'Helvetica Neue', Arial, sans-serif", fontSize: '13px', color: '#333', borderBottom: '1px solid #EEE' }} onMouseOver={(e) => e.currentTarget.style.background = '#F5F5F5'} onMouseOut={(e) => e.currentTarget.style.background = '#FFF'}>
                            <span>ðŸ™</span> GitHub Settings
                          </button>
                          <button onClick={() => { saveToGitHub(); setShowSettingsMenu(false); }} disabled={!gitHubConfig.token} style={{ display: 'flex', alignItems: 'center', gap: '10px', width: '100%', padding: '10px 14px', border: 'none', background: '#FFF', cursor: gitHubConfig.token ? 'pointer' : 'not-allowed', textAlign: 'left', fontFamily: "'Helvetica Neue', Arial, sans-serif", fontSize: '13px', color: gitHubConfig.token ? '#333' : '#AAA', borderBottom: '1px solid #EEE' }} onMouseOver={(e) => gitHubConfig.token && (e.currentTarget.style.background = '#F5F5F5')} onMouseOut={(e) => e.currentTarget.style.background = '#FFF'}>
                            <span style={{ opacity: gitHubConfig.token ? 1 : 0.5 }}>ðŸ“¤</span> Save to GitHub
                          </button>
                          <button onClick={() => { loadFromGitHub(); setShowSettingsMenu(false); }} disabled={!gitHubConfig.token} style={{ display: 'flex', alignItems: 'center', gap: '10px', width: '100%', padding: '10px 14px', border: 'none', background: '#FFF', cursor: gitHubConfig.token ? 'pointer' : 'not-allowed', textAlign: 'left', fontFamily: "'Helvetica Neue', Arial, sans-serif", fontSize: '13px', color: gitHubConfig.token ? '#333' : '#AAA', borderBottom: '1px solid #EEE' }} onMouseOver={(e) => gitHubConfig.token && (e.currentTarget.style.background = '#F5F5F5')} onMouseOut={(e) => e.currentTarget.style.background = '#FFF'}>
                            <span style={{ opacity: gitHubConfig.token ? 1 : 0.5 }}>ðŸ“¥</span> Load from GitHub
                          </button>
                          <div style={{ height: '1px', background: '#EEE', margin: '4px 0' }}></div>
                          <button onClick={() => { exportConfig(); setShowSettingsMenu(false); }} style={{ display: 'flex', alignItems: 'center', gap: '10px', width: '100%', padding: '10px 14px', border: 'none', background: '#FFF', cursor: 'pointer', textAlign: 'left', fontFamily: "'Helvetica Neue', Arial, sans-serif", fontSize: '13px', color: '#333', borderBottom: '1px solid #EEE' }} onMouseOver={(e) => e.currentTarget.style.background = '#F5F5F5'} onMouseOut={(e) => e.currentTarget.style.background = '#FFF'}>
                            <span>ðŸ’¾</span> Export JSON
                          </button>
                          <label style={{ display: 'flex', alignItems: 'center', gap: '10px', width: '100%', padding: '10px 14px', border: 'none', background: '#FFF', cursor: 'pointer', textAlign: 'left', fontFamily: "'Helvetica Neue', Arial, sans-serif", fontSize: '13px', color: '#333', borderBottom: '1px solid #EEE' }} onMouseOver={(e) => e.currentTarget.style.background = '#F5F5F5'} onMouseOut={(e) => e.currentTarget.style.background = '#FFF'}>
                            <span>ðŸ“‚</span> Import JSON
                            <input type="file" accept=".json" onChange={(e) => { importConfig(e); setShowSettingsMenu(false); }} style={{ display: 'none' }} />
                          </label>
                          <button onClick={() => { setShowJson(!showJson); setShowSettingsMenu(false); }} style={{ display: 'flex', alignItems: 'center', gap: '10px', width: '100%', padding: '10px 14px', border: 'none', background: '#FFF', cursor: 'pointer', textAlign: 'left', fontFamily: "'Helvetica Neue', Arial, sans-serif", fontSize: '13px', color: '#333', borderBottom: '1px solid #EEE' }} onMouseOver={(e) => e.currentTarget.style.background = '#F5F5F5'} onMouseOut={(e) => e.currentTarget.style.background = '#FFF'}>
                            <span>{'{ }'}</span> {showJson ? 'Hide' : 'View'} JSON
                          </button>
                          <div style={{ height: '1px', background: '#EEE', margin: '4px 0' }}></div>
                          <button 
                            onClick={() => setShowCosts(!showCosts)} 
                            style={{ 
                              display: 'flex', 
                              alignItems: 'center', 
                              gap: '10px', 
                              width: '100%', 
                              padding: '10px 14px', 
                              border: 'none', 
                              background: '#FFF', 
                              cursor: 'pointer', 
                              textAlign: 'left', 
                              fontFamily: "'Helvetica Neue', Arial, sans-serif", 
                              fontSize: '13px', 
                              color: '#333',
                              borderBottom: '1px solid #EEE'
                            }} 
                            onMouseOver={(e) => e.currentTarget.style.background = '#F5F5F5'} 
                            onMouseOut={(e) => e.currentTarget.style.background = '#FFF'}
                          >
                            <span>{showCosts ? 'ðŸ’°' : 'ðŸš«'}</span> 
                            <span style={{ flex: 1 }}>Cost Data</span>
                            <span style={{ 
                              padding: '2px 8px', 
                              borderRadius: '10px', 
                              fontSize: '10px', 
                              fontWeight: 600,
                              background: showCosts ? '#D1FAE5' : '#FEE2E2',
                              color: showCosts ? '#065F46' : '#B91C1C'
                            }}>
                              {showCosts ? 'VISIBLE' : 'HIDDEN'}
                            </span>
                          </button>
                          <div style={{ height: '1px', background: '#EEE', margin: '4px 0' }}></div>
                          <button onClick={() => { 
                            if (confirm('Clear local data and reload from defaults? Your GitHub data will not be affected.')) {
                              localStorage.removeItem('journeymap-config');
                              window.location.reload();
                            }
                            setShowSettingsMenu(false); 
                          }} style={{ display: 'flex', alignItems: 'center', gap: '10px', width: '100%', padding: '10px 14px', border: 'none', background: '#FFF', cursor: 'pointer', textAlign: 'left', fontFamily: "'Helvetica Neue', Arial, sans-serif", fontSize: '13px', color: '#C53030' }} onMouseOver={(e) => e.currentTarget.style.background = '#FEE2E2'} onMouseOut={(e) => e.currentTarget.style.background = '#FFF'}>
                            <span>ðŸ—‘ï¸</span> Clear Local Data
                          </button>
                        </div>
                      )}
                    </div>
                  </>
                )}
              </div>
            </div>
            
            {/* Row 2: View Toggles - Mobile only */}
            {isMobile && !editMode && (
              <div className="no-print header-buttons" style={{ display: 'flex', gap: '6px', alignItems: 'center', flexWrap: 'wrap' }}>
                {/* GROUP 1: View Mode */}
                <div style={{ display: 'flex', borderRadius: '5px', overflow: 'hidden', border: '1px solid rgba(255,255,255,0.35)' }}>
                  <button onClick={() => { setViewMode('stages'); }} style={{ padding: '7px 12px', background: viewMode === 'stages' ? '#4A5568' : 'transparent', color: '#FAFAFA', border: 'none', cursor: 'pointer', fontFamily: "'Helvetica Neue', Arial, sans-serif", fontSize: '11px', display: 'flex', alignItems: 'center', gap: '5px' }}>
                    ðŸ“ Stages
                  </button>
                  <button onClick={() => setViewMode('steps')} style={{ padding: '7px 12px', background: viewMode === 'steps' ? '#4A5568' : 'transparent', color: '#FAFAFA', border: 'none', borderLeft: '1px solid rgba(255,255,255,0.25)', cursor: 'pointer', fontFamily: "'Helvetica Neue', Arial, sans-serif", fontSize: '11px', display: 'flex', alignItems: 'center', gap: '5px' }}>
                    ðŸ“‹ Steps
                  </button>
                </div>
                
                {/* GROUP 2: View Layers */}
                {(showCosts || config.funnel?.enabled) && (
                  <div style={{ display: 'flex', borderRadius: '5px', overflow: 'hidden', border: '1px solid rgba(255,255,255,0.35)' }}>
                    {showCosts && (
                      <button 
                        onClick={() => { 
                          if (highlightOpportunities) {
                            setHighlightOpportunities(false);
                          } else {
                            setHighlightOpportunities(true);
                            setShowFunnel(false);
                          }
                        }} 
                        style={{ 
                          padding: '7px 12px', 
                          background: highlightOpportunities ? '#059669' : 'transparent', 
                          color: '#FAFAFA', 
                          border: 'none', 
                          cursor: 'pointer', 
                          fontFamily: "'Helvetica Neue', Arial, sans-serif", 
                          fontSize: '11px',
                          display: 'flex',
                          alignItems: 'center',
                          gap: '5px',
                          borderRight: config.funnel?.enabled ? '1px solid rgba(255,255,255,0.25)' : 'none'
                        }}
                      >
                        ðŸŽ¯
                      </button>
                    )}
                    {config.funnel?.enabled && (
                      <button 
                        onClick={() => { 
                          if (showFunnel) {
                            setShowFunnel(false);
                          } else {
                            setShowFunnel(true);
                            setHighlightOpportunities(false);
                          }
                        }} 
                        style={{ 
                          padding: '7px 12px', 
                          background: showFunnel ? '#6366F1' : 'transparent', 
                          color: '#FAFAFA', 
                          border: 'none', 
                          cursor: 'pointer', 
                          fontFamily: "'Helvetica Neue', Arial, sans-serif", 
                          fontSize: '11px',
                          display: 'flex',
                          alignItems: 'center',
                          gap: '5px'
                        }}
                      >
                        ðŸ”»
                      </button>
                    )}
                  </div>
                )}
                
                {/* GROUP 3: Dashboards */}
                <div style={{ display: 'flex', borderRadius: '5px', overflow: 'hidden', border: '1px solid rgba(255,255,255,0.35)' }}>
                  <button onClick={() => setShowTimeline(!showTimeline)} style={{ padding: '7px 12px', background: showTimeline ? '#4A5568' : 'transparent', color: '#FAFAFA', border: 'none', cursor: 'pointer', fontFamily: "'Helvetica Neue', Arial, sans-serif", fontSize: '11px', display: 'flex', alignItems: 'center', gap: '5px', borderRight: '1px solid rgba(255,255,255,0.25)' }}>
                    ðŸ“…
                  </button>
                  {showCosts && (
                    <button onClick={() => setShowCostAnalysis(!showCostAnalysis)} style={{ padding: '7px 12px', background: showCostAnalysis ? '#4A5568' : 'transparent', color: '#FAFAFA', border: 'none', cursor: 'pointer', fontFamily: "'Helvetica Neue', Arial, sans-serif", fontSize: '11px', display: 'flex', alignItems: 'center', gap: '5px', borderRight: config.funnel?.enabled ? '1px solid rgba(255,255,255,0.25)' : 'none' }}>
                      ðŸ’°
                    </button>
                  )}
                  {config.funnel?.enabled && (
                    <button 
                      onClick={() => setShowFunnelDashboard(true)} 
                      style={{ 
                        padding: '7px 12px', 
                        background: 'transparent', 
                        color: '#FAFAFA', 
                        border: 'none', 
                        cursor: 'pointer', 
                        fontFamily: "'Helvetica Neue', Arial, sans-serif", 
                        fontSize: '11px',
                        display: 'flex',
                        alignItems: 'center',
                        gap: '5px'
                      }}
                    >
                      ðŸ“Š
                    </button>
                  )}
                </div>
              </div>
            )}
          </header>

          {/* GitHub Status Toast */}
          {gitHubStatus.message && !showGitHubSettings && (
            <div style={{
              position: 'fixed',
              top: '80px',
              right: '20px',
              padding: '12px 20px',
              background: gitHubStatus.error ? '#FEF2F2' : gitHubStatus.loading ? '#F0F9FF' : '#F0FDF4',
              color: gitHubStatus.error ? '#B91C1C' : gitHubStatus.loading ? '#1D4ED8' : '#166534',
              borderRadius: '8px',
              boxShadow: '0 4px 12px rgba(0,0,0,0.15)',
              zIndex: 1000,
              fontSize: '14px',
              display: 'flex',
              alignItems: 'center',
              gap: '8px',
              fontFamily: "'Helvetica Neue', Arial, sans-serif"
            }}>
              {gitHubStatus.loading ? 'â³' : gitHubStatus.error ? 'âŒ' : 'âœ“'}
              {gitHubStatus.message}
            </div>
          )}

          {/* Stats Bar */}
          <div className="stats-bar" style={{ background: '#FFF', borderBottom: '1px solid #E0E0E0', padding: '16px 40px', display: 'flex', gap: '32px', alignItems: 'center', flexWrap: 'wrap', flexShrink: 0 }}>
            <div style={{ display: 'flex', alignItems: 'center', gap: '8px' }}>
              <span style={{ fontSize: '20px' }}>â±ï¸</span>
              <div>
                <div style={{ fontFamily: "'Helvetica Neue', Arial, sans-serif", fontSize: '11px', color: '#999', textTransform: 'uppercase' }}>Total Time</div>
                <div style={{ fontWeight: 600 }}>{formatTime(totalTime)}</div>
              </div>
            </div>
            <div style={{ display: 'flex', alignItems: 'center', gap: '8px' }}>
              <span style={{ fontSize: '20px' }}>{frictionConfig[Math.round(stats.avgFriction) || 3]?.emoji || 'ðŸ˜•'}</span>
              <div>
                <div style={{ fontFamily: "'Helvetica Neue', Arial, sans-serif", fontSize: '11px', color: '#999', textTransform: 'uppercase' }}>Avg Friction</div>
                <div style={{ fontWeight: 600, color: frictionConfig[Math.round(stats.avgFriction) || 3]?.color || '#666' }}>{stats.avgFriction}/5</div>
              </div>
            </div>
            <div style={{ display: 'flex', alignItems: 'center', gap: '8px' }}>
              <span style={{ fontSize: '20px' }}>âš ï¸</span>
              <div>
                <div style={{ fontFamily: "'Helvetica Neue', Arial, sans-serif", fontSize: '11px', color: '#999', textTransform: 'uppercase' }}>Pain Points</div>
                <div style={{ fontWeight: 600 }}>{stats.totalPainPoints}</div>
              </div>
            </div>
            <div style={{ display: 'flex', alignItems: 'center', gap: '8px' }}>
              <span style={{ fontSize: '20px' }}>ðŸ’¡</span>
              <div>
                <div style={{ fontFamily: "'Helvetica Neue', Arial, sans-serif", fontSize: '11px', color: '#999', textTransform: 'uppercase' }}>High Improvement</div>
                <div style={{ fontWeight: 600 }}>{stats.highAutomation} steps</div>
              </div>
            </div>
            <div style={{ display: 'flex', alignItems: 'center', gap: '8px' }}>
              <span style={{ fontSize: '20px' }}>ðŸ“‹</span>
              <div>
                <div style={{ fontFamily: "'Helvetica Neue', Arial, sans-serif", fontSize: '11px', color: '#999', textTransform: 'uppercase' }}>Regulatory Reqs</div>
                <div style={{ fontWeight: 600 }}>{stats.totalRegReqs}</div>
              </div>
            </div>
            {showCosts && (
              <div style={{ display: 'flex', alignItems: 'center', gap: '12px', marginLeft: 'auto' }}>
                <div style={{ display: 'flex', alignItems: 'center', gap: '8px', padding: '8px 16px', background: '#FEF3C7', borderRadius: '8px' }}>
                  <span style={{ fontSize: '20px' }}>ðŸ’°</span>
                  <div>
                    <div style={{ fontFamily: "'Helvetica Neue', Arial, sans-serif", fontSize: '11px', color: '#92400E', textTransform: 'uppercase' }}>Total Cost</div>
                    <div style={{ fontWeight: 600, color: '#92400E', fontSize: '18px' }}>{formatCurrency(stats.totalCost)}</div>
                  </div>
                </div>
                <div style={{ 
                  display: 'flex', 
                  alignItems: 'center', 
                  gap: '8px', 
                  padding: highlightOpportunities ? '8px 16px' : '0', 
                  background: 'linear-gradient(135deg, #059669 0%, #047857 100%)', 
                  borderRadius: '8px',
                  maxWidth: highlightOpportunities ? '400px' : '0',
                  opacity: highlightOpportunities ? 1 : 0,
                  overflow: 'hidden',
                  transition: 'max-width 0.3s ease, opacity 0.3s ease, padding 0.3s ease',
                  whiteSpace: 'nowrap'
                }}>
                    <span style={{ fontSize: '20px' }}>ðŸŽ¯</span>
                    <div>
                      <div style={{ fontFamily: "'Helvetica Neue', Arial, sans-serif", fontSize: '11px', color: 'rgba(255,255,255,0.9)', textTransform: 'uppercase' }}>Potential Savings</div>
                      <div style={{ fontWeight: 600, color: '#FFF', fontSize: '18px' }}>
                        {(() => {
                          const totalSavings = config.stages.reduce((acc, stage) => 
                            acc + stage.steps.reduce((stepAcc, step) => {
                              const stepCost = calculateStepCost(step, config.personas);
                              const savings = step.automationOpportunity === 'high' ? stepCost * 0.7 
                                : step.automationOpportunity === 'medium' ? stepCost * 0.4 
                                : step.automationOpportunity === 'low' ? stepCost * 0.1 : 0;
                              return stepAcc + savings;
                            }, 0), 0);
                          const totalTimeSavings = config.stages.reduce((acc, stage) => 
                            acc + stage.steps.reduce((stepAcc, step) => {
                              const savings = step.automationOpportunity === 'high' ? step.timeMinutes * 0.7 
                                : step.automationOpportunity === 'medium' ? step.timeMinutes * 0.4 
                                : step.automationOpportunity === 'low' ? step.timeMinutes * 0.1 : 0;
                              return stepAcc + savings;
                            }, 0), 0);
                          const percentage = stats.totalCost > 0 ? Math.round((totalSavings / stats.totalCost) * 100) : 0;
                          return `${formatTime(Math.round(totalTimeSavings))} Â· ${formatCurrency(totalSavings)} (${percentage}%)`;
                        })()}
                      </div>
                    </div>
                </div>
                {funnelMetrics && (
                  <div style={{ 
                    display: 'flex', 
                    alignItems: 'center', 
                    gap: '8px', 
                    padding: showFunnel ? '8px 16px' : '0',
                    background: 'linear-gradient(135deg, #6366F1 0%, #4F46E5 100%)', 
                    borderRadius: '8px',
                    maxWidth: showFunnel ? '500px' : '0',
                    opacity: showFunnel ? 1 : 0,
                    overflow: 'hidden',
                    transition: 'max-width 0.3s ease, opacity 0.3s ease, padding 0.3s ease',
                    whiteSpace: 'nowrap'
                  }}>
                    <span style={{ fontSize: '20px' }}>ðŸ”»</span>
                    <div>
                      <div style={{ fontFamily: "'Helvetica Neue', Arial, sans-serif", fontSize: '11px', color: 'rgba(255,255,255,0.9)', textTransform: 'uppercase' }}>Funnel</div>
                      <div style={{ fontWeight: 600, color: '#FFF', fontSize: '18px', display: 'flex', alignItems: 'center', gap: '6px' }}>
                        <span>{funnelMetrics.initialVolume.toLocaleString()}</span>
                        <span style={{ fontSize: '12px', opacity: 0.7 }}>â†’</span>
                        <span>{funnelMetrics.finalVolume.toLocaleString()}</span>
                        <span style={{ 
                          marginLeft: '4px',
                          padding: '2px 8px', 
                          borderRadius: '10px', 
                          fontSize: '12px',
                          fontWeight: 600,
                          background: 'rgba(255,255,255,0.2)',
                          color: '#FFF'
                        }}>
                          {funnelMetrics.overallConversionRate.toFixed(1)}%
                        </span>
                      </div>
                    </div>
                    <div style={{ marginLeft: '8px', paddingLeft: '12px', borderLeft: '1px solid rgba(255,255,255,0.3)' }}>
                      <div style={{ fontFamily: "'Helvetica Neue', Arial, sans-serif", fontSize: '11px', color: 'rgba(255,255,255,0.9)', textTransform: 'uppercase' }}>Spend</div>
                      <div style={{ fontWeight: 600, fontSize: '14px', display: 'flex', alignItems: 'center', gap: '8px', color: '#FFF' }}>
                        <span>âœ“ {formatCurrency(funnelMetrics.totalStageInvestment)}</span>
                        <span style={{ background: 'rgba(239,68,68,0.9)', padding: '2px 8px', borderRadius: '4px' }}>ðŸ’¸ {formatCurrency(funnelMetrics.totalWastedCost)}</span>
                      </div>
                    </div>
                  </div>
                )}
              </div>
            )}
          </div>

          {/* Perspective Filter - only show in steps view */}
          {viewMode === 'steps' && (
            <div className="perspective-filter no-print" style={{ background: '#F9F9F9', borderBottom: '1px solid #E0E0E0', padding: '12px 40px', display: 'flex', gap: '12px', alignItems: 'center', flexWrap: 'wrap' }}>
              <span style={{ fontFamily: "'Helvetica Neue', Arial, sans-serif", fontSize: '13px', color: '#666', marginRight: '8px' }}>Filter by perspective:</span>
              
              {/* Desktop: Button row */}
              <div className="perspective-buttons" style={{ display: 'flex', gap: '8px', flexWrap: 'wrap' }}>
                <button onClick={() => setActivePerspective('all')} style={{ padding: '8px 16px', background: activePerspective === 'all' ? '#1A1A1A' : '#FFF', color: activePerspective === 'all' ? '#FFF' : '#1A1A1A', border: '1px solid #DDD', borderRadius: '20px', cursor: 'pointer', fontFamily: "'Helvetica Neue', Arial, sans-serif", fontSize: '12px', fontWeight: 500 }}>All</button>
                {config.personas.map(persona => (
                  <button key={persona.id} onClick={() => setActivePerspective(persona.id)} style={{ padding: '8px 16px', background: activePerspective === persona.id ? persona.color : '#FFF', color: activePerspective === persona.id ? '#FFF' : '#1A1A1A', border: '1px solid #DDD', borderRadius: '20px', cursor: 'pointer', fontFamily: "'Helvetica Neue', Arial, sans-serif", fontSize: '12px', fontWeight: 500 }}>{persona.label}</button>
                ))}
              </div>
              
              {/* Mobile: Dropdown */}
              <div className="perspective-dropdown" style={{ display: 'none' }}>
                <select 
                  value={activePerspective} 
                  onChange={(e) => setActivePerspective(e.target.value)}
                  style={{ 
                    padding: '8px 32px 8px 12px', 
                    background: activePerspective === 'all' ? '#1A1A1A' : (config.personas.find(p => p.id === activePerspective)?.color || '#1A1A1A'),
                    color: '#FFF',
                    border: 'none',
                    borderRadius: '20px',
                    cursor: 'pointer',
                    fontFamily: "'Helvetica Neue', Arial, sans-serif",
                    fontSize: '12px',
                    fontWeight: 500,
                    appearance: 'none',
                    backgroundImage: `url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 12 12'%3E%3Cpath fill='white' d='M3 5l3 3 3-3'/%3E%3C/svg%3E")`,
                    backgroundRepeat: 'no-repeat',
                    backgroundPosition: 'right 10px center'
                  }}
                >
                  <option value="all" style={{ background: '#FFF', color: '#1A1A1A' }}>All Perspectives</option>
                  {config.personas.map(persona => (
                    <option key={persona.id} value={persona.id} style={{ background: '#FFF', color: '#1A1A1A' }}>{persona.label}</option>
                  ))}
                </select>
              </div>
            </div>
          )}

          {/* JSON Panel */}
          {showJson && (
            <div className="no-print" style={{ background: '#1E1E1E', color: '#D4D4D4', padding: '20px 40px', fontFamily: "'Monaco', 'Menlo', 'Courier New', monospace", fontSize: '12px', maxHeight: '300px', overflow: 'auto', borderBottom: '1px solid #333' }}>
              <pre style={{ margin: 0 }}>{JSON.stringify(config, null, 2)}</pre>
            </div>
          )}

          {/* Main Journey Map */}
          <main className="main-content" style={{ 
            padding: isMobile ? '20px 16px' : '40px', 
            flex: isMobile ? 'none' : 1, 
            overflow: isMobile ? 'visible' : 'hidden', 
            display: 'flex', 
            flexDirection: 'column' 
          }}>
            {/* Timeline - inline on mobile with card styling */}
            {isMobile && showTimeline && (
              <div style={{ background: '#FFF', borderRadius: '12px', marginBottom: '24px', boxShadow: '0 2px 8px rgba(0,0,0,0.04)' }}>
                <Timeline stages={config.stages} totalTime={totalTime} formatTime={formatTime} personas={config.personas} onClose={() => setShowTimeline(false)} showCosts={showCosts} />
              </div>
            )}
            
            {/* Cost Analysis - inline on mobile with card styling */}
            {isMobile && showCostAnalysis && (
              <div style={{ background: '#FFF', borderRadius: '12px', marginBottom: '24px', boxShadow: '0 4px 24px rgba(0,0,0,0.08)', border: '2px solid #FDE68A' }}>
                <CostAnalysisPanel stages={config.stages} personas={config.personas} formatTime={formatTime} onClose={() => setShowCostAnalysis(false)} />
              </div>
            )}
            <div className="stages-container" style={{ 
              display: 'flex', 
              flexWrap: 'nowrap',
              gap: '16px', 
              overflowX: 'auto', 
              paddingBottom: '20px', 
              flex: isMobile ? 'none' : 1, 
              alignItems: isMobile ? 'flex-start' : 'stretch' 
            }}>
              {viewMode === 'stages' ? (
                /* Stages Summary View */
                <>
                  {(() => {
                    // Calculate global ranking of all opportunities
                    const allOpportunitySteps = config.stages.flatMap((stage, stageIdx) => 
                      stage.steps.map(step => {
                        const stepCost = calculateStepCost(step, config.personas);
                        const savings = step.automationOpportunity === 'high' ? stepCost * 0.7 
                          : step.automationOpportunity === 'medium' ? stepCost * 0.4 
                          : step.automationOpportunity === 'low' ? stepCost * 0.1 : 0;
                        return { id: step.id, savings, hasOpportunity: step.automationOpportunity === 'high' || step.automationOpportunity === 'medium' };
                      })
                    ).filter(s => s.hasOpportunity).sort((a, b) => b.savings - a.savings);
                    
                    // Create a map of step id to rank (1-5 for top 5)
                    const opportunityRanks = {};
                    allOpportunitySteps.slice(0, 5).forEach((step, idx) => {
                      opportunityRanks[step.id] = idx + 1;
                    });
                    
                    return config.stages.map((stage, stageIndex) => {
                  const stageTime = stage.steps.reduce((acc, step) => acc + step.timeMinutes, 0);
                  const stageCost = stage.steps.reduce((acc, step) => acc + calculateStepCost(step, config.personas), 0);
                  const totalPainPoints = stage.steps.reduce((acc, step) => acc + (step.painPoints?.length || 0), 0);
                  const totalRegReqs = stage.steps.reduce((acc, step) => acc + (step.regulatoryRequirements?.length || 0), 0);
                  const highAutoOps = stage.steps.filter(step => step.automationOpportunity === 'high').length;
                  const medAutoOps = stage.steps.filter(step => step.automationOpportunity === 'medium').length;
                  const checkpointCount = stage.steps.filter(step => step.isHardCheckpoint).length;
                  const maxStepTime = Math.max(...stage.steps.map(s => s.timeMinutes), 1);
                  const stageColor = `hsl(${stageIndex * 45 + 180}, 35%, 45%)`;
                  const stageColorLight = `hsl(${stageIndex * 45 + 180}, 35%, 85%)`;
                  
                  // Get funnel metrics for this stage
                  const stageFunnelData = funnelMetrics?.stageMetrics?.[stageIndex];
                  
                  // Calculate stage-level savings
                  const stageSavings = stage.steps.reduce((acc, step) => {
                    const stepCost = calculateStepCost(step, config.personas);
                    const savings = step.automationOpportunity === 'high' ? stepCost * 0.7 
                      : step.automationOpportunity === 'medium' ? stepCost * 0.4 
                      : step.automationOpportunity === 'low' ? stepCost * 0.1 : 0;
                    return acc + savings;
                  }, 0);
                  const stageTimeSavings = stage.steps.reduce((acc, step) => {
                    const savings = step.automationOpportunity === 'high' ? step.timeMinutes * 0.7 
                      : step.automationOpportunity === 'medium' ? step.timeMinutes * 0.4 
                      : step.automationOpportunity === 'low' ? step.timeMinutes * 0.1 : 0;
                    return acc + savings;
                  }, 0);
                  const hasOpportunities = highAutoOps > 0 || medAutoOps > 0;
                  
                  return (
                    <div key={stage.id} className="stage-card" style={{ 
                      flex: '0 0 auto', 
                      width: '320px',
                      minWidth: '280px',
                      maxWidth: '400px',
                      background: '#FFF', 
                      borderRadius: '12px', 
                      overflow: 'hidden',
                      boxShadow: '0 2px 8px rgba(0,0,0,0.06)',
                      display: 'flex',
                      flexDirection: 'column',
                      maxHeight: isMobile ? 'none' : '100%'
                    }}>
                      {/* Stage Header */}
                      <div style={{ 
                        background: `hsl(${stageIndex * 45 + 180}, 35%, 45%)`, 
                        padding: '16px 20px',
                        color: '#FFF',
                        flexShrink: 0
                      }}>
                        {/* Top row: Stage title and time/cost */}
                        <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'flex-start' }}>
                          <div>
                            <div style={{ fontSize: '10px', opacity: 0.7, textTransform: 'uppercase', letterSpacing: '0.5px', marginBottom: '2px' }}>Stage {stageIndex + 1}</div>
                            <h2 style={{ margin: 0, fontSize: '18px', fontWeight: 600, lineHeight: 1.2 }}>{stage.name}</h2>
                          </div>
                          <div style={{ textAlign: 'right' }}>
                            <div style={{ fontSize: '16px', fontWeight: 600 }}>{formatTime(stageTime)}</div>
                            {showCosts && <div style={{ fontSize: '12px', opacity: 0.8 }}>{formatCurrency(stageCost)}</div>}
                          </div>
                        </div>
                        
                        {/* Funnel row (when enabled) */}
                        {stageFunnelData && (
                          <div className="funnel-stat" style={{ 
                            marginTop: showFunnel ? '12px' : '0', 
                            paddingTop: showFunnel ? '12px' : '0',
                            maxHeight: showFunnel ? '100px' : '0',
                            opacity: showFunnel ? 1 : 0,
                            overflow: 'hidden',
                            borderTop: showFunnel ? '1px solid rgba(255,255,255,0.2)' : '1px solid transparent',
                            display: 'flex',
                            alignItems: 'center',
                            gap: '12px',
                            flexWrap: 'wrap',
                            transition: 'max-height 0.3s ease, opacity 0.3s ease, margin 0.3s ease, padding 0.3s ease, border 0.3s ease'
                          }}>
                            <div style={{ display: 'flex', alignItems: 'center', gap: '6px' }}>
                              <span style={{ fontSize: '14px', fontWeight: 600 }}>{stageFunnelData.entryVolume.toLocaleString()}</span>
                              <span style={{ fontSize: '11px', opacity: 0.7 }}>â†’</span>
                              {stageFunnelData.dropOff > 0 && (
                                <span style={{ fontSize: '11px', background: 'rgba(239,68,68,0.9)', padding: '2px 6px', borderRadius: '4px', fontWeight: 600 }}>-{stageFunnelData.dropOff.toLocaleString()}</span>
                              )}
                              <span style={{ fontSize: '11px', opacity: 0.7 }}>â†’</span>
                              <span style={{ fontSize: '14px', fontWeight: 600, color: '#86EFAC' }}>{stageFunnelData.exitVolume.toLocaleString()}</span>
                            </div>
                            <span style={{ 
                              padding: '2px 8px', 
                              borderRadius: '10px', 
                              fontSize: '11px',
                              background: stageFunnelData.completionRate >= 90 ? 'rgba(134,239,172,0.3)' : stageFunnelData.completionRate >= 70 ? 'rgba(253,224,71,0.3)' : 'rgba(252,165,165,0.3)',
                              fontWeight: 600
                            }}>
                              {stageFunnelData.completionRate.toFixed(0)}% pass
                            </span>
                            {showCosts && (
                              <div style={{ display: 'flex', alignItems: 'center', gap: '6px', fontSize: '11px' }}>
                                <span style={{ opacity: 0.85 }}>âœ“ {formatCurrency(stageFunnelData.stageInvestment)}</span>
                                {stageFunnelData.wastedCost > 0 && (
                                  <span style={{ 
                                    background: 'rgba(239,68,68,0.9)', 
                                    padding: '2px 8px', 
                                    borderRadius: '4px', 
                                    fontWeight: 600 
                                  }}>
                                    ðŸ’¸ {formatCurrency(stageFunnelData.wastedCost)}
                                  </span>
                                )}
                              </div>
                            )}
                          </div>
                        )}
                      </div>
                      
                      {/* Stage Body */}
                      <div style={{ padding: '16px 20px', flex: isMobile ? 'none' : 1, overflowY: isMobile ? 'visible' : 'auto' }}>
                        {/* Steps List */}
                        <div style={{ marginBottom: '16px' }}>
                          <div style={{ fontSize: '11px', color: '#999', textTransform: 'uppercase', letterSpacing: '0.5px', marginBottom: '8px' }}>
                            {stage.steps.length} Steps
                          </div>
                          <div style={{ display: 'flex', flexDirection: 'column', gap: highlightOpportunities ? '8px' : '6px', paddingTop: highlightOpportunities ? '8px' : 0, paddingLeft: highlightOpportunities ? '8px' : 0 }}>
                            {stage.steps.map((step, idx) => {
                              const timeBarWidth = maxStepTime > 0 ? (step.timeMinutes / maxStepTime) * 100 : 0;
                              const isHighOpp = step.automationOpportunity === 'high';
                              const isMedOpp = step.automationOpportunity === 'medium';
                              const stepCost = calculateStepCost(step, config.personas);
                              const stepSavings = isHighOpp ? stepCost * 0.7 : isMedOpp ? stepCost * 0.4 : 0;
                              const stepTimeSavings = isHighOpp ? step.timeMinutes * 0.7 : isMedOpp ? step.timeMinutes * 0.4 : 0;
                              const showOppHighlight = highlightOpportunities && (isHighOpp || isMedOpp);
                              const isTopFive = opportunityRanks[step.id] !== undefined;
                              return (
                              <div key={step.id} className="step-item" style={{ 
                                display: 'flex', 
                                alignItems: 'center', 
                                gap: '8px',
                                padding: '8px 12px',
                                background: showOppHighlight 
                                  ? (isTopFive 
                                    ? (isHighOpp ? 'linear-gradient(90deg, #D1FAE5 0%, #A7F3D0 100%)' : 'linear-gradient(90deg, #FEF3C7 0%, #FDE68A 100%)')
                                    : (isHighOpp ? '#F0FDF4' : '#FFFBEB'))
                                  : step.isHardCheckpoint ? '#FDF2F8' : '#F8F8F8',
                                borderRadius: '6px',
                                fontSize: '13px',
                                border: showOppHighlight 
                                  ? (isTopFive
                                    ? (isHighOpp ? '2px solid #6EE7B7' : '2px solid #FCD34D')
                                    : (isHighOpp ? '1px solid #BBF7D0' : '1px solid #FEF08A'))
                                  : step.isHardCheckpoint ? '1px solid #FBCFE8' : '1px solid transparent',
                                position: 'relative',
                                overflow: 'visible',
                                marginTop: showOppHighlight && isTopFive ? '6px' : 0,
                                marginLeft: showOppHighlight && isTopFive ? '6px' : 0
                              }}>
                                {/* Top 5 Ranking Badge - overlaid in top-left corner */}
                                {showOppHighlight && isTopFive && (
                                  <span className="ranking-badge" style={{ 
                                    position: 'absolute',
                                    top: '-10px',
                                    left: '-10px',
                                    zIndex: 2,
                                    display: 'inline-flex',
                                    alignItems: 'center',
                                    justifyContent: 'center',
                                    width: '26px',
                                    height: '26px',
                                    borderRadius: '50%',
                                    background: isHighOpp ? '#059669' : '#D97706',
                                    color: '#FFF',
                                    fontSize: '14px',
                                    fontWeight: 700,
                                    boxShadow: '0 2px 6px rgba(0,0,0,0.25)'
                                  }}>
                                    {opportunityRanks[step.id]}
                                  </span>
                                )}
                                {/* Time Bar Background - only show when not highlighting opportunities */}
                                {!showOppHighlight && (
                                  <div style={{
                                    position: 'absolute',
                                    top: 0,
                                    left: 0,
                                    width: `${timeBarWidth}%`,
                                    height: '100%',
                                    background: stageColorLight,
                                    opacity: 0.5,
                                    transition: 'width 0.3s ease',
                                    zIndex: 0
                                  }} />
                                )}
                                <span style={{ color: '#999', fontWeight: 500, minWidth: '24px', position: 'relative', zIndex: 1 }}>{stageIndex + 1}.{idx + 1}</span>
                                {step.isHardCheckpoint && <span style={{ fontSize: '12px', position: 'relative', zIndex: 1 }}>ðŸš§</span>}
                                <span style={{ flex: 1, color: showOppHighlight ? (isHighOpp ? '#065F46' : '#92400E') : step.isHardCheckpoint ? '#BE185D' : '#333', position: 'relative', zIndex: 1, fontWeight: showOppHighlight && isTopFive ? 600 : showOppHighlight ? 500 : 400, opacity: showOppHighlight && !isTopFive ? 0.8 : 1 }}>{step.name}</span>
                                {showOppHighlight ? (
                                  <span style={{ color: isHighOpp ? '#065F46' : '#92400E', fontSize: '11px', position: 'relative', zIndex: 1, fontWeight: isTopFive ? 700 : 500, opacity: isTopFive ? 1 : 0.7 }}>
                                    {formatTime(Math.round(stepTimeSavings))} Â· {formatCurrency(stepSavings)} ({isHighOpp ? '70' : '40'}%)
                                  </span>
                                ) : (
                                  <span style={{ color: '#666', fontSize: '12px', position: 'relative', zIndex: 1 }}>{formatTime(step.timeMinutes)}</span>
                                )}
                              </div>
                            );})}
                          </div>
                        </div>
                        
                        {/* Savings Summary - show when highlighting opportunities */}
                        {highlightOpportunities && hasOpportunities && (
                          <div className="savings-panel" style={{ 
                            padding: '12px 16px', 
                            background: 'linear-gradient(135deg, #059669 0%, #047857 100%)', 
                            borderRadius: '8px',
                            marginBottom: '16px',
                            color: '#FFF'
                          }}>
                            <div style={{ fontSize: '11px', opacity: 0.9, textTransform: 'uppercase', letterSpacing: '0.5px', marginBottom: '4px' }}>
                              Potential Savings
                            </div>
                            <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center' }}>
                              <div style={{ fontSize: '18px', fontWeight: 700 }}>
                                {formatTime(Math.round(stageTimeSavings))}
                              </div>
                              <div style={{ fontSize: '18px', fontWeight: 700 }}>
                                {formatCurrency(stageSavings)} ({stageCost > 0 ? Math.round((stageSavings / stageCost) * 100) : 0}%)
                              </div>
                            </div>
                          </div>
                        )}
                        
                        {/* Badges Row */}
                        <div style={{ display: 'flex', gap: '8px', flexWrap: 'wrap', paddingTop: '16px', borderTop: '1px solid #EEE' }}>
                          {highAutoOps > 0 && (
                            <div style={{ 
                              display: 'flex', 
                              alignItems: 'center', 
                              gap: '6px', 
                              padding: '6px 12px', 
                              background: '#D1FAE5', 
                              borderRadius: '16px',
                              fontSize: '12px',
                              color: '#065F46'
                            }}>
                              <span>ðŸŽ¯</span>
                              <span>{highAutoOps} high improvement</span>
                            </div>
                          )}
                          {medAutoOps > 0 && (
                            <div style={{ 
                              display: 'flex', 
                              alignItems: 'center', 
                              gap: '6px', 
                              padding: '6px 12px', 
                              background: '#FEF3C7', 
                              borderRadius: '16px',
                              fontSize: '12px',
                              color: '#92400E'
                            }}>
                              <span>ðŸŽ¯</span>
                              <span>{medAutoOps} medium improvement</span>
                            </div>
                          )}
                          {totalPainPoints > 0 && (
                            <div style={{ 
                              display: 'flex', 
                              alignItems: 'center', 
                              gap: '6px', 
                              padding: '6px 12px', 
                              background: '#FEF2F2', 
                              borderRadius: '16px',
                              fontSize: '12px',
                              color: '#B91C1C'
                            }}>
                              <span>âš ï¸</span>
                              <span>{totalPainPoints} pain point{totalPainPoints !== 1 ? 's' : ''}</span>
                            </div>
                          )}
                          {totalRegReqs > 0 && (
                            <div style={{ 
                              display: 'flex', 
                              alignItems: 'center', 
                              gap: '6px', 
                              padding: '6px 12px', 
                              background: '#EEF2FF', 
                              borderRadius: '16px',
                              fontSize: '12px',
                              color: '#4338CA'
                            }}>
                              <span>ðŸ“‹</span>
                              <span>{totalRegReqs} reg req{totalRegReqs !== 1 ? 's' : ''}</span>
                            </div>
                          )}
                          {checkpointCount > 0 && (
                            <div style={{ 
                              display: 'flex', 
                              alignItems: 'center', 
                              gap: '6px', 
                              padding: '6px 12px', 
                              background: '#FDF2F8', 
                              borderRadius: '16px',
                              fontSize: '12px',
                              color: '#BE185D',
                              border: '1px solid #FBCFE8'
                            }}>
                              <span>ðŸš§</span>
                              <span>{checkpointCount} checkpoint{checkpointCount !== 1 ? 's' : ''}</span>
                            </div>
                          )}
                        </div>
                      </div>
                    </div>
                  );
                })
                  })()}
                </>
              ) : (
                /* Steps Detail View (existing) */
                <>
                {config.stages.map((stage, stageIndex) => {
                const stageTime = stage.steps.reduce((acc, step) => acc + step.timeMinutes, 0);
                const stageCost = stage.steps.reduce((acc, step) => acc + calculateStepCost(step, config.personas), 0);
                const stageFunnelData = funnelMetrics?.stageMetrics?.[stageIndex];
                return (
                  <div key={stage.id} style={{ flex: stage.steps.length > 0 ? `${stage.steps.length} 0 ${stage.steps.length * 220}px` : '0 0 220px', minWidth: stage.steps.length > 0 ? stage.steps.length * 220 + 'px' : '220px' }}>
                    {/* Stage Header */}
                    <div style={{ background: `hsl(${stageIndex * 45 + 180}, 35%, 45%)`, padding: '16px 20px', borderRadius: '8px 8px 0 0', color: '#FFF' }}>
                      <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'flex-start' }}>
                        <div>
                          <div style={{ fontSize: '10px', opacity: 0.7, textTransform: 'uppercase', letterSpacing: '0.5px', marginBottom: '2px' }}>Stage {stageIndex + 1}</div>
                          {editMode ? (
                            <input 
                              type="text" 
                              value={stage.name} 
                              onChange={(e) => updateStage(stage.id, { name: e.target.value })}
                              onClick={(e) => e.stopPropagation()}
                              style={{ 
                                background: 'rgba(255,255,255,0.9)', 
                                border: 'none', 
                                borderRadius: '4px', 
                                padding: '6px 10px', 
                                fontSize: '18px', 
                                fontWeight: 600, 
                                color: '#1A1A1A', 
                                fontFamily: 'Georgia, serif', 
                                width: `${Math.max(120, Math.min(300, stage.name.length * 11 + 20))}px`
                              }}
                            />
                          ) : (
                            <h2 style={{ margin: 0, fontSize: '18px', fontWeight: 600, lineHeight: 1.2 }}>{stage.name}</h2>
                          )}
                        </div>
                        <div style={{ textAlign: 'right' }}>
                          <div style={{ fontSize: '16px', fontWeight: 600 }}>{formatTime(stageTime)}</div>
                          {showCosts && <div style={{ fontSize: '12px', opacity: 0.8 }}>{formatCurrency(stageCost)}</div>}
                        </div>
                      </div>
                      
                      {/* Funnel row (when enabled) */}
                      {stageFunnelData && (
                        <div className="funnel-stat" style={{ 
                          marginTop: showFunnel ? '12px' : '0', 
                          paddingTop: showFunnel ? '12px' : '0',
                          maxHeight: showFunnel ? '100px' : '0',
                          opacity: showFunnel ? 1 : 0,
                          overflow: 'hidden',
                          borderTop: showFunnel ? '1px solid rgba(255,255,255,0.2)' : '1px solid transparent',
                          display: 'flex',
                          alignItems: 'center',
                          gap: '12px',
                          flexWrap: 'wrap',
                          transition: 'max-height 0.3s ease, opacity 0.3s ease, margin 0.3s ease, padding 0.3s ease, border 0.3s ease'
                        }}>
                          <div style={{ display: 'flex', alignItems: 'center', gap: '6px' }}>
                            <span style={{ fontSize: '14px', fontWeight: 600 }}>{stageFunnelData.entryVolume.toLocaleString()}</span>
                            <span style={{ fontSize: '11px', opacity: 0.7 }}>â†’</span>
                            {stageFunnelData.dropOff > 0 && (
                              <span style={{ fontSize: '11px', background: 'rgba(239,68,68,0.9)', padding: '2px 6px', borderRadius: '4px', fontWeight: 600 }}>-{stageFunnelData.dropOff.toLocaleString()}</span>
                            )}
                            <span style={{ fontSize: '11px', opacity: 0.7 }}>â†’</span>
                            <span style={{ fontSize: '14px', fontWeight: 600, color: '#86EFAC' }}>{stageFunnelData.exitVolume.toLocaleString()}</span>
                          </div>
                          <span style={{ 
                            padding: '2px 8px', 
                            borderRadius: '10px', 
                            fontSize: '11px',
                            background: stageFunnelData.completionRate >= 90 ? 'rgba(134,239,172,0.3)' : stageFunnelData.completionRate >= 70 ? 'rgba(253,224,71,0.3)' : 'rgba(252,165,165,0.3)',
                            fontWeight: 600
                          }}>
                            {stageFunnelData.completionRate.toFixed(0)}% pass
                          </span>
                          {showCosts && (
                            <div style={{ display: 'flex', alignItems: 'center', gap: '6px', fontSize: '11px' }}>
                              <span style={{ opacity: 0.85 }}>âœ“ {formatCurrency(stageFunnelData.stageInvestment)}</span>
                              {stageFunnelData.wastedCost > 0 && (
                                <span style={{ 
                                  background: 'rgba(239,68,68,0.9)', 
                                  padding: '2px 8px', 
                                  borderRadius: '4px', 
                                  fontWeight: 600 
                                }}>
                                  ðŸ’¸ {formatCurrency(stageFunnelData.wastedCost)}
                                </span>
                              )}
                            </div>
                          )}
                        </div>
                      )}
                    </div>

                    {/* Steps Row */}
                    <div style={{ display: 'flex', gap: '2px', background: '#E8E8E8', minHeight: '300px' }}>
                      {stage.steps.map((step, stepIndex) => {
                        const isSelected = selectedStep?.id === step.id;
                        const isFiltered = activePerspective !== 'all' && !step.actions[activePerspective] && step.owner !== activePerspective && !(activePerspective === 'client' && step.clientTouchpoint);
                        const stepCost = calculateStepCost(step, config.personas);
                        const costPerMinute = step.timeMinutes > 0 ? stepCost / step.timeMinutes : 0;
                        const automationSavings = step.automationOpportunity === 'high' ? stepCost * 0.7 
                          : step.automationOpportunity === 'medium' ? stepCost * 0.4 
                          : step.automationOpportunity === 'low' ? stepCost * 0.1 : 0;
                        const timeSavings = step.automationOpportunity === 'high' ? step.timeMinutes * 0.7 
                          : step.automationOpportunity === 'medium' ? step.timeMinutes * 0.4 
                          : step.automationOpportunity === 'low' ? step.timeMinutes * 0.1 : 0;
                        const isHighOpportunity = highlightOpportunities && step.automationOpportunity === 'high' && stepCost > 50;
                        const isMediumOpportunity = highlightOpportunities && step.automationOpportunity === 'medium' && stepCost > 100;
                        const stageColor = `hsl(${stageIndex * 45 + 180}, 35%, 45%)`;
                        const stageColorDark = `hsl(${stageIndex * 45 + 180}, 40%, 35%)`;
                        
                        return (
                          <div key={step.id} className="step-card" onClick={() => setSelectedStep(isSelected ? null : { ...step, stageId: stage.id, stageIndex })} style={{ 
                            flex: '1 0 218px', 
                            background: isSelected ? '#FFF' : isHighOpportunity ? 'linear-gradient(135deg, #D1FAE5 0%, #A7F3D0 100%)' : isMediumOpportunity ? 'linear-gradient(135deg, #FEF3C7 0%, #FDE68A 100%)' : '#FAFAFA', 
                            padding: '20px', 
                            cursor: 'pointer', 
                            opacity: isFiltered ? 0.4 : 1, 
                            borderLeft: isSelected ? `4px solid ${stageColorDark}` : '4px solid transparent',
                            display: 'flex', 
                            flexDirection: 'column', 
                            position: 'relative',
                            boxShadow: isSelected 
                              ? `0 0 0 2px ${stageColorDark}, 0 8px 24px rgba(0, 0, 0, 0.15)` 
                              : isHighOpportunity 
                                ? '0 0 0 2px #059669, 0 4px 12px rgba(5, 150, 105, 0.2)' 
                                : isMediumOpportunity 
                                  ? '0 0 0 2px #D97706' 
                                  : 'none',
                            borderRadius: isSelected ? '8px' : (isHighOpportunity || isMediumOpportunity) ? '8px' : '0',
                            transform: isSelected ? 'translateY(-2px)' : 'none',
                            transition: 'all 0.15s ease',
                            zIndex: isSelected ? 10 : 1
                          }}>
                            {/* Opportunity Badge */}
                            {showCosts && (isHighOpportunity || isMediumOpportunity) && (
                              <div style={{
                                position: 'absolute',
                                top: '-8px',
                                right: '12px',
                                background: isHighOpportunity ? '#059669' : '#D97706',
                                color: '#FFF',
                                padding: '4px 10px',
                                borderRadius: '12px',
                                fontSize: '10px',
                                fontFamily: "'Helvetica Neue', Arial, sans-serif",
                                fontWeight: 600,
                                display: 'flex',
                                alignItems: 'center',
                                gap: '4px',
                                boxShadow: '0 2px 4px rgba(0,0,0,0.1)'
                              }}>
                                ðŸŽ¯ Save {formatTime(Math.round(timeSavings))} Â· {formatCurrency(automationSavings)} ({step.automationOpportunity === 'high' ? '70' : '40'}%)
                              </div>
                            )}
                            <div style={{ display: 'flex', justifyContent: 'space-between', marginBottom: '12px' }}>
                              <span style={{ fontFamily: "'Helvetica Neue', Arial, sans-serif", fontSize: '11px', color: '#999', textTransform: 'uppercase', letterSpacing: '0.5px' }}>Step {stageIndex + 1}.{stepIndex + 1}</span>
                              <div style={{ display: 'flex', gap: '6px', alignItems: 'center' }}>
                                <span style={{ fontFamily: "'Helvetica Neue', Arial, sans-serif", fontSize: '12px', color: '#666', background: '#F0F0F0', padding: '2px 8px', borderRadius: '10px' }}>{formatTime(step.timeMinutes)}</span>
                                {showCosts && (
                                  <span style={{ fontFamily: "'Helvetica Neue', Arial, sans-serif", fontSize: '12px', color: '#92400E', background: '#FEF3C7', padding: '2px 8px', borderRadius: '10px', fontWeight: 500 }}>
                                    {formatCurrency(stepCost)}
                                    {highlightOpportunities && <span style={{ fontSize: '10px', marginLeft: '3px', opacity: 0.8 }}>({formatCurrencyDetailed(costPerMinute)}/m)</span>}
                                  </span>
                                )}
                              </div>
                            </div>
                            {editMode ? (
                              <textarea 
                                value={step.name} 
                                onChange={(e) => updateStep(stage.id, step.id, { name: e.target.value })}
                                onClick={(e) => e.stopPropagation()}
                                rows={step.name.length > 25 ? 2 : 1}
                                style={{ 
                                  margin: '0 0 8px', 
                                  fontSize: '16px', 
                                  fontWeight: 600, 
                                  lineHeight: 1.3, 
                                  width: '100%', 
                                  padding: '4px 6px', 
                                  border: '1px solid #DDD', 
                                  borderRadius: '4px', 
                                  fontFamily: 'Georgia, serif',
                                  resize: 'none',
                                  overflow: 'hidden'
                                }}
                              />
                            ) : (
                              <h3 style={{ margin: '0 0 8px', fontSize: '16px', fontWeight: 600, lineHeight: 1.3, paddingRight: '20px' }}>{step.name}</h3>
                            )}
                            {editMode ? (
                              <textarea 
                                value={step.description} 
                                onChange={(e) => updateStep(stage.id, step.id, { description: e.target.value })}
                                onClick={(e) => e.stopPropagation()}
                                rows={2}
                                style={{ margin: '0 0 12px', fontSize: '13px', lineHeight: 1.5, color: '#555', fontFamily: "'Helvetica Neue', Arial, sans-serif", width: '100%', padding: '4px 6px', border: '1px solid #DDD', borderRadius: '4px', resize: 'vertical' }}
                              />
                            ) : (
                              <p style={{ margin: '0 0 12px', fontSize: '13px', lineHeight: 1.5, color: '#555', fontFamily: "'Helvetica Neue', Arial, sans-serif" }}>{step.description}</p>
                            )}
                            {/* Role involvement list */}
                            <div style={{ display: 'flex', flexDirection: 'column', gap: '4px', marginBottom: '10px' }}>
                              {(() => {
                                const involvedRoles = Object.entries(step.roleInvolvement || {})
                                  .filter(([roleId, inv]) => inv.timeMinutes > 0)
                                  .map(([roleId, inv]) => ({
                                    roleId,
                                    ...inv,
                                    persona: config.personas.find(p => p.id === roleId),
                                    isOwner: roleId === step.owner
                                  }))
                                  .sort((a, b) => {
                                    if (a.isOwner) return -1;
                                    if (b.isOwner) return 1;
                                    return b.timeMinutes - a.timeMinutes;
                                  });
                                
                                return involvedRoles.map((role, idx) => (
                                  <div key={role.roleId} style={{ display: 'inline-flex', alignItems: 'center', gap: '6px' }}>
                                    <span style={{ width: '8px', height: '8px', borderRadius: '50%', background: role.isOwner ? (role.persona?.color || '#666') : 'transparent', border: role.isOwner ? 'none' : `2px solid ${role.persona?.color || '#666'}`, boxSizing: 'border-box' }} />
                                    <span style={{ fontFamily: "'Helvetica Neue', Arial, sans-serif", fontSize: '11px', color: role.persona?.color || '#666', fontWeight: role.isOwner ? 600 : 400 }}>
                                      {role.persona?.label || role.roleId}
                                    </span>
                                    <span style={{ fontFamily: "'Helvetica Neue', Arial, sans-serif", fontSize: '10px', color: '#999' }}>
                                      {formatTime(role.timeMinutes)}{role.headcount > 1 ? ` Ã— ${role.headcount}` : ''}
                                    </span>
                                  </div>
                                ));
                              })()}
                            </div>
                            <div style={{ display: 'flex', gap: '8px', marginBottom: '8px', flexWrap: 'wrap' }}>
                              <div style={{ display: 'flex', alignItems: 'center', gap: '4px', padding: '4px 8px', background: frictionConfig[step.frictionScore || 3]?.bg || '#F5F5F5', borderRadius: '12px' }}>
                                <span style={{ fontSize: '10px' }}>{frictionConfig[step.frictionScore || 3]?.emoji || 'ðŸ˜•'}</span>
                                <div style={{ display: 'flex', gap: '2px' }}>
                                  {[1,2,3,4,5].map(n => (<div key={n} style={{ width: '6px', height: '6px', borderRadius: '1px', background: n <= (step.frictionScore || 3) ? frictionConfig[step.frictionScore || 3]?.color : '#DDD' }} />))}
                                </div>
                              </div>
                              <div style={{ display: 'flex', alignItems: 'center', gap: '4px', padding: '4px 8px', background: automationColors[step.automationOpportunity]?.bg || '#F5F5F5', borderRadius: '12px' }}>
                                <span style={{ fontSize: '10px' }}>ðŸ’¡</span>
                                <span style={{ fontFamily: "'Helvetica Neue', Arial, sans-serif", fontSize: '10px', color: automationColors[step.automationOpportunity]?.text || '#666', fontWeight: 500 }}>{automationColors[step.automationOpportunity]?.label || 'N/A'}</span>
                              </div>
                              {step.clientTouchpoint && (
                                <div style={{ display: 'flex', alignItems: 'center', gap: '4px', padding: '4px 8px', background: '#E6F4EA', borderRadius: '12px', border: '1px solid #2D5A4B' }}>
                                  <span style={{ fontSize: '10px' }}>ðŸ‘¤</span>
                                  <span style={{ fontFamily: "'Helvetica Neue', Arial, sans-serif", fontSize: '10px', color: '#2D5A4B', fontWeight: 500 }}>Client</span>
                                </div>
                              )}
                            </div>
                            {(() => {
                              const stepEmotions = Array.isArray(step.emotions) ? step.emotions : (step.emotions ? [step.emotions] : []);
                              return stepEmotions.length > 0 && (
                                <div style={{ display: 'flex', flexWrap: 'wrap', gap: '4px', marginBottom: '8px' }}>
                                  {stepEmotions.map(emotion => (
                                    <div key={emotion} style={{ display: 'inline-flex', alignItems: 'center', gap: '4px', padding: '4px 8px', background: emotionColors[emotion]?.bg || '#F5F5F5', borderRadius: '12px' }}>
                                      <span style={{ fontSize: '12px' }}>{emotionColors[emotion]?.icon || 'ðŸ˜'}</span>
                                      <span style={{ fontFamily: "'Helvetica Neue', Arial, sans-serif", fontSize: '10px', color: emotionColors[emotion]?.text || '#666', textTransform: 'capitalize', fontWeight: 500 }}>{emotion}</span>
                                    </div>
                                  ))}
                                </div>
                              );
                            })()}
                            {/* Spacer to push reg reqs and pain points to bottom */}
                            <div style={{ flex: 1 }} />
                            {/* Hard Checkpoint indicator */}
                            {step.isHardCheckpoint && (
                              <div 
                                className="tooltip" 
                                data-tooltip={step.checkpointDetails || 'Hard checkpoint - must be completed before proceeding'}
                                style={{ display: 'flex', alignItems: 'center', gap: '8px', padding: '10px 12px', background: '#FDF2F8', borderRadius: '6px', border: '2px solid #EC4899', marginBottom: '8px', cursor: 'help' }}
                              >
                                <span style={{ fontSize: '16px' }}>ðŸš§</span>
                                <div>
                                  <div style={{ fontFamily: "'Helvetica Neue', Arial, sans-serif", fontSize: '12px', color: '#BE185D', fontWeight: 600, textTransform: 'uppercase', letterSpacing: '0.5px' }}>Hard Checkpoint</div>
                                  <div style={{ fontFamily: "'Helvetica Neue', Arial, sans-serif", fontSize: '11px', color: '#9D174D', textTransform: 'capitalize' }}>{step.checkpointType || 'Compliance'}</div>
                                </div>
                              </div>
                            )}
                            {/* Reg requirements and Pain points at bottom */}
                            <div style={{ display: 'flex', flexDirection: 'column', gap: '6px' }}>
                              {step.regulatoryRequirements?.length > 0 && (
                                <div 
                                  className="tooltip" 
                                  data-tooltip={step.regulatoryRequirements.join(' â€¢ ')}
                                  style={{ display: 'flex', alignItems: 'center', gap: '6px', padding: '6px 10px', background: '#EEF2FF', borderRadius: '6px', cursor: 'help' }}
                                >
                                  <span style={{ fontSize: '12px' }}>ðŸ“‹</span>
                                  <span style={{ fontFamily: "'Helvetica Neue', Arial, sans-serif", fontSize: '11px', color: '#4338CA', fontWeight: 500 }}>{step.regulatoryRequirements.length} reg req{step.regulatoryRequirements.length > 1 ? 's' : ''}</span>
                                </div>
                              )}
                              {step.painPoints.length > 0 && (
                                <div 
                                  className="tooltip" 
                                  data-tooltip={step.painPoints.join(' â€¢ ')}
                                  style={{ display: 'flex', alignItems: 'center', gap: '6px', padding: '8px 12px', background: '#FEF3F2', borderRadius: '6px', border: '1px solid #FEE4E2', cursor: 'help' }}
                                >
                                  <span style={{ fontSize: '14px' }}>âš ï¸</span>
                                  <span style={{ fontFamily: "'Helvetica Neue', Arial, sans-serif", fontSize: '12px', color: '#B42318', fontWeight: 500 }}>{step.painPoints.length} pain point{step.painPoints.length > 1 ? 's' : ''}</span>
                                </div>
                              )}
                            </div>
                          </div>
                        );
                      })}
                    </div>
                  </div>
                );
                })
                }
                </>
              )}
            </div>

            {/* Selected Step Detail Panel - slide-out modal on desktop, inline on mobile */}
            {selectedStep && (
              <>
                {/* Overlay - desktop only */}
                {!isMobile && (
                  <div 
                    onClick={() => setSelectedStep(null)} 
                    style={{ 
                      position: 'fixed', 
                      top: 0, 
                      left: 0, 
                      right: 0, 
                      bottom: 0, 
                      background: 'rgba(0,0,0,0.3)', 
                      zIndex: 1999 
                    }} 
                  />
                )}
                {/* Panel */}
                <div className="no-print" style={ isMobile ? {
                  marginTop: '32px',
                  background: '#FFF', 
                  borderRadius: '12px',
                  boxShadow: '0 4px 24px rgba(0,0,0,0.08)',
                  overflow: 'hidden'
                } : { 
                  position: 'fixed', 
                  top: 0, 
                  right: 0, 
                  bottom: 0, 
                  width: '500px', 
                  maxWidth: '90vw',
                  background: '#FFF', 
                  boxShadow: '-4px 0 24px rgba(0,0,0,0.15)', 
                  zIndex: 2000,
                  display: 'flex',
                  flexDirection: 'column',
                  overflow: 'hidden'
                }}>
                <div style={{ background: `hsl(${(selectedStep.stageIndex || 0) * 45 + 180}, 35%, 40%)`, color: '#FFF', padding: isMobile ? '20px 24px' : '24px 32px', display: 'flex', justifyContent: 'space-between', alignItems: 'center', flexShrink: 0 }}>
                  <div>
                    <h2 style={{ margin: 0, fontSize: isMobile ? '20px' : '24px', fontWeight: 400 }}>{selectedStep.name}</h2>
                    <p style={{ margin: '8px 0 0', opacity: 0.7, fontFamily: "'Helvetica Neue', Arial, sans-serif", fontSize: '14px' }}>{selectedStep.description}</p>
                  </div>
                  <button onClick={() => setSelectedStep(null)} style={{ background: 'transparent', border: 'none', color: '#FFF', fontSize: '28px', cursor: 'pointer', opacity: 0.7, padding: '0 8px' }}>Ã—</button>
                </div>
                <div style={{ padding: isMobile ? '24px' : '32px', flex: isMobile ? 'none' : 1, overflowY: isMobile ? 'visible' : 'auto' }}>
                  <div style={{ display: 'flex', flexDirection: 'column', gap: '24px' }}>
                    <div style={{ display: 'grid', gridTemplateColumns: '1fr 1fr', gap: '16px' }}>
                      <div style={{ padding: '16px', background: '#F9FAFB', borderRadius: '8px' }}>
                        <label style={{ display: 'block', fontFamily: "'Helvetica Neue', Arial, sans-serif", fontSize: '11px', color: '#666', textTransform: 'uppercase', letterSpacing: '0.5px', marginBottom: '8px' }}>Time Required</label>
                        <span style={{ fontSize: '24px', fontWeight: 600 }}>{formatTime(selectedStep.timeMinutes)}</span>
                        {editMode && (
                          <div style={{ fontFamily: "'Helvetica Neue', Arial, sans-serif", fontSize: '10px', color: '#999', marginTop: '4px' }}>
                            Auto-calculated from roles below
                          </div>
                        )}
                      </div>
                      <div style={{ padding: '16px', background: '#F9FAFB', borderRadius: '8px' }}>
                        <label style={{ display: 'block', fontFamily: "'Helvetica Neue', Arial, sans-serif", fontSize: '11px', color: '#666', textTransform: 'uppercase', letterSpacing: '0.5px', marginBottom: '8px' }}>Primary Owner</label>
                        {editMode ? (
                          <select value={selectedStep.owner} onChange={(e) => { updateStep(selectedStep.stageId, selectedStep.id, { owner: e.target.value }); setSelectedStep(prev => ({ ...prev, owner: e.target.value })); }} style={{ width: '100%', padding: '8px', border: '1px solid #DDD', borderRadius: '4px', fontSize: '14px', background: '#FFF' }}>
                            {config.personas.map(p => (<option key={p.id} value={p.id}>{p.label}</option>))}
                          </select>
                        ) : (
                          <div style={{ display: 'flex', alignItems: 'center', gap: '8px' }}>
                            <span style={{ width: '12px', height: '12px', borderRadius: '50%', background: getPersonaColor(selectedStep.owner) }} />
                            <span style={{ fontSize: '16px', fontWeight: 500 }}>{config.personas.find(p => p.id === selectedStep.owner)?.label}</span>
                          </div>
                        )}
                      </div>
                    </div>
                    {/* Friction */}
                    <div style={{ padding: '16px', background: frictionConfig[selectedStep.frictionScore || 3]?.bg || '#F9FAFB', borderRadius: '8px', marginBottom: '16px', transition: 'background 0.2s' }}>
                      <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: '12px' }}>
                        <label style={{ fontFamily: "'Helvetica Neue', Arial, sans-serif", fontSize: '11px', color: '#666', textTransform: 'uppercase', letterSpacing: '0.5px' }}>Friction</label>
                        <div style={{ display: 'flex', alignItems: 'center', gap: '6px' }}>
                          <span style={{ fontSize: '18px' }}>{frictionConfig[selectedStep.frictionScore || 3]?.emoji}</span>
                          <span style={{ fontFamily: "'Helvetica Neue', Arial, sans-serif", fontSize: '12px', fontWeight: 600, color: frictionConfig[selectedStep.frictionScore || 3]?.color }}>{frictionConfig[selectedStep.frictionScore || 3]?.label}</span>
                        </div>
                      </div>
                      <div style={{ display: 'flex', gap: '8px' }}>
                        {[1,2,3,4,5].map(n => (
                          <button key={n} onClick={() => { if (editMode) { updateStep(selectedStep.stageId, selectedStep.id, { frictionScore: n }); setSelectedStep(prev => ({ ...prev, frictionScore: n })); }}} disabled={!editMode} style={{ width: '40px', height: '40px', border: '2px solid', borderColor: (selectedStep.frictionScore || 3) >= n ? frictionConfig[selectedStep.frictionScore || 3]?.color : '#E5E5E5', borderRadius: '8px', background: (selectedStep.frictionScore || 3) >= n ? frictionConfig[selectedStep.frictionScore || 3]?.color : '#FFF', color: (selectedStep.frictionScore || 3) >= n ? '#FFF' : '#333', cursor: editMode ? 'pointer' : 'default', fontWeight: 600, fontSize: '14px', transition: 'all 0.2s' }}>{n}</button>
                        ))}
                      </div>
                    </div>
                    {/* Improvement Opportunity */}
                    <div style={{ padding: '16px', background: '#F9FAFB', borderRadius: '8px', marginBottom: '16px' }}>
                      <label style={{ display: 'block', fontFamily: "'Helvetica Neue', Arial, sans-serif", fontSize: '11px', color: '#666', textTransform: 'uppercase', letterSpacing: '0.5px', marginBottom: '12px' }}>Improvement Opportunity</label>
                      {editMode ? (
                        <>
                          <div style={{ display: 'flex', gap: '8px', marginBottom: '12px' }}>
                            {['high', 'medium', 'low', 'none'].map(level => (
                              <button key={level} onClick={() => { updateStep(selectedStep.stageId, selectedStep.id, { automationOpportunity: level }); setSelectedStep(prev => ({ ...prev, automationOpportunity: level })); }} style={{ padding: '8px 16px', border: '2px solid', borderColor: selectedStep.automationOpportunity === level ? automationColors[level].text : '#E5E5E5', borderRadius: '20px', background: selectedStep.automationOpportunity === level ? automationColors[level].bg : '#FFF', color: selectedStep.automationOpportunity === level ? automationColors[level].text : '#666', cursor: 'pointer', fontFamily: "'Helvetica Neue', Arial, sans-serif", fontSize: '12px', fontWeight: 500, textTransform: 'capitalize' }}>{level}</button>
                            ))}
                          </div>
                          <textarea value={selectedStep.automationNotes || ''} onChange={(e) => { updateStep(selectedStep.stageId, selectedStep.id, { automationNotes: e.target.value }); setSelectedStep(prev => ({ ...prev, automationNotes: e.target.value })); }} placeholder="Notes on improvement potential..." style={{ width: '100%', padding: '10px', border: '1px solid #DDD', borderRadius: '6px', fontSize: '13px', fontFamily: "'Helvetica Neue', Arial, sans-serif", resize: 'vertical', minHeight: '60px' }} />
                        </>
                      ) : (
                        <>
                          <div style={{ display: 'inline-flex', alignItems: 'center', gap: '8px', padding: '8px 16px', background: automationColors[selectedStep.automationOpportunity]?.bg, borderRadius: '20px', marginBottom: selectedStep.automationNotes ? '12px' : 0 }}>
                            <span>ðŸ’¡</span>
                            <span style={{ fontFamily: "'Helvetica Neue', Arial, sans-serif", fontSize: '14px', color: automationColors[selectedStep.automationOpportunity]?.text, fontWeight: 500, textTransform: 'capitalize' }}>{selectedStep.automationOpportunity} potential</span>
                          </div>
                          {selectedStep.automationNotes && <p style={{ margin: 0, fontSize: '13px', color: '#666', fontFamily: "'Helvetica Neue', Arial, sans-serif", lineHeight: 1.5 }}>{selectedStep.automationNotes}</p>}
                        </>
                      )}
                    </div>
                    
                    {/* Client Touchpoint */}
                    <div style={{ padding: '16px', background: selectedStep.clientTouchpoint ? '#E6F4EA' : '#F9FAFB', borderRadius: '8px', marginBottom: '16px', border: selectedStep.clientTouchpoint ? '1px solid #2D5A4B' : '1px solid transparent' }}>
                      <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center' }}>
                        <div>
                          <label style={{ display: 'block', fontFamily: "'Helvetica Neue', Arial, sans-serif", fontSize: '11px', color: '#666', textTransform: 'uppercase', letterSpacing: '0.5px', marginBottom: '8px' }}>Client Touchpoint</label>
                          <div style={{ display: 'flex', alignItems: 'center', gap: '8px' }}>
                            <span style={{ fontSize: '16px' }}>{selectedStep.clientTouchpoint ? 'ðŸ‘¤' : 'ðŸ‘¤'}</span>
                            <span style={{ fontFamily: "'Helvetica Neue', Arial, sans-serif", fontSize: '13px', color: selectedStep.clientTouchpoint ? '#2D5A4B' : '#666', fontWeight: 500 }}>
                              {selectedStep.clientTouchpoint ? 'This step has direct client involvement' : 'This step DOES NOT have direct client involvement'}
                            </span>
                          </div>
                        </div>
                        {editMode && (
                          <button 
                            onClick={() => { 
                              const newValue = !selectedStep.clientTouchpoint;
                              updateStep(selectedStep.stageId, selectedStep.id, { clientTouchpoint: newValue }); 
                              setSelectedStep(prev => ({ ...prev, clientTouchpoint: newValue })); 
                            }} 
                            style={{ 
                              width: '60px', 
                              height: '32px', 
                              borderRadius: '16px', 
                              border: 'none',
                              background: selectedStep.clientTouchpoint ? '#2D5A4B' : '#CCC',
                              cursor: 'pointer',
                              position: 'relative',
                              transition: 'background 0.2s',
                              flexShrink: 0
                            }}
                          >
                            <div style={{
                              width: '26px',
                              height: '26px',
                              borderRadius: '50%',
                              background: '#FFF',
                              position: 'absolute',
                              top: '3px',
                              left: selectedStep.clientTouchpoint ? '31px' : '3px',
                              transition: 'left 0.2s',
                              boxShadow: '0 1px 3px rgba(0,0,0,0.2)'
                            }} />
                          </button>
                        )}
                      </div>
                    </div>
                    
                    {/* Cost Breakdown - only show when costs are enabled */}
                    {showCosts && (
                    <div style={{ padding: '16px', background: '#FFFBEB', borderRadius: '8px', marginBottom: '16px', border: '1px solid #FDE68A' }}>
                      <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'flex-start', marginBottom: '16px' }}>
                        <label style={{
                          display: 'block',
                          fontFamily: "'Helvetica Neue', Arial, sans-serif",
                          fontSize: '11px',
                          color: '#92400E',
                          textTransform: 'uppercase',
                          letterSpacing: '0.5px',
                          fontWeight: 600
                        }}>
                          ðŸ’° Cost Breakdown
                        </label>
                        <div style={{ textAlign: 'right' }}>
                          <div style={{
                            fontFamily: "'Helvetica Neue', Arial, sans-serif",
                            fontSize: '20px',
                            fontWeight: 700,
                            color: '#92400E'
                          }}>
                            {formatCurrency(calculateStepCost(selectedStep, config.personas))}
                          </div>
                          <div style={{
                            fontFamily: "'Helvetica Neue', Arial, sans-serif",
                            fontSize: '11px',
                            color: '#B45309'
                          }}>
                            {formatCurrencyDetailed(selectedStep.timeMinutes > 0 ? calculateStepCost(selectedStep, config.personas) / selectedStep.timeMinutes : 0)}/min
                          </div>
                        </div>
                      </div>
                      
                      {/* Potential Savings Banner */}
                      {selectedStep.automationOpportunity && selectedStep.automationOpportunity !== 'none' && (
                        <div style={{
                          background: 'linear-gradient(135deg, #D1FAE5 0%, #A7F3D0 100%)',
                          borderRadius: '8px',
                          padding: '12px 16px',
                          marginBottom: '16px',
                          display: 'flex',
                          alignItems: 'center',
                          justifyContent: 'space-between',
                          border: '1px solid #6EE7B7'
                        }}>
                          <div style={{ display: 'flex', alignItems: 'center', gap: '8px' }}>
                            <span style={{ fontSize: '20px' }}>ðŸŽ¯</span>
                            <div>
                              <div style={{ fontFamily: "'Helvetica Neue', Arial, sans-serif", fontSize: '12px', fontWeight: 600, color: '#065F46' }}>
                                Improvement Opportunity ({selectedStep.automationOpportunity})
                              </div>
                              <div style={{ fontFamily: "'Helvetica Neue', Arial, sans-serif", fontSize: '11px', color: '#047857' }}>
                                {selectedStep.automationOpportunity === 'high' ? '~70%' : selectedStep.automationOpportunity === 'medium' ? '~40%' : '~10%'} potential reduction
                              </div>
                            </div>
                          </div>
                          <div style={{ textAlign: 'right' }}>
                            <div style={{ fontFamily: "'Helvetica Neue', Arial, sans-serif", fontSize: '14px', fontWeight: 600, color: '#065F46', marginBottom: '2px' }}>
                              {formatTime(Math.round(selectedStep.timeMinutes * (selectedStep.automationOpportunity === 'high' ? 0.7 : selectedStep.automationOpportunity === 'medium' ? 0.4 : 0.1)))}
                            </div>
                            <div style={{ fontFamily: "'Helvetica Neue', Arial, sans-serif", fontSize: '18px', fontWeight: 700, color: '#065F46' }}>
                              {formatCurrency(
                                calculateStepCost(selectedStep, config.personas) * 
                                (selectedStep.automationOpportunity === 'high' ? 0.7 : selectedStep.automationOpportunity === 'medium' ? 0.4 : 0.1)
                              )} <span style={{ fontSize: '14px', opacity: 0.8 }}>({selectedStep.automationOpportunity === 'high' ? '70' : selectedStep.automationOpportunity === 'medium' ? '40' : '10'}%)</span>
                            </div>
                            <div style={{ fontFamily: "'Helvetica Neue', Arial, sans-serif", fontSize: '10px', color: '#047857' }}>potential savings</div>
                          </div>
                        </div>
                      )}
                      
                      {/* Labour Costs Section */}
                      <div style={{ marginBottom: '16px' }}>
                        <div style={{ fontFamily: "'Helvetica Neue', Arial, sans-serif", fontSize: '10px', color: '#92400E', textTransform: 'uppercase', letterSpacing: '0.5px', marginBottom: '8px', fontWeight: 600 }}>
                          ðŸ‘¤ Labour Costs ({formatCurrency(calculateStepLabourCost(selectedStep, config.personas))})
                        </div>
                        <div style={{ display: 'flex', flexDirection: 'column', gap: '8px' }}>
                          {config.personas.filter(p => !p.isExternal).map(persona => {
                            const involvement = selectedStep.roleInvolvement?.[persona.id] || { timeMinutes: 0, headcount: 1 };
                            const fullyLoadedRate = calculateFullyLoadedRate(persona);
                            const roleCost = (involvement.timeMinutes / 60) * fullyLoadedRate * (involvement.headcount || 1);
                            
                            if (!editMode && involvement.timeMinutes === 0) return null;
                            
                            return (
                              <div key={persona.id} style={{
                                display: 'flex',
                                alignItems: 'center',
                                gap: '12px',
                                padding: '12px',
                                background: '#FFF',
                                borderRadius: '6px',
                                borderLeft: `3px solid ${persona.color}`
                              }}>
                                <div style={{ flex: 1, minWidth: '100px' }}>
                                  <div style={{
                                    fontFamily: "'Helvetica Neue', Arial, sans-serif",
                                    fontSize: '12px',
                                    fontWeight: 600,
                                    color: persona.color
                                  }}>
                                    {persona.label}
                                  </div>
                                  <div style={{
                                    fontFamily: "'Helvetica Neue', Arial, sans-serif",
                                    fontSize: '10px',
                                    color: '#999'
                                  }}>
                                    {formatCurrencyDetailed(fullyLoadedRate)}/hr (loaded)
                                  </div>
                                </div>
                                
                                {editMode ? (
                                  <>
                                    <div style={{ display: 'flex', flexDirection: 'column', alignItems: 'center', gap: '2px' }}>
                                      <span style={{ fontFamily: "'Helvetica Neue', Arial, sans-serif", fontSize: '9px', color: '#999', textTransform: 'uppercase' }}>Mins</span>
                                      <input
                                        type="number"
                                        value={involvement.timeMinutes || 0}
                                        onChange={(e) => {
                                          const newVal = parseInt(e.target.value) || 0;
                                          updateRoleInvolvement(selectedStep.stageId, selectedStep.id, persona.id, 'timeMinutes', newVal);
                                          setSelectedStep(prev => {
                                            const newRoleInvolvement = {
                                              ...(prev.roleInvolvement || {}),
                                              [persona.id]: { ...involvement, timeMinutes: newVal }
                                            };
                                            const totalTime = Object.values(newRoleInvolvement).reduce(
                                              (sum, inv) => sum + (inv.timeMinutes || 0), 0
                                            );
                                            return {
                                              ...prev,
                                              roleInvolvement: newRoleInvolvement,
                                              timeMinutes: totalTime
                                            };
                                          });
                                        }}
                                        style={{
                                          width: '60px',
                                          padding: '6px',
                                          border: '1px solid #DDD',
                                          borderRadius: '4px',
                                          fontSize: '12px',
                                          textAlign: 'center'
                                        }}
                                      />
                                    </div>
                                    <div style={{ display: 'flex', flexDirection: 'column', alignItems: 'center', gap: '2px' }}>
                                      <span style={{ fontFamily: "'Helvetica Neue', Arial, sans-serif", fontSize: '9px', color: '#999', textTransform: 'uppercase' }}>People</span>
                                      <input
                                        type="number"
                                        min="1"
                                        value={involvement.headcount || 1}
                                        onChange={(e) => {
                                          const newVal = parseInt(e.target.value) || 1;
                                          updateRoleInvolvement(selectedStep.stageId, selectedStep.id, persona.id, 'headcount', newVal);
                                          setSelectedStep(prev => ({
                                            ...prev,
                                            roleInvolvement: {
                                              ...(prev.roleInvolvement || {}),
                                              [persona.id]: { ...involvement, headcount: newVal }
                                            }
                                          }));
                                        }}
                                        style={{
                                          width: '50px',
                                          padding: '6px',
                                          border: '1px solid #DDD',
                                          borderRadius: '4px',
                                          fontSize: '12px',
                                          textAlign: 'center'
                                        }}
                                      />
                                    </div>
                                  </>
                                ) : (
                                  <>
                                    <div style={{ fontFamily: "'Helvetica Neue', Arial, sans-serif", fontSize: '12px', color: '#666' }}>
                                      {involvement.timeMinutes}m Ã— {involvement.headcount || 1} {(involvement.headcount || 1) > 1 ? 'people' : 'person'}
                                    </div>
                                  </>
                                )}
                                
                                <div style={{
                                  fontFamily: "'Helvetica Neue', Arial, sans-serif",
                                  fontSize: '14px',
                                  fontWeight: 600,
                                  color: '#92400E',
                                  minWidth: '60px',
                                  textAlign: 'right'
                                }}>
                                  {formatCurrency(roleCost)}
                                </div>
                              </div>
                            );
                          })}
                        </div>
                      </div>
                      
                      {/* Additional Costs Section (Third-party, Materials) */}
                      <div>
                        <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: '8px' }}>
                          <div style={{ fontFamily: "'Helvetica Neue', Arial, sans-serif", fontSize: '10px', color: '#92400E', textTransform: 'uppercase', letterSpacing: '0.5px', fontWeight: 600 }}>
                            ðŸ“¦ Additional Costs ({formatCurrency(calculateStepAdditionalCosts(selectedStep))})
                          </div>
                          {editMode && (
                            <button
                              onClick={() => {
                                const newCost = { id: generateId(), description: 'New cost', amount: 0, category: 'third-party' };
                                const newCosts = [...(selectedStep.additionalCosts || []), newCost];
                                updateStep(selectedStep.stageId, selectedStep.id, { additionalCosts: newCosts });
                                setSelectedStep(prev => ({ ...prev, additionalCosts: newCosts }));
                              }}
                              style={{ padding: '4px 10px', background: '#92400E', color: '#FFF', border: 'none', borderRadius: '4px', cursor: 'pointer', fontFamily: "'Helvetica Neue', Arial, sans-serif", fontSize: '11px' }}
                            >
                              + Add Cost
                            </button>
                          )}
                        </div>
                        
                        {(!selectedStep.additionalCosts || selectedStep.additionalCosts.length === 0) && !editMode ? (
                          <div style={{ padding: '12px', background: '#FFF', borderRadius: '6px', fontFamily: "'Helvetica Neue', Arial, sans-serif", fontSize: '12px', color: '#999', fontStyle: 'italic' }}>
                            No additional costs
                          </div>
                        ) : (
                          <div style={{ display: 'flex', flexDirection: 'column', gap: '8px' }}>
                            {(selectedStep.additionalCosts || []).map((cost, index) => (
                              <div key={cost.id || index} style={{
                                display: 'flex',
                                alignItems: 'center',
                                gap: '12px',
                                padding: '12px',
                                background: '#FFF',
                                borderRadius: '6px',
                                borderLeft: '3px solid #6B7280'
                              }}>
                                {editMode ? (
                                  <>
                                    <select
                                      value={cost.category || 'third-party'}
                                      onChange={(e) => {
                                        const newCosts = [...(selectedStep.additionalCosts || [])];
                                        newCosts[index] = { ...cost, category: e.target.value };
                                        updateStep(selectedStep.stageId, selectedStep.id, { additionalCosts: newCosts });
                                        setSelectedStep(prev => ({ ...prev, additionalCosts: newCosts }));
                                      }}
                                      style={{ padding: '6px', border: '1px solid #DDD', borderRadius: '4px', fontSize: '11px', fontFamily: "'Helvetica Neue', Arial, sans-serif" }}
                                    >
                                      <option value="third-party">ðŸ”Œ Third-party</option>
                                      <option value="materials">ðŸ“„ Materials</option>
                                      <option value="other">ðŸ“Ž Other</option>
                                    </select>
                                    <input
                                      type="text"
                                      value={cost.description}
                                      onChange={(e) => {
                                        const newCosts = [...(selectedStep.additionalCosts || [])];
                                        newCosts[index] = { ...cost, description: e.target.value };
                                        updateStep(selectedStep.stageId, selectedStep.id, { additionalCosts: newCosts });
                                        setSelectedStep(prev => ({ ...prev, additionalCosts: newCosts }));
                                      }}
                                      placeholder="Description"
                                      style={{ flex: 1, padding: '6px', border: '1px solid #DDD', borderRadius: '4px', fontSize: '12px', fontFamily: "'Helvetica Neue', Arial, sans-serif" }}
                                    />
                                    <div style={{ display: 'flex', alignItems: 'center', gap: '4px' }}>
                                      <span style={{ fontFamily: "'Helvetica Neue', Arial, sans-serif", fontSize: '12px', color: '#666' }}>Â£</span>
                                      <input
                                        type="number"
                                        step="0.01"
                                        value={cost.amount || ''}
                                        onChange={(e) => {
                                          const newCosts = [...(selectedStep.additionalCosts || [])];
                                          newCosts[index] = { ...cost, amount: parseFloat(e.target.value) || 0 };
                                          updateStep(selectedStep.stageId, selectedStep.id, { additionalCosts: newCosts });
                                          setSelectedStep(prev => ({ ...prev, additionalCosts: newCosts }));
                                        }}
                                        style={{ width: '70px', padding: '6px', border: '1px solid #DDD', borderRadius: '4px', fontSize: '12px', textAlign: 'right' }}
                                      />
                                    </div>
                                    <button
                                      onClick={() => {
                                        const newCosts = (selectedStep.additionalCosts || []).filter((_, i) => i !== index);
                                        updateStep(selectedStep.stageId, selectedStep.id, { additionalCosts: newCosts });
                                        setSelectedStep(prev => ({ ...prev, additionalCosts: newCosts }));
                                      }}
                                      style={{ width: '24px', height: '24px', borderRadius: '50%', border: 'none', background: '#FEE2E2', color: '#B42318', cursor: 'pointer', fontSize: '14px', display: 'flex', alignItems: 'center', justifyContent: 'center' }}
                                    >Ã—</button>
                                  </>
                                ) : (
                                  <>
                                    <span style={{ fontSize: '14px' }}>
                                      {cost.category === 'materials' ? 'ðŸ“„' : cost.category === 'other' ? 'ðŸ“Ž' : 'ðŸ”Œ'}
                                    </span>
                                    <div style={{ flex: 1, fontFamily: "'Helvetica Neue', Arial, sans-serif", fontSize: '12px', color: '#374151' }}>
                                      {cost.description}
                                    </div>
                                    <div style={{ fontFamily: "'Helvetica Neue', Arial, sans-serif", fontSize: '14px', fontWeight: 600, color: '#92400E' }}>
                                      {formatCurrency(cost.amount)}
                                    </div>
                                  </>
                                )}
                              </div>
                            ))}
                          </div>
                        )}
                      </div>
                    </div>
                    )}

                    {/* Pain Points */}
                    <div style={{ marginBottom: '24px' }}>
                      <label style={{ display: 'block', fontFamily: "'Helvetica Neue', Arial, sans-serif", fontSize: '11px', color: '#666', textTransform: 'uppercase', letterSpacing: '0.5px', marginBottom: '12px' }}>Pain Points</label>
                      {selectedStep.painPoints.length === 0 && !editMode ? (
                        <p style={{ color: '#999', fontStyle: 'italic', fontFamily: "'Helvetica Neue', Arial, sans-serif", fontSize: '14px' }}>No pain points identified</p>
                      ) : (
                        <ul style={{ margin: 0, padding: 0, listStyle: 'none' }}>
                          {selectedStep.painPoints.map((pp, i) => (
                            <li key={i} style={{ display: 'flex', alignItems: 'flex-start', gap: '12px', padding: '12px', background: '#FEF3F2', borderRadius: '6px', marginBottom: '8px', fontFamily: "'Helvetica Neue', Arial, sans-serif", fontSize: '14px', color: '#B42318' }}>
                              <span>âš ï¸</span>
                              <span style={{ flex: 1 }}>{pp}</span>
                              {editMode && <button onClick={(e) => { e.stopPropagation(); removePainPoint(selectedStep.stageId, selectedStep.id, i); setSelectedStep(prev => ({ ...prev, painPoints: prev.painPoints.filter((_, idx) => idx !== i) })); }} style={{ background: 'none', border: 'none', color: '#B42318', cursor: 'pointer', fontSize: '16px' }}>Ã—</button>}
                            </li>
                          ))}
                        </ul>
                      )}
                      {editMode && (
                        <div style={{ marginTop: '12px', display: 'flex', gap: '8px' }}>
                          <input type="text" placeholder="Add a pain point..." id="new-pain-point" style={{ flex: 1, padding: '10px 12px', border: '1px solid #DDD', borderRadius: '6px', fontSize: '14px', fontFamily: "'Helvetica Neue', Arial, sans-serif" }} onKeyDown={(e) => { if (e.key === 'Enter' && e.target.value.trim()) { const val = e.target.value.trim(); addPainPoint(selectedStep.stageId, selectedStep.id, val); setSelectedStep(prev => ({ ...prev, painPoints: [...prev.painPoints, val] })); e.target.value = ''; }}} />
                          <button onClick={() => { const input = document.getElementById('new-pain-point'); if (input.value.trim()) { const val = input.value.trim(); addPainPoint(selectedStep.stageId, selectedStep.id, val); setSelectedStep(prev => ({ ...prev, painPoints: [...prev.painPoints, val] })); input.value = ''; }}} style={{ padding: '10px 20px', background: '#B42318', color: '#FFF', border: 'none', borderRadius: '6px', cursor: 'pointer', fontFamily: "'Helvetica Neue', Arial, sans-serif", fontSize: '13px' }}>Add</button>
                        </div>
                      )}
                    </div>
                    {/* Hard Checkpoint */}
                    <div style={{ marginBottom: '24px' }}>
                      <label style={{ display: 'block', fontFamily: "'Helvetica Neue', Arial, sans-serif", fontSize: '11px', color: '#666', textTransform: 'uppercase', letterSpacing: '0.5px', marginBottom: '12px' }}>Hard Checkpoint</label>
                      {editMode ? (
                        <div style={{ display: 'flex', flexDirection: 'column', gap: '12px' }}>
                          <label style={{ display: 'flex', alignItems: 'center', gap: '12px', cursor: 'pointer' }}>
                            <input 
                              type="checkbox" 
                              checked={selectedStep.isHardCheckpoint || false} 
                              onChange={(e) => { 
                                updateStep(selectedStep.stageId, selectedStep.id, { isHardCheckpoint: e.target.checked }); 
                                setSelectedStep(prev => ({ ...prev, isHardCheckpoint: e.target.checked })); 
                              }}
                              style={{ width: '20px', height: '20px', accentColor: '#EC4899' }}
                            />
                            <span style={{ fontFamily: "'Helvetica Neue', Arial, sans-serif", fontSize: '14px' }}>This step is a hard checkpoint</span>
                          </label>
                          {selectedStep.isHardCheckpoint && (
                            <>
                              <div>
                                <label style={{ display: 'block', fontFamily: "'Helvetica Neue', Arial, sans-serif", fontSize: '12px', color: '#666', marginBottom: '6px' }}>Checkpoint Type</label>
                                <select 
                                  value={selectedStep.checkpointType || 'compliance'} 
                                  onChange={(e) => { 
                                    updateStep(selectedStep.stageId, selectedStep.id, { checkpointType: e.target.value }); 
                                    setSelectedStep(prev => ({ ...prev, checkpointType: e.target.value })); 
                                  }}
                                  style={{ width: '100%', padding: '10px 12px', border: '1px solid #DDD', borderRadius: '6px', fontSize: '14px', fontFamily: "'Helvetica Neue', Arial, sans-serif" }}
                                >
                                  <option value="compliance">Compliance</option>
                                  <option value="regulatory">Regulatory</option>
                                  <option value="vetting">Vetting</option>
                                  <option value="approval">Approval</option>
                                  <option value="verification">Verification</option>
                                </select>
                              </div>
                              <div>
                                <label style={{ display: 'block', fontFamily: "'Helvetica Neue', Arial, sans-serif", fontSize: '12px', color: '#666', marginBottom: '6px' }}>Checkpoint Requirements</label>
                                <textarea 
                                  value={selectedStep.checkpointDetails || ''} 
                                  onChange={(e) => { 
                                    updateStep(selectedStep.stageId, selectedStep.id, { checkpointDetails: e.target.value }); 
                                    setSelectedStep(prev => ({ ...prev, checkpointDetails: e.target.value })); 
                                  }}
                                  placeholder="Describe what must be verified or completed at this checkpoint..."
                                  style={{ width: '100%', minHeight: '80px', padding: '10px 12px', border: '1px solid #DDD', borderRadius: '6px', fontSize: '14px', fontFamily: "'Helvetica Neue', Arial, sans-serif", resize: 'vertical' }}
                                />
                              </div>
                            </>
                          )}
                        </div>
                      ) : selectedStep.isHardCheckpoint ? (
                        <div style={{ padding: '16px', background: '#FDF2F8', borderRadius: '8px', border: '2px solid #EC4899' }}>
                          <div style={{ display: 'flex', alignItems: 'center', gap: '10px', marginBottom: '8px' }}>
                            <span style={{ fontSize: '20px' }}>ðŸš§</span>
                            <span style={{ fontFamily: "'Helvetica Neue', Arial, sans-serif", fontSize: '14px', color: '#BE185D', fontWeight: 600, textTransform: 'uppercase' }}>{selectedStep.checkpointType || 'Compliance'} Checkpoint</span>
                          </div>
                          <p style={{ margin: 0, fontSize: '14px', lineHeight: 1.6, fontFamily: "'Helvetica Neue', Arial, sans-serif", color: '#9D174D' }}>{selectedStep.checkpointDetails || 'No details specified'}</p>
                        </div>
                      ) : (
                        <p style={{ color: '#999', fontStyle: 'italic', fontFamily: "'Helvetica Neue', Arial, sans-serif", fontSize: '14px' }}>No hard checkpoint set for this step</p>
                      )}
                    </div>
                    {/* Regulatory */}
                    <div>
                      <label style={{ display: 'block', fontFamily: "'Helvetica Neue', Arial, sans-serif", fontSize: '11px', color: '#666', textTransform: 'uppercase', letterSpacing: '0.5px', marginBottom: '12px' }}>Regulatory Requirements</label>
                      {(!selectedStep.regulatoryRequirements || selectedStep.regulatoryRequirements.length === 0) && !editMode ? (
                        <p style={{ color: '#999', fontStyle: 'italic', fontFamily: "'Helvetica Neue', Arial, sans-serif", fontSize: '14px' }}>No regulatory requirements specified</p>
                      ) : (
                        <ul style={{ margin: 0, padding: 0, listStyle: 'none' }}>
                          {(selectedStep.regulatoryRequirements || []).map((req, i) => (
                            <li key={i} style={{ display: 'flex', alignItems: 'flex-start', gap: '12px', padding: '12px', background: '#EEF2FF', borderRadius: '6px', marginBottom: '8px', fontFamily: "'Helvetica Neue', Arial, sans-serif", fontSize: '14px', color: '#4338CA' }}>
                              <span>ðŸ“‹</span>
                              <span style={{ flex: 1 }}>{req}</span>
                              {editMode && <button onClick={(e) => { e.stopPropagation(); removeRegRequirement(selectedStep.stageId, selectedStep.id, i); setSelectedStep(prev => ({ ...prev, regulatoryRequirements: prev.regulatoryRequirements.filter((_, idx) => idx !== i) })); }} style={{ background: 'none', border: 'none', color: '#4338CA', cursor: 'pointer', fontSize: '16px' }}>Ã—</button>}
                            </li>
                          ))}
                        </ul>
                      )}
                      {editMode && (
                        <div style={{ marginTop: '12px', display: 'flex', gap: '8px' }}>
                          <input type="text" placeholder="Add a regulatory requirement..." id="new-reg-req" style={{ flex: 1, padding: '10px 12px', border: '1px solid #DDD', borderRadius: '6px', fontSize: '14px', fontFamily: "'Helvetica Neue', Arial, sans-serif" }} onKeyDown={(e) => { if (e.key === 'Enter' && e.target.value.trim()) { const val = e.target.value.trim(); addRegRequirement(selectedStep.stageId, selectedStep.id, val); setSelectedStep(prev => ({ ...prev, regulatoryRequirements: [...(prev.regulatoryRequirements || []), val] })); e.target.value = ''; }}} />
                          <button onClick={() => { const input = document.getElementById('new-reg-req'); if (input.value.trim()) { const val = input.value.trim(); addRegRequirement(selectedStep.stageId, selectedStep.id, val); setSelectedStep(prev => ({ ...prev, regulatoryRequirements: [...(prev.regulatoryRequirements || []), val] })); input.value = ''; }}} style={{ padding: '10px 20px', background: '#4338CA', color: '#FFF', border: 'none', borderRadius: '6px', cursor: 'pointer', fontFamily: "'Helvetica Neue', Arial, sans-serif", fontSize: '13px' }}>Add</button>
                        </div>
                      )}
                    </div>
                    {/* Actions by Role */}
                    <div>
                    <label style={{ display: 'block', fontFamily: "'Helvetica Neue', Arial, sans-serif", fontSize: '11px', color: '#666', textTransform: 'uppercase', letterSpacing: '0.5px', marginBottom: '16px' }}>Actions by Role</label>
                    <div style={{ display: 'flex', flexDirection: 'column', gap: '12px' }}>
                      {config.personas.map(persona => {
                        const action = selectedStep.actions?.[persona.id];
                        if (!action && !editMode) return null;
                        return (
                          <div key={persona.id} style={{ padding: '16px', background: '#F9FAFB', borderRadius: '8px', borderLeft: `4px solid ${persona.color}` }}>
                            <div style={{ fontFamily: "'Helvetica Neue', Arial, sans-serif", fontSize: '12px', color: persona.color, fontWeight: 600, marginBottom: '8px', textTransform: 'uppercase', letterSpacing: '0.5px' }}>{persona.label}</div>
                            {editMode ? (
                              <textarea value={action || ''} onChange={(e) => { const newActions = { ...(selectedStep.actions || {}), [persona.id]: e.target.value }; updateStep(selectedStep.stageId, selectedStep.id, { actions: newActions }); setSelectedStep(prev => ({ ...prev, actions: newActions })); }} placeholder={`What does the ${persona.label.toLowerCase()} do?`} style={{ width: '100%', minHeight: '60px', padding: '8px', border: '1px solid #DDD', borderRadius: '4px', fontSize: '14px', fontFamily: "'Helvetica Neue', Arial, sans-serif", resize: 'vertical' }} />
                            ) : (
                              <p style={{ margin: 0, fontSize: '14px', lineHeight: 1.5, fontFamily: "'Helvetica Neue', Arial, sans-serif" }}>{action}</p>
                            )}
                          </div>
                        );
                      })}
                    </div>
                    </div>
                    {/* Touchpoints */}
                    <div style={{ marginTop: '24px' }}>
                      <label style={{ display: 'block', fontFamily: "'Helvetica Neue', Arial, sans-serif", fontSize: '11px', color: '#666', textTransform: 'uppercase', letterSpacing: '0.5px', marginBottom: '12px' }}>Touchpoints</label>
                      <div style={{ display: 'flex', flexWrap: 'wrap', gap: '8px' }}>
                        {(selectedStep.touchpoints || []).map((tp, i) => (
                          <span key={i} style={{ padding: '6px 12px', background: '#E8E8E8', borderRadius: '16px', fontFamily: "'Helvetica Neue', Arial, sans-serif", fontSize: '13px', display: 'flex', alignItems: 'center', gap: '6px' }}>
                            {tp}
                            {editMode && (
                              <button 
                                onClick={() => { 
                                  const newTouchpoints = selectedStep.touchpoints.filter((_, idx) => idx !== i);
                                  updateStep(selectedStep.stageId, selectedStep.id, { touchpoints: newTouchpoints }); 
                                  setSelectedStep(prev => ({ ...prev, touchpoints: newTouchpoints })); 
                                }} 
                                style={{ background: 'none', border: 'none', color: '#666', cursor: 'pointer', fontSize: '14px', padding: '0 0 0 2px', lineHeight: 1 }}
                              >Ã—</button>
                            )}
                          </span>
                        ))}
                      </div>
                      {editMode && (
                        <div style={{ marginTop: '12px', display: 'flex', gap: '8px' }}>
                          <input 
                            type="text" 
                            placeholder="Add a touchpoint..." 
                            id="new-touchpoint" 
                            style={{ flex: 1, padding: '8px 12px', border: '1px solid #DDD', borderRadius: '6px', fontSize: '13px', fontFamily: "'Helvetica Neue', Arial, sans-serif" }} 
                            onKeyDown={(e) => { 
                              if (e.key === 'Enter' && e.target.value.trim()) { 
                                const val = e.target.value.trim(); 
                                const newTouchpoints = [...(selectedStep.touchpoints || []), val];
                                updateStep(selectedStep.stageId, selectedStep.id, { touchpoints: newTouchpoints }); 
                                setSelectedStep(prev => ({ ...prev, touchpoints: newTouchpoints })); 
                                e.target.value = ''; 
                              }
                            }} 
                          />
                          <button 
                            onClick={() => { 
                              const input = document.getElementById('new-touchpoint'); 
                              if (input.value.trim()) { 
                                const val = input.value.trim(); 
                                const newTouchpoints = [...(selectedStep.touchpoints || []), val];
                                updateStep(selectedStep.stageId, selectedStep.id, { touchpoints: newTouchpoints }); 
                                setSelectedStep(prev => ({ ...prev, touchpoints: newTouchpoints })); 
                                input.value = ''; 
                              }
                            }} 
                            style={{ padding: '8px 16px', background: '#666', color: '#FFF', border: 'none', borderRadius: '6px', cursor: 'pointer', fontFamily: "'Helvetica Neue', Arial, sans-serif", fontSize: '13px' }}
                          >Add</button>
                        </div>
                      )}
                    </div>
                    {/* Emotion */}
                    <div style={{ marginTop: '24px' }}>
                      <label style={{ display: 'block', fontFamily: "'Helvetica Neue', Arial, sans-serif", fontSize: '11px', color: '#666', textTransform: 'uppercase', letterSpacing: '0.5px', marginBottom: '12px' }}>Client Emotions <span style={{ fontWeight: 400, textTransform: 'none' }}>(select multiple)</span></label>
                      {editMode ? (
                        <div style={{ display: 'flex', flexWrap: 'wrap', gap: '8px' }}>
                          {Object.entries(emotionColors).map(([emotion, colors]) => {
                            const currentEmotions = Array.isArray(selectedStep.emotions) ? selectedStep.emotions : (selectedStep.emotions ? [selectedStep.emotions] : []);
                            const isSelected = currentEmotions.includes(emotion);
                            return (
                              <button key={emotion} onClick={() => { 
                                const newEmotions = isSelected 
                                  ? currentEmotions.filter(e => e !== emotion)
                                  : [...currentEmotions, emotion];
                                updateStep(selectedStep.stageId, selectedStep.id, { emotions: newEmotions }); 
                                setSelectedStep(prev => ({ ...prev, emotions: newEmotions })); 
                              }} style={{ padding: '8px 14px', background: isSelected ? colors.bg : '#F5F5F5', border: '2px solid', borderColor: isSelected ? colors.text : 'transparent', borderRadius: '20px', cursor: 'pointer', display: 'flex', alignItems: 'center', gap: '6px' }}>
                                <span>{colors.icon}</span>
                                <span style={{ fontFamily: "'Helvetica Neue', Arial, sans-serif", fontSize: '12px', color: isSelected ? colors.text : '#666', textTransform: 'capitalize' }}>{emotion}</span>
                              </button>
                            );
                          })}
                        </div>
                      ) : (
                        <div style={{ display: 'flex', flexWrap: 'wrap', gap: '8px' }}>
                          {(() => {
                            const displayEmotions = Array.isArray(selectedStep.emotions) ? selectedStep.emotions : (selectedStep.emotions ? [selectedStep.emotions] : []);
                            return displayEmotions.length > 0 ? displayEmotions.map(emotion => (
                              <div key={emotion} style={{ display: 'inline-flex', alignItems: 'center', gap: '8px', padding: '10px 16px', background: emotionColors[emotion]?.bg || '#F5F5F5', borderRadius: '20px' }}>
                                <span style={{ fontSize: '18px' }}>{emotionColors[emotion]?.icon || 'ðŸ˜'}</span>
                                <span style={{ fontFamily: "'Helvetica Neue', Arial, sans-serif", fontSize: '14px', color: emotionColors[emotion]?.text || '#666', textTransform: 'capitalize', fontWeight: 500 }}>{emotion}</span>
                              </div>
                            )) : (
                              <div style={{ display: 'inline-flex', alignItems: 'center', gap: '8px', padding: '10px 16px', background: '#F5F5F5', borderRadius: '20px' }}>
                                <span style={{ fontSize: '18px' }}>ðŸ˜</span>
                                <span style={{ fontFamily: "'Helvetica Neue', Arial, sans-serif", fontSize: '14px', color: '#666', fontWeight: 500 }}>No emotion set</span>
                              </div>
                            );
                          })()}
                        </div>
                      )}
                    </div>
                  </div>
                </div>
              </div>
              </>
            )}
          </main>

          {/* Footer */}
          <footer style={{ background: '#1A1A1A', color: '#999', padding: '20px 40px', fontFamily: "'Helvetica Neue', Arial, sans-serif", fontSize: '12px', display: 'flex', justifyContent: 'space-between', alignItems: 'center', flexShrink: 0 }}>
            <span>{isMultiUserMode ? `${mapTitle} Â· ` : "Steve's Journey Map "}v{APP_VERSION}</span>
            <div style={{ display: 'flex', alignItems: 'center', gap: '16px' }}>
              <button 
                onClick={refreshFromPublicGitHub}
                disabled={refreshStatus.loading}
                style={{ 
                  background: 'transparent', 
                  border: '1px solid #666', 
                  borderRadius: '4px', 
                  padding: '4px 12px', 
                  color: refreshStatus.message ? (refreshStatus.message.includes('âœ“') ? '#4ADE80' : refreshStatus.message.includes('âœ—') ? '#F87171' : '#999') : '#999', 
                  cursor: refreshStatus.loading ? 'wait' : 'pointer', 
                  fontFamily: "'Helvetica Neue', Arial, sans-serif", 
                  fontSize: '11px',
                  display: 'flex',
                  alignItems: 'center',
                  gap: '6px',
                  transition: 'all 0.2s'
                }}
                onMouseOver={(e) => !refreshStatus.loading && (e.currentTarget.style.borderColor = '#999', e.currentTarget.style.color = '#CCC')}
                onMouseOut={(e) => (e.currentTarget.style.borderColor = '#666', e.currentTarget.style.color = refreshStatus.message ? (refreshStatus.message.includes('âœ“') ? '#4ADE80' : '#F87171') : '#999')}
              >
                <span className={refreshStatus.loading ? 'refresh-spinning' : ''}>ðŸ”„</span>
                {refreshStatus.loading ? 'Refreshing...' : refreshStatus.message || 'Refresh Data'}
              </button>
              <span>Last updated: {new Date(config.meta?.lastUpdated || new Date()).toLocaleDateString('en-GB')}</span>
            </div>
          </footer>

          {/* Modals */}
          {/* Timeline Modal - desktop only */}
          {!isMobile && showTimeline && (
            <div style={{ position: 'fixed', top: 0, left: 0, right: 0, bottom: 0, background: 'rgba(0,0,0,0.5)', display: 'flex', alignItems: 'center', justifyContent: 'center', zIndex: 3000, padding: '40px' }} onClick={() => setShowTimeline(false)}>
              <div onClick={(e) => e.stopPropagation()} style={{ background: '#FFF', borderRadius: '12px', maxWidth: '1400px', width: '100%', maxHeight: '90vh', overflow: 'auto', boxShadow: '0 20px 60px rgba(0,0,0,0.3)' }}>
                <Timeline stages={config.stages} totalTime={totalTime} formatTime={formatTime} personas={config.personas} onClose={() => setShowTimeline(false)} showCosts={showCosts} />
              </div>
            </div>
          )}
          
          {/* Cost Analysis Modal - desktop only */}
          {!isMobile && showCostAnalysis && (
            <div style={{ position: 'fixed', top: 0, left: 0, right: 0, bottom: 0, background: 'rgba(0,0,0,0.5)', display: 'flex', alignItems: 'center', justifyContent: 'center', zIndex: 3000, padding: '40px' }} onClick={() => setShowCostAnalysis(false)}>
              <div onClick={(e) => e.stopPropagation()} style={{ background: '#FFF', borderRadius: '12px', maxWidth: '1400px', width: '100%', maxHeight: '90vh', overflow: 'auto', boxShadow: '0 20px 60px rgba(0,0,0,0.3)' }}>
                <CostAnalysisPanel stages={config.stages} personas={config.personas} formatTime={formatTime} onClose={() => setShowCostAnalysis(false)} />
              </div>
            </div>
          )}
          
          {showAddStage && <AddStageModal onAdd={addStage} onClose={() => setShowAddStage(false)} />}
          {addStepTo && <AddStepModal stageId={addStepTo.id} stageName={addStepTo.name} personas={config.personas} onAdd={addStep} onClose={() => setAddStepTo(null)} />}
          {showSalarySettings && <SalarySettingsModal personas={config.personas} onUpdate={updateSalaries} onClose={() => setShowSalarySettings(false)} />}
          {showStructurePanel && <StructurePanel 
            config={config} 
            onMoveStage={moveStage}
            onMoveStep={moveStep}
            onInsertStage={insertStageAt}
            onInsertStep={insertStepAt}
            onRemoveStage={removeStage}
            onRemoveStep={(stageId, stepId) => {
              setConfig(prev => ({
                ...prev,
                stages: prev.stages.map(stage =>
                  stage.id === stageId
                    ? { ...stage, steps: stage.steps.filter(s => s.id !== stepId) }
                    : stage
                )
              }));
            }}
            onClose={() => setShowStructurePanel(false)} 
          />}
          {showGitHubSettings && <GitHubSettingsModal 
            config={gitHubConfig}
            onUpdate={setGitHubConfig}
            onSave={saveToGitHub}
            onLoad={loadFromGitHub}
            status={gitHubStatus}
            onClose={() => setShowGitHubSettings(false)} 
          />}
          
          {/* Funnel Dashboard Modal */}
          {showFunnelDashboard && (
            <div style={{ position: 'fixed', top: 0, left: 0, right: 0, bottom: 0, background: 'rgba(0,0,0,0.5)', display: 'flex', alignItems: 'center', justifyContent: 'center', zIndex: 1000 }} onClick={() => setShowFunnelDashboard(false)}>
              <div onClick={(e) => e.stopPropagation()} style={{ background: '#FFF', borderRadius: '12px', maxWidth: '1200px', width: '100%', maxHeight: '90vh', overflow: 'auto', boxShadow: '0 20px 60px rgba(0,0,0,0.3)' }}>
                <FunnelDashboard config={config} formatTime={formatTime} onClose={() => setShowFunnelDashboard(false)} />
              </div>
            </div>
          )}
          
          {/* Funnel Settings Modal */}
          {showFunnelSettings && <FunnelSettingsModal config={config} onUpdate={updateFunnelSettings} onClose={() => setShowFunnelSettings(false)} />}
          
          {/* Password Prompt Modal */}
          {showPasswordPrompt && (
            <div style={{ position: 'fixed', top: 0, left: 0, right: 0, bottom: 0, background: 'rgba(0,0,0,0.5)', display: 'flex', alignItems: 'center', justifyContent: 'center', zIndex: 10000 }} onClick={() => setShowPasswordPrompt(false)}>
              <div onClick={(e) => e.stopPropagation()} style={{ background: '#FFF', borderRadius: '12px', padding: '32px', width: '320px', maxWidth: '90%', boxShadow: '0 20px 60px rgba(0,0,0,0.3)' }}>
                <h3 style={{ margin: '0 0 8px', fontSize: '18px', fontWeight: 600 }}>ðŸ”’ Settings Locked</h3>
                <p style={{ margin: '0 0 20px', fontSize: '14px', color: '#666', fontFamily: "'Helvetica Neue', Arial, sans-serif" }}>Enter password to access settings</p>
                <input 
                  type="password" 
                  id="settings-password"
                  placeholder="Password"
                  autoFocus
                  onKeyDown={(e) => {
                    if (e.key === 'Enter') {
                      if (e.target.value === passwords?.settings) {
                        setIsSettingsUnlocked(true);
                        localStorage.setItem('journeymap-settings-unlocked', 'true');
                        setShowPasswordPrompt(false);
                        setShowSettingsMenu(true);
                      } else {
                        e.target.value = '';
                        e.target.placeholder = 'Incorrect password';
                        e.target.style.borderColor = '#C53030';
                      }
                    }
                  }}
                  style={{ 
                    width: '100%', 
                    padding: '12px 16px', 
                    border: '2px solid #E5E5E5', 
                    borderRadius: '8px', 
                    fontSize: '16px', 
                    marginBottom: '16px',
                    fontFamily: "'Helvetica Neue', Arial, sans-serif"
                  }} 
                />
                <div style={{ display: 'flex', gap: '12px' }}>
                  <button 
                    onClick={() => setShowPasswordPrompt(false)}
                    style={{ flex: 1, padding: '12px', background: '#F3F4F6', border: 'none', borderRadius: '8px', cursor: 'pointer', fontFamily: "'Helvetica Neue', Arial, sans-serif", fontSize: '14px', fontWeight: 500 }}
                  >
                    Cancel
                  </button>
                  <button 
                    onClick={() => {
                      const input = document.getElementById('settings-password');
                      if (input.value === passwords?.settings) {
                        setIsSettingsUnlocked(true);
                        localStorage.setItem('journeymap-settings-unlocked', 'true');
                        setShowPasswordPrompt(false);
                        setShowSettingsMenu(true);
                      } else {
                        input.value = '';
                        input.placeholder = 'Incorrect password';
                        input.style.borderColor = '#C53030';
                      }
                    }}
                    style={{ flex: 1, padding: '12px', background: '#1A1A1A', color: '#FFF', border: 'none', borderRadius: '8px', cursor: 'pointer', fontFamily: "'Helvetica Neue', Arial, sans-serif", fontSize: '14px', fontWeight: 500 }}
                  >
                    Unlock
                  </button>
                </div>
              </div>
            </div>
          )}
        </div>
      );
    }

    ReactDOM.createRoot(document.getElementById('root')).render(<JourneyMap />);
  </script>
</body>
</html>
