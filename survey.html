<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, viewport-fit=cover">
  <title>Process Survey | FATHOM</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Open+Sans:wght@400;500;600;700&display=swap" rel="stylesheet">
  <style>
    /* ============================================
       FATHOM RFI SURVEY - BRAND STYLES
       ============================================ */
    
    /* Interstate Font Family - Brand/Display Font */
    @font-face {
      font-family: 'Interstate';
      src: url('https://steveyoung74.github.io/journeymaps/fonts/Interstate-regular.ttf') format('truetype');
      font-weight: 400;
      font-style: normal;
      font-display: swap;
    }
    @font-face {
      font-family: 'Interstate';
      src: url('https://steveyoung74.github.io/journeymaps/fonts/Interstate-bold.ttf') format('truetype');
      font-weight: 700;
      font-style: normal;
      font-display: swap;
    }
    
    :root {
      /* Font Families */
      --font-display: 'Interstate', -apple-system, BlinkMacSystemFont, sans-serif;
      --font-body: 'Open Sans', -apple-system, BlinkMacSystemFont, sans-serif;
      
      --navy-950: #0C1620;
      --navy-900: #111E2E;
      --navy-800: #15243A;
      --navy-700: #192B45;
      --navy-600: #243D5C;
      --navy-500: #2F5070;
      --steel-600: #4A7485;
      --steel-500: #5B8A9A;
      --steel-400: #74A0AE;
      --steel-300: #96BCC7;
      --steel-100: #E1EEF2;
      --slate-50: #F4F5F7;
      --slate-100: #E4E7EB;
      --slate-200: #C8CED6;
      --slate-300: #A9B2BE;
      --slate-400: #8A95A5;
      --slate-500: #6E7B8C;
      --slate-600: #556275;
      --slate-700: #3D4A5C;
      --slate-900: #1A2332;
      --amber-500: #C4942A;
      --amber-100: #FAF0D6;
      --success: #2D8A6E;
      --success-light: #D4EDE5;
      --error: #B84A5A;
      --error-light: #F5E0E3;
    }
    
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }
    html {
      overflow-x: hidden;
      width: 100%;
    }
    body {
      font-family: var(--font-body);
      background: var(--slate-50);
      color: var(--slate-700);
      line-height: 1.6;
      min-height: 100vh;
      overflow-x: hidden;
      width: 100%;
      max-width: 100vw;
    }
    
    /* Typography - Display font for headings */
    h1, h2, h3, h4, h5, h6 {
      font-family: var(--font-display);
    }
    
    /* Page background with topographic pattern */
    .page-bg {
      min-height: 100vh;
      background: var(--slate-50);
      position: relative;
    }
    .page-bg::before {
      content: '';
      position: absolute;
      inset: 0;
      background: url('https://steveyoung74.github.io/journeymaps/topography-light.svg') center/600px 600px repeat;
      opacity: 1;
      pointer-events: none;
      z-index: 0;
    }
    .page-bg > header,
    .page-bg > .progress-container,
    .page-bg > main {
      position: relative;
      z-index: 1;
    }
    
    /* ============================================
       HEADER
       ============================================ */
    
    .header {
      background: linear-gradient(135deg, var(--navy-700) 0%, var(--navy-900) 100%);
      color: #FFF;
      padding: 16px 24px;
      position: sticky;
      top: 0;
      z-index: 100;
      overflow: hidden;
    }
    
    .header::before {
      content: '';
      position: absolute;
      inset: 0;
      background: url('https://steveyoung74.github.io/journeymaps/topography-dark.svg') center/600px 600px repeat;
      opacity: 1;
      pointer-events: none;
    }
    
    .header-content {
      max-width: 640px;
      margin: 0 auto;
      display: flex;
      align-items: center;
      gap: 16px;
      position: relative;
      z-index: 1;
    }
    
    .header-logo {
      height: 32px;
    }
    
    .header-title {
      font-size: 18px;
      font-weight: 600;
      opacity: 0.9;
    }
    
    /* ============================================
       PROGRESS BAR
       ============================================ */
    
    .progress-container {
      background: var(--slate-200);
      height: 4px;
      position: sticky;
      top: 56px;
      z-index: 99;
    }
    
    .progress-bar {
      background: var(--steel-500);
      height: 100%;
      transition: width 0.3s ease;
    }
    
    /* ============================================
       MAIN CONTENT
       ============================================ */
    
    .main {
      max-width: 640px;
      margin: 0 auto;
      padding: 24px;
    }
    
    /* ============================================
       WELCOME SCREEN
       ============================================ */
    
    .welcome {
      background: #FFF;
      border-radius: 16px;
      padding: 32px 24px;
      margin-bottom: 24px;
      box-shadow: 0 1px 3px rgba(0,0,0,0.08);
    }
    
    .welcome h1 {
      font-size: 24px;
      font-weight: 600;
      color: var(--navy-700);
      margin-bottom: 16px;
    }
    
    .welcome p {
      color: var(--slate-600);
      margin-bottom: 16px;
    }
    
    .welcome-meta {
      background: var(--slate-50);
      border-radius: 8px;
      padding: 16px;
      margin: 20px 0;
    }
    
    .welcome-meta-item {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 8px 0;
    }
    
    .welcome-meta-item:not(:last-child) {
      border-bottom: 1px solid var(--slate-200);
    }
    
    .welcome-meta-icon {
      font-size: 20px;
    }
    
    .welcome-meta-label {
      font-size: 13px;
      color: var(--slate-500);
    }
    
    .welcome-meta-value {
      font-weight: 600;
      color: var(--navy-700);
    }
    
    .btn {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      padding: 14px 28px;
      border-radius: 8px;
      font-size: 15px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.15s;
      border: none;
      width: 100%;
    }
    
    .btn-primary {
      background: var(--navy-900);
      color: #FFF;
    }
    
    .btn-primary:hover {
      background: var(--navy-700);
    }
    
    .btn-secondary {
      background: var(--slate-100);
      color: var(--slate-700);
    }
    
    .btn-secondary:hover {
      background: var(--slate-200);
    }
    
    /* ============================================
       STEP CARD
       ============================================ */
    
    .step-card {
      background: #FFF;
      border-radius: 16px;
      padding: 24px;
      margin-bottom: 16px;
      box-shadow: 0 1px 3px rgba(0,0,0,0.08);
    }
    
    .step-header {
      margin-bottom: 20px;
    }
    
    .step-stage {
      font-size: 12px;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 1px;
      color: var(--steel-500);
      margin-bottom: 4px;
    }
    
    .step-name {
      font-size: 18px;
      font-weight: 600;
      color: var(--navy-700);
    }
    
    .step-existing {
      background: var(--slate-50);
      border-radius: 8px;
      padding: 12px 16px;
      margin: 16px 0;
      font-size: 14px;
      color: var(--slate-600);
    }
    
    .step-existing-label {
      font-size: 11px;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      color: var(--slate-400);
      margin-bottom: 4px;
    }
    
    /* ============================================
       FORM FIELDS
       ============================================ */
    
    .field {
      margin-bottom: 20px;
    }
    
    .field-label {
      display: block;
      font-size: 14px;
      font-weight: 600;
      color: var(--slate-700);
      margin-bottom: 8px;
    }
    
    .field-hint {
      font-size: 13px;
      color: var(--slate-500);
      font-weight: 400;
      display: block;
      margin-top: 2px;
    }
    
    .field-optional {
      font-weight: 400;
      color: var(--slate-400);
      font-size: 12px;
    }
    
    .input, .textarea, .select {
      width: 100%;
      padding: 12px 14px;
      border: 2px solid var(--slate-200);
      border-radius: 8px;
      font-size: 15px;
      color: var(--slate-700);
      background: #FFF;
      transition: border-color 0.15s;
    }
    
    .input:focus, .textarea:focus, .select:focus {
      outline: none;
      border-color: var(--steel-500);
    }
    
    .textarea {
      resize: vertical;
      min-height: 100px;
    }
    
    .input-with-unit {
      display: flex;
      align-items: stretch;
    }
    
    .input-with-unit .input {
      border-radius: 8px 0 0 8px;
      flex: 1;
    }
    
    .input-unit {
      background: var(--slate-100);
      border: 2px solid var(--slate-200);
      border-left: none;
      border-radius: 0 8px 8px 0;
      padding: 12px 14px;
      font-size: 14px;
      color: var(--slate-500);
      min-width: 80px;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    
    /* ============================================
       FRICTION SCALE
       ============================================ */
    
    .friction-scale {
      display: flex;
      gap: 8px;
    }
    
    .friction-option {
      flex: 1;
      padding: 12px 8px;
      border: 2px solid var(--slate-200);
      border-radius: 8px;
      background: #FFF;
      cursor: pointer;
      text-align: center;
      transition: all 0.15s;
    }
    
    .friction-option:hover {
      border-color: var(--slate-300);
    }
    
    .friction-option.selected {
      border-color: var(--steel-500);
      background: rgba(91, 138, 154, 0.1);
    }
    
    .friction-option.selected.friction-none { border-color: var(--green-500); background: rgba(45, 138, 110, 0.1); }
    .friction-option.selected.friction-low { border-color: var(--steel-500); background: rgba(91, 138, 154, 0.1); }
    .friction-option.selected.friction-medium { border-color: var(--amber-500); background: rgba(196, 148, 42, 0.1); }
    .friction-option.selected.friction-high { border-color: var(--red-500); background: rgba(184, 74, 90, 0.1); }
    
    .friction-emoji {
      font-size: 24px;
      margin-bottom: 4px;
    }
    
    .friction-label {
      font-size: 12px;
      font-weight: 600;
      color: var(--slate-600);
    }
    
    /* ============================================
       NAVIGATION
       ============================================ */
    
    .nav-buttons {
      display: flex;
      gap: 12px;
      margin-top: 24px;
    }
    
    .nav-buttons .btn {
      flex: 1;
    }
    
    /* ============================================
       STEP INDICATOR
       ============================================ */
    
    .step-indicator {
      text-align: center;
      margin-bottom: 24px;
    }
    
    .step-indicator-text {
      font-size: 13px;
      color: var(--slate-500);
    }
    
    .step-indicator-current {
      font-weight: 600;
      color: var(--navy-700);
    }
    
    /* ============================================
       REVIEW SCREEN
       ============================================ */
    
    .review-section {
      background: #FFF;
      border-radius: 16px;
      padding: 24px;
      margin-bottom: 16px;
      box-shadow: 0 1px 3px rgba(0,0,0,0.08);
    }
    
    .review-section h2 {
      font-size: 18px;
      color: var(--navy-700);
      margin-bottom: 16px;
    }
    
    .review-step {
      padding: 16px 0;
      border-bottom: 1px solid var(--slate-200);
    }
    
    .review-step:last-child {
      border-bottom: none;
    }
    
    .review-step-name {
      font-weight: 600;
      color: var(--navy-700);
      margin-bottom: 8px;
    }
    
    .review-field {
      display: flex;
      gap: 8px;
      font-size: 14px;
      margin-bottom: 4px;
    }
    
    .review-field-label {
      color: var(--slate-500);
      min-width: 100px;
    }
    
    .review-field-value {
      color: var(--slate-700);
      flex: 1;
    }
    
    .review-field-value.empty {
      color: var(--slate-400);
      font-style: italic;
    }
    
    /* ============================================
       SUCCESS SCREEN
       ============================================ */
    
    .success {
      text-align: center;
      padding: 48px 24px;
    }
    
    .success-icon {
      font-size: 64px;
      margin-bottom: 24px;
    }
    
    .success h1 {
      font-size: 24px;
      color: var(--navy-700);
      margin-bottom: 16px;
    }
    
    .success p {
      color: var(--slate-600);
      max-width: 400px;
      margin: 0 auto;
    }
    
    /* ============================================
       ERROR SCREEN
       ============================================ */
    
    .error-screen {
      text-align: center;
      padding: 48px 24px;
    }
    
    .error-icon {
      font-size: 64px;
      margin-bottom: 24px;
    }
    
    .error-screen h1 {
      font-size: 24px;
      color: var(--red-500);
      margin-bottom: 16px;
    }
    
    .error-screen p {
      color: var(--slate-600);
    }
    
    /* ============================================
       LOADING
       ============================================ */
    
    .loading {
      text-align: center;
      padding: 48px 24px;
    }
    
    .loading-spinner {
      width: 48px;
      height: 48px;
      border: 4px solid var(--slate-200);
      border-top-color: var(--steel-500);
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin: 0 auto 24px;
    }
    
    @keyframes spin {
      to { transform: rotate(360deg); }
    }
    
    /* ============================================
       RESPONSIVE
       ============================================ */
    
    @media (max-width: 480px) {
      .friction-scale {
        flex-wrap: wrap;
      }
      
      .friction-option {
        flex: 1 1 45%;
      }
      
      .nav-buttons {
        flex-direction: column;
      }
      
      .nav-buttons .btn-secondary {
        order: 2;
      }
    }
  </style>
</head>
<body>
  <div id="root"></div>
  
  <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  
  <script type="text/babel">
    const { useState, useEffect, useCallback } = React;
    
    // ============================================
    // SUPABASE CONFIG
    // ============================================
    const SUPABASE_URL = 'https://ktctvaeulualihczwnrl.supabase.co';
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imt0Y3R2YWV1bHVhbGloY3p3bnJsIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njc0MzczNjksImV4cCI6MjA4MzAxMzM2OX0.qnvrAUvUhp3hgu37YnahR0Ql-CKR0zcDt3sKWaMq95I';
    
    const supabase = window.supabase?.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
    
    // ============================================
    // GITHUB CONFIG (Legacy fallback)
    // ============================================
    const GITHUB_CONFIG = {
      owner: 'steveyoung74',
      repo: 'journeymaps',
      branch: 'main',
      mapsPath: 'maps',
      responsesPath: 'responses'
    };
    
    const getRawUrl = (path) => 
      `https://raw.githubusercontent.com/${GITHUB_CONFIG.owner}/${GITHUB_CONFIG.repo}/${GITHUB_CONFIG.branch}/${path}`;
    
    const getApiUrl = (path) => 
      `https://api.github.com/repos/${GITHUB_CONFIG.owner}/${GITHUB_CONFIG.repo}/contents/${path}`;
    
    // ============================================
    // URL PARAMS
    // ============================================
    const urlParams = new URLSearchParams(window.location.search);
    const supabaseMapId = urlParams.get('id');  // New Supabase UUID format
    const legacyMapId = urlParams.get('map');   // Legacy GitHub format
    const mapId = supabaseMapId || legacyMapId;
    const isSupabaseMode = !!supabaseMapId;
    
    const roleId = urlParams.get('role');
    const respondentEmail = urlParams.get('email');
    const respondentName = urlParams.get('name') || respondentEmail?.split('@')[0] || 'Respondent';
    
    // ============================================
    // FRICTION OPTIONS
    // ============================================
    const FRICTION_OPTIONS = [
      { id: 'none', label: 'None', emoji: 'üòä' },
      { id: 'low', label: 'Low', emoji: 'üôÇ' },
      { id: 'medium', label: 'Medium', emoji: 'üòê' },
      { id: 'high', label: 'High', emoji: 'üò´' }
    ];
    
    // ============================================
    // MAIN APP
    // ============================================
    function SurveyApp() {
      const [loading, setLoading] = useState(true);
      const [error, setError] = useState(null);
      const [mapConfig, setMapConfig] = useState(null);
      const [organisationId, setOrganisationId] = useState(null);
      const [roleName, setRoleName] = useState('');
      const [steps, setSteps] = useState([]);
      const [currentStep, setCurrentStep] = useState(-1); // -1 = welcome, -2 = review, -3 = success
      const [responses, setResponses] = useState({});
      const [submitting, setSubmitting] = useState(false);
      
      // Load journey map config
      useEffect(() => {
        if (!mapId || !roleId) {
          setError('Invalid survey link. Please contact the person who sent you this link.');
          setLoading(false);
          return;
        }
        
        const loadMap = async () => {
          try {
            let config;
            
            // Load from Supabase or GitHub based on mode
            if (isSupabaseMode && supabase) {
              console.log('Loading map from Supabase:', mapId);
              const { data, error } = await supabase
                .from('journey_maps')
                .select('config, title, organisation_id')
                .eq('id', mapId)
                .single();
              
              if (error) throw new Error('Survey not found');
              if (!data?.config) throw new Error('Survey configuration not found');
              
              config = data.config;
              setOrganisationId(data.organisation_id);
            } else {
              // Legacy GitHub mode
              console.log('Loading map from GitHub:', mapId);
              const url = getRawUrl(`${GITHUB_CONFIG.mapsPath}/${mapId}.json`) + '?t=' + Date.now();
              const response = await fetch(url);
              
              if (!response.ok) {
                throw new Error('Survey not found');
              }
              
              config = await response.json();
            }
            
            setMapConfig(config);
            
            // Find role/persona
            const persona = config.personas?.find(p => p.id === roleId);
            if (!persona) {
              throw new Error('Role not found in this survey');
            }
            setRoleName(persona.label || persona.name || roleId);
            
            // Filter steps for this role - check roleInvolvement, owner, or persona
            const roleSteps = [];
            config.stages?.forEach(stage => {
              stage.steps?.forEach(step => {
                let isAssigned = false;
                
                // Check roleInvolvement (new format)
                if (step.roleInvolvement && step.roleInvolvement[roleId]) {
                  const involvement = step.roleInvolvement[roleId];
                  if (involvement.timeMinutes > 0) {
                    isAssigned = true;
                  }
                }
                // Check owner (fallback)
                else if (step.owner === roleId) {
                  isAssigned = true;
                }
                // Check persona (legacy)
                else if (step.persona === roleId) {
                  isAssigned = true;
                }
                
                if (isAssigned) {
                  roleSteps.push({
                    ...step,
                    stageName: stage.name,
                    stageId: stage.id
                  });
                }
              });
            });
            
            if (roleSteps.length === 0) {
              throw new Error('No steps assigned to your role');
            }
            
            setSteps(roleSteps);
            
            // Initialize responses
            const initialResponses = {};
            roleSteps.forEach(step => {
              initialResponses[step.id] = {
                description: '',
                timeEstimate: step.timeMinutes || step.duration || '',
                painPoints: '',
                regulatory: '',
                friction: step.friction || 'none',
                thirdPartyCosts: '',
                improvements: '',
                additionalNotes: ''
              };
            });
            setResponses(initialResponses);
            
            setLoading(false);
          } catch (err) {
            setError(err.message || 'Failed to load survey');
            setLoading(false);
          }
        };
        
        loadMap();
      }, []);
      
      // Update response for current step
      const updateResponse = (field, value) => {
        const stepId = steps[currentStep]?.id;
        if (!stepId) return;
        
        setResponses(prev => ({
          ...prev,
          [stepId]: {
            ...prev[stepId],
            [field]: value
          }
        }));
      };
      
      // Navigate
      const goToStep = (index) => {
        setCurrentStep(index);
        window.scrollTo(0, 0);
      };
      
      const goNext = () => {
        if (currentStep < steps.length - 1) {
          goToStep(currentStep + 1);
        } else {
          goToStep(-2); // Review
        }
      };
      
      const goPrev = () => {
        if (currentStep > 0) {
          goToStep(currentStep - 1);
        } else if (currentStep === 0) {
          goToStep(-1); // Welcome
        } else if (currentStep === -2) {
          goToStep(steps.length - 1); // Back to last step
        }
      };
      
      // Submit responses
      const submitResponses = async () => {
        setSubmitting(true);
        
        try {
          const surveyId = `${mapId}-${roleId}-${Date.now()}`;
          const responseData = {
            surveyId,
            mapId,
            roleId,
            roleName,
            respondent: {
              email: respondentEmail,
              name: respondentName
            },
            submittedAt: new Date().toISOString(),
            responses: Object.entries(responses).map(([stepId, data]) => {
              const step = steps.find(s => s.id === stepId);
              return {
                stepId,
                stepName: step?.name,
                stageName: step?.stageName,
                ...data
              };
            })
          };
          
          // Save to Supabase if in Supabase mode
          if (isSupabaseMode && supabase && organisationId) {
            const { error } = await supabase
              .from('survey_responses')
              .insert({
                survey_id: surveyId,
                journey_map_id: mapId,
                organisation_id: organisationId,
                role_id: roleId,
                role_name: roleName,
                respondent_email: respondentEmail,
                respondent_name: respondentName,
                responses: responseData.responses,
                submitted_at: new Date().toISOString()
              });
            
            if (error) {
              console.error('Supabase save error:', error);
              throw new Error('Failed to save response');
            }
            console.log('‚úÖ Response saved to Supabase');
          } else {
            // Fallback to localStorage for legacy mode
            const localResponses = JSON.parse(localStorage.getItem('fathom-survey-responses') || '[]');
            localResponses.push(responseData);
            localStorage.setItem('fathom-survey-responses', JSON.stringify(localResponses));
            console.log('Response saved to localStorage:', responseData);
          }
          
          setCurrentStep(-3); // Success
        } catch (err) {
          console.error('Submit error:', err);
          alert('Failed to submit. Please try again.');
        }
        
        setSubmitting(false);
      };
      
      // Calculate progress
      const progress = currentStep >= 0 
        ? ((currentStep + 1) / steps.length) * 100 
        : currentStep === -2 ? 100 : 0;
      
      // ============================================
      // RENDER
      // ============================================
      
      if (loading) {
        return (
          <div className="page-bg">
            <header className="header">
              <div className="header-content">
                <img src="https://steveyoung74.github.io/journeymaps/logo_light.png" alt="FATHOM" className="header-logo" />
                <div className="header-title">Process Survey</div>
              </div>
            </header>
            <main className="main">
              <div className="loading">
                <div className="loading-spinner"></div>
                <p>Loading survey...</p>
              </div>
            </main>
          </div>
        );
      }
      
      if (error) {
        return (
          <div className="page-bg">
            <header className="header">
              <div className="header-content">
                <img src="https://steveyoung74.github.io/journeymaps/logo_light.png" alt="FATHOM" className="header-logo" />
                <div className="header-title">Process Survey</div>
              </div>
            </header>
            <main className="main">
              <div className="error-screen">
                <div className="error-icon">‚ö†Ô∏è</div>
                <h1>Unable to Load Survey</h1>
                <p>{error}</p>
              </div>
            </main>
          </div>
        );
      }
      
      // Success screen
      if (currentStep === -3) {
        return (
          <div className="page-bg">
            <header className="header">
              <div className="header-content">
                <img src="https://steveyoung74.github.io/journeymaps/logo_light.png" alt="FATHOM" className="header-logo" />
                <div className="header-title">{mapConfig?.meta?.title || 'Process Survey'}</div>
              </div>
            </header>
            <main className="main">
              <div className="welcome success">
                <div className="success-icon">‚úÖ</div>
                <h1>Thank You!</h1>
                <p>Your responses have been submitted successfully. Your input will help us better understand and improve this process.</p>
              </div>
            </main>
          </div>
        );
      }
      
      return (
        <div className="page-bg">
          <header className="header">
            <div className="header-content">
              <img src="https://steveyoung74.github.io/journeymaps/logo_light.png" alt="FATHOM" className="header-logo" />
              <div className="header-title">{mapConfig?.meta?.title || 'Process Survey'}</div>
            </div>
          </header>
          
          <div className="progress-container">
            <div className="progress-bar" style={{ width: `${progress}%` }}></div>
          </div>
          
          <main className="main">
            {/* Welcome Screen */}
            {currentStep === -1 && (
              <div className="welcome">
                <h1>Hi {respondentName}! üëã</h1>
                <p>We're mapping out the <strong>{mapConfig?.meta?.title || 'process'}</strong> to understand how it really works and identify opportunities for improvement.</p>
                <p>You've been identified as someone involved in this process. We'd love to hear about your experience.</p>
                
                <div className="welcome-meta">
                  <div className="welcome-meta-item">
                    <span className="welcome-meta-icon">üë§</span>
                    <div>
                      <div className="welcome-meta-label">Your Role</div>
                      <div className="welcome-meta-value">{roleName}</div>
                    </div>
                  </div>
                  <div className="welcome-meta-item">
                    <span className="welcome-meta-icon">üìã</span>
                    <div>
                      <div className="welcome-meta-label">Steps to Review</div>
                      <div className="welcome-meta-value">{steps.length} step{steps.length !== 1 ? 's' : ''}</div>
                    </div>
                  </div>
                  <div className="welcome-meta-item">
                    <span className="welcome-meta-icon">‚è±Ô∏è</span>
                    <div>
                      <div className="welcome-meta-label">Estimated Time</div>
                      <div className="welcome-meta-value">{Math.ceil(steps.length * 2)} minutes</div>
                    </div>
                  </div>
                </div>
                
                <p style={{ fontSize: '14px', color: 'var(--slate-500)', marginBottom: '24px' }}>
                  For each step, we'll ask you to describe what you do, how long it takes, and any pain points you experience. Your input is invaluable!
                </p>
                
                <button className="btn btn-primary" onClick={() => goToStep(0)}>
                  Let's Get Started ‚Üí
                </button>
              </div>
            )}
            
            {/* Step Form */}
            {currentStep >= 0 && currentStep < steps.length && (
              <>
                <div className="step-indicator">
                  <span className="step-indicator-text">
                    Step <span className="step-indicator-current">{currentStep + 1}</span> of {steps.length}
                  </span>
                </div>
                
                <div className="step-card">
                  <div className="step-header">
                    <div className="step-stage">{steps[currentStep].stageName}</div>
                    <div className="step-name">{steps[currentStep].name}</div>
                  </div>
                  
                  {steps[currentStep].notes && (
                    <div className="step-existing">
                      <div className="step-existing-label">Current Description</div>
                      {steps[currentStep].notes}
                    </div>
                  )}
                  
                  <div className="field">
                    <label className="field-label">
                      What do you actually do in this step?
                      <span className="field-hint">Describe the activities in your own words</span>
                    </label>
                    <textarea 
                      className="textarea"
                      value={responses[steps[currentStep].id]?.description || ''}
                      onChange={(e) => updateResponse('description', e.target.value)}
                      placeholder="e.g., I review the application form, check all required fields are completed, and verify the information against our system..."
                    />
                  </div>
                  
                  <div className="field">
                    <label className="field-label">
                      How long does this typically take you?
                      <span className="field-hint">Your best estimate in minutes</span>
                    </label>
                    <div className="input-with-unit">
                      <input 
                        type="number" 
                        className="input"
                        value={responses[steps[currentStep].id]?.timeEstimate || ''}
                        onChange={(e) => updateResponse('timeEstimate', e.target.value)}
                        placeholder="e.g., 15"
                        min="0"
                      />
                      <span className="input-unit">minutes</span>
                    </div>
                  </div>
                  
                  <div className="field">
                    <label className="field-label">
                      How much friction do you experience?
                      <span className="field-hint">Is this step easy, stressful, or frustrating?</span>
                    </label>
                    <div className="friction-scale">
                      {FRICTION_OPTIONS.map(option => (
                        <div 
                          key={option.id}
                          className={`friction-option friction-${option.id} ${responses[steps[currentStep].id]?.friction === option.id ? 'selected' : ''}`}
                          onClick={() => updateResponse('friction', option.id)}
                        >
                          <div className="friction-emoji">{option.emoji}</div>
                          <div className="friction-label">{option.label}</div>
                        </div>
                      ))}
                    </div>
                  </div>
                  
                  <div className="field">
                    <label className="field-label">
                      What pain points do you experience?
                      <span className="field-hint">Systems, handoffs, waiting, rework, etc.</span>
                    </label>
                    <textarea 
                      className="textarea"
                      value={responses[steps[currentStep].id]?.painPoints || ''}
                      onChange={(e) => updateResponse('painPoints', e.target.value)}
                      placeholder="e.g., The system is slow, I often have to chase other teams for information, the form requires duplicate data entry..."
                    />
                  </div>
                  
                  <div className="field">
                    <label className="field-label">
                      Any regulatory or compliance requirements? <span className="field-optional">(Optional)</span>
                      <span className="field-hint">Things you must do for legal/compliance reasons</span>
                    </label>
                    <textarea 
                      className="textarea"
                      value={responses[steps[currentStep].id]?.regulatory || ''}
                      onChange={(e) => updateResponse('regulatory', e.target.value)}
                      placeholder="e.g., Must document decision rationale, FCA requires audit trail..."
                      style={{ minHeight: '80px' }}
                    />
                  </div>
                  
                  <div className="field">
                    <label className="field-label">
                      Any third-party or material costs? <span className="field-optional">(Optional)</span>
                      <span className="field-hint">External services, postage, materials, etc.</span>
                    </label>
                    <div className="input-with-unit">
                      <input 
                        type="number" 
                        className="input"
                        value={responses[steps[currentStep].id]?.thirdPartyCosts || ''}
                        onChange={(e) => updateResponse('thirdPartyCosts', e.target.value)}
                        placeholder="e.g., 25"
                        min="0"
                        step="0.01"
                      />
                      <span className="input-unit">¬£ per case</span>
                    </div>
                  </div>
                  
                  <div className="field">
                    <label className="field-label">
                      Ideas for improvement? <span className="field-optional">(Optional)</span>
                      <span className="field-hint">How could this step be better?</span>
                    </label>
                    <textarea 
                      className="textarea"
                      value={responses[steps[currentStep].id]?.improvements || ''}
                      onChange={(e) => updateResponse('improvements', e.target.value)}
                      placeholder="e.g., If we had integration with X system, this could be automated. A checklist would reduce errors..."
                      style={{ minHeight: '80px' }}
                    />
                  </div>
                  
                  <div className="nav-buttons">
                    <button className="btn btn-secondary" onClick={goPrev}>
                      ‚Üê Back
                    </button>
                    <button className="btn btn-primary" onClick={goNext}>
                      {currentStep < steps.length - 1 ? 'Next Step ‚Üí' : 'Review Responses ‚Üí'}
                    </button>
                  </div>
                </div>
              </>
            )}
            
            {/* Review Screen */}
            {currentStep === -2 && (
              <>
                <div className="step-indicator">
                  <span className="step-indicator-text">
                    <span className="step-indicator-current">Review Your Responses</span>
                  </span>
                </div>
                
                <div className="review-section">
                  <h2>Summary</h2>
                  {steps.map((step, index) => {
                    const response = responses[step.id];
                    return (
                      <div key={step.id} className="review-step">
                        <div className="review-step-name">{index + 1}. {step.name}</div>
                        <div className="review-field">
                          <span className="review-field-label">Time:</span>
                          <span className={`review-field-value ${!response?.timeEstimate ? 'empty' : ''}`}>
                            {response?.timeEstimate ? `${response.timeEstimate} mins` : 'Not specified'}
                          </span>
                        </div>
                        <div className="review-field">
                          <span className="review-field-label">Friction:</span>
                          <span className="review-field-value">
                            {FRICTION_OPTIONS.find(f => f.id === response?.friction)?.emoji} {response?.friction || 'None'}
                          </span>
                        </div>
                        {response?.painPoints && (
                          <div className="review-field">
                            <span className="review-field-label">Pain Points:</span>
                            <span className="review-field-value">{response.painPoints.substring(0, 100)}{response.painPoints.length > 100 ? '...' : ''}</span>
                          </div>
                        )}
                        {response?.improvements && (
                          <div className="review-field">
                            <span className="review-field-label">Ideas:</span>
                            <span className="review-field-value">{response.improvements.substring(0, 100)}{response.improvements.length > 100 ? '...' : ''}</span>
                          </div>
                        )}
                        <button 
                          onClick={() => goToStep(index)}
                          style={{ marginTop: '8px', padding: '6px 12px', fontSize: '12px', background: 'var(--slate-100)', border: 'none', borderRadius: '4px', cursor: 'pointer', color: 'var(--slate-600)' }}
                        >
                          Edit
                        </button>
                      </div>
                    );
                  })}
                </div>
                
                <div className="nav-buttons">
                  <button className="btn btn-secondary" onClick={goPrev}>
                    ‚Üê Back
                  </button>
                  <button 
                    className="btn btn-primary" 
                    onClick={submitResponses}
                    disabled={submitting}
                  >
                    {submitting ? 'Submitting...' : 'Submit Responses ‚úì'}
                  </button>
                </div>
              </>
            )}
          </main>
        </div>
      );
    }
    
    // ============================================
    // RENDER
    // ============================================
    ReactDOM.createRoot(document.getElementById('root')).render(<SurveyApp />);
  </script>
</body>
</html>
